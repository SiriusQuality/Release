!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/icesheet/comp_bc_ice_sheet.F90 $
!---------------------------------------------------------------------
!********************************************************************!


subroutine compute_bc_ice_sheet
 
use parm
use gen
use dens
use m_ice_sheet
#ifdef OPENMP
use omp_lib 
#endif
#ifdef PETSC
use petsc_mpi_common, only : petsc_mpi_finalize
#endif

implicit none

#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif

#ifdef PETSC
      real*8 :: delta_uvs_max_gbl
      PetscErrorCode :: ierrcode
#endif

integer :: ibheat, ibvs, ivol

real*8 :: val, delta_uvs, delta_uvs_max, ratio_delta_uvs

real*8, parameter :: tiny = 1.d-5, tiny_time=1.0d-5, r0=0.0d0
logical  iserror

external :: zero_r8_parallel

!cprovi-----------------------------------------------------------------
!cprovi Set the original boundary conditions 
!cprovi-----------------------------------------------------------------
nbvs=nbvs0
nbrt=nbrt0
iabvs=iabvs0
jabrt=jabrt0
if(nbvs>0) then 
  call zero_r8_parallel(valuebc, nbvs, 1, 1)
  call get_new_bc_(ice_sheet,iabvs,valuebc,iwork_bc,rwork_bc,nbvs,xg,zg,nngl,time_io,time_io-delt_io,iserror)
  if (iserror) then
     if(rank == 0) then 
       write(*,*) 'Error when update BC for flow'     
       write(ilog,*) 'Error when update BC for flow'
       !write(igen,*) 'Error when update BC for flow'
       close(ilog)
     end if
#ifdef PETSC
     call petsc_mpi_finalize
#endif
     stop
  end if
end if

if (nbrt>0) then
  call zero_r8_parallel(valuebc, nbrt, 1, 1)
  call get_new_bc_(ice_sheet,jabrt,valuebc,iwork_bc,rwork_bc,nbrt,xg,zg,nngl,time_io,time_io-delt_io,iserror)
  if (iserror) then
    if (rank == 0) then  
      write(*,*) 'Error when update BC for transport'
      write(ilog,*) 'Error when update BC for transport'
      !write(igen,*) 'Error when update BC for transport'
      close(ilog)
    end if
#ifdef PETSC
    call petsc_mpi_finalize
#endif
    stop
  end if
end if
!cprovi-------------------------------------------------------------------------
!cprovi If energy balance is solved modify their boundary conditions
!cprovi-------------------------------------------------------------------------
if (heat_transport) then
  nbheat=nbheat0
  iabheat=iabheat0
  bcondheat=bcondheat0
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nbheat > numofloops_thred_comp_bc_ice_1)                &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ibheat, ivol, iserror)
    !$omp do schedule(dynamic)
#endif
  do ibheat=1,nbheat
   if (btypeheat(ibheat)=='first') then
     ivol = iabheat(ibheat)
     call modify_for_permafrost_ (ice_sheet,bcondheat(ibheat),xg(ivol),zg(ivol),time_io,iserror)
     tempnew(ivol)=bcondheat(ibheat)
     if (iserror) then
        if (rank == 0) then         
          write(*,*) 'Error when update BC for heat transport'
          write(ilog,*) 'Error when update BC for heat transport'
          if (b_enable_output_gen) then
            write(igen,*) 'Error when update BC for heat transport'
          end if
          close(ilog)
          close(igen)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
     end if
   end if
  end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif  
end if

delta_uvs = 0.0d0
delta_uvs_max = 0.0d0

if (b_check_update_pw) then
  ratio_delta_uvs = delt / deltmax
else
  ratio_delta_uvs = 1.0d0
end if

!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nbvs > numofloops_thred_comp_bc_ice_2)                  &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ibvs, ivol, val, iserror, delta_uvs)
    !$omp do schedule(dynamic) lastprivate (delta_uvs_max)
#endif
do ibvs = 1,nbvs          

!c  assign pointer and 
!c
          ivol=iabvs(ibvs) 
          
!c Assign initial values in uvsnew          
          
          delta_uvs = (bcondvs0(ibvs) - uvsnew(ivol))*ratio_delta_uvs

          uvsnew(ivol) = uvsnew(ivol) + delta_uvs

!c  first type boundary condition - constant pressure head
          if (btypevs(ibvs)=='first') then
          
              if (fluid_pressure) then
              
                    call compute_pw_ (ice_sheet,val,time_io,time_io-delt_io,xg(ivol),zg(ivol),'head',iserror)
                    delta_uvs = delta_uvs + val*ratio_delta_uvs
                    uvsnew(ivol) = uvsnew(ivol) + val*ratio_delta_uvs
                    bcondvs(ibvs) = uvsnew(ivol)
                  
              elseif (pressure_head) then

                    call compute_pw_ (ice_sheet,val,time_io,time_io-delt_io,xg(ivol),zg(ivol),'head',iserror)
                    delta_uvs = delta_uvs + val*density(ivol)*gacc*ratio_delta_uvs
                    uvsnew(ivol) = uvsnew(ivol) + val*density(ivol)*gacc*ratio_delta_uvs
                    bcondvs(ibvs) = uvsnew(ivol)

              elseif (fresh_head) then
                    
                    call compute_pw_ (ice_sheet,val,time_io,time_io-delt_io,xg(ivol),zg(ivol),'head',iserror)
                    delta_uvs = delta_uvs + val*gacc*ref_dens*ratio_delta_uvs
                    uvsnew(ivol) = uvsnew(ivol) + val*gacc*ref_dens*ratio_delta_uvs
                    bcondvs(ibvs) = uvsnew(ivol)

              elseif (hydraulic_head) then
                    
                    call compute_pw_ (ice_sheet,val,time_io,time_io-delt_io,xg(ivol),zg(ivol),'pressure',iserror)
                    delta_uvs = delta_uvs + val*ratio_delta_uvs
                    uvsnew(ivol) = uvsnew(ivol) + val*ratio_delta_uvs
                    bcondvs(ibvs) = uvsnew(ivol)

              end if
          
          end if

          if (ibvs == 1) then
            delta_uvs_max = abs(delta_uvs)
          else
            if (delta_uvs_max < abs(delta_uvs)) then
              delta_uvs_max = abs(delta_uvs)
            end if
          end if

end do 
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif  

#ifdef PETSC
      call MPI_Allreduce(delta_uvs_max, delta_uvs_max_gbl,1,           &
                         MPI_REAL8,MPI_MAX,                            &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      delta_uvs_max = delta_uvs_max_gbl
#endif

if (b_check_update_pw .and. delta_uvs_max > max_update_pw) then
  if (idetail_vs > 0 .and. b_enable_output .and. rank == 0) then
    write(*,*) "Reduce timestep, maximum ice loading boundary pressure update ",delta_uvs_max
    write(ilog,*) "Reduce timestep, maximum ice loading boundary pressure update ",delta_uvs_max
  end if
  reduce_timestep = .true.

  do ibvs = 1,nbvs
  !c  assign pointer and !c
            ivol=iabvs(ibvs)
  !c Assign initial values in uvsnew
            uvsnew(ivol) = uvsold(ivol)
  end do

else if (b_check_update_pw .and. delta_uvs_max <= max_update_pw) then
  if (idetail_vs > 0 .and. b_enable_output .and. rank == 0) then
    write(*,*) "Maximum ice loading boundary pressure update ",delta_uvs_max
    write(ilog,*) "Maximum ice loading boundary pressure update ",delta_uvs_max
  end if
end if

return
end subroutine 
