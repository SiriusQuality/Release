!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/gas_advection/velocity_g.F90 $
!---------------------------------------------------------------------
!********************************************************************!
!c ----------------------------------------------------------------------
!c subroutine velocityg
!c --------------------
!c
!c compute average interfacial velocities in x,y,z directions 
!c for rectangular, cartesian finite volume discretization 
!c in the gas phase
!c 
!c compute density, viscosity, gradients that drive advection
!c
!c written by:      Sergi Molins - May 2, 2006
!c
!c last modified:   Sergi Molins - May 24,2006
!c                  press+temp dependence of diff coeff
!c
!c modified by: Danyang Su - March 26, 2014
!c
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           l_sufx             = length of file suffix               + -
!c
!c           character:
!c           ----------
!c           suffix             = file suffix                         + -
!c
!c gen.f:
!c           real*8:
!c           -------
!c           dimcv(3,nn)        = dimension of cells in x,y,z         + -
!c                                direction
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c 
!c added for gas advection and multi-component diffusion
!c
!c           gacc               = gravity                             + -
!c           deltaij(njavs)     = distance between i-j                + -
!c           gmfrac(1,ivol)     = gas molar fractions at c.v. i       * +
!c           gporij(njavs)      = gas filled porosity                 + -
!c           relpermg(ivol)     = relative permeability (gas phase)   * +
!c           tauij(njavs)       = tortuosity (gas phase)              + -
!c
!c           character:
!c           ----------
!c           iupsg(i1)
!c -----------------------
!c
!c           integer*4:
!c           ----------
!c           iavs(nn+1)         = row pointer array for 1d-scalar     + -
!c                                matrix
!c           idbg               = output for debugging information    + -
!c           ifls               = unit number, file information       + -
!c           igsa               = unit number, molar fluxes           + -
!c                                             - contour
!c           igsa2              = unit number, molar fluxes           + -
!c                                             - contour
!c           igsa_first         = unit number, molar fluxes           + -
!c                                             - contour
!c           igsa_last          = unit number, molar fluxes           * +
!c                                             - contour
!c           igsf2              = unit number, diffusion coefficients + -
!c                                             for each component
!c                                             - contour data
!c           igsf_first         = unit number, diffusion coefficients + -
!c                                             - contour data
!c           igsf_last          = unit number, diffusion coefficients + -
!c                                             - contour data
!c           igsk               = unit number, adv & diff gradients   + -
!c                                             - contour data
!c           igsr               = unit number, gas density            + -
!c                                                - contour data 
!c           igsy               = unit number, gas viscosity          + -
!c                                             - contour data 
!c           ilog               = unit number, logbook                + -
!c           javs(njavs)        = connectivity list for 1d-scalar     + -
!c                                matrix
!c           nn                 = total number of control volumes     + -
!c           nvx                = number of control volumes           + -
!c                                in x direction
!c           nvy                = number of control volumes           + -
!c                                in y direction
!c           nvz                = number of control volumes           + -
!c                                in z direction
!c
!c           logical:
!c           --------
!c           half_cells         = .true.  -> half cells on boundary   + -
!c
!c           character:
!c           ----------
!c           spatial_weighting  = 'upstream'
!c                                'centered'
!c
!c phys.f:
!c           real*8:
!c           -------
!c           blanc_diff_g       = .true.  -> LeBlanc's approx to      + -
!c                                           compute diff coeff                                            (Fick's law)
!c chem.f:
!c           character:
!c           ----------
!c           namec(nc)          = component names
!c           nameg(ng)          = names of gases
!c
!c           integer*4:
!c           ----------
!c           ng                 = number of gases
!c           nc                 = number of components
!c
!c dgml.f    logical:
!c           --------
!c           dgm                = .true. -> Dusty Gas Model for diffusion
!c           maxwell            = .true. -> Stefan-Maxwell for diffusion
!c
!c common:   -
!c
!c local:    real*8:
!c           -------
!c           aread(3,12)        = A_ij/d_ij for current "pseudo
!c                                dispersion element" associated
!c                                with control volume ivol, up to 4
!c                                entries for each dimension
!c           areai              = interfacial area
!c           dd(3,12)           = distance between nodes
!c           dgflux             = interfacial gas velocity
!c           dgflux_ca(n)       = interfacial gas advective flux
!c           dgflux_cd(n)       = interfacial gas diffusive flux
!c           diff(n,3)          = diffusive coefficient (LeBlancs approx)
!c           eps                = constant
!c           r0                 = constant
!c           r1                 = constant
!c           rhalf              = constant
!c           velg(3)            = gas velocity
!c           velg_ca(n,3)       = gas advective flux
!c           velg_cd(n,3)       = gas diffusive flux
!c           rverysmall         = constant
!c
!c added for gas transport:
!c
!c           cinfrt             = influence coefficients              * +
!c           densgij            = gas density at interface i-j
!c           dgm_gflux(nc)      = diffusive flux (as computed w/DGM)  * +
!c           dgflux_cd_dgm(n)   = diffusive flux calc w/DGM           * +
!c           fmat(ng)           = right hand side DGM system          * +
!c           gdens(nn)          = gas density at control volume i     * +
!c           gij(ng)            = gas concentration at i-j            * +
!c           gmfracij(ng)       = gas molar fractions at i-j          * +
!c           gpivol(nn)         = gas pressure at control volume i    * +
!c           grad_diff(ng,3)    = gradient that drives diffusion      * +
!c           grad_adv(3)        = gradient that drives advection      * +
!c           gvisc(ivol)        = gas viscosity at control vol i      * +
!c           ludecomp(ng,ng)    = LU decomp of matrix of DGM system * +
!c           ms_gflux(nc)       = diffusive flux (as computed w/S-M)  * +
!c           neflux(nc)         = non-equimolar flux for multi-comp   * +
!c                                diffusion
!c           relpgij            = relative perm (gas) at i-j          * +
!c           totgij             = total gas concentrations of         * +
!c                                components at interface i-j         * +
!c           rverysmall         = constant 
!c           viscgij            = gas viscosity at interface i-j      * +
!c
!c           character:
!c           ----------
!c           spt_weight         = spatial weighting for gas transp    * +
!c
!c           integer*4:
!c           ----------
!c           ipvt(ng)           = pivot pointer
!c
!c -------------------------
!c
!c           integer*4:
!c           ----------
!c           cvpair(3,12,2)     = pointers to connected control 
!c                                volumes in each pair for each 
!c                                dimension
!c           i1                 = pointer (connectivity list)
!c           i1sav              = pointer (connectivity list)
!c           idim               = pointer (dimensions)
!c           idim2              = pointer (dimensions)
!c           idim3              = pointer (dimensions)
!c           ipair              = counter (control volume pairs in
!c                                         dimension)
!c           ivol               = pointer (control volume i)
!c           jvol               = pointer (connected control volume j)
!c           ivol2              = counter (control volumes)
!c           ivx                = counter (number of control
!c                                volumes in x-direction)
!c           ivy                = counter (number of control
!c                                volumes in y-direction)
!c           ivz                = counter (number of control
!c                                volumes in z-direction)
!c           npair(3)           = number of control volume pairs
!c                                in dimension
!c
!c external: cliqdisp  = find control volume pairs for computation of 
!c                       average interfacial velocities
!c           fluxvg    = compute advective flux + gas phase velocity
!c           gasp_m    = compute gas pressure
!c           gasd_m    = compute gas density
!c           gasv      = compute gas viscosity
!c           dgm_fluxdg = compute gas diffusive fluxes with DGM
!c           wgprop    = spatial weighting for gas transport properties
!c ----------------------------------------------------------------------

      subroutine velocity_g (l_sufx, suffix, nmax, njamxc, cinfradx,  &
                             radial_coordx)
    

      use gen
      use chem
      use phys
      use dgml
      use writeversion
      use file_unit, only : lun_get, lun_set
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use module_binary_mpiio, only :  binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close,              & 
                                       binary_subarray_initialize
      
      implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif

      real*8 :: gasp_m, gasd_m, gasv, fluxvg, fluxd, xg_out, yg_out,   &
                zg_out, gpi, gasdiff2

      external cliqdisp
      external fluxvg, gasp_m, gasd_m, gasv, wgprop, gasdiff2

!c    passed variables
      integer, intent(in) :: l_sufx, nmax, njamxc
      character*3, intent(in) :: suffix      
      real*8 :: cinfradx(njamxc)
      logical :: radial_coordx

!c    local variables
      real*8, parameter :: eps = 1.0d-300, r0 = 0.0d0, rhalf = 0.5d0
      real*8, parameter :: r1 = 1.0d0, rverysmall = 1.d-30

      real*8 aread(3,12), velg(3), velg_ca(n,3), velg_cd(n,3), areai, &
             dgflux, dgflux_ca(n), dgflux_cd(n), diff(n,3), dd(3,12), &
             dist(3,12), areax(3,12)
      
      integer ivol, ivz, ivy, ivx, i1, jvol, i1sav, idim, npair(3),   &
              cvpair(3,12,2), ipair, idim2, idim3, ivol_l, nvarsgsk
      
      
      integer :: i, ic, ig, ivol2, izn, ierr, igsa2, igsf2
    
!c    I/O variables  
      integer*4      :: l_sfx2
      character*12   :: suffix2
      character*32   :: strvar32
      character*2048 :: strbuffer
      character*72, allocatable :: tec_variables(:)
#ifdef MPI
      integer(kind=MPI_OFFSET_KIND), allocatable ::                    &
                                offset_igsa2(:), offset_igsa2_temp(:), &
                                offset_igsf2(:), offset_igsf2_temp(:)
#else
      integer*8, allocatable ::                                        &
                                offset_igsa2(:), offset_igsa2_temp(:), &
                                offset_igsf2(:), offset_igsf2_temp(:)
#endif

      integer*4, allocatable :: igsa2_list(:), igsf2_list(:)
      
#ifdef MPI
      integer(kind=MPI_OFFSET_KIND) ::                                 &
#else
      integer*8 ::                                                     &
#endif
                  offset_igsa, offset_igsa_temp,                       &
                  offset_igsr, offset_igsr_temp,                       &
                  offset_igsy, offset_igsy_temp,                       &
                  offset_igsk, offset_igsk_temp,                       &
                  offset_ihycx, offset_ihycx_temp

!c    advective flux calculations                   
      character*12 spt_weight

!c  dgm calculations
      integer*4 :: ipvt(ng)
	  real*8    :: ludecomp(ng,ng)
	  real*8    :: dgm_gflux(nc)
	  real*8    :: fmat(ng) 

!c  maxwell stefan
      real*8     ms_gflux(nc), neflux(nc)
      
!c    more variables (gas)
      real*8 :: relpgij, densgij, viscgij, grad_diff(ng,3),            &
                grad_adv(3), gpij,                                     &
                cinfrt, dgflux_cd_dgm(n), velg_dgm(n,3), velg_neq(n,3)
      
      
      if (b_output_binary) then
          
        allocate(tec_variables(100+nc+nr+naq+ng*3+nanc+nsites+nsb_ion+ &
                 nsb_surf+nm))
        tec_variables = ''
        
        allocate(offset_igsa2(n))
        offset_igsa2 = 0
        allocate(offset_igsa2_temp(n))
        offset_igsa2_temp = 0
        allocate(igsa2_list(n))
        igsa2_list = 0
        
        if (blanc_diff_g) then
          allocate(offset_igsf2(n))
          offset_igsf2 = 0
          allocate(offset_igsf2_temp(n))
          offset_igsf2_temp = 0
          allocate(igsf2_list(n))
          igsf2_list = 0
        end if
        
      end if

      dgflux = r0

!c    spatial weighting for the gas phase    
      spt_weight = spatial_weighting
      do ic = 1, ng
	    fmat(ic) = r0
      end do
      do ic = 1, nc
	    neflux(ic) = r0
      end do

!c    open output files___________________________________________

      igsa = igsa_first

!c    gas phase velocity
      if (b_output_binary) then
        if (b_output_mpiio_single) then
          strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.vlg'
        else
          strbuffer = prefix(:l_prfx)//'_'//                           &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.vlg'
        end if
          
        call binary_file_open(Petsc_Comm_World, igsa,          &
                     trim(strbuffer), b_output_mpiio_single)

      else
        open(igsa,file=prefix(:l_prfx)//'_'//                          &
             suffix(:l_sufx)//trim(adjustl(str_rank))//'.vlg',         &
             status='unknown',form='formatted')
      end if
      
!c  version information
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igsa, "#")
      end if

      if (b_output_binary) then
        strbuffer = 'dataset '//prefix(:l_prfx)//'' 
        offset_igsa = 0
        call tecplot_binary_write_header(Petsc_Comm_World, igsa,       &
                     "#!TDV102", trim(strbuffer), offset_igsa,         &
                     b_output_mpiio_single,.false.)
        
        tec_variables(1:7) = [character(len=72) ::"x", "y", "z",       &
                              "vx", "vy", "vz", "p_t_o_t"]
        call tecplot_binary_write_variable(Petsc_Comm_World,           &
                     igsa, 7, tec_variables(1:7), offset_igsa,         &
                     b_output_mpiio_single,.false.)
        
        write(strbuffer,'(a,1pe10.3,1x,a)')                            &
              'Average interfacial gas phase velocities, T = ',        &
              time_io,time_unit

        offset_igsa_temp = offset_igsa
        
        if (b_output_multizone) then
          call tecplot_binary_write_zoneinfo(Petsc_Comm_World,igsa,    &
                       trim(strbuffer),offset_igsa,itec_vel,           &
                       jtec_vel,ktec_vel,b_output_mpiio_single,        &
                       .false.,b_output_multizone)
          offset_igsa = offset_igsa_temp +                             &
                        (11+len_trim(strbuffer))*4*nprcs + 4
        else
          call tecplot_binary_write_zoneinfo(Petsc_Comm_World,igsa,    &
                       trim(strbuffer),offset_igsa,itec_vel_gbl,       &
                       jtec_vel_gbl,ktec_vel_gbl,b_output_mpiio_single,&
                       .false.,b_output_multizone)
          offset_igsa = offset_igsa_temp +                             &
                        (12+len_trim(strbuffer))*4
        end if
      else
        write(igsa,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(igsa,'(3a)') 'variables = "x", "y", "z", ',              &
                                     '"vx", "vy", "vz"',               &
                                     ', "p_t_o_t"'
        write(igsa,'(a,1pe10.3,1x,a,3(a,i5),a)')                       &
            'zone t = "Average interfacial gas phase velocities, T = ',&
            time_io, time_unit,                                        &
            '" i =',itec_vel,                                          &
            ', j =',jtec_vel,                                          &
            ', k =',ktec_vel,',  f=point' 
      end if
      
      if (rank == 0 .and. b_enable_output) then

        write(ifls,'(/a,1pe12.4,1x,a,/72a)')                           &
                   'Average interfacial gas phase velocities, T = ',   &
                    time_io,time_unit,('-',i=1,72)
        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
                   suffix(:l_sufx)//trim(adjustl(str_rank))//'.vlg'
        
        write(ifls,'(2a)')                                             &
                'column   entry                           ','unit'
        write(ifls,'(2a)')                                             &
                '1        x                               ','m'        
        write(ifls,'(2a)')                                             &
                '2        y                               ','m'        
        write(ifls,'(2a)')                                             &
                '3        z                               ','m'        
        write(ifls,'(2a)')                                             &
                '4        v_x                             ','m/d'      
        write(ifls,'(2a)')                                             &
                '5        v_y                             ','m/d'      
        write(ifls,'(2a)')                                             &
                '6        v_z                             ','m/d'
        write(ifls,'(2a)')                                             &
                '7        p_t_o_t                         ','atm'
        
      end if

      igsa2 = igsa 

!c  velocity of gases species in mixture
!c  File extension name was changed from .gsa to .gsga as the flux 
!c  output result takes the extension name .gsa. 
      do ic=1,n

        igsa2 = igsa2+1
        
        call icnvrt(0,ic,suffix2,l_sfx2,ierr)

        if (ierr > 0) then
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          write(*,*) "Error in icnvrt function in velocity_g"
          write(ilog,*) "Error in icnvrt function in velocity_g"
          close(ilog)
          stop
        end if
            
        if (b_output_binary) then
          if (b_output_mpiio_single) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'//   &
               suffix2(:l_sfx2)//'.gsga'
          else
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'//   &
                        suffix2(:l_sfx2)//trim(adjustl(str_rank))//    &
                        '.gsga'
          end if
            
          call binary_file_open(Petsc_Comm_World,              &
                       igsa2_list(ic),trim(strbuffer),                 &
                       b_output_mpiio_single)

        else
          open(igsa2,file=prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'// &
               suffix2(:l_sfx2)//trim(adjustl(str_rank))//'.gsga',      &
               status='unknown', form='formatted')
        end if
        
!c  version information
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsa2, "#")
        end if

        if (b_output_binary) then
          strbuffer = 'dataset '//prefix(:l_prfx)//'' 
          offset_igsa2(ic) = 0
          call tecplot_binary_write_header(Petsc_Comm_World,           &
                       igsa2_list(ic),"#!TDV102", trim(strbuffer),     &
                       offset_igsa2(ic),b_output_mpiio_single,.false.) 
          
          tec_variables(1:18) = [character(len=72) ::                  &
                          "x", "y", "z", "vx adv", "vy adv", "vz adv", &
                          "vx dif", "vy dif", "vz dif", "vx tot",      &
                          "vy tot", "vz tot", "vx dgm", "vy dgm",      &
                          "vz dgm", "vx neq", "vy neq", "vz neq"]
          
          call tecplot_binary_write_variable(Petsc_Comm_World,         &
                       igsa2_list(ic),18, tec_variables(1:18),         &
                       offset_igsa2(ic),b_output_mpiio_single,.false.) 
          
          write(strbuffer,'(a, a, 1x, a, 1p, e12.4, 1x, a)')           &
                  'Average interfacial gas velocities for component: ',&
                  namec(ic)(:l_namec(ic)),' T = ',                     &
                  time_io,time_unit
          offset_igsa2_temp(ic) = offset_igsa2(ic)  
          
          if (b_output_multizone) then
            call tecplot_binary_write_zoneinfo(Petsc_Comm_World,       &
                         igsa2_list(ic), trim(strbuffer),              &
                         offset_igsa2(ic),itec_vel,                    &
                         jtec_vel,ktec_vel,b_output_mpiio_single,      &
                         .false.,b_output_multizone)
            offset_igsa2(ic) = offset_igsa2_temp(ic) +                 &
                          (11+len_trim(strbuffer))*4*nprcs + 4
          else
            call tecplot_binary_write_zoneinfo(Petsc_Comm_World,       &
                         igsa2_list(ic), trim(strbuffer),              &
                         offset_igsa2(ic),itec_vel_gbl,                &
                         jtec_vel_gbl,ktec_vel_gbl,                    &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            offset_igsa2(ic) = offset_igsa2_temp(ic) +                 &
                          (12+len_trim(strbuffer))*4
          end if  
        else
          write(igsa2,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          write(igsa2,'(6a)') 'variables = "x", "y", "z", ',           &
                              '"vx adv", "vy adv", "vz adv", ',        &
                              '"vx dif", "vy dif", "vz dif", ',        &
                              '"vx tot", "vy tot", "vz tot", ',        &
                              '"vx dgm", "vy dgm", "vz dgm",',         &
                              '"vx neq", "vy neq", "vz neq"'
          write(igsa2,'(4a,e12.4,1x,2a,3(a,i5),a)')                    &
                'zone t = "advection and diffusion fluxes for',        &
                ' component: ', namec(ic)(:l_namec(ic)),' T = ',       &
                time_io,time_unit, ' "',                               &  
                ', i =',itec_vel,                                      &
                ', j =',jtec_vel,                                      &
                ', k =',ktec_vel,',  f=point'
        end if

        if (rank == 0 .and. b_enable_output) then

          write(ifls,'(/a, a, 1x, a, 1p, e12.4, 1x, a, /, 72a)')       &
                'Average interfacial gas fluxes for component: ',      &
                 namec(ic)(:l_namec(ic)),' T = ',                      &
                 time_io,time_unit,('-',i=1,72)
          
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                      suffix(:l_sufx)//'_'//                           &
                      suffix2(:l_sfx2)//trim(adjustl(str_rank))//'.gsga'
          
          write(ifls,'(2a)')                                           &
              'column   entry                           ','unit'
          write(ifls,'(2a)')                                           &
              '1        x                               ','m'
          write(ifls,'(2a)')                                           &
              '2        y                               ','m'
          write(ifls,'(2a)')                                           &
              '3        z                               ','m'
          write(ifls,'(2a)')                                           &
              '4        v_x advection                   ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '5        v_y advection                   ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '6        v_z advection                   ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '7        v_x Fick s diffusion            ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '8        v_y Fick s diffusion            ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '9        v_z Fick s diffusion            ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '10       v_x total                       ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '11       v_y total                       ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '12       v_z total                       ','moles/m^2/d'
	      write(ifls,'(2a)')                                           &
              '13       v_x DGM / M-S diffusion         ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '14       v_y DGM / M-S diffusion         ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '15       v_z DGM / M-S diffusion         ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '16       v_x non-equimolar diffusion     ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '17       v_y non-equimolar diffusion     ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '18       v_z non-equimolar diffusion     ','moles/m^2/d'
        
        end if
    
      enddo
      
      igsa_last = igsa2
      
      igsf2 = igsf_first

!c  variable diffusion coefficients
      if (blanc_diff_g) then

	    do ic=1,n

	      igsf2 = igsf2+1
	      
	      call icnvrt(0,ic,suffix2,l_sfx2,ierr)
	      
          if (ierr > 0) then
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            write(*,*) "Error in icnvrt function in velocity_g"
            write(ilog,*) "Error in icnvrt function in velocity_g"
            close(ilog)
            stop
          end if

          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'// &
                 suffix2(:l_sfx2)//'.gsf'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'// &
                          suffix2(:l_sfx2)//trim(adjustl(str_rank))//  &
                          '.gsf'
            end if
              
            call binary_file_open(Petsc_Comm_World,                    &
                         igsf2_list(ic),trim(strbuffer),               &
                         b_output_mpiio_single)
          
          else
	        open(igsf2,file=prefix(:l_prfx)//'_'//                     &  
                            suffix(:l_sufx)//'_'//suffix2(:l_sfx2)//   &
                            trim(adjustl(str_rank))//'.gsf',           &
                            status='unknown',form='formatted')
          end if
          
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsf2, "#")
          end if          
          
          if (b_output_binary) then
            strbuffer = 'dataset '//prefix(:l_prfx)//'' 
            offset_igsf2(ic) = 0
            call tecplot_binary_write_header(Petsc_Comm_World,         &
                         igsf2_list(ic),"#!TDV102", trim(strbuffer),   &
                         offset_igsf2(ic),b_output_mpiio_single,.false.) 
            
            tec_variables(1:6) = [character(len=72) ::                 &
                            "x", "y", "z", "Dxx", "Dyy", "Dzz"]
            
            call tecplot_binary_write_variable(Petsc_Comm_World,       &
                         igsf2_list(ic),6, tec_variables(1:6),         &
                         offset_igsf2(ic),b_output_mpiio_single,.false.) 
            
            write(strbuffer,'(3a, 1x, a, 1p, e12.4, 1x, a)')           &
                    'Species-dependent gas diffusion coefficients ',   &
                    'for component: ', namec(ic)(:l_namec(ic)),' T = ',&
                    time_io,time_unit
            offset_igsf2_temp(ic) = offset_igsf2(ic)  
            
            if (b_output_multizone) then
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsf2_list(ic), trim(strbuffer),            &
                           offset_igsf2(ic),itec_vel,                  &
                           jtec_vel,ktec_vel,b_output_mpiio_single,    &
                           .false.,b_output_multizone)
              offset_igsf2(ic) = offset_igsf2_temp(ic) +               &
                            (11+len_trim(strbuffer))*4*nprcs + 4
            else
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsf2_list(ic), trim(strbuffer),            &
                           offset_igsf2(ic),itec_vel_gbl,              &
                           jtec_vel_gbl,ktec_vel_gbl,                  &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igsf2(ic) = offset_igsf2_temp(ic) +               &
                            (12+len_trim(strbuffer))*4
            end if  
          else
	        write(igsf2,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(igsf2,'(2a)') 'variables = "x", "y", "z", ',         &  
                                '"Dxx", "Dyy", "Dzz"'     
            write(igsf2,'(4a,e12.4,1x,2a,3(a,i5),a)')                  &
                  'zone t = "Species-dependent gas diffusion ',        &
                  'coefficients for component: ',                      &
                  namec(ic)(:l_namec(ic)),' T = ',                     &
                  time_io,time_unit, ' "',                             &  
                  ', i =',itec_vel,                                    &
                  ', j =',jtec_vel,                                    &
                  ', k =',ktec_vel,',  f=point'
          end if  
       
          if (rank == 0 .and. b_enable_output) then
            write(ifls,'(/a, a, 1x, a, 1p, e12.4, 1x, a, /, 72a)')     &
                  'Species-dependent gas diffusion coefficients: ',    &
                  namec(ic)(:l_namec(ic)),' T = ',                     &
                  time_io,time_unit,('-',i=1,72)                    
                                                                          
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'_'//                 &
                                suffix2(:l_sfx2)//'.gsf'
                                                                          
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'       
            write(ifls,'(2a)')                                         &
                  '4        Dxx                             ','m2/d'    
            write(ifls,'(2a)')                                         &
                  '5        Dyy                             ','m2/d'    
            write(ifls,'(2a)')                                         &
                  '6        Dzz                             ','m2/d'
          end if
	
	    enddo

	  endif

	  igsf_last = igsf2

!c   open files for density
      if (b_output_binary) then
        if (b_output_mpiio_single) then
          strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsr'
        else
          strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//          &
                      trim(adjustl(str_rank))//'.gsr'
        end if
          
        call binary_file_open(Petsc_Comm_World, igsr,          &
                     trim(strbuffer), b_output_mpiio_single)

      else
        open(igsr,file=prefix(:l_prfx)//'_'//                          &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsr',    &
                  status='unknown',form='formatted')
      end if
      
!c  version information
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igsr, "#")
      end if

      if (b_output_binary) then
        strbuffer = 'dataset '//prefix(:l_prfx)//'' 
        offset_igsr = 0
        call tecplot_binary_write_header(Petsc_Comm_World, igsr,       &
                     "#!TDV102", trim(strbuffer), offset_igsr,         &
                     b_output_mpiio_single,.false.)
        
        tec_variables(1:4) = [character(len=72) ::"x", "y", "z",       &
                              "density"]
        call tecplot_binary_write_variable(Petsc_Comm_World, igsr,     &
                     4, tec_variables(1:4), offset_igsr,               &
                     b_output_mpiio_single,.false.)
        
        write(strbuffer,'(a,1pe10.3,1x,a)')                            &
              'Density of the gas phase, T = ',                        &
              time_io,time_unit(:l_time_unit)
        
        offset_igsr_temp = offset_igsr
        
        if (b_output_multizone) then
          call tecplot_binary_write_zoneinfo(Petsc_Comm_World,igsr,    &
                       trim(strbuffer),offset_igsr,itec_vel,           &
                       jtec_vel,ktec_vel,b_output_mpiio_single,        &
                       .false.,b_output_multizone)        
          offset_igsr = offset_igsr_temp +                             &
                        (11+len_trim(strbuffer))*4*nprcs + 4
        else
          call tecplot_binary_write_zoneinfo(Petsc_Comm_World,igsr,    &
                       trim(strbuffer),offset_igsr,itec_vel_gbl,       &
                       jtec_vel_gbl,ktec_vel_gbl,b_output_mpiio_single,&
                       .false.,b_output_multizone)        
          offset_igsr = offset_igsr_temp +                             &
                        (12+len_trim(strbuffer))*4
        end if
      else
        write(igsr,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(igsr,'(2a)') 'variables = "x", "y", "z", "density"'
        write(igsr,'(2a,1pe10.3,1x,a,3(a,i5),a)')                      &
             'zone t = "Density of the gas phase, ',                   &
             'T = ',time_io,time_unit(:l_time_unit),                   &
             '", i =',itec_vel,', j =',jtec_vel,', k =',               &
             ktec_vel,',  f=point'
      end if
      
      if (rank == 0 .and. b_enable_output) then

        write(ifls,'(/a,1pe12.4,1x,a,/72a)')                          &
                   'Density of the gas phase, T = ',                  &
                    time_io,time_unit,('-',i=1,72)
        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                    &
                    suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsr'
        
        write(ifls,'(2a)')                                            &
                'column   entry                           ','unit'     
        write(ifls,'(2a)')                                            &
                '1        x                               ','m'        
        write(ifls,'(2a)')                                            &
                '2        y                               ','m'        
        write(ifls,'(2a)')                                            &
                '3        z                               ','m'        
        write(ifls,'(2a)')                                            &
                '4        density                         ','g/l'
      
      end if

!c   open files for viscosity
      if (b_output_binary) then
        if (b_output_mpiio_single) then
          strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsy'
        else
          strbuffer = prefix(:l_prfx)//'_'//                           &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsy'
        end if
          
        call binary_file_open(Petsc_Comm_World, igsy,          &
                     trim(strbuffer), b_output_mpiio_single)

      else
        open(igsy,file=prefix(:l_prfx)//'_'//                          &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsy',    &
                  status='unknown',form='formatted')
      end if
      
!c  version information
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igsy, "#")
      end if

      if (b_output_binary) then
        strbuffer = 'dataset '//prefix(:l_prfx)//'' 
        offset_igsy = 0
        call tecplot_binary_write_header(Petsc_Comm_World, igsy,       &
                     "#!TDV102", trim(strbuffer), offset_igsy,         &
                     b_output_mpiio_single,.false.)
        
        tec_variables(1:4) = [character(len=72) :: "x", "y", "z",      &
                              "viscosity"]
        call tecplot_binary_write_variable(Petsc_Comm_World, igsy,     &
                     4, tec_variables(1:4), offset_igsy,               &
                     b_output_mpiio_single,.false.)
        
        write(strbuffer,'(a,1pe10.3,1x,a)')                            &
              'Viscosity of the gas phase, T = ',                      &
              time_io,time_unit(:l_time_unit)
        
        offset_igsy_temp = offset_igsy   
        
        if (b_output_multizone) then
          call tecplot_binary_write_zoneinfo(Petsc_Comm_World,igsy,    &
                       trim(strbuffer),offset_igsy,itec_vel,           &
                       jtec_vel,ktec_vel,b_output_mpiio_single,        &
                       .false.,b_output_multizone)        
          offset_igsy = offset_igsy_temp +                             &
                        (11+len_trim(strbuffer))*4*nprcs + 4
        else
          call tecplot_binary_write_zoneinfo(Petsc_Comm_World,igsy,    &
                       trim(strbuffer),offset_igsy,itec_vel_gbl,       &
                       jtec_vel_gbl,ktec_vel_gbl,b_output_mpiio_single,&
                       .false.,b_output_multizone)        
          offset_igsy = offset_igsy_temp +                             &
                        (12+len_trim(strbuffer))*4
        end if
      else
        write(igsy,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(igsy,'(2a)') 'variables = "x", "y", "z", ',              &
                                     '"viscosity"'
        write(igsy,'(2a,1pe10.3,1x,a,3(a,i5),a)')                      &
             'zone t = "Viscosity of the gas phase, ',                 &
             'T = ',time_io,time_unit(:l_time_unit),                   &
             '", i =',itec_vel,', j =',jtec_vel,', k =',               &
             ktec_vel,',  f=point'
      end if
      
      if (rank == 0 .and. b_enable_output) then

        write(ifls,'(/a,1pe12.4,1x,a,/72a)')                          &
                   'Viscosity of the gas phase, T = ',                &
                    time_io,time_unit,('-',i=1,72)
        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                    &
                   suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsy'
        
        write(ifls,'(2a)')                                            &
                'column   entry                           ','unit'     
        write(ifls,'(2a)')                                            &
                '1        x                               ','m'        
        write(ifls,'(2a)')                                            &
                '2        y                               ','m'        
        write(ifls,'(2a)')                                            &
                '3        z                               ','m'        
        write(ifls,'(2a)')                                            &
                '4        viscosity                       ','Pa s'
      
      end if


!c  gas phase velocity
      if (b_output_binary) then
        if (b_output_mpiio_single) then
          strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsk'
        else
          strbuffer = prefix(:l_prfx)//'_'//                           &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsk'
        end if
          
        call binary_file_open(Petsc_Comm_World, igsk,          &
                     trim(strbuffer), b_output_mpiio_single)

      else
        open(igsk,file=prefix(:l_prfx)//'_'//suffix(:l_sufx)//         &
                       trim(adjustl(str_rank))//'.gsk',                &
                       status='unknown',form='formatted')
      end if
      
!c  version information
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igsk, "#")
      end if

      if (b_output_binary) then
        strbuffer = 'dataset '//prefix(:l_prfx)//'' 
        offset_igsk = 0
        call tecplot_binary_write_header(Petsc_Comm_World, igsk,       &
                     "#!TDV102", trim(strbuffer), offset_igsk,         &
                     b_output_mpiio_single,.false.)
        
        nvarsgsk = 6+3*ng
        
        tec_variables(1:6) = [character(len=72) :: "x", "y", "z",      &
                              "grad_adv_x", "grad_adv_y","grad_adv_z"]
        do ic=1,ng
          tec_variables(ic+6) = nameg(ic)(:l_nameg(ic))//'_diff_x'  
        end do
        
        do ic=1,ng
          tec_variables(ic+ng+6) = nameg(ic)(:l_nameg(ic))//'_diff_y'  
        end do
        
        do ic=1,ng
          tec_variables(ic+2*ng+6) = nameg(ic)(:l_nameg(ic))//'_diff_z'  
        end do
        
        
        call tecplot_binary_write_variable(Petsc_Comm_World, igsk,     &
                     nvarsgsk, tec_variables(1:nvarsgsk), offset_igsk, &
                     b_output_mpiio_single,.false.)
        
        write(strbuffer,'(a,1pe10.3,1x,a)')                            &
              'Advective and Diffusive driving force gradients, T = ', &
              time_io,time_unit(:l_time_unit)
        
        offset_igsk_temp = offset_igsk    
        
        if (b_output_multizone) then
          call tecplot_binary_write_zoneinfo(Petsc_Comm_World, igsk,   &
                       trim(strbuffer),offset_igsk, itec_vel,          &
                       jtec_vel,ktec_vel,b_output_mpiio_single,        &
                       .false.,b_output_multizone)        
          offset_igsk = offset_igsk_temp +                             &
                        (11+len_trim(strbuffer))*4*nprcs + 4
        else
          call tecplot_binary_write_zoneinfo(Petsc_Comm_World, igsk,   &
                       trim(strbuffer),offset_igsk,itec_vel_gbl,       &
                       jtec_vel_gbl,ktec_vel_gbl,b_output_mpiio_single,&
                       .false.,b_output_multizone)        
          offset_igsk = offset_igsk_temp +                             &
                        (12+len_trim(strbuffer))*4
        end if
      else
        write(igsk,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(igsk,'(600a)') 'variables = "x", "y", "z", ',            &
                     '"grad_adv_x",','"grad_adv_y",','"grad_adv_z"',   &
                      (',"',nameg(ic)(:l_nameg(ic))//'_diff_x',        &
                       '"',ic=1,ng),                                   &
                      (',"',nameg(ic)(:l_nameg(ic))//'_diff_y',        &
                       '"',ic=1,ng),                                   &
                      (',"',nameg(ic)(:l_nameg(ic))//'_diff_z',        &
                       '"',ic=1,ng)
        write(igsk,'(2a,1pe10.3,1x,a,3(a,i5),a)')                      &
             'zone t = "Advective and Diffusive driving force ',       &
             'gradients, T = ',time_io,time_unit(:l_time_unit),        &
             '", i =',itec_vel,', j =',jtec_vel,', k =',               &
             ktec_vel,',  f=point'
      end if
      
      if (rank == 0 .and. b_enable_output) then

        write(ifls,'(/a,1pe12.4,1x,a,/72a)')                          &
                   'Advective and Diffusive driving force gradients', &
                    time_io,time_unit,('-',i=1,72)
        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                    &
                            suffix(:l_sufx)//'.gsk'
        
        write(ifls,'(2a)')                                            &
                'column   entry                           ','unit'     
        write(ifls,'(2a)')                                            &
                '1        x                               ','m'        
        write(ifls,'(2a)')                                            &
                '2        y                               ','m'        
        write(ifls,'(2a)')                                            &
                '3        z                               ','m'        
        write(ifls,'(2a)')                                            &
                '4        grad_adv_x                      ','m^3/d' 
        write(ifls,'(2a)')                                            &
                '5        grad_adv_y                      ','m^3/d'  
        write(ifls,'(2a)')                                            &
                '6        grad_adv_z                      ','m^3/d'  
        do ic = 1,ng
          strvar32 = trim(nameg(ic))//"_diff_x"
          if(ic+6 < 10) then
            write(ifls,'(i1,8x,2a)') ic+6,strvar32,'moles L^-1 m^-1'
          else if (ic+6 >= 10 .and. ic+6 < 100) then
            write(ifls,'(i2,7x,2a)') ic+6,strvar32,'moles L^-1 m^-1' 
          else if (ic+6 >= 100 .and. ic+6 < 1000) then
            write(ifls,'(i3,6x,2a)') ic+6,strvar32,'moles L^-1 m^-1' 
          else if (ic+6 >= 1000 .and. ic+6 < 10000) then
            write(ifls,'(i4,5x,2a)') ic+6,strvar32,'moles L^-1 m^-1'
          else
            write(ifls,'(i8,1x,2a)') ic+6,strvar32,'moles L^-1 m^-1' 
          end if
        end do
        
        do ic = 1,ng
          strvar32 = trim(nameg(ic))//"_diff_y"
          if (ic+ng+6 < 10) then
            write(ifls,'(i1,8x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1'
          else if (ic+ng+6 >= 10 .and. ic+ng+6 < 100) then
            write(ifls,'(i2,7x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1'
          else if (ic+ng+6 >= 100 .and. ic+ng+6 < 1000) then
            write(ifls,'(i3,6x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1'
          else if (ic+ng+6 >= 1000 .and. ic+ng+6 < 10000) then
            write(ifls,'(i4,5x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1'
          else
            write(ifls,'(i8,1x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1' 
          end if
        end do
        
        do ic = 1,ng
          strvar32 = trim(nameg(ic))//"_diff_z"
          if (ic+2*ng+6 < 10) then
            write(ifls,'(i1,8x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          else if (ic+2*ng+6 >= 10 .and. ic+2*ng+6 < 100) then
            write(ifls,'(i2,7x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          else if (ic+2*ng+6 >= 100 .and. ic+2*ng+6 < 1000) then
            write(ifls,'(i3,6x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          else if (ic+2*ng+6 >= 1000 .and. ic+2*ng+6 < 10000) then
            write(ifls,'(i4,5x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          else    
            write(ifls,'(i8,1x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          end if
        end do
      
      end if
        
!c  write section and allocate output buffer for       
      if (b_output_binary) then
        offset_igsa_temp = offset_igsa
        call tecplot_binary_write_section(Petsc_Comm_World,igsa,7,     &
                     nn_interfacial_offset,offset_igsa,                &
                     b_output_mpiio_single,.false.,b_output_multizone) 
        allocate(realbuffer(nn*7))
        realbuffer = 0.0d0
        
        do ic = 1, n  
          offset_igsa2_temp(ic) = offset_igsa2(ic)
          call tecplot_binary_write_section(Petsc_Comm_World,          &
                       igsa2_list(ic),18,nn_interfacial_offset,        &
                       offset_igsa2(ic),b_output_mpiio_single,.false., &
                       b_output_multizone)
        end do
        allocate(realbuffer2d(nn*18, n))
        realbuffer2d = 0.0d0
        
        if (blanc_diff_g) then
          do ic = 1, n  
            offset_igsf2_temp(ic) = offset_igsf2(ic)
            call tecplot_binary_write_section(Petsc_Comm_World,          &
                         igsf2_list(ic),6,nn_interfacial_offset,         &
                         offset_igsf2(ic),b_output_mpiio_single,.false., &
                         b_output_multizone)
          end do
          allocate(realbuffer2d_2(nn*6, n))
          realbuffer2d_2 = 0.0d0
        end if
        
        offset_igsr_temp = offset_igsr
        call tecplot_binary_write_section(Petsc_Comm_World,igsr,4,     &
                     nn_interfacial_offset,offset_igsr,                &
                     b_output_mpiio_single,.false.,b_output_multizone) 
        allocate(realbuffer2(nn*4))
        realbuffer2 = 0.0d0
        
        offset_igsy_temp = offset_igsy
        call tecplot_binary_write_section(Petsc_Comm_World,igsy,4,     &
                     nn_interfacial_offset,offset_igsy,                &
                     b_output_mpiio_single,.false.,b_output_multizone) 
        allocate(realbuffer3(nn*4))
        realbuffer3 = 0.0d0
        
        offset_igsk_temp = offset_igsk
        call tecplot_binary_write_section(Petsc_Comm_World,igsk,       &
                     nvarsgsk,nn_interfacial_offset,offset_igsk,       &
                     b_output_mpiio_single,.false.,b_output_multizone) 
        allocate(realbuffer4(nn*nvarsgsk))
        realbuffer4 = 0.0d0
      end if

!c  compute average interfacial velocities

      ivol2 = 0
      ivol_l = 0

      do ivz = 1, nvzgl          !increments in z-direction
        do ivy = 1, nvygl        !increments in y-direction
          do ivx = 1, nvxgl      !increments in x-direction

            ivol2 = ivol2 + 1  !counter - control volumes
            
!c  skip ghost nodes
#ifdef PETSC
            if(node_idx_lg2l(ivol2) < 0) then
                cycle
            end if
#endif

!c  find node pairs for interfacial velocities

            call cliqdisp (nvxgl, nvygl, nvzgl, ivx, ivy, ivz,         &
                           cvpair, npair,                              &
                           aread, areax,dist,dimcv,half_cells,         &
                           iavs,javs, njamxc,                          & 
                           nmax, idbg, cinfradx, radial_coordx)

!c  check connections

            if ((nvxgl .gt. 1 .and. npair(1) .eq. 0) .or.              &
                (nvygl .gt. 1 .and. npair(2) .eq. 0) .or.              &
                (nvzgl .gt. 1 .and. npair(3) .eq. 0)) goto 400
            
            ivol_l = ivol_l + 1

!c  loop over the dimensions x,y,z

            do idim = 1, 3

              idim2 = idim + 1
              idim3 = idim + 2
              if (idim2 .gt. 3) idim2 = idim2 - 3
              if (idim3 .gt. 3) idim3 = idim3 - 3

!c  zero average interfacial velocity

              velg(idim) = r0
            
              do ic=1,n
     
                velg_ca(ic,idim)= r0
                velg_cd(ic,idim)= r0
	            velg_dgm(ic,idim) = r0
	            velg_neq(ic,idim) = r0
                diff(ic,idim) = r0
                
              enddo
            
              grad_adv(idim)= r0
              
              do ic=1,ng
                grad_diff(ic,idim)= r0
              enddo

!c  loop over the number of control volume pairs in the dimension

              do ipair = 1, npair(idim)

                ivol = cvpair(idim, ipair, 1)
                jvol = cvpair(idim, ipair, 2)

!c  calculate average interfacial area between control volumes

                areai = areax(idim, ipair)

                do i1 = iavs(ivol), iavs(ivol+1)-1
                  if (javs(i1) .eq. jvol) then
                    i1sav = i1
                    go to 500
                  endif
                end do
                if (rank == 0) then
                  write(ilog,*) ' error-cannot find jvol in list'
                  write(ilog,*) ' ivol, jvol ', ivol, jvol
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
500             continue

!c  pressure, density, viscosity, relative permeability
              gpivol   (ivol) = gasp_m(mdens_g(ivol),ivol)  
              gpivol   (jvol) = gasp_m(mdens_g(jvol),jvol)  
              gdens    (ivol) = gasd_m(mdens_g(ivol),gmfrac(:,ivol))  
              gdens    (jvol) = gasd_m(mdens_g(jvol),gmfrac(:,jvol))  
              gvisc    (ivol) = gasv(gmfrac(:,ivol))  
              gvisc    (jvol) = gasv(gmfrac(:,jvol))  
              

!c  calculate gas properties at interface according to weighting scheme
              call wgprop(totgnew(1,ivol),totgnew(1,jvol),totgij   ,  &
                          gnew(1,ivol)   ,gnew(1,jvol)   ,gij      ,  &
                          gmfrac(1,ivol) ,gmfrac(1,jvol) ,gmfracij ,  &
                          relpermg(ivol) ,relpermg(jvol) ,relpgij  ,  &
                          gdens(ivol)    ,gdens(jvol)    ,densgij  ,  &
                          gvisc(ivol)    ,gvisc(jvol)    ,viscgij  ,  &
                          gpivol(ivol)   ,gpivol(jvol)   ,gpij     ,  &
                          zg(ivol)       ,zg(jvol)       ,            &
                          spt_weight     ,iupsg(i1)      ,            &
                          nc             ,ng             ,gacc     )
              
              
!c  calculate gradients that drive diffusive fluxes using the DGM model
!c  find flux between control volume pair
!c ----- Dusty Gas module -------------------------------------------------------

	          if (dgm) then

!c               solve A F = B
!c               computes fluxes F of all gas components at current c.v. interphase

	            call dgm_fluxdg (gnew(1,ivol)     ,gnew(1,jvol)  ,     &
                                 gij              ,gmfracij      ,     &
                                 zg(ivol)         ,zg(jvol)      ,     &
                                 densgij          ,gpij          ,     &
                                 tkel(ivol)       ,permij(i1sav) ,     &
                                 relpgij          ,tauij(i1sav)  ,     &
                                 gporij(i1sav)    ,deltaij(i1sav),     &
                                 rverysmall       ,                    &
                                 ludecomp         ,                    &
                                 fmat             ,                    &
                                 ipvt             ,                    &
                                 dgm_gflux        ,neflux       )
                call diff_grad(gnew(1,ivol)  ,gnew(1,jvol) ,           &
                               gmfracij      ,                         &
                               zg(ivol)      ,zg(jvol)     ,           &
                               densgij       ,tkel(ivol)   ,           &
                               gporij(i1sav),                          &
                               deltaij(i1sav)              ,           &
                               grad_diff(1,idim))
!c ----- Maxwell Stefan module --------------------------------------------------

			  else if (maxwell) then
			  
			    call ms_fluxdg (gnew(1,ivol)     ,gnew(1,jvol)    ,    &
                                gij              ,gmfracij        ,    &
                                zg(ivol)         ,zg(jvol)        ,    &
                                densgij          ,gpij            ,    &
                                tkel(ivol)       ,tauij(i1sav)    ,    &
                                gporij(i1sav)    ,deltaij(i1sav)  ,    &
                                rverysmall       ,                     &
                                ludecomp         ,fmat            ,    &
                                ipvt             ,equimolar       ,    &
                                ms_gflux         ,neflux       ) 
			  			  
			  endif

!c  find flux between control volume pair

!c when gas advection, report velocity and flux results

              if (ng .gt. 0 .and. gas_advection) then

                dgflux = fluxvg(gpivol(ivol),gpivol(jvol),            &
                                zg(ivol)    ,zg(jvol)    ,            &
                                r1          ,relpgij     ,            &
                                densgij     ,viscgij     ,            &
                                cinfvs_g(i1sav)          ,            &
                                gas_gravity ,gacc)

                grad_adv(idim) = fluxvg(gpivol(ivol),gpivol(jvol),    &
                                        zg(ivol)    ,zg(jvol)    ,    &
                                        r1          ,r1          ,    &
                                        densgij     ,r1          ,    &
                                        r1          ,                 &
                                        gas_gravity ,gacc)

              endif

              do ic=1,n

                  if (gas_advection) then

                    dgflux_ca(ic) = fluxvg(gpivol(ivol),gpivol(jvol), &
                                           zg(ivol)    ,zg(jvol)    , &
                                           totgij(ic)  ,relpgij     , &
                                           densgij     ,viscgij     , &
                                           cinfvs_g(i1sav)          , &
                                           gas_gravity ,gacc)
                  else

                    dgflux_ca(ic) = r0
                 
                  endif  

!c ----------------gas diffusion -------------------------
!c ---------------- fick's law, business as usual -------------------------
                       
				 if (blanc_diff_g) then
!c                  diffusion coefficient calc'd with LeBlanc's law

                     diff(ic,idim)  = gasdiff2                         & 
                                    ( gmfrac(1,ivol),gmfrac(1,jvol),   &
                                      gpivol(ivol)  ,gpivol(jvol)  ,   &
                                      zg(ivol)      ,zg(jvol)      ,   &
                                      gdens(ivol)   ,gdens(jvol)   ,   &
                                      ic            ,                  &
                                      iupsg(i1sav)  ,spt_weight    )

				    cinfrt = cinfrt_dg(i1) * diff(ic,idim)

			      else 
!c                   single constant diffusion
	                cinfrt = cinfrt_dg(i1sav)
			      endif                       
                  dgflux_cd(ic) =                                      &
                                  - fluxd(totgnew(ic,ivol),            &!diff flux
                                        totgnew(ic,jvol),              &
                                        cinfrt)
!cz     &                            - fluxdg(totgmfrac(ic,ivol)    ,
!cz     &                                     totgmfrac(ic,jvol)    ,
!cz     &                                     mdens_g(ivol)         ,
!cz     &                                     mdens_g(jvol)         ,
!cz     &                                     cinfrt                ,
!cz     &                                     gpivol    ,gpjvol     ,
!cz     &                                     zg(ivol)  ,zg(jvol)   ,
!cz     &                                     dens_i    ,dens_j     ,
!cz     &                                     iupsg(i1sav)          ,
!cz     &                                     spt_weight            )

				  if (dgm) then

!c                     check if there is gas phase
                    if (gporij(i1sav).lt.rverysmall) then
!c                     no gas phase 
                    else

				      dgflux_cd_dgm(ic) = cinfrt_dg(i1sav)             &
                                          * deltaij(i1sav)             &
                                          * dgm_gflux(ic)              &
                                          / tauij(i1sav)               &
                                          / gporij(i1sav)               
	                                                                    
                      neflux(ic)        = cinfrt_dg(i1sav)             &
                                          * deltaij(i1sav)             &
                                          * neflux(ic)                 &
                                          / tauij(i1sav)               &
                                          / gporij(i1sav) 
                    endif

				  else if (maxwell) then

!c                     check if there is gas phase
                    if (gporij(i1sav).lt.rverysmall) then
!c                     no gas phase
                    else

     				  dgflux_cd_dgm(ic) = cinfrt_dg(i1sav)             & 
                                          * deltaij(i1sav)             &
                                          * ms_gflux(ic)               &
                                          / tauij(i1sav)               &
                                          / gporij(i1sav)
                                                                        
	                  neflux(ic)        = cinfrt_dg(i1sav)             &
                                          * deltaij(i1sav)             &
                                          * neflux(ic)                 &
                                          / tauij(i1sav)               &
                                          / gporij(i1sav)

	                endif

	              else

	                dgflux_cd_dgm(ic) = dgflux_cd(ic)
	                neflux(ic)        = 0.d0
				     
                  endif        

              enddo
         

!c  velocity is the flux (m^3/day) divided
!c  by the interfacial area between the two control volumes

              velg(idim) = velg(idim) - dgflux / areai

              do ic=1,n

                velg_ca(ic,idim) = velg_ca(ic,idim) - dgflux_ca(ic)    &
                                                      / areai * 1.d+3 
      
                velg_cd(ic,idim) = velg_cd(ic,idim) - dgflux_cd(ic)    &
                                                      / areai * 1.d+3
                
	            velg_dgm(ic,idim) = velg_dgm(ic,idim)                  &
                                    - dgflux_cd_dgm(ic) / areai * 1.d+3
                                                                        
	            velg_neq(ic,idim) = velg_neq(ic,idim)                  &
                                    - neflux(ic) / areai * 1.d+3
              
              enddo
          
              end do

!c  find the average interfacial velocity in the x,y,z directions

              velg(idim) = velg(idim)/(float( npair(idim) ) + eps)

              do ic=1,n

                velg_ca(ic,idim) = velg_ca(ic,idim) /                  &
                                  (float(npair(idim))+eps)
      
                velg_cd(ic,idim) = velg_cd(ic,idim) /                  &
                                  (float(npair(idim))+eps)
                
	            velg_dgm(ic,idim) = velg_dgm(ic,idim) /                &
                                   (float(npair(idim))+eps)
     
                if (velg_dgm(ic,idim).gt.1.d50) then
                  velg_dgm = 0.0d0
                end if
			  
			    velg_neq(ic,idim) = velg_neq(ic,idim) /                &
                                   (float(npair(idim))+eps) 
                
              enddo

            end do

!c  write average interfacial velocities to output file__________________

            if (nvxgl.gt.1) then
              xg_out = xg(ivol2) - rhalf * dimcv(1,ivol2)
            else
              xg_out = xg(ivol2)
            end if

            if (nvygl.gt.1) then
              yg_out = yg(ivol2) - rhalf * dimcv(2,ivol2)
            else
              yg_out = yg(ivol2)
            end if

            if (nvzgl.gt.1) then
              zg_out = zg(ivol2) - rhalf * dimcv(3,ivol2)
            else
              zg_out = zg(ivol2)
            end if

!c           velocity
            gpi = gasp_m(mdens_g(ivol2),ivol2)  ! gas pressure

            if (b_output_binary) then
              realbuffer((ivol_l-1)*7+1:ivol_l*7) = (/                 &
                                     xg_out,yg_out,zg_out,             &
                                    (velg(idim),idim=1,3),             &
                                     gpi/pa_atm/) 
            else
              write(igsa,'(7e15.7)') xg_out,yg_out,zg_out,             &
                                    (velg(idim),idim=1,3),             &
                                     gpi/pa_atm
            end if

!c           density
            if (b_output_binary) then
              realbuffer2((ivol_l-1)*4+1:ivol_l*4) = (/                &
                                     xg_out,yg_out,zg_out,             &
                                     gasd_m(mdens_g(ivol2),            &
                                            gmfrac(:,ivol2))/)
            else
              write(igsr,'(4e15.7)') xg_out,yg_out,zg_out,             &
                                     gasd_m(mdens_g(ivol2),            &
                                            gmfrac(:,ivol2))
            end if

!c           viscosity
            if (b_output_binary) then
              realbuffer3((ivol_l-1)*4+1:ivol_l*4) = (/                &
                                     xg_out,yg_out,zg_out,             &
                                     gasv(gmfrac(:,ivol2))/)
            else
              write(igsy,'(4e15.7)') xg_out,yg_out,zg_out,             &
                                     gasv(gmfrac(:,ivol2))
            end if

!c           driving force gradients
            if (b_output_binary) then
              realbuffer4((ivol_l-1)*nvarsgsk+1:ivol_l*nvarsgsk) = (/  &
                                      xg_out,yg_out,zg_out,            &
                                  (grad_adv(idim),idim=1,3),           &
                                  (grad_diff(ig,1),ig=1,ng),           &
                                  (grad_diff(ig,2),ig=1,ng),           &
                                  (grad_diff(ig,3),ig=1,ng)/)
            else
              write(igsk,'(22e15.7)') xg_out,yg_out,zg_out,            &
                                  (grad_adv(idim),idim=1,3),           &
                                  (grad_diff(ig,1),ig=1,ng),           &
                                  (grad_diff(ig,2),ig=1,ng),           &
                                  (grad_diff(ig,3),ig=1,ng)
            end if
            
!c           mass fluxes
            igsa2 = igsa            

            do ic=1,n
          
              igsa2 = igsa2 + 1
              
              if (b_output_binary) then
                realbuffer2d((ivol_l-1)*18+1:ivol_l*18,ic) = (/        & 
                                    xg_out,yg_out,zg_out,              &
                                   (velg_ca(ic,idim),idim=1,3),        &
                                   (velg_cd(ic,idim),idim=1,3),        &
                  (velg_ca(ic,idim)+velg_dgm(ic,idim),idim=1,3),       &
                                   (velg_dgm(ic,idim),idim=1,3),       &
                                   (velg_neq(ic,idim),idim=1,3)/)
              else
                write(igsa2,'(24e15.7)') xg_out,yg_out,zg_out,         &
                                   (velg_ca(ic,idim),idim=1,3),        &
                                   (velg_cd(ic,idim),idim=1,3),        &
                  (velg_ca(ic,idim)+velg_dgm(ic,idim),idim=1,3),       &
                                   (velg_dgm(ic,idim),idim=1,3),       &
                                   (velg_neq(ic,idim),idim=1,3) 
              end if
            enddo  
            
            
            igsf2 = igsf_first
!c  variable diffusion coefficients
            if (blanc_diff_g) then
            
	          do ic=1,n
            
	            igsf2 = igsf2+1
                
                if (b_output_binary) then
                  realbuffer2d_2((ivol_l-1)*6+1:ivol_l*6,ic) = (/     & 
                               xg_out,yg_out,zg_out,                   &
                               (diff(ic,idim)/sec_per_days,idim=1,3)/)
                else
                  write(igsf2,'(6e15.7)') xg_out,yg_out,zg_out,        &
                        (diff(ic,idim)/sec_per_days,idim=1,3) 
                  
                 
                end if
                
              end do
              
            end if
            
400         continue

          end do
        end do
      end do
      
      if (b_output_binary) then
        if (b_output_multizone .or. .not.b_output_mpiio_single) then
          call binary_write_data(igsa, 7*ivol_l,                       &
                       realbuffer, offset_igsa,b_output_mpiio_single) 
        else
          call binary_subarray_initialize(7,b_mpiarray_igsa_g_init,    &
                      .true.,mpiarray_filetype_igsa_g,                 &
                      mpiarray_sizes_gbl_igsa_g,                       &
                      mpiarray_sizes_sub_igsa_g,                       &
                      mpiarray_starts_sub_igsa_g)
          call binary_write_data(igsa, 7*ivol_l,                       &
                       realbuffer, offset_igsa,mpiarray_filetype_igsa_g) 
        end if
        deallocate(realbuffer) 
        
        if (b_output_multizone .or. .not.b_output_mpiio_single) then
          do ic = 1, n
            call binary_write_data(igsa2_list(ic), ivol_l*18,          &
                         realbuffer2d(:,ic), offset_igsa2(ic),         &
                         b_output_mpiio_single)
          end do
        else
          do ic = 1, n
            call binary_subarray_initialize(18,b_mpiarray_igsa2_g_init,&
                        .true.,mpiarray_filetype_igsa2_g,              &
                        mpiarray_sizes_gbl_igsa2_g,                    &
                        mpiarray_sizes_sub_igsa2_g,                    &
                        mpiarray_starts_sub_igsa2_g)
            call binary_write_data(igsa2_list(ic), ivol_l*18,          &
                         realbuffer2d(:,ic), offset_igsa2(ic),         &
                         mpiarray_filetype_igsa2_g)
          end do
        end if
        deallocate(realbuffer2d)
        
        if (blanc_diff_g) then
          if (b_output_multizone .or. .not.b_output_mpiio_single) then
            do ic = 1, n
              call binary_write_data(igsf2_list(ic), ivol_l*6,         &
                           realbuffer2d_2(:,ic), offset_igsf2(ic),     &
                           b_output_mpiio_single)
            end do
          else
            do ic = 1, n
              call binary_subarray_initialize(6,                       &
                          b_mpiarray_igsf2_g_init,                     &
                          .true.,mpiarray_filetype_igsf2_g,            &
                          mpiarray_sizes_gbl_igsf2_g,                  &
                          mpiarray_sizes_sub_igsf2_g,                  &
                          mpiarray_starts_sub_igsf2_g)
              call binary_write_data(igsf2_list(ic), ivol_l*6,         &
                           realbuffer2d_2(:,ic), offset_igsf2(ic),     &
                           mpiarray_filetype_igsf2_g)
            end do
          end if
          deallocate(realbuffer2d_2) 
        end if
        
        if (b_output_multizone .or. .not.b_output_mpiio_single) then
          call binary_write_data(igsr, 4*ivol_l,                       &
                       realbuffer2, offset_igsr,b_output_mpiio_single)
        else
          call binary_subarray_initialize(4,b_mpiarray_igsr_g_init,    &
                      .true.,mpiarray_filetype_igsr_g,                 &
                      mpiarray_sizes_gbl_igsr_g,                       &
                      mpiarray_sizes_sub_igsr_g,                       &
                      mpiarray_starts_sub_igsr_g)
          call binary_write_data(igsr, 4*ivol_l,                       &
                       realbuffer2,offset_igsr,mpiarray_filetype_igsr_g) 
        end if
        deallocate(realbuffer2) 
            
        if (b_output_multizone .or. .not.b_output_mpiio_single) then
          call binary_write_data(igsy, 4*ivol_l,                       &
                       realbuffer3, offset_igsy,b_output_mpiio_single)
        else
          call binary_subarray_initialize(4,b_mpiarray_igsy_g_init,    &
                      .true.,mpiarray_filetype_igsy_g,                 &
                      mpiarray_sizes_gbl_igsy_g,                       &
                      mpiarray_sizes_sub_igsy_g,                       &
                      mpiarray_starts_sub_igsy_g)
          call binary_write_data(igsy, 4*ivol_l,                       &
                       realbuffer3,offset_igsy,mpiarray_filetype_igsy_g)
        end if
        deallocate(realbuffer3) 
               
        if (b_output_multizone .or. .not.b_output_mpiio_single) then
          call binary_write_data(igsk, nvarsgsk*ivol_l,                &
                       realbuffer4, offset_igsk,b_output_mpiio_single)
        else
          call binary_subarray_initialize(nvarsgsk,                    &
                      b_mpiarray_igsk_g_init,                          &
                      .true.,mpiarray_filetype_igsk_g,                 &
                      mpiarray_sizes_gbl_igsk_g,                       &
                      mpiarray_sizes_sub_igsk_g,                       &
                      mpiarray_starts_sub_igsk_g)
          call binary_write_data(igsk, nvarsgsk*ivol_l,                &
                       realbuffer4,offset_igsk,mpiarray_filetype_igsk_g)
        end if
        deallocate(realbuffer4)
      end if
        
      if(b_output_binary) then
        call binary_file_close(igsa,b_output_mpiio_single)
        do ic = 1, n
          call binary_file_close(igsa2_list(ic),b_output_mpiio_single)
        end do
        if (blanc_diff_g) then
          do ic = 1, n
            call binary_file_close(igsf2_list(ic),b_output_mpiio_single)
          end do
        end if
        
        call binary_file_close(igsr,b_output_mpiio_single)
        call binary_file_close(igsy,b_output_mpiio_single)
        call binary_file_close(igsk,b_output_mpiio_single)
      else
        close(igsa) 
        !Keep the file unit, this will be used later
        !call lun_free(igsa)
        igsa2 = igsa
        do ic=1,n
          igsa2 = igsa2 + 1
          close(igsa2)
          !Keep the file unit, this will be used later
          !call lun_free(igsa2)
        end do 
        
        igsf2 = igsf_first
        if (blanc_diff_g) then
          do ic=1,n
            igsf2 = igsf2 + 1
            close(igsf2)
            !Keep the file unit, this will be used later
            !call lun_free(igsf2)
          end do
        end if
        
        close(igsr)        
        close(igsy)
        close(igsk)
        !Keep the file unit, this will be used later
        !call lun_free(igsr)
        !call lun_free(igsy)
        !call lun_free(igsk)
      end if
      
      if (b_output_binary) then
        deallocate(tec_variables)
        deallocate(offset_igsa2)        
        deallocate(offset_igsa2_temp)
        deallocate(igsa2_list)
        if (blanc_diff_g) then
           deallocate(offset_igsf2)        
          deallocate(offset_igsf2_temp)
          deallocate(igsf2_list) 
        end if
      end if     

      if (update_permeability) then
 
        if (b_output_binary) then
          if (b_output_mpiio_single) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.hycx'
          else            
            strbuffer = prefix(:l_prfx)//'_'//                         &
                        suffix(:l_sufx)//trim(adjustl(str_rank))//'.hycx'
          end if
          call binary_file_open(Petsc_Comm_World, ihycx,     &
                       trim(strbuffer), b_output_mpiio_single)
        else
          open(ihycx,file=prefix(:l_prfx)//'_'//                       &
                     suffix(:l_sufx)//trim(adjustl(str_rank))//'.hycx', &
                     status='unknown',form='formatted')
        end if

!c  output of nodal hydraulic conductivities           

!c  title and variables
        if (b_output_binary) then
          strbuffer = 'dataset '//prefix(:l_prfx)//'' 
          offset_ihycx = 0
          call tecplot_binary_write_header(Petsc_Comm_World, ihycx,    &
                       "#!TDV102", trim(strbuffer), offset_ihycx,      &
                       b_output_mpiio_single, .false.)
          
          tec_variables(1:4) = [character(len=72) ::"x", "y", "z", "k"] 
          call tecplot_binary_write_variable(Petsc_Comm_World, ihycx,  &
                       4, tec_variables(1:4), offset_ihycx,            &
                       b_output_mpiio_single,.false.)  
        else
          write(ihycx,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          write(ihycx,'(a)') 'variables = "x", "y", "z", "k"'
        end if

!c  zone record
        if (b_output_binary) then
          write(strbuffer,'(a,1pe10.3,1x,a)') 'K - [m/s], T = ',       &
                time_io, time_unit(:l_time_unit)
          offset_ihycx_temp = offset_ihycx
          
          if (b_output_multizone) then
            call tecplot_binary_write_zoneinfo(Petsc_Comm_World,ihycx, &
                         trim(strbuffer),offset_ihycx,                 &
                         itec,jtec,ktec,                               &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            offset_ihycx = offset_ihycx_temp +                         &
                          (11+len_trim(strbuffer))*4*nprcs + 4
          else
            call tecplot_binary_write_zoneinfo(Petsc_Comm_World,ihycx, &
                         trim(strbuffer),offset_ihycx,                 &
                         itec_gbl,jtec_gbl,ktec_gbl,                   &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            offset_ihycx = offset_ihycx_temp +                         &
                          (12+len_trim(strbuffer))*4
          end if
        else
          write(ihycx,'(a,1pe10.3,1x,a,3(a,i5),a)')                    &
              'zone t = "K - [m/s], T = ', time_io,                    &
              time_unit(:l_time_unit), '", i =',itec,', j =',jtec,     &
              ', k =',ktec,',  f=point'          
        end if
        
!c  write section and allocate output buffer
        if (b_output_binary) then
          offset_ihycx_temp = offset_ihycx
          call tecplot_binary_write_section(Petsc_Comm_World,ihycx,4,  &
                       nn_offset,offset_ihycx,b_output_mpiio_single,   &
                       .false.,b_output_multizone) 
          allocate(realbuffer5(nn*4))
          realbuffer5 = 0.0d0
        end if

!c  output of hydraulic conductivities in units [m/s]
        ivol_l = 0
        
        do ivol = 1,nngl
#ifdef PETSC
          if(node_idx_lg2l(ivol) < 0) then
              cycle
          end if
#endif
          ivol_l = ivol_l + 1
          
          izn = mpropvs(ivol)
          if (b_output_binary) then
            realbuffer5((ivol_l-1)*4+1:ivol_l*4) = (/                  &
                        xg(ivol),yg(ivol),zg(ivol),perm_fac(ivol)/) 
          else
            write(ihycx,'(4e15.7)') xg(ivol),yg(ivol),zg(ivol),        &
                                    perm_fac(ivol)
          end if
        end do
        
        if (b_output_binary) then
          if (b_output_multizone .or. .not.b_output_mpiio_single) then
            call binary_write_data(ihycx,ivol_l*4,realbuffer5,         &
                         offset_ihycx,b_output_mpiio_single)
          else
            call binary_subarray_initialize(4,b_mpiarray_ihycx_g_init, &
                        .true.,mpiarray_filetype_ihycx_g,              &
                        mpiarray_sizes_gbl_ihycx_g,                    &
                        mpiarray_sizes_sub_ihycx_g,                    &
                        mpiarray_starts_sub_ihycx_g)
            call binary_write_data(ihycx,ivol_l*4,realbuffer5,         &
                         offset_ihycx,mpiarray_filetype_ihycx_g)
          end if
          deallocate(realbuffer5)
        end if

!c  close output file for initial hydraulic conductivity 
!c  distribution
        if(b_output_binary) then
          call binary_file_close(ihycx,b_output_mpiio_single)
        else
          close(ihycx)
          !Keep the file unit, this will be used later
          !call lun_free(ihycx)
        end if

      endif

      return
      end
