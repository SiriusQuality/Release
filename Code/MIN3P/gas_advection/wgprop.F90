!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/gas_advection/wgprop.F90 $
!---------------------------------------------------------------------
!********************************************************************!
!c ----------------------------------------------------------------------
!c subroutine wgprop
!c -----------------
!c
!c compute gas properties at interface i-j for gas transport calculations
!c
!c written by:      Sergi Molins - May 2, 2006
!c
!c last modified:   Sergi Molins - May 24,2006
!c                  weighted pressure
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           dens_i             = gas density at control volume i     + -
!c           dens_j             = gas density at control volume j     + -
!c           densg              = gas density at interface i-j        * +
!c           g_i(ng)            = gas concentration at c.v. i         + -
!c           g_j(ng)            = gas concentration at c.v. j         + -
!c           g(ng)              = gas concentration at interface      * +
!c           molfrac_i(ng,nn)   = gas molar fractions at c.v. i       + -
!c           molfrac_i(ng,nn)   = gas molar fractions at c.v. j       + -
!c           molfracg(ng,nn)    = gas molar fractions at interface    * +
!c           relpermg_i         = relative gas permeability at i      + -
!c           relpermg_j         = relative gas permeability at j      + -
!c           relpg              = relative gas permeability at i      * +
!c           totg_i(nc)         = total gas concentration at c.v. i   + -
!c           totg_j(nc)         = total gas concentration at c.v. j   + -
!c           totg(nc)           = total gas concentration at i-j      * +
!c           visc_i             = gas viscosity at control volume i   + -
!c           visc_j             = gas viscosity at control volume j   + -
!c           viscg              = gas viscosity at interface i-j      * +
!c           gpi                = gas pressure at control volume i    + -
!c           gpj                = gas pressure at control volume j    + - 
!c           gpij               = gas pressure at interface i-j       * + 
!c           zgi                = elevation of control volume i       + -
!c           zgj                = elevation of control volume j       + -
!c
!c           character:
!c           ----------
!c           iupsgx             = upstream node for gas transport     + -
!c           spt_weight         = spatial weighting for gas transp    * +
!c
!c           integer*4:
!c           ----------       
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c
!c common:   
!c
!c gen.f:    real*8:
!c           -------
!c           gacc               = gravity                             + -
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           r1                 = constant
!c           rhalf              = constant
!c
!c ----------------------------------------------------------------------

      subroutine wgprop(totg_i    ,totg_j    ,totg     ,              &
     &                  g_i       ,g_j       ,g        ,              &
     &                  molfrac_i ,molfrac_j ,molfracg ,              &
     &                  relpermg_i,relpermg_j,relpg ,                 &
     &                  dens_i    ,dens_j    ,densg    ,              &
     &                  visc_i    ,visc_j    ,viscg    ,              &
     &                  gpi       ,gpj       ,gpij     ,              &
     &                  zgi       ,zgj       ,                        &
     &                  spt_weight,iupsgx    ,                        &
     &                  nc        ,ng        ,gacc     )

      implicit none

!c  constants
      real*8 :: r0, rhalf, r1, hi, hj
      parameter (r0 = 0.0d0, rhalf = 0.5d0, r1 = 1.0d0)

!c  dimensions
      integer*4    nc ,ng

!c  gravity 
      real*8       gacc

!c  variables       input i      ,input j      ,output interface  
      real*8       totg_i(nc)   ,totg_j(nc)   ,totg(nc)    ,          &
     &             g_i(ng)      ,g_j(ng)      ,g(ng)       ,          &
     &             molfrac_i(ng),molfrac_j(ng),molfracg(ng),          &
     &             relpermg_i   ,relpermg_j   ,relpg       ,          &
     &             dens_i       ,dens_j       ,densg       ,          &
     &             visc_i       ,visc_j       ,viscg       ,          &
     &             gpi          ,gpj          ,gpij        ,          &
     &             zgi          ,zgj

      character*1  iupsgx     ! input
      
      character*12 spt_weight ! input  
      
      integer*4    ic         ! internal

     
!c     averaged properties at the interphase between adjacent control volumes
!c     for different weighting schemes

!c     centered weighting
      if (spt_weight.eq.'centered') then

        do ic=1,nc
          totg(ic)     = (totg_i(ic)+totg_j(ic))       * rhalf
        enddo
        do ic=1,ng
          g(ic)        = (g_i(ic)+g_j(ic))             * rhalf
          molfracg(ic) = (molfrac_i(ic)+molfrac_j(ic)) * rhalf
        enddo
        relpg          = (relpermg_i+relpermg_j)       * rhalf
        viscg          = (visc_i+visc_j)               * rhalf
        densg          = (dens_i+dens_j)               * rhalf
        gpij           = (gpi+gpj)                     * rhalf
      
!c     upstream weigthing 
      elseif (spt_weight.eq.'upstream') then

        if (iupsgx.eq.'i') then

          do ic=1,nc
            totg(ic)     = totg_i(ic)
          enddo
          do ic=1,ng
            g(ic)        = g_i(ic)
            molfracg(ic) = molfrac_i(ic)
          enddo
          relpg          = relpermg_i
          viscg          = visc_i
          densg          = dens_i
          gpij           = gpi
         
        else if (iupsgx.eq.'j') then
      
          do ic=1,nc
            totg(ic)     = totg_j(ic)
          enddo
          do ic=1,ng
            g(ic)        = g_j(ic)
            molfracg(ic) = molfrac_j(ic)
          enddo
          relpg          = relpermg_j
          viscg          = visc_j
          densg          = dens_j
          gpij           = gpj

!c       first time step - still undetermined
        else if (iupsgx.eq.'a') then

!c         fluid potential
          hi = gpi + dens_i * gacc * zgi
          hj = gpj + dens_j * gacc * zgj
         
          if ((hi-hj).gt.r0) then
            
            do ic=1,nc
              totg(ic)     = totg_i(ic)
            enddo
            
            do ic=1,ng
              g(ic)        = g_i(ic)
              molfracg(ic) = molfrac_i(ic)
            enddo
            
            relpg          = relpermg_i
            viscg          = visc_i
            densg          = dens_i
            gpij           = gpi

          else
            
            do ic=1,nc
              totg(ic)     = totg_j(ic)
            enddo
            
            do ic=1,ng
              g(ic)        = g_j(ic)
              molfracg(ic) = molfrac_j(ic)
            enddo
            
            relpg          = relpermg_j
            viscg          = visc_j
            densg          = dens_j
            gpij           = gpj

          end if

        end if

      endif

      return
    end
