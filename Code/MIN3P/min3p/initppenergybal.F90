!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/initppenergybal.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initppeb
!c -------------------
!c
!c physical parameters for energy balance
!c
!c
!c written by:      Sergio Andres Bea Jofre 
!c
!c last modified:   Sergio Andres Bea Jofre 
!c
!c  NOTE: 
!c ----------------------------------------------------------------------
      subroutine initppeb
 
      use parm
      use gen
      use phys
      use dens
      use file_unit, only : lun_free
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif

      integer :: i, ivol, izn, l_string, nzn1, nntemp
#ifdef PETSC
      integer :: nntemp_gbl
      PetscErrorCode :: ierrcode
#endif
      
      real*8 :: rdummy, heatcaps1, heatcondwxx, heatcondwyy,           &
                heatcondwzz, heatcondsxx, heatcondsyy, heatcondszz,    &
                denssolid1, disheatx1, disheaty1, disheatz1,           &
                xpmin, xpmax, ypmin, ypmax, zpmin, zpmax

      external findstrg, readbloc

      logical found_section, found_subsection
      character*72 subsection
      character*1 cdummy
      
      integer :: iskip, nskip

      real*8, parameter :: r0 = 0.0d0,              &
                           r1 = 1.0d0,              &
                           r1000 = 1.0d3,           &
                           r86400 = 86400.0d0,      &
                           tiny=1.0d-5,             &
                           r2600=2600.0d0,          &
                           r08=0.8d0

      dens_h2o = 1.0d+3
      visc_h2o = 1.0d-3

!cprovi--------------------------------------------------------------
!cprovi Read parameters for energy balance
!cprovi-------------------------------------------------------------- 
      section_header = 'physical parameters - energy balance'
      call readbloc (idat,itmp,section_header,found_section,.true.)
      
      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if

!c  terminate program if section header not found

      if (.not.found_section) then
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      else
        read(itmp,*,err=999,end=999) nzn1            !number of zones
      end if
      
!c  read specific heat of water

        subsection = 'specific heat of water'
        heatcapw = 4.182d0
        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
          read(itmp,*,err=998,end=998) heatcapw
          heatcapw=heatcapw/r1000
        end if
                
!c  read specific heat of vapour (only if evaporation is computed)
        if (evaporation) then
          subsection = 'specific heat of vapour'
          heatcapv = 1.996d0
          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
            read(itmp,*,err=998,end=998) heatcapv
            heatcapv=heatcapv/r1000
          end if
        end if
!c----------------------------------------------------------------------------------
!c  read thermal conductivity for gas (only if variably saturated flow is solved)
!c----------------------------------------------------------------------------------
        if (variably_saturated) then
          subsection = 'gas thermal conductivity'
          heatcondg = 2.0736d0 ! KJ / m / day / K
          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
            read(itmp,*,err=998,end=998) heatcondg
            heatcondg=heatcondg*r86400/r1000
          end if
        end if
        
!c----------------------------------------------------------------------------------        
!c  read specific heat of air (only if evaporation is computed)
!c----------------------------------------------------------------------------------
        if (evaporation) then
          subsection = 'specific heat of air'
          heatcapa = 1.006d0 
          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
            read(itmp,*,err=998,end=998) heatcapa
            heatcapa=heatcapa/r1000
          end if
        end if
        
!c  read energy parameters as nodal values from separate file

        subsection = 'read energy balance parameters from file'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
!cprovi----------------------------------------------------------------------
!cprovi Units
!cprovi Thermal capacity => J kg-1 Kelvin-1
!cprovi Thermal conductivity => J s-1 m-1 Kelvin-1
!cprovi Solid density => kg m-3      
!cprovi----------------------------------------------------------------------
          open(ienergy,file=prefix(:l_prfx)//'.energybal',    &
              status='old', form='formatted',err=997)
          read(ienergy,*,err=998,end=998) cdummy
          read(ienergy,*,err=998,end=998) cdummy
          read(ienergy,*,err=998,end=998) cdummy
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
                read(ienergy,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif
            read(ienergy,*,err=998,end=998) rdummy, rdummy, rdummy,   &
     &                                      heatcaps(ivol),           &
     &                                      heatcondw(ivol,1),        &
     &                                      heatcondw(ivol,2),        &
     &                                      heatcondw(ivol,3),        &
     &                                      heatconds(ivol,1),        &
     &                                      heatconds(ivol,2),        &
     &                                      heatconds(ivol,3),        &
     &                                      disheatx(ivol),           &
     &                                      disheaty(ivol),           &
     &                                      disheatz(ivol),           &
     &                                      denssolid(ivol)     
          end do 

          close(ienergy)
          call lun_free(ienergy)
          
!cprovi----------------------------------------------------------------------
!cprovi Transform J s-1 m-1 oC-1 => KJ day-1 m-1 oC-1      
!cprovi----------------------------------------------------------------------  
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppeb_1)                       &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)                  
    !$omp do schedule(static)
#endif     
          do ivol = 1,nngl
             heatcaps(ivol)=heatcaps(ivol)/r1000
             heatcondw(ivol,1)=heatcondw(ivol,1)*r86400/r1000
             heatcondw(ivol,2)=heatcondw(ivol,2)*r86400/r1000
             heatcondw(ivol,3)=heatcondw(ivol,3)*r86400/r1000
             heatconds(ivol,1)=heatconds(ivol,1)*r86400/r1000
             heatconds(ivol,2)=heatconds(ivol,2)*r86400/r1000
             heatconds(ivol,3)=heatconds(ivol,3)*r86400/r1000
          end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif   
          goto 1000
          
        end if    
         
     
        nntemp = 0 
        do izn = 1,nzn1


          subsection = 'number and name of zone'

          call findzone(subsection,itmp,found_subsection,izn, &
     &                  zone_name)

          if (found_subsection) then

            call readzone(itmp,icnv,ilog,zone_name,found_subsection)

          else
            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error in input file'
              write(ilog,*) 'section "',section_header(:l_string),'"'
              write(ilog,*) 'zone number "',izn, '" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if

         
        subsection = 'specific heat of solid'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcaps1
          heatcaps1=heatcaps1/r1000
        else  
          heatcaps1=r08 ! for sandstones 
        end if
        
        subsection = 'water thermal conductivity in x-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondwxx
          heatcondwxx=heatcondwxx*r86400/r1000
        else 
          if (rank == 0) then  
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'subsection "',subsection(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'water thermal conductivity in y-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondwyy
          heatcondwyy=heatcondwyy*r86400/r1000
        else
          if (rank == 0) then  
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',section_header(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'water thermal conductivity in z-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondwzz
          heatcondwzz=heatcondwzz*r86400/r1000
        else
          if (rank == 0) then  
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',section_header(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
         call petsc_mpi_finalize
#endif
         stop
        end if
        
        subsection = 'solid thermal conductivity in x-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondsxx
          heatcondsxx=heatcondsxx*r86400/r1000
        else
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',subsection(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'solid thermal conductivity in y-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondsyy
          heatcondsyy=heatcondsyy*r86400/r1000
        else
          if (rank == 0) then  
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',subsection(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'solid thermal conductivity in z-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondszz
          heatcondszz=heatcondszz*r86400/r1000
        else
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',subsection(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'solid bulk density'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) denssolid1
        else  
          denssolid1 = r2600 
        end if
        
!cprovi-----------------------------------------------------------------
!cprovi Dispersivities for heat equation 
!cprovi-----------------------------------------------------------------        
        disheatx1=r0  
        subsection = 'longitudinal dispersivity'
       
        call findstrg(subsection,icnv,found_subsection)
    
        if (found_subsection) then

             read(icnv,*,err=999,end=999) disheatx1
         
        end if

        disheaty1=r0  
        subsection = 'transverse horizontal dispersivity'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then

                read(icnv,*,err=999,end=999) disheaty1
         
        end if           


        disheatz1=r0  
        subsection = 'transverse vertical dispersivity'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then

                read(icnv,*,err=999,end=999) disheatz1


        end if          !(found_subsection)
        
        
        

!c  read coordinates delineating zone

          subsection = 'extent of zone'

          call findstrg(subsection,icnv,found_subsection)

          if (found_subsection) then

            read(icnv,*,err=999,end=999) xpmin,xpmax,ypmin,ypmax, &
     &                                   zpmin,zpmax

          else
            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading input file'
              write(ilog,*) 'section "',section_header(:l_string),'"'
              write(ilog,*) 'zone "', zone_name(:l_zone_name),'"'
              l_string = index(subsection,'  ')-1
              if (l_string.eq.-1.or.l_string.gt.72) then
                 l_string=72
              end if
              write(ilog,*) 'subsection "',subsection(:l_string),   &
     &                      '" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if

!c  define extent of zone

          xpmin = xpmin-tiny
          xpmax = xpmax+tiny
          ypmin = ypmin-tiny
          ypmax = ypmax+tiny
          zpmin = zpmin-tiny
          zpmax = zpmax+tiny
 
!c  assign physical parameters to global system
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppeb_2)                       &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol)                                               &
    !$omp reduction(+:nntemp)
    !$omp do schedule(static)
#endif        
          do ivol = 1,nngl                  !loop over control volumes

             if ((xg(ivol).gt.xpmin).and.(xg(ivol).lt.xpmax)) then
              if ((yg(ivol).gt.ypmin).and.(yg(ivol).lt.ypmax)) then
                if ((zg(ivol).gt.zpmin).and.(zg(ivol).lt.zpmax)) then
                    heatcaps(ivol) = heatcaps1    
                    heatcondw(ivol,1)=heatcondwxx
                    heatcondw(ivol,2)=heatcondwyy
                    heatcondw(ivol,3)=heatcondwzz
                    heatconds(ivol,1)=heatcondsxx
                    heatconds(ivol,2)=heatcondsyy
                    heatconds(ivol,3)=heatcondszz
                    denssolid(ivol) = denssolid1 
                    disheatx(ivol) = disheatx1
                    disheaty(ivol) = disheaty1
                    disheatz(ivol) = disheatz1                    
                  end if
#ifdef PETSC
                  if(node_idx_lg2l(ivol) > 0) then
                    nntemp = nntemp+1
                  end if
#else
                  nntemp = nntemp+1
#endif
                end if
              end if
          end do                          !loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif 
        end do                     !loop over property zones

#ifdef PETSC
        call MPI_Allreduce(nntemp, nntemp_gbl,1,MPI_INTEGER4,MPI_SUM,  &
                           Petsc_Comm_World,ierrcode)
        CHKERRQ(ierrcode)
        nntemp = nntemp_gbl
#endif

!c  check if material properties have been assigned correctly

        if (nntemp>nngbl) then

          if (rank == 0) then  
            write(ilog,*)
            write(ilog,'(a)')  &                 !screen or logbook
     &            'warning ...........'
            write(ilog,'(a,i6,a)')                                      &
     &            'energy medium properties have been assigned to  ',   &
     &             nntemp,' control volumes'
            write(ilog,'(a,i6)')                                        &
     &            'the actual number of control volumes is only',nngbl
            write(ilog,'(/72a)')('-',i=1,72)
          end if

        elseif (nntemp<nngbl) then
            
          if (rank == 0) then
            write(ilog,*) 'could assign energy properties only to ',    &
     &                  nntemp, ' control volumes'
            write(ilog,*) 'the actual number of control volumes is ',nngbl
          end if

          goto 999

        end if                             !(nntemp.....)

      goto 1000

997   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED' 
        write(ilog,*) 'file ', prefix(:l_prfx)//'.energybal missing'
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

998   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading nodal material properties field ', &
     &                'from file'
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file'
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end subroutine
