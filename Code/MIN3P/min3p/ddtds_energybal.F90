!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/ddtds_energybal.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine ddtds
!c -----------------
!c
!c assign fluid densities and viscosities as a function of total component 
!c concentrations and an empirical linear coefficient taken
!c using the formula 
!c density = freshwater density + EC, where
!c
! written by:   Sergio Andres Bea
!c
!c last modified:
!c
!c references:
!c
!
!c external: - 
!c ----------------------------------------------------------------------

subroutine ddtds_energybal (isinitial)

use parm
use gen
use chem
use dens
#ifdef OPENMP
use omp_lib 
#endif
#ifdef PETSC
use petsc_mpi_common, only : petsc_mpi_finalize
#endif

implicit none

integer :: ivol, ic, itemp 

real*8 :: visco_c, visco_temp, temp_n, tempref_n, tempk1, tempk2,      &
          ddens_c, ddens_temp

logical         :: isinitial 
logical iserror
external zero_r8
integer, parameter :: iscreen=6 
real*8, parameter          ::  &
      r10=10.0d0, &
      r2=2.0d0, &
      r3=3.0d0, &
      r0= 0.0d0, &
      r1=1.0d0, &
      r100=100.0d0 , &
      r150=150.0d0, &
      r1000=1.0d3, &
      r06=1.0d-6, &
      visc_coef1=1.85d0, &
      visc_coef2=-4.1d0, & 
      visc_coef3=44.5d0, &
      rkelvin=273.15d0, &
      zero=1.0d-20, &
      r86400=86400.0d0
real*8               :: &
 massfrac0     
integer, parameter   :: &
 model_sutra=1, &
 model_diersch=2

visco_c    = 0.0d0
visco_temp = 0.0d0
temp_n     = 0.0d0
tempref_n  = 0.0d0
tempk1     = 0.0d0
tempk2     = 0.0d0
ddens_c    = 0.0d0
ddens_temp = 0.0d0


!cprovi----------------------------------------------------
!cprovi clear density and viscosity vectors
!cprovi----------------------------------------------------
if (update_viscosity.or.update_viscosity_temp) then
  viscosity=r0 
end if
!cprovi-------------------------------------------------------------------
!cprovi Compute reference density based on Pitzer equations 
!cprovi-------------------------------------------------------------------
if (ispitzerdens.and.isinitial) then
!cprovi-------------------------------------------------------------------
!cprovi Compute density at zero concentrations (initial)
!cprovi-------------------------------------------------------------------
        cpz_loc(1:nc)=zero
        cpz_loc(nc+1:nc+nx)=zero
        call compute_density_ (phase,r0,r0,cpz_loc,ref_dens,.false.,iserror)
        if (iserror) then 
             if(rank == 0) then
                write (iscreen,*) 'Error when call compute_density_ in the phase object'
             end if
#ifdef PETSC
             call petsc_mpi_finalize
#endif
             stop 
        end if        
end if                           
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi Check after
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
if (density_field.and.isinitial) then
#ifdef OPENMP
    !$omp parallel                                                    & 
    !$omp if (nngl > numofloops_thred_ddtds_energybal_1)              &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ic, itemp, ivol, massfrac, massfrac0,              &
    !$omp tds_ic, tempk, temp_n, tempref_n, tot_tds,                  &
    !$omp visco_c, visco_temp)                  
    !$omp do schedule(static)
#endif 
 do ivol = 1,nngl    !loop over control volumes
        
        !cprovi----------------------------------------------------------------------------
        !cprovi Initial values for viscosity ratios are unity 
        !cprovi---------------------------------------------------------------------------- 
        visco_c = r1 
        visco_temp = r1 
        tot_tds = r0

        do ic=1,nc-1
        itemp = ncorder(ic) 
        if ((namec(itemp) .ne. 'h+').and.         &
             (namec(itemp) .ne. 'h+1').and.        &
             (namec(itemp) .ne. 'o2(aq)').and.     &
             (namec(itemp) .ne. 'h2(aq)').and.     &
              (namec(itemp) .ne. 'n2(aq)').and.     &
             (namec(itemp) .ne. 'ch4(aq)')) then

          if (specify_dd_comp) then
            tds_ic = totcnew(itemp,ivol) * gfwdd(itemp) ! M/L --> g/L = Kg/M^3
          else
            tds_ic = totcnew(itemp,ivol) * gfwc(itemp)  ! M/L --> g/L = Kg/M^3
          end if

            tot_tds = tot_tds + tds_ic
        end if

        end do
 
        tds_new(ivol) = tot_tds
        
       !cprovi----------------------------------------------------------------------------
       !cprovi Compute the viscosity ratio for concentrations 
       !cprovi This expression is from Cordier/Goblet, 1991)
       !cprovi This expression is also from Diersch and Kolditz (1998,2002) 
       !cprovi---------------------------------------------------------------------------- 
        if (update_viscosity) then

            massfrac = tot_tds / density(ivol)
            massfrac0 = ref_tds / ref_dens
            visco_c = r1 + visc_coef1 * massfrac + visc_coef2 * massfrac**r2 + visc_coef3 * massfrac**r3 
            visco_c = visco_c / (r1 + visc_coef1 * massfrac0 + visc_coef2 * massfrac0**r2 + visc_coef3 * massfrac0**r3)
                                   
        end if               
        !cprovi----------------------------------------------------------------------------            
        !cprovi Compute the viscosity ratio for temperature 
        !cprovi----------------------------------------------------------------------------
        if (update_viscosity_temp) then
          if (iviscomodel==model_sutra) then
        
               temp_n = cvisco4 / (tempnew(ivol) + cvisco5)
               tempref_n = cvisco4 / (tempref_dens + cvisco5)
               visco_temp = r10**(temp_n-tempref_n)
        
          else if(iviscomodel==model_diersch) then
        
               temp_n = (tempnew(ivol)-r150)/r100
               tempref_n = (tempref_dens-r150)/r100
               visco_temp = r1 + cvisco1*tempref_n + cvisco2*(tempref_n**r3)  
               visco_temp = visco_temp / (r1 + cvisco1*temp_n + cvisco2*(temp_n**r3))
        
          else  
               if(rank == 0) then
                 write (*,*) 'Viscosity model not defined'
               end if
#ifdef PETSC
               call petsc_mpi_finalize
#endif
               stop    
          end if 
        end if  
        !cprovi----------------------------------------------------------------------------
        !cprovi Compute the viscosity as a function of concentrations and temperature
        !cprovi in a similar way than Diersch and Kolditz (1998)
        !cprovi----------------------------------------------------------------------------    
        viscosity(ivol) = ref_visco * visco_c * visco_temp   
        !cprovi-------------------------------------------------
        !cprovi Compute thermal conductivity of water 
        !cprovi Yen et al. (1991)
        !cprovi Yen, Y.-C., K. C. Cheng, and S. Fukusako (1991), Review of intrinsic
        !cprovi thermophysical properties of snow, ice, sea ice and frost, in Proceedings
        !cprovi of 3rd International Symposium on Cold Regions Heat Transfer, edited
        !cprovi by J. P. Zarling and S. L. Fausett, pp. 187?218, Univ. of Alaska Fairbanks,
        !cprovi Fairbanks.
        !cprovi-------------------------------------------------
        if (update_heatcondw) then
          tempk=tempnew(ivol)+rkelvin
          heatcondw(ivol,1) = clambdaw1 * r86400 * (clambdaw2 + clambdaw3 * tempk + clambdaw4 * tempk * tempk) / r1000          
          heatcondw(ivol,2) = heatcondw(ivol,1)
          heatcondw(ivol,3) = heatcondw(ivol,1)
        end if
      
    
end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif
else
 
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi Loop of control volumes 
!cprovi----------------------------------------------------------------
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_ddtds_energybal_2)              &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ic, iserror, itemp, ivol,                          &
    !$omp cpz_loc, ddens_c, ddens_temp, massfrac, massfrac0,          &
    !$omp tds_ic, tempk, tempk1, tempk2, temp_n, tempref_n,           &
    !$omp tot_tds, visco_c, visco_temp)                  
    !$omp do schedule(static)
#endif
do ivol = 1,nngl    !loop over control volumes
        !cprovi----------------------------------------------------------------------------
        !cprovi Initial values for viscosity ratios are unity 
        !cprovi----------------------------------------------------------------------------
        visco_c = r1
        visco_temp = r1 
        !cprovi----------------------------------------------------------------
        !cprovi Compute TDS
        !cprovi----------------------------------------------------------------
        tot_tds = r0

        do ic=1,nc-1
         itemp = ncorder(ic) 
         if ((namec(itemp) .ne. 'h+').and.         &
              (namec(itemp) .ne. 'h+1').and.        &
              (namec(itemp) .ne. 'o2(aq)').and.     &
              (namec(itemp) .ne. 'h2(aq)').and.     &
               (namec(itemp) .ne. 'n2(aq)').and.     &
              (namec(itemp) .ne. 'ch4(aq)')) then

           if (specify_dd_comp) then
             tds_ic = totcnew(itemp,ivol) * gfwdd(itemp) ! M/L --> g/L = Kg/M^3
           else
             tds_ic = totcnew(itemp,ivol) * gfwc(itemp)  ! M/L --> g/L = Kg/M^3
           end if

           tot_tds = tot_tds + tds_ic
         end if

        end do
 
        tds_new(ivol) = tot_tds
!cprovi----------------------------------------------------------
!cprovi Initialice density  
!cprovi----------------------------------------------------------        
        density(ivol) = r0         
!cprovi----------------------------------------------------------
!cprovi  
!cprovi----------------------------------------------------------
        if (nonlindens_heat) then 
        !cprovi----------------------------------------------------------
        !cprovi Constant for the density changes by temperature 
        !cprovi See Yusa and Oishi (1989)
        !cprovi----------------------------------------------------------
               tempk1=tempref_dens+rkelvin
               tempk2=tempnew(ivol)+rkelvin
               ddens_temp = cdens1+r1000*tempk1*(cdens2+tempk1*(cdens3-tempk1*cdens4)) 
               ddens_temp = cdens1+r1000*tempk2*(cdens2+tempk2*(cdens3-tempk2*cdens4)) - ddens_temp  
        else                                 
               ddens_temp = drho_dt*(tempnew(ivol) - tempref_dens)                 
        end if
        
        
            
        if (ispitzerdens) then
                !cprovi-------------------------------------------------------------------
                !cprovi Compute density at given concentration using Pitzer equations
                !cprovi-------------------------------------------------------------------
                cpz_loc(1:nc)=cnew(1:nc,ivol)
                cpz_loc(nc+1:nc+nx)=cx(1:nx,ivol)  
                !computer_density_ : m_phase (compute_density_) 
                !                    -> m_aqueousphase (compute_density_) 
                !                    -> m_aqueousphasepitzer (compute_density_)
                !                    -> m_parentaqueousphase subroutines
                call compute_density_ (phase,r0,r0,cpz_loc,ddens_c,.false.,iserror)    
                if (iserror) then 
                  write (iscreen,*) 'Error when call compute_density_ in the phase object'
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop 
                end if 
                
                density_pitzer(ivol) = ddens_c
                
                ddens_c = ddens_c - ref_dens
                   
        else
                ddens_c = drho_dc * (tds_new(ivol) - ref_tds)
        end if
            
        density(ivol) = ref_dens + ddens_temp + ddens_c 
       !cprovi----------------------------------------------------------------------------
       !cprovi Compute the viscosity ratio for concentrations 
       !cprovi This expression is from Cordier/Goblet, 1991)
       !cprovi This expression is also from Diersch and Kolditz (1998,2002) 
       !cprovi----------------------------------------------------------------------------  
        if (update_viscosity) then

            massfrac = tot_tds / density(ivol)
            massfrac0 = ref_tds / ref_dens
            visco_c = r1 + visc_coef1 * massfrac      &
                      + visc_coef2 * massfrac**r2     &
                      + visc_coef3 * massfrac**r3 
            visco_c = visco_c / (r1 + visc_coef1 * massfrac0  &
                      + visc_coef2 * massfrac0**r2     &
                      + visc_coef3 * massfrac0**r3)                       
        end if                      
        !cprovi----------------------------------------------------------------------------            
        !cprovi Compute the viscosity ratio for temperature 
        !cprovi----------------------------------------------------------------------------
        if (update_viscosity_temp) then
          if (iviscomodel==model_sutra) then
               temp_n = cvisco4 / (tempnew(ivol) + cvisco5)
               tempref_n = cvisco4 / (tempref_dens + cvisco5)
               visco_temp = r10**(temp_n-tempref_n)
          else if(iviscomodel==model_diersch) then
               temp_n = (tempnew(ivol)-r150)/r100
               tempref_n = (tempref_dens-r150)/r100
               visco_temp = r1 + cvisco1*tempref_n + cvisco2*(tempref_n**r3)  
               visco_temp = visco_temp / (r1 + cvisco1*temp_n + cvisco2*(temp_n**r3))
          else  
               if(rank == 0) then
                 write (*,*) 'Viscosity model not defined'
               end if
#ifdef PETSC
               call petsc_mpi_finalize
#endif
               stop    
          end if 
        end if  
        !cprovi----------------------------------------------------------------------------
        !cprovi Compute the viscosity as a function of concentrations and temperature
        !cprovi in a similar way than Diersch and Kolditz (1998)
        !cprovi----------------------------------------------------------------------------    
        viscosity(ivol) = ref_visco * visco_c * visco_temp     
        !cprovi-------------------------------------------------
        !cprovi Compute thermal conductivity of water 
        !cprovi Yen et al. (1991)
        !cprovi Yen, Y.-C., K. C. Cheng, and S. Fukusako (1991), Review of intrinsic
        !cprovi thermophysical properties of snow, ice, sea ice and frost, in Proceedings
        !cprovi of 3rd International Symposium on Cold Regions Heat Transfer, edited
        !cprovi by J. P. Zarling and S. L. Fausett, pp. 187?218, Univ. of Alaska Fairbanks,
        !cprovi Fairbanks.
        !cprovi-------------------------------------------------
        if (update_heatcondw) then
          tempk=tempnew(ivol) + rkelvin
          heatcondw(ivol,1) = clambdaw1 * (clambdaw2 + clambdaw3 * tempk + clambdaw4 * tempk * tempk) 
          heatcondw(ivol,2) = heatcondw(ivol,1)
          heatcondw(ivol,3) = heatcondw(ivol,1)
        end if 
      
    
    end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif
end if
    
return
end subroutine 