!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/outputlc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine outputlc
!c -------------------
!c
!c write results of local chemistry computations to generic output file
!c
!c written by:      Uli Mayer - October, 95
!c
!c last modified:   Uli Mayer - December 6, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(n)               = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c                                - new time level [moles/l water]
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           gammax(nx)         = activity coefficient of             + -
!c                                secondary aqueous species
!c           g(ng)              = gas concentrations                  + -
!c                                - new time level [moles/l air]
!c
!c           integer*4:
!c           ----------
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, log file               + -
!c
!c           character:
!c           ----------
!c           section_header     = section header                      + -
!c
!c common: 
!c chem.f:   real*8:
!c           -------
!c           alkfacc(nc)        = alkalinity factors for components   + -
!c                                as species in solution
!c           alkfacx(nx)        = alkalinity factors for aqueous      + -
!c                                complexes
!c           areac(nm)          = reactivity term                     + -
!c           conct()            = species concentrations (temporary)  * *
!c           csb(nsb)           = concentrations of sorbed species    * *
!c                                - new time level [moles/l bulk]
!c           csb_ion(nsb_ion,nthreads)
!c                              = concentrations of sorbed species    * *
!c                                - new time level [moles/l bulk]
!c                                (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    * *
!c                                - new time level [moles/l bulk]
!c                                (surface-complex)
!c           ehfac              = factor for calculating Eh from pe   + -
!c           eqm(nm,nthreads)   = equilibrium constants for minerals  + -
!c           eqmx(nmx,nthreads) = equilibrium constants for excluded  + -
!c                                minerals
!c           gammac()           = species activities (temporary)      * *
!c           phic(nm,nthreads)  = volume fractions of minerals        + -
!c           rgasatm            = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           rhobulk            = dry bulk density of porous medium   + -
!c           satm(nm,nthreads)  = saturation indices for minerals     * *
!c           satmx(nm)          = saturation indices for excluded     * *
!c                                minerals
!c           sion1(nthreads)    = ionic strength (local chemistry)    + -
!c           tempk              = temperature [deg K]                 + -
!c           totan(nc,nthreads) = total sorbed component              + -
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk)
!c           totcn(n,nthreads)  = total aqueous component             + -
!c                                concentrations
!c                                - new time level [moles/l water]
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in minerals
!c           xnumx(nmx*nc)      = stoichiometric coefficients of      + -
!c                                components in excluded minerals
!c
!c           integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamx(nmx+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in excluded mineral
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamx(nmx*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in excluded mineral
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           nbio               = number of biomass components        + -
!c           nc                 = number of components                + -
!c           ng                 = number od gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c           nx                 = number of aqueous complexes         + -
!c
!c           logical:
!c           --------
!c           compute_alkalinity = .true.  -> calculate alkalinity     + -
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c           noncompetitive_sorption = logical array for activation   + -
!c                                     of noncompetitive sorption
!c                                     reactions
!c           reactive_minerals  = .true.  -> consider mineral         + -
!c                                           dissolution-
!c                                           precipitation reactions
!c
!c           character:
!c           ----------
!c           component_type(nc) = 'aqueous' = aqueous component       + -
!c                                'surface' = surface site
!c                                'biomass' = biomass
!c           isotherm_type(nc)  = definition of sorption isotherm     + -  
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namem(nm)          = mineral names                       + -
!c           namemx(nmx)        = names of excluded minerals          + -
!c           namesb(nsb)        = names of sorbed species             + -
!c           namesb_ion(nsb_ion)= names of sorbed species             + -
!c                                (ion-exchange)
!c           namesb_surf(nsb_surf)= names of sorbed species           + -
!c                                  (surface-complex)
!c           namet()            = species names (temporary)           * *
!c           namex(nx)          = names of secondary aqueous species  + -
!c           redox_master       = 'o2(aq)'                            + -
!c                                'h2(aq)'
!c                                'e-1'
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c
!c local:    real*8:
!c           -------
!c           alk_carb           = carbonate alkalinity [eq/L]
!c           alk_noncarb        = noncarbonate alkalinity [eq/L]
!c           alk_tot            = total alkalinity [eq/L]
!c           alk_carb_mg        = carbonate alkalinity [mg/L CaCO3]
!c           alk_noncarb_mg     = non-carbonate alkalinity
!c                                [mg/L CaCO3]
!c           alk_tot_mg         = total alkalinity [mg/L CaCO3]
!c           eh                 = computed Eh of solution [mV]
!c           ph                 = computed ph of solution
!c           pe                 = computed pe of solution
!c           r0                 = constant
!c           r100               = conversion factor
!c           satlog             = saturation index
!c           totsitec           = total concentration of surface 
!c                                site [mol/L h2o]
!c           zbal               = charge balance [%]
!c           zneg               = sum of negative charge
!c           zpos               = sum of positive charge
!c
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           isb                = counter (sorbed species)
!c           isites             = counter (surface sites)
!c           ix                 = counter (aqueous complexes)
!c
!c           logical:
!c           --------
!c           found              = logical variable 
!c
!c external: alkcalc   = compute alkalinity
!c           cbalance  = compute charge balance 
!c           concsort  = sort species concentrations in decreasing 
!c                       order
!c           rstatlc   = run specific statistics (local chemistry)
!c           satindex  = compute saturation index
!c           totconc   = total aqueous component concentrations
!c ----------------------------------------------------------------------
 
      subroutine outputlc(c,cx,gammac,gammax,g,igen,ilog,section_header)
 
      use parm
      use chem
      use gen, only : idbg, rank, b_enable_output, b_enable_output_gen
#ifdef OPENMP
      use omp_lib 
#endif
 
      implicit none
      
      integer :: igen, ilog
      real*8 :: c, cx, gammac, gammax, g
      
      integer :: tid, i, i1, i2, i3, ii, ic, ic2, icount, icur, ireac, &
                 istart, istop, istart2, istop2, next, ix, ig, im, imx,&
                 isites, isb

      real*8 :: ph, pe, eh, alk_carb, alk_noncarb, alk_tot,            &
                alk_carb_mg, alk_noncarb_mg, alk_tot_mg, totsitec,     &
                satindex, satlog, zbal, zpos, zneg, gammatemp
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r100 = 100.0d0

      external alkcalc, cbalance, concsort, rstatlc, satindex,    &
     &         totconc

      logical found

      character*72 section_header
 
      dimension c(*), cx(*), gammac(*), gammax(*), g(*)
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

      totsitec = r0
      namet(:) = ''
 
      write(igen,'(/a)') 'results:'
      write(igen,'(72a/)')('-',i=1,72)
 
!c  convert h+1 concentrations to pH
 
      ic = 0
      found = .false.
      do while (.not.found.and.ic.lt.nc)
        ic = ic+1
        if (namec(ic).eq.'h+1') then
          ph = -dlog10(gammac(ic)*c(ic))
          found = .true.
        end if
      end do

!c  computed pH of solution

      if (found) then
        write(igen,'(a,f12.4)')                                   &
     &  'computed pH of solution:           pH = ',ph
      end if

!c  compute pe and Eh

      ic = 0
      found = .false.
      do while (.not.found.and.ic.lt.nc)
        ic = ic+1
        if (redox_master.eq.'e-1'.and.namec(ic).eq.'e-1') then
          pe = -dlog10(c(ic))
          eh = ehfac * tempk * pe
          found = .true.
        elseif (redox_master.eq.'o2(aq)'.and.                         &
     &          namec(ic).eq.'o2(aq)') then                            
          pe = 21.5045d0                                              &
     &       - dlog10(gammac(nc)**0.5d0)                              &
     &       + dlog10((gammac(ic)*c(ic))**0.25d0)                     &
     &       - ph                                                      
          eh = ehfac * tempk * pe                                      
          found = .true.                                               
        elseif (redox_master.eq.'h2(aq)'.and.                         &
     &          namec(ic).eq.'h2(aq)') then                            
          pe = -1.562d0                                               &
     &       - dlog10((gammac(ic)*c(ic))**0.50d0)                     &
     &       - ph
          eh = ehfac * tempk * pe
          found = .true.
        end if
      end do

!c  computed pe and Eh of solution

      if (found) then
        write(igen,'(a,f12.4)')                                       &
     &  'computed pe of solution:           pe = ',pe                  
        write(igen,'(a,f12.4,a)')                                     &
     &  'computed Eh of solution:           Eh = ',eh,' mV'
      end if

!c  ionic strength

      write(igen,'(a,1pe12.4)')                                       &
     &'ionic strength:                     I = ',sion1(tid)
                                                                       
      if (compute_alkalinity) then
                                                                       
        call alkcalc(alk_carb,alk_noncarb,alk_tot,                    &
     &               alk_carb_mg,alk_noncarb_mg,alk_tot_mg,           &
     &               alkfacc,alkfacx,c,cx,iax,jax,nc,nx,              &
     &               namec,namex)
                                                                       
        write(igen,'(a,1pe12.4,a)')                                   &
     &  'alkalinity:                       Alk = ',alk_tot,' eq/L'     
        write(igen,'(a,1pe12.4,a)')                                   &
     &  'carbonate alkalinity:           C-Alk = ',alk_carb,' eq/L'    
        write(igen,'(a,1pe12.4,a)')                                   &
     &  'non-carbonate alkalinity:      NC-Alk = ',alk_noncarb,' eq/L' 
        write(igen,'(a,1pe12.4,a)')                                   &
     &  'alkalinity:                       Alk = ',alk_tot_mg,        &
     &  ' mg/L CaCO3'                                                  
        write(igen,'(a,1pe12.4,a)')                                   &
     &  'carbonate alkalinity:           C-Alk = ',alk_carb_mg,       &
     &  ' mg/L CaCO3'                                                  
        write(igen,'(a,1pe12.4,a)')                                   &
     &  'non-carbonate alkalinity:      NC-Alk = ',alk_noncarb_mg,    &
     &  ' mg/L CaCO3'

      end if

!c  total aqueous component concentrations
 
      call totconc(c,cx,totcn(:,tid))

      write(igen,'(/a)')'total concentrations - aqueous phase:'
      write(igen,'(a)')'--------------------------------------'
      write(igen,'(a)')'species               conc.'
      write(igen,'(a)')'---------------------------'

      do ic=1,nc-1
        if (component_type(ic).eq.'aqueous') then
          write(igen,'(a12,1x,1pe15.4)') namec(ic),totcn(ic,tid)
        end if
      end do

!c  free species concentrations and activity coefficients
 
      write(igen,'(/a)')'components as species in solution:'
      write(igen,'(a)')'----------------------------------'
      write(igen,'(a)')'species               conc.          gamma'
      write(igen,'(a)')'------------------------------------------'
      do ic=1,nc
        if (component_type(ic).eq.'aqueous') then
          write(igen,'(a12,1x,2(1pe15.4))') namec(ic),c(ic),gammac(ic)
        end if
      end do
 
!c  secondary aqueous species concentrations and activity coefficients
 
!c  assign to temporary storage

      do ix=1,nx
        namet(ix) = namex(ix)
        conct(ix) = cx(ix)
        gammat(ix) = gammax(ix)
      end do

!c  sort concentrations in decreasing order

      call concsort(conct,gammat,namet,nx)

      write(igen,'(/a)')'secondary aqueous species:'
      write(igen,'(a)')'--------------------------'
      write(igen,'(a)')'species               conc.          gamma'
      write(igen,'(a)')'------------------------------------------'
      do ix=1,nx
        write(igen,'(a12,1x,2(1pe15.4))') namet(ix),conct(ix),gammat(ix) 
      end do 
      
!c  biomass concentrations
      
      if (nbio.gt.0) then
        
        write(igen,'(/a)')'biomass concentrations:'
        write(igen,'(a)') '-----------------------'
        write(igen,'(a)')'species               conc.'
        write(igen,'(a)')'---------------------------'

        do ic=1,nc-1
          if (component_type(ic).eq.'biomass') then
            write(igen,'(a12,1x,1pe15.4)') namec(ic),totcn(ic,tid)
          end if
        end do
      
      end if
      

!c  gas concentrations 

      if (ng.gt.0) then

!c  assign to temporary storage

        do ig=1,ng
          namet(ig) = nameg(ig)
          conct(ig) = g(ig)
        end do

!c  sort concentrations in decreasing order

        call concsort(conct,gammat,namet,ng)

        write(igen,'(/a)')'gases:'
        write(igen,'(a)')'-------'
        write(igen,'(a)')'species               conc.  partial pres.'
        write(igen,'(a)')'------------------------------------------'
        do ig=1,ng
          write(igen,'(a12,1x,2(1pe15.4))') namet(ig),                   &
     &                                   conct(ig),rgasatm*tempk*conct(ig)
        end do
      end if

!c  sorbed species concentrations - non-competitive sorption

      if (noncompetitive_sorption.and.section_header.ne.              &
     &    'boundary conditions - reactive transport') then

        write(igen,'(/a)')'linear sorption:'
        write(igen,'(a)') '----------------'    
        write(igen,'(a)')'component             conc.               '
        write(igen,'(a)')'               [mol/l bulk]               '
        write(igen,'(a)')'------------------------------------------'
        do ic=1,nc-1
          if (isotherm_type(ic).eq.'linear') then
          write(igen,'(a12,1x,1pe15.4)') namec(ic), totan(ic,tid)
        end if
        end do
    
    end if
 
!c  sorbed species concentrations

      if ((nsb_ion.gt.0.or.nsb_surf.gt.0).and.section_header.ne. &
     &    'boundary conditions - reactive transport') then

!c  output of sorbed species concentrations

        write(igen,'(/a)')'sorbed species:'
        write(igen,'(a)')'---------------'
        
        !write(*,*) "sorption_group ", trim(sorption_group)
        !write(*,*) "nsb_surf ", nsb_surf, " nsb_ion ", nsb_ion

!c  output for surface complexation reactions

        if (sorption_group.eq.'surface-complexation' .or. (nsb_surf.gt.0 &
            .and.sorption_group.eq.'surface-complex and ion-exchange')) then
          write(igen,'(2a)')'species          [mol/L H2O]    ',       &
                            '[mol/m^2]             [%]'                
          write(igen,'(2a)')'--------------------------------',       &
                            '-------------------------'
          
!cff fix up for isites > 1
          do isites = 1,nsites
            ic = iaic(isites)
            totsitec = totcsn_surf(ic,tid)+totcn(ic,tid)
            write(igen,'(a12,3(3x,1pe12.4))')                         &
                  namec(ic),c(ic),                                    &
                  c(ic)/site_mass(isites)/site_area(isites),          &
                  c(ic)/totsitec*100.0d0
            !write(igen,'(5(a, 1x, 1pe12.4, 1x))') "check: totcsn", totcsn_surf(ic), "totcn", totcn(ic), "c", c(ic), "site_mass", site_mass(isites), "site_area", site_area(isites)
          end do
          
          do isb = 1,nsb_surf
!cff fix up for isites > 1
            isites = 1
            write(igen,'(a12,3(3x,1pe12.4))')                         &
                  namesb_surf(isb),csb_surf(isb,tid),                 &
                  csb_surf(isb,tid)/site_mass(isites)/                &
                  site_area(isites),                                  &
                  csb_surf(isb,tid)/totsitec*100.0d0
            !write(igen,'(3(a, 1x, 1pe12.4, 1x))') "check: csb", csb_surf(isb), "site_mass", site_mass(isites), "site_area", site_area(isites)
          end do
        end if  

!c  output for ion exchange reactions

        if (sorption_group.eq.'ion-exchange' .or. (nsb_ion.gt.0 .and. &
            sorption_group.eq.'surface-complex and ion-exchange')) then

          write(igen,'(2a)')'species          [meq/100g]     ',       &
     &                      '[mol/l bulk]'                             
          write(igen,'(2a)')'--------------------------------',       &
     &                      '------------'                             
          do isb = 1,nsb_ion                                               
            write(igen,'(a12,2(3x,1pe12.4))')                         &
     &        namesb_ion(isb),csb_ion(isb,tid),                       &
     &        rhobulk/r100*csb_ion(isb,tid)/chargesb_ion(isb)
          end do
        end if

      end if       !(nsb.gt.0)

!c  mineral concentrations, volume fractions and surface area
 
      if (nm.gt.0) then
        write(igen,'(/a)')'minerals:'
        write(igen,'(a)')'---------'
        do im = 1,nm
          if (.not.far_from_equil(im)) then
!c_isotope
            if (isofrac(im)) then
              satm(im, tid) = eqm(im, tid)**(-r1)
              ireac = iamd(im)            
              istart = iam(im)
              istop = iam(im+1)-1 
                  
              do i1 = istart, istop ! loop through components in mineral
                icount = 0
                ic = jam(i1)
                next = 0
                do i = 1, nifrm(im)  ! loop through isotope sets
                    istart2 = next + iamdiso(im)
                    icur = iamdiso2(im) + i - 1
                    istop2 = iamdiso(im) + jamdiso2(icur) - 1
                    next = jamdiso2(icur)
                    gammatemp = r0
                    !loop through isotope compents in set
                    do i2 = istart2, istop2 
                      ii = jamdiso(i2)
                      !check to see if component is an isotope
                      if (ii.eq.ic) then 
                        icount = icount + 1
                        !if so sum the isotope activities
                        do i3 = istart2, istop2 
                          ic2 = jamdiso(i3)
                          gammatemp = gammatemp + gammac(ic2)*c(ic2)
                        end do 
                        satm(im,tid) = satm(im,tid) *(gammatemp**xnum(i1))
                      end if
                    end do
                end do 
                !if not calculate the saturaton index the normal way  
                if (icount.eq.0) then    
                  satm(im,tid) = satm(im,tid) * (gammac(ic)*c(ic))**xnum(i1)
                end if
              end do   !i1
            else
              satm(im,tid) = satindex(c,eqm(im,tid),gammac,xnum,iam,   &
                                    jam,im)
            end if
          end if
        end do
        if (reactive_minerals) then
          write(igen,'(2a)')'mineral               SI',               &
     &                      '               phi              area'     
          write(igen,'(2a)')'------------------------',               &
     &                      '------------------------------------'     
          do im = 1,nm                                                 
            if (.not.far_from_equil(im)) then                          
              satlog = dlog10(satm(im,tid))                                
            else                                                       
              satlog = r0                                              
            end if                                                     
            write(igen,'(a12,1x,f12.3,2(6x,1pe12.4))')                &
    &             namem(im),satlog, phic(im,tid),areac(im)
          end do
        else
          write(igen,'(a)')'mineral               SI'
          write(igen,'(a)')'------------------------'
          do im = 1,nm
            if (.not.far_from_equil(im)) then
              satlog = dlog10(satm(im,tid))
            else
              satlog = r0
            end if
            write(igen,'(a12,1x,f12.3)') namem(im),satlog
          end do
        end if
      end if

!c  excluded minerals

      if (nmx.gt.0) then
        write(igen,'(/a)')'excluded minerals:'
        write(igen,'(a)') '------------------'
        do imx = 1,nmx
          satmx(imx) = satindex(c,eqmx(imx,tid),gammac,xnumx,         &
     &                            iamx,jamx,imx)
        end do
        write(igen,'(a)')'mineral               SI'
        write(igen,'(a)')'------------------------'
        do imx = 1,nmx
          satlog = dlog10(satmx(imx))
          write(igen,'(a12,1x,f12.3)') namemx(imx),satlog
        end do
      end if
 
!c  charge balance
 
      call cbalance(c,cx,zbal,zpos,zneg)
      write(igen,'(/,a)')'charge balance:'
      write(igen,'(a)')'---------------'
      write(igen,'(a,1pe11.3,3x,a,1pe10.3)')                      &
     &          'sum of positive charge: ',zpos,                  &
     &          'sum of negative charge: ',zneg                    
      write(igen,'(a,4x,1pe10.3,1x,a)') 'charge balance error:',  &
     &                                   zbal,'%'
 
!c  write run specific statistics to screen and output file

      if (rank == 0) then
        call rstatlc(ilog)
        if (b_enable_output .and. b_enable_output_gen) then
          call rstatlc(igen)
        end if
      end if

      return
      end
