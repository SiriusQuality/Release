!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/drateint_new.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine drateint_new
!c -----------------------
!c
!c compute derivative of reaction rates for intra-aqueous kinetic 
!c reactions (new database format)
!c
!c written by:      Uli Mayer - July 14, 02
!c                  based on drateint.f
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c           cx(nx)             = concentrations of aqueous           + -
!c                                complexes
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           gammac(nc)         = activity coefficients of components + -
!c                                as species in solution
!c           gammax(nx)         = activity coefficients of aqueous    + -
!c                                complexes
!c           phim(nm)           = mineral volume fractions            + -
!c           rate               = rate for current intra-aqueous      * +
!c                                kinetic reactions [mol/(l h2o*day)
!c           totc(nc-1)         = total aqueous component             + -
!c                                concentrations
!c
!c           integer*4:
!c           ----------
!c           iaq                = pointer to current intra-aqueous    + -
!c                                kinetic reactions
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           eqaq(nac,nthreads) = equilibrium constants for intra-    + -
!c                                aqueous kinetic reactions
!c           faqic(naq*nc)      = inhibition factors C^c              + -
!c           faqit(naq*nc)      = inhibition factors T^a              + -
!c           faqim(naq*nm)      = inhibition factors phi^m            + -
!c           faqhc(naq*nc)      = half saturation constants C^c       + -
!c           faqht(naq*nc)      = half saturation constants T^a       + -
!c           faqhm(naq*nm)      = half saturation constants phi^m     + -
!c           ordaqic(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for inhibition terms C^c
!c           ordaqit(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for inhibition terms T^a
!c           ordaqim(naq*nm)    = order of intra-aqueous kinetic      + -
!c                                reaction for inhibition terms phi^m
!c           ordaqhc(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms C^c
!c           ordaqht(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms T^a
!c           ordaqhm(naq*nm)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms phi^m
!c           ordaqc(naq*nc)     = order of intra-aqueous kinetic      + -
!c                                reaction C^c
!c           ordaqt(naq*nc)     = order of intra-aqueous kinetic      + -
!c                                reaction T^a
!c           ordaqx(naq*nx)     = order of intra-aqueous kinetic      + -
!c                                reaction C^x
!c           sataq(naq,nthreads)= IAP/K for intra-aqueous kinetic     * *
!c                                reactions
!c           scalfac_aq(naq)    = scaling factors for intra-aqueous   + -
!c                                kinetic reactions
!c           ratecaq(naq,nthreads)
!c                              = log of rate constant for intra-     + -
!c                                aqueous kinetic reactions
!c                                (units: liter -  moles - seconds)
!c           cinc(n,nthreads)   = concentrations of species as        + -
!c                                components in solution
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           cxinc(nx,nthreads) = concentrations of aqueous           + -
!c                                complexes
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           totcinc(n,nthreads)= total aqueous component             + -
!c                                concentrations
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           xnuaq(naq*nc)      = stoichiometric coefficient of       + -
!c                                components in intra-aqueous
!c                                kinetic reaction
!c
!c           integer*4:
!c           ----------
!c           iaaq(naq+1)        = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           iaaqic(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms C^c)
!c           iaaqit(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms T^a)
!c           iaaqim(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms phi^m)
!c           iaaqhc(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms C^c)
!c           iaaqht(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           iaaqhm(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms phi^m)
!c           iaaqc(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                C^c
!c           iaaqt(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                T^a
!c           iaaqx(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                C^x
!c           jaaq(naq*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaqic(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms C^c)
!c           jaaqit(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms T^a)
!c           jaaqim(naq*nm)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms phi^m)
!c           jaaqhc(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms C^c)
!c           jaaqht(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           jaaqhm(naq*nm)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms phi^m)
!c           jaaqc(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                C^c
!c           jaaqt(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                T^a
!c           jaaqx(naq*nx)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                C^x
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c
!c
!c           character:
!c           ----------
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           rtype_aq(naq)      = reaction type of intra-aqueous      * +
!c                                kinetic reaction
!c                                'monod'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = product of reacting species
!c           prodrcinc          = product of reacting species
!c                                (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c           sataqinc           = IAP/K for intra-aqueous kinetic
!c                                reactions - incremented
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           iaqic              = counter
!c           iaqit              = counter
!c           iaqim              = counter
!c           iaqhc              = counter
!c           iaqht              = counter
!c           iaqhm              = counter
!c           iaqt               = counter
!c           ic                 = counter (components)
!c           im                 = counter (minerals)
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine drateint_new(rate,totc,c,cx,gammac,gammax,phim,      &
                              drtinc,iaq,scalfacaq)
 
      use parm
      use chem
      use gen, only : ilog, idbg, rank, b_enable_output
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
      implicit none
      
      real*8 :: rate, totc, c, cx, gammac, gammax, phim, drtinc,       &
                scalfacaq
      
      integer :: iaq
      
      integer :: tid, i, i1, i2, ic, im, ix, iaqc, iaqhc, iaqht, iaqhm,&
                 iaqit, iaqic, iaqim, iaqx, iaqt, istart, istop,       &
                 istart2, istop2, itop, ibottom, icur, next, itemp,    &
                 iaqhst, istart3, istop3, info_debug

      real*8 :: prodrc, prodrcinc, sataqinc, alphar, alpharinc, sumic, &
                sumicinc, alphartot, alphartop, alphartotinc,          &
                alphartopinc
      
      dimension c(*),cx(*),gammac(*),gammax(*),totc(*),phim(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

      sataqinc = r0
 
!c  form product of reactants for current intra-aqueous kinetic 
!c  reaction
 
      prodrc = r1
      prodrcinc = r1

!c  fractional order terms - total aqueous component concentrations

      istart2 = iaaqt(iaq)
      istop2 = iaaqt(iaq+1)-1      
      
      if (istop2.ge.istart2) then

        do iaqt = istart2,istop2

          ic = jaaqt(iaqt)
          prodrc = prodrc * totc(ic)**ordaqt(iaqt)
          prodrcinc = prodrcinc * totcinc(ic,tid)**ordaqt(iaqt)

        end do

      end if

!c  fractional order terms - activities of components as species
!c  in solution

      istart2 = iaaqc(iaq)
      istop2 = iaaqc(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqc = istart2,istop2

          ic = jaaqc(iaqc)

          prodrc = prodrc * (gammac(ic)*c(ic))**ordaqc(iaqc)
          prodrcinc = prodrcinc * (gammac(ic)*cinc(ic,tid))**ordaqc(iaqc)

        end do

      end if

!c  fractional order terms - activities of components as species
!c  in solution

      istart2 = iaaqx(iaq)
      istop2 = iaaqx(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqx = istart2,istop2

          ix = jaaqx(iaqx)

          prodrc = prodrc * (gammax(ix)*cx(ix))**ordaqx(iaqx)
          prodrcinc = prodrcinc *                                     &
                      (gammax(ix)*cxinc(ix,tid))**ordaqx(iaqx)

        end do

      end if

!c  hyperbolic terms - activities of components as concentrations in
!c  solution

      istart2 = iaaqhc(iaq)
      istop2 = iaaqhc(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqhc = istart2,istop2

          ic = jaaqhc(iaqhc)

!csevinc          prodrc = prodrc * (gammac(ic)*c(ic)
!csevinc     &           / (faqhc(iaqhc) + gammac(ic)*c(ic)))**ordaqhc(iaqhc) 
!csevinc          prodrcinc = prodrcinc * (gammac(ic)*cinc(ic)
!csevinc     &              / (faqhc(iaqhc)
!csevinc     &                 + gammac(ic)*cinc(ic)))**ordaqhc(iaqhc)
          prodrc = prodrc * (c(ic)                                    &
     &           / (faqhc(iaqhc) + c(ic)))**ordaqhc(iaqhc) 
          prodrcinc = prodrcinc * (cinc(ic,tid)                       &
     &              / (faqhc(iaqhc)                                   &
     &                 + cinc(ic,tid)))**ordaqhc(iaqhc)    

        end do

      end if

!c  hyperbolic terms - total aqueous component concentrations

      istart2 = iaaqht(iaq)
      istop2 = iaaqht(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqht = istart2,istop2

          ic = jaaqht(iaqht)
          prodrc = prodrc                                             &
                * (totc(ic)/(faqht(iaqht)                             &
                + totc(ic)))**ordaqht(iaqht) 
          prodrcinc = prodrcinc * (totcinc(ic,tid)/                   &
                    (faqht(iaqht)+totcinc(ic,tid)))**ordaqht(iaqht)

        end do

      end if
      
!c_isotopes      
!c  hyperbolic terms - sum of total aqueous component concentrations

      istart2 = iaaqhst2(iaq)
      istop2 = iaaqhst2(iaq+1)-1
      itemp = r0

      if (istop2.ge.istart2) then

        do iaqhst = istart2,istop2
        
           istart3 = iaaqhst(iaq)+itemp
           istop3 = istart3+ntsca(iaqhst)-1
           sumic = r0
           sumicinc = r0
           do i2 = istart3, istop3
             ic = jaaqhst(i2)
             sumic = sumic + totc(ic)
             sumicinc = sumicinc + totcinc(ic, tid)
           end do

           prodrc = prodrc                       &
               * (sumic/(faqhst(iaqhst) +        &
                  sumic))**ordaqhst(iaqhst) 
                                                  
           prodrcinc = prodrcinc                  &
                * (sumicinc/(faqhst(iaqhst) +     &
                   sumicinc))**ordaqhst(iaqhst) 
            
           itemp = itemp + ntsca(iaqhst)

        end do

      end if
      
!c_isotopes
!c  isotope fractionation

      if (isofraca(iaq)) then
       
        if (rtype_aq(iaq).eq.'irreversible') then

          next = 0
          do i = 1, nifra(iaq)  ! loop through isotope sets
             istart2 = next + iamdisoa(iaq)
             icur = iamdisoa2(iaq) + i - 1
             istop2 = iamdisoa(iaq) + jamdisoa2(icur) - 1
             next = jamdisoa2(icur)
             ibottom = jamdisoa(istart2)
             alphartot = r1
             alphartop = r1
             alphartotinc = r1
             alphartopinc = r1
             !loop through isotope compents in set
             do i2 = istart2+1, istop2 
                 itop = jamdisoa(i2)
                 alphar = totc(itop)/totc(ibottom)*jamdalphaa(i2)
                 alpharinc = totcinc(itop,tid)/totcinc(ibottom, tid)*  &
                             jamdalphaa(i2)
                 alphartot = alphartot + alphar
                 alphartotinc = alphartotinc + alpharinc
             
                 istart = iaaq(iaq)
                 istop = iaaq(iaq+1)-1 
                 do i1 = istart, istop
                     ic = jaaq(i1)
                     if (ic.eq.itop) then
                        alphartop = alphar
                        alphartopinc = alpharinc
                     end if
                 end do
             end do
             prodrc = prodrc*alphartop/alphartot
             prodrcinc = prodrcinc*alphartopinc/alphartotinc

          end do
        else   !irreversibe
          if (rank == 0 .and. b_enable_output) then
            write(*,'(3a)') nameaq(iaq),                               &
                'isotope fractionation is only defined for ',          &
                'irreversible intra-aqueous kinetic reactions'
            write(ilog,'(3a)') nameaq(iaq),                            &
                'isotope fractionation is only defined for ',          &
                'irreversible intra-aqueous kinetic reactions'
          end if
        end if
      end if   !isofrac

!c  hyperbolic terms - minerals
!c  Note: This is at the present time not necessary, since phi is not 
!c        considered implicitly, included only for future modifications

      istart2 = iaaqhm(iaq)
      istop2 = iaaqhm(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqhm = istart2,istop2

          im = jaaqhm(iaqhm)
          prodrc = prodrc                                             &
                * (phim(im)/(faqhm(iaqhm)                             &
                + phim(im)))**ordaqhm(iaqhm) 
          prodrcinc = prodrcinc * (phim(im)/                          &
                    (faqhm(iaqhm)+phim(im)))**ordaqhm(iaqhm)

        end do

      end if
 
!c  inhibition terms - total aqueous component concentrations

      istart2 = iaaqit(iaq)
      istop2 = iaaqit(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqit = istart2,istop2

          ic = jaaqit(iaqit)

          prodrc = prodrc * (faqit(iaqit)                             &
                / (faqit(iaqit)+totc(ic)))**ordaqit(iaqit)
          prodrcinc = prodrcinc * (faqit(iaqit)                       &
                   / (faqit(iaqit)+totcinc(ic,tid)))**ordaqit(iaqit)

        end do

      end if

!c  inhibition terms - activities of components as species in solution

      istart2 = iaaqic(iaq)
      istop2 = iaaqic(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqic = istart2,istop2

          ic = jaaqic(iaqic)

          prodrc = prodrc * (faqic(iaqic)                             &
                / (faqic(iaqic)+gammac(ic)*c(ic)))**ordaqic(iaqic)
          prodrcinc = prodrcinc * (faqic(iaqic)                       &
                   / (faqic(iaqic)                                    &
                      + gammac(ic)*cinc(ic,tid)))**ordaqic(iaqic)

        end do

      end if


!c  inhibition terms due to minerals
!c  Note: This is at the present time not necessary, since phi is not 
!c        considered implicitly, included only for future modifications

      istart2 = iaaqim(iaq)
      istop2 = iaaqim(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqim = istart2,istop2

          im = jaaqim(iaqim)

          prodrc = prodrc * (faqim(iaqim)                             &
                / (faqim(iaqim)+phim(im)))**ordaqim(iaqim)
          prodrcinc = prodrcinc * (faqim(iaqim)                       &
                   / (faqim(iaqim)+phim(im)))**ordaqim(iaqim)

        end do

      end if

!c  compute IAP/K for reversible reactions, regular and incremented

      if (rtype_aq(iaq).ne.'irreversible') then

        sataq(iaq,tid) = eqaq(iaq,tid)**(-r1)
        sataqinc = sataq(iaq,tid)

        istart = iaaq(iaq)
        istop = iaaq(iaq+1)-1
        do i1 = istart,istop
          ic = jaaq(i1)
          sataq(iaq,tid) = sataq(iaq,tid) * (gammac(ic)*c(ic))**      &
                           xnuaq(i1)
          sataqinc = sataqinc * (gammac(ic)*cinc(ic,tid))**xnuaq(i1)
        end do

    end if

!c  modify reaction product for reversible reactions

      if (rtype_aq(iaq).eq.'reversible') then

!crevintaff
         if (reverse_intra_affinity(iaq).and.                         &
             sataq(iaq,tid).gt.dg_limaq(iaq)) then
           prodrc = - prodrc * (dg_limaq(iaq) - sataq(iaq,tid)**(-r1))
           prodrcinc = - prodrcinc * (dg_limaq(iaq) - sataqinc**(-r1))
         else 
           prodrc = prodrc * (dg_limaq(iaq) - sataq(iaq,tid))
           prodrcinc = prodrcinc * (dg_limaq(iaq) - sataqinc)
         end if  

!crevintaff 

!crevintaff         prodrc = prodrc * (r1 - sataq(iaq))
!crevintaff         prodrcinc = prodrcinc * (r1 - sataqinc)
     
!c  modify reaction product for irreversible reactions - log K control

    elseif (rtype_aq(iaq).eq.'irreversible - log K control') then

         prodrc = prodrc * dmax1(r0,(prodrc * (r1 - sataq(iaq,tid))))
         if (prodrc.gt.r0) then
           prodrcinc = prodrcinc  &
                    * dmax1(r0,(prodrcinc * (r1 - sataqinc)))
         else
         prodrcinc = r0
         end if

    end if

!c  sum up final reaction rate [moles/(m^3 h2o * day)]
 
      rate = - scalfacaq*ratecaq(iaq,tid)                       &
            * (prodrcinc-prodrc)/drtinc

!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        write(*,'(a)') 'returning from rateint ...'
        write(*,'(a)') trim(nameaq(iaq))
        write(*,'(a,e17.10)') 'rate     ',rate
        write(*,*) '----------------------------------------------'
      end if

      if (info_debug.gt.1) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

      return
      end
