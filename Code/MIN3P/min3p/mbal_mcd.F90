!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/mbal_mcd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine mbal_mcd
!c -----------------
!c mass balance (reactive transport)
!c
!c written by:      Uli Mayer - September 5, 96
!c
!c last modified:   Uli Mayer - July 26, 01
!c                  Uli Mayer - November 12, 01
!c                  added new database format
!c                  for dissolution-precipitation reactions
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   - 
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           bcondrt_a(nc,nbrt) = concentrations in boundary control  + -
!c                                volumes (aqueous phase)
!c                                first type b.c. -> free species 
!c                                                   concentrations
!c                                third and mixed 
!c                                type b.c.       -> total aqueous
!c                                                   component
!c                                                   concentrations
!c           bcondrt_g(nc,nbrt) = concentrations in boundary control  + -
!c                                volumes (gaseous phase)
!c                                third and mixed 
!c                                type b.c.       -> total gaseous
!c                                                   component
!c                                                   concentrations
!c           bdycrt_d(nbrt)     = boundary influence coefficients for + -
!c                                diffusive mass fluxes across
!c                                boundary (excluding diffusion 
!c                                coefficient)
!c           cinfrt_da(njavs)   = influence coefficients              + -
!c                                (dispersion - aqueous phase)
!c           cinfrt_va(njavs)   = influence coefficients              + -
!c                                (advection - aqueous phase)
!c           hhead(nn)          = hydraulic head                      + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c           cnew(nc,nn)        = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           cx(nx,nn)          = concentrations of secondary aqueous + -
!c                                species [moles/l water]
!c           gamma(nc+nx,nn)    = activity coefficients of aqueous    + -
!c                                species
!c           gbrt(ng,nbrt)      = gas concentrations in boundary      + -
!c                                control volumes
!c           gnew(ng,nn)        = gas concentrations                  + -
!c                                - new time level [moles / l air]
!c           gold(ng,nn)        = gas concentrations                  + -
!c                                - old time level [moles / l air]
!c           cmnew(nm,nn)       = mineral concentrations              + -
!c                                - new time level [moles/l bulk]
!c           cmold(nm,nn)       = mineral concentrations              + -
!c                                - old time level [moles/l bulk]]
!c           cculabsbal(n)      = accumulative absolute mass balance  + +
!c                                error for dissolved species 
!c                                [moles/elapsed time]
!c           cmculabsbal(n)     = accumulative absolute mass balance  + +
!c                                error for minerals 
!c                                [moles/elapsed time]
!c           cculrelbal(n)      = accumulative relative mass balance  + +
!c                                error for dissolved species [%]
!c           cmculrelbal(n)     = accumulative relative mass balance  + +
!c                                for minerals [%]
!c           gculabsbal(ng)     = accumulative absolute mass balance  + +
!c                                error for gaseous species
!c                                [moles/elapsed time]
!c           gculrelbal(ng)     = accumulative relative mass balance  + +
!c                                error for gaseous species [%]
!c           cvol(nn)           = nodal volumes                       + -
!c           delt               = current time step                   + -
!c           dpdiff(nc+nm-1)    = source-sink term due to phase       * * 
!c                                exchange with minerals 
!c           dpdiffp(ndr*nm)    = individual source-sink terms due    * *
!c                                to parallel dissolution-
!c                                precipitation reactions
!c           cfluxin(n)         = mass gain due to inflow in water    * *
!c                                phase in terms of total aqueous
!c                                component concentrations
!c           cfluxout(n)        = mass loss due to outflow in water   * *
!c                                phase in terms of total aqueous
!c                                component concentrations
!           cfluxin_diff(n)    = mass gain due to diffusion in water  
!                                phase in terms of total aqueous 
!                                component concentrations
!           cfluxout_diff(n)   = mass loss due to diffusion in water 
!                                phase in terms of total aqueous
!                                component concentrations
!           cfluxin_mig(n)     = mass gain due to electrochemical    
!                                migration in water phase in terms  
!                                of total aqueous component 
!                                concentrations
!           cfluxout_mig(n)    = mass loss due to electrochemical    
!                                migration in water phase in terms  
!                                of total aqueous component 
!                                concentrations
!c           contaqtot(naq)     = contribution of intra-aqueous       + +
!c                                kinetic reactions to mass balance
!c                                [moles/elapsed time]
!c           contmintot(nm)     = contribution of dissolution-        + +
!c                                precipitation reactions to mass
!c                                balance [moles/elapsed time]
!c           gfluxtbdy(ng)      = mass flux across top boundary       * *
!c                                (gaseous phase)
!c           gfluxin(n)         = mass gain due to inflow in air      * *
!c                                phase in terms of total gaseous
!c                                component concentrations
!c           gfluxout(n)        = mass loss due to outflow in air     * *
!c                                phase in terms of total gaseous
!c                                component concentrations
!c           ordiff(n)          = global source-sink term due to      * *
!c                                oxidation-reduction reactions
!c           pornew(nn)         = porosity                            + -
!c           ratemdp(nm,nn)     = absolute dissolution-precipitation  + -
!c                                rates of minerals
!c           cstordiff(nc+nm-1) = change in storage in terms of total * *
!c                                aqueous component concentrations
!c           gdegas(n)          = mass loss from aqueous phase due to * *
!c                                degassing 
!c           gstordiff(n)       = change in storage in terms of total * *
!c                                gaseous component concentrations
!c           phi(nm,nn)         = volume fractions of minerals        + -
!c           phiold(nm,nn)      = volume fractions of minerals        + -
!c                                (old time level)
!c           rateaqtot(naq)     = total rate of intra-aqueous kinetic * * 
!c                                reaction in solution domain
!c                                [moles/day]
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                - new time level
!c           saold(nn)          = aqueous phase saturation            + -
!c                                - old time level
!c           sbdiff(n)          = source-sink term due to phase       * *
!c                                exchange with sorbed phase
!c           sgnew(nn)          = gaseous phase saturation            + -
!c                                - new time level
!c           sgold(nn)          = gaseous phase saturation            + -
!c                                - old time level
!c           sionnew(nn)        = ionic strength of solution          + -
!c                                - new time level
!c           tkel(nn)           = nodal temperatures in Kelvin        + -
!c           totaold(n,nn)      = total sorbed component              + -
!c                                concentrations
!c                                non-competitive sorption 
!c                                - old time level [moles/l bulk]
!c           totanew(n,nn)      = total aqueous component             + +
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk]
!c
!c           totcnew(nc-1,nn)   = total aqueous component             + -
!c                                concentrations
!c                                - new time level [moles/l water]
!c           totcold(nc-1,nn)   = total aqueous component             + -
!c                                concentrations
!c                                - old time level [moles/l water]
!c           totgnew(nc-1,nn)   = total gaseous component             + -
!c                                concentrations
!c                                - new time level [moles/l air]
!c           totgold(n,nn)      = total gaseous component             + -
!c                                concentrations
!c                                - old time level [moles/l air]
!c           tmass(n)           = total mass in aqueous and gaseous   + -
!c                                phase in terms of total component
!c                                concentrations [moles] 
!c           time_io            = current solution time (I/O units)   + -
!c           totmdp(nc-1,nn)    = total source/sink term towards      + -
!c                                total aqueous component
!c                                concentrations due to mineral
!c                                dissolution-precipitation reactions
!c           totcflux(n)        = total mass fluxes (aqueous phase)   * *
!c           totgflux(n)        = total mass fluxes (gaseous phase)   * *
!c           totsold(n,nn)      = total sorbed component              + -
!c                                concentrations
!c                                - old time level [moles/l bulk]
!c           totsold_ion(n,nn)  = total sorbed component              + -
!c                                concentrations 
!c                                - old time level [moles/l bulk]
!c                                (ion-exchange)
!c           totsold_surf(n,nn) = total sorbed component              + -
!c                                concentrations 
!c                                - old time level [moles/l bulk]
!c                                (surface-complex)
!c           totsnew(n,nn)      = total sorbed component              + -
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c           totsnew_ion(n,nn)  = total sorbed component              + -
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (ion-exchange)
!c           totsnew_surf(n,nn) = total sorbed component              + -
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (surface-complex)
!c           totcfluxin(nc)     = total mass gain due to inflow in    + +
!c                                auqueous phase in terms of total
!c                                aqueous component concentrations
!c           totcfluxout(nc)    = total mass loss due to inflow in    + +
!c                                aqueous phase in terms of total
!c                                aqueous component concentrations
!c           totcstordiff(nc)   = total change in storage in          + +
!c                                aqueous phase in terms of total
!c                                aqueous component concentrations
!c           totordiff(nc)      = total source/sink to total          + +
!c                                aqueous component concentrations
!c                                due to intra-aqueous kinetic 
!c                                reactions
!c           totdpdiff(nc)      = total source/sink to total          + +
!c                                aqueous component concentrations
!c                                due to dissolution-precipitation 
!c                                reactions
!c           totdpdiffp(ndr*nm) = individual contribution of parallel + +
!c                                reaction pathways of dissolution-
!c                                precipitation reactions to mass
!c                                balance [moles/elapsed time]
!c           totgdegas(nc)      = total mass loss from aquoeus phase  + +
!c                                due to degassing
!c           totgdiff(nc)       = total source/sink to total          + +
!c                                aqueous component concentrations
!c                                due to gas dissolution-esolution
!c                                reactions
!c           totgfluxin(nc)     = total mass gain due to inflow in    + +
!c                                gas phase in terms of total
!c                                gaseous component concentrations
!c           totgfluxout(nc)    = total mass loss due to inflow in    + +
!c                                gas phase in terms of total
!c                                gaseous component concentrations
!c           totgstordiff(nc)   = total change in storage in          + +
!c                                gas phase in terms of total
!c                                gaseous component concentrations
!c           totsbdiff(nc)      = total source/sink to total          + +
!c                                aqueous component concentrations
!c                                due to sorption or ion-exchange
!c                                reactions
!c
!c
!c           integer*4:
!c           ----------
!c           i2up(nn)           = pointer array to second upstream    + -
!c                                point
!c           iavs(nn+1)         = row pointer array for avs           + -
!c           idbg               = unit number - debugging file        + -
!c           imcd               = unit number, mass balance -         + -
!c                                             reactive transport
!c           jabrt(nbrt)        = pointer array - boundary conditions + -
!c                                (reactive transport)
!c           l_time_unit        = length of time unit for output      + -
!c           m_time             = current time step                   + -
!c           nbrt               = number of specified boundary        + -
!c                                control volumes
!c           nn                 = total number of control volumes     + -
!c
!c
!c           character:
!c           ----------
!c           btypert(nn)        = type of boundary control volumes    + -
!c                                'first'  = Dirichlet
!c                                           (specified
!c                                            concentration)
!c                                'second' = Neumann
!c                                           (free advective mass
!c                                            outflux for aqueous
!c                                            phase)
!c                                'third'  = Cauchy
!c                                           (specified advective
!c                                            mass influx for
!c                                            aqueous phase)
!c                                'mixed'  = mixed
!c                                           (specified advective
!c                                            mass influx and
!c                                            free diffusive mass
!c                                            influx for aqueous
!c                                            phase and free
!c                                            diffusive mass influx
!c                                            for gaseous phase)
!c           time_unit          = time unit for output -> 'years'     + -
!c                                                        'days'
!c                                                        'hours'
!c                                                        'seconds'
!c           tortuosity_corr    = .true.  -> Millington-Quirk         + -
!c                                           tortuosity correction
!c                                           for diffusion
!c                                           coefficients
!c
!c phys.f:   real*8:
!c           -------
!c           diff_a             = diffusion coefficient in aqueous    + -
!c                                phase (equal for all species)
!c           diff_g             = diffusion coefficient in gaseous    + -
!c                                phase (equal for all species)
!c
!c chem.f:   real*8:
!c           -------
!c           acth2omin          = min. activity for h2o               + -
!c           adav               = coefficient for Davies equation     + -
!c           bdav               = coefficient for Davies equation     + -
!c           dhac(nc)           = debye-huckel a for free species     + -
!c           dhad(nthreads)     = Debye Huckel constant a_d depending + -
!c                                on dielectric constant and
!c                                temperature (only for 25C)
!c           dhax(nx)           = debye-huckel a for secondary        + -
!c                                aqueous species
!c           dhbc(nc)           = debye-huckel b for free species     + -
!c           dhbd(nthreads)     = Debye Huckel constant b_d depending + -
!c                                on dielectric constant and
!c                                temperature (only for 25C)
!c           dhbx(nx)           = debye-huckel b for secondary        + -
!c                                aqueous species
!c           rateaq(naq,nthreads)
!c                              = reaction rates of intra-aqueous     * *
!c                                kinetic reaction
!c           rateg(ng,nthreads) = degassing rates                     * *
!c           rateor(nr,nthreads)= oxidation-reduction rate for        * *
!c                                redox couple [moles/(l h2o*day)
!c           temp_field         = .true.  -> nodal temperatures       + -
!c           totaq(nc-1,nthreads)
!c                              = total source-sink term towards      * *
!c                                total aqueous component
!c                                concentrations due to intra-aqueous
!c                                kinetic reactions
!c           totor(nc-1)        = total source/sink term towards      * *
!c                                aqueous component concentrations
!c                                due to oxidation-reduction
!c                                reactions [moles/(l bulk*day)]
!c           totrateg(nc-1)     = total rate for removal of aqueous   * *
!c                                components due to degassing
!c                                [mol L^-1 s^-1]
!c
!c           logical:
!c           --------
!c           gas_removal        = .true.  -> degassing of dissolved   + -
!c                                           gases, if confining
!c                                           pressure exceeded
!c           new_database       = .true.  -> use new database format  + -
!c           noncompetitive_sorption = logical array for activation   + -  
!c                                     of noncompetitive sorption
!c                                     reactions
!c
!c           integer*4:
!c           ----------
!c           l_namec(nc)        = length of component names           + -
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c           nx                 = number of secondary species         + -
!c           nm                 = number of minerals                  + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c
!c           character:
!c           ----------
!c           component_type(nc) = 'aqueous' = aqueous component       + -
!c                                'surface' = surface site
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           namem(nm)          = mineral names                       + -
!c           sorption_group     = 'ion-exchange'
!c                                'surface-complexation'
!c                                'undefined'
!c           update_activity(nthreads)
!c                              = 'no_update' -> unity activity       + -
!c                                 coefficients
!c                                'time_lagged' -> update activity
!c                                 coefficients after each time step
!c                                'double_update' -> double update
!c                                 of activity coefficients during
!c                                 Newton iterations
!c
!c local:    real*8:
!c           -------
!c           absbalance         = absolute mass balance in 
!c                                [moles/timestep]
!c           bdyinfrt_da        = boundary influence coefficient 
!c                                for diffusive mass flux (aqueous
!c                                phase)
!c           bdyinfrt_dg        = boundary influence coefficient 
!c                                for diffusive mass flux (gaseous
!c                                phase)
!c           conv3              = conversion factor [l/m^3]
!c           diff_eff           = effective diffusion coefficient
!c           r0                 = constant
!c           r100               = constant
!c           relbalance         = relative mass balance in %
!c           totvsflux          = total water flux across boundary
!c
!c           integer*4:
!c           ----------
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           ibrt               = counter (source control volumes)
!c           ic                 = counter (components)
!c           im                 = counter (minerals)
!c           ir                 = counter (redox couples)
!c           ivol               = counter (control volumes)
!c
!c external: acoff     = compute activity coefficient
!c           bdryflux  = compute water flux across boundary control 
!c                       volumes
!c           bulkconc  = convert from [moles/l water] to
!c                       [moles/l bulk]
!c           comptotc  = compress concentration vector, if number
!c                       of unknowns is reduced due to redox
!c                       equilibrium reactions
!c           diffcoff  = compute effective diffusion coefficient
!c           fluxv     = advective flux
!c           fluxd     = diffusive/dispersive flux
!c           molconc   = compute average molar concentration for
!c                       organic mixture
!c           msysrt    = compute total system mass (reactive 
!c                       transport) 
!c           rategas   = compute degassing rates
!c           rateint   = compute rate for intra-aqueous kinetic
!c                       reactions
!c           rateint_new   = compute rate for intra-aqueous kinetic
!c                       reactions (new database format)
!c           ratemin   = compute dissolution-precipitation
!c                       rate for mineral phase
!c           ratemin_new   = compute dissolution-precipitation
!c                       rate for mineral phase (new database format)
!c           rateredx  = compute total oxidation-reduction rates 
!c                       for redox couples 
!c           tcorr     = temperature correction for debye-huckel,
!c                       equilibrium and rate constants
!c           totconcg  = compute total gaseous component
!c                       concentrations based on concentrations
!c                       of gases
!c           totint    = compute total source-sink terms towards
!c                       total aqueous component concentrations
!c                       due to intra-aqueous reactions
!c           totredx   = compute total source/sink term towards total 
!c                       aqueous component concentrations due to
!c                       oxidation-reduction reactions or derivative 
!c                       thereof
!c           zero_r8   = clear real*8 array
!c ----------------------------------------------------------------------
  
      subroutine mbal_mcd
 
      use parm
      use gen
      use phys
      use chem
      use writeversion
#ifdef OPENMP
      use omp_lib 
#endif
      use module_binary_mpiio, only : binary_write_data

      implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif

      integer :: i1, ibrt, ic, ivol, istart, iend, imb, jvol 
      
      real*8 :: fluxd, totvsflux, bdryflux, bdyinfrt_da, bulkconc,     &
                diff_eff, diffcoff
      
#ifdef PETSC
      PetscErrorCode :: ierrcode
#endif

      external acoff, bulkconc, bdryflux, comptotc, diffcoff, fluxv_vl, &
     &         fluxd, molconc, msysrt,zero_r8


      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0,r100 = 100.0d0,      &
                           conv3 = 1.0d3
      
      integer :: nvarsimcd
      
!cdsu added for dgm model
      real*8 :: so_av

!c  zero arrays
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp parallel
    !$omp sections
#endif
#endif
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(totcflux_diff,n,1,1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(totcflux_mig,n,1,1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(cfluxin_diff,n,1,1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(cfluxin_mig,n,1,1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(cfluxin,n,1,1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(cfluxout_diff,n,1,1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(cfluxout_mig,n,1,1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(cfluxout,n,1,1)  
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(cstordiff,n,1,1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp end sections
    !$omp end parallel
#endif
#endif 
 
!c  compute total system mass at current time step
 
      call msysrt
 
!c  compress total aqueous component concentration vector and
!c  total gaseous component concentration vector for mass 
!c  balance calculations

      if (redox_equil.and.nr.gt.0) then
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_mcd_1)                          &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)   
    !$omp do schedule(static)
#endif   
        do ivol = 1,nngl
          call comptotc(totcnew(1,ivol))
        end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif        
      end if

!c  calculate mass balance for water phase in terms of total 
!c  aqueous component concentrations [moles/unit time]

!c  flux contributions
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nbrt > numofloops_thred_mcd_2)                          &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(i1, ibrt, ic, iend, istart, ivol, jvol,             &
    !$omp totcflux, totvsflux)                                        &
    !$omp reduction(+:totcflux_diff, totcflux_mig,                    &
    !$omp cfluxin_diff, cfluxin_mig, cfluxin,                         &
    !$omp cfluxout_diff, cfluxout_mig, cfluxout)
    !$omp do schedule(static)
#endif
      do ibrt = 1,nbrt                 !boundary control volumes
        ivol = jabrt(ibrt)             !pointer to control volume
#ifdef PETSC
        if(node_idx_lg2l(ivol) < 0) then
            cycle
        end if
#endif
!c  Dirichlet type boundary conditions

        if (btypert(ivol).eq.'first') then

          istart = iavs(ivol)+1 
          iend = iavs(ivol+1)-1

          do ic=1,n              !loop over components

            if (component_type(ic).eq.'aqueous') then
            
              !totcflux_diff(ic) = r0
              !totcflux_mig(ic) = r0            
              !totcflux(ic) = r0
              
              do i1 = istart,iend        !loop over local connections

                jvol = javs(i1)

!!!!!! For now Advective flux is neglected !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   !ToDo
                
                if (multi_diff) then 
                   
                    totcflux_diff(ic) = totcflux_diff(ic) - conv3 *    &    !Diffusive Flux
                                        (fluxd(totviscnew(ic,ivol),    &
                                               totviscnew(ic,jvol),    &
                                               cinfrt_mcd(i1)))
                
                    totcflux_mig(ic) = totcflux_mig(ic) - conv3 *      &     !Electromigration Flux
                                     (fluxd(electromignew(ic,ivol),r0, &
                                             cinfrt_mcd(i1)))                
                       
                    totcflux(ic) = totcflux_diff(ic) + totcflux_mig(ic)
                  
                else
                    totcflux_diff(ic) = totcflux_diff(ic) - conv3 *    &    !Diffusive Flux
                                         (fluxd(totcnew(ic,ivol),      &
                                          totcnew(ic,jvol),            &
                                          cinfrt_da(i1)))                
                
                    totcflux(ic) = totcflux_diff(ic)
          
                end if    
   
              end do

            end if                     !loop over local connections

          end do                       !loop over components

!c  Neumann, Cauchy or mixed type boundary conditions

        else

!c  compute water flux axcross boundary

          totvsflux = bdryflux(ivol) 

!c  total mass fluxes across Neumann type boundary control volumes
 
          if (btypert(ivol).eq.'second') then

            do ic = 1,n
              if (component_type(ic).eq.'aqueous') then
                totcflux(ic) = conv3 * totvsflux          &    !advective flux
     &                       * totcnew(ic,ivol)
              end if
            end do

!c  total mass fluxes across Cauchy type boundary control volumes

          elseif (btypert(ivol).eq.'third') then

!cbdy-start
            if (totvsflux.gt.0) then
!cbdy-end
!cbdy - flux enters domain

              do ic = 1,n
                if (component_type(ic).eq.'aqueous') then
                  totcflux(ic) = conv3 * totvsflux         &   !advective flux
     &                         * bcondrt_a(ic,ibrt)
                end if
              end do
!cbdy-start
!cbdy - flux leaves domain

            else
              
            do ic = 1,n
                if (component_type(ic).eq.'aqueous') then
                  totcflux(ic) = conv3 * totvsflux         &   !advective flux
     &                         * totcnew(ic,ivol)
                end if
              end do

          end if

!cbdy-end

!c  total mass fluxes across mixed type boundary control volumes

          elseif (btypert(ivol).eq.'mixed') then
              
            so_av=dmin1(r1, sonew(ivol))  

            diff_eff = diffcoff(diff_a, sanew(ivol),pornew(ivol),    &
                                tortuosity_corr,assigned_tau,        &
                                tau(ivol)*tau_fac(ivol),             &
                                type_tortuosity,marchies(ivol),so_av)
     
            bdyinfrt_da = diff_eff * bdycrt_d(ibrt)
 
            do ic = 1,n
              if (component_type(ic).eq.'aqueous') then
                totcflux(ic) = conv3 *             &
     &                       ( totvsflux                &    !advective flux
     &                       * bcondrt_a(ic,ibrt)    &
     &                       + fluxd(totcnew(ic,ivol),  &    !diffusive flux
     &                               bcondrt_a(ic,ibrt), &
     &                               bdyinfrt_da))
              end if
            end do

          end if

        end if                !boundary type (transport) 

!c  assign flux contributions

        do ic = 1,n
          if (component_type(ic).eq.'aqueous') then
            if (totcflux(ic).gt.r0 ) then
              if (btypert(ivol).eq.'first') then  
                cfluxin_diff(ic) = cfluxin_diff(ic) + totcflux_diff(ic)  !mass in
                cfluxin_mig(ic) = cfluxin_mig(ic) + totcflux_mig(ic)     !mass in
              end if
              cfluxin(ic) = cfluxin(ic) + totcflux(ic)                   !mass in
            else
              if (btypert(ivol).eq.'first') then  
                cfluxout_diff(ic) = cfluxout_diff(ic) - totcflux_diff(ic)!mass out
                cfluxout_mig(ic) = cfluxout_mig(ic) - totcflux_mig(ic)   !mass out
              end if
              cfluxout(ic) = cfluxout(ic) - totcflux(ic)                 !mass out
            end if
          end if
        end do

      end do                  !loop over boundary control volumes
      
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

#ifdef PETSC
      call MPI_Allreduce(cfluxin_diff, mpireduce_n,n,MPI_REAL8,MPI_SUM,     &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      cfluxin_diff(1:n) = mpireduce_n(1:n) 
      
      call MPI_Allreduce(cfluxin_mig, mpireduce_n,n,MPI_REAL8,MPI_SUM,     &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      cfluxin_mig(1:n) = mpireduce_n(1:n) 
      
      call MPI_Allreduce(cfluxin, mpireduce_n,n,MPI_REAL8,MPI_SUM,     &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      cfluxin(1:n) = mpireduce_n(1:n) 
      
      call MPI_Allreduce(cfluxout_diff, mpireduce_n,n,MPI_REAL8,MPI_SUM,     &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      cfluxout_diff(1:n) = mpireduce_n(1:n) 
      
      call MPI_Allreduce(cfluxout_mig, mpireduce_n,n,MPI_REAL8,MPI_SUM,     &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      cfluxout_mig(1:n) = mpireduce_n(1:n) 
      
      call MPI_Allreduce(cfluxout, mpireduce_n,n,MPI_REAL8,MPI_SUM,     &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      cfluxout(1:n) = mpireduce_n(1:n) 
#endif
 
!c  change in storage [moles/unit time]
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_mcd_3)                          &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ic, ivol)                                           &
    !$omp reduction(+:cstordiff)
    !$omp do schedule(static)
#endif
      do ivol = 1,nngl
#ifdef PETSC
        if(node_idx_lg2l(ivol) < 0) then
            cycle
        end if
#endif
        do ic = 1,n
          cstordiff(ic) = cstordiff(ic)                                &
                        + cvol(ivol)                                   &
                        * (bulkconc(totcnew(ic,ivol),                  &
                                    sanew(ivol),                       &
                                    pornew(ivol))                      &
                        -  bulkconc(totcold(ic,ivol),                  &
                                    saold(ivol),                       &
                                    porold(ivol)))
        end do
      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif   

#ifdef PETSC
      call MPI_Allreduce(cstordiff, mpireduce_n,n,MPI_REAL8,MPI_SUM,     &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      cstordiff(1:n) = mpireduce_n(1:n)
#endif

      cstordiff(1:n) = cstordiff(1:n) * conv3 / delt

      do ic = 1,n

!c compute accumulative changes over time

        totcfluxin_diff(ic) = totcfluxin_diff(ic)     &
     &                      + cfluxin_diff(ic)*delt
     
        totcfluxin_mig(ic) = totcfluxin_mig(ic)     &
     &                      + cfluxin_mig(ic)*delt
     
        totcfluxin(ic) = totcfluxin(ic) + cfluxin(ic)*delt    
        
        totcfluxout_diff(ic) = totcfluxout_diff(ic)     &
     &                       + cfluxout_diff(ic)*delt
     
        totcfluxout_mig(ic) = totcfluxout_mig(ic)     &
     &                       + cfluxout_mig(ic)*delt
     
        totcfluxout(ic) = totcfluxout(ic) + cfluxout(ic)*delt
        
!c  write results
 
        imcd = imcd+1
        
        if(rank == 0 .and. b_enable_output) then
          if (b_output_binary) then
            nvarsimcd = 15
            realbuffer_gb(1:nvarsimcd)=(/time_io,                      &
                                        cfluxin_diff(ic),              &
                                        cfluxin_mig(ic),               &
                                        cfluxin(ic),                   &
                                        cfluxout_diff(ic),             &
                                        cfluxout_mig(ic),              &
                                        cfluxout(ic),                  &
                                        cstordiff(ic),                 &
                                        totcfluxin_diff(ic),           &
                                        totcfluxin_mig(ic),            &
                                        totcfluxin(ic),                &
                                        totcfluxout_diff(ic),          &
                                        totcfluxout_mig(ic),           &
                                        totcfluxout(ic),               &
                                        totcstordiff(ic)/)
            call binary_write_data(imcd_mpi(imcd), 1,          &
                         (/mtime/),offset_imcd_ijk(imcd),.true.)
            call binary_write_data(imcd_mpi(imcd), nvarsimcd,  &
                         realbuffer_gb,offset_imcd(imcd),.true.) 

            offset_imcd(imcd) = offset_imcd(imcd) + nvarsimcd*nfloatbit
   
          else
            write(imcd,'(23(1pe12.4))') time_io,                       &
                                        cfluxin_diff(ic),              &
                                        cfluxin_mig(ic),               &
                                        cfluxin(ic),                   &
                                        cfluxout_diff(ic),             &
                                        cfluxout_mig(ic),              &
                                        cfluxout(ic),                  &
                                        cstordiff(ic),                 &
                                        totcfluxin_diff(ic),           &
                                        totcfluxin_mig(ic),            &
                                        totcfluxin(ic),                &
                                        totcfluxout_diff(ic),          &
                                        totcfluxout_mig(ic),           &
                                        totcfluxout(ic),               &
                                        totcstordiff(ic)
          end if      
        end if
      
      end do   ! do ic

!c  absolute mass balance error [moles/time unit]
!c  relative mass balance error in [%] = [moles/moles in system] x 100
!c  accumulative mass balance error [moles]
!c  relative accumulative mass balance error in [%] = 
!c  [moles/moles in system] x 100
! 
!      do ic = 1,n
!        absbalance = (cfluxin(ic) - cfluxout(ic)
!     &             - cstordiff(ic))*delt
!        relbalance = dabs(absbalance)/tmass(ic)*r100
!        cculabsbal(ic) = cculabsbal(ic) + absbalance
!        cculrelbal(ic) = cculabsbal(ic)/tmass(ic)*r100
!        imcd = imcd+1
!
!        if (mtime.eq.1) then
!        write(imcd,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
!          write(imcd,'(11a)') 'variables = "time [',
!     &            time_unit(:l_time_unit),']", ',
!     &           '"absolute mass balance error [mol]", ',
!     &           '"relative mass balance error ',
!     &           '[% of system mass]", ',
!     &           '"absolute cumulative mass balance error ',
!     &           '[mol] ", ',    
!     &           '"relative cumulative mass balance error ',
!     &           '[% of system mass]"' 
!          write(imcd,'(4a)') 
!     &              'zone t = "mass balance error for component ',
!     &           namec(ic)(:l_namec(ic)),' - ',
!     &           ' reactive transport", f=point'
!    end if
!
!        write(imcd,'(5(1pe12.4,4x))') time_io,absbalance,
!     &                                relbalance,cculabsbal(ic),
!     &                                cculrelbal(ic)
!      end do
!   
!c ----------------------------------------------------------------------
!c  compute mass balance for selected species in aqueous phase
!c  only if selected species are specified
!c ----------------------------------------------------------------------

      if (nmb.gt.0) then
    
        do imb = 1,nmb
          imcd = imcd + 1
        end do

      end if

      return
      end
