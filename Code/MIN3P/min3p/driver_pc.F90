!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 491 $
!> $Author: fgerard $
!> $Date: 2017-07-18 00:06:39 +0200 (Tue, 18 Jul 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/driver_pc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ---------------------------------------------------------------------- 
!c                  M     M  I  N     N  333333  PPPPPP
!c                  MM   MM  I  NN    N       3  P    P
!c                  M M M M  I  N N   N       3  P    P
!c                  M  M  M  I  N  N  N    3333  PPPPPP
!c                  M     M  I  N   N N       3  P
!c                  M     M  I  N    NN       3  P
!c                  M     M  I  N     N  333333  P
!c
!c                            THCm Version 1.0
!c
!c                  A Numerical Model for the Analysis
!c                               of the
!c                        Geochemical Evolution
!c                                 of
!c                      Mineral-Water-Air Systems
!c
!c                          (c) 1997 U. Mayer
!c ---------------------------------------------------------------------- 
!c
!c Ulrich Mayer, University of Waterloo
!c basic version: September 1995
!c
!c last modified: November 09, 2012
!c
!c duplication of this program or any part thereof without
!c the express written consent of the author is prohibited.
!c
!c ----------------------------------------------------------------------
!c driver code - MIN3P
!c ---------------------
!c
!c Features:
!c ---------
!c variably saturated density dependent flow and/or 
!c reactive transport or batch systems with kinetically 
!c controlled disssolution-precipitation reactions 
!c
!c variably saturated flow:
!c ------------------------
!c optional density dependent flow simulation
!c steady state and transient simulations
!c fully saturated and variably saturated
!c fully implicit time-stepping
!c FVM assembly for scalar conservation law
!c Newton-linearization for variably saturated conditions
!c
!c reactive transport: 
!c -------------------
!c fully implicit time stepping
!c FVM assembly for vector conservation law for n components
!c Newton linearization
!c
!c geochemistry module:
!c --------------------
!c equilibrium reactions for complexation, redox and phase partitioning
!c kinetically controlled dissolution-precipitation reactions
!c for surface and transport controlled reactions
!c geochemical system defined by means of database files for:
!c - components
!c - secondary aqueous species  
!c - minerals
!c - gases
!c activity coefficients: extended Debye Huckel equation and/or Davies
!c                        equation
!c multicomponent diffusion
!c ----------------------------------------------------------------------
!c parameter definitions:
!c ----------------------
!c see parm.f   
!c
!c ----------------------------------------------------------------------
!c variables definitions: 
!c ----------------------
!c general variables:   'gen.f'
!c physical variables:  'phys.f'
!c chemical variables:  'chem.f'
!c density variables:   'dens.f' 
!c
!c variables used in a specific routine are defined therein,
!c
!c ----------------------------------------------------------------------
!c common:
!c gen.f:    real*8:
!c           -------
!c           area(nm,nn)        = mineral reactivity term
!c                                (global system)
!c           cnew(nc,nn)        = concentrations of free species
!c                                - new time level [moles/l water]
!c           cec_g(nn)          = cation exchange capacity (meq/100g)
!c                                - global system
!c           gnew(ng,nn)        = gas concentrations
!c                                - new time level [moles/l air]
!c           cmnew(nm,nn)       = mineral concentrations
!c                                - new time level [moles/l bulk]
!c           cx(nx,nn)          = concentrations of secondary aqueous
!c                                species [moles/l water]
!c           gamma(nc+nx,nn)    = activity coefficients for aqueous
!c                                species
!c           delt               = time step
!c           distcoff_rt(nc,nn) = sorption distribution coefficient
!c                                [-], [l bulk/l bulk]
!c                                - reactive transport
!c           gs_tout(ngs)       = specified output times for
!c                                contour data
!c           hhead(nn)          = hydraulic head
!c           phi(nm,nn)         = volume fractions of minerals
!c           phiold(nm,nn)      = volume fractions of minerals
!c                                - old time level
!c           pornew(nn)         = porosity  
!c           sanew(nn)          = aqueous phase saturation 
!c                                (new time level)
!c           sionnew(nn)        = ionic strength of solution
!c                                - new time level
!c           uvsnew(nn)         = solution vector (new time level)
!c           uvsold(nn)         = solution vector (old time level)
!c           tkel(nn)           = nodal temperatures in Kelvin
!c           time_io            = current solution time (I/O units)
!c           totcnew(n,nn)      = total aqueous component
!c                                concentrations
!c                                - new time level [moles/l water]
!c           zg(nn)             = spatial coordinates in z-direction
!c
!c           integer*4:
!c           ----------
!c           igen               = unit number, generic output file
!c           ilog               = unit number, logbook
!c           igbb               = unit number, concentrations of
!c                                             sorbed species
!c                                             - transient data
!c                                               global system
!c           igbt               = unit number, total aqueous
!c                                             component
!c                                             concentrations
!c                                             - transient data
!c                                               global system
!c           igbc               = unit number, species
!c                                             concentrations
!c                                             - transient data
!c                                               global system
!c           igbd               = unit number, dissolution-
!c                                             precipitation
!c                                             rates
!c                                             - transient data
!c                                               global system
!c           igbg               = unit number, gas concentrations
!c                                             - transient data
!c                                               global system
!c           igbgr              = unit number, degassing rates
!c                                             - transient data
!c                                               global system
!c           igbm               = unit number, master variables
!c                                             - transient data
!c                                               global system
!c           igbi               = unit number, rates of intra-aqueous
!c                                             kinetic reactions
!c                                             - transient data
!c                                               global system
!c           igbs               = unit number, saturation indices
!c                                             - transient data
!c                                               global system
!c           igbv               = unit number, mineral volume
!c                                             fractions
!c                                             - transient data
!c                                               global system
!c           igbx               = unit number, saturation indices
!c                                             (excluded minerals)
!c                                             - transient data
!c                                               global system
!c           igstime            = pointer to next output time for
!c                                contour data
!c           itseep_tot         = total number of seepage face
!c                                iterations
!c           itsolvtot_vs       = total number of solver
!c                                iterations
!c                                (variably saturated flow)
!c           ittot_vs           = total number of iterations
!c                                (variably saturated flow)
!c           l_prfx             = length of prefix of I/O files
!c           l_zone_name        = length of zone name
!c           n                  = number of components excluding h2o
!c                                equals number of unknowns per
!c                                control volume
!c           ngb                = number of output locations for
!c                                transient data
!c           ngb_vol(ngb)       = control volume numbers for output
!c                                of transient data
!c           nn                 = total number of control volumes
!c
!c           logical:
!c           --------
!c           analyt_deriv_rt    = .true.  -> form derivatives
!c                                           analytically
!c           gb_output          = .true.  -> output of transient data
!c           gs_output          = .true.  -> output of contour data
!c           geo_chemistry      = .true.  -> local or background and
!c                                           source chemistry
!c           initial_condition  = .true.  -> output of initial
!c                                           condition for contour
!c                                           data
!c                                .false. -> output of contour data
!c                                           for steady state or
!c                                           transient solutions
!c           mass_balance_vs    = .true.  -> compute mass balance
!c                                           (variably_saturated
!c                                            flow)
!c           mass_balance_rt    = .true.  -> compute mass balance
!c                                           (reactive tramsport)
!c           reactive_transport = .true.  -> perform reactice
!c                                           transport simulation
!c           redox_equil_rt     = .true.  -> equilibrium redox
!c                                           reactions
!c           show_module        = .true.  -> write current module
!c                                           name to screen
!c           steady_flow        = .true.  -> steady state flow
!c           tec_header         = .true.  -> write header for tecplot
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c           transient_flow     = .true.  -> .not.steady_flow,
!c                                        -> transient flow
!c           update_porosity    = .true.  -> update porosity as
!c                                           a result of dissolution-
!c                                           precipitation reactions
!c           varsat_flow        = .true.  -> perform flow simulation
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files
!c           zone_name          = name of zone
!c
!c chem.f:   integer*4:
!c           ----------
!c           nx                 = number of secondary aqueous species
!c           nm                 = number of minerals
!c
!c           logical:
!c           --------
!c           finite_minerals    = .true.  -> finite minerals 
!c
!c dens.f:   real*8:
!c           -------
!c           pressure(nn)       = fluid pressure
!c           density(nn)        = fluid density         
!c           viscosity(nn)      = fluid viscosity
!c           dcoef(ncon-1)      = coefficient including density,
!c                                viscosity, and relative 
!c                                permeability
!c           ref_dens           = reference density to convert 
!c                                from freshwater heads to pressures
!c           logical:
!c           --------
!c           density_dependence = .true.  -> simulate density 
!c                                           dependent flow
!c           fluid_pressure     = .true.  -> initial and boundary
!c                                           conditions in terms 
!c                                           of fluid pressure 
!c           fresh_head         = .true.  -> initial and boundary
!c                                           conditions in terms 
!c                                           of freshwater head 
!c           init_perm          = .true. -> initial media properties
!c                                           in permeability units
!c           init_cond          = .true. -> initial media properties
!c                                           in hydraulic conductivity
!c                                           units       
!c local:    integer*4:
!c           ----------
!c           igb                = counter
!c           ivol               = counter
!c
!c external: welcome  = welcome the user and read problem 
!c                      prefix name
!c           opngfls  = open general problem specific files
!c           initcpgs = control parameters for global system
!c           constnts = assign constants for global use
!c           initprob = initialize variably saturated flow 
!c                      and/or reactive transport simulation 
!c                      or perform batch simulation
!c           batreac  = driver subroutine for local chemistry
!c           opnpgfls = open files for postprocessing 
!c                      (global system)
!c           outputvs = write contour data for variably saturated 
!c                      flow simulation to output file
!c           outputdd = write contour data for variably saturated 
!c                      density dependent flow simulation to 
!c                      output file
!c           outputrt = write contour data of reactive transport 
!c                      simulation to output file
!c           tprfrtlc = write transient data to output file
!c                      (reactive transport)
!c           msysrt   = compute total system mass 
!c                      (reactive transport)
!c           msysvs   = compute total system mass 
!c                      (variably saturated flow)
!c           msysdd   = compute total system mass 
!c                      (variably saturated density dependent flow)
!c           setsize  = define number of primary unknowns
!c           stedflow = driver subroutine for steady state 
!c                      variably saturated flow 
!c           timeloop = driver subroutine for transient flow 
!c                      and/or eactive transport
!c           tranunit = assign unit numbers for output of transient 
!c                      data
!c           clsgfls  = close I/O files (global system)
!c ----------------------------------------------------------------------

subroutine driver_pc
 !DEC$ ATTRIBUTES STDCALL, ALIAS:"DRIVER" , DLLEXPORT :: driver_pc

      use parm
      use gen
      use chem
      use dens
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_initialize,               &
                                   petsc_mpi_finalize
#endif

#ifdef OPENMP
      use omp_lib 
#endif

#ifdef PETSC
     use solver_dd, only : solver_dd_release,solver_dd_snes_create
#endif


      use solver, only : initsolver, mem_solver, releasesolver
      use solver_runtime, only : openruntimefile, closeruntimefile

      implicit none
      
      integer :: i, ivol, igb, ierrcode
      logical :: bflag
      

      external welcome, opngfls, initcpgs, constnts, initprob,    &
              opnpgfls, outputvs, outputdd, outputrt, tprfrtlc,   &
              msysrt, msysvs, msysdd, stedflow, timeloop,         &
              tranunit, clsgfls

#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#include <petsc/finclude/petscdef.h>
#elif PETSC
#include <finclude/petscsys.h>
#include <finclude/petscdef.h>
#endif
      
!c  initialize MPI parallel environment  
#ifdef PETSC
      call petsc_mpi_initialize(rank, nprcs)
      
      !If run with threadcomm, use the number of threads from '-threadcomm_nthreads'
#ifdef PETSC_V3_7_X
      call PetscOptionsGetInt(PETSC_NULL_OBJECT,PETSC_NULL_CHARACTER,  &
                              '-threadcomm_nthreads',nthreads_per_proc,&
                              bflag,ierrcode) 
#elif PETSC
      call PetscOptionsGetInt(PETSC_NULL_CHARACTER,                    &
                              '-threadcomm_nthreads',nthreads_per_proc,&
                              bflag,ierrcode) 
#endif
      
      CHKERRQ(ierrcode)
      !If run without threadcomm, use the number of threads from '-mpicomm_nthreads'
      if (.not. bflag) then
#ifdef PETSC_V3_7_X
        call PetscOptionsGetInt(PETSC_NULL_OBJECT,PETSC_NULL_CHARACTER,&
                                '-mpicomm_nthreads',nthreads_per_proc, &
                                bflag,ierrcode)      
#elif PETSC
        call PetscOptionsGetInt(PETSC_NULL_CHARACTER,                  &
                                '-mpicomm_nthreads',nthreads_per_proc, &
                                bflag,ierrcode) 
#endif
        
        CHKERRQ(ierrcode)
      end if
      
      if (.not. bflag) then
        nthreads_per_proc = 1 
      else
        if (nthreads_per_proc <1) then
          if (rank == 0) then
            write(*,*) "Error: number of threads < 1"
          end if
          call petsc_mpi_finalize  
          stop
        end if
      end if
#else
      rank = 0
      nprcs = 1
      nthreads_per_proc = 1
      Petsc_Comm_World = 0
      Petsc_Comm_Self = 0
#endif

!#ifdef OPENMP
!      call omp_set_dynamic(.true.)
!#endif

#ifdef MPI
      if(nprcs > 1) then
          write(str_rank,'(A,I0)')"_rank_", rank 
      else
          str_rank = ""
      end if
#else
      str_rank = ""
#endif

!c  hardwired logical variables

      show_module = .true.
!!cprovi-------------------------------------------------
!!cprovi We can swith the option of analytic and numerical
!!cprovi derivatives 
!!cprovi-------------------------------------------------
      analyt_deriv_rt = .false.
!!cprovi-------------------------------------------------

!c  welcome the user and read problem read prefix name
      call welcome
 
!c  open problem specific input file, generic output file
!c  and scratch file for temporary data storage
      call opngfls
      
!c  initialize global control parameters
      call initcpgs

!c  define constants for global use
      call constnts
     
!c  initialize solver
      call initsolver(str_solvercfg) 
      call mem_solver
     
!c  open runtime file
      if(rank == 0 .and. b_prtfile) then      !if MPI rank 0
        call openruntimefile
      end if                  !end if MPI rank 0
     
!c  initialize variably saturated flow and/or reactive transport simulation 
!c  or initialize equilibrium or reaction path simulation
!c  Parallelized, OpenMP, MPI
      call initprob
     
!c  initialize iteration parameters
      ittotglob = 0 
      ittot_vs  = 0
      ittot_rt  = 0
      itseep_tot = 0
      itsolvtot_vs = 0
      iter_seep = 0
      itseep_tot = 0

!c  equilibrium or reaction path simulation
!c  parallelized, OpenMP, DSU
      if (.not.reactive_transport.and.geo_chemistry) then
        call batreac
      end if

!c  reset problem size for reaction-transport problem
      if (reactive_transport) then
        call setsize(redox_equil_rt)
        if (nm.gt.0) then
          finite_minerals = .true.
        end if
      end if

!c  open files for postprocessing
      if (varsat_flow.or.reactive_transport) then
        call opnpgfls
      end if

!c  write initial contour data to output file
!c  and define next output time
      if (varsat_flow.or.reactive_transport) then
        initial_condition = .true.
        igstime = 0
        if (gs_output) then
          if(b_enable_output) then
            if (varsat_flow) then
              if (density_dependence) then
                call outputdd
              else
                call outputvs
              end if  !densit_dependence
            end if    !varsat_flow
            if (reactive_transport) then
              call outputrt
            end if
          end if
          igstime = 1
          initial_condition = .false.
        end if
      end if

!c  write initial condition of transient data to output file
      if (reactive_transport) then
        if (gb_output .and. b_enable_output) then
          do igb = 1,ngb

!c  assign unit numbers for output of transient data

            call tranunit(igb)
!cprovi----------------------------------------------------------------------
!cprovi The point of activity coefficients corresponding to aqueous 
!cprovi complexes was corrected. 
!cprovi Now is nc+1
!cprovi----------------------------------------------------------------------
            ivol = ngb_vol(igb)
!cdsu  When domain docomposition is used, the output transient data is 
!cdsu  distributed into different sub-domain. ivol = -1 indicates that 
!cdsu  this transient data (igb) is not in the current sub-domain.
            if(ivol > 0) then
                
              if (b_output_binary) then                    
                igbt  = igbt_mpi(igb)
                igbc  = igbc_mpi(igb)
                igbm  = igbm_mpi(igb)
                igbgr = igbgr_mpi(igb)
                igbg  = igbg_mpi(igb)
                igbi  = igbi_mpi(igb)
                igbb  = igbb_mpi(igb)
                igbs  = igbs_mpi(igb)
                igbv  = igbv_mpi(igb)
                igbd  = igbd_mpi(igb)
                igbx  = igbx_mpi(igb)
                igbis = igbis_mpi(igb)
              end if 
                
              call tprfrtlc(totcnew(1,ivol),cnew(1,ivol),cx(1,ivol),  &
                         gamma(1,ivol),gamma(nc+1,ivol),cmnew(1,ivol),&
                         gnew(1,ivol),cec_g(ivol),distcoff_rt(1,ivol),&
                         area(1,ivol),phi(1,ivol),phiold(1,ivol),     &
                         sionnew(ivol),tkel(ivol),hhead(ivol),        &
                         zg(ivol),time_io,delt,sanew(ivol),           &
                         pornew(ivol),igbt,igbc,igbm,igbg,igbgr,igbi, &
                         igbb,igbs,igbv,igbd,igbx,igbis,              &
                         offset_igbt(igb),                            &
                         offset_igbc(igb),offset_igbm(igb),           &
                         offset_igbg(igb),offset_igbgr(igb),          &
                         offset_igbi(igb),offset_igbb(igb),           &
                         offset_igbs(igb),offset_igbv(igb),           &
                         offset_igbd(igb),offset_igbx(igb),           &
                         offset_igbis(igb),                           &
                         offset_igbt_ijk(igb),                        &
                         offset_igbc_ijk(igb),offset_igbm_ijk(igb),   &
                         offset_igbg_ijk(igb),offset_igbgr_ijk(igb),  &
                         offset_igbi_ijk(igb),offset_igbb_ijk(igb),   &
                         offset_igbs_ijk(igb),offset_igbv_ijk(igb),   &
                         offset_igbd_ijk(igb),offset_igbx_ijk(igb),   &
                         offset_igbis_ijk(igb),                       &
                         prefix,l_prfx,                               &
                         tec_header,ivol,0,1,zone_name,l_zone_name,   &
                         update_porosity)
            end if
          end do
        end if
      end if
      
#ifdef PETSC
      !> create petsc solver space for reactive transport problem 
      call solver_dd_snes_create
#endif
    
      if (varsat_flow) then
!c  initialize iteration parameters for variably saturated flow

!c  steady state flow
!c  Parallelized, OpenMP, DSU 
        if (steady_flow) then
          call stedflow
        end if

      end if
      
!c  compute initial system mass - variably saturated flow
!c  transient conditions
!c  Parallelized, OpenMP, DSU
      if (varsat_flow.and.transient_flow.and.mass_balance_vs) then
        if (density_dependence) then
          call msysdd
        else
          call msysvs
        end if      
      end if
      
!c  compute initial system energy
!c  transient conditions
!c  Parallelized, OpenMP, DSU
      if (heat_transport.and.transient_flow.and.energy_balance) then
         call energysys 
      end if  
      
!c  compute initial system mass - reactive transport
!c  Parallelized, OpenMP, DSU
      if (mass_balance_rt) then
        call msysrt
      end if
     
!c  transient simulation for variably saturated flow and 
!c  reactive transport
!c  Parallelized, OpenMP, DSU     
    if ((varsat_flow.and.transient_flow).or.reactive_transport) then
	
        call TIMELOOP
        write(*,*) 'timeloop fini'
      end if
           
!c   release memory used by solver
      call releasesolver
      
!c   close runtime file
      if(rank == 0 .and. b_prtfile) then      !if MPI rank 0
        call closeruntimefile
      end if                  !end if MPI rank 0
      
!c  cputime and statistics to screen and generic output file
      if (varsat_flow.or.reactive_transport) then
        if (rank == 0) then
          call rstatgs(ilog)
        end if
        if (b_enable_output .and. b_enable_output_gen) then
          call rstatgs(igen)
        end if
      end if
      
      if(rank == 0) then      !if MPI rank 0
        write(*,'(/a//)')                                              &
        '     ***************** normal exit ******************'
      end if                  !end if MPI rank 0
      
      if(rank == 0) then
        write(ilog,'(72a)')('-',i=1,72)
        write(ilog,'(/a//)')                                           &
        '         ***************** normal exit *************b****'
      end if
      
      if(b_enable_output .and. b_enable_output_gen) then
        write(igen,'(72a)')('-',i=1,72)
        write(igen,'(/a//)')                                           &
        '         ***************** normal exit ******************'
      end if


!c  close I/O files (global system)
      call clsgfls

!FG sept 2021 -------------
      if ((reactive_transport).and.(nm.gt.0)) then
         close(idmr)
         call lun_free(idmr)
         close(idmm)
         call lun_free(idmm)
      endif
!--------------------------
      
!cprovi---------------------------------------------------------
!cprovi Destroy and nullify the phase object
!cprovi It was added by Sergio Andrï¿½s Bea Jofr?
!cprovi 24/01/2009
!cprovi---------------------------------------------------------
      call closepitzer 
!cprovi---------------------------------------------------------

      

!c    finalize petsc solver
#ifdef PETSC
      call solver_dd_release
#endif
#ifdef PETSC
      call petsc_mpi_finalize
#endif


      stop
      
End subroutine
