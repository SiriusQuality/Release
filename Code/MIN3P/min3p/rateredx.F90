!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/rateredx.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine rateredx
!c -------------------
!c
!c compute total oxidation-reduction rates for redox couples in terms
!c of total aqueous component concentrations
!c
!c sign convention: depletion of primary component - ve
!c                  production of primary component + ve
!c
!c written by:      Uli Mayer - May 29, 97
!c
!c last modified:   Uli Mayer - February 4, 98
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c                                - new time level [moles/l h2o]
!c           gammac(nc)         = activity coefficients of components + -
!c                                as species in solution
!c           gammax(nx)         = activity coefficients of            + -
!c                                secondary aqueous species
!c           rate               = oxidation-reduction rate for        * +
!c                                redox couple [moles/(l h2o*day)
!c           totc(nc-1)         = total aqueous component             + -
!c                                concentrations
!c
!c           integer*4:
!c           ----------
!c           ir                 = pointer to current redox couple     + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           bcatfac(nr*nor)    = bacterial catalysis factor          + -
!c           chomc(nr*nor*nc)   = cutoff concentrations for reacting  + -
!c                                species (components as species
!c                                in solution)
!c           chomt(nr*nor*nc)   = cutoff concentration for reacting   + -
!c                                species (total aqueous component
!c                                concentrations)
!c           chomx(nr*nor*nx)   = cutoff concentration for reacting   + -
!c                                species (aqueous complexes)
!c           eqr(nr,nthreads)   = equilibrium constant for redox      + -
!c                                couple reaction equation
!c           ordorc(nr*nor*nc)  = order of oxidation-reduction        + -
!c                                reaction with respect to components
!c                                as species in solution
!c           ordort(nr*nor*nc)  = order of oxidation-reduction        + -
!c                                reaction with respect to total
!c                                aqueous component concentrations
!c           ordorx(nr*nor*nx)  = order of oxidation-reduction        + -
!c                                reaction with respect to
!c                                secondary aqueous species
!c           rateox(nr*nor)     = log of oxidation-reduction rate     + -
!c                                constant
!c                                (units: liter -  moles - seconds)
!c           xnur(nr*nc)        = stoichiometric coefficient of       + -
!c                                components in redox couple
!c                                reaction equation
!c
!c
!c           integer*4:
!c           ----------
!c           iarc(nr+1)         = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           iaor(nr+1)         = pointer array to parallel           + -
!c                                oxidation-reduction reactions
!c           iaorc(nr*nor+1)    = row pointer array to reactants      + -
!c                                in parallel oxidation-reduction
!c                                reactions (components as species
!c                                in solution)
!c           iaort(nr*nor+1)    = row pointer array to reactants      + -
!c                                in parallel oxidation-reduction
!c                                reactions (total aqueous component
!c                                concentrations)
!c           iaorx(nr*nor+1)    = row pointer array to reactants      + -
!c                                in parallel oxidation-reduction
!c                                reactions (secondary aqueous
!c                                species)
!c           jaorc(nr*nor*nc)   = column pointer array to reactants   + -
!c                                in parallel oxidation-reduction
!c                                reactions (components as species
!c                                in solution)
!c           jaort(nr*nor*nc)   = column pointer array to reactants   + -
!c                                in parallel oxidation-reduction
!c                                reactions (total aqueous component
!c                                concentrations)
!c           jaorx(nr*nor*nx)   = column pointer array to reactants   + -
!c                                in parallel oxidation-reduction
!c                                reactions (secondary aqueous
!c                                species)
!c           jarc(nr*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           nc                 = number of components                + -
!c           nr                 = number of redox couples             + -
!c
!c           character:
!c           ----------
!c           rtype_hom(nr)      = reaction type of homogeneous        + -
!c                                reaction in aqueous phase
!c                                'forward'
!c                                'backward'
!c                                'forward-to-equilibrium'
!c                                'backward-to-equilibrium'
!c                                'reversible'
!c                                'equilibrium'
!c
!c local:    real*8:
!c           -------
!c           aprod              = activity product                  
!c           prodrc             = product of reacting species
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           ior                = counter (parallel oxidation-
!c                                         reduction reactions)
!c           iorc               = counter
!c           iort               = counter
!c           iorx               = counter
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine rateredx(c,cx,gammac,gammax,rate,totc,ir)
 
      use parm
      use chem
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif 
      implicit none
      
      real*8 :: c,cx,gammac,gammax,rate,totc
      
      integer :: ir
      
      integer :: tid, i, ic, ix, ior, iorc, iorx, iort, istart, istop, &
                 istart2, istop2, info_debug
      
      real*8 :: prodrc, aprod

      dimension c(*),cx(*),gammac(*),gammax(*),totc(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

      ic = 0
 
!c  initialize oxidation-reduction rate

      rate = r0

!c  pointer to oxidation-reduction reactions for redox couple
 
      istart = iaor(ir)
      istop = iaor(ir+1)-1

!c  loop over parallel oxidation-reduction rates

      do ior = istart,istop
 
!c  form product of reactants for current oxidation-
!c  reduction reaction, skip, if current oxidation-reduction rate is 
!c  zero order 
 
        prodrc = r1

!c  total aqueous component concentrations

        istart2 = iaort(ior)
        istop2 = iaort(ior+1)-1

        if (istop2.ge.istart2) then    !skip for zero order rate

          do iort = istart2,istop2

            ic = jaort(iort)

            if (rtype_hom(ir).eq.'forward'.or.                        &
     &          rtype_hom(ir).eq.'backward') then

              prodrc = prodrc                                         &
     &               * totc(ic) / (totc(ic)+chomt(iort))

            end if

            prodrc = prodrc * totc(ic)**ordort(iort)

          end do

        end if

!c  components as species in solution

        istart2 = iaorc(ior)
        istop2 = iaorc(ior+1)-1

        if (istop2.ge.istart2) then    !skip for zero order rate

          do iorc = istart2,istop2

            ic = jaorc(iorc)

            if (rtype_hom(ir).eq.'forward'.or.                        &
     &          rtype_hom(ir).eq.'backward') then
                                                                       
              prodrc = prodrc                                         &
     &               * (gammac(ic)*c(ic))                             &
     &               / (gammac(ic)*c(ic)+chomc(iorc))

            end if

            prodrc = prodrc * (gammac(ic)*c(ic))**ordorc(iorc)

          end do

        end if
 
!c  secondary aqueous species

        istart2 = iaorx(ior)
        istop2 = iaorx(ior+1)-1

        if (istop2.ge.istart2) then    !skip for zero order rate

          do iorx = istart2,istop2

            ix = jaorx(iorx)

           if (rtype_hom(ir).eq.'forward'.or.                         &
     &          rtype_hom(ir).eq.'backward') then
                                                                       
              prodrc = prodrc                                         &
     &               * (gammax(ic)*cx(ic))                            &
     &               / (gammax(ic)*cx(ic)+chomx(iorx))

            end if

            prodrc = prodrc * (gammax(ix)*cx(ix))**ordorx(iorx)

          end do

        end if

!c  sum up final oxidation-reduction rate [moles/(m^3 h2o * day)]
 
        rate = rate - bcatfac(ior)*rateox(ior)*prodrc

      end do          !number of parallel oxidation rates

!c  compute K/IAP for redox reaction

!c  reacting species

      aprod = r1
      istart = iarc(ir)
      istop = iarc(ir+1)-1
      do i = istart,istop 
        ic = jarc(i)
        aprod =  aprod*(gammac(ic)*c(ic))**xnur(i)
      end do

!c  produced species

      ic = iars(ir)
      aprod = aprod*(gammac(ic)*c(ic))**(-r1)

!c  final K/IAP 

      aprod = eqr(ir,tid)/aprod

!c  compute final rate
!c  fix this later

      rate = - rate

!c  multiply with affinity factor

      if (rtype_hom(ir).eq.'forward_to_equilibrium'.or.               &
     &    rtype_hom(ir).eq.'backward_to_equilibrium'.or.              &
     &    rtype_hom(ir).eq.'reversible') then

        rate = rate * (r1-aprod)

      end if

!c  consider irreversibility of reaction

      if (rtype_hom(ir).eq.'forward_to_equilibrium') then

        rate = dmax1(rate,r0)

      elseif (rtype_hom(ir).eq.'backward_to_equilibrium') then

        rate = dmin1(rate,r0)

      end if

!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        write(*,'(a)') 'returning from rateredx ...'
        write(*,'(a)') trim(namer(ir))
        write(*,'(a,e17.10)') 'aprod    ',aprod
        write(*,'(a,e17.10)') 'rate     ',rate
        write(*,*) '----------------------------------------------'
      end if

      if (info_debug.gt.1) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

      return
      end
