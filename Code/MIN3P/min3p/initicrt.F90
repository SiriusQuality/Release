!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/initicrt.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initicrt
!c -------------------
!c
!c initial condition (reactive transport) 
!c
!c written by:      Uli Mayer - May 15, 96
!c
!c last modified:   Tom Henderson - June 2, 2004
!c                                  read initial aqueous conc from file 
!c                                  March 2007
!c                                  read nodal mineral surface areas from file
!c                  Rich Amos - 2006
!c                                  overwrite mineral distribution
!c                                  Sergi Molins - May 11, 2006 
!c                                  define/allocate min_to_overwrite and nmo
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           porc               = porosity for local chemistry        + -
!c                                calculations
!c           sac                = air saturation for local            + -
!c                                chemistry calculations
!c           swc                = water saturation for local          + -
!c                                chemistry saturations
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           icnv               =  unit number, data conversion and   + -
!c                                            temporary storage
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           idbg               = unit number, debugging information  + -
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, logbook                + -
!c           itmp               = unit number, temporary storage      + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           l_zone_name        = length of zone name                 * +
!c           mpropc(nn)         = pointer array for allocation of     * +
!c                                chemical material properties
!c
!c           logical:
!c           --------
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           section_header     = section_header                      * +
!c           zone_name          = name of zone                        * +
!c
!c chem.f:   real*8:
!c           -------
!c           ccnew(nc)          = concentrations of free species      + +
!c                                - new time level [moles/l water]
!c           ccold(nc)          = concentrations of free species      + +
!c                                - old time level [moles/l water]
!c           cxc(nx)            = concentrations of secondary         * +
!c                                aqueous species
!c                                - new time level [moles/l water]
!c           cgc(ng)            = gas concentrations                  * +
!c                                - new time level [moles/l air]
!c           gamma_l(nc+nx)     = activity coefficients of aqueous    * *
!c                                species
!c           totcn(nc-1,nthreads)
!c                              = total aqueous component             * *
!c                                concentrations
!c                                - new time level [moles/l water]
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components including h2o  + -
!c           nm                 = number of minerals                  + -
!c
!c           logical:
!c           --------
!c           lb_output          = .true.  -> output of transient data * +
!c                                           (local chemistry)
!c           reactive_minerals  = .true.  -> consider mineral         * +
!c                                           dissolution-
!c                                           precipitation reaction
!c           redox_equil_lc     = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c           tiny               = small increment
!c           ximax              = max. limit of zone in x-direction
!c           ximin              = min. limit of zone in x-direction
!c           yimax              = max. limit of zone in y-direction
!c           yimin              = min. limit of zone in y-direction
!c           zimax              = max. limit of zone in z-direction
!c           zimin              = min. limit of zone in z-direction
!c
!c           integer*4:
!c           ----------
!c           iiz                = counter (zones)
!c           iminvol            = unit number, initial mimeral vol  
!c                                input file
!c           iminvnuc            = unit number, mimeral nucleation thresholds  
!c                                input file
!c           iaqvol            = unit number, initial aqueous  
!c                                concentration input file
!c           ivol               = counter (control volumes)
!c           l_string           = length of text string
!c           nntemp             = counter (control volumes
!c                                possessing initial condition)
!c           niz                = number of zones
!c
!c           logical:
!c           --------
!c           found_section      = .true.  -> section header was
!c                                           found in input file
!c           found_subsection   = .true.  -> subsection header was
!c                                           found in input file
!c           mineral_vol_field  = .true.  -> read mineral volume field
!c                                           from file prefix.min
!c           mineral_vnuc_field  = .true.  -> read mineral volume nucleation thresholds
!c                                           from file prefix.vnuc
!c           mineral_anuc_field  = .true.  -> read reference surface area of mineral volume nucleation thresholds
!c                                           from file prefix.anuc
!c           aq_conc_field  = .true.  -> read aqueous component concentrations
!c                                           from file prefix.aqt
!c
!c           character:
!c           ----------
!c           cdummy             = character dummy variable
!c           subsection         = name of subsection in input file
!c
!c external: clstpfls  = close postprocessing files for transient
!c                       data (local chemistry)
!c           findstrg  = find text string in file
!c           gcreact   = geochemical reactions for batch system
!c           icbcrt    = assign initial or boundary condition
!c                       to global system (reactive transport)
!c           icrtlczn  = read control parameters and initial
!c                       condition for current zone
!c                       (reactive transport or local chemistry)
!c           minmaxwd  = determine minimum total aqueous component
!c                       concentrations and maximum secondary aqueous 
!c                       species concentration in solution domain
!c           opnplfls  = open postprocessing files for
!c                       transient data (local chemistry)
!c           outputlc  = write results of local chemistry
!c                       computations to generic output file
!c           readbloc  = read section of input file and write to
!c                       temporary file
!c           rtrvpprm  = retrieve physical parameters
!c           setsize   = define number of primary unknowns
!c ----------------------------------------------------------------------
 
      subroutine initicrt
 
      use parm
      use gen
      use chem
      use dens
      use bbls
      use file_unit, only : lun_get, lun_free
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
!cprovi-----------------------------------------------------------------
!cprovi This was added by Sergio Andres Bea Jofre 
!cprovi We need the por variable
!cprovi-----------------------------------------------------------------
      use phys 
!cprovi-----------------------------------------------------------------
      implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif
      
      integer :: i, i1, iaqvol, itid, ivol, icecvol, iiz, im, iminvol, &
                 iminsurf, iminvnuc, iminanuc, l_string, niz, nntemp

#ifdef PETSC
      integer :: nntemp_gbl
      PetscErrorCode :: ierrcode
#endif
      
      real*8 :: rdummy, ximin, ximax, yimin, yimax, zimin, zimax, swc, &
                sac, porc
      
      integer :: tid, ierr, imo, istart, istop, j, nmo, ic
      integer :: iskip, nskip

      external clstpfls, findstrg,  icbcrt, icrtlczn,                   &
     &         minmaxwd, opnplfls, outputlc, readbloc, rtrvpprm,        &
     &         setsize, minmaxwd_mpi

      logical found_section, found_subsection
      character*72 subsection
      character*1 cdummy
      
      integer, parameter :: nread = 4
      real*8, parameter :: r1 = 1.0d0, tiny = 1.0d-6
      
      !For the shared-memory parallel version, the variables defined in the module
      !are shared variables by different threads. So as to avoid race condition, 
      !these variable should be passed by dummy arguments. Danyang Su, 2013-05.
      interface
      
        !>interface of gcreact           
        subroutine gcreact(cnew,cold,cx,gammac,gammax,gnew,sw,sa,por,   &
                        igen,ilog,idbg,tec_header,prefix,l_prfx,        &
                        zone_name,l_zone_name) 
          use parm, only : type_i4, type_r8
          real(type_r8), dimension(*) :: cnew
          real(type_r8), dimension(*) :: cold
          real(type_r8), dimension(*) :: cx
          real(type_r8), dimension(*) :: gammac
          real(type_r8), dimension(*) :: gammax
          real(type_r8), dimension(*) :: gnew
          real (type_r8) :: sw
          real (type_r8) :: sa
          real (type_r8) :: por
          integer(type_i4) :: igen
          integer(type_i4) :: ilog
          integer(type_i4) :: idbg
          logical :: tec_header
          character*72 :: prefix
          integer(type_i4) :: l_prfx
          character*72 :: zone_name
          integer(type_i4) :: l_zone_name      
        end subroutine
      
      end interface

#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
      
!c  set defaults

      mineral_vol_field = .false.
      mineral_vnuc_field = .false.
      mineral_anuc_field = .false.
      aq_conc_field = .false.
      mineral_surf_field = .false.
      cec_field=.false. 

!c  initialize number of control volumes with assigned initial condition

      nntemp = 0
 
!c  read section header for initial condition (reactive transport)

      section_header = 'initial condition - reactive transport'
      call readbloc (idat,itmp,section_header,found_section,.true.)

!c  define length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      endif

!c  terminate program if section header not found

      if (.not.found_section) then
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

!c  write section header to generic output file
      if (b_enable_output .and. b_enable_output_gen) then
        write(igen,'(/72a)')('-',i=1,72)
        write(igen,'(a)') section_header(:l_string)
        write(igen,'(72a)')('-',i=1,72)
      end if

      if(rank == 0 .and. b_enable_output) then
        write(*,'(/1x,a)') section_header(:l_string)
        write(*,'(1x,72a)')('-',i=1,72)
      end if
      
      if (rank == 0 .and. b_enable_output) then
        write(ilog,'(a)') section_header(:l_string)
        write(ilog,'(72a/)')('-',i=1,72)
      end if
 
!c  assign free species concentration for h2o

      ccnew(nc) = r1
      ccold(nc) = r1

!c  read number of zones for initial condition
  
      read(itmp,*,err=999,end=999) niz
      if (b_enable_output .and. b_enable_output_gen) then
        write(igen,'(/a,i10)')  &
     &  'number of zones for initial condition           = ',niz
      end if

!c  read initial total aqueous component concentrations as nodal values from separate file
!c  file must be named 'prefix'.aqt

      subsection = &
     &   'read initial aqueous component concentrations from file' ! miss-spell 
!c                                                                     noted 1/4/05
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        aq_conc_field = .true.
      end if
!cprovi---------------------------------------------------------------------------------
!cprovi Read CEC field from file 
!cprovi Open the unit 
!cprovi Sergio Andres Bea Jofre
!cprovi Vancouver 16/11/2009
!cprovi---------------------------------------------------------------------------------      
      if (nsb_ion>0) then
      
      subsection = 'read cec from file' 
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        cec_field = .true.
        !icecvol=29
        icecvol = lun_get()
        open(icecvol,file=prefix(:l_prfx)//'.cec',status='old', &
            form='formatted')
        read(icecvol,*,err=999,end=999) cdummy
        read(icecvol,*,err=999,end=999) cdummy
        read(icecvol,*,err=999,end=999) cdummy
        nskip = 0
        do ivol=1,nngl 
#ifdef PETSC
          do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
              read(icecvol,*,end=999,err=999) rdummy
          end do
          nskip = node_idx_lg2g(ivol)
#endif 
          read(icecvol,*,end=999,err=999) (rdummy, i=1,3),cec_g(ivol), &
                                          rhobulk_g(ivol)
        end do
        close(icecvol)
        call lun_free(icecvol)
      end if
      
      end if
!cprovi---------------------------------------------------------------------------------
!cprovi---------------------------------------------------------------------------------
!cprovi---------------------------------------------------------------------------------
      if(aq_conc_field) then

!c current program: only one zone allowed if aqueous concentrations are read from file

        if (niz .gt. 1) then
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "', section_header(:l_string),'"'
            write(ilog,*) 'zone "', zone_name(:l_zone_name),'"'
            l_string = index(subsection,'  ')-1
            if (l_string.eq.-1.or.l_string.gt.72) then
               l_string=72
            end if
            write(ilog,*) 'only one zone allowed if nodal aqueous  &  
     &                    concentrations are read from file'
            close(ilog)
          end if

#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
      end if


!c  open nodal file : use *.gst file format with three header rows
!c  pH column must be added in the correct order 

        !iaqvol=26
        iaqvol = lun_get()
        open(iaqvol,file=prefix(:l_prfx)//'.aqt',status='old',    &
     &          form='formatted')

        read(iaqvol,*,err=999,end=999) cdummy
        read(iaqvol,*,err=999,end=999) cdummy
        read(iaqvol,*,err=999,end=999) cdummy

!c  initialize control and input parameters for current zone 

        iiz = 1
        call icrtlczn(iiz)
!c  set number of primary unknowns for current batch problem
        call setsize(redox_equil_lc)

!c  read coordiantes delineating zone
!c may be able to kill this

        subsection = 'extent of zone'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then

          read(icnv,*,err=999,end=999) ximin,ximax,yimin,yimax,   &
     &                                 zimin,zimax

        elseif (.not.found_subsection) then
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "', section_header(:l_string),'"'
            write(ilog,*) 'zone "', zone_name(:l_zone_name),'"'
            l_string = index(subsection,'  ')-1
            if (l_string.eq.-1.or.l_string.gt.72) then
               l_string=72
            end if
            write(ilog,*) 'subsection "',subsection(:l_string),     &
     &                    '" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop

        end if

!c nodal aqueous concnentratins
        nskip = 0
        do ivol=1,nngl
!c read concentrations  
#ifdef PETSC
          do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
              read(iaqvol,*,end=999,err=999) rdummy
          end do
          nskip = node_idx_lg2g(ivol)
#endif
          read(iaqvol,*,end=999,err=999) (rdummy, i=1,3),         &
     &           (totco(i1,tid),i1 = 1,nc-1)
!cdsu -------------------------------------------------------------
!cdsu  Sync data to other slave threads
!cdsu -------------------------------------------------------------
          do itid = 1, nthreads
            totco(:,itid) = totco(:,tid)
          end do




!cprovi-------------------------------------------------------          
!cprovi This was added by Sergio Andres Bea Jofre 
!cprovi If CEC field was defined, then assign CEC and rhobulk
!cprovi corresponding to ivol 
!cprovi-------------------------------------------------------          
          por=pornew(ivol)
          if (cec_field) then
             cec(:)=cec_g(ivol)
             rhobulk=rhobulk_g(ivol)
          end if 
!cprovi-------------------------------------------------------          
!cprovi-------------------------------------------------------          
!cprovi-------------------------------------------------------                    
!cprovi-------------------------------------------------------          
!c  retrieve physical parameters for scaling
          call rtrvpprm(swc,sac,porc,section_header)
!c  temperature correction
          if (temp_field.or.heat_transport) then
            call tcorr(tkel(ivol))
          end if
!c-----------------------------------------------------------------------
!c  compute initial conditions for Newton Raphson
!c-----------------------------------------------------------------------
!cmx   The type of H+ is fixed to 'pH'. The type of 'O2(aq)' is not treated seperatly,
!       which means it can only be given in concentration, not others like 'eh'.
          do ic=1,nc-1
            if (namec(ic).eq.'h+1') then
                ccold(ic) = 10.0**(-phguess)
                ccnew(ic) = ccold(ic)
            else
                ccold(ic) = 1.0d-2*dabs(totco(ic,tid))
                ccnew(ic) = ccold(ic)
            end if
          end do
!c  compute initial condition
 
          call gcreact(ccnew,ccold,cxc,gamma_l(1),gamma_l(nc+1),  &
     &               cgc,swc,sac,porc,igen,ilog,idbg,tec_header,  &
     &               prefix,l_prfx,zone_name,l_zone_name)

!c  determine minimum total aqueous component concentrations and maximum
!c  secondary aqueous species concentration in solution domain

          call minmaxwd(cxc,totcn(:,tid))

 
!c  assign initial condition to global system
          
          mpropc(ivol) = iiz

#ifdef PETSC
          if(node_idx_lg2l(ivol) > 0) then
            nntemp = nntemp+1
          end if
#else
          nntemp = nntemp+1
#endif

          call icbcrt(ivol,0)

        end do         !(loop over control volumes)    
#ifdef PETSC
        call minmaxwd_mpi
#endif
    
      else !read by zones from MIN3P input file
!cprovi------------------------------------------------------------------------------------
!cprovi------------------------------------------------------------------------------------
!cprovi------------------------------------------------------------------------------------
!cprovi------------------------------------------------------------------------------------     
        do iiz=1,niz                            !loop over zones

!c  initialize control and input parameters for current zone 

          call icrtlczn(iiz)

!c  read coordiantes delineating zone

          subsection = 'extent of zone'

          call findstrg(subsection,icnv,found_subsection)

          if (found_subsection) then

            read(icnv,*,err=999,end=999) ximin,ximax,yimin,yimax, &
     &                                 zimin,zimax

          elseif (.not.found_subsection) then
            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading input file'
              write(ilog,*) 'section "', section_header(:l_string),'"'
              write(ilog,*) 'zone "', zone_name(:l_zone_name),'"'
              l_string = index(subsection,'  ')-1
              if (l_string.eq.-1.or.l_string.gt.72) then
                 l_string=72
              end if
              write(ilog,*) 'subsection "',subsection(:l_string),   &
     &                      '" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if

!c  set number of primary unknowns for current batch problem

          call setsize(redox_equil_lc)

!c  open output files for postprocessing
  
          if(rank == 0) then 
            if (lb_output .and. b_enable_output) then
              call opnplfls(iiz)
            end if
          end if

!c  retrieve physical parameters for scaling
          
          call rtrvpprm(swc,sac,porc,section_header)

!c  temperature correction
          if (temp_field.or.heat_transport) then
            call tcorr(tempk)
          end if

!c  compute initial condition
          call gcreact(ccnew,ccold,cxc,gamma_l(1),gamma_l(nc+1),  &
     &               cgc,swc,sac,porc,igen,ilog,idbg,tec_header,  &
     &               prefix,l_prfx,zone_name,l_zone_name)
 
!c  determine minimum total aqueous component concentrations and maximum
!c  secondary aqueous species concentration in solution domain

          call minmaxwd(cxc,totcn(:,tid))
          

!c  write results to generic output file
          if(b_enable_output .and. b_enable_output_gen)  then
            call outputlc(ccnew,cxc,gamma_l(1),gamma_l(nc+1),cgc, &
     &                  igen,ilog,section_header)
          end if
 
!c  assign initial condition to global system

!c  increment coordinates delineating zone

          ximin = ximin-tiny
          ximax = ximax+tiny
          yimin = yimin-tiny
          yimax = yimax+tiny
          zimin = zimin-tiny
          zimax = zimax+tiny

          do ivol = 1,nngl    !loop over control volumes

!c  check limits of boundary zone

            if ((xg(ivol).gt.ximin).and.(xg(ivol).lt.ximax)) then
              if ((yg(ivol).gt.yimin).and.(yg(ivol).lt.yimax)) then
                if ((zg(ivol).gt.zimin).and.(zg(ivol).lt.zimax)) then
           
                  mpropc(ivol) = iiz

#ifdef PETSC
                  if(node_idx_lg2l(ivol) > 0) then
                    nntemp = nntemp+1
                  end if
#else
                  nntemp = nntemp+1
#endif

                  call icbcrt(ivol,0)

                end if      !(zg(ivol).gt.zimin).and.(zg(ivol).lt.zimax)
              end if        !(yg(ivol).gt.yimin).and.(yg(ivol).lt.yimax)
            end if          !(xg(ivol).gt.ximin).and.(xg(ivol).lt.ximax)
          end do            !loop over control volumes

!c
!c  clear logical array for next zone
 
          reactive_minerals = .false.
 
!c  close files for postprocessing 
          if(rank == 0) then
            if (lb_output .and. b_enable_output) then
              call clstpfls
            end if
          end if
 
        end do         !(loop over number of zones)

#ifdef PETSC
        call minmaxwd_mpi
#endif
 
      end if         !(aq_conc_field)

#ifdef PETSC
      call MPI_Allreduce(nntemp, nntemp_gbl,1,MPI_INTEGER4,MPI_SUM,  &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      nntemp = nntemp_gbl
#endif

!c  read initial mineral volume fractions as nodal values from separate file
!c  file must be named 'prefix'.min

      subsection = 'read initial mineral volume fractions from file'

      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then

        mineral_vol_field = .true.

!c  read mineral volumes

        !iminvol=27
        iminvol = lun_get()
        open(iminvol,file=prefix(:l_prfx)//'.min',status='old',   &
     &          form='formatted')

        read(iminvol,*,err=999,end=999) cdummy
        read(iminvol,*,err=999,end=999) cdummy
        read(iminvol,*,err=999,end=999) cdummy
        nskip = 0
        do ivol = 1,nngl
#ifdef PETSC
          do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
              read(iminvol,*,end=999,err=999) rdummy
          end do
          nskip = node_idx_lg2g(ivol)
#endif
          read(iminvol,*,end=999,err=999) (rdummy, i=1,3),        &
     &        (phi_init(im,ivol),im=1,nm), por_init(ivol) 
        end do
         
!c       update matrices: phi, phiold, cmold, and cmnew 
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initicrt_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(im, ivol)
    !$omp do schedule(static)
#endif
        do ivol = 1,nngl
         do im=1,nm
           if (phi_init(im,ivol)<phic(im,tid)) then
             phi_init(im,ivol)=phic(im,tid)  
           end if 
             phi(im,ivol) = phi_init(im,ivol)
             phiold(im,ivol) = phi_init(im,ivol)
             cmold(im,ivol) = 1000.d0 * phi_init(im,ivol) *       &
                              densm(im) / gfwm(im)
             cmnew(im,ivol)=cmold(im,ivol)
         end do
        end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

        close(iminvol)
        call lun_free(iminvol)
                
      end if !found subsection

!c THH March 07
!c  read initial mineral surface areas as nodal values from separate file
!c  file must be named 'prefix'.surf

      subsection = 'read initial mineral areas from file'

      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then

        mineral_surf_field = .true.

!c  read mineral volumes

        !iminsurf=28
        iminsurf = lun_get()
        open(iminsurf,file=prefix(:l_prfx)//'.surf',status='old', &
     &          form='formatted')

        read(iminsurf,*,err=999,end=999) cdummy
        read(iminsurf,*,err=999,end=999) cdummy
        read(iminsurf,*,err=999,end=999) cdummy
        nskip = 0
        do ivol = 1,nngl
#ifdef PETSC
          do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
              read(iminsurf,*,end=999,err=999) rdummy
          end do
          nskip = node_idx_lg2g(ivol)
#endif
          read(iminsurf,*,end=999,err=999) (rdummy, i=1,3),       &
     &        (area_init(im,ivol),im=1,nm) 
        end do
        close(iminsurf)
        call lun_free(iminsurf)

!c update areas
        do im=1,nm
          do ivol = 1,nngl
            area(im,ivol) = area_init(im,ivol)
          end do
        end do

      end if  
      
!c  read mineral volume fractions nucleation thresholds as nodal values from separate file
!c  file must be named 'prefix'.vnuc
!c  DSU, 2013-2-18

      subsection = 'read mineral volume fractions nucleation thresholds from file'

      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then

        mineral_vnuc_field = .true.

!c  read mineral volume fractions nucleation thresholds

        !iminvnuc=94
        iminvnuc=lun_get()
        open(iminvnuc,file=prefix(:l_prfx)//'.vnuc',status='old',   &
     &          form='formatted')

        read(iminvnuc,*,err=999,end=999) cdummy
        read(iminvnuc,*,err=999,end=999) cdummy
        read(iminvnuc,*,err=999,end=999) cdummy
        nskip = 0
        do ivol = 1,nngl
#ifdef PETSC
          do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
              read(iminvnuc,*,end=999,err=999) rdummy
          end do
          nskip = node_idx_lg2g(ivol)
#endif 
          read(iminvnuc,*,end=999,err=999) (rdummy, i=1,3),        &
     &        (phinucthrd(im,ivol),im=1,nm) 
        end do
         
        close(iminvnuc)
        call lun_free(iminvnuc)
                
      end if !found subsection
      
!c  read nucleation threshold reference surface area as nodal values from separate file
!c  file must be named 'prefix'.anuc
!c  DSU, 2013-2-18 

      subsection = 'read nucleation threshold reference surface area from file'

      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then

        mineral_anuc_field = .true.

!c  read nucleation threshold reference surface area

        !iminanuc=28
        iminanuc=lun_get()
        open(iminanuc,file=prefix(:l_prfx)//'.anuc',status='old', &
     &          form='formatted')

        read(iminanuc,*,err=999,end=999) cdummy
        read(iminanuc,*,err=999,end=999) cdummy
        read(iminanuc,*,err=999,end=999) cdummy
        nskip = 0
        do ivol = 1,nngl
#ifdef PETSC
          do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
              read(iminanuc,*,end=999,err=999) rdummy
          end do
          nskip = node_idx_lg2g(ivol)
#endif
          read(iminanuc,*,end=999,err=999) (rdummy, i=1,3),       &
     &        (areanucthrd(im,ivol),im=1,nm) 
      end do
      close(iminanuc)
      call lun_free(iminanuc)

      end if 
      
!c  check if initial conditions have been assigned correctly

      if (nntemp.gt.nngbl) then

        if (rank == 0 .and. b_enable_output) then            
          write(ilog,*)
          write(ilog,'(a)') &                   !screen or logbook
     &          'warning ...........'
          write(ilog,'(2a,i6,a)')                                       &
     &          'initial conditions for reactive transport have been ', &
     &          'assigned to ',nntemp,' control volumes'
          write(ilog,'(a,i6)')                                          &
     &          'the actual number of control volumes is only',nngbl
          write(ilog,'(/72a)')('-',i=1,72)
        end if  
          
        if (b_enable_output .and. b_enable_output_gen) then
          write(igen,*)
          write(igen,'(a)') &                  !general output file
     &          'warning ...........'
          write(igen,'(2a,i6,a)')                                       &
     &          'initial conditions for reactive transport have been ', &
     &          'assigned to ',nntemp,' control volumes'
          write(igen,'(a,i6)')                                          &
     &          'the actual number of control volumes is only',nngbl
          write(igen,'(/72a)')('-',i=1,72)
        end if

      elseif (nntemp.lt.nngbl) then

        if (rank == 0) then  
          write(ilog,'(2a)') 'could not assign initial conditions ',    &
     &                    'for reactive transport to all control volumes'
        end if
        
        goto 999

      end if
      
!c_bubbles read subsection 'overwrite mineral distibution'

      subsection = 'overwrite mineral distribution'
      call findstrg(subsection,itmp,found_subsection)
    
      if (found_subsection) then

        read(itmp,*,err=999,end=999) nmo

        allocate (min_to_overwrite(nmo), stat = ierr)
        call checkerr(ierr,'min_to_overwrite',ilog)

        do i = 1,nmo,nread

            istart = i
            istop = i+nread-1
            if (istop.gt.nmo) then
              istop = nmo
            end if
            read(itmp,*,err=999,end=999) (min_to_overwrite(imo),       &
                                          imo=istart,istop)
        end do

        if (rank == 0 .and. b_enable_output) then
          write(ilog,*) 'reading mineral distributions from file'
        end if
        
        !igsv = 69
        igsv = lun_get()
       
        do i=1,nmo

          open(igsv,file=prefix(:l_prfx)//'.gsv',status='unknown',     &
               form='formatted')
          
          im=min_to_overwrite(i)
          if (rank == 0 .and. b_enable_output) then
            write(igen,'(/2a)')                                        &
             'read mineral volume fractions from file for mineral "',  &
              namem(im)(:l_namem(im))
          end if
            
          read(igsv,*,err=999,end=999) cdummy
          read(igsv,*,err=999,end=999) cdummy
          read(igsv,*,err=999,end=999) cdummy
          do ivol = 1,nngl
            read(igsv,*,err=999,end=999) (cdummy,j=1,3+(im-1)),        &
                 phic(im,tid)
            call initgeom(im,idbg)
            cmnew(im,ivol) = cmcnew(im,tid)
            cmold(im,ivol) = cmcnew(im,tid)
            phi(im,ivol) = phic(im,tid)
            phiold(im,ivol) = phic(im,tid)
            phi_init(im,ivol) = phic(im,tid)
          end do
          close (igsv)
          call lun_free(igsv)
        end do
        
        do ivol =1,nngl
          call distmp(cmnew(1,ivol),phi(1,ivol),area(1,ivol))
        end do
        
      end if

      goto 1000
      
999   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file'
        write(ilog,*) 'section "',section_header(:l_string),'"'
        write(ilog,*) 'zone "', zone_name(:l_zone_name),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end
