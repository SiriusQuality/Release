!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/readgses.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readgses
!c -------------------
!c
!c read database for gaseous species and assign to permanent storage
!c
!c written by:      Uli Mayer - September 12, 96
!c
!c last modified:   Uli Mayer - December 6, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           igdbs              = unit number, database gases         + -
!c           ilog               = unit number, log book               + -
!c           idbg               = unit number, debugging file         + -
!c           ipsp               = unit number, list of possible       + -
!c                                             secondary aqueous 
!c                                             species, gases and 
!c                                             minerals
!c
!c common:
!c bbls.f    real*8
!c           ------
!c           gascon_a(ng)       = temperature dependent solubility coefficient
!c           gascon_b(ng)       = temperature dependent solubility coefficient
!c           gascon_c(ng)       = temperature dependent solubility coefficient
!c                              
!c           character          
!c           ---------          
!c           gas_type(ng)       = specifies temperature dependence of solubility
!c                                 'type_0' enthalphy (default)               
!c                                 'type_1' CRC handbook
!c                                 'type_2' bunsen solubility coefficients
!c
!c chem.f:   real*8:
!c           -------
!c           dhcg(ng)           = enthalpy change for gases           * +
!c           eqgs(ng)           = equilibrium constants for           * +
!c                                formation of gases from free
!c                                species at standard temperature
!c           gfwg(ng)           = gram formula weight for gases       * +
!c           xnug(ng*nc)        = stoichiometric coefficient matrix   * +
!c                                for formation of gases from
!c                                free species
!c            
!c           integer*4:
!c           ----------
!c           iaga(ng+1)         = row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           jaga(ng*nc)        = column pointer array to             * +
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c
!c           logical:
!c           --------
!c           search_database    = .true.  -> search database for      + -
!c                                           all secondary species
!c                                           possible and list in
!c                                           file prefix_o.psp
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namet(30)          = species names (temporary)           * *
!c
!c local:    real*8:
!c           -------
!c           dhc                = enthalpy change (temporary)
!c           eqt                = log equilibrium constant 
!c                                (temporary)
!c           gfw                = gram formula weight (temporary)
!c           xnugt(iv)          = stoichiometric coefficient of 
!c                                component in gaseous species 
!c                                (temporary)
!c
!c           integer*4:
!c           ----------
!c           i                = counter
!c                              array)
!c           ic               = counter (components)
!c           icount           = counter (check number of species)
!c           icur             = counter (position in compresses
!c                                       array)
!c           iend             = pointer
!c           istart           = pointer
!c           iv               = counter
!c           l_name           = length of name
!c           nv               = number of components forming 
!c                              gas (temporary)
!c
!c           logical:
!c           --------
!c           found            = logical variable to stop search 
!c                              for species
!c           done             = logical variable to stop search 
!c                              for gas
!c
!c           character:
!c           ----------
!c           name             = name of component currently 
!c                              processed
!c           rgas_type        = specifies temperature dependence of solubility
!c                              - temporary
!c           rgascon_a        = solubility coefficient - temporary
!c           rgascon_b        = solubility coefficient - temporary
!c           rgascon_c        = solubility coefficient - temporary
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readgses(igdbs,ipsp,ilog,idbg)
 
      use parm
      use chem
      use bbls
      use gen, only : rank, b_enable_output
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      implicit none
      
      integer :: igdbs,ipsp,ilog,idbg
      
      integer :: i, iii, ic, ig, icount, icur, istart, iend, iv, nv,   &
                 l_name
      
      real*8 :: dhc, eqt, gfw, xnugt, rgascon_a, rgascon_b, rgascon_c

      character*256 :: strbuffer
      character*72 :: name
      character*12 :: rgas_type
      dimension xnugt(20)
      logical done,found    
      real*8, parameter :: r0 = 0.0d0
!c_bubbles initialize temperature dependence variables

      if (gas_bubbles) then
        gascon_a = r0
        gascon_b = r0
        gascon_c = r0
        gas_type = 'type_0'
      end if
 
!c  search database for possible secondary aqueous species

      if (search_database) then

        if (rank == 0 .and. b_enable_output) then
          write(ipsp,'(/a)') 'gases'
          write(ipsp,'(a/)') '-----'
        end if

        do while (.true.)
          read(igdbs,100,end=999,err=9999) name,dhc,eqt,gfw,           &
                         nv,(namet(iv),xnugt(iv),iv=1,nv)
			 
!c_bubbles - read in third line if temperature dependence is specified
          if (gas_bubbles) then  
            if ((dhc.gt.9.985e2).and.(dhc.lt.9.995e2))then
              read (igdbs,'(3f10.4)') rgascon_a, rgascon_b, rgascon_c
            else if ((dhc.gt.9.975e2).and.(dhc.lt.9.985e2))then
              read (igdbs,'(3f10.4)') rgascon_a, rgascon_b, rgascon_c
            end if
          end if

          if (name.eq.'end') goto 999

!c  check if all components with non-zero stoichiometric coefficients in 
!c  gas are specified in general input file

          icount = 0
          ic = 0
          do while ((icount.lt.nv).and.(ic.lt.nc))
            ic = ic+1
            iv = 0
            found = .false.
            do while ((iv.lt.nv).and.(.not.found))
              iv = iv+1
              if (namet(iv).eq.namec(ic)) then
                found = .true.
                icount = icount+1
              end if
            end do
          end do

!c  report all possible gases

          if (icount.eq.nv) then
             l_name = index(name,' ')-1
             if (l_name.gt.72.or.l_name.eq.-1) then
               l_name = 72
             end if
             if (rank == 0 .and. b_enable_output) then
               write(ipsp,'(3a)') "'",name(:l_name),"'"
             end if
          end if

        end do             !loop over gases in database

999     continue

!c  rewind database file

        rewind(igdbs)

      end if               !search_database

!c  read data for specified gases

      if (ng.gt.0) then

!c  initialize row pointer array for sparse matrix structure
 
        iaga(1) = 1
 
!c  loop over gaseous species specified for simulation
 
        do ig = 1,ng
 
!c  loop over gaseous species in database,
!c  search for match and assign data to permanent storage
!c  exit when done or when end of file is reached
 
          done = .false.
 
          do while (.not.done)
              
!c_bubbles set temporary temperature dependence variables to zero
            if (gas_bubbles) then
              rgascon_a = r0
              rgascon_b = r0
              rgascon_c = r0
              rgas_type = 'type_0'
            end if
 
!c  read name of complexed species and complex specific data 
 
            read(igdbs,100,err=9999) name,dhc,eqt,gfw,                 &
                            nv,(namet(iv),xnugt(iv),iv=1,nv)
            
!c_bubbles - read temperature dependence variables for gases
!c_bubbles - if dhc = 999 then gas type is type 1, from CRC manual 
            if (gas_bubbles) then
              if ((dhc.gt.9.985e2).and.(dhc.lt.9.995e2))then
                rgas_type = 'type_1'
                read (igdbs,'(3f10.4)') rgascon_a, rgascon_b, rgascon_c
!c_bubbles - if dhc = 998 then gas type is type 2, bunsen solubility coefficients
              else if ((dhc.gt.9.975e2).and.(dhc.lt.9.985e2))then
                rgas_type = 'type_2'
                read (igdbs,'(3f10.4)') rgascon_a, rgascon_b, rgascon_c
              end if  
            end if
 
!c  look for match, as long end of file is not reached or 
!c  match is found
 
!c  complexed species is found --> assign permanent storage
 
            if (name.eq.nameg(ig)) then
 
              done = .true.
 
!c  pointer array to row in stoichiometric reaction matrix for
!c  next complex
 
              iaga(ig+1) = iaga(ig)+nv
 
!c  check if all components for gas
!c  are specified in general input file
!c  set up pointer array to column in stoichiometric matrix
 
              icount = 0
              ic = 0
              do while ((icount.lt.nv).and.(ic.lt.nc))
                ic = ic+1
                iv = 0
                found = .false.
                do while ((iv.lt.nv).and.(.not.found))
                  iv = iv+1
                  if (namet(iv).eq.namec(ic)) then
                    found = .true.
                    icount = icount+1
                    icur = iaga(ig)+iv-1
                    jaga(icur) = ic
                  end if
                end do
              end do
 
!c  if component is missing, exit
 
              if (icount.ne.nv) then
                  
                if (rank == 0) then  
                  write(ilog,'(72a)') ('-',i=1,72)
                  write(ilog,'(a,a12,a)')'component for ',              &
     &                                    name,' is missing'
                  write(ilog,'(72a)') ('-',i=1,72)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
 
!c  all components available --> assign data to permanent storage
 
              elseif (icount.eq.nv) then
!                dhcg(ig) = dhc
!cdhr - corrected April 06
                dhcg(ig) = -dhc       
                eqgs(ig) = 10.0d0**(-eqt)
                gfwg(ig) = gfw
                
!c_bubbles assign temperature dependence variables
                if (gas_bubbles) then
                  gascon_a(ig) = rgascon_a
                  gascon_b(ig) = rgascon_b
                  gascon_c(ig) = rgascon_c
                  gas_type(ig) = rgas_type
                end if
 
!c  stoichiometric coefficients
 
                istart = iaga(ig)
                iend = iaga(ig+1)-1
                iv = 0
                do i = istart,iend
                  iv = iv+1
                  xnug(i) = xnugt(iv)
                end do
              end if
 
!c  end of file is reached --> exit 
 
            elseif (name.eq.'end') then
              if (rank == 0) then
                write(ilog,'(72a)') ('-',i=1,72)
                write(ilog,'(a,a,a)')'gaseous species ',trim(nameg(ig)),    & 
     &                                 ' not in database'
                write(ilog,'(72a)') ('-',i=1,72)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop
 
            end if
          end do                 !end - loop over database for gases
 
!c  rewind database for aqueous complexes to search for next 
!c  complexed species, doing this allows the specification of 
!c  complexed species in an arbitray order
 
          rewind(igdbs)
 
        end do                   !end - loop over specified complexes

      end if                     !(ng.gt.0)

100  format(a12,2x,2f10.4,31x,f9.4/6x,i2,2x,20(a12,1x,f7.3,1x))
! 100  format(a12,2x,2f10.4,31x,f9.4/6x,i1,3x,5(a12,1x,f7.3,1x))
 
!cdbg ---- activate this section for purposes of debugging -----
#ifdef DEBUG      
      iii = 0
      if (iii.eq.1) then 
      do ig=1,ng 
        write(idbg,'(a,i3,2x,a)') 'ig    = ',ig,trim(nameg(ig))
        write(idbg,'(a,f10.4)') 'dhcg(ig)     = ',dhcg(ig)
        write(idbg,'(a,f10.4)') 'eqgs(ig)     = ',dlog10(eqgs(ig))
        write(idbg,'(a,f10.4)') 'gfwg(ig)     = ',gfwg(ig)
        write(idbg,'(a,i10)') 'iaga    ',iaga(ig)
        if (gas_bubbles) then
          write(idbg,'(a,a)')'gas_type(ig)   =',gas_type(ig)
          write(idbg,'(a,f10.4)') 'gascon_a(ig) = ',gascon_a(ig)
          write(idbg,'(a,f10.4)') 'gascon_b(ig) = ',gascon_b(ig)
          write(idbg,'(a,f10.4)') 'gascon_c(ig) = ',gascon_c(ig)
        end if
 
!c  echo check for stoichiometric coefficients
 
        istart = iaga(ig)
        iend = iaga(ig+1)-1
        do i = istart, iend
          icur = jaga(i)
          write(idbg,'(i5,2x,a72,a,i5,a,f10.3)') i,namec(icur),' jaga ',&
     &                jaga(i),' xnug ',xnug(i)
        end do
        write(idbg,*)
        write(idbg,*) '----------------------------------------------'
        write(idbg,*)
      end do
      end if      
!c     stop
#endif
!cdbg
      return

9999  continue
      backspace(igdbs)
      read(igdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in gas database: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in gas database: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end
  
