!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/inittemp.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine inittemp
!c -------------------
!c
!c define temperature field
!c
!c written by:      Uli Mayer - June 25, 1999
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed: -
!c
!c common: 
!c gen.f:    real*8:
!c           -------
!c           tkel(nngl)           = nodal temperatures in Kelvin      + -
!c
!c chem.f:   real*8:
!c           -------
!c           dhad(nthreads)     = Debye Huckel constant a_d depending * +
!c                                on dielectric constant and
!c                                temperature
!c           dhbd(nthreads)     = Debye Huckel constant b_d depending * +
!c                                on dielectric constant and
!c                                temperature
!c           eqaq(naq,nthreads) = equilibrium constants for           * +
!c                                intra-aqueous kinetic reactions
!c           eqaqs(naq)         = equilibrium constants for           + -
!c                                intra-aqueous kinetic reactions
!c                                at standard temperature
!c           eqg(ng,nthreads)   = equilibrium constants for gases     * +
!c           eqgs(ng)           = equilibrium constants for gases     + -
!c                                at standard temperature
!c           eqm(nm,nthreads)   = equilibrium constants for minerals  * +
!c           eqms(nm)           = equilibrium constants for minerals  + -
!c                                at standard temperature
!c           eqmx(nmx,nthreads) = equilibrium constants for excluded  * +
!c                                minerals
!c           eqmxs(nmx)         = equilibrium constants for excluded  + -
!c                                minerals at standard temperature
!c           eqsb(nsb)          = equilibrium constants for           * +
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for           * +
!c                                sorbed species (ion-exchange)
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for           * +
!c                                sorbed species (surface-complex)
!c           eqsbs(nsb)         = equilibrium constants for           + -
!c                                sorbed species at standard
!c                                temperature
!c           eqsbs_ion(nsb_ion) = equilibrium constants for           + -
!c                                sorbed species at standard
!c                                temperature (ion-exchange)
!c           eqsbs_surf(nsb_surf)
!c                              = equilibrium constants for           + -
!c                                sorbed species at standard
!c                                temperature (surface-complex)
!c           eqr(nr,nthreads)   = equilibrium constant for redox      * +
!c                                couple reaction equation
!c           eqrs(nr)           = equilibrium constant for redox      + -
!c                                for standard temperature
!c                                couple reaction equation
!c           eqx(nx,nthreads)   = equilibrium constants for           * +
!c                                secondary aqueous species
!c           eqxs(nx)           = equilibrium constants for           + -
!c                                secondary aqueous species
!c                                at standard temperature
!c           ratecaq(naq,nthreads)
!c                              = log of rate constant for intra-     * +
!c                                aqueous kinetic reactions
!c                                (units: liter -  moles - seconds)
!c           ratecaqs(naq)      = log of rate constant for intra-     + -
!c                                aqueous kinetic reactions at
!c                                stndard temperature
!c                                (units: liter -  moles - seconds)
!c           rated(ndr*nm,nthreads)
!c                              = rate constants for dissolution      * +
!c                                reactions
!c           rateds(ndr*nm)     = rate constants for dissolution-     + -
!c                                precipitation reactions at
!c                                standard temperature
!c           tempk              = temperature [deg K]                 + -
!c           tconv              = temperature correction factor       + -
!c 
!c           integer*4:
!c           ---------- 
!c           iamd(nm+1)         = pointer array to dissolution-       + -
!c                                precipitation reactions
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nx                 = number of aqueous complexes         + -
!c
!c           logical:
!c           --------
!c           temp_corr          = .true.  -> specify constant         + -
!c                                           temperature
!c                                .false. -> use standard
!c                                           temperature
!c           temp_field         = .true.  -> nodal temperatures       + -
!c
!c local:    integer*4:
!c           ----------
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imx                = counter (excluded minerals)
!c           ir                 = counter (redox couples)
!c           ireac              = counter (dissolution-
!c                                         precipitation reactions)
!c           isb                = counter (sorbed species)
!c           istart             = pointer
!c           istop              = pointer
!c           ix                 = counter (aqueous complexes)
!c
!c
!c external: dhconst   = compute debye huckel constants a_d and b_d
!c           intpolt   = interpolate depth-dependent temperature 
!c                       data on grid
!c           opntemp   = open file containing temperature data
!c                       and read initial temperature profile
!c           tcorr     = temperature correction for debye-huckel,
!c                       equilibrium and rate constants
!c           vhoff     = temperature correction for equilibrium 
!c                       and rate constants based on Van't Hoff 
!c                       and Arrhenius equations
!c ----------------------------------------------------------------------
 
      subroutine inittemp
 
      use parm
      use gen
      use chem
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      integer :: iaq, ig, im, imx, ir, ireac, isb, istart, istop,      &
                 ivol, ix, info_debug
      
      integer :: tid

      external dhconst,intpolt,opntemp,vhoff
      
      !For the shared-memory parallel version, the variables defined in the module
      !are shared variables by different threads. So as to avoid race condition, 
      !these variable should be passed by dummy arguments. Danyang Su, 2013-05.
      interface
      
        !>interface of tcorr
        subroutine tcorr(tempkel)
          use parm, only : type_r8     
          real(type_r8) :: tempkel    
        end subroutine tcorr
      
      end interface
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

!c  assign debye-huckel, equilibrium and rate constants
!c  standard temperature and initail condition for temperature
!c  field

      if (.not.temp_corr.or.temp_field.or.heat_transport) then

        call dhconst(dhad(tid),dhbd(tid),tempk,tconv)        
     
!cdsu -------------------------------------------------------------
!cdsu  Sync data to other slave threads
!cdsu -------------------------------------------------------------
        dhad(:) = dhad(tid)
        dhbd(:) = dhbd(tid)

!c  aqueous complexation reactions

        do ix = 1,nx
          eqx(ix,:) = eqxs(ix)
        end do
 
!c  gas dissolution-exsolution reactions

        do ig = 1,ng
          eqg(ig,:) = eqgs(ig)
        end do
     
!c  dissolution-precipitation reactions

        do im = 1,nm

          eqm(im,:) = eqms(im)
  
          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop
            rated(ireac,:) = rateds(ireac)
          end do

        end do

!c  excluded mineral phases

        do imx = 1,nmx
          eqmx(imx,:) = eqmxs(imx)
        end do

!c  redox couples

        do ir = 1,nr
          eqr(ir,:) = eqrs(ir)
        end do

!c  sorption and ion-exchange reactions

        do isb = 1,nsb_ion
          eqsb_ion(isb,:) = eqsbs_ion(isb)
        end do
      
        do isb = 1,nsb_surf
          eqsb_surf(isb,:) = eqsbs_surf(isb)
        end do

!c  intra-aqueous kinetic reactions

        do iaq = 1,naq
          eqaq(iaq,:) = eqaqs(iaq)
          ratecaq(iaq,:) = ratecaqs(iaq)
        end do 
      
!c  temperature correction for debye-huckel, equilibrium and 
!c  rate constants - constant non-standard temperature

      else
 
        call tcorr(tempk)        

      end if
 
!c  assign temperature field

      if (temp_field) then

!c  open file containing temperature data and read initial
!c  temperature data

        call opntemp

!c  interpolate depth-dependent temperatures on grid 

        call intpolt

!c  constant temperature in entire solution domain

      else

        do ivol = 1,nngl
          tkel(ivol) = tempk
        end do

      end if

!c  debugging information

      info_debug = 0

!c  temperature corrected equilibrium constants
#ifdef DEBUG
      if (info_debug.gt.0) then

        do ix = 1,nx
          write(idbg,"(a,3(1x,e15.4))") namex(ix),dhcx(ix),           &
                eqx(ix,tid),eqxs(ix)
        end do

        do ig = 1,ng
          write(idbg,"(a,3(1x,e15.4))") nameg(ig),dhcg(ig),           &
                eqg(ig,tid),eqgs(ig)
        end do

        do im = 1,nm
          write(idbg,"(a,3(1x,e15.4))") namem(im),dhcm(im),           &
                eqm(im,tid),eqms(im)
        end do

        do imx = 1,nmx
          write(idbg,"(a,3(1x,e15.4))") namemx(imx),dhcmx(imx),       &
                eqmx(imx,tid),eqmxs(imx)
        end do

        do ir = 1,nr
          write(idbg,"(a,3(1x,e15.4))") namer(ir),dhcr(ir),           &
                eqr(ir,tid),eqrs(ir)
        end do

        !do isb = 1,nsb
        !  write(idbg,"(a,3(1x,e15.4))") namesb(isb),dhcsb(isb),      &
        !         eqsb(isb),eqsbs(isb)
        !end do
        
        do isb = 1,nsb_ion
          write(idbg,"(a,3(1x,e15.4))") namesb_ion(isb),              &
                dhcsb_ion(isb),eqsb_ion(isb,tid),eqsbs_ion(isb)
        end do
        
        do isb = 1,nsb_surf
          write(idbg,"(a,3(1x,e15.4))") namesb_surf(isb),             &
                dhcsb_surf(isb),eqsb_surf(isb,tid),eqsbs_surf(isb)
        end do

        do iaq = 1,naq
          write(idbg,"(a,3(1x,e15.4))") nameaq(iaq),dhaq(iaq),        &
                eqaq(iaq,tid), eqaqs(iaq)
        end do

!c  temperature corrected rate constants

        do im = 1,nm
          istart = iamd(im)
          istop = iamd(im+1)-1
          do ireac = istart,istop
            write(idbg,"(a,2(1x,e15.4))") namem(im),                  &
                  rated(ireac,tid), rateds(ireac)
          end do
        end do

        do iaq = 1,naq
          write(idbg,*) ratecaq(iaq,tid), ratecaqs(iaq)
        end do

!c  temperature field

        do ivol = 1,nngl
          write(idbg,*) 'tkel(ivol)  ',tkel(ivol)
        end do
        
        if (info_debug.gt.1) then
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if

      end if
#endif

      return
      end