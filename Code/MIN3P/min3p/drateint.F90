!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/drateint.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine drateint
!c -------------------
!c
!c compute derivative of reaction rates for intra-aqueous kinetic 
!c reactions
!c
!c written by:      Uli Mayer - April 23, 99
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           gammac(ic)         = activity coefficients of components + -
!c                                as species in solution
!c           phim(nm)           = mineral volume fractions            + -
!c           rate               = rate for current intra-aqueous      * +
!c                                kinetic reactions [mol/(l h2o*day)
!c           totc(nc-1)         = total aqueous component             + -
!c                                concentrations
!c
!c           integer*4:
!c           ----------
!c           iaq                = pointer to current intra-aqueous    + -
!c                                kinetic reactions
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           faqi(naq*nc)       = inhibition factors                  + -
!c           faqht(naq*nc)      = half saturation constants T^a       + -
!c           ordaqht(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms T^a
!c           ordaqt(naq*nc)     = order of intra-aqueous kinetic      + -
!c                                reaction with respect to total
!c                                aqueous component concentrations
!c           scalfac_aq(naq)    = scaling factors for intra-aqueous   + -
!c                                kinetic reactions
!c           ratecaq(naq,nthreads) 
!c                              = log of rate constant for intra-     + -
!c                                aqueous kinetic reactions
!c                                (units: liter -  moles - seconds)
!c           cinc(n,nthreads)   = concentrations of species as        + -
!c                                components in solution
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           totcinc(n,nthreads)= total aqueous component             + -
!c                                concentrations
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           xnuaq(naq*nc)      = stoichiometric coefficient of       + -
!c                                components in intra-aqueous
!c                                kinetic reaction
!c
!c           integer*4:
!c           ----------
!c           iaaq(naq+1)        = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           iaaqi(2*naq+1)     = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms)
!c           iaaqht(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyerbolic terms T^a)
!c           iaaqt(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (total aqueous component
!c                                concentrations)
!c           jaaq(naq*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaqi(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms)
!c           jaaqht(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           jaaqt(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (total aqueous component
!c                                concentrations)
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c
!c
!c           character:
!c           ----------
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           rtype_aq(naq)      = reaction type of intra-aqueous      * +
!c                                kinetic reaction
!c                                'monod'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = product of reacting species
!c           prodrcinc          = product of reacting species
!c                                (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           iaqi               = counter
!c           iaqh               = counter
!c           iaqt               = counter
!c           ic                 = counter (components)
!c           im                 = counter (minerals)
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine drateint(rate,totc,c,gammac,phim,drtinc,iaq,scalfacaq)
 
      use parm
      use chem
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
      implicit none
      
      real*8 :: rate, totc, c, gammac, phim, drtinc, scalfacaq
      
      integer :: iaq
      
      integer :: tid, iaqt, iaqht, iaqi, ic, im, info_debug,           &
                 istart2, istop2
      
      real*8 :: prodrc, prodrcinc

      dimension c(*),gammac(*),totc(*),phim(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
 
!c  initialize reaction rate for intra-aqueous reaction

      rate = r0

!c  form product of reactants for current intra-aqueous kinetic 
!c  reaction
 
      prodrc = r1
      prodrcinc = r1

!c  total aqueous component concentrations and pH

      istart2 = iaaqt(iaq)
      istop2 = iaaqt(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqt = istart2,istop2

          ic = jaaqt(iaqt)

          if (namec(ic).ne.'h+1') then
            prodrc = prodrc * totc(ic)**ordaqt(iaqt)
            prodrcinc = prodrcinc * totcinc(ic,tid)**ordaqt(iaqt)
          else
            prodrc = prodrc * c(ic)**ordaqt(iaqt)
            prodrcinc = prodrcinc * cinc(ic,tid)**ordaqt(iaqt)
        end if

        end do

      end if

!c  monod terms

      istart2 = iaaqht(iaq)
      istop2 = iaaqht(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqht = istart2,istop2

          ic = jaaqht(iaqht)

          if (namec(ic).ne.'h+1') then
            prodrc = prodrc                                           &
                  * (totc(ic)/(faqht(iaqht)                           &
                  + totc(ic)))**ordaqht(iaqht) 
            prodrcinc = prodrcinc * (totcinc(ic,tid)/                 &
                      (faqht(iaqht)+totcinc(ic,tid)))**ordaqht(iaqht)
          else
            prodrc = prodrc                                           &
                  * (c(ic)/(faqht(iaqht) + c(ic)))**ordaqht(iaqht) 
            prodrcinc = prodrcinc * (cinc(ic,tid)/                    &
                      (faqht(iaqht)+cinc(ic,tid)))**ordaqht(iaqht)
        end if 

        end do

      end if
 
!c  inhibition terms due to components

      istart2 = iaaqi(2*iaq-1)
      istop2 = iaaqi(2*iaq)-1

      if (istop2.ge.istart2) then

        do iaqi = istart2,istop2

          ic = jaaqi(iaqi)

          if (namec(ic).ne.'h+1') then
            prodrc = prodrc * faqi(iaqi)/(faqi(iaqi)+totc(ic))
            prodrcinc = prodrcinc * faqi(iaqi)/(faqi(iaqi)+           &
                        totcinc(ic,tid))
          else
            prodrc = prodrc                                           &
                  * faqi(iaqi)/(faqi(iaqi)+gammac(ic)*c(ic))
            prodrcinc = prodrcinc                                     &
                     * faqi(iaqi)/(faqi(iaqi)+gammac(ic)*cinc(ic,tid))
          end if

        end do

      end if

!c  inhibition terms due to minerals
!c  Note: This is at the present time not necessary, since phi is not 
!c        considered implicitly, included only for future modifications

      istart2 = iaaqi(2*iaq)
      istop2 = iaaqi(2*iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqi = istart2,istop2

          im = jaaqi(iaqi)

          prodrc = prodrc * faqi(iaqi)/(faqi(iaqi)+phim(im))
          prodrcinc = prodrcinc * faqi(iaqi)/(faqi(iaqi)+phim(im))

        end do

      end if

!c  sum up final reaction rate [moles/(m^3 h2o * day)]
 
      rate = rate - scalfacaq*ratecaq(iaq,tid)                  &
                 * (prodrcinc-prodrc)/drtinc
!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        write(*,'(a)') 'returning from rateint ...'
        write(*,'(a)') trim(nameaq(iaq))
        write(*,'(a,e17.10)') 'rate     ',rate
        write(*,*) '----------------------------------------------'
      end if

      if (info_debug.gt.1) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

      return
      end
