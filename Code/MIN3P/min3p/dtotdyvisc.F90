!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/dtotdyvisc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c  ----------------------------------------------------------------------
!c  subroutine dtotdyvisc
!c  -------------------
!c 
!c  compute derivatives of total aqueous component dynamic viscosity based 
!c  on concentrations of free species and secondary aqueous species
!c 
!c  written by:      Pejman Rasouli - February 24, 2010
!c 
!c  last modified:   
!c 
!c  definition of variables:
!c 
!c  I --> on input   * arbitrary  - initialized  + entries expected
!c  O --> on output  * arbitrary  - unaltered    + altered
!c                                                                     I O
!c  passed:   real*8:
!c            -------
!c            c(nc)              = concentrations of free species      + -
!c                                 - new time level [moles/l water]
!c            cx(nx)             = concentrations of secondary         + -
!c                                 aqueous species
!c                                 - new time level [moles/l water]
!c            drtinc             = increment for numerical             + -
!c                                 differentiation
!c 
!c            integer*4:
!c            ----------
!c            jbl                = pointer to column of block matrix   + -
!c 
!c  chem.f:   real*8:
!c            -------
!c            cxinc(nx,nthreads) = secondary aqueous species           + -
!c                                 concentrations dependent on
!c                                 incremented free species
!c                                 concentrations
!c                                 [moles/l water]
!c            dtotc(n,nthreads)  = derivatives of total aqueous        * +
!c                                 component concentrations
!c                                 [moles/l water]
!c            xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                 for formation of secondary aqueous
!c                                 species from free species
!c 
!c            integer*4:
!c            ----------
!c            iax(nx+1)          = row pointer array to                + -
!c                                 stoichiometric coefficients of
!c                                 free species in
!c                                 secondary aqueous species
!c            jax(nx*nc)         = column pointer array to             + -
!c                                 stoichiometric coefficients of
!c                                 free species in secondary aqueous
!c                                 species
!c            nc                 = number of components                + -
!c            nx                 = number of secondary aqueous         + -
!c                                 species
!c 
!c 
!c  local:    integer*4:
!c            ----------
!c            i                   = counter (stoichiometric
!c                                  coefficients)
!c            ibl                 = counter (components)
!c            ibl2                = counter (components)
!c            istart              = pointer (stoichiometric 
!c                                  coefficients)
!c            istop               = pointer (stoichiometric
!c                                  coefficients)
!c            ix                  = counter (secondary species) 
!c 
!c  external: -
!c  ----------------------------------------------------------------------
  
      subroutine dtotdyvisc(cd,cdx,diff_cof_ic,diff_cof_ix,drtinc)
     
      use parm
      use chem
      use gen
#ifdef OPENMP
      use omp_lib 
#endif
 
      implicit none      
     
      integer :: tid
       
!      external diffcof_mcd
      real*8 :: drtinc
      real*8 :: cd(nc),cdx(nx),diff_cof_ic(nc),diff_cof_ix(nx)
      
      integer :: i, ic, ibl, info_debug, ix, istart, istop
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
      
!c   contributions from free species 
 
      do ibl=1,nc-1
      
        dtotviscnew(ibl,tid) = diff_cof_ic(ibl)*(cinc(ibl,tid) -      &
                               cd(ibl))
        
      end do
 
!c   sum up contributions from aqueous complexes
 
      do ix=1,nx
        istart = iax(ix)
        istop = iax(ix+1)-1
        do i = istart,istop
          ibl = jax(i)

!c   skip h2o, since not a primary unknown
 
          if (namec(ibl).ne.'h2o') then
          
            dtotviscnew(ibl,tid) = dtotviscnew(ibl,tid) +             &
     &                         diff_cof_ix(ix) *                      &
     &                         (xnux(i)*(cxinc(ix,tid)-cdx(ix)))
          
          end if
        end do
      end do
 
!c   form derivative -> divide by increment for numerical
!c   differentiation
 
      do ibl=1,nc-1
      
        dtotviscnew(ibl,tid) = dtotviscnew(ibl,tid)/drtinc
        
      end do
 
!cdbg
#ifdef DEBUG
      info_debug = 0
      if (info_debug.gt.0) then
         do ic=1,nc-1     
             write(idbg,'(a,i4,a,e10.3,/)')                              &
     &          'dtotvisc(',ic,') = ',dtotviscnew(ic,tid)   
         end do
         write(idbg,'(a,e10.3,/)') 'time = ',time
      end if
#endif
!cdbg
 
      return
      end
