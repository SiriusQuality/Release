!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 496 $
!> $Author: fgerard $
!> $Date: 2017-07-19 22:34:11 +0200 (mer., 19 juil. 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/rootwat.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c real*8 function rootwat
!c -----------------------
!c compute root water uptake for current control volume 
!c
!c		    Celine Blitz Frayret (CBF)  from May 9, 2017 - According to the MIN3P-ArchiSimple
!c          and Frédéric Gérard (FG) - dec 2020 in order to prepare the couplinhg with SiriusQuality
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           satwnew            = aqueous phase satutaion             + -
!c                                - new time level
!c
!c           integer*4:
!c           ----------
!c           izn                = pointer to material property zone   + -
!c
!c          
!c common:   
!c phys.f:   real*8:
!c           ------- 
!c           satwlim(nzn)       = water saturation at wilting point   + -
!c           satwfield(nzn)     = water saturation at field capacity  + -
!c           rew0(izn)          = relative extractable water at       + -
!c                                50% of maximum extraction capacity 
!c                                (fitting parameter)
!c           p1(nzn)            = fitting parameter for root water    + -
!c                                uptake function
!c           tree_trans_factor(nzn) = tree transpiration factor       + -
!c
!c
!c local:    rew                = relative extractable water
!c           r0                 = constant
!c           r1                 = constant
!c           r2                 = constant
!c
!c
!c external: -
!c ----------------------------------------------------------------------
 
! CBF : rld read from external file not implemented

      real*8 function rootwat(satwnew,ivol)
 
      use parm
      use phys
      use gen
      use dual
      use biol

      !implicit none CBF !would be great to use implicit none in all F90 files (FG: that was your job...)
      implicit real*8 (a-h,o-z)

      real*8 :: satwnew(*)
      
      integer :: izn
      
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r2 = 2.0d0
      real*8, parameter :: r4 = 4.0d0
      real*8 :: rew, alpha
      
      
    if (rootdensitynill) then !no calculation if no root => 0 returned
        
          rootwat=0.0d0
        
    else !calculations of rootwat
      
      
!    setup pointer to the material properties of the current volume

      izn = mpropvs(ivol)

!   calculate REW	

      rew = dmin1((satwnew(ivol)-satwlim(izn))                              &
     &            /(satwfield(izn)-satwlim(izn)),r1)

!c  calculate reduction factor (Battaglia et al., 1997) : method 1 (local REW, see function)

	if (cmws.eq.1) then

		if (satwnew(ivol).gt.satwlim(izn)) then

!			alpha=rew**r2*dexp(rew*p1(izn))/    &
!    &           	 ((rew0(izn))**r2*dexp((p1(izn))*(rew0(izn)))     & !CBF
!    &           	+ rew**r2*dexp((p1(izn))*rew)) !CBF
            
            alpha = (rew**r2)*dexp(p1*rew)/ & !FG dec 2020 p1 and rew0 must be scalars
     &              (rew0**r2*dexp(p1*rew0) &
     &              + rew**r2*dexp(p1*rew))

		else !CBF

			alpha = r0

		endif !CBF

!c  calculate reduction factor (Battaglia et al., 1997) : method 2 (mean domain scale REW value used instead of local REW, see function)

	elseif (cmws.eq.2) then	! CBF

        alpha = rewm**r2*dexp(p1*rewm)/  & !FG dec 2020 p1 and rew0 must be scalars
     &          (rew0**r2*dexp(p1*rew0)  &
     &         + rewm**r2*dexp(p1*rewm))

!c  no reduction factor

        elseif (cmws.eq.3) then

        	alpha = r1
            
!FG dec 2020 - correction by Feddes type equation (non continuous)
        elseif (cmws.eq.4) then 
            
!c         write(*,*) satwfield(nzn),satwopt(nzn),satwlim(nzn),satwnew(ivol)
!c         write(*,*) h1field(nzn),h1opt(nzn),h1lim(nzn)
!c         write(*,*) abs(uvsnew(ivol))
          if (satwnew(ivol).le.satwlim(izn)) then
           alpha = r0
          elseif (satwnew(ivol).ge.satwfield(izn)) then ! reduction because of soil moisture exceeding field capacity (and soil moisture always lesser or equal to 1)
           a = r0 ! affine function in this case (b = 0)
           a = 1/h1field(nzn)
           alpha = a*abs(uvsnew(ivol)) ! valeur absolue variable primaire eau = la pression de l'eai
                                     ! il faudrait donc ajouter zg(ivol) pour calculer h
          elseif (satwnew(ivol).ge.satwopt(izn)) then
           alpha = r1
         
          elseif (satwnew(ivol).eq.1.0) then  !Mujica 2022
           alpha = 0.0          

          else ! satwnew shall be comprised between sat lim and sat opt => linear reduction
            b = r0
            a = -1/(h1lim(nzn) - h1opt(nzn))
            b = 1-(a*h1opt(nzn))
            alpha = a*abs(uvsnew(ivol))+b    
          endif
          !write(1800,*) ivol, satwnew(ivol), satwlim(izn), satwopt(izn), uvsnew(ivol), alpha  
          
!FG  Dec 2020 - correction according to the s-shaped equation of van genuchten (1987) (continuous)          
        elseif (cmws.eq.5) then 
           alpha = (1+(abs(uvsnew(ivol))/(0.5*(h1opt(nzn)+h1lim(nzn))))**3) & !psi50 (corresponding to alpha = 0.5) not set as additional parameter (formalism dependent)
     &          **-1                                                          !but approached through psilim and psi opt. Note that exponent p = 3 (standard value; see ref in Skaggs et al.) 
            
        endif ! cmws
        
alphafeddes = alpha !Mujica2022

!c  calculate proportion of potential transpiration in each volume

         rsum = r0
!
!FG calculate root volume prop (v_prop) using root length and soil moisture
!
         do i = 1,nn
             
          rsum = rsum + rld(i)*satwnew(i)*cvol(i)
      
         enddo

         v_prop = satwnew(ivol) * rld(ivol) * cvol(ivol)/rsum
         
!         if (rootdensitynill) then ! FG dec 2020 - to avoir NaN in gsp file if no root
!           v_prop=r0
!         endif

!c  calculate maximum transpiration (decrease max transpiration the wet days)
     

        !tmax = pet - pe_soil - canopy_int * canopy_evap_factor
        tmax = tp_sirius
         
        
 

!c  Make sure tmax positif as it can be negative in case of large interception
!c  and low pet. Also depends on the choice of f_i

        if (tmax.lt.0) then

           tmax = r0

        endif

!c  scale maximum transpiration by reduction factor alpha
!c  eventually scaled down to account for growing vegetation
!c  v_prp to determine proportion in current volume

        if (vegetation_growth) then
         
          rootwat = toparea * v_prop * alpha * scale_tree_growth * tmax	&
     &            / cvol(ivol)
       
        else
       
          rootwat = toparea * v_prop  * tmax * alpha / cvol(ivol)

        endif
        
    endif!rootdensitynill or not        

    return

    end
