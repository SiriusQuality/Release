!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/tstepvs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine tstepvs
!c ------------------
!c
!c estimate magnitude of next time step (variably saturated flow)
!c based on the method of Sammon and Forsyth, J. of Computational 
!c Physics, Vol.62, 265-281, 1986
!c
!c written by:      Uli Mayer - July 2, 96
!c
!c last modified:   Uli Mayer - November 27, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           delt               = time step                           + -
!c           delt_vs            = estimated time step                 * +
!c                                (variably saturated flow)
!c           deltmax            = maximum time step                   + -
!c           deltmin            = minimum time step                   + -
!c           saold(nn)          = aqueous phase saturation            + -
!c                                - old time level
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                - new time level
!c           sw_star            = anticipated change in saturation    + -
!c                                per time step
!c           integer*4:
!c           ----------
!c           nn                 = total number of control volumes     + -
!c
!c local:    real*8:
!c           -------
!c           delta_sw           = saturation change
!c           r0                 = constant
!c           rhalf              = constant 
!c           r5                 = constant
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine tstepvs

      use parm
      use gen
#ifdef OPENMP
      use omp_lib 
#endif 

      implicit none
     
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif

      integer :: ivol
      real*8 :: delta_sw
      
#ifdef PETSC
      real*8 :: delta_sw_gbl
      PetscErrorCode :: ierrcode
#endif

      real*8, parameter :: r0=0.0d0,rhalf=0.5d0,r5=5.0d0,rsmall=1.0d-10       

!c  calculate maximum saturation change 

      delta_sw = r0
      
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_tstepvs_1)                      &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)                                              &
    !$omp reduction(max:delta_sw)
    !$omp do schedule(static)
#endif  
      do ivol=1,nngl
!#ifdef PETSC 
!        if(node_idx_lg2l(ivol) < 0) then
!            cycle
!        end if
!#endif
        delta_sw = dmax1(delta_sw,dabs(sanew(ivol)-saold(ivol)))
      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

#ifdef PETSC
      call MPI_Allreduce(delta_sw, delta_sw_gbl,1,MPI_REAL8,           & 
                 MPI_MAX, Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      delta_sw = delta_sw_gbl
#endif

!c  new time step estimate for variably saturated flow

      delt_vs = sw_star/(delta_sw+rsmall)*delt  !first estimate
      delt_vs = dmin1(delt_vs, r5*delt)         !upper bound - max. increase
      delt_vs = dmin1(delt_vs, deltmax)         !upper bound - max. time step
      delt_vs = dmax1(delt_vs, rhalf*delt)      !lower bound - max. decrease
      delt_vs = dmax1(delt_vs, deltmin)         !lower bound - min. time step

      return
      end
