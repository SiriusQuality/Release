!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 491 $
!> $Author: fgerard $
!> $Date: 2017-07-18 00:06:39 +0200 (Tue, 18 Jul 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/inittsgs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine inittsgs
!c -------------------
!c
!c time step control parameters (global system)
!c
!c written by:      Uli Mayer - May 12, 96
!c
!c last modified:   Tom Henderson - January 21, 2003
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           ------- 
!c           delt               = time step                           * +
!c           delt_io            = time step (I/O units)               * +
!c           delt_vs            = estimated time step                 * +
!c                                (variably saturated flow)
!c           delt_rt            = estimated time step                 * +
!c                                (reactive transport)
!c           deltmax            = maximum time step                   * +
!c           deltmin            = minimum time step                   * +
!c           time               = current solution time               * +
!c           time_io            = current solution time (I/O units)   * +
!c           time_factor        = conversion factor from I/O time     * +
!c                                units to internal time units
!c           tfinal             = final solution time                 * +
!c
!c
!c           integer*4:
!c           ----------
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, logbook                + -
!c           itmp               = unit number, temporary storage      + -
!c           l_time_unit        = length of time unit for output      * +
!c
!c           character:
!c           -----------
!c           section_header     = section header                      * +
!c           time_unit          = time unit for I/O -> 'years'        * +
!c                                                     'days'
!c                                                     'hours'
!c                                                     'seconds'
!c dens.f:   real*8:
!c           -------
!c           delt_tds           = lagged time step for tds storage    - + 
!c                                derivative
!c
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c           r24                = constant
!c           r365               = constant
!c           r86400             = constant
!c
!c           integer*4:
!c           ----------
!c           l_string           = length of text string
!c
!c           logical:
!c           --------
!c           found_section      = .true.  -> section header was
!c                                           found in input file
!c       
!c external: readbloc  = read section of input file and write to
!c                       temporary file
!c ----------------------------------------------------------------------
 
      subroutine inittsgs 
 
      use parm
      use gen
      use dens
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      implicit none
      
      integer :: i, l_string

      external readbloc

      logical found_section

      real*8, parameter :: r1 = 1.0d0, r24 = 24.0d0, r365 = 365.0d0,   &
     &           r86400 = 8.64d4

!c  read time step control parameters and write to temporary file   
   
      section_header = 'time step control - global system'
      call readbloc (idat,itmp,section_header,found_section,.true.)
 
!c  define length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if

!c  terminate program if section header not found

      if (.not.found_section) then
        if (rank == 0) then  
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

!c  read time step control parameters

      read(itmp,*,err=999,end=999) time_unit
      l_time_unit = index(time_unit,' ')-1
      if (l_time_unit.eq.-1.or.l_time_unit.gt.12) then
        l_time_unit = 12
      end if
      if (time_unit.ne.'years'.and.           &
     &    time_unit.ne.'days'.and.            &
     &    time_unit.ne.'hours'.and.           &
     &    time_unit.ne.'seconds') then
        if (rank == 0 .and. b_enable_output) then  
          write(ilog,*)'-------------------------------------------'
          write(ilog,*)'   terminated in inittsgs                  '
          write(ilog,*)'   no provision for specified time unit    '
          write(ilog,*)'   bye now ...                             '
          write(ilog,*)'-------------------------------------------'
          if (b_enable_output_gen) then
            write(igen,*)'-------------------------------------------'
            write(igen,*)'   terminated in inittsgs                  '
            write(igen,*)'   no provision for specified time unit    '
            write(igen,*)'   bye now ...                             '
            write(igen,*)'-------------------------------------------'
          end if
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
      read(itmp,*,err=999,end=999) time
      read(itmp,*,err=999,end=999) tfinal
      read(itmp,*,err=999,end=999) deltmax
      read(itmp,*,err=999,end=999) deltmin

!c  compute time factor for conversion between internal and I/O time
!c  units

      if (time_unit.eq.'years') then
        time_factor = r365
      elseif (time_unit.eq.'days') then
        time_factor = r1
      elseif (time_unit.eq.'hours') then
        time_factor = r1/r24
      elseif (time_unit.eq.'seconds') then
        time_factor = r1/r86400
      end if

!c  write time step control parameters to generic output file
      if (b_enable_output .and. b_enable_output_gen) then
        write(igen,'(/72a)')('-',i=1,72)
        write(igen,'(a)') section_header(:l_string)
        write(igen,'(72a/)')('-',i=1,72)
        
        write(igen,'(a,1pe10.3,1x,a)')                          &
     &  'start time of simulation                        = ',   &
     &   time,time_unit
        write(igen,'(a,1pe10.3,1x,a)')                          &
     &  'initial time step                               = ',   &
     &   deltmin,time_unit
        write(igen,'(a,1pe10.3,1x,a)')                          &
     &  'max. time step                                  = ',   &
     &   deltmax,time_unit
        write(igen,'(a,1pe10.3,1x,a)')                          &
     &  'min. time step                                  = ',   &
     &  deltmin,time_unit
      end if

!c  save current time in i/o units

      time_io = time

!c  conversion of time units for computation in days

      time = time_factor * time
      tfinal = time_factor * tfinal
      deltmax = time_factor * deltmax
      deltmin = time_factor * deltmin

!c set initial time step size to minimum time step specified
      if (.not.restart_sim .or. .not. b_max_restart_timestep) then
        delt = deltmin                   !set initial time step
        delt_vs = deltmin                !- variably saturated flow
        delt_rt = deltmin                !- reactive transport
        delt_tds = deltmin               !- density-dependent flow
      else
        delt = deltmax                   !set initial time step
        delt_vs = deltmax                !- variably saturated flow
        delt_rt = deltmax                !- reactive transport
        delt_tds = deltmax 
      end if

      goto 1000

999   continue
      if (rank == 0) then
        write(ilog,*) 'error reading input file'
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end
