!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/iajavs_energybal.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine iajavs_energybal
!c --------------------
!c
!c set up ia-ja data-structure for variably saturated flow - 
!c secondary porosity, by duplicationg existing ia-ja structure 
!c      
!c                z
!c                     y
!c                7  
!c                |  5                  local connection list 
!c                | /                   for ja pointer array
!c                |/                    
!c       2--------1----------3  x     
!c               /|
!c              / |
!c             4  |
!c                6
!c
!c nonexistent connections (1D-2D-boundary effects) are skipped:
!c
!c      z
!c            
!c      4                     e.g.
!c      |                     x-z plane - on boundary x=0
!c      |                     
!c      |                     
!c      1----------2  x     
!c      |
!c      |
!c      |
!c      3
!c
!c written by:      Uli Mayer - July 7, 02 
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c
!c gen.f:    integer*4:
!c           ---------- 
!c           idbg               = unit number, debugging file         + -
!c           ilog               = unit number, logbook                + -
!c           nn                 = total number of control volumes     + -
!c           iavs(nn+1)         = row pointer array for avs           * +
!c           javs(njavs)        = connectivity list                   * +
!c           isymvs(njavs)      = symmetry pointer array              * +
!c           njavs              = number of global connections        * +
!c
!c local:    idebug             = key for activation of debug output  
!c           irow               = counter (rows)
!c           i1                 = counter (column entries in row)
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine iajavs_energybal
 
      use parm
      use gen
#ifdef OPENMP
      use omp_lib 
#endif 

      implicit none
      
      integer :: i, ivol, iterm, istart, iend, isym, jvol
      
      integer, parameter :: i0=0
     
      
      njaglob = njavs*4 
      
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp parallel
    !$omp sections
#endif
#endif

#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif 
      allocate (iaglob(2*nngl+1))
      iaglob = i0
#ifdef PETSC      
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif 
      allocate (row_idx_l2pg_glob(2*nngl+1))
      row_idx_l2pg_glob = i0
#endif      
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif 
      allocate (jaglob(njaglob))
      jaglob = i0
#ifdef PETSC
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif 
      allocate (col_idx_l2pg_glob(njaglob))
      col_idx_l2pg_glob = i0
#endif
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif 
      allocate (isymglob1(njavs))
      isymglob1 = i0
      
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif 
      allocate (isymglob2(njavs))
      isymglob2 = i0
      
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif 
      allocate (isymglob3(njavs))
      isymglob3 = i0
      
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif 
      allocate (isymglob4(njavs))
      isymglob4 = i0 
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp end sections
    !$omp end parallel
#endif
#endif
      
       
      iterm=i0 
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_iajavs_ener_1)                  &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (i, iend, istart, iterm, ivol, jvol, isym)
#endif

#ifdef OPENMP
    !$omp do schedule(static)
#endif      
      do ivol = 1,nngl

       istart=iavs(ivol)
       iend=iavs(ivol+1)-1

#ifdef OPENMP
       iterm = 2*(iavs(ivol)-1)
#endif

       if (ivol==1) then
         iaglob(ivol)=1
         iaglob(nngl+ivol)=2*njavs+ivol
   !      else if (ivol==nngl+1) then
   !      iaglob(nngl+ivol)=iavs(ivol)+3*njavs
       else 
         iaglob(ivol)=2*iavs(ivol)-1
         iaglob(nngl+ivol)=2*iavs(ivol)-1 + 2*njavs 
       end if  
       
#ifdef PETSC
       row_idx_l2pg_glob(ivol) = 2*(node_idx_lg2pg(ivol))-1       
       row_idx_l2pg_glob(nngl+ivol) = row_idx_l2pg_glob(ivol) + 1
!#ifdef DEBUG
!       write(idbg,'(2(a,1x,i,1x))') "ivol",ivol,"row_idx_l2pg_glob",row_idx_l2pg_glob(ivol)
!#endif       
       if(node_idx_lg2l(ivol) < 0) then
           row_idx_l2pg_glob(ivol) = - row_idx_l2pg_glob(ivol)
           row_idx_l2pg_glob(nngl+ivol) = - row_idx_l2pg_glob(nngl+ivol)
       end if
#endif
     
      ! for the first cuadrant
        do i=istart,iend       

          iterm = iterm + 1
     
          jvol = javs(i)       
           
          jaglob(iterm) = jvol 
          
          isym = isymvs(i)   
          
          isymglob1(isym)=iterm
          
#ifdef PETSC
          col_idx_l2pg_glob(iterm) = 2*(node_idx_lg2pg(jvol))-1
#endif
         
        end do
        ! for the second cuadrant 
        do i=istart,iend        

          iterm=iterm+1
          
          jvol = javs(i)        
          
          jaglob(iterm)=jvol+nngl
          
          isym = isymvs(i)   
          
          isymglob2(isym)=iterm
          
#ifdef PETSC
          col_idx_l2pg_glob(iterm) = 2*(node_idx_lg2pg(jvol))
#endif
         
        end do 
        
      end do 
#ifdef OPENMP
    !$omp end do
#endif
    
#ifdef OPENMP
    !$omp single
#endif
      iaglob(2*nngl+1)=iavs(nngl+1)+3*njavs
#ifdef OPENMP
    !$omp end single
#endif      
     
#ifdef OPENMP
    !$omp do schedule(static)
#endif 
      do ivol=1,nngl
        
        istart=iavs(ivol)
        iend=iavs(ivol+1)-1
        
#ifdef OPENMP
       iterm = 2*(iavs(nngl+1) + iavs(ivol) - 2)
#endif

        ! for the third cuadrant
        do i=istart,iend        

          iterm=iterm+1
          
          jvol = javs(i)        
          
          jaglob(iterm)=jvol+nngl
          
          isym = isymvs(i)   
          
          isymglob3(isym)=iterm  
          
#ifdef PETSC
          col_idx_l2pg_glob(iterm) = 2*(node_idx_lg2pg(jvol))
#endif
         
        end do
        ! for the forth cuadrant 
        do i=istart,iend        

          iterm=iterm+1
          
          jvol = javs(i)     
          
          jaglob(iterm)=jvol
          
          isym = isymvs(i)   
          
          isymglob4(isym)=iterm 
          
#ifdef PETSC
          col_idx_l2pg_glob(iterm) = 2*(node_idx_lg2pg(jvol))-1
#endif

        end do
      
      end do    
#ifdef OPENMP
    !$omp end do
#endif    
    
#ifdef OPENMP
    !$omp end parallel
#endif
      


      return
      end
