!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 501 $
!> $Author: fgerard $
!> $Date: 2017-07-20 05:48:48 +0200 (jeu., 20 juil. 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/opnpgfls.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine opnpgfls
!c -------------------
!c
!c modified for density dependent flow
!c
!c open postprocessing files for transient data (global system)
!c assign unit numbers for postprocessing files
!c
!c written by:      Uli Mayer - May 7, 96
!c
!c last modified:   Tom Henderson - March 11, 2004
!c                  increased output locations to 999
!c
!c                  Tom Henderson - October 24, 2002
!c                  Sergi Molins - May 2, 2006
!c                  added files for gas variables
!c                  Sergi Molins - June 7, 2006
!c                  open unit igsw (water production)
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           dimcv(3,nn)        = dimensions of control volumes       + -
!c           elevmax            = max. elevation of solution domain   + -
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           ifls               = unit number - file information      + -
!c           igb_start          = starting pointer for unit numbers   + - 
!c                                for transient data
!c           igsp               = unit number, flow variables         * +
!c           igst               = unit number, total aqueous          * +
!c                                             component
!c                                             concentrations
!c                                             - contour data
!c           igsb               = unit number, sorbed species         * +
!c                                             concentrations
!c                                             - contour data
!c           igsc               = unit number, free species and       * +
!c                                             secondary aqueous
!c                                             species concentrations
!c                                             - contour data
!c           igsd               = unit number, reaction rates of      * +
!c                                             dissolution-
!c                                             precipitation
!c                                             reactions
!c                                             - contour data
!c           igsg               = unit number, gas concentrations     * +
!c                                             - contour data
!c           igsgr              = unit number, rates of degassing     * +
!c                                             - contour data
!c           igsi               = unit number, rates of intra-aqueous * +
!c                                             kinetic reactions
!c                                             - contour data
!c           igsm               = unit number, master variables       * +
!c                                             - contour data
!c           igss               = unit number, saturation indices     * +
!c                                             - contour data
!c           igsv               = unit number, mineral volume         * +
!c                                             fractions
!c                                             - contour data
!c           igsx               = unit number, saturation indices     * +
!c                                             excluded minerals
!c                                             - contour data
!c           igbt               = unit number, total aqueous          * +
!c                                             component
!c                                             concentrations
!c                                             - transient data
!c                                               global system
!c           igbb               = unit number, concentrations of      * +
!c                                             sorbed species
!c                                             - transient data
!c                                               global system
!c           igbc               = unit number, free species and       * +
!c                                             secondary aqueous
!c                                             species concentrations
!c                                             - transient data
!c                                               global system
!c           igbd               = unit number, dissolution-           * +
!c                                             precipitation
!c                                             rates
!c                                             - transient data
!c                                               global system
!c           igbg               = unit number, gas concentrations     * +
!c                                             - transient data
!c                                                global system
!c           igbgr              = unit number, degassing rates        * +
!c                                             - transient data
!c                                                global system
!c           igbm               = unit number, master variables       * +
!c                                             - transient data
!c                                               global system
!c           igbi               = unit number, rates of intra-aqueous * +
!c                                             kinetic reactions
!c                                             - transient data
!c                                               global system
!c           igbp               = unit number, flow variables         * +
!c                                             - transient data
!c                                               global system
!c           igbs               = unit number, saturation indices     * +
!c                                             - transient data
!c                                               global system
!c           igbv               = unit number, mineral volume         * +
!c                                             fractions
!c                                             - transient data
!c                                               global system
!c           igbx               = unit number, saturation indices     * +
!c                                             excluded minerals
!c                                             - transient data
!c                                               global system
!c           icnv               = unit number, data conversion        + -
!c           ivel               = unit number, average interfacial    * +
!c                                             velocities
!c           l_prfx             = length of prefix of I/O files       + -
!c           ngb                = number of output locations for      + - 
!c                                transient data
!c           ngb_vol(ngb)       = control volume numbers for output   + -
!c                                of transient data
!c added for gas transport;
!c
!c           igs2               = unit number, gas molar fractions    * +
!c                                             - contour data
!c	         igsa_first         = unit number, gas fluxes             * +
!c                                                - contour data
!c	         igsr               = unit number, gas density            * +
!c                                                - contour data 
!c	         igsy               = unit number, gas viscosity          * +
!c                                                - contour data 
!c	         igsf_first         = unit number, gas diffusion coeff    * +
!c                                             - contour data 
!c added
!c           igsw               = unit number, water prod/consumption * +
!c                                             - contour data
!c
!c           logical:
!c           --------
!c           depth_output       = .true.  -> output in terms of       + -
!c                                           depth instead of
!c                                           elevation
!c           extended_output    = .true.  -> extended output of       + -
!c                                           contour data for
!c                                           reaction-transport
!c                                           simulation
!c                                .false. -> basic output of
!c                                           contour data for
!c                                           for reaction-transport
!c                                           simulation
!c           fully_saturated    = .true.  -> saturated conditions     + - 
!c           gb_output          = .true.  -> output of transient data + -
!c           gs_output          = .true.  -> output of contour data   + -
!c           reactive_transport = .true.  -> perform reactive         + -
!c                                           transport simulation     + -
!c           transient_flow     = .true.  -> .not.steady_flow,        + -
!c                                        -> transient flow
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated 
!c                                           conditions
!c           varsat_flow        = .true.  -> perform flow simulation  + -
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           time_unit          = time unit for output -> 'years'     + -
!c                                                        'days'
!c           
!c
!c chem.f:   integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           iamd(nm+1)         = pointer array to dissolution-       + -
!c                                precipitation reactions
!c           nanc               = number of sorbed species            + -
!c                                non-competitive sorption
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c           nx                 = number of aqueous complexes         + -
!c
!c           logical:
!c           --------
!c           gas_removal        = .true.  -> degassing of dissolved   + -
!c                                           gases, if confining
!c                                           pressure exceeded
!c           noncompetitive_sorption = logical array for activation   + -   
!c                                     of noncompetitive sorption
!c                                     reactions
!c           ph_output          = .true.  -> output of pH             + -
!c           pe_output          = .true.  -> output of pe and Eh      + -
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c           character:
!c           ----------
!c           isotherm_type(nc)  = definition of sorption isotherm     + -    
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namex(nx)          = names of secondary aqueous species  + -
!c           namem(nm)          = mineral names                       + -
!c           namemx(nmx)        = names of excluded minerals          + -
!c           namemp(ndr*nm)     = names for parallel                  + -
!c                                dissolution-precipitation reactions
!c           namer(nr)          = names of redox couples              + -
!c           namesb(nsb)        = names of sorbed species             + -
!c           namesb_ion(nsb_ion)= names of sorbed species             + -
!c                                (ion-exchange)
!c           namesb_surf(nsb_surf)= names of sorbed species           + -
!c                                  (surface-complex)
!c           output_unit_sb     = output unit for surface species     + -
!c           output_unit_sb_ion = output unit for sorption            + -
!c                                reactions of ion-exchange
!c           output_unit_sb_surf= output unit for sorption            + -
!c                                reactions of surface-complex
!c
!c dens.f:   logical:
!c           --------
!c          density_dependence = .true.  -> density-dependent flow   + -
!c
!c local:    real*8:
!c           -------
!c           zout               = output for z-coordinate in terms
!c                                depth or elevation
!c
!c           integer*4:
!c           ----------
!c           ianc               = counter (non-competitive
!c                                         sorption reactions)
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           ic                 = counter (components)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imx                = counter (excluded minerals)
!c           ir                 = counter (redox couples)
!c           isites             = counter (surafce sites)
!c           isb                = counter (sorbed species)
!c           ix                 = counter (aqueous complexes)
!c           igb                = counter (output locations)
!c           ireac              = counter
!c           istart             = pointer
!c           istop              = pointer
!c           l_sufx             = length of file suffix
!c
!c           character:
!c           ----------
!c           suffix             = file suffix
!c
!c external: tranunit  = assign unit numbers for output of transient 
!c                       data
!c           zoutput   = assign depth coordinate in terms of depth
!c                       or elevation
!c ----------------------------------------------------------------------

      subroutine opnpgfls

      use parm
      use gen
      use chem
      use dens
      use writeversion
      
      use module_binary_mpiio, only : binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close
      use file_unit, only : lun_get, lun_set
      implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif
      
      integer :: i, ianc, ic, ig, iaq, im, ir, ix, ivol, igsi_igsb,    &
                 igb, imx, ireac, istart, istop, isites, isb, l_sufx,  &
                 i1, ic1, ic2, icount
      
      real*8 :: zout, zoutput

      external tranunit, zoutput, trans_evap_info

      character*3 suffix
      
      integer :: nvarsigbp
      
      character*2048 strbuffer
      character*72:: tec_variables(100)

!c     write(*,'(/a)') 'enter routine opnpgfls ...'

!c  contour data
!c -----------------------------------------------------------------------   

      if (gs_output) then

!c  unit number for density componnets
        if (issplitdens) then 
          !idens = 75
          idens = lun_get()
        end if

!c  unit numbers for variably saturated flow

        if (varsat_flow) then
          !igsp  = 60
          !ivel  = 61
          igsp = lun_get()
          ivel = lun_get()
        end if

!c  unit numbers for reactive transport

        if (reactive_transport) then
          !igst = 62
          igst = lun_get()
          if(multi_diff)then
            !icbt = 82
            icbt = lun_get()  
          end if
          
          if(flux_out)then
            !igmf = 92
            igmf = lun_get()
          end if
          
          if (extended_output) then
            !igsc = 63
            !igsm = 64
            igsc = lun_get()
            igsm = lun_get()
            if (ng.gt.0) then
              !igsg = 65
              !igs2 = 265        !adv              
              !igsr = 266        !adv
              !igsy = 267        !adv
              !igsw = 268        !water
              !igsa_first = 300  !adv
              igsg = lun_get()
              igs2 = lun_get()        !adv              
              igsr = lun_get()        !adv
              igsy = lun_get()        !adv
              igsw = lun_get()        !water
              igsa_first = lun_get()  !adv
              do i = 1, n
                call lun_set(igsa_first+i)  
              end do
              igsf_first = lun_get()  !adv
              do i = 1, n
                call lun_set(igsf_first+i)  
              end do
            end if
            if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.noncompetitive_sorption) then
              !igsb = 66
              igsb = lun_get()
              
              !cprovi--------------------------------------------
              !cprovi In this unit is written the total 
              !cprovi concentrations in the aqueous and sorbed
              !cprovi phases
              !cprovi--------------------------------------------
              
              !igsi_igsb = 73
              igsi_igsb = lun_get()
            end if
            if (nm.gt.0) then
              !igss = 67
              !igsd = 68
              !igsv = 69
              igss = lun_get()
              igsd = lun_get()
              igsv = lun_get()
            end if
            if (naq.gt.0.or.nr.gt.0) then
              !igsi = 70
              igsi = lun_get()
            end if
            if (nmx.gt.0) then
              !igsx = 71
              igsx = lun_get()
            end if
            if (gas_removal.and.ng.gt.0) then
              !igsgr = 72
              igsgr = lun_get()
            end if
            if (iso_output) then
              !igsis = 73
              igsis = lun_get()
            end if
          end if                           !(extended_output)
          
          if (ng.gt.0 .and. gas_advection) then
            igsk = lun_get()
          end if
          
          if (update_permeability) then 
            !ihycx = 170     !global file unit number?
            ihycx = lun_get()
          end if
          
        end if                             !(reactive_transport)

      end if                               !(gs_output)

!c  transient data
!c -----------------------------------------------------------------------   

      if (gb_output .and. b_enable_output) then

!c  write header for transient data to file information file

        if (rank == 0) then

          write(ifls,'(//72a/a/72a)')                   &
     &         ('*',i=1,72),                            &
     &         'transient data - global system',        &
     &         ('*',i=1,72) 
        
        end if

        !igb_start = 200
        igb_start = lun_get()
 
        do igb = 1,ngb        !loop over output locations

          ivol = ngb_vol(igb)   !local volume number
          
          if (ivol < 0) then        !control volume in the current domain
            cycle 
          end if    !End control volume in the current domain
        
!c  assign depth coordinate in terms of depth or elevation
!c
!c  for domain decomposition method, ivol = -1 indicates that 
!c  this volume is not in the current sub-domain, skip it.
          zout = zoutput(depth_output,zg(ivol),elevmax)

!c  assign file suffixes
!c  maximum of 999 locations

          !rewind(icnv)            !Deprecated, use internal convert instead. DSU
          if(igb.lt.10) then
            !write(icnv,'(i1)') igb 
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i1)') igb
            l_sufx = 1
          elseif ((igb.ge.10).and.(igb.lt.100)) then
            !write(icnv,'(i2)') igb 
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i2)') igb
            l_sufx = 2
          else
            !write(icnv,'(i3)') igb 
            !rewind(icnv)
            !read(icnv,'(a3)') suffix
            write(suffix,'(i3)') igb
            l_sufx = 3
          end if

!c  assign unit numbers for output of transient data

          call tranunit(igb)
          
!c  open files for transient data and write information
!c  to file information file

!c  ---------------------------------------------------------------
!c  variably saturated flow

!c  open file

          if (transient_flow) then

            if (b_output_binary) then
#ifndef MPI
              if (igbp_mpi(igb) < 10) then
                igbp_mpi(igb) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           igbp_mpi(igb), prefix(:l_prfx)//'_'//       &
                           suffix(:l_sufx)//'.gbp', .true.)
            else
              open(igbp,file=prefix(:l_prfx)//'_'//                    &
                             suffix(:l_sufx)//'.gbp',status='unknown', &
                        form='formatted')
            end if
!c  write file information
            if (rank == 0 .and. b_enable_output) then 

            write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                   & 
     &            'Flow variables, ',                                 &
     &            'x = ',xg(ivol),' m',                               &
     &            'y = ',yg(ivol),' m',                               &
     &            'z = ',zout,' m',                                   &
     &            ('-',i=1,72)
     
                                                                       
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                &
     &                          suffix(:l_sufx)//'.gbp'
                                                                       
            write(ifls,'(2a)')                                        &
     &           'column   entry                          ','unit'     
            write(ifls,'(2a)')                                        &
     &            '1        time                           ',time_unit 
            write(ifls,'(2a)')                                        &
     &            '2        hydraulic head                  ','m'      
            write(ifls,'(2a)')                                        &
     &            '3        pressure head                   ','m'      
            write(ifls,'(2a)')                                        &
     &            '4        water saturation                ','-'      
            write(ifls,'(2a)')                                        &
     &            '5        water content                   ','-'      
            if (variably_saturated) then                               
              write(ifls,'(2a)')                                      &
     &              '6        air saturation                  ','-'    
              write(ifls,'(2a)')                                      &
     &              '7        air content                     ','-'    
              write(ifls,'(2a)')                                      &
     &              '8        root water uptake               ','m^3/d'
            end if
            
            end if

!c  title and variables

!c  version information
            if (b_writeversion_tecplot.and..not.b_output_binary) then
                call writeversion2file(igbp, "#")
            end if
        
            if (b_output_binary) then
              offset_igbp(igb) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           igbp_mpi(igb), "#!TDV102",'dataset '//      &
                           prefix(:l_prfx),offset_igbp(igb),.true.,    &
                           .true.)              
            else
              write(igbp,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            end if
            
            if (b_output_binary) then
                
              if (density_dependence) then
                  
              if (fully_saturated) then

                nvarsigbp = 7
                tec_variables(1:7)= [character(len=72) ::              &
                                    "time","fh_w","p_w","ph_w",        &
                                    "rho_w","s_w","theta_a"]
                                                                       
              elseif (variably_saturated) then                         
                if (evaporation) then 
                  nvarsigbp = 14  
                  tec_variables(1:14)= [character(len=72) ::           &
                                      "time","fh_w","p_w","ph_w",      &
                                      "rho_w","s_w","theta_a","s_a",   &
                                      "theta_g","q_root","temp",       &     
                                      "rho_v","actw","pv"]
                else 
                  nvarsigbp = 10  
                  tec_variables(1:10)= [character(len=72) ::           &
                                      "time","fh_w","p_w","ph_w",      &
                                      "rho_w","s_w","theta_a","s_a",   &
                                      "theta_g","q_root"]
                end if
              end if
            else
              if (fully_saturated) then
                nvarsigbp = 5  
                tec_variables(1:5)= [character(len=72) ::              &
                                    "time","h_w","p_w","s_w", "theta_a"]
                                                                       
              elseif (variably_saturated) then
                nvarsigbp = 8  
                tec_variables(1:8)= [character(len=72) ::              &
                                      "time","h_w","p_w","s_w",        &
                                      "theta_a","s_a","theta_g",       &
                                      "q_root"]
              end if
            end if !density_dependence
            
            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         igbp_mpi(igb), nvarsigbp,                     &
                         tec_variables(1:nvarsigbp), offset_igbp(igb), &
                         .true.,.true.) 
            
            else
                
            if (density_dependence) then
              if (fully_saturated) then

                write(igbp,'(20a)') 'variables = "time",',            &
     &                              ' "fh_w",',                       &
     &                              ' "p_w",',                        &
     &                              ' "ph_w",',                       &
     &                              ' "rho_w",',                      &
     &                              ' "s_w",',                        &
     &                              ' "theta_a"'
                                                                       
              elseif (variably_saturated) then                         
                if (evaporation) then                                  
                  write(igbp,'(20a)') 'variables = "time",',          &
     &                              ' "fh_w",',                       &
     &                              ' "p_w",',                        &
     &                              ' "ph_w",',                       &
     &                              ' "rho_w",',                      &
     &                              ' "s_w",',                        &
     &                              ' "theta_a",',                    &
     &                              ' "s_a",',                        &
     &                              ' "theta_g",',                    &
     &                              ' "q_root",',                     &
     &                              ' "temp",',                       &
     &                              ' "rho_v",',                      &
     &                              ' "actw",',                       &
     &                              ' "pv"'                            
                else                                                   
                   write(igbp,'(20a)') 'variables = "time",',         &
     &                              ' "fh_w",',                       &
     &                              ' "p_w",',                        &
     &                              ' "ph_w",',                       &
     &                              ' "rho_w",',                      &
     &                              ' "s_w",',                        &
     &                              ' "theta_a",',                    &
     &                              ' "s_a",',                        &
     &                              ' "theta_g",',                    &
     &                              ' "q_root"' 
                end if
              end if
            else
              if (fully_saturated) then

                write(igbp,'(20a)') 'variables = "time",',            &
     &                              ' "h_w",',                        &
     &                              ' "p_w",',                        &
     &                              ' "s_w",',                        &
     &                              ' "theta_a"'
                                                                       
              elseif (variably_saturated) then
                                                                       
                write(igbp,'(20a)') 'variables = "time",',            &
     &                              ' "h_w",',                        &
     &                              ' "p_w",',                        &
     &                              ' "s_w",',                        &
     &                              ' "theta_a",',                    &
     &                              ' "s_a",',                        &
     &                              ' "theta_g",',                    &
     &                              ' "transp(m3/s)",',               &
     &                              ' "evap (m3/s)",',                &!FG evap       
     &                              ' "alpha (-)"'                     !Mujica 2022

              end if
            end if !density_dependence
          
          end if !b_output_binary

!c  zone record for fully saturated or variably saturated conditions
          if (b_output_binary) then 
#ifdef PETSC
            write(strbuffer,'(2(a,i5,1x),3(a,1pe9.2))')                &
                  'Flow variables, local volume = ',ivol,              &
                  ', global volume = ', node_idx_lg2g(ivol),           &       
                  ', delx = ',dimcv(1,ivol),                           &
                  ', dely = ',dimcv(2,ivol),                           &
                  ', delz = ',dimcv(3,ivol)
#else
            write(strbuffer,'(a,i5,3(a,1pe9.2))')                      &
     &            'Flow variables, volume = ',ivol,                    &
     &            ', delx = ',dimcv(1,ivol),                           &
     &            ', dely = ',dimcv(2,ivol),                           &
     &            ', delz = ',dimcv(3,ivol)
#endif
            !c the number of values (here 1) is just for temporary output
            !c that should be output in every time step as this value is
            !c not predicitable
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,        &
                         igbp_mpi(igb),trim(strbuffer),                &
                         offset_igbp(igb), 1, 1, 1, .true.,.true.,     &
                         b_output_multizone)
            offset_igbp_ijk(igb) = offset_igbp(igb) - 5*4

          else
#ifdef PETSC
            write(igbp,'(2(a,i5,1x),3(a,1pe9.2),a)')                   &
     &            'zone t = "Flow variables, local volume = ',ivol,    &
     &            ', global volume = ', node_idx_lg2g(ivol),           &       
     &            ', delx = ',dimcv(1,ivol),                           &
     &            ', dely = ',dimcv(2,ivol),                           &
     &            ', delz = ',dimcv(3,ivol),                           &
     &            '", f=point'
#else
            write(igbp,'(a,i5,3(a,1pe9.2),a)')                         &
     &            'zone t = "Flow variables, volume = ',ivol,          &
     &            ', delx = ',dimcv(1,ivol),                           &
     &            ', dely = ',dimcv(2,ivol),                           &
     &            ', delz = ',dimcv(3,ivol),                           &
     &            '", f=point'
#endif
          end if
          
!c  write tecplot zone section information for binary output
          if (b_output_binary) then
            call tecplot_binary_write_section(PETSC_COMM_SELF,         &
                         igbp_mpi(igb),nvarsigbp,0,offset_igbp(igb),   &
                         .true.,.true.,b_output_multizone) 
          end if
          
          end if
          
!c  ---------------------------------------------------------------
!c  reactive transport

!c  total aqueous component concentrations

!c  open file

          if (reactive_transport) then

            if (b_output_binary) then
#ifndef MPI
              if (igbt_mpi(igb) < 10) then
                igbt_mpi(igb) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           igbt_mpi(igb), prefix(:l_prfx)//'_'//       &
                           suffix(:l_sufx)//'.gbt', .true.)
            else
              open(igbt,file=prefix(:l_prfx)//'_'//                    &
                   suffix(:l_sufx)//'.gbt',status='unknown',           &
                   form='formatted')
            end if

!c  write file information

            if (rank == 0 .and. b_enable_output) then

            write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                   &
     &            'Total aqueous component concentrations, ',         &
     &            'x = ',xg(ivol),' m',                               &
     &            'y = ',yg(ivol),' m',                               &
     &            'z = ',zout,' m',                                   &
     &            ('-',i=1,72)
                                                                       
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                &
     &                          suffix(:l_sufx)//'.gbt'
                                                                       
            write(ifls,'(2a)')                                        &
     &          'column   entry                           ','unit'     
            write(ifls,'(2a)')                                        &
     &          '1        time                            ',time_unit  
            do     ic = 1,nc-1                                         
              if (ic.lt.9) then                                        
                write(ifls,'(i1,8x,a,20x,a)') ic+1,namec(ic),         &
     &                                       'moles/l h2o'             
              else                                                     
                write(ifls,'(i2,7x,a,20x,a)') ic+1,namec(ic),         &
     &                                        'moles/l h2o'
              end if
            end do
            
            end if

!c  aqueous species concentrations

!c  open file

            if (b_output_binary) then
#ifndef MPI
              if (igbc_mpi(igb) < 10) then
                igbc_mpi(igb) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           igbc_mpi(igb), prefix(:l_prfx)//'_'//       &
                           suffix(:l_sufx)//'.gbc', .true.)
            else
              open(igbc,file=prefix(:l_prfx)//'_'//                    &
                   suffix(:l_sufx)//'.gbc',status='unknown',           &
                   form='formatted')
            end if

!c  write file information

            if (rank == 0 .and. b_enable_output) then

            write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                   &
     &            'Species concentrations, ',                         &
     &            'x = ',xg(ivol),' m',                               &
     &            'y = ',yg(ivol),' m',                               &
     &            'z = ',zout,' m',                                   &
     &            ('-',i=1,72)
                                                                       
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                &
     &                          suffix(:l_sufx)//'.gbc'
                                                                       
            write(ifls,'(2a)')                                        &
     &          'column   entry                           ','unit'     
            write(ifls,'(2a)')                                        &
     &          '1        time                            ',time_unit  
            do ic = 1,nc-1                                             
              if (ic.lt.9) then                                        
                write(ifls,'(i1,8x,a,20x,a)') ic+1,namec(ic),         &
     &                                       'moles/l h2o'             
              else                                                     
                write(ifls,'(i2,7x,a,20x,a)') ic+1,namec(ic),         &
     &                                       'moles/l h2o'             
              end if                                                   
            end do                                                     
            do ix = 1,nx                                               
              if (ix+nc-1.lt.9) then                                   
                write(ifls,'(i1,8x,a,20x,a)') ix+nc,namex(ix),        &
     &                                        'moles/l h2o'            
              elseif (ix+nc-1.ge.9.and.ix+nc-1.lt.99) then             
                write(ifls,'(i2,7x,a,20x,a)') ix+nc,namex(ix),        &
     &                                        'moles/l h2o'            
              else                                                     
                write(ifls,'(i2,7x,a,20x,a)') ix+nc,namex(ix),        &
     &                                        'moles/l h2o'
              end if
            end do
            
            end if

!c  master variables

!c  open file
            if (b_output_binary) then
#ifndef MPI
              if (igbm_mpi(igb) < 10) then
                igbm_mpi(igb) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           igbm_mpi(igb), prefix(:l_prfx)//'_'//       &
                           suffix(:l_sufx)//'.gbm', .true.)
            else
              open(igbm,file=prefix(:l_prfx)//'_'//                    &
                   suffix(:l_sufx)//'.gbm',status='unknown',           &
                   form='formatted')
            end if

!c  write file information

            if (rank == 0 .and. b_enable_output) then

            write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                     &
     &            'Master variables, ',                                 &
     &            'x = ',xg(ivol),' m',                                 &
     &            'y = ',yg(ivol),' m',                                 &
     &            'z = ',zout,' m',                                     &
     &            ('-',i=1,72)
                                                                         
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                  &
     &                          suffix(:l_sufx)//'.gbm'
                                                                         
            write(ifls,'(2a)')                                          &
     &            'column   entry                           ','unit'     
            write(ifls,'(2a)')                                          &
     &            '1        time                            ',time_unit  
            if ((ph_output).and.(pe_output)) then                        
              write(ifls,'(a,30x,a)')'2        pH','-'                   
              write(ifls,'(a,30x,a)')'3        pe','-'                   
              write(ifls,'(a,30x,a)')'4        Eh','-'                   
              write(ifls,'(a,18x,a)')'5        ionic strength','-'       
              write(ifls,'(a,12x,a)')'6        carbonate alkalinity',   &
     &                               'eq/L'                              
              write(ifls,'(a,8x,a)')'7        non-carbonate alkalinity',&
     &                               'eq/L'                              
              write(ifls,'(a,22x,a)')'8        alkalinity','eq/L'        
              write(ifls,'(a,12x,a)')'9        carbonate alkalinity',   &
     &                               'mg/L CaCO3'                        
              write(ifls,'(a,8x,a)')'10       non-carbonate alkalinity',&
     &                               'mg/L CaCO3'                        
              write(ifls,'(a,22x,a)')'11       alkalinity','mg/L CaCO3'  
              write(ifls,'(a,21x,a)')'12       temperature','C'          
            elseif ((.not.ph_output).and.(pe_output)) then               
              write(ifls,'(a,30x,a)')'2        pe','-'                   
              write(ifls,'(a,30x,a)')'3        Eh','-'                   
              write(ifls,'(a,18x,a)')'4        ionic strength','-'       
              write(ifls,'(a,12x,a)')'5        carbonate alkalinity',   &
     &                               'eq/L'                              
              write(ifls,'(a,8x,a)')'6        non-carbonate alkalinity',&
     &                               'eq/L'                              
              write(ifls,'(a,22x,a)')'7        alkalinity','eq/L'        
              write(ifls,'(a,12x,a)')'8        carbonate alkalinity',   &
     &                               'mg/L CaCO3'                        
              write(ifls,'(a,8x,a)')'9        non-carbonate alkalinity',&
     &                               'mg/L CaCO3'                        
              write(ifls,'(a,22x,a)')'10       alkalinity','mg/L CaCO3'  
              write(ifls,'(a,21x,a)')'11       temperature','C'          
            elseif ((ph_output).and.(.not.pe_output)) then               
              write(ifls,'(a,30x,a)')'2        pH','-'                   
              write(ifls,'(a,18x,a)')'3        ionic strength','-'       
              write(ifls,'(a,12x,a)')'4        carbonate alkalinity',   &
     &                               'eq/L'                              
              write(ifls,'(a,8x,a)')'5        non-carbonate alkalinity',&
     &                               'eq/L'                              
              write(ifls,'(a,22x,a)')'6        alkalinity','eq/L'        
              write(ifls,'(a,12x,a)')'7        carbonate alkalinity',   &
     &                               'mg/L CaCO3'                        
              write(ifls,'(a,8x,a)')'8        non-carbonate alkalinity',&
     &                               'mg/L CaCO3'
              write(ifls,'(a,22x,a)')'9        alkalinity','mg/L CaCO3'
              write(ifls,'(a,21x,a)')'10       temperature','C'
            end if
            
            end if

!c  partial gas pressures

            if (ng.gt.0) then

!c  open file
              if (b_output_binary) then
#ifndef MPI
                if (igbg_mpi(igb) < 10) then
                  igbg_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,         &
                             igbg_mpi(igb), prefix(:l_prfx)//'_'//     &
                             suffix(:l_sufx)//'.gbg', .true.)
              else
                open(igbg,file=prefix(:l_prfx)//'_'//                  &
                               suffix(:l_sufx)//'.gbg',                &
                               status='unknown',                       &
                               form='formatted')
              end if 
!c  write file information

              if (rank == 0 .and. b_enable_output) then

              write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                 &
     &              'Partial gas pressures, ',                        &
     &              'x = ',xg(ivol),' m',                             &
     &              'y = ',yg(ivol),' m',                             &
     &              'z = ',zout,' m',                                 &
     &              ('-',i=1,72)
                                                                       
              write(ifls,'(/a/)') prefix(:l_prfx)//'_'//              &
     &                            suffix(:l_sufx)//'.gbg'
                                                                       
              write(ifls,'(2a)')                                      &
     &           'column   entry                           ','unit'    
              write(ifls,'(2a)')                                      &
     &           '1        time                            ',time_unit 
              do ig = 1,ng                                             
                if (ig.lt.9) then                                      
                  write(ifls,'(i1,8x,a,20x,a)') ig+1,nameg(ig),'atm'   
                else                                                   
                  write(ifls,'(i2,7x,a,20x,a)') ig+1,nameg(ig),'atm'   
                end if                                                 
              end do                                                   
              write(ifls,'(2a)')                                      &
     &              '1+ng+1   total gas pressure              ','atm'
              
              end if

!c  degassing rates

!c  open file

              if (gas_removal) then
                if (b_output_binary) then
#ifndef MPI
              if (igbgr_mpi(igb) < 10) then
                igbgr_mpi(igb) = lun_get()
              end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,       &
                               igbgr_mpi(igb), prefix(:l_prfx)//'_'//  &
                               suffix(:l_sufx)//'.gbgr', .true.)
                else
                  open(igbgr,file=prefix(:l_prfx)//'_'//               &
                             suffix(:l_sufx)//'.gbgr',                 &
                             status='unknown',                         &
                             form='formatted')
                end if
!c  write file information

                if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')               &
     &                'Degassing rates, ',                            &
     &                'x = ',xg(ivol),' m',                           &
     &                'y = ',yg(ivol),' m',                           &
     &                'z = ',zout,' m',                               &
     &                ('-',i=1,72)
                                                                       
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//            &
     &                              suffix(:l_sufx)//'.gbgr'
                                                                       
                write(ifls,'(2a)')                                    &
     &                'column   entry                           ',    &
     &                'unit'                                           
                write(ifls,'(2a)')                                    &
     &                '1        time                            ',    &
     &                 time_unit                                       
                do ig = 1,ng                                           
                  if (ig.lt.9) then                                    
                    write(ifls,'(i1,8x,a,20x,a)') ig+1,nameg(ig),     &
     &                                            'mol L^-1 d^-1'      
                  else                                                 
                    write(ifls,'(i2,7x,a,20x,a)') ig+1,nameg(ig),     &
     &                                            'mol L^-1 d^-1'
                  end if
                end do
                
                end if

              end if              !(gas_removal)      

            end if                !(ng.gt.0)

!c  oxidation-reduction rates

           if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) then

!c  open file
              if (b_output_binary) then
#ifndef MPI
                if (igbi_mpi(igb) < 10) then
                  igbi_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,         &
                             igbi_mpi(igb), prefix(:l_prfx)//'_'//     &
                             suffix(:l_sufx)//'.gbr', .true.)
              else
                open(igbi,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbr',status='unknown',         &
                     form='formatted')
              end if
!c  write file information

              if (rank == 0 .and. b_enable_output) then

              write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                 &
     &              'Oxidation-reduction rates, ',                    &
     &              'x = ',xg(ivol),' m',                             &
     &              'y = ',yg(ivol),' m',                             &
     &              'z = ',zout,' m',                                 &
     &              ('-',i=1,72)
                                                                       
              write(ifls,'(/a/)') prefix(:l_prfx)//'_'//              &
     &                            suffix(:l_sufx)//'.gbr'
                                                                       
              write(ifls,'(2a)')                                      &
     &           'column   entry                           ','unit'    
              write(ifls,'(2a)')                                      &
     &           '1        time                            ',time_unit 
              do ir = 1,nr                                           
                if (ir.lt.9) then                                      
                  write(ifls,'(i1,8x,a,8x,a)') ir+1,namer(ir),        &
     &                                         'moles/l h2o/day'       
                else                                                   
                  write(ifls,'(i2,7x,a,8x,a)') ir+1,namer(ir),        &
     &                                         'moles/l h2o/day'
                end if
              end do
                
              end if  

            end if                !(naq.eq.0.and.(nr.gt.0.....)

!c  rates of intra-aqueous kinetic reactions

            if (naq.gt.0) then

!c  open file
              if (b_output_binary) then
#ifndef MPI
                if (igbi_mpi(igb) < 10) then
                  igbi_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,         &
                             igbi_mpi(igb), prefix(:l_prfx)//'_'//     &
                             suffix(:l_sufx)//'.gbi', .true.)
              else
                open(igbi,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbi',status='unknown',         &
                     form='formatted')
              end if
!c  write file information

              if (rank == 0 .and. b_enable_output) then

              write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                 &
     &              'rates of intra-aqueous kinetic reactions, ',     &
     &              'x = ',xg(ivol),' m',                             &
     &              'y = ',yg(ivol),' m',                             &
     &              'z = ',zout,' m',                                 &
     &              ('-',i=1,72)
                                                                       
              write(ifls,'(/a/)') prefix(:l_prfx)//'_'//              &
     &                            suffix(:l_sufx)//'.gbi'
                                                                       
              write(ifls,'(2a)')                                      &
     &          'column   entry                           ','unit'     
              write(ifls,'(2a)')                                      &
     &          '1        time                            ',time_unit  
              do iaq = 1,naq                                           
                if (iaq.lt.9) then                                     
                  write(ifls,'(i1,8x,a,20x,a)') iaq+1,nameaq(iaq),    &
     &                                          'moles/l h2o/day'      
                else                                                   
                  write(ifls,'(i2,7x,a,20x,a)') iaq+1,nameaq(iaq),    &
     &                                          'moles/l h2o/day'
                end if
              end do
              
              end if

            end if                !(naq.gt.0)

!c  sorbed species concentrations

            if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.                      &
                noncompetitive_sorption) then
              if (b_output_binary) then
#ifndef MPI
                if (igbb_mpi(igb) < 10) then
                  igbb_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,         &
                             igbb_mpi(igb), prefix(:l_prfx)//'_'//     &
                             suffix(:l_sufx)//'.gbb', .true.)
              else
                open(igbb,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbb',status='unknown',         &
                     form='formatted')
              end if
!c  write file information

              if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
     &                'Sorbed species concentraions, ',                &
     &                'x = ',xg(ivol),' m',                            &
     &                'y = ',yg(ivol),' m',                            &
     &                'z = ',zout,' m',                                &
     &                ('-',i=1,72)
                                                                        
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
     &                              suffix(:l_sufx)//'.gbb'
                                                                        
                write(ifls,'(2a)')                                     &
     &            'column   entry                           ','unit'    
                write(ifls,'(2a)')                                     &
     &            '1        time                            ',time_unit
                
              end if

!c  non-competitive sorption

              if (rank == 0 .and. b_enable_output) then

                if (noncompetitive_sorption) then
                
                  ianc = 0
                  do ic = 1,nc-1
                    if (isotherm_type(ic).ne.'none') then
                      ianc = ianc+1
                      if (ianc.lt.9) then
                        write(ifls,'(i1,8x,a,20x,a)') ianc+1,namec(ic),&
     &                                                'moles/l bulk'     
                      else                                               
                        write(ifls,'(i2,7x,a,20x,a)') ianc+1,namec(ic),& 
     &                                                'moles/l bulk'
                      end if
                    end if
                  end do
                
                end if
              
              end if

!c  competitive sorption

              if (rank == 0 .and. b_enable_output) then

                if (nsb_ion.gt.0.or.nsb_surf.gt.0) then
                
!c  primary surface species

                  do isites = 1,nsites
                    ic = iaic(isites)
                    if (isites+nanc.lt.9) then
                      write(ifls,'(i1,8x,a,20x,a)') isites+nanc+1,     &
                                                    namec(ic),         &
                                                    output_unit_sb_surf      
                    else                                                
                      write(ifls,'(i2,7x,a,20x,a)') isites+nanc+1,     &
                                                    namec(ic),         &
                                                    output_unit_sb_surf
                    end if
                  end do

!c  secondary surface species

                  do isb = 1,nsb_ion
                    if (isb+nsites+nanc.lt.9) then
                      write(ifls,'(i1,8x,a,20x,a)')isb+nsites+nanc+1,  &
                                                   namesb_ion(isb),    &
                                                   output_unit_sb_ion       
                    else                                                
                      write(ifls,'(i2,7x,a,20x,a)')isb+nsites+nanc+1,  &
                                                   namesb_ion(isb),    &
                                                   output_unit_sb_ion
                    end if
                  end do
                  
                  do isb = 1,nsb_surf
                    if (isb+nsites+nanc.lt.9) then
                      write(ifls,'(i1,8x,a,20x,a)')isb+nsites+nanc+1,  &
                                                   namesb_surf(isb),   &
                                                   output_unit_sb_surf       
                    else                                                
                      write(ifls,'(i2,7x,a,20x,a)')isb+nsites+nanc+1,  &
                                                   namesb_surf(isb),   &
                                                   output_unit_sb_surf
                    end if
                  end do

                end if
              
              end if

            end if

!c  mineral saturation indices  
!c  open file

            if (nm.gt.0) then
              if (b_output_binary) then
#ifndef MPI
                if (igbs_mpi(igb) < 10) then
                  igbs_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,         &
                             igbs_mpi(igb), prefix(:l_prfx)//'_'//     &
                             suffix(:l_sufx)//'.gbs', .true.)
              else
                open(igbs,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbs',status='unknown',         &
                     form='formatted')
              end if
!c  write file information

              if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
     &                'Mineral saturation indices, ',                  &
     &                'x = ',xg(ivol),' m',                            &
     &                'y = ',yg(ivol),' m',                            &
     &                'z = ',zout,' m',                                &
     &                ('-',i=1,72)
                                                                        
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
     &                              suffix(:l_sufx)//'.gbs'
                                                                        
                write(ifls,'(2a)')                                     &
     &             'column   entry                           ','unit'  
                write(ifls,'(2a)')                                     &
     &             '1        time                            ',time_unit
                do im = 1,nm
                  if (im.lt.9) then
                    write(ifls,'(i1,8x,a,20x,a)') im+1,namem(im),'-'
                  else
                    write(ifls,'(i2,7x,a,20x,a)') im+1,namem(im),'-'
                  end if
                end do
              
              end if

!c  mineral volume fractions 
!c  open file
              if (b_output_binary) then
#ifndef MPI
                if (igbv_mpi(igb) < 10) then
                  igbv_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,         &
                             igbv_mpi(igb), prefix(:l_prfx)//'_'//     &
                             suffix(:l_sufx)//'.gbv', .true.)
              else
                open(igbv,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbv',status='unknown',         &
                     form='formatted')
              end if
              
!c  write file information

              if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
     &                'Mineral volume fractions, ',                    &
     &                'x = ',xg(ivol),' m',                            &
     &                'y = ',yg(ivol),' m',                            &
     &                'z = ',zout,' m',                                &
     &                ('-',i=1,72)
                                                                        
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
     &                            suffix(:l_sufx)//'.gbv'
                                                                        
                write(ifls,'(2a)')                                     &
     &            'column   entry                           ','unit'    
                write(ifls,'(2a)')                                     &
     &            '1        time                            ',time_unit
                do im = 1,nm
                  if (im.lt.9) then
                    write(ifls,'(i1,8x,a,20x,a)') im+1,namem(im),'-'
                  else
                    write(ifls,'(i2,7x,a,20x,a)') im+1,namem(im),'-'
                  end if
                end do
                if (nm.lt.8) then
                  write(ifls,'(i1,8x,a,24x,a)') nm+2,'porosity','-'
                else
                  write(ifls,'(i2,7x,a,24x,a)') nm+2,'porosity','-'
                end if
              
              end if

!c  dissolution-precipitation rates 
!c  open file
              if (b_output_binary) then
#ifndef MPI
                if (igbd_mpi(igb) < 10) then
                  igbd_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,         &
                             igbd_mpi(igb), prefix(:l_prfx)//'_'//     &
                             suffix(:l_sufx)//'.gbd', .true.)
              else
                open(igbd,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbd',status='unknown',         &
                     form='formatted')
              end if
!c  write file information

              if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
     &                'Dissolution-precipitation rates, ',             &
     &                'x = ',xg(ivol),' m',                            &
     &                'y = ',yg(ivol),' m',                            &
     &                'z = ',zout,' m',                                &
     &                ('-',i=1,72)
                                                                        
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
     &                              suffix(:l_sufx)//'.gbd'
                                                                        
                write(ifls,'(2a)')                                     &
     &            'column   entry                           ','unit'    
                write(ifls,'(2a)')                                     &
     &            '1        time                            ',time_unit
                                                                         
                istart = iamd(1)                                         
                istop = iamd(nm+1)-1                                     
                do ireac = istart,istop                                  
                  if (ireac.lt.9) then                                   
                    write(ifls,'(i1,8x,a,18x,a)') ireac+1,             &
     &                              namemp(ireac),'moles/l bulk/day'     
                  else                                                   
                    write(ifls,'(i2,7x,a,18x,a)') ireac+1,             &
     &                              namemp(ireac),'moles/l bulk/day'
                  end if
                end do
              
              end if
           
            end if                           !(nm.gt.0)

            if (nmx.gt.0) then

!c  saturation indices (excluded minerals) 
!c  open file
              if (b_output_binary) then
#ifndef MPI
                if (igbx_mpi(igb) < 10) then
                  igbx_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,         &
                             igbx_mpi(igb), prefix(:l_prfx)//'_'//     &
                             suffix(:l_sufx)//'.gbx', .true.)
              else
                open(igbx,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbx',status='unknown',         &
                     form='formatted')
              end if

!c  write file information

              if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
     &                'Saturation indices (excluded minerals), ',      &
     &                'x = ',xg(ivol),' m',                            &
     &                'y = ',yg(ivol),' m',                            &
     &                'z = ',zout,' m',                                &
     &                ('-',i=1,72)
                                                                        
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
     &                              suffix(:l_sufx)//'.gbx'
                                                                        
                write(ifls,'(2a)')                                     &
     &             'column   entry                           ','unit' 
                write(ifls,'(2a)')                                     &
     &             '1        time                            ',time_unit
                do imx = 1,nmx
                  if (imx.lt.9) then
                    write(ifls,'(i1,8x,a,20x,a)') imx+1,namemx(imx),'-'
                  else
                    write(ifls,'(i2,7x,a,20x,a)') imx+1,namemx(imx),'-'
                  end if
                end do
              
              end if
 
            end if                           !(nmx.gt.0)
            
!c_isotope
!c  isotope data 
!c  open file
            if (iso_output) then
                
!c  dissolution-precipitation rates 
!c  open file
              if (b_output_binary) then
#ifndef MPI
                if (igbis_mpi(igb) < 10) then
                  igbis_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,                 &
                             igbis_mpi(igb), prefix(:l_prfx)//'_'//    &
                             suffix(:l_sufx)//'.gbis', .true.)
              else
                open(igbis,file=prefix(:l_prfx)//'_'//                 &
                     suffix(:l_sufx)//'.gbis',status='unknown',        &
                     form='formatted')
              end if

!c  write file information
              if (rank == 0 .and. b_enable_output) then
                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
                      'Isotope Data, ',                                &
                      'x = ',xg(ivol),' m',                            &
                      'y = ',yg(ivol),' m',                            &
                      'z = ',zout,' m',                                &
                      ('-',i=1,72)
                                                                        
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
                                    suffix(:l_sufx)//'.gbis'
                                                                        
                write(ifls,'(2a)')                                     &
                      'column   entry                           ','unit'  
                write(ifls,'(2a)')                                     &
                      '1        time                            ',     &
                      time_unit              
                
                icount = 1
                do i=1,nip
                istart = iamdisoo(i)
                istop = iamdisoo(i+1)-1
                do i1 = istart, istop
                    ic2 = jamdisoo(i1)
                    icount = icount +1
                    if (icount.le.9) then
                        write(ifls,'(i1,8x,a,8x,a)') icount,namec(ic2),&
                                           'moles/l h2o'
                    else
                        write(ifls,'(i2,7x,a,8x,a)') icount,namec(ic2),&
                                           'moles/l h2o'
                    end if
                end do
                icount = icount +1
                ic2 = jamdisoo(istart)
                if (icount.le.9) then
                   write(ifls,'(i1,8x,a4,a,4x,a)') icount, 'sum ',     &
                         namec(ic2), 'moles/l h2o'                      
                else                                                    
                    write(ifls,'(i2,8x,a4,a,4x,a)') icount, 'sum ',    &
                         namec(ic2), 'moles/l h2o'
                end if
               
                istart = iamdisoo(i)
                istop = iamdisoo(i+1)-1
                do i1 = istart+1, istop
                    ic1 = jamdisoo(istart)
                    ic2 = jamdisoo(i1)
                    icount = icount +1 
                    if (icount.le.9) then
                      write(ifls,'(i1,8x,a6,a8,a2,a8,8x,a)') icount,   &
                        'delta ', namec(ic2),'/ ', namec(ic1),'per mil' 
                    else                                                
                      write(ifls,'(i2,8x,a6,a8,a2,a8,8x,a)') icount,   &
                        'delta ', namec(ic2),'/ ', namec(ic1),'per mil'
                    end if
                    
                end do
                end do 
              end if
              
            end if                           !(iso_output)
          end if                             !(reactive_transport)      
        end do                               !(igb = 1,ngb)
      end if                                 !(gb_output)
      
!c  temporal evolution about energy and evaporation parameters
      if (transient_flow.or.reactive_transport) then
        if (evaporation.and.write_evap_info) then
          if(rank == 0 .and. b_enable_output) then
            call trans_evap_info (.true.,0)
          end if
        end if
      end if

!c  write header for contour data to file information file

      if (gs_output .and. rank == 0 .and. b_enable_output) then
        write(ifls,'(//72a/a/72a)')                                   &
     &              ('*',i=1,72),                                     &
     &              'contour data - global system',                   &
     &              ('*',i=1,72) 
      end if

      return
      end
