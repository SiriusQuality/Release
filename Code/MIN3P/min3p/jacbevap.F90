!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/jacbevap.F90 $
!---------------------------------------------------------------------
!********************************************************************!

subroutine jacbevap(ivol,typeequation) 
 
use parm
use gen
use dens
use phys 
use chem
#ifdef PETSC
use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
implicit none
     
character(len=*), intent(in)  :: typeequation
integer, intent(in)           :: ivol

! Local variables

character(len=100)            :: typebc

logical                       :: comp_der

real*8  :: latvaploc, area_ivol, actw, evap, densinc_ivol,             &
           densvinc_ivol, dflux, dummy, dummy1, dummy2, dummy3, dummy4,&
           evapinc_temp, evapinc_pa, heatflux, heatfluxinc, hrunoff,   &
           hrunoffinc, porinc_ivol, porosity_flow, rain, radiation,    &
           radnetinc, rhinc, rhonew, runoffinc, sainc_ivol,            &
           sawinc_ivol, tempinc_ivol, uvsinc_ivol

real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, rsmall=1.0d-3
integer :: ibvs, idiag_pa, idiag_temp, izn

external :: evap, porosity_flow, radiation


!real*8 :: area_ivol, densinc_ivol, densvinc_ivol, dflux,            &
!          dummy, dummy1, dummy2, dummy3, dummy4,                    &
!          evapinc_pa, evapinc_temp, heatflux, heatfluxinc,          &
!          hrunoff, hrunoffinc, porinc_ivol, radnetinc,              &
!          rain, rhinc, runoffinc,                                   &
!          sainc_ivol, sawinc_ivol, uvsinc_ivol

!real*8 :: sheat_atm, runoff_atm, rh_atm, radnet, evap_atm  

evapinc_temp = r0
evapinc_pa = r0
runoffinc = r0

! This subroutine is tricky, some of the variable is global shared
! and updated, but not used immediately. DSU, 2013-10-30

!cprovi---------------------------------------------------      
!cprovi---------------------------------------------------
!cprovi---------------------------------------------------  
izn = mpropvs(ivol)
ibvs = ivol2bvs(ivol)
if(ibvs==0) then
    if (rank == 0) then
      write(ilog,*)'error in boundary cond.'
      close(ilog)
    end if
#ifdef PETSC
    call petsc_mpi_finalize
#endif
    stop
end if
area_ivol = bcondvs(ibvs)
!cprovi---------------------------------------------------
!cprovi Check if the derivatives must be computed 
!cprovi---------------------------------------------------
if (typeequation=='heat'.or.typeequation=='flow') then
   comp_der = .true.
!cprovi---------------------------------------------------
!cprovi Compute the perturbation 
!cprovi---------------------------------------------------   
   tempinc_ivol = tempnew(ivol) + dinc_heat
   uvsinc_ivol = uvsnew(ivol) + dinc_vs 
else
   comp_der = .false.
end if
!cprovi---------------------------------------------------
!cprovi If reactive transport is not solved, water
!cprovi is considered equal to unity 
!cprovi---------------------------------------------------
if (reactive_transport) then
 actw=gamma(nc,ivol)
else
 actw=r1
end if
!cprovi---------------------------------------------------
!cprovi Compute the rain
!cprovi---------------------------------------------------
rain = rain_atm * ssdens(ivol) * area_ivol 
!cprovi-------------------------------------------------------------
!cprovi Compute the runoff term 
!cprovi-------------------------------------------------------------
if (uvsnew(ivol)>aentry(izn)) then
  if(b_water_freezing .and. tempnew(ivol) < water_freezing_temper) then
    runoff_atm=r0
    if (comp_der) then 
      runoffinc=r0
    end if
  else
    runoff_atm=gammaw_atm*(uvsnew(ivol)-aentry(izn)) 
    if (comp_der) then 
      runoffinc=gammaw_atm*(uvsinc_ivol-aentry(izn))  
    end if
  end if
else
  runoff_atm=r0
  if (comp_der) then 
    runoffinc=r0
  end if
end if
!cprovi-------------------------------------------------------------
!cprovi Compute sensible heat
!cprovi-------------------------------------------------------------
 call compute_sensible (sheat_atm,tempnew(ivol),rh_atm,r1)
!cprovi-------------------------------------------------------------
!cprovi During a rainfall event, evaporation is equal to zero
!cprovi-------------------------------------------------------------
if (comp_evap_rate_atm) then  
  evap_atm = evap(densvnew(ivol),pornew(ivol),sanew(ivol),rh_atm,r1)
  !cprovi-------------------------------------------------------------
  !cprovi If derivatives must be computed, then compute the perturbed 
  !cpeovi value for evaporation 
  !cprovi-------------------------------------------------------------    
  if (comp_der) then 
      if (ispitzerdens) then 
            densinc_ivol =rhonew (ref_dens,density_pitzer(ivol), &
                                  ref_dens,tempinc_ivol,tempref_dens,  &
                                  r1,drho_dt,nonlindens_heat,cdens1, &
                                  cdens2,cdens3,cdens4)
      else
            densinc_ivol = rhonew (ref_dens,tds_new(ivol), &
                                   ref_tds,tempinc_ivol,tempref_dens, & 
                                   drho_dc,drho_dt,nonlindens_heat,  &
                                   cdens1,cdens2,cdens3,cdens4)
      end if
      call vapor_prop (densvinc_ivol,dummy1,dummy2,dummy3,dummy4,  &
                       tempinc_ivol,aentry(izn),uvsnew(ivol),  &
                       actw,densinc_ivol,ivol)    
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the perturbed sensible heat by temperature
!cprovi-----------------------------------------------------------------------------                   
      call compute_sensible(dummy,tempinc_ivol,rhinc,r1)
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the perturbed evaporation rate by temperature
!cprovi-----------------------------------------------------------------------------             
      evapinc_temp=evap(densvinc_ivol,pornew(ivol),sanew(ivol),rhinc,r1)
 
      call vapor_prop (densvinc_ivol,dummy1,dummy2,dummy3,dummy4, &
                       tempnew(ivol),aentry(izn),uvsinc_ivol, & 
                       actw,density(ivol),ivol)  
      call soilprdd(uvsinc_ivol,sainc_ivol,dummy1,dummy2,relpermg(ivol),  &
                    snnew(ivol),swr(izn),aentry(izn),spalpha(izn), & 
                    spbeta(izn),expn(izn),spgamma(izn), &
                    napl_permeability,napl_kfunction,sgr,isovendrying(izn), & 
                    beta_ovendry(izn),hm_ovendry(izn),w0_ovendry(izn),cp0_ovendry(izn), &
                    ref_dens,gacc)                 
  
      if (modify_por(ivol)) then
          porinc_ivol = porosity_flow(porold(ivol),uvsinc_ivol,uvsold(ivol),stor(ivol), &
                        por_stress(ivol),por_init(ivol),facpormin)  
      else                  
          porinc_ivol = pornew(ivol)               
      end if                  
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the perturbed sensible heat by liquid pressure
!cprovi-----------------------------------------------------------------------------                      
      evapinc_pa=evap(densvinc_ivol,porinc_ivol,sainc_ivol,rh_atm,r1) 
      
   end if  ! if compute derivatives      
 else
   if (comp_der) then     
       evapinc_temp=evap_atm
       evapinc_pa=evap_atm
   end if 
 end if  ! comp_evap_rate_atm         
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the net radiation
!cprovi-----------------------------------------------------------------------------
if (.not.read_rad_atm) then
     radnet=radiation(sanew(ivol),tempnew(ivol))
end if
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the total fluxes
!cprovi-----------------------------------------------------------------------------
    if(b_water_freezing .and. tempnew(ivol) < water_freezing_temper) then        
      totwflux_atm = r0  
    else
      totwflux_atm = evap_atm + rain_atm * ssdens(ivol) + runoff_atm
    end if
    tothflux_atm = latvap_atm*evap_atm + heatcapw*rain_atm*ssdens(ivol)*temp_atm + radnet + &
                   heatcapw*runoff_atm*temp_atm + sheat_atm
!cprovi-----------------------------------------------------------------------------
!cprovi Modify residual and jacobian according to type of equation 
!cprovi-----------------------------------------------------------------------------
if (typeequation=='flow') then
    
  if((.not.b_water_freezing) .or. tempnew(ivol) > water_freezing_temper) then
  
    bglob(ivol) = bglob(ivol) + evap_atm * area_ivol + rain + runoff_atm * area_ivol
    
    idiag_temp = iaglob(ivol) + iavs(ivol+1) - iavs(ivol)
    
    idiag_pa = iaglob(ivol)  
    
    dflux =  area_ivol * (evapinc_temp - evap_atm)/dinc_heat
     
    aglob(idiag_temp) = aglob(idiag_temp) - dflux
                 
    dflux =  area_ivol * (evapinc_pa - evap_atm)/dinc_vs 
     
    aglob(idiag_pa) = aglob(idiag_pa) - dflux
     
    dflux =  area_ivol*(runoffinc - runoff_atm)/dinc_vs 
     
    aglob(idiag_pa) = aglob(idiag_pa) - dflux
    
  end if  
    

else if (typeequation=='heat') then   
   
   idiag_temp = iaglob(ivol+nngl)
   idiag_pa = iaglob(ivol+nngl) + iavs(ivol+1) - iavs(ivol)
   
   heatflux = evap_atm*latvap_atm
   bglob(ivol+nngl) = bglob(ivol+nngl) + heatflux * area_ivol  
   
   heatfluxinc=evapinc_temp*latvap_atm
   dflux =  area_ivol * (heatfluxinc - heatflux)/dinc_heat
   aglob(idiag_temp) = aglob(idiag_temp) - dflux
   
           
   heatfluxinc=evapinc_pa*latvap_atm
         
   dflux =  area_ivol * (heatfluxinc - heatflux)/dinc_vs 
     
   aglob(idiag_pa) = aglob(idiag_pa) - dflux
  !cprovi-------------------------------------------------------------
  !cprovi Sensible heat  
  !cprovi Compute perturbation in sensible heat 
  !cprovi-------------------------------------------------------------
   call compute_sensible (heatfluxinc,tempinc_ivol,dummy,r1)
           
   dflux =  area_ivol * (heatfluxinc - sheat_atm)/dinc_heat
     
   aglob(idiag_temp) = aglob(idiag_temp) - dflux
   
   bglob(ivol+nngl) = bglob(ivol+nngl) + sheat_atm * area_ivol 
   !cprovi-------------------------------------------------------------
   !cprovi Rainfall   
   !cprovi-------------------------------------------------------------
   bglob(ivol+nngl) = bglob(ivol+nngl) + heatcapw * rain * temp_atm
   !cprovi-------------------------------------------------------------
   !cprovi Radiation 
   !cprovi-------------------------------------------------------------
   if (.not.read_rad_atm) then
     radnetinc=radiation(sanew(ivol),tempinc_ivol)
     dflux =  area_ivol * (radnetinc - radnet)/dinc_heat 
     aglob(idiag_temp) = aglob(idiag_temp) - dflux
   end if
   bglob(ivol+nngl) = bglob(ivol+nngl) + radnet * area_ivol 
   if (.not.read_rad_atm) then
     call soilprdd(uvsinc_ivol,sawinc_ivol,dummy1,dummy2,relpermg(ivol), &
                   snnew(ivol),swr(izn),aentry(izn),spalpha(izn), & 
                   spbeta(izn),expn(izn),spgamma(izn), &
                   napl_permeability,napl_kfunction,sgr, &
                   isovendrying(izn),beta_ovendry(izn),hm_ovendry(izn), &
                   w0_ovendry(izn),cp0_ovendry(izn),ref_dens,gacc)
     radnetinc=radiation(sawinc_ivol,tempnew(ivol))
     dflux =  area_ivol * (radnetinc - radnet)/dinc_vs 
     aglob(idiag_pa) = aglob(idiag_pa) - dflux
   end if
   !cprovi-------------------------------------------------------------
   !cprovi Add the runoff term 
   !cprovi If Pl>Pg then the water is going out
   !cprovi-------------------------------------------------------------
   hrunoff=heatcapw*runoff_atm*temp_atm 
   hrunoffinc=heatcapw*runoffinc*temp_atm
   dflux =  area_ivol*(hrunoffinc-hrunoff)/dinc_vs 
   aglob(idiag_pa) = aglob(idiag_pa) - dflux 
   bglob(ivol+nngl) = bglob(ivol+nngl) + hrunoff 
   


 end if   
 
 return
 end subroutine 
