!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/draoult.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine draoult
!c ------------------
!c
!c compute derivative of dissolution rate for organic contaminant from 
!c organic mixture
!c
!c sign convention: dissolution -
!c
!c written by:      Uli Mayer - January 17, 00
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c                                - new time level [moles/l water]
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           gammac(nc)         = activity coefficients of components + -
!c                                as species in solution
!c           phim               = volume fractions of minerals        + -
!c           phimold            = volume fractions of minerals        + -
!c                                - old time level
!c           ratem              = absolute dissolution-precipitation  * +
!c                                rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(nc)           = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/l h2o]
!c
!c           integer*4:
!c           ----------
!c           im                = counter
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           cinc(nc,nthreads)  = incremented concentrations          + -
!c                                of components as species in
!c                                solution
!c                                [moles/l h2o]
!c           conc_mol_avg(nthreads)
!c                              = average molar concentration of      + -
!c                                organic mixture 
!c           densm(nm)          = density of free phase product       + -
!c           eqm(nm,nthreads)   = solubility constant for organic     + -
!c                                compound
!c           gfwm(nm)           = gram formula weight of free phase   + -
!c                                product
!c           rated(ndr*nm,nthreads)
!c                              = rate constants for dissolution      + -
!c                                reactions
!c           satm(nm,nthreads)  = IAP/K for free phase product        + -
!c           xnum(nm*nc)        = stoichiometric coefficients of
!c                                components in free phase product
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c
!c           character:
!c           ----------
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c
!c
!c local:    real*8:
!c           -------
!c           conc_mol           = molar concentration of organic
!c                                compound in organic mixture
!c           frac_mol           = mole fraction of organic compound
!c                                in organic mixture
!c           r0                 = constant
!c           r1                 = constant
!c           satminc            = saturation index with respect
!c                                to current mineral (incremented)
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter 
!c           ireac              = counter
!c           istart             = pointer
!c           istop              = pointer
!c
!c external: satindex  = compute saturation index
!c ----------------------------------------------------------------------
  
      subroutine draoult(c,gammac,ratem,phim,phimold,aream,drtinc,im)
 
      use parm
      use chem
#ifdef OPENMP
      use omp_lib 
#endif
 
      implicit none
      
      real*8 :: c,gammac,ratem,phim,phimold,aream,drtinc
      
      integer :: im
      
      integer :: tid, ireac, istart, istop
      
      real*8 :: conc_mol, frac_mol, satindex, satminc

      external satindex

      dimension c(*),gammac(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0   
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
      
!c  compute effective dissolution rate

      if (reaction_type(im).eq.'raoult') then

!c  compute mol fraction of organic compound in organic mixture

        conc_mol = phimold*densm(im)/gfwm(im)
        frac_mol = conc_mol/conc_mol_avg(tid)

!c  compute free phase saturation indices (unshifted and shifted)

        satm(im,tid) = satindex(c,eqm(im,tid),gammac,xnum,iam,jam,im)
        satminc = satindex(cinc(:,tid),eqm(im,tid),gammac,xnum,iam,   &
                  jam,im)

!c  compute effective saturation indices

        satm(im,tid) = satm(im,tid)/frac_mol
        satminc = satminc/frac_mol

!c  compute reaction rate for dissolution of organic compound

        ratem = r0

!c  consider parallel reaction pathways

        istart = iamd(im)
        istop = iamd(im+1)-1
      
          do ireac = istart,istop
          ratem = ratem - aream * rated(ireac,tid) * frac_mol         &
               * eqm(im,tid) * ((r1 - satminc) - (r1 - satm(im,tid)))
        end do
        ratem = ratem*phimold/(phimold+1.0d3*phimin(im))

!c  set rate to zero, if organic approaches depleted

        if (phimold.lt.phimin(im)+1.0d-3*phimin(im)) then
          ratem = r0
        end if

!c  divide by increment of numerical differentiation
!c  and obtain derivative of total rate

      ratem = ratem/drtinc

      end if           !(reaction_type)

      return
      end
