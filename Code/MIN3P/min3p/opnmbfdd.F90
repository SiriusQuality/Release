!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/opnmbfdd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine opnmbfdd
!c -------------------
!c
!c open mass balance files 
!c
!c written by:      Uli Mayer - February 3, 97
!c
!c last modified:   Tom Henderson - April 1, 2003
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -   
!c
!c common:   
!c gen.f:    integer*4:
!c           ----------
!c           icnv               = unit number, data conversion        + -
!c           ifls               = unit number, file information       + -
!c           imrt               = unit number, mass balance -         * *
!c                                             reactive transport
!c           imrt_first         = pointer - first unit number for     * +
!c                                mass balance - reactive transport
!c           imrt_last          = pointer - last unit number for      * +
!c                                mass balance - reactive transport
!c           imvs               = unit number, mass balance -         * *
!c                                             variably saturated
!c                                             flow
!c           imvs_first         = pointer - first unit number for     * +
!c                                mass balance - variably saturated
!c                                               flow
!c           imvs_last          = pointer - last unit number for      * +
!c                                mass balance - variably saturated
!c                                               flow
!c           l_prfx             = length of prefix of I/O files       + -
!c           nmb                = number of mass balance files for    + -
!c                                selected species
!c
!c           logical:
!c           --------
!c           mass_balance_rt    = .true.  -> compute mass balance     + -
!c                                           (reactive tramsport)
!c           mass_balance_vs    = .true.  -> compute mass balance     + -
!c                                           (variably saturated 
!c                                            flow)
!c
!c           character:
!c           ----------
!c           namemb(nmb)        = names of selected species           + -
!c           prefix             = prefix name for all I/O files       + -
!c           time_unit          = time unit for output -> 'years'     + -
!c                                                        'days'
!c
!c chem.f:   integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           nanc               = number of sorbed species            + -
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components including h2o  + -
!c           nm                 = number of minerals                  + -
!c           ng                 = number of gases                     + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c
!c           character:
!c           ----------
!c           isotherm_type(nc)  = definition of sorption isotherm     + -    
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           nameanc(nc)        = names of sorbed species             + -
!c                                (non-competitive sorption)
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namem(nm)          = mineral names                       + -
!c           namesb(nsb)        = names of sorbed species             + -
!c           namesb_ion(nsb_ion)= names of sorbed species             + -
!c                                (ion-exchange)
!c           namesb_surf(nsb_surf)= names of sorbed species           + -
!c                                  (surface-complex)
!c
!c           logical:
!c           --------
!c           noncompetitive_sorption = logical array for activation   + -  
!c                                     of noncompetitive sorption
!c                                     reactions
!c
!c local:    integer*4:
!c           ----------
!c           ianc               = counter (non-competitive sorption
!c                                         reactions)
!c           iaq                = counter (intra-aqueous kinetic 
!c                                         reactions)
!c           ic                 = counter (components)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imb                = counter (selected species)
!c           isb                = counter (sorbed species)
!c           isites             = counter (surface sites)
!c           l_sufx             = length of file suffix
!c
!c           character:
!c           ----------
!c           suffix             = file suffix
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine opnmbfdd
 
      use parm
      use gen
      use chem
      use file_unit, only : lun_get

      implicit none
      
      integer :: i, ianc, iaq, ic, ig, im ,imb, isb, isites, l_sufx

      character*2 suffix
      character*2048 :: strbuffer
      
      integer*4 :: nvarsimrt
      character*72, allocatable :: tec_variables(:)

!c     write(*,'(/a)') 'enter routine opnmbfls ...'
 
!c  mass balance - variably saturated flow
      
      if (mass_balance_vs) then

        imvs_first  = 100

        write(ifls,'(//72a/a/72a/)')                                  &
     &     ('*',i=1,72),                                              &
     &     'mass balance - density dependent variably saturated flow',&
     &     ('*',i=1,72)

!c  system mass

        imvs = imvs_first
        
        if (rank == 0 .and. b_enable_output) then
          open(imvs,file=prefix(:l_prfx)//'_o.mvs',status='unknown',   &
     &              form='formatted')
          
          if (evaporation) then

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(imvs, "#")
            end if
            
            write(imvs,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(imvs,'(3a)') 'variables = "time", "water mass", ',   &
                            '"water filled volume", ',                 &
                            '"vapour filled volume" '
            write(imvs,'(2a)') 'zone t = "system mass - ',             &
                            ' variably saturated flow", f=point'
          else
!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(imvs, "#")
            end if
            
            write(imvs,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(imvs,'(3a)') 'variables = "time", "water mass", ',   &
                            '"water filled volume", ',                 &
                            '"gas filled volume" '
            write(imvs,'(2a)') 'zone t = "system mass - ',             &
                            ' variably saturated flow", f=point'       
          end if
          
          write(ifls,'(a/72a/)')'system mass',('-',i=1,72)
          write(ifls,'(a/)') prefix(:l_prfx)//'_o.mvs'
          
          write(ifls,'(2a)')'column   entry                           ',&
     &                      'unit'
          write(ifls,'(2a)')'1        time                            ',&
     &                       time_unit
          write(ifls,'(2a)')'2        water mass                      ',&
     &                      'kg'
          write(ifls,'(2a)')'3        water filled volume             ',&
     &                      'm^3'
          write(ifls,'(2a/)')'4        air filled volume               ',&
     &                       'm^3'
        end if

!c  mass balance contributions

        imvs = imvs+1
        
        if (rank == 0 .and. b_enable_output) then            
          open(imvs,file=prefix(:l_prfx)//'_o.mvc',status='unknown',   &
     &              form='formatted')
        
!c  version information
          if (b_writeversion_tecplot ) then
              call writeversion2file(imvs, "#")
          end if
          
          write(imvs,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          write(imvs,'(3a)')                                           &
                'variables = "time", "inflow", "outflow", ',           &
                '"change in storage", ',                               &
                '"root water uptake" '                                 
          write(imvs,'(2a)') 'zone t = "mass balance - ',              &
                                ' variably saturated flow", f=point'
          
          write(ifls,'(a/72a/)')'mass balance contributions',          &
     &                          ('-',i=1,72)
          write(ifls,'(a/)') prefix(:l_prfx)//'_o.mvc'
          
          write(ifls,'(2a)') 'column   entry                           ',&
     &                       'unit'                                       
          write(ifls,'(2a)') '1        time                            ',&
     &                        time_unit                                   
          write(ifls,'(2a)') '2        total inflow                    ',&
     &                       'kg/day'                                     
          write(ifls,'(2a)') '3        total outflow                   ',&
     &                       'kg/day'                                     
          write(ifls,'(2a/)')'4        change in storage               ',&
     &                       'kg/day'
        end if

!c  mass balance error

        imvs = imvs+1
        
        if (rank == 0 .and. b_enable_output) then
          open(imvs,file=prefix(:l_prfx)//'_o.mve',status='unknown',   &
     &              form='formatted')
        
!c  version information
          if (b_writeversion_tecplot ) then
              call writeversion2file(imvs, "#")
          end if
          
          write(imvs,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          write(imvs,'(5a)') 'variables = "time", ',                   &
                         '"absolute mass balance error", ',            &
                         '"relative mass balance error", ',            & 
                         '"absolute cumulative mass balance error", ', &
                         '"relative cumulative mass balance error" '   
          write(imvs,'(2a)') 'zone t = "mass balance error - ',        &
                             ' variably saturated flow", f=point'
                                                                         
          write(ifls,'(a/72a/)')'mass balance error',                    &
     &                          ('-',i=1,72)                               
          write(ifls,'(a/)') prefix(:l_prfx)//'_o.mve'
                                                                           
          write(ifls,'(2a)')  'column   entry                           ',&
     &                        'unit'                                       
          write(ifls,'(2a)')  '1        time                            ',&
     &                         time_unit                                   
          write(ifls,'(2a)')  '2        absolute mass balance error     ',&
     &                        'm^3'                                        
          write(ifls,'(2a)')  '3        relative mass balance error     ',&
     &                        '% = kg/kg in system x 100'                  
          write(ifls,'(2a)')  '4        accumulative absolute mass      ',&
     &                        'kg'                                         
          write(ifls,'(a)')   '         balance error'                     
          write(ifls,'(2a)')  '5        accumulative relative mass      ',&
     &                        '% = kg/kg in system x 100'
          write(ifls,'(a)')   '         balance error'
        end if

        imvs_last = imvs

      end if
 
!c  mass balance - reactive transport

      if (mass_balance_rt) then

        imrt_first = 103

        if (rank == 0 .and. b_enable_output) then
          write(ifls,'(//72a/a/72a)')               &
     &         ('*',i=1,72),                        &
     &         'mass balance - reactive transport', &
     &         ('*',i=1,72)
        end if

!c  total system mass for components

        imrt = imrt_first
        
        if (rank == 0 .and. b_enable_output .and. b_output_binary) then
          i = 5+2*n+nmb+naq+ng+nm 
          allocate(imrt_mpi(imrt_first:imrt_first+i-1))
          allocate(offset_imrt(imrt_first:imrt_first+i-1))
          allocate(offset_imrt_ijk(imrt_first:imrt_first+i-1))
          allocate(tec_variables(nc+nmb+ng+nm+nsites+nsb_ion+          &
	                         nsb_surf+26))
        end if
        
        if (rank == 0 .and. b_enable_output) then
          if (b_output_binary) then
#ifndef MPI
            if (imrt_mpi(imrt) < 10) then
              imrt_mpi(imrt) = lun_get()
            end if
#endif
            call tecplot_binary_file_open(PETSC_COMM_SELF,             &
                         imrt_mpi(imrt), prefix(:l_prfx)//'_o.mas',    &
                         .true.)
          else
            open(imrt,file=prefix(:l_prfx)//'_o.mas',status='unknown', &
     &              form='formatted')
          end if
          
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(imrt, "#")
          end if            
          
          
          if (b_output_binary) then
            nvarsimrt = nc
            tec_variables(1:nvarsimrt) = (/"time",(trim(namec(ic)),    &
                                       ic=1, nc-1)/)
            strbuffer = 'system mass - aqueous phase'
            
            offset_imrt(imrt) = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                         imrt_mpi(imrt), "#!TDV102",'dataset '//       &
                         prefix(:l_prfx),offset_imrt(imrt),.true.,     &
                         .true.)  
  
            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         imrt_mpi(imrt), nvarsimrt,                    &
                         tec_variables(1:nvarsimrt), offset_imrt(imrt),&
                         .true.,.true.)               

            call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),         &
                         trim(strbuffer),offset_imrt(imrt), 1, 1, 1,   &
                         .true.,.true.)
            offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4

            call tecplot_binary_write_section(imrt_mpi(imrt),          &
                         nvarsimrt,0,offset_imrt(imrt), .true., .true.) 
          else
            write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"' 
            
            strbuffer = 'variables = "time"'
            do ic = 1,nc-1
              strbuffer = trim(strbuffer)//', "'//trim(namec(ic))//'"'
            end do
            
            write(imrt,'(a)') trim(strbuffer)            
            write(imrt,'(2a)')                                         &
                  'zone t = "system mass - aqueous phase", f=point'
          end if
          
                                                                           
          write(ifls,'(/a/72a/)') 'system mass - aqueous phase',       &
     &                            ('-',i=1,72)                             
          write(ifls,'(a/)') prefix(:l_prfx)//'_o.mas'
                                                                           
          write(ifls,'(2a)')  'column   entry                           ',&
     &                        'unit'                                       
          write(ifls,'(2a)')  '1        time                            ',&
     &                         time_unit
          do ic = 1,nc-1
            if (ic.lt.9) then
              write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic),'moles'
            else
              write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic),'moles'
            end if
          end do
        end if

!c  total system mass for selected species

        if (nmb.gt.0) then

          imrt = imrt + 1
          
          if (rank == 0 .and. b_enable_output) then
            if (b_output_binary) then  
#ifndef MPI
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call tecplot_binary_file_open(PETSC_COMM_SELF,             &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_o.mss',    &
                           .true.)
            else
              open(imrt,file=prefix(:l_prfx)//'_o.mss',status='unknown', &
     &                  form='formatted')
            end if
            
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(imrt, "#")
            end if            
            
            if (b_output_binary) then
              nvarsimrt = nmb+1
              tec_variables(1:nvarsimrt) = (/"time",(trim(namemb(imb)),&
                                         imb=1, nmb)/)
              strbuffer = 'system mass - selected species'
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),       &
                           trim(strbuffer),offset_imrt(imrt), 1, 1, 1, &
                           .true.,.true.)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(imrt_mpi(imrt),        &
                           nvarsimrt,0,offset_imrt(imrt), .true.,      &
                           .true.) 
            else
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"' 
              
              strbuffer = 'variables = "time"'
              do imb = 1,nmb
                strbuffer = trim(strbuffer)//', "'//trim(namemb(imb))//'"'
              end do
              
              write(imrt,'(a)') trim(strbuffer)            
              write(imrt,'(2a)')                                       &
                    'zone t = "system mass - selected species", f=point'
            end if
                                                                        
            write(ifls,'(/a/72a/)') 'system mass - selected species',  &
     &                              ('-',i=1,72)                           
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.mss'
                                                                           
            write(ifls,'(2a)')'column   entry                           ',&
     &                        'unit'                                       
            write(ifls,'(2a)')'1        time                            ',&
     &                         time_unit
            do imb = 1,nmb
              if (imb.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') imb+1,namemb(imb),'moles'
              else
                write(ifls,'(i2,7x,a30,2x,a)') imb+1,namemb(imb),'moles'
              end if
            end do
          end if          

        end if

!c  total system mass for gases

        if (ng.gt.0) then

          imrt = imrt + 1
          
          if (rank == 0 .and. b_enable_output) then
            if (b_output_binary) then
#ifndef MPI
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call tecplot_binary_file_open(PETSC_COMM_SELF,             &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_o.mgs',    &
                           .true.)
            else
              open(imrt,file=prefix(:l_prfx)//'_o.mgs',status='unknown', &
     &                  form='formatted')
            end if
            
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(imrt, "#")
            end if            
            
            if (b_output_binary) then
              nvarsimrt = ng+1
              tec_variables(1:nvarsimrt) = (/"time",(trim(nameg(ig)),&
                                         ig=1, ng)/)
              strbuffer = 'system mass - gaseous phase'
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),       &
                           trim(strbuffer),offset_imrt(imrt), 1, 1, 1, &
                           .true.,.true.)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(imrt_mpi(imrt),        &
                           nvarsimrt,0,offset_imrt(imrt), .true.,      &
                           .true.) 
            else
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'             
              
              strbuffer = 'variables = "time"'
              do ig = 1,ng
                strbuffer = trim(strbuffer)//', "'//trim(nameg(ig))//'"'
              end do
              
              write(imrt,'(a)') trim(strbuffer)            
              write(imrt,'(2a)')                                       &
                    'zone t = "system mass - gaseous phase", f=point'   
            end if
            
                                                                        
            write(ifls,'(/a/72a/)') 'system mass - gaseous phase',     &
     &                              ('-',i=1,72)                           
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.mgs'
                                                                           
            write(ifls,'(2a)')'column   entry                           ',&
     &                        'unit'                                       
            write(ifls,'(2a)')'1        time                            ',&
     &                         time_unit
            do ig = 1,ng
              if (ig.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') ig+1,nameg(ig),'moles'
              else
                write(ifls,'(i2,7x,a30,2x,a)') ig+1,nameg(ig),'moles'
              end if
            end do          
          end if

        end if               !(ng.gt.0)

! c  total system mass for sorbed species

        if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.noncompetitive_sorption) then

          imrt = imrt + 1
          
          if (rank == 0 .and. b_enable_output) then
            if (b_output_binary) then  
#ifndef MPI
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call tecplot_binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_o.mss',  &
                           .true.)
            else
              open(imrt,file=prefix(:l_prfx)//'_o.mss',                &
     &                  status='unknown',form='formatted')
            end if
            
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(imrt, "#")
            end if 
            
            if (b_output_binary) then
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.) 
            else
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"' 
            end if
            
            if (b_output_binary) then
              tec_variables(1) = "time"
            else
              strbuffer = 'variables = "time"'
            end if
                                                                           
            write(ifls,'(/a/72a/)') 'system mass - sorbed species',       &
     &                              ('-',i=1,72)                           
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.mss'
                                                                           
            write(ifls,'(2a)')'column   entry                           ',&
     &                        'unit'                                       
            write(ifls,'(2a)')'1        time                            ',&
     &                         time_unit

!c  non-competitive sorption reactions

            if (noncompetitive_sorption) then
              ianc = 0
              nvarsimrt = nc
              do ic = 1,nc-1
                if (isotherm_type(ic).ne.'none') then
                  ianc = ianc+1
                  
                  if (b_output_binary) then
                    tec_variables(ic+1) = trim(nameanc(ianc))   
                  else
                    strbuffer = trim(strbuffer)//', "'//               &
                                trim(nameanc(ianc))//'"'
                  end if
                  if (ianc.lt.9) then
                      write(ifls,'(i1,8x,a30,2x,a)') ianc+1,           &
     &                                               nameanc(ianc),    &
     &                                              'moles'            
                    else                                               
                      write(ifls,'(i2,7x,a30,2x,a)') ianc+1,           &
     &                                               nameanc(ianc),    &
     &                                              'moles'
                    end if
                end if
              end do
            end if
          
          
        
!c  competitive sorption reactions
         
            if (nsb_ion.gt.0.or.nsb_surf.gt.0) then
              nvarsimrt = nsites+nsb_ion+nsb_surf+1
              do isites = 1,nsites
                ic = iaic(isites)
                  if (b_output_binary) then
                    tec_variables(isites+1) = trim(namec(ic))  
                  else
                    strbuffer = trim(strbuffer)//', "'//               &
                                trim(namec(ic))//'"'
                  end if
                  if (isites+nanc.lt.9) then
                    write(ifls,'(i1,8x,a30,2x,a)') isites+nanc+1,      &
                                                   namec(ic),'moles'    
                  else                                                 
                    write(ifls,'(i2,7x,a30,2x,a)') isites+nanc+1,      &
                                                   namec(ic),'moles'    
                  end if
              end do
              
              do isb = 1,nsb_ion
                  if (b_output_binary) then
                    tec_variables(nsites+isb+1) = trim(namesb_ion(isb)) 
                  else
                    strbuffer = trim(strbuffer)//', "'//               &
                                trim(namesb_ion(isb))//'"'
                  end if
                  
                  if (isb+nsites+nanc.lt.9) then                       
                    write(ifls,'(i1,8x,a30,2x,a)') isb+nsites+nanc+1,  &
                                namesb_ion(isb),'moles'  
                  else                                                 
                    write(ifls,'(i2,7x,a30,2x,a)') isb+nsites+nanc+1,  &
                                namesb_ion(isb),'moles'
                  end if
              end do
              
              do isb = 1,nsb_surf 
                  if (b_output_binary) then
                    tec_variables(nsites+nsb_ion+isb+1) =              &
                        trim(namesb_surf(isb))   
                  else
                    strbuffer = trim(strbuffer)//', "'//               &
                                trim(namesb_surf(isb))//'"'
                  end if
                  if (isb+nsites+nanc.lt.9) then                       
                    write(ifls,'(i1,8x,a30,2x,a)') isb+nsites+nanc+1,  &
                                namesb_surf(isb),'moles'  
                  else                                                 
                    write(ifls,'(i2,7x,a30,2x,a)') isb+nsites+nanc+1,  &
                                namesb_surf(isb),'moles'
                  end if
              end do
              
            end if         !nsb.gt.0 
            
            if (b_output_binary) then                
              strbuffer = 'system mass - sorbed species'  
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),       &
                           trim(strbuffer),offset_imrt(imrt), 1, 1, 1, &
                           .true.,.true.)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(imrt_mpi(imrt),        &
                           nvarsimrt,0,offset_imrt(imrt), .true.,      &
                           .true.) 
            else
              write(imrt,'(a)') trim(strbuffer)            
              write(imrt,'(2a)')                                         &
                    'zone t = "system mass - sorbed species", f=point'
            end if
          
          end if

        end if

!c  total system mass for minerals

        if (nm.gt.0) then    

          imrt = imrt + 1
          if (rank == 0 .and. b_enable_output) then
            if (b_output_binary) then
#ifndef MPI
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call tecplot_binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_o.mms',  &
                           .true.)
            else
              open(imrt,file=prefix(:l_prfx)//'_o.mms',                &
     &                  status='unknown',form='formatted')
            end if
            
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(imrt, "#")
            end if            
            
            if (b_output_binary) then
              nvarsimrt = nm+1
              tec_variables(1:nvarsimrt) = (/"time",(trim(namem(im)),&
                                         im=1, nm)/)
              strbuffer = 'system mass - mineral phase'
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),       &
                           trim(strbuffer),offset_imrt(imrt), 1, 1, 1, &
                           .true.,.true.)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(imrt_mpi(imrt),        &
                           nvarsimrt,0,offset_imrt(imrt), .true.,      &
                           .true.) 
            else
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"' 
              
              strbuffer = 'variables = "time"'
              do im = 1,nm
                strbuffer = trim(strbuffer)//', "'//trim(namem(im))//'"'
              end do
              
              write(imrt,'(a)') trim(strbuffer)            
              write(imrt,'(2a)')                                       &
                    'zone t = "system mass - mineral phase", f=point'
            end if
                                                                        
            write(ifls,'(/a/72a/)') 'system mass - mineral phase',     &
     &                              ('-',i=1,72)                           
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.mms'
                                                                           
            write(ifls,'(2a)')'column   entry                           ',&
     &                        'unit'                                       
            write(ifls,'(2a)')'1        time                            ',&
     &                         time_unit
          
            do im = 1,nm
              if (im.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') im+1,namem(im),'moles'
              else
                write(ifls,'(i2,7x,a30,2x,a)') im+1,namem(im),'moles'
              end if
            end do
          end if

        end if               !(nm.gt.0)

!c  contributions to mass balance - aqueous phase

        if (rank == 0 .and. b_enable_output) then
          write(ifls,'(/a/72a/)')'mass balance - aqueous phase',       &
     &                           ('-',i=1,72)
          write(ifls,'(2a)')'file name                   ','component'
        end if

        do ic = 1,n

          imrt = imrt+1

          if (rank == 0 .and. b_enable_output) then
          !rewind(icnv)      !Deprecated, use internal convert instead. DSU
          if(ic.lt.10) then
            !write(icnv,'(i1)') ic
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i1)') ic
            l_sufx = 1
          elseif (ic.ge.10) then
            !write(icnv,'(i2)') ic
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i2)') ic
            l_sufx = 2
          end if

!c  open file

          if (b_output_binary) then  
#ifndef MPI
            if (imrt_mpi(imrt) < 10) then
              imrt_mpi(imrt) = lun_get()
            end if
#endif
            call tecplot_binary_file_open(PETSC_COMM_SELF,             &
                         imrt_mpi(imrt), prefix(:l_prfx)//'_'//        &
                         suffix(:l_sufx)//'.mac',.true.)
          else
            open(imrt,file=prefix(:l_prfx)//'_'//                      &
     &                     suffix(:l_sufx)//'.mac',status='unknown',   &
     &                form='formatted')
          end if
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(imrt, "#")
          end if
          
          if (b_output_binary) then
            if (ng .gt. 0 .and. gas_advection) then
              nvarsimrt = 26
              tec_variables(1:nvarsimrt) = [character(len=72) ::       &
              "time ["//time_unit(:l_time_unit)//"]",                  &
              "mass influx [mol/d]",                                   &
              "mass outflux [mol/d]",                                  &
              "change in storage [mol/d]",                             &
              "source/sink from intra-aqueous reactns [mol/d]",        &
              "source/sink from mineral phase [mol/d]",                &
              "source/sink from gas phase [mol/d]",                    &
              "mass influx (gas phase) [mol/d]",                       &
              "mass outflux (gas phase) [mol/d]",                      &
              "change in storage (gas phase) [mol/d]",                 &
              "mass loss - degassing [mol/d]",                         &
              "source/sink from sorbed phase [mol/d]",                 &
              "total mass influx [mol/elapsed time]",                  &
              "total mass outflux [mol/elapsed time]",                 &
              "total change in storage [mol/elapsed time]",            &
              "total source/sink intra-aqueous reactns "//             &
              "[mol/elapsed time]",                                    &
              "total source/sink from mineral phase "//                &
              "[mol/elapsed time]",                                    &
              "total source/sink from gas phase "//                    &
              "[mol/elapsed time]",                                    &
              "total mass influx (gas phase) "//                       &
              "[mol/elapsed time]",                                    &
              "total mass outflux (gas phase) [mol/elapsed time]",     &
              "total change in storage (gas phase) "//                 &
              "[mol/elapsed time]",                                    &
              "total mass loss - degassing [mol/elapsed time]",        &
              "total source/sink from sorbed phase "//                 &
              "[mol/elapsed time]",
              "mass influx by advection (gas phase) [mol/d]",          &
              "mass outflux by advection (gas phase) [mol/d]",         &
              "total mass influx by advection (gas phase) "//          &
              "[mol/elapsed time]"]                                    &
            else
              nvarsimrt = 23
              tec_variables(1:nvarsimrt) = [character(len=72) ::       &
              "time ["//time_unit(:l_time_unit)//"]",                  &
              "mass influx [mol/d]",                                   &
              "mass outflux [mol/d]",                                  &
              "change in storage [mol/d]",                             &
              "source/sink from intra-aqueous reactns [mol/d]",        &
              "source/sink from mineral phase [mol/d]",                &
              "source/sink from gas phase [mol/d]",                    &
              "mass influx (gas phase) [mol/d]",                       &
              "mass outflux (gas phase) [mol/d]",                      &
              "change in storage (gas phase) [mol/d]",                 &
              "mass loss - degassing [mol/d]",                         &
              "source/sink from sorbed phase [mol/d]",                 &
              "total mass influx [mol/elapsed time]",                  &
              "total mass outflux [mol/elapsed time]",                 &
              "total change in storage [mol/elapsed time]",            &
              "total source/sink intra-aqueous reactns "//             &
              "[mol/elapsed time]",                                    &
              "total source/sink from mineral phase "//                &
              "[mol/elapsed time]",                                    &
              "total source/sink from gas phase "//                    &
              "[mol/elapsed time]",                                    &
              "total mass influx (gas phase) "//                       &
              "[mol/elapsed time]",                                    &
              "total mass outflux (gas phase) [mol/elapsed time]",     &
              "total change in storage (gas phase) "//                 &
              "[mol/elapsed time]",                                    &
              "total mass loss - degassing [mol/elapsed time]",        &
              "total source/sink from sorbed phase "//                 &
              "[mol/elapsed time]"]
            end if

            write(strbuffer,'(3a)') 'mass balance for component ',     &
                  trim(namec(ic)),' - reactive transport'
            
            offset_imrt(imrt) = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                         imrt_mpi(imrt), "#!TDV102",'dataset '//       &
                         prefix(:l_prfx),offset_imrt(imrt),.true.,     &
                         .true.)                                       
                                                                       
            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         imrt_mpi(imrt), nvarsimrt,                    &
                         tec_variables(1:nvarsimrt),                   &
                         offset_imrt(imrt),.true.,.true.)                 
                                                                       
            call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),         &
                         trim(strbuffer),offset_imrt(imrt), 1, 1, 1,   &
                         .true.,.true.)                                
            offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4            
                                                                       
            call tecplot_binary_write_section(imrt_mpi(imrt),          &
                         nvarsimrt,0,offset_imrt(imrt), .true.,        &
                         .true.) 
          else
            write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            if (ng .gt. 0 .and. gas_advection) then
              write(imrt,'(35a)') 'variables = "time [',               &
               time_unit(:l_time_unit),']", ',                         &
              '"mass influx [mol/d]", ',                               &
              '"mass outflux [mol/d]", ',                              &
              '"change in storage [mol/d]", ',                         &
              '"source/sink from intra-aqueous reactns [mol/d]", ',    &
              '"source/sink from mineral phase [mol/d]", ',            &
              '"source/sink from gas phase [mol/d]", ',                &
              '"mass influx (gas phase) [mol/d]", ',                   &
              '"mass outflux (gas phase) [mol/d]", ',                  &
              '"change in storage (gas phase) [mol/d]", ',             &
              '"mass loss - degassing [mol/d]", ',                     &
              '"source/sink from sorbed phase [mol/d]", ',             &
              '"total mass influx [mol/elapsed time]", ',              &
              '"total mass outflux [mol/elapsed time]", ',             &
              '"total change in storage [mol/elapsed time]", ',        &
              '"total source/sink intra-aqueous reactns ',             &
              '[mol/elapsed time]", ',                                 &
              '"total source/sink from mineral phase ',                &
              '[mol/elapsed time]", ',                                 &
              '"total source/sink from gas phase ',                    &
              '[mol/elapsed time]", ',                                 &
              '"total mass influx (gas phase) ',                       &
              '[mol/elapsed time]", ',                                 &
              '"total mass outflux (gas phase) [mol/elapsed time]", ', &
              '"total change in storage (gas phase) ',                 &
              '[mol/elapsed time]", ',                                 &
              '"total mass loss - degassing [mol/elapsed time]", ',    &
              '"total source/sink from sorbed phase ',                 &
              '[mol/elapsed time]", ',                                 &
              '"mass influx by advection (gas phase) [mol/d]", ',      &
              '"mass outflux by advection (gas phase) [mol/d]", ',     &
              '"total mass influx by advection (gas phase) ',          &
              '[mol/elapsed time]"'
            else
              write(imrt,'(35a)') 'variables = "time [',               &
               time_unit(:l_time_unit),']", ',                         &
              '"mass influx [mol/d]", ',                               &
              '"mass outflux [mol/d]", ',                              &
              '"change in storage [mol/d]", ',                         &
              '"source/sink from intra-aqueous reactns [mol/d]", ',    &
              '"source/sink from mineral phase [mol/d]", ',            &
              '"source/sink from gas phase [mol/d]", ',                &
              '"mass influx (gas phase) [mol/d]", ',                   &
              '"mass outflux (gas phase) [mol/d]", ',                  &
              '"change in storage (gas phase) [mol/d]", ',             &
              '"mass loss - degassing [mol/d]", ',                     &
              '"source/sink from sorbed phase [mol/d]", ',             &
              '"total mass influx [mol/elapsed time]", ',              &
              '"total mass outflux [mol/elapsed time]", ',             &
              '"total change in storage [mol/elapsed time]", ',        &
              '"total source/sink intra-aqueous reactns ',             &
              '[mol/elapsed time]", ',                                 &
              '"total source/sink from mineral phase ',                &
              '[mol/elapsed time]", ',                                 &
              '"total source/sink from gas phase ',                    &
              '[mol/elapsed time]", ',                                 &
              '"total mass influx (gas phase) ',                       &
              '[mol/elapsed time]", ',                                 &
              '"total mass outflux (gas phase) [mol/elapsed time]", ', &
              '"total change in storage (gas phase) ',                 &
              '[mol/elapsed time]", ',                                 &
              '"total mass loss - degassing [mol/elapsed time]", ',    &
              '"total source/sink from sorbed phase ',                 &
              '[mol/elapsed time]"'
            end if

            write(imrt,'(3a)') 'zone t = "mass balance for component ',&
                  trim(namec(ic)),' - reactive transport", f=point'
          end if
          

!c  write data to file information file

          if (l_prfx+l_sufx.eq.2) then
            write(ifls,'(a,21x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic) 
          elseif (l_prfx+l_sufx.eq.3) then
            write(ifls,'(a,20x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.4) then                             
            write(ifls,'(a,19x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.5) then                             
            write(ifls,'(a,18x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.6) then                             
            write(ifls,'(a,17x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.7) then                             
            write(ifls,'(a,16x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.8) then                             
            write(ifls,'(a,15x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.9) then                             
            write(ifls,'(a,14x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.10) then                            
            write(ifls,'(a,13x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.11) then                            
            write(ifls,'(a,12x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.12) then                            
            write(ifls,'(a,11x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.13) then                            
            write(ifls,'(a,10x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.14) then                            
            write(ifls,'(a,9x,a)') prefix(:l_prfx)//'_'//             &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.15) then                            
            write(ifls,'(a,8x,a)') prefix(:l_prfx)//'_'//             &
     &                             suffix(:l_sufx)//'.mac',           &
     &                             namec(ic)               
          end if
          
          end if
        end do
          
        if (rank == 0 .and. b_enable_output) then  

        write(ifls,'(/2a)')                                           &
     &        'column   entry                                   ',    &
     &        'unit'                                                   
        write(ifls,'(2a)')                                            &
     &        '1        time                                    ',    &
     &        time_unit                                                
        write(ifls,'(2a)')                                            &
     &        '2        mass influx                             ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '3        mass outflux                            ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '4        change in storage                       ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '5        source/sink from intra-aqueous reactns  ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '6        source/sink from mineral phase          ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '7        source/sink from gas phase              ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '8        mass influx (gas phase)                 ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '9        mass outflux (gas phase)                ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '10       change in storage (gas phase)           ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '11       mass loss - degassing                   ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '12       source/sink from sorbed phase           ',    &
     &        'mol/day'                                                
        write(ifls,'(2a)')                                            &
     &        '13       total mass influx                       ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '14       total mass outflux                      ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '15       total change in storage                 ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '16       total source/sink intra-aqueous reactns ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '17       total source/sink from mineral phase    ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '18       total source/sink from gas phase        ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '19       total mass influx (gas phase)           ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '20       total mass outflux (gas phase)          ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '21       total change in storage (gas phase)     ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '22       total mass loss - degassing             ',    &
     &        'mol/elapsed time'                                       
        write(ifls,'(2a)')                                            &
     &        '23       total source/sink from sorbed phase     ',    &
     &        'mol/elapsed time'
        if (ng .gt. 0 .and. gas_advection) then
          write(ifls,'(2a)')                                          &
     &        '24       mass influx by advection (gas phase)    ',    &
     &        'mol/day'                                                
          write(ifls,'(2a)')                                          &
     &        '25       mass outflux by advection (gas phase)   ',    &
     &        'mol/day'                                                
          write(ifls,'(2a)')                                          &
     &        '26      total mass influx by advection(gas phase)',    &
     &        'mol/elapsed time'                                       
         
        end if
        
        end if

!c  mass balance error - aqueous phase

        if (rank == 0 .and. b_enable_output) then
          write(ifls,'(/a/72a/)')'mass balance error - aqueous phase', &
     &                           ('-',i=1,72)          
          write(ifls,'(a)')'file name                   component'
        end if

        do ic = 1,n

          imrt = imrt+1

          if (rank == 0 .and. b_enable_output) then
          !rewind(icnv)      !Deprecated, use internal convert instead. DSU
          if(ic.lt.10) then
            !write(icnv,'(i1)') ic
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i1)') ic
            l_sufx = 1
          elseif (ic.ge.10) then
            !write(icnv,'(i2)') ic
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i2)') ic
            l_sufx = 2
          end if

          if (b_output_binary) then
#ifndef MPI
            if (imrt_mpi(imrt) < 10) then
              imrt_mpi(imrt) = lun_get()
            end if
#endif
            call tecplot_binary_file_open(PETSC_COMM_SELF,             &
                         imrt_mpi(imrt), prefix(:l_prfx)//'_'//        &
                         suffix(:l_sufx)//'.mae',.true.)
          else
            open(imrt,file=prefix(:l_prfx)//'_'//                      &
     &                     suffix(:l_sufx)//'.mae',status='unknown',   &
     &                form='formatted')
          end if
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(imrt, "#")
          end if
          
          if (b_output_binary) then
            nvarsimrt = 5
            tec_variables(1:nvarsimrt) = (/                            &
                "time ["//time_unit(:l_time_unit)//"]",                &
                "absolute mass balance error [mol]",                   &
                "relative mass balance error [% of system mass]",      &
                "absolute cumulative mass balance error [mol] ",       &
                "relative cumulative mass balance error "//            &
                "[% of system mass]"                  /)
            write(strbuffer,'(3a)')                                    &
                  'mass balance error for component ',                 &
                  trim(namec(ic)),' - reactive transport'
            
            offset_imrt(imrt) = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                         imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                         prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                         .true.)  
            
            call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                         imrt_mpi(imrt), nvarsimrt,                  &
                         tec_variables(1:nvarsimrt),                 &
                         offset_imrt(imrt),.true.,.true.)               
            
            call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),       &
                         trim(strbuffer),offset_imrt(imrt), 1, 1, 1, &
                         .true.,.true.)
            offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
            
            call tecplot_binary_write_section(imrt_mpi(imrt),        &
                         nvarsimrt,0,offset_imrt(imrt), .true.,      &
                         .true.) 
          else
            write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(imrt,'(11a)') 'variables = "time [',                 &
     &              time_unit(:l_time_unit),']", ',                    &
     &             '"absolute mass balance error [mol]", ',            &
     &             '"relative mass balance error ',                    &
     &             '[% of system mass]", ',                            &
     &             '"absolute cumulative mass balance error ',         &
     &             '[mol] ", ',                                        &
     &             '"relative cumulative mass balance error ',         &
     &             '[% of system mass]"'                               
            write(imrt,'(3a)')                                         &
     &            'zone t = "mass balance error for component ',       &
     &            trim(namec(ic)),' - reactive transport", f=point'
          end if
                                                                       
          if (l_prfx+l_sufx.eq.2) then                                 
            write(ifls,'(a,21x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.3) then                             
            write(ifls,'(a,20x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.4) then                             
            write(ifls,'(a,19x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.5) then                             
            write(ifls,'(a,18x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.6) then                             
            write(ifls,'(a,17x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.7) then                             
            write(ifls,'(a,16x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.8) then                             
            write(ifls,'(a,15x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.9) then                             
            write(ifls,'(a,14x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.10) then                            
            write(ifls,'(a,13x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.11) then                            
            write(ifls,'(a,12x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.12) then                            
            write(ifls,'(a,11x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.13) then                            
            write(ifls,'(a,10x,a)') prefix(:l_prfx)//'_'//            &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.14) then                            
            write(ifls,'(a,9x,a)') prefix(:l_prfx)//'_'//             &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)                           
          elseif (l_prfx+l_sufx.eq.15) then                            
            write(ifls,'(a,8x,a)') prefix(:l_prfx)//'_'//             &
     &                             suffix(:l_sufx)//'.mae',           &
     &                             namec(ic)
          end if
          
          end if

        end do

        if (rank == 0 .and. b_enable_output) then
          write(ifls,'(/2a)') 'column   entry                           ',&
     &                        'unit'                                       
          write(ifls,'(2a)')  '1        time                            ',&
     &                         time_unit                                   
          write(ifls,'(2a)')  '2        absolute mass balance error     ',&
     &                        'moles'                                      
          write(ifls,'(2a)')  '3        relative mass balance error     ',&
     &                        '% = moles/moles in system x 100'            
          write(ifls,'(2a)')  '4        accumulative absolute mass      ',&
     &                        'moles'                                      
          write(ifls,'(a)')   '         balance error'                     
          write(ifls,'(2a)')  '5        accumulative relative mass      ',&
     &                        '% = moles/moles in system x 100'
          write(ifls,'(a)')   '         balance error'
        end if

!c  contributions to mass balance - selected species

        if (nmb.gt.0) then

          if (rank == 0 .and. b_enable_output) then  
            write(ifls,'(/a/72a/)')'mass balance - selected species',  &
     &                             ('-',i=1,72)
            write(ifls,'(2a)')'file name         ','species'
          end if

          do imb = 1,nmb

            imrt = imrt+1

            if (rank == 0 .and. b_enable_output) then
            !rewind(icnv)            !Deprecated, use internal convert instead. DSU
            if(imb.lt.10) then
              !write(icnv,'(i1)') imb
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i1)') imb
              l_sufx = 1
            elseif (imb.ge.10) then
              !write(icnv,'(i2)') imb
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i2)') imb
              l_sufx = 2
            end if

!c  open file

            if (b_output_binary) then  
#ifndef MPI
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call tecplot_binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_'//      &
                           suffix(:l_sufx)//'.msc',.true.)
            else
              open(imrt,file=prefix(:l_prfx)//'_'//                    &
     &                       suffix(:l_sufx)//'.msc',status='unknown', &
     &                  form='formatted')
            end if  
            
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(imrt, "#")
            end if            
            
            if (b_output_binary) then
              nvarsimrt = 7
              tec_variables(1:nvarsimrt) = (/                          &
                  "time ["//time_unit(:l_time_unit)//"]",              &
                  "mass influx [mol/d]",                               &
                  "mass outflux [mol/d]",                              & 
                  "change in storage [mol/d]",                         &
                  "source/sink from redox reactns [mol/d]",            &
                  "source/sink from mineral phase [mol/d]",            &
                  "source/sink from gas phase [mol/d]"/)
              write(strbuffer,'(3a)') 'contributions to mass ',        &
                    'balance for ', trim(namemb(imb))
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),       &
                           trim(strbuffer),offset_imrt(imrt), 1, 1, 1, &
                           .true.,.true.)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(imrt_mpi(imrt),        &
                           nvarsimrt,0,offset_imrt(imrt), .true.,      &
                           .true.) 
            else
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'             
              write(imrt,'(9a)') 'variables = "time [',                &
                     time_unit(:l_time_unit),']", ',                   &
                    '"mass influx [mol/d]", ',                         &
                    '"mass outflux [mol/d]", ',                        & 
                    '"change in storage [mol/d]", ',                   &
                    '"source/sink from redox reactns [mol/d]", ',      &
                    '"source/sink from mineral phase [mol/d]", ',      &
                    '"source/sink from gas phase [mol/d]"'
              write(imrt,'(4a)') 'zone t = "contributions to mass ',   &
                    'balance for ', trim(namemb(imb)), '", f=point'
            end if

!c  write data to file information file

            if(imb.lt.10) then
              write(ifls,'(a,6x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.msc',         &
     &                               namemb(imb)                       
            elseif (imb.ge.10) then                                    
              write(ifls,'(a,5x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.msc',         &
     &                               namemb(imb) 
            end if
            
            end if
            
          end do

          if (rank == 0 .and. b_enable_output) then
            write(ifls,'(/a)')                                            &
            'column   entry                           unit'                
            write(ifls,'(2a)')'1        time                            ',&
                              time_unit                                    
            write(ifls,'(2a)')'2        mass influx                     ',&
                              'moles/day'                                  
            write(ifls,'(2a)')'3        mass outflux                    ',&
                              'moles/day'                                  
            write(ifls,'(2a)')'4        change in storage               ',&
                              'moles/day'                                  
            write(ifls,'(2a)')'5        source/sink from redox reactns  ',&
                              'moles/day'                                  
            write(ifls,'(2a)')'6        source/sink from mineral phase  ',&
                              'moles/day'                                  
            write(ifls,'(2a)')'7        source/sink from gas phase      ',&
                              'moles/day'
          end if

        end if

!c  contributions to mass balance due to intra-aqueous kinetic reactions

        if (naq.gt.0) then

          if (rank == 0 .and. b_enable_output) then  
            write(ifls,'(/2a/72a/)')'mass balance contributions - ',   &
     &                              'intra-aqueous kinetic reactions', &
     &                              ('-',i=1,72)
            write(ifls,'(2a)')'file name         ','reaction'
          end if

          do iaq = 1,naq

            imrt = imrt+1
            
            if (rank == 0 .and. b_enable_output) then 
            !rewind(icnv)            !Deprecated, use internal convert instead. DSU
            if(iaq.lt.10) then
              !write(icnv,'(i1)') iaq
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i1)') iaq
              l_sufx = 1
            elseif (iaq.ge.10) then
              !write(icnv,'(i2)') iaq
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i2)') iaq
              l_sufx = 2
            end if

!c  open file

            if (b_output_binary) then
#ifndef MPI
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call tecplot_binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_'//      &
                           suffix(:l_sufx)//'.mic',.true.)
            else
              open(imrt,file=prefix(:l_prfx)//'_'//                    &
                             suffix(:l_sufx)//'.mic',status='unknown', &
                             form='formatted')
            end if
            
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(imrt, "#")
            end if            
            
            if (b_output_binary) then
              nvarsimrt = 3
              tec_variables(1:nvarsimrt) = (/                          &
                  "time ["//time_unit(:l_time_unit)//"]",              &
                  "total rate [mol/d]", "total contribution [mol]"/)
              write(strbuffer,'(3a)')                                  & 
                 'mass balance contributions ',                        &
                 '- intra-aqueous kinetic reactions for ',             &
                 trim(nameaq(iaq))
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),       &
                           trim(strbuffer),offset_imrt(imrt), 1, 1, 1, &
                           .true.,.true.)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(imrt_mpi(imrt),        &
                           nvarsimrt,0,offset_imrt(imrt), .true.,      &
                           .true.) 
            else
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'             
              write(imrt,'(5a)') 'variables = "time [',                &
                     time_unit(:l_time_unit),']", ',                   &
                    '"total rate [mol/d]", ',                          &
                    '"total contribution [mol]"'
              write(imrt,'(4a)')                                       & 
                 'zone t = "mass balance contributions ',              &
                 '- intra-aqueous kinetic reactions for ',             &
                    trim(nameaq(iaq)), '", f=point'
            end if
            

!c  write data to file information file

            if(iaq.lt.10) then
              write(ifls,'(a,7x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mic',         &
     &                               nameaq(iaq)
            elseif (iaq.ge.10) then
              write(ifls,'(a,6x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mic',         &
     &                               nameaq(iaq)
            end if
            
            end if
          end do

          if (rank == 0 .and. b_enable_output) then
            write(ifls,'(/a)')                                            &
     &      'column   entry                           unit'                
            write(ifls,'(2a)')'1        time                            ',&
     &                        time_unit                                    
            write(ifls,'(2a)')'2        total rate                      ',&
     &                        'moles/day'                                  
            write(ifls,'(2a)')'3        total contribution              ',&
     &                        'moles'
          end if
        end if

!c  contributions to mass balance - gaseous phase

        if (ng.ne.0) then

          if (rank == 0 .and. b_enable_output) then
            write(ifls,'(/a/72a/)')'mass balance - gaseous phase',     &
     &                             ('-',i=1,72)
            write(ifls,'(a)')'file name         gas'
          end if

          do ig = 1,ng

            imrt = imrt+1
            
            if (rank == 0 .and. b_enable_output) then
            !rewind(icnv)             !Deprecated, use internal convert instead. DSU
            if(ig.lt.10) then
              !write(icnv,'(i1)') ig
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i1)') ig
              l_sufx = 1
            elseif (ig.ge.10) then
              !write(icnv,'(i2)') ig
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i2)') ig
              l_sufx = 2
            end if

            if (b_output_binary) then  
#ifndef MPI
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call tecplot_binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_'//      &
                           suffix(:l_sufx)//'.mgc',.true.)
            else
              open(imrt,file=prefix(:l_prfx)//'_'//                    &
                             suffix(:l_sufx)//'.mgc',status='unknown', &
                        form='formatted')
            end if
            
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(imrt, "#")
            end if            
            
            if (b_output_binary) then
              nvarsimrt = 9
              tec_variables(1:nvarsimrt) = (/                          &
                  "time ["//time_unit(:l_time_unit)//"]",              &
                  "mass influx [mol/d]",                               &
                  "mass outflux [mol/d]",                              & 
                  "mass influx by gas advection [mol/d]",              &
                  "mass outflux by gas advection [mol/d]",             & 
                  "mass flux across top boundary [mol/d]",             &
                  "change in storage [mol/d]",                         &
                  "source/sink - aqueous phase [mol/d]",               &
                  "mass loss - degassing [mol/d]"'/)
              write(strbuffer,'(3a)') 'mass balance - gaseous ',       
                    'phase for ', trim(nameg(ig))
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),       &
                           trim(strbuffer),offset_imrt(imrt), 1, 1, 1, &
                           .true.,.true.)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(imrt_mpi(imrt),        &
                           nvarsimrt,0,offset_imrt(imrt), .true.,      &
                           .true.) 
            else
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'             
              write(imrt,'(11a)') 'variables = "time [',               &
                     time_unit(:l_time_unit),']", ',                   &
                    '"mass influx [mol/d]", ',                         &
                    '"mass outflux [mol/d]", ',                        & 
                    '"mass influx by gas advection [mol/d]", ',        &
                    '"mass outflux by gas advection [mol/d]", ',       & 
                    '"mass flux across top boundary [mol/d]", ',       &
                    '"change in storage [mol/d]", ',                   &
                    '"source/sink - aqueous phase [mol/d]", ',         &
                    '"mass loss - degassing [mol/d]"'
              write(imrt,'(4a)') 'zone t = "mass balance - gaseous ',  &
                    'phase for ', trim(nameg(ig)), '", f=point'
            end if
                                                                       
            if(ig.lt.10) then                                          
              write(ifls,'(a,6x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mgc',         &
     &                               nameg(ig)                         
            elseif (ig.ge.10) then                                     
              write(ifls,'(a,5x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mgc',         &
     &                               nameg(ig)                         
            end if
            
            end if
                                                                       
          end do                !(i=1,ng)
          
          if (rank == 0 .and. b_enable_output) then                                                                       
            write(ifls,'(/a)')                                         &
     &            'column   entry                           unit'       
            write(ifls,'(2a)')                                         &
     &            '1        time                            ',time_unit 
            write(ifls,'(a)')                                          &
     &            '2        mass influx                     mol/day'    
            write(ifls,'(a)')                                          &
     &            '3        mass outflux                    mol/day'    
            write(ifls,'(a)')                                          &
     &            '4        mass influx by gas advection    mol/day'    
            write(ifls,'(a)')                                          &
     &            '5        mass outflux by gas advection   mol/day'    
            write(ifls,'(a)')                                          &
     &            '6        mass flux across top boundary   mol/day'    
            write(ifls,'(a)')                                          &
     &            '7        change in storage               mol/day'    
            write(ifls,'(a)')                                          &
     &            '8        source/sink - aqueous phase     mol/day'    
            write(ifls,'(a)')                                          &
     &            '9        mass loss - degassing           mol/day'
          end if

        end if                !(ng.ne.0)

!c  contributions to mass balance - mineral phase

        if (nm.ne.0) then

          if (rank == 0 .and. b_enable_output) then  
            write(ifls,'(/a/72a/)')'mass balance - mineral phase',     &
     &                             ('-',i=1,72)
            write(ifls,'(a)')'file name         mineral'
          end if

          do im = 1,nm        !loop over minerals

            imrt = imrt+1

            if (rank == 0 .and. b_enable_output) then  
            !rewind(icnv)           !Deprecated, use internal convert instead. DSU
            if(im.lt.10) then
              !write(icnv,'(i1)') im
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i1)') im
              l_sufx = 1
            elseif (im.ge.10) then
              !write(icnv,'(i2)') im
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i2)') im
              l_sufx = 2
            end if

            if (b_output_binary) then  
#ifndef MPI
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call tecplot_binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_'//      &
                           suffix(:l_sufx)//'.mmc',.true.)
            else
              open(imrt,file=prefix(:l_prfx)//'_'//                    &
                             suffix(:l_sufx)//'.mmc',status='unknown', &
                        form='formatted')
            end if
            
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(imrt, "#")
            end if            
            
            if (b_output_binary) then
              nvarsimrt = 6
              tec_variables(1:nvarsimrt) = (/                          &
                  "time ["//time_unit(:l_time_unit)//"]",              &
                  "change in storage [mol/d]",                         &
                  "source/sink - aqueous phase [mol/d]",               & 
                  "total contribution [mol]",                          &
                  "source/sink - aqueous phase "//                     &
                  "parallel reaction pathways [mol/d]",                &
                  "total contribution "//                              &
                  "parallel reaction pathways [mol/d]"/)
              write(strbuffer,'(4a)') 'mass balance - mineral ',       &
                    'phase for ', trim(namem(im))
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(imrt_mpi(imrt),       &
                           trim(strbuffer),offset_imrt(imrt), 1, 1, 1, &
                           .true.,.true.)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(imrt_mpi(imrt),        &
                           nvarsimrt,0,offset_imrt(imrt), .true.,      &
                           .true.) 
            else
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'             
              write(imrt,'(10a)') 'variables = "time [',               &
                     time_unit(:l_time_unit),']", ',                   &
                    '"change in storage [mol/d]", ',                   &
                    '"source/sink - aqueous phase [mol/d]", ',         & 
                    '"total contribution [mol]", ',                    &
                    '"source/sink - aqueous phase ',                   &
                      'parallel reaction pathways [mol/d]", ',         &
                    '"total contribution ',                            &
                      'parallel reaction pathways [mol/d]"'
              write(imrt,'(4a)') 'zone t = "mass balance - mineral ',  &
                    'phase for ', trim(namem(im)), '", f=point'
            end if
                                                                       
            if (l_prfx+l_sufx.eq.2) then                               
              write(ifls,'(a,11x,a)') prefix(:l_prfx)//'_'//          &
     &                               suffix(:l_sufx)//'.mmc',         &
     &                               namem(im)                         
            elseif (l_prfx+l_sufx.eq.3) then                           
              write(ifls,'(a,10x,a)') prefix(:l_prfx)//'_'//          &
     &                               suffix(:l_sufx)//'.mmc',         &
     &                               namem(im)                         
            elseif (l_prfx+l_sufx.eq.4) then                           
              write(ifls,'(a,9x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mmc',         &
     &                               namem(im)                         
            elseif (l_prfx+l_sufx.eq.5) then                           
              write(ifls,'(a,8x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mmc',         &
     &                               namem(im)                         
            elseif (l_prfx+l_sufx.eq.6) then                           
              write(ifls,'(a,7x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mmc',         &
     &                               namem(im)                         
            elseif (l_prfx+l_sufx.eq.7) then                           
              write(ifls,'(a,6x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mmc',         &
     &                               namem(im)                         
            elseif (l_prfx+l_sufx.eq.8) then                           
              write(ifls,'(a,5x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mmc',         &
     &                               namem(im)                         
            elseif (l_prfx+l_sufx.eq.9) then                           
              write(ifls,'(a,4x,a)') prefix(:l_prfx)//'_'//           &
     &                               suffix(:l_sufx)//'.mmc',         &
     &                               namem(im)                         
            end if
            
            end if
                                                                       
          end do           !(im=1,nm)
          
          if (rank == 0 .and. b_enable_output) then                   
            write(ifls,'(/a)')                                         &
     &            'column   entry                           unit'       
            write(ifls,'(2a)')                                         &
     &            '1        time                            ',time_unit 
            write(ifls,'(a)')                                          &
     &            '2        change in storage               moles/day'  
            write(ifls,'(a)')                                          &
     &            '3        source/sink - aqueous phase     moles/day'  
            write(ifls,'(a)')                                          &
     &            '4        total contribution              moles'      
            write(ifls,'(a/a)')                                        &
     &            '5 -      source/sink - aqueous phase     moles/day',&
     &            '5+Np-1   parallel reaction pathways               '  
            write(ifls,'(a/a)')                                        &
     &            '5+Np -   total contribution              moles',    &
     &            '5+2*Np-1 parallel reaction pathways               '
          end if
 
        end if             !(nm.gt.0)

!c  pointer to last mass balance file for reactive transport

        imrt_last = imrt

      end if

      return
      end
