!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/ddbdflux.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c real*8 function ddbdflux
!c ------------------------
!c
!c !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!c have to add storage here ...... for transient conditions
!c i.e. do local mass balance ....(only needed for seepage face in case 
!c switching bewteen types)
!c !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!c compute water flux across boundary control volumes
!c calculates water volume flux (not water mass flux)
!c
!c modified from Uli Mayer template
!c
!c written by:      Tom Henderson - October 22, 2002
!c
!c last modified:   Tom Henderson - January 30, 2003
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           ddbdflux           = water flux across boundary face     * + 
!c
!c           integer*4:
!c           ----------
!c           ivol               = pointer to current control volume   + -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           bcondvs(nbvs)      = boundary condition                  + -
!c                                (pressure head or flux) or
!c                                identification of seepage face
!c                                boundary type
!c           cinfvs(njavs)      = influence coefficients              + -
!c           relperm(nn)        = relative permeability               + -
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           vsflux(ncon-1)     = interfacial fluxes                  + -
!c
!c           integer*4:
!c           ----------
!c           iabvs(nbvs)        = pointer to boundary control volumes + -
!c                                for variably saturated flow
!c           iavs(nn+1)         = row pointer array for avs           + -
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, logbook                + -
!c           iups(ncon-1)       = upstream pointer array              + -
!c           javs(njavs)        = connectivity list                   + -
!c           nbvs               = number of specified boundary        + -
!c                                control volumes
!c                                (variably saturated flow)
!c           njavs              = number of global connections        + -
!c           nn                 = total number of control volumes     + -
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           upstream           = .true.  -> upstream weighting       + -
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c
!c           character:
!c           ----------
!c           btypevs(nbvs)      = boundary type array                 + -
!c                                (variably saturated flow)
!c                                'first'   = Dirichlet
!c                                'second'  = Neumann
!c                                'seepage' = seepage face
!c
!c
!c dens.f:   real*8:
!c           -------
!c           pressure(nn)       = fluid pressure                      + - 
!c           density(nn)        = fluid density                       + -  
!c           viscosity(nn)      = fluid viscosity                     + -
!c           dvolcoef           = volume flux coefficient             + -
!c                                (viscosity, relative k)
!c                                viscosity, and relative 
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c        
!c           integer*4:
!c           ----------
!c           i1                 = counter (row entries)
!c           ibvs               = counter (boundary control 
!c                                volumes)
!c           icon               = counter (off-diagonal 
!c                                connections)
!c           iend               = pointer (end)
!c           istart             = pointer (start) 
!c           jvol               = pointer (column in 1d-scalar 
!c                                matrix)
!c
!c           logical:
!c           --------
!c           found              = logical variable to exit
!c                                search
!c
!c external: fluxdd    = water flux at interface for density
!c                       dependent flow
!c ----------------------------------------------------------------------
 
      real*8 function ddbdflux(ivol)
 
      use parm
      use gen
      use dens
#ifdef PETSC      
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      implicit none
      
      integer :: ivol
      
      integer :: i1, ibvs, icon, istart, iend, jvol
      real*8 :: delp_dd, delz_dd, fluxdd
      
      real(type_r8) :: rho_av_loc
      real(type_r8) :: dvolcoef_loc
      real(type_r8) :: vsflux_icon_loc

      real*8, parameter :: r0 = 0.0d0, rhalf = 0.5d0, r1 = 1.0d0 

      external fluxdd

      ddbdflux = r0             !initialize boundary flux
      ibvs = ivol2bvs(ivol)
      
      if (ibvs == 0) then
        return
      end if

!      if (ibvs == 0) then
!        if (rank == 0) then  
!          write(ilog,*) ' warning .....................'
!          write(ilog,*) ' no water flux across boundary'
!          !write(igen,*) ' warning .....................'
!          !write(igen,*) ' no water flux across boundary'
!        end if
!#ifdef PETSC
!        call petsc_mpi_finalize
!#endif
!        stop 
!      end if


!c  compute water flux across boundary

!c  fluxes at first type control volumes or zero pressure seepage
!c  control volumes

      if ((btypevs(ibvs).eq.'first').or.    &  !first type (Dirichlet)
        ((btypevs(ibvs).eq.'seepage').and.  &  !first type (seepage)
         (bcondvs(ibvs).lt.r0))) then

        istart = iavs(ivol)+1     !pointer - start of row
        iend = iavs(ivol+1)-1     !pointer - end of row
        icon = 0                  !counter (connections)

        do i1=istart,iend         !loop over connections

          jvol = javs(i1)         !column pointer
          icon = icon+1           !counter (connections)

          delp_dd = uvsnew(jvol) - uvsnew(ivol)
          delz_dd = zg(jvol) - zg(ivol)

          if (delz_dd .ne. r0) then
            rho_av_loc = rhalf * (density(ivol) + density(jvol))

!c  convert delz_dd to total elevation potential wrt fluid pressure
!c  and calculate difference in total pressure potential
 
            delz_dd = delz_dd * rho_av_loc * gacc
            delp_dd = delp_dd + delz_dd
    
          end if
            
!c  assign coefficients for upstream weighting
!c calculate water volume (not mass!!) fluxes
!cprovi-----------------------------------------------------------                   
!cprovi We have changed this 
!cprovi-----------------------------------------------------------                   
          if (variably_saturated) then
            
            if (delp_dd .gt. r0) then
            if (density_dependence) then 
             dvolcoef_loc = relperm(jvol)/viscosity(jvol)       
            else
             dvolcoef_loc = relperm(jvol)/1.0d-3 
            end if
            else          
             if (density_dependence) then 
               dvolcoef_loc = relperm(ivol)/viscosity(ivol)          
             else
               dvolcoef_loc = relperm(ivol)/1.0d-3 
             end if 
            end if
!cprovi-----------------------------------------------------------                   
!cprovi-----------------------------------------------------------                   
!cprovi-----------------------------------------------------------                   
        else if (fully_saturated) then  ! THH sept 8 03
            
            if (delp_dd .gt. r0) then
            if (density_dependence) then  
              dvolcoef_loc = r1/viscosity(jvol)       
            else
              dvolcoef_loc = r1/1.0d-3 
            end if
            else          
            if (density_dependence) then  
              dvolcoef_loc = r1/viscosity(ivol)
            else          
              dvolcoef_loc = r1/1.0d-3 
            end if 
            end if

        end if
!cprovi-----------------------------------------------------------                   
!cprovi-----------------------------------------------------------                   
!cprovi-----------------------------------------------------------                   
            vsflux_icon_loc = - fluxdd(delp_dd,cinfvs_a(i1), &
                              dvolcoef_loc) 

!c  water volume (not mass!) flux calculations

!            ddbdflux = ddbdflux + vsflux(icon)
            ddbdflux = ddbdflux + vsflux_icon_loc

        end do                    !loop over connections

!c        write(idbg,*) 'ddbdryflux',ddbdflux

!c  fluxes at specified flux control volumes

      elseif ((btypevs(ibvs).eq.'second') .or. &
           (btypevs(ibvs).eq.'point')) then   

        if (b_water_freezing) then
          if (tempnew(ivol) > water_freezing_temper) then
            ddbdflux = bcondvs(ibvs)
          else
            ddbdflux = 0.0d0
          end if
        else
          ddbdflux = bcondvs(ibvs)
        end if
        continue

      end if                      !boundary type (flow)
 
      return
      end
