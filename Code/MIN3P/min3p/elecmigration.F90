!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/elecmigration.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine elecmigration
!c -------------------
!c
!c compute the electric potential for aqueous component electrostatic 
!c based on concentrations of free species and secondary aqueous species
!c
!c written by:      Pejman Rasouli - June 03, 2010
!c
!c last modified:   Pejman Rasouli - September 06, 2012
!c                 Electromigration term is computeted here
!c                 and the transport equation converted to
!c                 Nersnst-Planck equation 
!c                   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                   I O
!c passed:   real*8:
!c          -------
!c          c(nc)              = concentrations of free species      + -
!c                               [moles/l water]
!c          cx(nx)             = concentrations of secondary aqueous + -
!c                               species [moles/l water]
!c
!c common:
!c chem.f:   real*8:
!c          -------
!c          xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                               for formation of secondary aqueous
!c                               species from free species
!c
!c          integer*4:
!c          ----------
!c          n!c                = number of components including h2o  + -
!c          nx                 = number of secondary aqueous species + -
!c
!c local:    integer*4:
!c          ----------
!c          i                  = counter (stoichiometric
!c                               coefficients)
!c          ic                = counter (components)
!c          ix                 = counter (secondary aqueous species) 
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine elecmigration(cd_ivol,cdx_ivol,cd_jvol,cdx_jvol,    &
     &                         diff_cof_ic,diff_cof_ix,            &
     &                         elcmig,vel,ivol_loc)
 !MX    &                         elcmig,vel,ecur_ivol,ivol_loc)     
     
      use parm
      use chem
      use gen
!MX      use MCDFunctions
 
      implicit none
      
      real*8 :: zc_loc, zc_locj, Dzdeltac_loc, Dz2c_loc, Dz2c_loci,    &
                Dz2c_locj, zx_loc, zx_loci, zx_locj, Dzdeltax_loc,     &
                Dz2x_loc, Dz2x_loci, Dz2x_locj, fluxd
      
      integer :: i, ic, ix, istart, iend, ivol_loc, info_debug
      
      external fluxd 
      
      real*8, parameter :: small = 1.0d-10, tiny = 5.0d-2, r0 = 0.0d0,&
     &                     r1 = 1.0d0, r5 = 5.0d-1
           
      real*8 :: diff_cof_ic(nc),diff_cof_ix(nx),Dz2c_locjj(nc),           &
     &      Dz2c_locii(nc), Dzdeltac_locii(nc), zc_loci(nc)                    ! Dz2c_locj(nc), Dz2c_loc(nc)
      
      real*8 :: cd_ivol(nc),cdx_ivol(nx),cd_jvol(nc),cdx_jvol(nx),        &
     &          elcmig(nc),elcmigx(nx), vel
    

!c Initialize local variables for electromigration term

!c Components Parameters 

!c    Scaler Parameters
      zc_loc = r0
      zc_loci = r0
      zc_locj = r0
      Dzdeltac_loc = r0
!c    Vector Parameters 
      Dzdeltac_locii = r0
      
!c    Vector Parameters      
      Dz2c_locii = r0
      Dz2c_locjj = r0
!c    Scaler Parameters       
      Dz2c_loc = r0
      Dz2c_loci = r0
      Dz2c_locj = r0
      
      elcmig = r0

!c Complexes Parameters      

      zx_loc = r0
      zx_loci = r0
      zx_locj = r0
      Dzdeltax_loc = r0
      Dz2x_loc = r0
      Dz2x_loci = r0
      Dz2x_locj = r0
      elcmigx = r0

!c  Craps for Now!!!

!MX      faraday = 9.64846d4
!MX      e_current = ecur_ivol / faraday
  

! prc -----------------------------------------------------------------------------
! prc -----------------------------------------------------------------------------
! prc Computing electromigration flux for free species using Lichtner formulation
! prc -----------------------------------------------------------------------------
! prc -----------------------------------------------------------------------------  


!      if (time > 1.0) then
!        elcmigx = r0
!      endif

!c free species


!c Calculating Sigma_D_z^2_C for the current cvolume

      do ic=1,nc-1          ! loop over free species 
              
         Dz2c_locii(ic) = diff_cof_ic(ic)*          &
     &                    chargec(ic) * cd_ivol(ic)

         Dz2c_locjj(ic) = diff_cof_ic(ic)*          &
     &                    chargec(ic) * cd_jvol(ic)     
      
!c This is for advection; Crap for now !!!
         
         zc_loci(ic) = zc_loci(ic) + cd_ivol(ic)           
                                                       
      end do                ! loop over free species
            
      
      if (nx>0) then
                
!c add up aqueous complexes
 
      do ix=1,nx            ! ix loop over complexes
        istart = iax(ix)
        iend = iax(ix+1)-1
        do i = istart,iend  ! i loop
          ic = jax(i)
 
!c skip h2o, h+1 and oh- since electromig considers other sps

!!!!!!!!!!!!!!!!!!!! Dz2x_loc needs to be like Dz2x_loc(ix)??????????????
!!!!!!!!!!!!!!!!!!!! Dz2c_loc needs to be like Dz2c_loc(ic)??????????????
  
          if (namec(ic).ne.'h2o') then   
             Dz2c_locii(ic) = Dz2c_locii(ic) +             &
     &                        xnux(i) * diff_cof_ix(ix)*     & 
     &                        chargex(ix) * cdx_ivol(ix)
             Dz2c_locjj(ic) = Dz2c_locjj(ic) +             &
     &                        xnux(i) * diff_cof_ix(ix)*      &
     &                        chargex(ix) * cdx_jvol(ix)
             zc_loci(ic) = zc_loci(ic) + xnux(i) * cdx_jvol(ix)
          
          end if
        end do              ! i loop
      end do                ! ix loop over complexes 
      
      endif !      if (nx>0) then
                                                                    
       
!c Calculating Sigma_D_z_Delta_C for the current cvolume

      do ic=1,nc-1          ! loop over free species
                                                                 
         Dzdeltac_locii(ic) =  diff_cof_ic(ic)*        &
     &                         fluxd(cd_ivol(ic),    &
     &                         cd_jvol(ic),r1)     
         
      end do                ! loop over free species
      

      if (nx>0) then
     
!c add up aqueous complexes
 
      do ix=1,nx            ! ix loop over complexes
        istart = iax(ix)
        iend = iax(ix+1)-1
        do i = istart,iend  ! i loop
          ic = jax(i)
 
!c skip h2o, h+1 and oh- since electromig considers other sps    !?MX h+1 and oh- should be considered
!!!!!!!!!!!!!!!!!!!! Dzdeltax_loc needs to be like Dzdeltax_loc(ix)
!!!!!!!!!!!!!!!!!!!! Dzdeltac_loc needs to be like Dzdeltac_loc(ic)

          if (namec(ic).ne.'h2o') then   
             Dzdeltac_locii(ic) = Dzdeltac_locii(ic) +             &
     &                            xnux(i) * (diff_cof_ix(ix))*        &
     &                            fluxd(cdx_ivol(ix),cdx_jvol(ix),r1)
          end if
        end do              ! i loop
      end do                ! ix loop over complexes 
     
      endif !(nx>0)   
           
!c Assembaling Drift term for the current cvolume

      do ic=1,nc-1          ! loop over free species 
              
         Dz2c_loci = Dz2c_loci + chargec(ic) * Dz2c_locii(ic)
         Dz2c_locj = Dz2c_locj + chargec(ic) * Dz2c_locjj(ic)
         Dzdeltac_loc = Dzdeltac_loc + chargec(ic) * Dzdeltac_locii(ic)
         zc_loc = zc_loc + chargec(ic)* zc_loci(ic)
         
      enddo    

      
      Dz2c_loc = r5 * (Dz2c_loci + Dz2c_locj)
!      Dz2c_loc = ArithmeticMean(Dz2c_loci,Dz2c_locj)
!      Dz2c_loc = HarmonicMean(Dz2c_loci,Dz2c_locj)      
!      zc_loc = r5 * (zc_loci + zc_locj)

!c Calculating Sigma_D_z_Delta_X for the current cvolume
    if (Dz2c_loc .ne. 0.0) then
      do ic=1,nc-1          ! loop over free species
      
        elcmig(ic) = r5 * diff_cof_ic(ic) * chargec(ic)*    &
     &              (cd_ivol(ic) + cd_jvol(ic)) *         &
     &              (Dzdeltac_loc - zc_loc*vel)/Dz2c_loc
!MX     &              (e_current + Dzdeltac_loc - zc_loc*vel)/Dz2c_loc
        
!        elcmig(ic) = diff_cof_ic(ic) * chargec(ic)*
!     &              ArithmeticMean(cd_ivol(ic),cd_jvol(ic)) * 
!     &              Dzdeltac_loc/Dz2c_loc

!        elcmig(ic) = diff_cof_ic(ic) * chargec(ic)*
!     &              HarmonicMean(cd_ivol(ic),cd_jvol(ic)) * 
!     &              Dzdeltac_loc/Dz2c_loc

      end do  
    endif

      if (nx>0) then

!      do ix=1,nx              ! loop over free species
!      
!        elcmigx(ix) = r5 * diff_cof_ix(ix) * chargex(ix)*
!     &               (cdx_ivol(ix) + cdx_jvol(ix)) * 
!     &               (e_current + Dzdeltax_loc - zx_loci*vel)/Dz2x_loc
!
!      end do

!c add up aqueous complexes
 
      do ix=1,nx            ! ix loop over complexes
        istart = iax(ix)
        iend = iax(ix+1)-1
        do i = istart,iend  ! i loop
          ic = jax(i)
 
!c skip h2o, h+1 and oh- since electromig considers other species
 
          if (namec(ic).ne.'h2o') then   
             elcmig(ic) = elcmig(ic) +                         &
     &                    xnux(i) * r5 * diff_cof_ix(ix) * chargex(ix)*        &
     &                   (cdx_ivol(ix) + cdx_jvol(ix))*             &
     &                   (Dzdeltac_loc - zc_loc*vel)/Dz2c_loc
!MX     &                (e_current + Dzdeltac_loc - zc_loc*vel)/Dz2c_loc
          end if
        end do              ! i loop
      end do                ! ix loop over complexes       
      
      endif !(nx>0) 



      
         

! prc -----------------------------------------------------------------------------
! prc -----------------------------------------------------------------------------
! prc Computing electromigration flux for complexes using Lichtner formulation
! prc -----------------------------------------------------------------------------
! prc -----------------------------------------------------------------------------  



!cdbg
#ifdef DEBUG
      info_debug = 0
      if (info_debug.gt.0 .and. Dz2c_loc .gt. 0.0) then 
       do ic=1,nc-1     
           write(idbg,'(a,i4,a,e10.3,/)')    &
     &          'elcmig(',ic,') = ',elcmig(ic)   
           write(idbg,'(a,i4,a,e10.3,/)')    &
     &          'DZDeltaC/DZ2C(',ic,') = ',Dzdeltac_loc/Dz2c_loc 

       end do
           write(idbg,'(a,e10.3,/)')        &
     &          'time = ',time         
!       write(idbg,*) 'wrote to dbg from elecmigration.f'
      end if 
#endif
!cdbg
            
      return
      end