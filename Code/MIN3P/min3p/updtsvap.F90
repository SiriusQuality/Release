!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/updtsvap.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine updtsvap
!c -------------------
!c
!c update secondary variables in aqueous phase
!c - activity coefficients
!c - concentrations of secondary aqueous species
!c - ionic strength
!c
!c written by:      Uli Mayer - January 29, 96
!c
!c last modified:   Uli Mayer - November 28, 96
!c
!c definition of variables:
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           cx(nx)             = concentrations of secondary         + +
!c                                aqueous species
!c                                - new time level [moles/l water]
!c           gammac(nc)         = activity coefficients of free       + +
!c                                species
!c           gammax(nx)         = activity coefficient of             + +
!c                                secondary aqueous species
!c           strion             = ionic strength                      + +
!c
!c common:
!c chem.f:   real*8:
!c           ------- 
!c           acth2omin          = min. activity for h2o               + -
!c           actv(nc)           = activity of free species            + -
!c                                - new time level
!c           adav               = coefficient for Davies equation     + -
!c           bdav               = coefficient for Davies equation     + -
!c           dhac(nc)           = debye-huckel a for free species     + -
!c           dhad(nthreads)     = Debye Huckel constant a_d depending + -
!c                                on dielectric constant and
!c                                temperature (only for 25C)
!c           dhax(nx)           = debye-huckel a for secondary        + -
!c                                aqueous species
!c           dhbc(nc)           = debye-huckel b for free species     + -
!c           dhbd(nthreads)     = Debye Huckel constant b_d depending + -
!c                                on dielectric constant and
!c                                temperature (only for 25C)
!c           dhbx(nx)           = debye-huckel b for secondary        + -
!c                                aqueous species
!c           eqr(nr,nthreads)   = equilibrium constant for redox      + -
!c                                couple reaction equation
!c           eqx(nx,nthreads)   = equilibrium constants for           + -
!c                                formation of complexed
!c                                species from free species
!c           xnur(nr*nc)        = stoichiometric coefficient of       + -
!c                                component in redox couple
!c                                reaction equation
!c           xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of secondary aqueous
!c                                species from free species
!c
!c           integer*4:
!c           ----------
!c           iarc(nr+1)         = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                free species in
!c                                secondary aqueous species
!c           jarc(nr*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in secondary aqueous
!c                                species
!c           nc                 = number of components including h2o  + -
!c           nopu               = number of primary unknowns          + -
!c           nr                 = number of redox couples             + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           logical:
!c           --------
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c           update_activity(nthreads)
!c                              = 'no_update' -> unity activity       + -
!c                                 coefficients
!c                                'time_lagged' -> update activity
!c                                 coefficients after each time step
!c                                'double_update' -> double update
!c                                 of activity coefficients during
!c                                 Newton iterations
!c
!c           character:
!c           ----------
!c           component_type(nc) = 'aqueous' = aqueous component       + -
!c                                'surface' = surface site
!c                                'biomass' = biomass
!c           ctype(nc-1)        = 'charge' = correct total aqueous    + -
!c                                           component concentration
!c                                           for specified component 
!c                                           to satisfy charge balance
!c                                'fixed'  = compute total aqueous
!c                                           component concentrations
!c                                           based on fixed activities
!c                                           of components as species
!c                                           in solution
!c                                'free'   = compute concentrations
!c                                           of components as species
!c                                           in solution based on 
!c                                           specified total aqueous
!c                                           component concentrations
!c                                'ph'    =  pH specified for 'h+1'
!c           namec(nc)          = component names                     + -
!c           namex(nx)          = names of aqueous complexes          + -
!c
!c local:    integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           ir                 = counter (redox couples)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: acoff     = compute activity coefficient 
!c           secspec   = compute concentration of secondary aqueous
!c                       species based on concentrations of free 
!c                       species
!c           ionstr    = compute ionic strength
!c ----------------------------------------------------------------------
 
      subroutine updtsvap (c,cx,gammac,gammax,strion)
 
      use parm
      use chem
      use gen, only : ilog,idbg
#ifdef OPENMP
      use omp_lib 
#endif 

      implicit none
      
      real*8 :: c,cx,gammac,gammax,strion
      
      integer :: ic, ix, ir
      
      real*8 :: acoff
      
      integer :: tid 

      external acoff, secspec, ionstr

      dimension c(*),cx(*),gammac(*),gammax(*)
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

!c  activity coefficients for free species
 
      if (update_activity(tid).eq.'double_update') then
!cprovi----------------------------------------------      
      if (ispitzer) then
!cprovi----------------------------------------------        
!cprovi it was added by Sergio Andrés Bea Jofr?
!cprovi Compute activity coefficients from
!cprovi Pitzer equations 
!cprovi Cuidado, las componentes pueden no ser acuosas
!cprovi preguntarle a Uli 
!cprovi---------------------------------------------- 
        call pitzer (phase,gammac,gammax,c,cx,nc,nx,ilog)
      else  
        do ic=1,nc

          if (component_type(ic).eq.'aqueous') then
            gammac(ic) = acoff(c,cx,strion,chargec(ic),dhac(ic),      &
     &                         dhbc(ic),dhad(tid),dhbd(tid),adav,bdav,&
     &                         acth2omin,nc,nx,namec(ic),namec)
          elseif (component_type(ic).eq.'biomass') then
            gammac(ic) = 1.0d0
          end if

        end do
 
!c  activity coefficients for aqueous complexes
 
        do ix=1,nx
          gammax(ix) = acoff(c,cx,strion,chargex(ix),                 &
     &                       dhax(ix),dhbx(ix),dhad(tid),dhbd(tid),   &
     &                       adav,bdav,acth2omin,nc,nx,               &
     &                       namex(ix),namec)
        end do
      end if 
      end if

!c  compute free species concentrations from free species activities, 
!c  if free species activities are fixed

       do ic = 1,nc-1
         if (ctype(ic).eq.'fixed') then
           c(ic) = actv(ic)/gammac(ic) 
         end if
       end do

!c  equilibrium redox reactions, compute concentrations of oxidized 
!c  components of redox couples

      if (redox_equil.and.nr.gt.0) then
        do ir=1,nr
          ic = nopu+ir
          call secspec(c,c(ic),eqr(ir,tid),gammac,gammac(ic),xnur,    &
     &                 iarc,jarc,nc,ir)
        end do
      end if

!c  compute concentrations of aqueous complexes
 
      do ix = 1,nx
        call secspec(c,cx(ix),eqx(ix,tid),gammac,gammax(ix),xnux,     &
     &               iax,jax,nc,ix)
      end do
 
!c  update ionic strength
 
      call ionstr(c,cx,strion,chargec,chargex,nc-1,nx,namec)
 
!c  make sure new ionic strength is not larger than maximum
!c  allowed ionic strength to avoid convergence problems
 
      strion = dmin1(strion,sionmax)

      return
      end
