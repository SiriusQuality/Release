!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/jacddfs_energybal.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine jacddfs_energybal
!c ----------------
!c
!c pressure formulation
!c accounts for presence of DNAPL phase
!c 
!c
!c construct Jacobian matrix and rhs-vector (density-dependent flow)
!c
!c modified from Sergio Andres Bea Jofre 
!c
!c written by:      Sergio Andres Bea Jofre 
!c
!c last modified:   Sergio Andres Bea Jofre 
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           avs(njavs)         = jacobian matrix                     - +
!c           bvs(nn)            = rhs vector                          - +
!c           cinfvs(njavs)      = influence coefficients              + -
!c           cvol(nn)           = nodal volumes                       + -
!c           delt               = time step                           + -
!c           dinc_vs            = increment for numerical             + -
!c                                differentiation
!c           pornew(nn)         = porosity (new time level)           + -
!c           relperm(nn)        = relative permeability               * +
!c           relpinc(nn)        = relative permeability (incremented) * *
!c           sainc(nn)          = aqueous phase saturation            * *
!c                                - incremented
!c           sanew(nn)          = aqueous phase saturation            * +
!c                                - new time level
!c           saold(nn)          = aqueous phase saturation            + -
!c                                - old time level
!c           uvsinc(nn)         = solution vector (incremented)       * *
!c           uvsnew(nn)         = solution vector (new time level)    * +
!c           uvsold(nn)         = solution vector (old time level)    + -
!c           vsflux(ncon-1)     = interfacial fluxes                  * *
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           idbg               = unit number, debugging file         + -
!c           iavs(nn+1)         = row pointer array for avs           + -
!c           isymvs(njavs)      = symmetry pointer array              + -
!c           javs(njavs)        = connectivity list                   + -
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           nn                 = total number of control volumes     + -
!c           njavs              = number of global connections        + -
!c
!c           logical:
!c           --------
!c           root_uptake        = .true.  -> compute root water       + -
!c                                           uptake 
!c           transient_flow     = .true.  -> .not.steady_flow,        + -
!c                                        -> transient flow
!c           upstream           = .true.  -> upstream weighting       + -
!c
!c           character:
!c           ----------
!c           iups(ncon-1)       = upstream pointer                    * *
!c
!c
!c dens.f:   real*8:
!c           -------
!c           del_p(ncon-1)      = difference in total                 + -       
!c                                pressure potential
!c           del_z(ncon-1)      = difference in                       + -                   
!c                                elevation potential
!c           pressure(nn)       = fluid pressure                      + - 
!c           density(nn)        = fluid density                       + -  
!c           viscosity(nn)      = fluid viscosity                     + -
!c           dcoef(ncon-1)      = coefficient including density       + -
!c                                and viscosity 
!c           rho_av             = average density between ivol        + -
!c                                and jvol
!c
!c           integer*4
!c           ---------
!c           iter_sia           = iteration counter -Picard iteration * - 
!c
!c local:    real*8:
!c           -------
!c           dqroot             = derivative of root water uptake
!c           dtotvsflux         = derivative of total flux into
!c                                current control volume
!c           dvsstor            = derivative of storage term
!c           dvsflux            = derivative of flux term
!c           hhinc              = hydraulic head (incremented)
!c           qroot              = root water uptake for current
!c                                control volume
!c           qrootinc           = root water uptake for current 
!c                                control volume (incremented)
!c           totvsflux          = total flux into current control 
!c                                volume
!c           vsstor             = storage term for current control 
!c                                volume
!c           vsstorinc          = storage term for current control
!c                                volume (incremented variables)
!c           vsfluxinc          = interfacial flux (incremented 
!c                                variables)
!c           r0                 = constant
!c           r1                 = constant
!c           rhalf              = constant
!c           gacc               = gravitational acceleration [m s^-2]
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter (row entries)
!c           ivol               = counter (control volumes)
!c           istart             = pointer (start of row)
!c           iend               = pointer (end of row)
!c           idiag              = pointer (diagonal)
!c           icon               = pointer (connections - local)
!c           isym               = symmetry pointer
!c           jvol               = row-column pointer
!c
!c external: rhsvs     = assembly of rhs vector
!c           rootwat   = function for computing root water uptake
!c           storddfs  = storage function for fully saturated 
!c                       density dependent flow 
!c           fluxdd    = flux function for fully saturated 
!c                       density dependent flow
!c           soilparm  = soil hydraulic parameters
!c ----------------------------------------------------------------------
 
subroutine jacddfs_energybal
 
use parm
use gen
use phys
use dens
use chem
#ifdef OPENMP
use omp_lib 
#endif 
 
implicit none

integer :: i1, icon, ivol, izn, idiagvspa, idiagheattemp, idiagheatpa, &
           idiagvstemp, istart, iend, jvol, isymvspa, isymvstemp,      &
           isymheatpa, isymheattemp 

real*8 :: actw, relpfsat, delt_loc, densoldc_ivol, densnewc_ivol,      &
          tdsold_ivol, tdsnew_ivol, totvsflux, darcy_energybal,        &
          diff_energybal, tortuosity, tortuosity_vap, fluxheat, coeff, &
          fluxdd, vsstor, storddfs, storevap, stordheat, facpa,        &
          factemp, dinc_vs_loc, dtemp_ivol, tempinc_ivol,              &
          densinc_ivol, rhonew, viscoinc_ivol, visconew, porinc_ivol,  &
          porosity_flow, sainc_ivol, sginc_ivol, relperminc_ivol,      &
          densvinc_pa_ivol, densvinc_temp_ivol, dtotvsflux_pa,         &
          dtotvsflux_temp, del_pinc, vsfluxinc, dvsflux, tortinc,      &
          dtemp_ivol_jvol, por_av, sa_av, heatfluxinc, dheatflux,      &
          vapfluxinc, vsstorinc, dvsstor

integer :: chunk

external relpfsat, storevap, storddfs, stordheat, fluxdd, fluxheat,    &
         rhsvs, zero_r8, darcy_energybal, diff_energybal, rhonew,      &
         tortuosity_vap, visconew, porosity_flow

real*8, parameter  :: r0 = 0.0d0, &
                      rhalf = 0.5d0, & 
                      r1 = 1.0d0, &
                      r4 = 4.0d0
                      
integer, parameter :: i0=0 
     
      
logical                :: iserror,isdebug
integer :: info_debug
      
real*8                 :: heatstor, & 
                          heatstorinc, & 
                          tempivol, &
                          totheatflux , & 
                          heatcap_av,  &
                          dheatstor, &
                          dtotheatflux_pa, & 
                          dtotheatflux_temp, & 
                          dtotvsfluxtemp, & 
                          del_tempinc, &
                          dummy1, &
                          dummy2, &
                          dummy3, &
                          dummy4, &
                          latvapinc_ivol, &
                          latvap_av  

#ifdef OPENMP
      chunk = nngl / numofthreads_matrix_flow
      if(mod(nngl, numofthreads_matrix_flow) > 0) then
          chunk = chunk + 1                             !This is default chunk size for static scheduling.
      end if
      if (i_chunksize_factor_flow > 1) then
            if(mod(chunk, i_chunksize_factor_flow) > 0) then
                chunk = chunk/i_chunksize_factor_flow + 1
            else
                chunk = chunk/i_chunksize_factor_flow
            end if
      end if
#endif

#ifdef SCHEDULE_DYNAMIC
      if(i_chunksize_factor_flow == 0) then
        chunk = 1                                       !This is the default chunk size for dynamic scheduling.
      end if 
#endif

!c  debug toggle
isdebug = .false. 
info_debug = 0

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (i_matrix_assembly_type_flow == 1)                       &
    !$omp num_threads(numofthreads_matrix_flow)                       &
    !$omp default(shared)                                             &
    !$omp private (i1, icon, idiagheatpa, idiagheattemp, idiagvspa,   &
    !$omp idiagvstemp, iend, istart, isymheatpa, isymheattemp,        &
    !$omp isymvspa, isymvstemp, ivol, izn, jvol,                      &
    !$omp actw, coeff, del_p, del_temp, del_z, delt_loc, del_pinc,    &
    !$omp densinc_ivol, densnewc_ivol, densoldc_ivol,                 &
    !$omp densvinc_temp_ivol, densvinc_pa_ivol, dheatflux,            &
    !$omp dheatstor, dinc_vs_loc, dtemp_ivol, dtemp_ivol_jvol,        &
    !$omp dtotheatflux_pa, dtotheatflux_temp, dtotvsflux_pa,          &
    !$omp dtotvsflux_temp, dummy1, dummy2, dummy3, dummy4,            &
    !$omp dvsflux, dvsstor, facpa, factemp, heatflux_a, heatflux_c,   &
    !$omp heatflux_d, heatflux_v, heatfluxinc, heatstor,              &
    !$omp heatstorinc, latvap_av, latvapinc_ivol, por_av,             &
    !$omp porinc_ivol, relperminc_ivol, rho_av, sa_av, sainc_ivol,    &
    !$omp sginc_ivol, tdsnew_ivol, tempinc_ivol, tdsold_ivol, tortinc,&
    !$omp tortuosity, totheatflux, totvsflux, vapflux, vapfluxheat,   &
    !$omp vapfluxinc, viscoinc_ivol, vsflux, vsfluxinc, vsfluxheat,   &
    !$omp vsstor, vsstorinc)                              
#endif

!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
!cprovi calculate relative permeability to account for the 
!cprovi presence of a napl phase
!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
 if (napl_permeability) then
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif     
      do ivol = 1,nngl             !loop over control volumes
          izn = mpropvs(ivol)
          if (napl_kfunction .eq. 'vangenuchten') then

            relperm(ivol) = relpfsat(sanew(ivol),swr(izn),expn(izn),spgamma(izn))
            
          else if (napl_kfunction .eq. 'corey') then
                
            relperm(ivol) = ((sanew(ivol) - swr(izn))/(r1 - swr(izn)))**r4
        
          end if 
      end do
#ifdef OPENMP
    !$omp end do
#endif      
end if      
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi Build Jacobian matrix 
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
if (iter_sia==1) then 
    delt_loc=delt_tds 
else
    delt_loc=delt
end if


!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif
 do ivol = 1,nngl    
 
        if (reactive_transport) then
           actw=gamma(nc,ivol)
        else
           actw=r1
        end if
        
        if (iter_sia==1) then
            
          if (ispitzerdens) then  
            densoldc_ivol = densold2(ivol)
            densnewc_ivol = densold_pitzer(ivol)
          else
            densoldc_ivol = r0
            densnewc_ivol = r0
          end if
          
          tdsold_ivol = tds_old2(ivol)
          tdsnew_ivol = tds_old(ivol)
       
        else
       
          if (ispitzerdens) then  
            densoldc_ivol = densold_pitzer(ivol)
            densnewc_ivol = density_pitzer(ivol)
          else
            densoldc_ivol = r0
            densnewc_ivol = r0
          end if
          tdsold_ivol = tds_old(ivol)
          tdsnew_ivol = tds_new(ivol)
       
        end if
 
        izn = mpropvs(ivol)                                        ! Zone corresponding to ivol for material properties 

        idiagvspa = iaglob(ivol)                                   ! diagonal pointer dF(Pa)/dPa
        idiagheattemp = iaglob(ivol+nngl)                            ! diagonal pointer dF(T)/dT
        idiagheatpa = iaglob(ivol+nngl) + iavs(ivol+1) - iavs(ivol)  ! diagonal pointer dF(T)/dPa        
        idiagvstemp = iaglob(ivol) + iavs(ivol+1) - iavs(ivol)     ! diagonal pointer dF(Pa)/dT
!cprovi-----------------------------------------------------------
!cprovi Pointers to connected cells
!cprovi-----------------------------------------------------------           
        istart = iavs(ivol)+1                                       
        iend = iavs(ivol+1)-1                                      
!cprovi-----------------------------------------------------------
!cprovi calculate storage and flux terms for current control 
!cprovi volume
!cprovi-----------------------------------------------------------
        totvsflux = r0           ! initialize total flux for flow
        totheatflux = r0         ! initialize total flux for heat 
        icon = 0                 ! counter (connections)     
!cprovi---------------------------------------------------------------
!cprovi Loop on connected control volumes
!cprovi---------------------------------------------------------------             
      do i1=istart,iend          !loop over connected control volumes 
          
          icon = icon + 1 
!cprovi---------------------------------------------------------------             
!cprovi Column pointer 
!cprovi---------------------------------------------------------------                      
          jvol = javs(i1)       
!cprovi---------------------------------------------------------------             
!cprovi Initialice vectors for connected cells
!cprovi---------------------------------------------------------------             
          heatflux_a(icon)=r0 
          heatflux_c(icon)=r0 
          heatflux_d(icon)=r0 
          vsflux(icon)=r0  
          if (evaporation) then                                         
            vapflux(icon)=r0  
            vapfluxheat(icon)=r0
            heatflux_v(icon)=r0                                
          end if   
!cprovi---------------------------------------------------------------            
!cprovi compute difference in total presure potential between  
!cprovi current and adjacent control volumes Pjvol - Pivol
!cprovi the distance between cells are in the influence 
!cprovi coefficients 
!cprovi---------------------------------------------------------------  
            del_p(icon) = uvsnew(jvol) - uvsnew(ivol) 
            del_z(icon) = zg(jvol) - zg(ivol)
!cprovi---------------------------------------------------------------             
!cprovi     
!cprovi---------------------------------------------------------------  
           if (del_z(icon)/=r0) then
!cprovi---------------------------------------------------------------  
!cprovi Compute the average density
!cprovi---------------------------------------------------------------             
              rho_av = rhalf * (density(ivol) + density(jvol))  
              if (av_dens_z) then  
                 del_p(icon)=rho_av*(uvsnew(jvol)/density(jvol)-uvsnew(ivol)/density(ivol))
              end if
!cprovi---------------------------------------------------------------  
!c  convert del_z to total elevation potential wrt fluid pressure
!c  and calculate difference in total pressure potential
!cprovi---------------------------------------------------------------   
              del_z(icon) = del_z(icon) * rho_av * gacc 
              del_p(icon) = del_p(icon) + del_z(icon)             
           end if
!cprovi---------------------------------------------------------------  
!c  assign coefficients for upstream weighting of density and viscosity
!c  required for mass flux calculation
!cprovi---------------------------------------------------------------  
!cprovi----------------------------------------------------------------
!cprovi Compute the advective fluxes 
!cprovi----------------------------------------------------------------
           vsflux(icon) = darcy_energybal(del_p(icon),del_p(icon),density(ivol), &
                                          density(jvol),viscosity(ivol), &
                                          viscosity(jvol),relperm(ivol),relperm(jvol), &
                                          cinfvs(i1),ups_flow,isboussinesq)
           if (evaporation) then
              !------------------------------------------------
              ! Thermal hydraulic conductivity               
              ! Noborio et al. (1996)
              ! Sakai et al. (2009)
              !------------------------------------------------   
              vsflux(icon) = vsflux(icon) + diff_energybal(tempnew(ivol),tempnew(jvol),density(ivol), &
                                            density(jvol),uvsnew(ivol),uvsnew(jvol),relperm(ivol), &
                                            relperm(jvol),cinfvs_t(i1), &
                                            r1/viscosity(ivol),r1/viscosity(jvol),r1,ups_flow,.false.) 
                                        
           end if                                
!cprovi----------------------------------------------------------------
!cprovi Compute for divergence of fluxes 
!cprovi----------------------------------------------------------------   
           totvsflux = totvsflux + vsflux(icon)                                          
!cprovi----------------------------------------------------------------
!cprovi Compute the vapour diffusiive fluxes 
!cprovi with respect to pressure gradients 
!cprovi and temperature gradients
!cprovi----------------------------------------------------------------                                          
           if (evaporation) then   
           
              tortuosity = tortuosity_vap(pornew(ivol),pornew(jvol),sgnew(ivol),sgnew(jvol)) 
              
              if (split_divdensv) then
                 vapflux(icon) = diff_energybal(uvsnew(ivol),uvsnew(jvol),r1, &
                                 r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                                 r1,r1,tortuosity,ups_flow,.false.)
                 vapflux(icon) = vapflux(icon) + diff_energybal(tempnew(ivol),tempnew(jvol),r1, &
                                 r1,r1,r1,r1,r1,cinfevap_t(i1), &
                                 r1,r1,tortuosity,ups_flow,.false.)
              else
                 vapflux(icon) = diff_energybal(densvnew(ivol),densvnew(jvol),r1, &
                                 r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                                 r1,r1,tortuosity,ups_flow,.false.)
              end if
              
              totvsflux = totvsflux + vapflux(icon) 
                                                                      
           end if                                                                                
!cprovi--------------------------------------------------------------------------
!cprovi Energy balance equation 
!cprovi--------------------------------------------------------------------------
           del_temp(icon) = tempnew(jvol) - tempnew(ivol)
!cprovi--------------------------------------------------------------------------
!cprovi Advective term 
!cprovi--------------------------------------------------------------------------          
           if (isadvective) then 
             
                      
            vsfluxheat(icon) = darcy_energybal(del_p(icon),del_p(icon),density(ivol), &
                                               density(jvol),viscosity(ivol), &
                                               viscosity(jvol),relperm(ivol),relperm(jvol), &
                                               cinfvs(i1),ups_heat,isboussinesq)
     
            if (evaporation) then
              !------------------------------------------------
              ! Thermal hydraulic conductivity               
              ! Noborio et al. (1996)
              ! Sakai et al. (2009)
              !------------------------------------------------   
              vsfluxheat(icon) = vsfluxheat(icon) + diff_energybal(tempnew(ivol),tempnew(jvol),density(ivol), &
                                                    density(jvol),uvsnew(ivol),uvsnew(jvol),relperm(ivol), &
                                                    relperm(jvol),cinfvs_t(i1), &
                                                    r1/viscosity(ivol),r1/viscosity(jvol),r1,ups_heat,.false.)  
            end if       
                           
            if (isboussinesq) then                   
                 heatflux_a(icon)=fluxheat(tempnew(ivol), &
                                  tempnew(jvol),ivol,jvol,vsfluxheat(icon),nngl,tempold, &
                                  i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2)) 
            else
                 heatflux_a(icon)=heatcapw*fluxheat(tempnew(ivol), &
                                  tempnew(jvol),ivol,jvol,vsfluxheat(icon),nngl,tempold, &
                                  i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2)) 
            end if
             
           end if
           
           if (evaporation) then
              if (split_divdensv) then
                 vapfluxheat(icon)  = diff_energybal(uvsnew(ivol),uvsnew(jvol),r1, &
                                     r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                                     r1,r1,tortuosity,ups_heat,.false.)
              
              
                vapfluxheat(icon)  = vapfluxheat(icon) + diff_energybal(tempnew(ivol), &
                                     tempnew(jvol),r1,r1,r1,r1,r1,r1,cinfevap_t(i1), &
                                     r1,r1,tortuosity,ups_heat,.false.)
              else
                vapfluxheat(icon)  = diff_energybal(densvnew(ivol),densvnew(jvol),r1, &
                                     r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                                     r1,r1,tortuosity,ups_heat,.false.)
              end if                        
              
              heatflux_v(icon)   = heatcapv*fluxheat(tempnew(ivol), &
                                   tempnew(jvol),ivol,jvol,vapfluxheat(icon),nngl,tempold, &
                                   i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
                                   
              latvap_av = rhalf*(latvapnew(ivol)+latvapnew(jvol))
                                    
              heatflux_v(icon)   = heatflux_v(icon) + latvap_av*vapfluxheat(icon)                      
                              
              totheatflux = totheatflux +  heatflux_v(icon)                                                        
           end if
!cprovi--------------------------------------------------------------------------
!cprovi Conductive fluxes 
!cprovi--------------------------------------------------------------------------                
           if (isconductive) then
             if (isboussinesq) then
                coeff = r1/(heatcapw*density(ivol))       
             else   
                coeff = r1
             end if
             heatflux_c(icon) = - fluxdd(del_temp(icon),cinfheat_c(i1),coeff)             
           end if
!cprovi--------------------------------------------------------------------------
!cprovi Dispersive fluxes 
!cprovi--------------------------------------------------------------------------                
           if (isdispersive) then 
              heatflux_d(icon) = diff_energybal(tempnew(ivol),tempnew(jvol),density(ivol), &
                                 density(jvol),pornew(ivol),pornew(jvol), &
                                 sanew(ivol),sanew(jvol),cinfheat_d(i1),r1,r1,heatcapw, &
                                 ups_heat,isboussinesq)
           end if 
!cprovi--------------------------------------------------------------------------
!cprovi Add the total fluxes
!cprovi--------------------------------------------------------------------------     
           totheatflux = totheatflux + heatflux_a(icon) + heatflux_c(icon) + heatflux_d(icon)  
    
       end do                   !loop over connected control volumes
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------

!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
        if (transient_flow) then
            if (isstorflow) then 
              if (isboussinesq) then                                  
                vsstor = cvol(ivol)* storddfs(delt,delt_loc,pornew(ivol), &
                         porold(ivol),sanew(ivol),saold(ivol),r1,r1,r0,r0, &
                         r0,r0,r0,r0,r0,r0,.true.,.false.,r0,r0,r0,r0)                        
     
              else
                vsstor = cvol(ivol)* storddfs(delt,delt_loc,pornew(ivol), &
                         porold(ivol),sanew(ivol),saold(ivol),density(ivol), &
                         densold(ivol),densnewc_ivol,densoldc_ivol,tdsnew_ivol, &
                         tdsold_ivol,drho_dc,drho_dt, &
                         tempnew(ivol),tempold(ivol),ispitzerdens,nonlindens_heat, &
                         cdens1,cdens2,cdens3,cdens4)
                if (evaporation) then
                     vsstor = vsstor + cvol(ivol)*storevap(delt,r1, &
                                       r1,sgnew(ivol),sgold(ivol), &
                                       densvnew(ivol),densvold(ivol), &
                                       pornew(ivol),porold(ivol),r1)
                end if                           
              end if
            else
                vsstor = r0 
            end if                                             
!cprovi-------------------------------------------------------------
!cprovi assembly of storage and flux terms in rhs vector for 
!cprovi flow equation 
!cprovi-------------------------------------------------------------
!c Anna Harrison added qh2o term Jan 24 2014
            if(water_removal) then
              totvsflux = totvsflux+qh2o(ivol)/delt  
            end if
            call rhsvs(vsstor,totvsflux,bglob(ivol))                       
!cprovi-------------------------------------------------------------          
!cprovi Compute the energy balance storage term for ivol 
!cprovi-------------------------------------------------------------          
            if (isstorheat) then
                heatstor = cvol(ivol)*stordheat(delt,delt_loc,tempnew(ivol),  & 
                           tempold(ivol),sanew(ivol),saold(ivol), &
                           density(ivol),densold(ivol),densnewc_ivol, &
                           densoldc_ivol,tdsnew_ivol,tdsold_ivol, &
                           drho_dc,drho_dt,denssolid(ivol), & 
                           pornew(ivol),porold(ivol),heatcapw,  &
                           heatcaps(ivol),ispitzerdens,nonlindens_heat, &
                           cdens1,cdens2,cdens3,cdens4)
                !cprovi---------------------------------------------
                !cprovi Add the terms corresponding to evaporation
                !cprovi in the storage of heat equation  
                !cprovi---------------------------------------------    
                if (evaporation) then   
                    heatstor = heatstor + cvol(ivol)*storevap(delt,tempnew(ivol), &
                                          tempold(ivol),sgnew(ivol),sgold(ivol), &
                                          densvnew(ivol),densvold(ivol), &
                                          pornew(ivol),porold(ivol),heatcapv)
                    heatstor = heatstor + cvol(ivol)*storevap(delt,latvapnew(ivol), &
                                          latvapold(ivol),sgnew(ivol),sgold(ivol), &
                                          densvnew(ivol),densvold(ivol), &
                                          pornew(ivol),porold(ivol),r1)                      
                end if            
            else
                heatstor = r0 
            end if
!cprovi-------------------------------------------------------------
!cprovi Store in the residual the total fluxes and storage term  
!cprovi-------------------------------------------------------------             
            call rhsvs(heatstor,totheatflux,bglob(nngl+ivol))
!cprovi-------------------------------------------------------------          
!cprovi-------------------------------------------------------------          
!cprovi-------------------------------------------------------------                
                         
        end if                    
!cprovi--------------------------------------------------------------------
!cprovi  If we consider logarithm in unknowns 
!cprovi--------------------------------------------------------------------        
        if (islogunk_energybal) then
           facpa=uvsnew(ivol)
           factemp=tempnew(ivol)
        else   
           facpa=r1
           factemp=r1
        end if
!cprovi--------------------------------------------------------------------
!cprovi increment primary unknown (fluid pressure)
!cprovi If the process is iterative, the increment is a factor of the 
!cprovi fluid pressure 
!cprovi--------------------------------------------------------------------
        dinc_vs_loc = dinc_vs        
        uvsinc(ivol) = uvsnew(ivol) + dinc_vs_loc        
!cprovi--------------------------------------------------------------------
!cprovi Compute increment in temperature 
!cprovi--------------------------------------------------------------------
        dtemp_ivol = dinc_heat           
        tempinc_ivol = tempnew(ivol) + dtemp_ivol                       
!cprovi--------------------------------------------------------------------
!cprovi Compute density and viscosity increment as a function of 
!cprovi temperature increment 
!cprovi Also compute the increment of porosity as a function of
!cprovi Pl
!cprovi 
!cprovi--------------------------------------------------------------------       
       if (ispitzerdens) then 
         densinc_ivol = rhonew (ref_dens,density_pitzer(ivol),ref_dens,tempinc_ivol,tempref_dens, &
                                r1,drho_dt,nonlindens_heat,cdens1,cdens2,cdens3,cdens4)
       else
         densinc_ivol = rhonew (ref_dens,tds_new(ivol),ref_tds,tempinc_ivol,tempref_dens,drho_dc,drho_dt, &
                                nonlindens_heat,cdens1,cdens2,cdens3,cdens4)
       end if       

       if (update_viscosity_temp) then
           viscoinc_ivol = visconew(densinc_ivol,tds_new(ivol),tempinc_ivol,update_viscosity, &
                           update_viscosity_temp,cvisco1,cvisco2,cvisco3,cvisco4,cvisco5, &
                           tempref_dens,iviscomodel,ref_visco,ref_tds,ref_dens)
       else
           viscoinc_ivol = viscosity(ivol)
       end if
       
       if (modify_por(ivol)) then
            porinc_ivol = porosity_flow(porold(ivol),uvsinc(ivol),uvsold(ivol),stor(ivol), &
                          por_stress(ivol),por_init(ivol),facpormin)  
       else                  
            porinc_ivol = pornew(ivol)               
       end if 
!cprovi--------------------------------------------------------------------       
!cprovi Compute the preturbed liquid saturation and relative permeability 
!cprovi as function of liquid pressure 
!cprovi--------------------------------------------------------------------
       if (variably_saturated) then       
         izn = mpropvs(ivol)
         call soilprdd(uvsinc(ivol),sainc_ivol,sginc_ivol,relperminc_ivol,relpermg(ivol), &
                       snnew(ivol),swr(izn),aentry(izn),spalpha(izn), & 
                       spbeta(izn),expn(izn),spgamma(izn), &
                       napl_permeability,napl_kfunction,sgr,isovendrying(izn), & 
                       beta_ovendry(izn),hm_ovendry(izn),w0_ovendry(izn), &
                       cp0_ovendry(izn),ref_dens,gacc)
         !cprovi-----------------------------------------------------------
         !cprovi Compute the perturbations in vapour density
         !cpprovi----------------------------------------------------------              
         if (evaporation) then
           ! Perturbation in the liquid pressures
           !               
           call vapor_prop (densvinc_pa_ivol,dummy1,dummy2,dummy3,dummy4,tempnew(ivol),aentry(izn),uvsinc(ivol), &
                            actw,density(ivol),ivol)                            
           ! Perturbation in temperature             
           !      
           call vapor_prop (densvinc_temp_ivol,dummy1,dummy2,dummy3,latvapinc_ivol,tempinc_ivol,aentry(izn),uvsnew(ivol), &
                            actw,densinc_ivol,ivol)
                            
         end if              
       else                
         sainc_ivol = sanew(ivol)
         relperminc_ivol = relperm(ivol)             
       end if
              
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------        
!cprovi--------------------------------------------------------------------        
!c  calculate derivatives of storage and flux terms for current 
!c  control volume (assembly columnwise)
!cprovi--------------------------------------------------------------------        
        dtotvsflux_pa = r0                !initialize derivative of total influx with respect to pressure
        dtotvsflux_temp = r0              !initialize derivative of total influx with respect to temperature 
        dtotheatflux_pa = r0
        dtotheatflux_temp = r0
        icon = 0                          !counter (connections)

        do i1=istart,iend                 !loop over connected control volumes

          jvol = javs(i1)                 !column pointer
          
          isymvspa = isymglob1(i1)        !symmetry pointer for pa in flow equation 
          isymvstemp = isymglob2(i1)      !symmetry pointer for temp in flow equation 
          isymheatpa = isymglob4(i1)      !symmetry pointer for pa in heat equation
          isymheattemp = isymglob3(i1)    !symmetry pointer for temp in heat equation
          
          icon = icon + 1
          
          
          del_pinc = uvsnew(jvol) - uvsinc(ivol)
          
          
          if (del_z(icon)/=r0.and.av_dens_z) then
              rho_av = rhalf * (density(ivol) + density(jvol))
              del_pinc = rho_av*(uvsnew(jvol)/density(jvol)-uvsinc(ivol)/density(ivol))              
          end if
!cprovi--------------------------------------------------------------------
!cprovi Compute d F(Pa) / dPa
!cprovi--------------------------------------------------------------------           
          del_pinc = del_pinc + del_z(icon) 
!cprovi--------------------------------------------------------------------
!cprovi assembly of flux terms (loop over adjacent control volumes)
!cprovi for steady state and transient conditions
!cprovi flux with incremented variables and derivative of flux
!cprovi--------------------------------------------------------------------
          vsfluxinc = darcy_energybal(del_p(icon),del_pinc,density(ivol),density(jvol), &
                                      viscosity(ivol),viscosity(jvol),relperminc_ivol, &
                                      relperm(jvol),cinfvs(i1),ups_flow,isboussinesq)                        
          if (evaporation) then
             !------------------------------------------------
             ! Thermal hydraulic conductivity               
             ! Noborio et al. (1996)
             ! Sakai et al. (2009)
             !------------------------------------------------   
             vsfluxinc = vsfluxinc + diff_energybal(tempnew(ivol),tempnew(jvol),density(ivol), &
                                     density(jvol),uvsinc(ivol),uvsnew(jvol),relperminc_ivol, &
                                     relperm(jvol),cinfvs_t(i1),r1/viscosity(ivol),r1/viscosity(jvol), &
                                     r1,ups_flow,.false.)                                     
          end if
          dvsflux = (vsfluxinc - vsflux(icon)) / dinc_vs_loc          
          dtotvsflux_pa = dtotvsflux_pa + dvsflux          
!cprovi--------------------------------------------------------------------
!cprovi assembly of flux terms in jacobian matrix (off diagonal entries)
!cprovi-------------------------------------------------------------------- 
          aglob(isymvspa) = aglob(isymvspa) - facpa * dvsflux   
#ifdef DEBUG
          if(info_debug > 0) then
              if(ivol == 75 .or. ivol == 76) then
                  write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')       &
                        "jacddfs-A ivol",ivol,"isymvspa",isymvspa,     &
                        "facpa",facpa,"dvsflux",dvsflux,               &
                        "aglob(isymvspa)",aglob(isymvspa)
              end if
          end if
#endif
          
          
          if (evaporation) then  
          
             tortuosity = tortuosity_vap(pornew(ivol),pornew(jvol),sgnew(ivol),sgnew(jvol))
             
             tortinc = tortuosity_vap(porinc_ivol,pornew(jvol),sginc_ivol,sgnew(jvol))   
             
             if (split_divdensv) then
!cprovi--------------------------------------------------------------------        
!cprovi Add the vapor diffusion induced by pressure gradients
!cprovi--------------------------------------------------------------------                                                      
              vsfluxinc = diff_energybal(uvsinc(ivol),uvsnew(jvol),r1, &
                          r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                          r1,r1,tortinc,ups_flow,.false.)
#ifdef DEBUG
             if(info_debug > 0) then
                 if(ivol == 75 .or. ivol == 76) then
                     write(idbg,'(3(a,1x,i6,1x),5(a,1x,e13.6,1x))')    &
                           "jacddfs-B1 ivol",ivol,"jvol",jvol,"i1",i1, &
                           "uvsinc(ivol)",uvsinc(ivol),                &
                           "uvsnew(jvol)",uvsnew(jvol),                &
                           "cinfevap_pa(i1)",cinfevap_pa(i1),          &
                           "tortinc",tortinc,"ups_flow",ups_flow
                 end if
             end if
#endif    
!cprovi--------------------------------------------------------------------        
!cprovi Add the vapor dissusion induced by temperature gradients
!cprovi--------------------------------------------------------------------                                  
              vsfluxinc = vsfluxinc + diff_energybal(tempnew(ivol),tempnew(jvol), &
                          r1,r1,r1,r1,r1,r1,cinfevap_t(i1),r1,r1, &
                          tortinc,ups_flow,.false.)  
#ifdef DEBUG
             if(info_debug > 0) then
                 if(ivol == 75 .or. ivol == 76) then
                     write(idbg,'(3(a,1x,i6,1x),5(a,1x,e13.6,1x))')    &
                           "jacddfs-B2 ivol",ivol,"jvol",jvol,"i1",i1, &
                           "tempnew(ivol)",tempnew(ivol),              &
                           "tempnew(jvol))",tempnew(jvol),             &
                           "cinfevap_t(i1)",cinfevap_t(i1),            &
                           "tortinc",tortinc,"ups_flow",ups_flow
                 end if
             end if
#endif
             else             
              vsfluxinc = diff_energybal(densvinc_pa_ivol,densvnew(jvol),r1, &
                          r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                          r1,r1,tortinc,ups_flow,.false.)  
#ifdef DEBUG
             if(info_debug > 0) then
                 if(ivol == 75 .or. ivol == 76) then
                     write(idbg,'(3(a,1x,i6,1x),5(a,1x,e13.6,1x))')    &
                           "jacddfs-B3 ivol",ivol,"jvol",jvol,"i1",i1, &
                           "densvinc_pa_ivol",densvinc_pa_ivol,        &
                           "densvnew(jvol)",densvnew(jvol),            &
                           "cinfevap_pa(i1)",cinfevap_pa(i1),          &
                           "tortinc",tortinc,"ups_flow",ups_flow
                 end if
             end if
#endif
             
             end if
             dvsflux = (vsfluxinc - vapflux(icon)) / dinc_vs_loc 
#ifdef DEBUG
             if(info_debug > 0) then
                 if(ivol == 75 .or. ivol == 76) then
                     write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')         &
                           "jacddfs-B0 ivol",ivol,"icon",icon,              &
                           "vsfluxinc",vsfluxinc,"dinc_vs_loc",dinc_vs_loc, &
                           "vapflux(icon)",vapflux(icon)
                 end if
             end if
#endif
             
             aglob(isymvspa) = aglob(isymvspa) - facpa * dvsflux   
#ifdef DEBUG
             if(info_debug > 0) then
                 if(ivol == 75 .or. ivol == 76) then
                     write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')       &
                           "jacddfs-B ivol",ivol,"isymvspa",isymvspa,     &
                           "facpa",facpa,"dvsflux",dvsflux,               &
                           "aglob(isymvspa)",aglob(isymvspa)
                 end if
             end if
#endif
             dtotvsflux_pa = dtotvsflux_pa + dvsflux                   
          
          end if
          
          
          
          
!cprovi--------------------------------------------------------------------
!cprovi Compute df(Pa) / dT
!cprovi--------------------------------------------------------------------                              
          del_p(icon) = uvsnew(jvol) - uvsnew(ivol)          
          del_z(icon) = zg(jvol) - zg(ivol)
          
          if (del_z(icon)/=r0) then
              rho_av = rhalf * (densinc_ivol + density(jvol))
              if (av_dens_z) then  
                del_p(icon)=rho_av*(uvsnew(jvol)/density(jvol)-uvsnew(ivol)/densinc_ivol)
              end if  
              del_z(icon) = del_z(icon) * rho_av * gacc
              del_p(icon) = del_p(icon) + del_z(icon)           
          end if
                      
           
          vsfluxinc = darcy_energybal(del_p(icon),del_p(icon),densinc_ivol,density(jvol), &
                                      viscoinc_ivol,viscosity(jvol),relperm(ivol), &
                                      relperm(jvol),cinfvs(i1),ups_flow,isboussinesq) 
          if (evaporation) then
             !------------------------------------------------
             ! Thermal hydraulic conductivity               
             ! Noborio et al. (1996)
             ! Sakai et al. (2009)
             !------------------------------------------------   
             vsfluxinc = vsfluxinc + diff_energybal(tempinc_ivol,tempnew(jvol),densinc_ivol, &
                                     density(jvol),uvsnew(ivol),uvsnew(jvol),relperm(ivol), &
                                     relperm(jvol),cinfvs_t(i1),r1/viscoinc_ivol, &
                                     r1/viscosity(jvol),r1,ups_flow,.false.) 
                                                                        
          end if
          dvsflux = (vsfluxinc - vsflux(icon)) / dtemp_ivol
          
          aglob(isymvstemp) = aglob(isymvstemp) - factemp * dvsflux 
#ifdef DEBUG
          if(info_debug > 0) then
              if(ivol == 75 .or. ivol == 76) then
                  write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')       &
                        "jacddfs-C ivol",ivol,"isymvstemp",isymvstemp, &
                        "factemp",factemp,"dvsflux",dvsflux,           &
                        "aglob(isymvstemp)",aglob(isymvstemp)
              end if
          end if
#endif
          
          dtotvsflux_temp = dtotvsflux_temp + dvsflux 
!cprovi--------------------------------------------------------------------
!cprovi Introduce terms corresponding to vapour
!cprovi Temperature perturbation  
!cprovi--------------------------------------------------------------------
          if (evaporation) then  
              if (split_divdensv) then
                vsfluxinc = diff_energybal(uvsnew(ivol),uvsnew(jvol),r1, &
                            r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                            r1,r1,tortuosity,ups_flow,.false.)
                          
                vsfluxinc = vsfluxinc + diff_energybal(tempinc_ivol,tempnew(jvol), &
                            r1,r1,r1,r1,r1,r1,cinfevap_t(i1), &
                            r1,r1,tortuosity,ups_flow,.false.)            
                          
              else
                vsfluxinc = diff_energybal(densvinc_temp_ivol,densvnew(jvol),r1, &
                            r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                            r1,r1,tortuosity,ups_flow,.false.)              
              end if                      
              dvsflux = (vsfluxinc - vapflux(icon)) / dtemp_ivol 
#ifdef DEBUG
             if(info_debug > 0) then
                 if(ivol == 75 .or. ivol == 76) then
                     write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')         &
                           "jacddfs-D0 ivol",ivol,"icon",icon,              &
                           "vsfluxinc",vsfluxinc,"dtemp_ivol",dtemp_ivol,   &
                           "vapflux(icon)",vapflux(icon)
                 end if
             end if
#endif
              aglob(isymvstemp) = aglob(isymvstemp) - factemp * dvsflux    
#ifdef DEBUG
              if(info_debug > 0) then
                  if(ivol == 75 .or. ivol == 76) then
                      write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')       &
                            "jacddfs-D ivol",ivol,"isymvstemp",isymvstemp, &
                            "factemp",factemp,"dvsflux",dvsflux,           &
                            "aglob(isymvstemp)",aglob(isymvstemp)
                  end if
              end if
#endif
              dtotvsflux_temp = dtotvsflux_temp + dvsflux                     
          
                
          end if                             
!cprovi--------------------------------------------------------------------
!cprovi Add terms corresponding to energy balance 
!cprovi 
!cprovi Add df(T)/dT
!cprovi--------------------------------------------------------------------        
         dtemp_ivol_jvol = tempnew(jvol) - tempinc_ivol  
         por_av = rhalf * (pornew(ivol) + pornew(jvol))
         sa_av = rhalf * (sanew(ivol) + sanew(jvol))      
         
         if (isadvective) then  
!cprovi--------------------------------------------------------------------
!cprovi Term df(T)/dPa
!cprovi Perturbation in the advective term 
!cprovi--------------------------------------------------------------------        
              vsfluxinc = darcy_energybal(del_p(icon),del_pinc,density(ivol),density(jvol),viscosity(ivol), &
                                          viscosity(jvol),relperminc_ivol,relperm(jvol),cinfvs(i1), &
                                          ups_heat,isboussinesq)  
              if (evaporation) then   
                !------------------------------------------------
                ! Thermal hydraulic conductivity               
                ! Noborio et al. (1996)
                ! Sakai et al. (2009)
                !------------------------------------------------
                vsfluxinc = vsfluxinc + diff_energybal(tempnew(ivol),tempnew(jvol),density(ivol), &
                                        density(jvol),uvsinc(ivol),uvsnew(jvol),relperminc_ivol, &
                                        relperm(jvol),cinfvs_t(i1),r1/viscosity(ivol),r1/viscosity(jvol), &
                                        r1,ups_heat,.false.) 
                                                                        
              end if 
                                             
              if (isboussinesq) then                   
                    heatfluxinc=fluxheat(tempnew(ivol), &
                                tempnew(jvol),ivol,jvol,vsfluxinc,nngl,tempold, &
                                i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2)) 
              else
                    heatfluxinc=heatcapw*fluxheat(tempnew(ivol), &
                                tempnew(jvol),ivol,jvol,vsfluxinc,nngl,tempold, &
                                i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2)) 
              end if
          
              dheatflux = (heatfluxinc - heatflux_a(icon)) / dinc_vs_loc          
              aglob(isymheatpa) = aglob(isymheatpa) - facpa * dheatflux
#ifdef DEBUG
              if(info_debug > 0) then
                  if(ivol == 75 .or. ivol == 76) then
                      write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')       &
                            "jacddfs-E ivol",ivol,"isymheatpa",isymheatpa, &
                            "facpa",facpa,"dheatflux",dheatflux,           &
                            "aglob(isymheatpa)",aglob(isymheatpa)
                  end if
              end if
#endif
              dtotheatflux_pa = dtotheatflux_pa + dheatflux                                   
                                              
                                              
!cprovi--------------------------------------------------------------------
!cprovi Term df(T)/dT
!cprovi Perturbation in the advective term 
!cprovi--------------------------------------------------------------------                     
              vsfluxinc = darcy_energybal(del_p(icon),del_p(icon),densinc_ivol,density(jvol),viscoinc_ivol, &
                                          viscosity(jvol),relperm(ivol),relperm(jvol),cinfvs(i1), &
                                          ups_heat,isboussinesq)  
         
                   
              if (evaporation) then
                !------------------------------------------------
                ! Thermal hydraulic conductivity               
                ! Noborio et al. (1996)
                ! Sakai et al. (2009)
                !------------------------------------------------   
                vsfluxinc = vsfluxinc + diff_energybal(tempinc_ivol,tempnew(jvol),densinc_ivol, &
                                        density(jvol),uvsnew(ivol),uvsnew(jvol),relperm(ivol), &
                                        relperm(jvol),cinfvs_t(i1),r1/viscoinc_ivol, &
                                        r1/viscosity(jvol),r1,ups_heat,.false.) 
                                                                        
              end if
          
              if (isboussinesq) then                   
                    heatfluxinc=fluxheat(tempinc_ivol, &
                                tempnew(jvol),ivol,jvol,vsfluxinc,nngl,tempold, &
                                i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2)) 
              else
                    heatfluxinc=heatcapw*fluxheat(tempinc_ivol, &
                                tempnew(jvol),ivol,jvol,vsfluxinc,nngl,tempold, &
                                i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2)) 
              end if
          
           
              dheatflux = (heatfluxinc - heatflux_a(icon)) / dtemp_ivol
              aglob(isymheattemp) = aglob(isymheattemp) -factemp * dheatflux
#ifdef DEBUG
              if(info_debug > 0) then
                  if(ivol == 75 .or. ivol == 76) then
                      write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')           &
                            "jacddfs-F ivol",ivol,"isymheattemp",isymheattemp, &
                            "factemp",factemp,"dheatflux",dheatflux,           &
                            "aglob(isymheattemp)",aglob(isymheattemp)
                  end if
              end if
#endif
              dtotheatflux_temp = dtotheatflux_temp + dheatflux
           
        end if ! isadvective
!cprovi--------------------------------------------------------------------
!cprovi Conductive term 
!cprovi--------------------------------------------------------------------         
         if (isconductive) then
            if (isboussinesq) then
                coeff = r1/(heatcapw*densinc_ivol)       
            else   
                coeff = r1
            end if
            heatfluxinc = - fluxdd(dtemp_ivol_jvol,cinfheat_c(i1),coeff)             
            dheatflux = (heatfluxinc-heatflux_c(icon)) / dtemp_ivol
            aglob(isymheattemp) = aglob(isymheattemp) - factemp * dheatflux
#ifdef DEBUG
            if(info_debug > 0) then
                if(ivol == 75 .or. ivol == 76) then
                    write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')           &
                          "jacddfs-G ivol",ivol,"isymheattemp",isymheattemp, &
                          "factemp",factemp,"dheatflux",dheatflux,           &
                          "aglob(isymheattemp)",aglob(isymheattemp)
                end if
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dheatflux            
         end if  ! isconductive
!cprovi--------------------------------------------------------------------------
!cprovi Dispersive fluxes 
!cprovi--------------------------------------------------------------------------                
         if (isdispersive) then  
            heatfluxinc = diff_energybal(tempinc_ivol,tempnew(jvol),densinc_ivol, &
                                         density(jvol),pornew(ivol),pornew(jvol), &
                                         sanew(ivol),sanew(jvol),cinfheat_d(i1),r1,r1, &
                                         heatcapw,ups_heat,isboussinesq)
            
            dheatflux = (heatfluxinc-heatflux_d(icon)) / dtemp_ivol
            aglob(isymheattemp) = aglob(isymheattemp) - factemp * dheatflux
#ifdef DEBUG
            if(info_debug > 0) then
                if(ivol == 75 .or. ivol == 76) then
                    write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')           &
                          "jacddfs-H ivol",ivol,"isymheattemp",isymheattemp, &
                          "factemp",factemp,"dheatflux",dheatflux,           &
                          "aglob(isymheattemp)",aglob(isymheattemp)
                end if
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dheatflux 
            
            heatfluxinc = diff_energybal(tempnew(ivol),tempnew(jvol),density(ivol), &
                                     density(jvol),porinc_ivol,pornew(jvol), &
                                     sainc_ivol,sanew(jvol),cinfheat_d(i1),r1,r1,heatcapw, &
                                     ups_heat,isboussinesq)
            
            dheatflux = (heatfluxinc-heatflux_d(icon)) / dinc_vs_loc
            aglob(isymheatpa) = aglob(isymheatpa) - facpa * dheatflux
#ifdef DEBUG
            if(info_debug > 0) then
                if(ivol == 75 .or. ivol == 76) then
                    write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')       &
                          "jacddfs-I ivol",ivol,"isymheatpa",isymheatpa, &
                          "facpa",facpa,"dheatflux",dheatflux,           &
                          "aglob(isymheatpa)",aglob(isymheatpa)
                end if
            end if
#endif
            dtotheatflux_pa = dtotheatflux_pa + dheatflux  
                       
         end if   ! isdispersive 
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------          
!cprovi-------------------------------------------------------------------------- 
!cprovi--------------------------------------------------------------------------
        if (evaporation) then 
              if (split_divdensv) then
                vapfluxinc   = diff_energybal(uvsnew(ivol),uvsnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortuosity,ups_heat,.false.)
                vapfluxinc = vapfluxinc + diff_energybal(tempinc_ivol,tempnew(jvol),r1, &
                              r1,r1,r1,r1,r1,cinfevap_t(i1), &
                              r1,r1,tortuosity,ups_heat,.false.)
              else
                vapfluxinc   = diff_energybal(densvinc_temp_ivol,densvnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortuosity,ups_heat,.false.)            
              end if                             
              heatfluxinc = heatcapv*fluxheat(tempinc_ivol, &
                            tempnew(jvol),ivol,jvol,vapfluxinc,nngl,tempold, &
                            i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
                            
              latvap_av = rhalf*(latvapinc_ivol+latvapnew(jvol))
                                    
              heatfluxinc   = heatfluxinc + latvap_av*vapfluxinc                             
                             
                            
              dvsflux = (heatfluxinc - heatflux_v(icon)) / dtemp_ivol 
              aglob(isymheattemp) = aglob(isymheattemp) - factemp * dvsflux 
#ifdef DEBUG
              if(info_debug > 0) then
                  if(ivol == 75 .or. ivol == 76) then
                      write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')           &
                            "jacddfs-J ivol",ivol,"isymheattemp",isymheattemp, &
                            "factemp",factemp,"dvsflux",dvsflux,               &
                            "aglob(isymheattemp)",aglob(isymheattemp)
                  end if
              end if
#endif
              dtotheatflux_temp = dtotheatflux_temp + dvsflux                                       
              !cprovi--------------------------------------------------------------------
              !cprovi--------------------------------------------------------------------
              !cprovi--------------------------------------------------------------------          
              !cprovi--------------------------------------------------------------------------
              !cprovi Compute dF(T) / d Pa 
              !cprovi Porosity is function of Pa in the dispersive term  
              !cprovi--------------------------------------------------------------------------
              if (split_divdensv) then
                 vapfluxinc  = diff_energybal(uvsinc(ivol),uvsnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortinc,ups_heat,.false.)
                             
                 vapfluxinc = vapfluxinc + diff_energybal(tempnew(ivol),tempnew(jvol),r1, &
                              r1,r1,r1,r1,r1,cinfevap_t(i1), &
                              r1,r1,tortinc,ups_heat,.false.)    
               else
                 vapfluxinc  = diff_energybal(densvinc_pa_ivol,densvnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortinc,ups_heat,.false.)               
               end if 
                           
               heatfluxinc=heatcapv*fluxheat(tempnew(ivol), &
                           tempnew(jvol),ivol,jvol,vapfluxinc,nngl,tempold, &
                           i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2)) 
                           
               latvap_av = rhalf*(latvapnew(ivol)+latvapnew(jvol))
                                    
               heatfluxinc   = heatfluxinc + latvap_av*vapfluxinc                       
                                       
               dvsflux = (heatfluxinc - heatflux_v(icon)) / dinc_vs_loc 
               aglob(isymheatpa) = aglob(isymheatpa) - facpa * dvsflux   
#ifdef DEBUG
               if(info_debug > 0) then
                   if(ivol == 75 .or. ivol == 76) then
                       write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')       &
                             "jacddfs-K ivol",ivol,"isymheatpa",isymheatpa, &
                             "facpa",facpa,"dvsflux",dvsflux,               &
                             "aglob(isymheatpa)",aglob(isymheatpa)
                   end if
               end if
#endif
               dtotheatflux_pa = dtotheatflux_pa + dvsflux
              
              
         end if                
!cprovi-------------------------------------------------------------------------- 
!cprovi-------------------------------------------------------------------------- 
!cprovi-------------------------------------------------------------------------- 
        end do                  !loop over connected control volumes

!c  compute storage term with incremented variables (lumped) 
!c  for current control volume, only for transient conditions

       
        aglob(idiagheattemp) = aglob(idiagheattemp) + factemp * dtotheatflux_temp
#ifdef DEBUG
        if(info_debug > 0) then
            if(ivol == 75 .or. ivol == 76) then
                write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')                        &
                      "jacddfs-L ivol",ivol,"idiagheattemp",idiagheattemp,            &
                      "factemp",factemp,"dvsfluxdtotheatflux_temp",dtotheatflux_temp, &
                      "aglob(idiagheattemp)",aglob(idiagheattemp)
            end if
        end if
#endif 
        if (isadvective.or.isdispersive.or.evaporation) then            
            aglob(idiagheatpa) = aglob(idiagheatpa) + facpa * dtotheatflux_pa
#ifdef DEBUG
          if(info_debug > 0) then
              if(ivol == 75 .or. ivol == 76) then
                  write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')         &
                        "jacddfs-M ivol",ivol,"idiagheatpa",idiagheatpa, &
                        "facpa",facpa,"dtotheatflux_pa",dtotheatflux_pa, &
                        "aglob(idiagheatpa)",aglob(idiagheatpa)
              end if
          end if
#endif
        end if 
          
        aglob(idiagvspa) = aglob(idiagvspa) + facpa * dtotvsflux_pa 
#ifdef DEBUG
          if(info_debug > 0) then
              if(ivol == 75 .or. ivol == 76) then
                  write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')     &
                        "jacddfs-N ivol",ivol,"idiagvspa",idiagvspa, &
                        "facpa",facpa,"dtotvsflux_pa",dtotvsflux_pa, &
                        "aglob(idiagvspa)",aglob(idiagvspa)
              end if
          end if
#endif

        aglob(idiagvstemp) = aglob(idiagvstemp) + factemp * dtotvsflux_temp
#ifdef DEBUG
        if(info_debug > 0) then
            if(ivol == 75 .or. ivol == 76) then
                write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')             &
                      "jacddfs-O ivol",ivol,"idiagvstemp",idiagvstemp,     &
                      "factemp",factemp,"dtotvsflux_temp",dtotvsflux_temp, &
                      "aglob(idiagvstemp)",aglob(idiagvstemp)
            end if
        end if
#endif

        if (transient_flow) then
            if (isstorflow) then
                if (isboussinesq) then  
                   vsstorinc = cvol(ivol)* storddfs(delt,delt_loc,porinc_ivol, &
                               porold(ivol),sainc_ivol,saold(ivol),r1,r0,r0, &
                               r1,r0,r0,r0,r0,r0,r0,ispitzerdens,.false., &
                               r0,r0,r0,r0)               
                            
                         
                else
                   vsstorinc = cvol(ivol)* storddfs(delt,delt_loc,porinc_ivol, &
                               porold(ivol),sainc_ivol,saold(ivol),density(ivol), &
                               densold(ivol),densnewc_ivol,densoldc_ivol,tdsnew_ivol, &
                               tdsold_ivol,drho_dc,drho_dt, &
                               tempnew(ivol),tempold(ivol),ispitzerdens, &
                               nonlindens_heat,cdens1,cdens2,cdens3,cdens4)
                   if (evaporation) then
                         vsstorinc = vsstorinc + cvol(ivol)*storevap(delt,r1, &
                                     r1,sginc_ivol,sgold(ivol), &
                                     densvinc_pa_ivol,densvold(ivol), &
                                     porinc_ivol,porold(ivol),r1)
                   end if                              
                            
                end if
                !cprovi-------------------------------------------------------------          
                !cprovi-------------------------------------------------------------          
                !cprovi-------------------------------------------------------------                   
                dvsstor = (vsstorinc - vsstor)/dinc_vs_loc                                  
                aglob(idiagvspa) = aglob(idiagvspa) + facpa * dvsstor
#ifdef DEBUG
                if(info_debug > 0) then
                    if(ivol == 75 .or. ivol == 76) then
                        write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')         &
                              "jacddfs-P ivol",ivol,"idiagvspa",idiagvspa,     &
                              "facpa",facpa,"dvsstor",dvsstor,                 &
                              "aglob(idiagvspa)",aglob(idiagvspa)
                    end if
                end if
#endif
                if (isboussinesq) then
                   vsstorinc = cvol(ivol)* storddfs(delt,delt_loc,pornew(ivol), &
                              porold(ivol),sanew(ivol),saold(ivol),r1,r1,r0,r0,r0,r0, &
                              r0,r0,r0,r0,ispitzerdens,.false., &
                              r0,r0,r0,r0) 
                else                    
                   vsstorinc = cvol(ivol)* storddfs(delt,delt_loc,pornew(ivol), &
                               porold(ivol),sanew(ivol),saold(ivol),densinc_ivol, &
                               densold(ivol),densnewc_ivol,densoldc_ivol,tdsnew_ivol, &
                               tdsold_ivol,drho_dc,drho_dt, &
                               tempinc_ivol,tempold(ivol),ispitzerdens,nonlindens_heat, &
                               cdens1,cdens2,cdens3,cdens4)
                   if (evaporation) then
                          vsstorinc = vsstorinc + cvol(ivol)*storevap(delt,r1, &
                                                  r1,sgnew(ivol),sgold(ivol), &
                                                  densvinc_temp_ivol,densvold(ivol), &
                                                  pornew(ivol),porold(ivol),r1)
                                                  
                   end if                            
 
                end if
        
        
                dvsstor = (vsstorinc - vsstor)/dtemp_ivol                          
                aglob(idiagvstemp) = aglob(idiagvstemp) + factemp * dvsstor
#ifdef DEBUG
                if(info_debug > 0) then
                    if(ivol == 75 .or. ivol == 76) then
                        write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')         &
                              "jacddfs-Q ivol",ivol,"idiagvstemp",idiagvstemp, &
                              "factemp",factemp,"dvsstor",dvsstor,             &
                              "aglob(idiagvstemp)",aglob(idiagvstemp)
                    end if
                end if
#endif
             
          
          end if 
!cprovi-------------------------------------------------------------          
!cprovi Compute the energy balance storage term for ivol 
!cprovi-------------------------------------------------------------          
          if (isstorheat) then 
           heatstorinc = cvol(ivol)*stordheat(delt,delt_loc,tempinc_ivol, & 
                         tempold(ivol),sanew(ivol),saold(ivol), &
                         densinc_ivol,densold(ivol),densnewc_ivol, &
                         densoldc_ivol,tdsnew_ivol,tdsold_ivol,drho_dc, &
                         drho_dt,denssolid(ivol), & 
                         pornew(ivol),porold(ivol),heatcapw, &
                         heatcaps(ivol),ispitzerdens,nonlindens_heat, &
                         cdens1,cdens2,cdens3,cdens4) 
            if (evaporation) then   
           
                 heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,tempinc_ivol, &
                                             tempold(ivol),sgnew(ivol),sgold(ivol), &
                                             densvinc_temp_ivol,densvold(ivol), &
                                             pornew(ivol),porold(ivol), &
                                             heatcapv)
                 heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,latvapinc_ivol, &
                                             latvapold(ivol),sgnew(ivol),sgold(ivol), &
                                             densvinc_temp_ivol,densvold(ivol),pornew(ivol), &
                                             porold(ivol),r1)                                             
            end if     
            
            !cprovi-------------------------------------------------------------          
            !cprovi Compute d F(Temp) / d Temp corresponding to storage term
            !cprovi-------------------------------------------------------------                             
            dheatstor = (heatstorinc - heatstor) / dtemp_ivol
            aglob(idiagheattemp) = aglob(idiagheattemp) + factemp * dheatstor                                                        
#ifdef DEBUG
            if(info_debug > 0) then
                if(ivol == 75 .or. ivol == 76) then
                    write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')             &
                          "jacddfs-R ivol",ivol,"idiagheattemp",idiagheattemp, &
                          "factemp",factemp,"dheatstor",dheatstor,             &
                          "aglob(idiagheattemp)",aglob(idiagheattemp)
                end if
            end if
#endif                              
                              
            heatstorinc = cvol(ivol)*stordheat(delt,delt_loc,tempnew(ivol), & 
                          tempold(ivol),sainc_ivol,saold(ivol), &
                          density(ivol),densold(ivol),densnewc_ivol, &
                          densoldc_ivol,tdsnew_ivol,tdsold_ivol, &
                          drho_dc,drho_dt,denssolid(ivol), & 
                          porinc_ivol,porold(ivol),heatcapw, &
                          heatcaps(ivol),ispitzerdens,nonlindens_heat, &
                          cdens1,cdens2,cdens3,cdens4)
                              
            if (evaporation) then   
           
                 heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,tempnew(ivol), &
                                             tempold(ivol),sginc_ivol,sgold(ivol), &
                                             densvinc_pa_ivol,densvold(ivol), &
                                             porinc_ivol,porold(ivol), &
                                             heatcapv) 
                 heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,latvapnew(ivol), &
                                             latvapold(ivol),sginc_ivol,sgold(ivol), &
                                             densvinc_pa_ivol,densvold(ivol),porinc_ivol, &
                                             porold(ivol),r1)                             
                                                             
            end if ! evaporation
           
            !cprovi-------------------------------------------------------------          
            !cprovi Compute d F(Temp) / d Pa corresponding to storage term
            !cprovi-------------------------------------------------------------                                       
            dheatstor = (heatstorinc - heatstor) / dinc_vs_loc
            aglob(idiagheatpa) = aglob(idiagheatpa) + facpa * dheatstor                                                 
#ifdef DEBUG
            if(info_debug > 0) then
                if(ivol == 75 .or. ivol == 76) then
                    write(idbg,'(2(a,1x,i6,1x),3(a,1x,e13.6,1x))')         &
                          "jacddfs-S ivol",ivol,"idiagheatpa",idiagheatpa, &
                          "facpa",facpa,"dheatstor",dheatstor,             &
                          "aglob(idiagheatpa)",aglob(idiagheatpa)
                end if
            end if
#endif       
          end if   ! isstorheat                    


end if   ! transient flow         
!cprovi-------------------------------------------------------------                            
!cprovi-------------------------------------------------------------                            
!cprovi-------------------------------------------------------------                    
!cprovi-------------------------------------------------------------                    
!cprovi------------------------------------------------------------- 
#ifdef DEBUG
    if (isdebug) then
        write(idbg,*) '---------------------------------------------------------------'
        write(idbg,*) 'Iteration:',iterglob
        write(idbg,*) '---------------------------------------------------------------'
        write(idbg,'(a15,2i6,e12.4)') 'idiagvspa',ivol,idiagvspa,aglob(idiagvspa)
        do i1=istart,iend
          isymvspa = isymglob1(i1)       
          jvol=javs(i1) 
          write (idbg,'(i6,e12.4)') jvol, aglob(isymvspa)
        end do
        write(idbg,'(a15,2i6,e12.4)') 'idiagvstemp',ivol,idiagvstemp,aglob(idiagvstemp)
        do i1=istart,iend
          jvol=javs(i1) 
          isymvstemp = isymglob2(i1)     
         write (idbg,'(i6,e12.4)') jvol, aglob(isymvstemp)
        end do
        write(idbg,'(a15,2i6,e12.4)') 'idiagheatpa',ivol,idiagheatpa,aglob(idiagheatpa)
        do i1=istart,iend
           jvol=javs(i1) 
          
           isymheatpa = isymglob3(i1)     
          
         write (idbg,'(i6,e12.4)') jvol, aglob(isymheatpa)
        end do
        write(idbg,'(a15,2i6,e12.4)') 'idiagheattemp',ivol,idiagheattemp,aglob(idiagheattemp)
        do i1=istart,iend
         
          jvol=javs(i1) 
         
          isymheattemp = isymglob4(i1) 
         write (idbg,'(i6,e12.4)') jvol, aglob(isymheattemp)
        end do
    end if
#endif    
    
 end do
      
#ifdef OPENMP
    !$omp end do
#endif

#ifdef OPENMP
    !$omp end parallel
#endif
      
!10 continue   

      

return
end subroutine 
