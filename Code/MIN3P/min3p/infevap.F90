!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/infevap.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!!c ----------------------------------------------------------------------
!!c subroutine infcrtdd
!!c -------------------
!!c
!!c compute influence coefficients for advective and dispersive flux 
!!c terms for rectangular, cartesian finite volume discretization 
!!c (reactive transport) for aqueous phase using density dependent 
!!c flow equation
!!c
!!c from Uli Mayer template
!!c
!!c written by:      Tom Henderson - October 22, 2002
!!c
!!c last modified:   Tom Henderson - July 11, 2003
!!c
!!c definition of variables:
!!c
!!c I --> on input   * arbitrary  - initialized  + entries expected
!!c O --> on output  * arbitrary  - unaltered    + altered
!!c                                                                    I O
!!c     input:
!!c
!!c passed:   real*8:
!!c           -------
!!c           d(3, ibk)          = dimension of cells in x,y,z         + -
!!c                                direction
!!c           density(nn)        = fluid density                       + - 
!!c           dvolcoef           = volume flux coefficient including   * +       
!!c                                viscosity and relative permeability
!!c           diffu              = phase molecular diffusion (m2/day)
!!c           disx(nzn)          = dispersion, x direction (m)
!!c           disy(nzn)          =    "      , y    "      (m)
!!c           disz(nzn)          =    "      , z    "      (m)
!!c           cinfrt_va()        = influence coefficients 
!!c                                J^w_ij/A_ij
!!c                                (advective flux terms)
!!c           cinfrt_da()        = influence coefficients
!!c                                D_ij * A_ij / d_ij  
!!c                                (dispersvie flux terms)
!!c           viscosity(nn)      = fluid viscosity                     - -     
!!c
!!c           integer*4:
!!c           ----------
!!c           ibk                = block i
!!c           id                 = connected block j
!!c           idbg               = output for debugging information
!!c           ilog               = unit number, logbook
!!c           nmax               = max cells for dim purposes
!!c           nphas              = max number of phases
!!c           njamxc             = max dim ja array (ncomp.com)
!!c           nvx                = number of control volumes 
!!c                                in x direction
!!c           nvy                = number of control volumes 
!!c                                in y direction
!!c           nvz                = number of control volumes 
!!c                                in z direction
!!c           pornew(ibk)        = porosity
!!c           sanew(nmax)        = aqueous phase saturation
!!c                                - new time level
!!c           uvsnew(nmax)       = pressure
!!c           relperm(nmax)      = rel permeability
!!c           cinfvs(nmax)       = influence coefficient 
!!c                                (variably saturated flow) 
!!c           ia(), ja()         = ysmp pointers
!!c           isymm(ii)          = symmetry pointer for cell ibk
!!c
!!c           logical:
!!c           --------
!!c           fully_saturated    = .true.  -> saturated conditions
!!c           variably_saturated = .true.  -> .not.fully_saturated,
!!c                                        -> variably saturated
!!c                                           conditions
!!c           half_cells         = .true.  -> half cells on boundary
!!c           tortuosity_corr    = .true.  -> Millington-Quirk 
!!c                                           tortuosity correction
!!c                                           for diffusion
!!c                                           coefficients
!!c
!!c
!!c
!!c local:
!!c
!!c external: diffcoff  = compute effective diffusion coefficient
!!c           fluxdd    = flux function for fully saturated flow 
!!c           fluxvs    = flux function for variably saturated flow
!!c --------------------------------------------------------------------------
      subroutine infevap  (nvx,nvy,nvz, ia, ja, isymm,                &
                          cinfevap_pa,cinfevap_t,cinfvs_t,cinfvs,     &
                          density,ddensvdpa,ddensvdt,d,               &
                          tempnew,mprop,nzn,diffu,                    &
                          pornew,sanew,idbg,ilog,njamxc, nmax,        &
                          tortuosity_corr,half_cells,assigned_tau,    &
                          tau,type_tortuosity,marchies,cinfrad,       &
                          radial_coord,isenhfactor,fclay_nabla,       &
                          cte_nabla,ref_dens,nabla_qhv,split_divdensv,& 
                          gacc,gainwt,dsurftensdt,gammaw0,tau_fac)
     
#ifdef OPENMP
      use omp_lib 
      use gen, only : rank, b_enable_output,                          &
                      numofthreads_global,                            &
                      numofloops_thred_global,                        &
                      numofloops_thred_infevap_1
#else
     use gen, only : rank, b_enable_output
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none

      integer nvx, nvy, nvz, ia(nmax+1), ja(njamxc),                  &
             isymm(njamxc), idbg, ilog, nzn, mprop(*) 

      logical half_cells, fully_saturated, variably_saturated,        &
             tortuosity_corr,diff_coff,assigned_tau,                  &
             harmonic_porosity,av_dens_z,radial_coord,isenhfactor,    &
             split_divdensv

      real*8  diffu,pornew(nmax),tempnew(nmax),ddensvdpa(nmax),       &
             ddensvdt(nmax),dsurftensdt(nmax),density(nmax),          &
             sanew(nmax),d(3,nmax),                                   &
             cinfevap_pa(njamxc),cinfevap_t(njamxc),                  &
             tau(nmax),cinfrad(njamxc),cinfvs_t(njamxc),              &
             cinfvs(njamxc),marchies(nmax),tau_fac(nmax)
     
      character(len=*) type_tortuosity

      real*8 value_tau,fclay_nabla,cte_nabla,ref_dens,        &
            nabla_qhv,gammaw0,gacc,gainwt
      
      
!c     local variables

      integer :: njamxc, nmax
      real*8 :: ddensvdpa_av, ddensvdt_av 

      real*8, parameter :: eps = 1.0d-300, r0 = 0.0d0, rhalf = 0.5d0, &
                       r1 = 1.0d0, r2 = 2.0d0, r3 = 3.0d0, r4=4.0d0,  &
                       rkelvin=273.15d0

      real*8 aread(3,12),areax(3,12),dist(3,12),                      &
            porav,satav,temp_ibk,temp_id,                             &
            diffav,tauav,tempav,densav,coeff_pa,coeff_t,nabla,exp,    &
            dsurftensdt_av
     
     
      integer ibk, ivz, ivy, ivx, ibkz, ibky,                         &
             ii, id, ixx, iyy, izz, iisav,                            &
             idim, npair(3), iface(3,12), ndim,                       &
             fvpair(3,12,2), ipair, idim2, idim3, irk_ibk, irk_id
    
!cprovi    changed: Nov. 09, added for harmonic averaging
      integer ivxp,ivxn,ivyp,ivyn,ivzp,ivzn,jtemp,nedge,              &
             ivol,jvol,izn,jzn
      
      integer :: info_debug

      character*1 iups
#ifdef OPENMP      
      integer :: nvols
#endif
      
      external :: zero_r8
      
      
      info_debug = 0

#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp parallel
    !$omp sections
#endif
#endif
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(cinfevap_pa, njamxc, 1, 1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp section
#endif
#endif  
      call zero_r8(cinfevap_t, njamxc, 1, 1)
#ifdef OPENMP
#ifdef PARALLEL_SECTION
    !$omp end sections
    !$omp end parallel
#endif
#endif
      
#ifdef OPENMP      
      nvols = nvx * nvy * nvz
#endif

!c  loop over control volumes
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nvols > numofloops_thred_infevap_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ibk, id, idim, idim2, idim3, iface, ii,            &
    !$omp iisav, ipair, ivx, ivy, ivz, ndim)                          &
    !$omp firstprivate(aread, areax, coeff_pa, coeff_t, densav,       &
    !$omp ddensvdpa_av, ddensvdt_av, diffav, dsurftensdt_av, exp,     &
    !$omp fvpair, nabla, npair, dist, porav, satav, tauav,            &
    !$omp tempav, temp_ibk, temp_id)
    !$omp do schedule(static)
#endif
      do ivz = 1, nvz          !increments in z-direction
        do ivy = 1, nvy       !increments in y-direction
          do ivx = 1, nvx    !increments in x-direction

!c  find node pairs for elemental velocities as well
!c  as influence coefficient for node pairs within dipersion element

            call cliqdisp (nvx, nvy, nvz, ivx, ivy, ivz,              &
                          fvpair, npair,aread,areax,dist,d,           &
                          half_cells, ia, ja, njamxc,                 &
                          nmax, idbg, cinfrad, radial_coord)

!c  check if fully connected "pseudo dispersion element"
!c  was found for dimensionality of problem

            if ((nvx .gt. 1 .and. npair(1) .eq. 0) .or.               &
               (nvy .gt. 1 .and. npair(2) .eq. 0) .or.                &
               (nvz .gt. 1 .and. npair(3) .eq. 0)) cycle

!c loop over the dimensions x,y,z

            do idim = 1, 3

              idim2 = idim + 1
              idim3 = idim + 2
              if (idim2 .gt. 3) idim2 = idim2 - 3
              if (idim3 .gt. 3) idim3 = idim3 - 3


!c  loop over the number of node pairs in the dimension

              do ipair = 1, npair(idim)

                ibk = fvpair(idim, ipair, 1)
                id = fvpair(idim, ipair, 2)



                do ii = ia(ibk), ia(ibk+1)-1
                  if (ja(ii) .eq. id) then
                    iisav = ii
                    go to 431
                  endif
                end do
                
                if (rank == 0) then
                  write(ilog,*) ' error-cannot find id in list-infevap'
                  write(ilog,*) ' ibk, id ', ibk, id
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
431             continue
                iface(idim, ipair) = iisav

              end do !ipair = 1, npair(idim)
               

            end do !idim = 1, 3
!-------------------------------------------------------------------------------------
!-------------------------------------------------------------------------------------
!-------------------------------------------------------------------------------------
!-------------------------------------------------------------------------------------
!-------------------------------------------------------------------------------------
!-------------------------------------------------------------------------------------
            porav = r0
            do idim = 1, 3
               do ipair = 1, npair(idim)
                  ibk = fvpair(idim, ipair, 1)
                  id = fvpair(idim, ipair, 2)
                  porav = porav                           &
                       + dmin1( r1, pornew(ibk) )         &
                       + dmin1( r1, pornew(id) )
               end do
            end do 

            ndim = 0
            if (nvx .gt. 1) ndim = ndim + 1
            if (nvy .gt. 1) ndim = ndim + 1
            if (nvz .gt. 1) ndim = ndim + 1
            porav = porav / float(ndim) / r2**ndim
            
!c  average tortuosity of the element
!c  note: each node is included in "ndim" number of node
!c        pairs, therefore the average must be divided
!c        by ndim as well as the number of nodes in the
!c        element
          if (assigned_tau) then
            tauav = r0
            do idim = 1, 3
               do ipair = 1, npair(idim)
                  ibk = fvpair(idim, ipair, 1)
                  id = fvpair(idim, ipair, 2)
!c                  tauav = tauav                             &
!c                       + dmin1( r1, tau(ibk)*tau_fac(ibk))  &
!c                       + dmin1( r1, tau(id)*tau_fac(id) )
                  tauav = tauav                               &
                         + tau(ibk)*tau_fac(ibk)              &
                         + tau(id)*tau_fac(id)
               end do
            end do 

            ndim = 0
            if (nvx .gt. 1) ndim = ndim + 1
            if (nvy .gt. 1) ndim = ndim + 1
            if (nvz .gt. 1) ndim = ndim + 1
            tauav = tauav / float(ndim) / r2**ndim
          end if

!c  calculate average dispersivities for the "pseudo
!c  dispersion element"

            tempav = r0            
            do idim = 1, 3                      !loop over dimensions
              do ipair = 1, npair(idim)        !node pairs

                     ibk = fvpair(idim, ipair, 1)
                     id = fvpair(idim, ipair, 2)

!c  material property -> currently hardwired
                     temp_ibk=tempnew(ibk)+rkelvin
                     temp_id=tempnew(id)+rkelvin
                     tempav = tempav + temp_ibk + temp_id
                     
                  end do                           !node pairs
               end do                              !dimensions 

               tempav = tempav / float(ndim) / r2**ndim
               
               diffav = diffu*(tempav/rkelvin)**r2
               
               ddensvdpa_av = r0
               ddensvdt_av = r0
               densav = r0
               
               dsurftensdt_av = r0

               do idim = 1, 3                      !loop over dimensions
                 do ipair = 1, npair(idim)        !node pairs

                     ibk = fvpair(idim, ipair, 1)
                     id = fvpair(idim, ipair, 2)

!c  material property -> currently hardwired
                     ddensvdpa_av = ddensvdpa_av          &
                                   + ddensvdpa(ibk)       &
                                   + ddensvdpa(id)
                     ddensvdt_av = ddensvdt_av            &
                                   + ddensvdt(ibk)        &
                                   + ddensvdt(id)
                     densav = densav                      &
                             + density(ibk)               &
                             + density(id)  
     
                     dsurftensdt_av = dsurftensdt_av      &
                             + dsurftensdt(ibk)           &
                             + dsurftensdt(id)      
                     
                  end do                           !node pairs
               end do                              !dimensions 

               ddensvdpa_av = ddensvdpa_av / float(ndim) / r2**ndim
               ddensvdt_av = ddensvdt_av / float(ndim) / r2**ndim
               densav = densav / float(ndim) / r2**ndim
               dsurftensdt_av = dsurftensdt_av / float(ndim) / r2**ndim
               
               
!c  calculate the dispersion tensor for the "pseudo dispersion element"
!c  average porosity of the element

               satav = r0
               do idim = 1, 3
                  do ipair = 1, npair(idim)
                     ibk = fvpair(idim, ipair, 1)
                     id = fvpair(idim, ipair, 2)
                     satav = satav                    &
                          + dmin1(r1,sanew(ibk))      &
                          + dmin1(r1,sanew(id))       
                  end do
               end do
               satav = satav / float(ndim) / r2**ndim
               
               !cprovi-------------------------------------------------
               !cprovi Compute the enhanced factor in vapour difussion
               !cprovi This enhanced factor is only for thermal vapor
               !cpeovi fluxes  
               !cprovi This expression is based on Sakai et al., 2009)
               !cprovi-------------------------------------------------
               if (isenhfactor) then  
                 exp=dexp(-(r1+(2.6d0/dsqrt(fclay_nabla))*satav)**r4) 
                 nabla=cte_nabla+r3*satav-(cte_nabla-r1)*exp
               else
                 nabla=r1
               end if
      

!c  build total influence coefficient from all elemental contributions
#ifdef OPENMP
    !$omp critical
#endif 
               do idim = 1, 3                   !loop over dimensions
 
!c  adjust for 1d-, 2d, 3d - discretization

                    do ipair = 1, npair(idim)           
  
                      iisav = iface(idim, ipair)
                       
                      if (split_divdensv) then  
                        coeff_pa = aread(idim,ipair)*nabla_qhv*   &
                                  diffav*ddensvdpa_av
                        coeff_t  = aread(idim,ipair)*nabla*       &
                                  diffav*ddensvdt_av  
                      else
                        coeff_pa = aread(idim,ipair)*nabla*       &
                                  diffav
                        coeff_t  = aread(idim,ipair)*nabla*       &
                                  diffav
                      end if

                      cinfevap_pa(iisav)=coeff_pa

                      cinfevap_pa(isymm(iisav))=coeff_pa
#ifdef DEBUG
                      if(info_debug > 0) then
                          write(idbg,'(7(a,1x,i6,1x),7(a,1x,e13.6,1x))')                       &
                                "ivx",ivx,"ivy",ivy,"ivz",ivz,"idim",idim,"ipair",ipair,       &
                                "iisav",iisav,"isymm(iisav)",isymm(iisav),"coeff_pa",coeff_pa, &
                                "aread(idim,ipair)",aread(idim,ipair),"nabla_qhv",nabla_qhv,   &
                                "diffav",diffav,"ddensvdpa_av",ddensvdpa_av,"nabla",nabla,     &
                                "ddensvdt_av",ddensvdt_av
                      end if
#endif
     
                      cinfevap_t(iisav)=coeff_t
     
                      cinfevap_t(isymm(iisav))=coeff_t
                      !------------------------------------------------
                      ! Influence coefficient for thermal 
                      ! hydraulic conductivity 
                      ! Noborio et al. (1996)
                      ! Sakai et al. (2009)
                      !------------------------------------------------
                      coeff_t = gainwt*dsurftensdt_av/gammaw0 
                      
                      cinfvs_t(iisav)=cinfvs(iisav)*coeff_t
                      
                      cinfvs_t(isymm(iisav))=cinfvs(isymm(iisav)) &
                                                * coeff_t
                      
                      
                      

                    end do                               
                    
               end do                           
#ifdef OPENMP
    !$omp end critical
#endif 
          end do
        end do
      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif               
               
      return
      end

