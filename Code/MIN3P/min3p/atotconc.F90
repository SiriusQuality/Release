!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/atotconc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine
!c -------------------
!c
!c compute analytical derivatives of total aqueous component 
!c concentrations based on concentrations of free species and 
!c secondary aqueous speciesmodified:   
!c
!c
!c written by:      Uli Mayer - October 31, 00
!c
!c last 
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c                                - new time level [moles/l water]
!c
!c           integer*4:
!c           ----------
!c           jbl                = pointer to column of block matrix   + -
!c
!c chem.f:   real*8:
!c           -------
!c           dtotc(n,nthreads)  = derivatives of total aqueous        * +
!c                                component concentrations
!c                                [moles/l water]
!c           xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of secondary aqueous
!c                                species from free species
!c
!c           integer*4:
!c           ----------
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                free species in
!c                                secondary aqueous species
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in secondary aqueous
!c                                species
!c           nc                 = number of components                + -
!c           nr                 = number of redox couples             + -
!c           nx                 = number of secondary aqueous         + -
!c                                species
!c
!c
!c local:    real*8:
!c           -------
!c           r0                  = constant
!c           r1                  = constant
!c
!c           integer*4:
!c           ----------
!c           i                   = counter (stoichiometric
!c                                 coefficients)
!c           ibl                 = counter (components)
!c           istart              = pointer (stoichiometric 
!c                                 coefficients)
!c           istop               = pointer (stoichiometric
!c                                 coefficients)
!c           ix                  = counter (secondary species) 
!c
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine atotconc(c,cx,jbl)
 
      use parm
      use chem
#ifdef OPENMP
      use omp_lib 
#endif
 
      implicit none
      
      real*8 :: c, cx
      integer :: jbl
      
      integer :: tid

      dimension c(*),cx(*)
 
      real*8, parameter :: r0 = 0.0d0

      real*8 :: factor(100)
      
      integer :: i, i1, ibl, ir, ix, istart, istop
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

!c  free species 
 
      do ibl=1,nc-1
        if (jbl.eq.ibl) then
          dtotc(ibl,tid) = c(ibl) 
        else
          dtotc(ibl,tid) = r0
        end if
      end do

!c  aqueous complexes

      if (nx.gt.0) then

!c  initialize factors

        do ix = 1,nx
          factor(ix) = r0
        end do

!c  define factors for aqueous complexes

        do ix = 1,nx
          istart = iax(ix)
          istop = iax(ix+1)-1
          do i1 = istart,istop
            ibl = jax(i1)
            if (ibl.eq.jbl) then
              factor(ix) = xnux(i1)
            end if
          end do
        end do
 
!c  sum up contributions from aqueous complexes
 
        do ix=1,nx
          istart = iax(ix)
          istop = iax(ix+1)-1
          do i = istart,istop
            ibl = jax(i)
            if (namec(ibl).ne.'h2o') then
              dtotc(ibl,tid) = dtotc(ibl,tid) + factor(ix)*xnux(i)*   &
                               cx(ix)
            end if
          end do
        end do

      end if

!cff  redox species, unfinished and deactivated with nr>100

      if (redox_equil.and.nr.gt.100) then

!c  initialize factors
        
        do ir = 1,nr
          factor(ir) = r0
        end do

!c  define factors for redox couples 

        do ir = 1,nr
          istart = iarc(ir)
          istop = iarc(ir+1)-1
          do i1 = istart,istop
            ibl = jarc(i1)
            if (ibl.eq.jbl) then
              factor(ir) = xnur(i1)
            end if
          end do
        end do

!c  sum up contributions from redox couples

        do ir = 1,nr
          istart = iarc(ir)
          istop = iarc(ir+1)-1
          do i1 = istart,istop
            ibl = jarc(i1)

!c  skip h2o, since not a primary unknown
 
            if (namec(ibl).ne.'h2o') then
              dtotc(ibl,tid) = dtotc(ibl,tid)+factor(ir)*xnur(i1)*    &
                               c(ir+nopu)
            end if
          end do
        end do

      end if

!c  final derivative

      do ibl = 1,nc-1
        dtotc(ibl,tid) = dtotc(ibl,tid)/c(jbl)
      end do
 
      return
      end
