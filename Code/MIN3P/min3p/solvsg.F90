!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/solvsg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine solvsg
!c -----------------
!c
!c solve gas bubble equation (sum gas pressures - hydrodynamic pressure = zero) using 
!c newtons method
!c
!c written by:      Rich Amos - February 16, 2004
!c
!c last modified:   - Rich Amos - February 16, 2004
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:       real*8
!c             -------
!c             tot_press                = hydrodynamic pressure (atm)    + *
!c            ivol                    = counter (nodes)                - *
!c
!c common:
!c gen.f       real*8:
!c             -------
!c             sgnew(nn)          = gaseous phase saturation            - +         
!c                                  (new time level)
!c
!c bbls.f        real*8
!c             -------
!c            tot_gas(ig,ivol)    = total concentration of gas in        - -
!c                                  the aqueous and gas phases
!c            k_henry(ig,ivol)    = henry's law constant for gas(i)->gas pair(i)    - -
!c
!c                                
!c
!c chem.f:   integer
!c          -------
!c           ng                 = number of gases                        - - 
!c           rgasatm            = ideal gas constant                    - - 
!c                                [liter atm/(deg K mole)]
!c           tkel(ivol)         = nodal temperatures in Kelvin            - - 
!c
!c local      real*8
!c           ------
!c          sg_old                = value of sg at beginning of newton loop    - *
!c          gas_pressure            = gas pressure for each gas assuming all
!c                                  gas is in aqueous phase                    - *
!c          d_gas_pressure        = derivative of gas_pressure                - *
!c          sum_gas_pressure        = sum of the gas pressure, equal to the total 
!c                                  gas pressure                                - *
!c          sum_d_gas_pressure    = total of the derivative of the gas pressure
!c                                  for newton calculation                    - *
!c          gas_tol                = tolerance for newton iterations            - -
!c          res_tol                = residual tolerance for newton iteration   - - 
!c
!c          initeger
!c          --------
!c          ig                 = counter (gases)                                
!c
!c          logical
!c          -------
!c          converged             = true - newton convergence criteria met
!c 
!c--------------------------------------------------------------------
    subroutine solvsg (ivol,tot_press,sgsolve_failed)

    use parm
    use gen
    use bbls
    use chem
#ifdef PETSC
    use petsc_mpi_common, only : petsc_mpi_finalize
#endif
    
    implicit none
    
    integer :: ivol
    real*8 :: tot_press
    
    logical :: converged,sgsolve_failed
    
    integer :: ig, sg_count, sg_count_max
    real (type_r8) :: sg_old
    real (type_r8) :: sg_new
    real (type_r8) :: gas_pressure
    real (type_r8) :: d_gas_pressure
    real (type_r8) :: sum_gas_pressure        
    real (type_r8) :: sum_d_gas_pressure
    
    real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r100=100d0
    
    converged = .false.
    sgsolve_failed = .false.
    
    sg_count=0
    sg_count_max=100
    


!c initial guess at sgnew

    do while ((.not.converged).and.(.not.sgsolve_failed))

      sg_old = (r1-sanew(ivol))
      sum_d_gas_pressure = r0
      sum_gas_pressure = -tot_press

      do ig=1,ng

!c calculate gas pressure

        gas_pressure = tot_gas(ig,ivol)/((1-sg_old)*k_henry(ig,ivol) + &
                       sg_old/rgasatm/tkel(ivol))
!#ifdef DEBUG
!        if (gas_pressure < 0) then
!          write(ilog,'(3(a,1x,i6,1x),5(a,1x,e16.8,1x))') "ivol",ivol,  &
!                "sg_count",sg_count,"ig",ig,                           &
!                "tot_gas(ig,ivol)",tot_gas(ig,ivol),                   &
!                "sg_old",sg_old,"k_henry(ig,ivol)",k_henry(ig,ivol),   & 
!                "rgasatm",rgasatm,"tkel(ivol)",tkel(ivol)
!        end if
!#endif
                 
!c calculate derivative of gas pressure

        d_gas_pressure = -tot_gas(ig,ivol)/(((1-sg_old)*               &
              k_henry(ig,ivol)+sg_old/rgasatm/tkel(ivol))**2)*         &
              (-k_henry(ig,ivol)+1/rgasatm/tkel(ivol))

!c sum gas pressure and derivative

        sum_gas_pressure = sum_gas_pressure + gas_pressure
        sum_d_gas_pressure = sum_d_gas_pressure + d_gas_pressure

      end do 
!c
!c calculate new value for Sg
        
      sanew(ivol)=r1-(sg_old - sum_gas_pressure/sum_d_gas_pressure)
      
      sg_new = r1-sanew(ivol)
      
!#ifdef DEBUG
!      write(ilog,'(2(a,1x,i6,1x),5(a,1x,e16.8,1x))') "ivol",ivol,      &
!            "sg_count",sg_count,"sg_new",sg_new,"sg_old",sg_old,       &
!            "tot_press",tot_press,"sum_gas_pressure",sum_gas_pressure, &                      &
!            "d_gas_pressure",d_gas_pressure
!#endif
    
      if ((dabs((r1-sanew(ivol)) - sg_old).lt.gas_tol).and.            &
                              (dabs(sum_gas_pressure).lt.res_tol)) then
        converged = .true.
      end if 
        
      sg_count=sg_count+1      
      if (sg_count.gt.sg_count_max) then
        sgsolve_failed = .true. 
        if (rank == 0) then  
          write (ilog,'(a)') 'bubble solution not convergent'
          write (ilog,'(a,i6)') 'volume', ivol
          write (ilog,'(a)') 'reduce timestep'

          write (*,*) 'bubble solution not convergent'
          write (*,*) 'volume', ivol
          write (*,*) 'reduce timestep'
        end if
        !pause
      end if
    end do

    end
