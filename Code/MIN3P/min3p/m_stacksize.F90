!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 107 $
!> $Author: dsu $
!> $Date: 2013-08-21 22:17:07 +0200 (Wed, 21 Aug 2013) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/m_stacksize.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c module m_stacksize
!c ------------------
!c
!c estimate and set stack size needed for the parallel program 
!c
!c written by:      Danyang Su - May 22, 2013
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c
!c external: -
!c ----------------------------------------------------------------------
!> Molude of stacksize management
!> This module is used to estimate and set stack size needed for every worker thread to store
!> copies of private variables.
!> Master thread uses regular stack, not included in this subroutine.
!> Size of these stacks is not defined by OpenMP standards.
!> Intel compiler: default stack is 4MB or 4194304B
!> GCC/GFortran: default stack is 2MB
module m_stacksize

    implicit none
    
contains

    subroutine setstacksize
    
#ifdef OPENMP
        use omp_lib 
#endif  
        use parm
        use gen
        use chem
        use multidiff, only : cinfrt_mcd, delecmigrationnew, dtotviscnew, totviscnewjvol
        use dens, only : dcoef, del_p, del_z
    
        implicit none
        
        integer(type_i8) :: stack_size
        integer(type_i8) :: stack_size_deft
        integer(type_i8) :: stack_size_check
        
        stack_size = 0
        !>Note: only arrays are used to estimate the stack size
        !>alc
        if(allocated(alc)) then
            stack_size = stack_size + type_r8 * size(alc,1) * size(alc,2)
        end if
        
        !>astor
        if(allocated(astor)) then
            stack_size = stack_size + type_r8 * size(astor,1)
        end if
       
        !>bdyinfrt_da_ic, this variable is in jacbrt.F90 and mbalrt.F90
        stack_size = stack_size + type_r8 * nc
        
        !>blc
        if(allocated(blc)) then
            stack_size = stack_size + type_r8 * size(blc,1)
        end if
        
        !>cflux
        if(allocated(cflux)) then
            stack_size = stack_size + type_r8 * size(cflux,1)
        end if

        !>cinc
        if(allocated(cinc)) then
            stack_size = stack_size + type_r8 * size(cinc,1)
        end if
        
        !>cinfrt_da
        if(allocated(cinfrt_da)) then
            stack_size = stack_size + type_r8 * size(cinfrt_da,1)
        end if
        
        !>cinfrt_da_ic
        if(allocated(cinfrt_da_ic)) then
            stack_size = stack_size + type_r8 * size(cinfrt_da_ic,1) * size(cinfrt_da_ic, 2)
        end if
        
        !>cinfrt_dg
        if(allocated(cinfrt_dg)) then
            stack_size = stack_size + type_r8 * size(cinfrt_dg,1)
        end if
        
        !>cinfrt_mcd
        if(allocated(cinfrt_mcd)) then
            stack_size = stack_size + type_r8 * size(cinfrt_mcd,1)
        end if
        
        !>cinfrt_va
        if(allocated(cinfrt_va)) then
            stack_size = stack_size + type_r8 * size(cinfrt_va,1)
        end if
        
        !>cmcmin
        if(allocated(cmcmin)) then
            stack_size = stack_size + type_r8 * size(cmcmin,1)
        end if
        
        !>cmcnew
        if(allocated(cmcnew)) then
            stack_size = stack_size + type_r8 * size(cmcnew,1)
        end if
        
        !!>csb
        !if(allocated(csb)) then
        !    stack_size = stack_size + type_r8 * size(csb,1)
        !end if
        
        !>csb_ion
        if(allocated(csb_ion)) then
            stack_size = stack_size + type_r8 * size(csb_ion,1)
        end if
        
        !>csb_surf
        if(allocated(csb_surf)) then
            stack_size = stack_size + type_r8 * size(csb_surf,1)
        end if
        
        !>cstor
        if(allocated(cstor)) then
            stack_size = stack_size + type_r8 * size(cstor,1)
        end if
        
        !>cxinc
        if(allocated(cxinc)) then
            stack_size = stack_size + type_r8 * size(cxinc,1)
        end if
        
        !>dcoef
        if(allocated(dcoef)) then
            stack_size = stack_size + type_r8 * size(dcoef,1)
        end if

        !!>dcsb
        !if(allocated(dcsb)) then
        !    stack_size = stack_size + type_r8 * size(dcsb,1)
        !end if
        
        !>dcsb_ion
        if(allocated(dcsb_ion)) then
            stack_size = stack_size + type_r8 * size(dcsb_ion,1)
        end if
        
        !>dcsb_surf
        if(allocated(dcsb_surf)) then
            stack_size = stack_size + type_r8 * size(dcsb_surf,1)
        end if
        
        !>del_p
        if(allocated(del_p)) then
            stack_size = stack_size + type_r8 * size(del_p,1)
        end if
        
        !>del_z
        if(allocated(del_z)) then
            stack_size = stack_size + type_r8 * size(del_z,1)
        end if

        !>delecmigrationnew
        if(allocated(delecmigrationnew)) then
            stack_size = stack_size + type_r8 * size(delecmigrationnew, 1)
        end if
        
        !>dratedp
        if(allocated(dratedp)) then
            stack_size = stack_size + type_r8 * size(dratedp,1)
        end if
        
        !>dtota
        if(allocated(dtota)) then
            stack_size = stack_size + type_r8 * size(dtota,1)
        end if

        !>dtotaq
        if(allocated(dtotaq)) then
            stack_size = stack_size + type_r8 * size(dtotaq,1)
        end if
        
        !>dtotc
        if(allocated(dtotc)) then
            stack_size = stack_size + type_r8 * size(dtotc,1)
        end if
        
        !>dtotcflux
        if(allocated(dtotcflux)) then
            stack_size = stack_size + type_r8 * size(dtotcflux,1)
        end if

        !>dtotdp
        if(allocated(dtotdp)) then
            stack_size = stack_size + type_r8 * size(dtotdp,1)
        end if
        
        !>dtotg
        if(allocated(dtotg)) then
            stack_size = stack_size + type_r8 * size(dtotg,1)
        end if
        
        !>dtotgflux
        if(allocated(dtotgflux)) then
            stack_size = stack_size + type_r8 * size(dtotgflux,1)
        end if

        !>dtotor
        if(allocated(dtotor)) then
            stack_size = stack_size + type_r8 * size(dtotor,1)
        end if
        
        !!>dtotsb        
        !if(allocated(dtotsb)) then
        !    stack_size = stack_size + type_r8 * size(dtotsb,1)
        !end if
        
        !>dtotsb_ion       
        if(allocated(dtotsb_ion)) then
            stack_size = stack_size + type_r8 * size(dtotsb_ion,1)
        end if
        
        !>dtotsb_surf        
        if(allocated(dtotsb_surf)) then
            stack_size = stack_size + type_r8 * size(dtotsb_surf,1)
        end if
        
        !>dtotviscnew
        if(allocated(dtotviscnew)) then
            stack_size = stack_size + type_r8 * size(dtotviscnew,1)
        end if
        
        !>eqaq
        if(allocated(eqaq)) then
            stack_size = stack_size + type_r8 * size(eqaq,1)
        end if
        
        !>eqg
        if(allocated(eqg)) then
            stack_size = stack_size + type_r8 * size(eqg,1)
        end if
        
        !>eqm
        if(allocated(eqm)) then
            stack_size = stack_size + type_r8 * size(eqm,1)
        end if
        
        !>eqmx
        if(allocated(eqmx)) then
            stack_size = stack_size + type_r8 * size(eqmx,1)
        end if
        
        !>eqr
        if(allocated(eqr)) then
            stack_size = stack_size + type_r8 * size(eqr,1)
        end if
        
        !!>eqsb
        !if(allocated(eqsb)) then
        !    stack_size = stack_size + type_r8 * size(eqsb,1)
        !end if
        
        !>eqsb_ion
        if(allocated(eqsb_ion)) then
            stack_size = stack_size + type_r8 * size(eqsb_ion,1)
        end if
        
        !>eqsb_surf
        if(allocated(eqsb_surf)) then
            stack_size = stack_size + type_r8 * size(eqsb_surf,1)
        end if
        
        !>eqx
        if(allocated(eqx)) then
            stack_size = stack_size + type_r8 * size(eqx,1)
        end if
        
        !>gflux
        if(allocated(gflux)) then
            stack_size = stack_size + type_r8 * size(gflux,1)
        end if
        
        !>ginc
        if(allocated(ginc)) then
            stack_size = stack_size + type_r8 * size(ginc,1)
        end if
        
        !>gstor
        if(allocated(gstor)) then
            stack_size = stack_size + type_r8 * size(gstor,1)
        end if
        
        !>phic
        if(allocated(phic)) then
            stack_size = stack_size + type_r8 * size(phic,1)
        end if
        
        !>phicold
        if(allocated(phicold)) then
            stack_size = stack_size + type_r8 * size(phicold,1)
        end if
        
        !>phiinit
        if(allocated(phiinit)) then
            stack_size = stack_size + type_r8 * size(phiinit,1)
        end if
        
        !>rads
        if(allocated(rads)) then
            stack_size = stack_size + type_r8 * size(rads,1)
        end if
        
        !>rateaq
        if(allocated(rateaq)) then
            stack_size = stack_size + type_r8 * size(rateaq,1)
        end if
        
        !>ratecaq
        if(allocated(ratecaq)) then
            stack_size = stack_size + type_r8 * size(ratecaq,1)
        end if
        
        !>rated
        if(allocated(rated)) then
            stack_size = stack_size + type_r8 * size(rated,1)
        end if
        
        !>ratedp
        if(allocated(ratedp)) then
            stack_size = stack_size + type_r8 * size(ratedp,1)
        end if
        
        !>rateg
        if(allocated(rateg)) then
            stack_size = stack_size + type_r8 * size(rateg,1)
        end if
        
        !>ratemp
        if(allocated(ratemp)) then
            stack_size = stack_size + type_r8 * size(ratemp,1)
        end if
        
        !>rateor
        if(allocated(rateor)) then
            stack_size = stack_size + type_r8 * size(rateor,1)
        end if
        
        !>sataq
        if(allocated(sataq)) then
            stack_size = stack_size + type_r8 * size(sataq,1)
        end if
        
        !>satm
        if(allocated(satm)) then
            stack_size = stack_size + type_r8 * size(satm,1)
        end if
        
        !>totan
        if(allocated(totan)) then
            stack_size = stack_size + type_r8 * size(totan,1)
        end if
        
        !>totaq
        if(allocated(totaq)) then
            stack_size = stack_size + type_r8 * size(totaq,1)
        end if
        
        !>totcflux
        if(allocated(totcflux)) then
            stack_size = stack_size + type_r8 * size(totcflux,1)
        end if
        
        !>totcinc
        if(allocated(totcinc)) then
            stack_size = stack_size + type_r8 * size(totcinc,1)
        end if
        
        !>totcn
        if(allocated(totcn)) then
            stack_size = stack_size + type_r8 * size(totcn,1)
        end if
        
        !>totco
        if(allocated(totco)) then
            stack_size = stack_size + type_r8 * size(totco,1)
        end if
        
        !!>totcsn
        !if(allocated(totcsn)) then
        !    stack_size = stack_size + type_r8 * size(totcsn,1)
        !end if
        
        !>totcsn
        if(allocated(totcsn_ion)) then
            stack_size = stack_size + type_r8 * size(totcsn_ion,1)
        end if
        
        !>totcsn
        if(allocated(totcsn_surf)) then
            stack_size = stack_size + type_r8 * size(totcsn_surf,1)
        end if
        
        !>totdp
        if(allocated(totdp)) then
            stack_size = stack_size + type_r8 * size(totdp,1)
        end if
        
        !>totgflux
        if(allocated(totgflux)) then
            stack_size = stack_size + type_r8 * size(totgflux,1)
        end if
        
        !>totgn
        if(allocated(totgn)) then
            stack_size = stack_size + type_r8 * size(totgn,1)
        end if
        
        !>totor
        if(allocated(totor)) then
            stack_size = stack_size + type_r8 * size(totor,1)
        end if
        
        !>totrateg
        if(allocated(totrateg)) then
            stack_size = stack_size + type_r8 * size(totrateg,1)
        end if
        
        !>totratem
        if(allocated(totratem)) then
            stack_size = stack_size + type_r8 * size(totratem,1)
        end if
        
        !!>totsb
        !if(allocated(totsb)) then
        !    stack_size = stack_size + type_r8 * size(totsb,1)
        !end if
        
        !>totsb_ion
        if(allocated(totsb_ion)) then
            stack_size = stack_size + type_r8 * size(totsb_ion,1)
        end if
        
        !>totsb_surf
        if(allocated(totsb_surf)) then
            stack_size = stack_size + type_r8 * size(totsb_surf,1)
        end if
        
        !>totviscnewjvol
        if(allocated(totviscnewjvol)) then
            stack_size = stack_size + type_r8 * size(totviscnewjvol,1)
        end if
        
        !>vel_lin
        if(allocated(vel_lin)) then
            stack_size = stack_size + type_r8 * size(vel_lin,1)
        end if
        
        !>vsflux
        if(allocated(vsflux)) then
            stack_size = stack_size + type_r8 * size(vsflux,1)
        end if
        
        write(idbg, *) "estimate stack size: ", stack_size   
        
!        stack_size = stack_size  + 1048576         !1M = 1048576B, this value is for other private variable
!                                                    !not included in the above estimation
!#ifdef OPENMP        
!        stack_size_deft = KMP_GET_STACKSIZE_S()        
!        if(stack_size > stack_size_deft) then
!            write(idbg, *) "default stack size: ", stack_size_deft
!            write(idbg, *) "set stack size to: ", stack_size
!            call KMP_SET_STACKSIZE_S(stack_size)            !stack is set, but does not solve the problem of stack overflow, need further check
!        else
!            write(idbg, *) "use the default stack size: ", stack_size_deft
!        end if
!        stack_size_check = KMP_GET_STACKSIZE_S()
!        write(idbg, *) "check stack size:", stack_size_check
!#endif        

        
    end subroutine setstacksize
    
end module m_stacksize