!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/readsspc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readsspc
!c -------------------
!c
!c read database for secondary aqueous species and assign to 
!c permanent storage
!c
!c written by:      Uli Mayer - April 9, 96
!c
!c last modified:   Uli Mayer - December 6, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           ixdbs              = unit number, database for           + -
!c                                             secondary species in
!c                                             water phase
!c           ipsp               = unit number, list of possible       + -
!c                                             secondary aqueous 
!c                                             species, gases and 
!c                                             minerals
!c           ilog               = unit number, log book               + -
!c           idbg               = unit number debugging file          + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           alkfacx(nx)        = alkalinity factor for secondary     * +
!c                                aqueous species
!c           chargex(nx)        = charge of secondary aqueous         * +
!c                                species
!c           dhax(nx)           = debye-huckel a for secondary        * +
!c                                aqueous species
!c           dhbx(nx)           = debye-huckel b for secondary        * +
!c                                aqueous species
!c           dhcx(nx)           = enthalpy change for secondary       * +
!c                                aqueous species
!c           eqxs(nx)           = equilibrium constants for           * +
!c                                formation of secondary aqueous
!c                                species from free species
!c                                at standard temperature
!c           gfwx(nx)           = gram formula weight of secondary    * +
!c                                aqueous species
!c           xnux(nx*nc)        = stoichiometric coefficient matrix   * +
!c                                for formation of secondary aqueous
!c                                species from free species
!c
!c           integer*4:
!c           ----------
!c           iax(nx+1)          = row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                free species in
!c                                secondary aqueous species
!c           jax(nx*nc)         = column pointer array to             * +
!c                                stoichiometric coefficients of
!c                                free species in secondary aqueous
!c                                species
!c           nc                 = number of components including h2o  + -
!c           nx                 = number of secondary aqueous species + -
!c 
!c           logical:
!c           --------
!c           compute_alkalinity = .true.  -> calculate alkalinity     + -
!c           search_database    = .true.  -> search database for      + -
!c                                           all secondary species
!c                                           possible and list in
!c                                           file prefix_o.psp
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           namex(nx)          = names of secondary aqueous species  + -
!c           namet(30)          = species names of (temporary)        * *
!c
!c local:    real*8:
!c           -------
!c           alkfac             = alkalinity factor (temporary)
!c           charge             = charge (temporary)
!c           dha                = debye huckel a (temporary)
!c           dhb                = debye huckel b (temporary)
!c           dhc                = enthalpy change (temporary)
!c           eqt                = log equilibrium constant 
!c                                (temporary)
!c           gfw                = gram formula weight (temporary)
!c           xnuxt(iv)          = stoichiometric coefficient of 
!c                                component in secondary aqueous 
!c                                species (temporary)
!c
!c           integer*4:
!c           ----------
!c           nv                 = number of components with 
!c                                non-zero stoichiometric 
!c                                coefficient in secondary
!c                                aqueous species (temporary)
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueous 
!c                                species)
!c           icount             = counter (check number of species)
!c           iv                 = counter (number of components
!c                                with non-zero stoichiometric
!c                                coefficient in secondary
!c                                aqueous species
!c           icur               = counter (position in single
!c                                subscripted array)
!c           istart             = pointer
!c           iend               = pointer
!c           i                  = counter
!c           l_name             = length of name
!c
!c           logical:
!c           --------          
!c           done               = logical variable to stop search
!c           found              = logical variable to stop search
!c
!c           character:
!c           ----------
!c           name               = name of current secondary aqueous
!c                                species (temporary)
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readsspc(ixdbs,ipsp,ilog,idbg)
 
      use parm
      use chem
      use multidiff
      use gen, only : rank, b_enable_output
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif 
      implicit none
      
      integer :: ixdbs,ipsp,ilog,idbg
      
      integer :: i, ic, icount, icur, istart, iend, ix, iv, l_name,    &
                 nv, info_debug
      
      real*8 :: dhc, eqt, charge, dha, dhb, gfw, alkfac, xnuxt,        &
                sec_per_days

      character*72 name
      character*256 :: strbuffer
      dimension xnuxt(10)
      logical done,found
      real*8 null
      
!c  search database for possible secondary aqueous species

      if (search_database) then

        if (rank == 0 .and. b_enable_output) then  
          write(ipsp,'(72a/a/72a/)')('*',i=1,72),                      &
     &          'Possible aqueous species, gases and minerals',        &
     &          ('*',i=1,72)                                             
          write(ipsp,'(a)') 'secondary aqueous species'                  
          write(ipsp,'(a/)') '-------------------------' 
        end if
        
        do i = 1,10000                                                 
          if (compute_alkalinity) then                                 
            read(ixdbs,100,end=999,err=9999) name,dhc,eqt,charge,dha,  &
                                             dhb,gfw,alkfac
          else
            read(ixdbs,100,end=999,err=9999) name,dhc,eqt,charge,dha,  &
                                             dhb,gfw
          end if
          
          if (name.eq.'end') goto 999
          
          read(ixdbs,101,end=999,err=9999) nv,(namet(iv),xnuxt(iv),iv=1,nv)

!MX          if (name.eq.'end') goto 999

!c  check if all components with non-stoichiometric coefficients in
!c  secondary aqueous species are specified in general input file

          icount = 0
          ic = 0
          do while ((icount.lt.nv).and.(ic.lt.nc))
            ic = ic+1
            iv = 0
            found = .false.
            do while ((iv.lt.nv).and.(.not.found))
              iv = iv+1
              if (namet(iv).eq.namec(ic)) then
                found = .true.
                icount = icount+1
              end if
            end do
          end do

!c  report all possible secondary aqueous species
     
          if (icount.eq.nv) then
             l_name = index(name,' ')-1
             if (l_name.gt.72.or.l_name.eq.-1) then
               l_name = 72
             end if
             if (rank == 0 .and. b_enable_output) then
               write(ipsp,'(3a)') "'",name(:l_name),"'"
             end if
          end if

        end do             !loop over secondary species in database

999     continue

!c  rewind database file

        rewind(ixdbs)

      end if               !search_database

!c  initialize row pointer array for sparse matrix structure
 
      iax(1) = 1
 
!c  loop over secondary aqueous species specified for simulation
 
      do ix = 1,nx
 
!c  loop over secondary aqueous species in database,
!c  search for match and assign data to permanent storage
!c  exit when done or when end of file is reached
 
        done = .false.
 
        do while (.not.done)
 
!c  read name of secondary aqueous species and species specific data 
 
        if (.not.multi_diff) then 
          if (compute_alkalinity) then
            read(ixdbs,100,err=9999) name,dhc,eqt,charge,dha,dhb,gfw,alkfac
          else                           ! .not.compute_alkalinity
            read(ixdbs,100,err=9999) name,dhc,eqt,charge,dha,dhb,gfw
          end if !  compute_alkalinity
            read(ixdbs,101,err=9999) nv,(namet(iv),xnuxt(iv),iv=1,nv)
        end if !  .not.multi_diff 
! prc ----------------------------------------------------------------------------
! prc Reading diffusion coefficients from the "complex.dbs" database for 
! prc each secondary aqueous species
! prc ----------------------------------------------------------------------------

          if (multi_diff) then           
            if (compute_alkalinity) then            
                read(ixdbs,102,err=9999) name,dhc,eqt,charge,dha,dhb,gfw,alkfac,  &
     &               diffcoff2                
            else       ! .not.compute_alkalinity           
                read(ixdbs,102,err=9999) name,dhc,eqt,charge,dha,dhb,gfw,null,    &
     &               diffcoff2                
            end if     ! compute_alakalinity  
                  
            read(ixdbs,101,err=9999) nv,(namet(iv),xnuxt(iv),iv=1,nv)
          end if ! multi_diff          
    
! prc ----------------------------------------------------------------------------

          
 
!c  look for match, as long end of file is not reached or 
!c  match is found
 
!c  secondary aqueous species is found --> assign to permanent storage
 
          if (name.eq.namex(ix)) then
 
            done = .true.
 
!c  pointer array to row in stoichiometric reaction matrix for
!c  next secondary aqueous species
 
            iax(ix+1) = iax(ix)+nv
 
!c  check if all components with non-stoichiometric coefficients in
!c  secondary aqueous species are specified in general input file
!c  set up pointer array to column in stoichiometric matrix
 
            icount = 0
            ic = 0
            do while ((icount.lt.nv).and.(ic.lt.nc))
              ic = ic+1
              iv = 0
              found = .false.
              do while ((iv.lt.nv).and.(.not.found))
                iv = iv+1
                if (namet(iv).eq.namec(ic)) then
                  found = .true.
                  icount = icount+1
                  icur = iax(ix)+iv-1
                  jax(icur) = ic
                end if
              end do
            end do
 
!c  exit, if component is missing
 
            if (icount.ne.nv) then
              if (rank == 0) then  
                write(ilog,'(72a)') ('-',i=1,72)
                write(ilog,'(a,a12,a)')'component for ',               &
     &                               name,' is missing'
                write(ilog,'(72a)') ('-',i=1,72)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop
 
!c  all components available --> assign data to permanent storage
 
            elseif (icount.eq.nv) then
              dhcx(ix) = dhc
              eqxs(ix) = 10.0d0**(-eqt)
              chargex(ix) = charge
              dhax(ix) = dha
              dhbx(ix) = dhb
              gfwx(ix) = gfw
              if (compute_alkalinity) then
                alkfacx(ix) = alkfac
              end if
! prc ----------------------------------------------------------------------------
! prc Initialization of vector of diffusion coeff. of secondary aqueous species
! prc and conversion of time units for computation in days
! prc ----------------------------------------------------------------------------
            sec_per_days = 8.64d4
            
            if (multi_diff) then            
                mdiff_ix(ix)= diffcoff2 * sec_per_days            
            end if ! multi_diff
            
! prc ----------------------------------------------------------------------------
! prc ----------------------------------------------------------------------------                
 
!c  stoichiometric coefficients
 
              istart = iax(ix)
              iend = iax(ix+1)-1
              iv = 0
              do i = istart,iend
                iv = iv+1
                xnux(i) = xnuxt(iv)
              end do
            end if
 
!c  end of file is reached --> exit 
 
          elseif (name.eq.'end         ') then
            if (rank == 0) then
              write(ilog,'(72a)') ('-',i=1,72)
              write(ilog,'(a,a12,a)')                                  &
     &        'secondary aqueous species ',namex(ix),' not in database'
              write(ilog,'(72a)') ('-',i=1,72)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop
 
          end if
        end do                 !end - loop over database
 
!c  rewind database for secondary aqueous species to search for next 
!c  species, doing this allows the specification of species in an 
!c  arbitray order
 
        rewind(ixdbs)
 
      end do                   !end - loop over species
 
 100  format(a12,2x,2f10.4,16x,3f5.2,f9.4,f7.2)
 101  format(6x,i2,2x,20(a12,1x,f7.3,1x))            !by dsu, modify to support more than 5 products
! 101  format(6x,i1,3x,5(a12,1x,f7.3,1x)) 
! prc ----------------------------------------------------------------------------
! prc Defining new format for "complex.dbs",  last column for diffusion coefficients
! prc ----------------------------------------------------------------------------

 102  format(a12,2x,2f10.4,16x,3f5.2,f9.4,f7.2,f10.4)
  
! prc ----------------------------------------------------------------------------
! prc ----------------------------------------------------------------------------

!c  ---- activate this section for purposes of debugging -----
#ifdef DEBUG
      info_debug = 0
      
      if (info_debug.eq.1) then
        do ix=1,nx
          write(idbg,'(a,i3,2x,a72)') 'ix    = ',ix,namex(ix)
          write(idbg,'(a,f10.4)') 'dhcx(ix)     = ',dhcx(ix)
          write(idbg,'(a,f10.4)') 'eqxs(ix)     = ',dlog10(eqxs(ix))
          write(idbg,'(a,f10.4)') 'chargex(ix)  = ',chargex(ix)
          write(idbg,'(a,f10.4)') 'dhax(ix)     = ',dhax(ix)
          write(idbg,'(a,f10.4)') 'dhbx(ix)     = ',dhbx(ix)
          write(idbg,'(a,f10.4)') 'gfwx(ix)     = ',gfwx(ix)
          write(idbg,'(a,e10.3)') 'mdiff_ix(ix) = ',mdiff_ix(ix)
          if (compute_alkalinity) then
            write(idbg,'(a,f10.4)') 'alkfacx(ix)  = ',alkfacx(ix)
          end if
          write(idbg,'(a,i10)') 'iax    ',iax(ix)
 
!c
!c  echo check for stoichiometric coefficients
!c
          istart = iax(ix)
          iend = iax(ix+1)-1
          do i = istart, iend
            icur = jax(i)
            write(idbg,'(i5,2x,a72,a,i5,a,f10.3)') i,namec(icur),     &
     &                 ' jax ', jax(i),' xnux ',xnux(i)
          end do
          write(idbg,*)
          write(idbg,*) '---------------------------------------------'
          write(idbg,*)
        end do

#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
 
      end if
#endif

      return

9999  continue
      backspace(ixdbs)
      read(ixdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in secondary species database: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in secondary species database: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end
  
