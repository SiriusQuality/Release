!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 94 $
!> $Author: dsu $
!> $Date: 2013-06-11 23:43:47 +0200 (Tue, 11 Jun 2013) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/m_jacobi_omp.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!> Module of subroutines needed for building jacobi matrix in OPENMP environment
!> Modified by DSU, 2013
Module m_jacobi_omp

implicit real*8 (a-h,o-z)
  
contains

!c -----------------------------------------------------------------------
!c real*8 function vhoff_omp
!c ---------------------
!c
!c temperature correction 
!c - for equilibrium constants based on Van't Hoff equation
!c - for rate constants based on Arrhenius equation
!c
!c written by:      Uli Mayer - June 25, 99
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c
!c passed:   real*8:
!c           -------
!c           delta              = enthalpy or activation energy       + -
!c                                for reaction
!c           con                = equilibrium constant or rate        + -
!c                                constant for reaction at standard 
!c                                temperature
!c           rgascal            = ideal gas constant                  + -
!c           tempk              = temperature [K]                     + -
!c           tempks             = standard temperature [K]            + -
!c
!c
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c
!c
!c external: -
!c ----------------------------------------------------------------------
  
      real*8 function vhoff_omp(delta,con,tempk,tempks,rgascal)
 
      implicit real*8 (a-h,o-z)
 
      parameter (r1 = 1.0d0)
      
      vhoff_omp = con * dexp(delta/rgascal * (r1/tempks - r1/tempk))
 
      return

      end function

!c ----------------------------------------------------------------------
!c real*8 function acoff_omp
!c ---------------------
!c compute activity coefficient 
!c
!c written by:      Uli Mayer - October 10, 95
!c
!c last modified:   Uli Mayer - April 18, 96
!c                  implemented b-dot equation
!c                  Uli Mayer - February 4, 98
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of components        + -
!c                                as species in solution
!c           cx(nx)             = concentrations of secondary aqueous + -
!c                                species
!c           acth2omin          = min. activity of h2o                + -
!c           adav               = coefficient for davies equation     + -
!c           bdav               = coefficient for davies equation     + -
!c           dhad               = debye-huckel constant a_d           + -
!c                                depending on dielectric constant 
!c                                and temperature
!c           dhbd               = debye-huckel constant b_d           + -
!c                                depending on dielectric constant 
!c                                and temperature
!c           dha                = debye-huckel a                      + -
!c           dhb                = debye-huckel b                      + -
!c           charge             = charge of aqueous species           + -
!c           strion             = ionic strength                      + -
!c           acoff              = activity coefficient                * +
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components                + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           character:
!c           ----------
!c           name               = name of current dissolved species   + -
!c           namec(nc)          = component names                     + -
!c 
!c local:    real*8:
!c           ------- 
!c           c1                 = constant
!c           rstrion            = square root of ionic strength
!c           rtenth             = constant
!c           r0                 = constant
!c           r1                 = constant
!c           r10                = constant
!c           sumc               = sum of all aqueous species 
!c                                concentrations
!c           tiny               = constant
!c
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -
!c ---------------------------------------------------------------------- 

      real*8 function acoff_omp(c,cx,strion,charge,dha,dhb, & 
                           dhad,dhbd,adav,bdav,acth2omin,nc,nx, &
                           name,namec)

      implicit real*8 (a-h,o-z)

      intrinsic dabs,dsqrt
 
      character*12 name,namec
      dimension c(*),cx(*),namec(*)
 
      parameter (tiny = 1.0d-10, rtenth = 0.1d0, r0 = 0.0d0, &
                r1 = 1.0d0, r10 = 10.0d0, c1 = 0.017d0)
 

!c  exclude h2o

      if (name.ne.'h2o') then
 
!c  compute activity coefficient for charged species

        if (dabs(charge).gt.tiny) then

!c  exclude electron

          if (name.eq.'e-1') then

            acoff_omp = r1

          else 

!c  dissolved species

            rstrion  = dsqrt(strion) 
 
!c  debye-hueckel parameters in database --> use bdot-equation
 
            if (dabs(dha).gt.tiny) then
              acoff_omp = r10 ** &
                  ((-dhad*charge**2*rstrion)/ &
                   (r1+dhbd*dha*rstrion)+dhb*strion)
 
!c  otherwise --> use davies equation
 
            elseif (dabs(dha).lt.tiny) then
              acoff_omp = r10 ** &
                    (- adav*charge**2*(rstrion/(r1+rstrion) &
                     - bdav*strion))
            end if

          end if
 
!c  activity coefficient for uncharged species 
 
        elseif (dabs(charge).lt.tiny) then

          acoff_omp = r10 ** (rtenth * strion)

        end if 
 
!c  activity coefficient for h2o
      
      elseif (name.eq.'h2o') then
 
        sumc = r0
        do ic = 1,nc-1
          if (namec(ic).ne.'e-1') then
            sumc = sumc + c(ic)
          end if
        end do
        do ix = 1,nx
          sumc = sumc + cx(ix)
        end do
 
        acoff_omp = r1 - c1 * sumc

!c  constrain to minimum specified activity  
 
        acoff_omp = dmax1(acoff_omp,acth2omin)

      end if

      return

      end function

!c -----------------------------------------------------------------------
!c function satindex_omp
!c -------------------
!c
!c compute saturation index for species isp
!c
!c written by:      Uli Mayer - February 12, 96
!c
!c last modified:   Uli Mayer - September 8, 97
!c                  passed all variables
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           eqsp               = equilibrium constants of species    + -
!c           gammac(*)          = activity coefficients of components + -
!c                                as species in solution
!c           satindex           = saturation index for species isp    * +
!c           xnusp(*)           = stoichiometric coefficients of      + -
!c                                components in specie
!c
!c           integer*4:
!c           ----------
!c           ia(*)              = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           ja(*)              = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           isp                = pointer to current species          + -
!c
!c local:    real*8:
!c           -------
!c           prodiap            = ion activity product
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           i                  = counter (stoichiometric
!c                                coefficient in dense format)
!c           ic                 = counter (components) 
!c           istart             = pointer (stoichiometric 
!c                                coefficient of species isp)
!c           iend               = pointer (stoichiometric
!c                                coefficient of species isp+1)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      real*8 function satindex_omp (c,eqsp,gammac,xnusp,ia,ja,isp)
 
      implicit real*8 (a-h,o-z)
 
      dimension c(*),gammac(*),xnusp(*),ia(*),ja(*)

      parameter (r1 = 1.0d0)
 
      prodiap = r1
      istart = ia(isp)
      iend = ia(isp+1)-1
      do i = istart,iend
        ic = ja(i)
        prodiap = prodiap*(gammac(ic)*c(ic))**xnusp(i)
      end do
      satindex_omp = prodiap/eqsp
 
      return
      end function

!c ----------------------------------------------------------------------
!c subroutine dhconst_omp
!c ------------------
!c compute debye huckel constants a_d and b_d
!c taken from MINTEQA2
!c
!c written by:      Uli Mayer - April 18, 96 
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           dhad               = Debye Huckel constant a_d depending - +
!c                                on dielectric constant and
!c                                temperature
!c           dhbd               = Debye Huckel constant b_d depending - +
!c                                on dielectric constant and
!c                                temperature
!c           tconv              = temperature conversion factor       + -
!c           tempk              = temperature [deg K]                 + -
!c 
!c local:    real*8:
!c           -------
!c           s1                 = intermediate value
!c           s2                 = intermediate value
!c           s3                 = intermediate value
!c           bob1               = intermediate value
!c           bob2               = intermediate value
!c           bob3               = intermediate value
!c           bob4               = intermediate value
!c           cc1                = intermediate value
!c  
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine dhconst_omp(dhad,dhbd,tempk,tconv)
 
      implicit real*8 (a-h,o-z)

!c  compute temperature in [deg C]
  
      tempc = tempk - tconv
     
!c  this subroutine which computes the Debye-Huckel
!c  constants as a function of temperature was taken directly
!c  from WATEQ2 (Ball et al. 1979). The mathematics is documented
!c  in Truesdell and Jones (1974).

      s1 = 374.11d0-tempc
      s2 = s1**(1.0d0/3.0d0)
      bob1 = (1.0d0+0.1342489d0*s2-3.946263d-03*s1)
      bob2 = (3.1975d0-0.3151548d0*s2-1.203374d-3*s1)
      bob3 = (7.48908d-13*s1**4.0d0)
      bob4 = bob2+bob3
      s3 = dsqrt(bob1/bob4)
      if (tempk.lt.373.16d0) then
         cc1 = 87.74d0-tempc*(tempc*(1.41d-6*tempc-9.398d-4)+0.4008d0)
      else
         cc1 = 5321d0/tempk+233.76d0-tempk*(tempk*(8.29d-7*tempk- &
           1.417d-3)+.9297d0)
      endif
 
      cc1 = dsqrt(cc1*tempk)
      dhad = 18246d2*s3/cc1**3.0d0
      dhbd = 50.29d0*s3/cc1
 
      return
      end subroutine

!c ----------------------------------------------------------------------
!c subroutine secspec_omp
!c ------------------
!c compute concentration of secondary species based on concentrations 
!c of primary species according to the law of mass action 
!c
!c written by:      Uli Mayer - October 10, 95
!c
!c last modified:   Uli Mayer - April 10, 96
!c                  sparse format for stoichiometric coefficients
!c                  Uli Mayer - November 15, 96
!c                  
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of primary species   + -
!c           c2                 = concentration of secondary species  * +
!c           eq2                = equilibrium constant for formation  + -
!c                                of secondary species from primary 
!c                                species
!c           gammac1(*)         = activity coefficients for primary   + -
!c                                species
!c           gammac2            = activity coefficients for           + -
!c                                secondary species
!c           xnuc(*)            = stoichiometric coefficient of       + -
!c                                primary species in secondary 
!c                                species
!c
!c           integer*4:
!c           ----------
!c           ia(*)              = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                primary species in secondary 
!c                                species
!c           i2                 = pointer to secondary species        + -
!c           ja(*)              = column pointer array to             + -
!c                                stoichiometric coefficients of 
!c                                primary species in secondary 
!c                                species 
!c           n                  = number of primary species           + -
!c
!c
!c local:    integer*4:
!c           ----------
!c           ic               = counter (free species)
!c           istart           = pointer (stoichiometric coefficients)
!c           iend             = pointer (stoichiometric coefficients)
!c           i                = counter (stoichiometric coefficients)
!c
!c external: -  
!c ----------------------------------------------------------------------
  
      subroutine secspec_omp(c,c2,eqc2,gammac1,gammac2,xnuc2,ia,ja,n,i2)
 
      implicit real*8 (a-h,o-z)

      dimension c(*),gammac1(*),xnuc2(*),ia(*),ja(*)
      parameter (r1 = 1.0d0)

!c  compute secondary species concentration 

      c2 = r1/(gammac2*eqc2)
 
      istart = ia(i2)
      iend = ia(i2+1)-1
      do i = istart,iend
        i1 = ja(i)
        c2 = c2 * (gammac1(i1)*c(i1))**xnuc2(i)
      end do

      return
      end subroutine

!c ----------------------------------------------------------------------
!c subroutine ionstr_omp 
!c -----------------
!c compute ionic strength 
!c
!c written by:      Uli Mayer - October 10, 95
!c
!c last modified:   Uli Mayer - November 15, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           ------- 
!c           c(nc)            = concentrations of free species        + -
!c           cx(nx)           = concentrations of secondary aqueous   + -
!c                              species
!c           chargec(nc)      = charge of free species                + -
!c           chargex(nx)      = charge of secondary aqueous species   + -
!c           strion           = ionic strength of solution            * +
!c
!c           integer*4:
!c           ----------
!c           nc               = number of components                  + -
!c           nx               = number of secondary aqueous species   + -
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c
!c local:    real*8:
!c           -------
!c           r0               = constant
!c           rhalf            = constant
!c
!c           integer*4:
!c           ----------
!c           ic               = counter (free species)
!c           ix               = counter (secondary aqueous species)
!c
!c external: -
!c ---------------------------------------------------------------------- 

      subroutine ionstr_omp(c,cx,strion,chargec,chargex,nc,nx,namec)

      implicit real*8 (a-h,o-z)

      character*12 namec
      dimension c(*),cx(*),chargec(*),chargex(*),namec(*)
      parameter (r0 = 0.0d0, rhalf = 0.5d0)

!c  initialize ionic strength

      strion = r0
 
!c  free species (excluding h2o)
 
      do ic=1,nc
        if (namec(ic).ne.'e-1') then
          strion = strion + chargec(ic)**2 * c(ic)
        end if
      end do
 
!c  secondary aqueous species
 
      do ix=1,nx
        strion = strion + chargex(ix)**2 * cx(ix)
      end do
 
!c  calculate final value
 
      strion = rhalf * strion
      
      return
      end subroutine

   
!c ----------------------------------------------------------------------
!c subroutine molconc_omp
!c ------------------
!c
!c compute average molar concentration of organic mixture
!c
!c written by:      Uli Mayer - January 17, 00
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           phim(nm)           = volume fractions of minerals        + -
!c
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           conc_mol_avg       = average molar concentration of      + -
!c                                organic mixture 
!c           densm(nm)          = density of free phase product       + -
!c           gfwm(nm)           = gram formula weight of free phase   + -
!c                                product
!c
!c           integer*4:
!c           ----------
!c           nm                 = number of minerals specified        + -
!c
!c           character:
!c           ----------
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c
!c
!c local:    real*8:
!c           -------
!c           r0                = constant
!c
!c           integer*4:
!c           ----------
!c           im                = counter
!c
!c external: -
!c ----------------------------------------------------------------------
      subroutine molconc_omp(phim, conc_mol_avg_omp, conc_mol_add_omp, eqm_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)

      real*8 :: conc_mol_avg_omp
      real*8 :: conc_mol_add_omp
      real (type_r8), allocatable :: eqm_omp(:)

      dimension phim(*)

      parameter (r0 = 0.0d0, r2 = 2.0d0, huge = 1.0d300)

!c  compute average molar concentration for organic mixture
      conc_mol_avg_omp = r0
      conc_mol_add_omp = huge
   
      do im = 1,nm
   
        if (reaction_type(im).eq.'raoult') then
        conc_mol_avg_omp = conc_mol_avg_omp         &
     &                 + phim(im)*densm(im)/gfwm(im)
	    conc_mol_add_omp = dmin1(conc_mol_add_omp,eqm_omp(im))
        end if
   
      end do

!cff1d      conc_mol_avg = conc_mol_avg + 1.0d-7       !2D and 3D
        conc_mol_avg_omp = conc_mol_avg_omp + r2*conc_mol_add_omp   !1D    
	return
      end subroutine
      
!c ----------------------------------------------------------------------
!c subroutine raoult_omp
!c ------------------
!c
!c compute dissolution rate for organic contaminant from organic mixture
!c
!c sign convention: dissolution -
!c
!c written by:      Uli Mayer - January 17, 00
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c                                - new time level [moles/l water]
!c           gammac(nc)         = activity coefficients of components + -
!c                                as species in solution
!c           phim               = volume fractions of minerals        + -
!c           phimold            = volume fractions of minerals        + -
!c                                - old time level
!c           ratem              = absolute dissolution-precipitation  * +
!c                                rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(nc)           = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/l h2o]
!c
!c           integer*4:
!c           ----------
!c           im                = counter
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           conc_mol_avg       = average molar concentration of      + -
!c                                organic mixture 
!c           densm(nm)          = density of free phase product       + -
!c           eqm(nm)            = solubility constant for organic     + -
!c                                compound
!c           gfwm(nm)           = gram formula weight of free phase   + -
!c                                product
!c           rated(ndr*nm)      = rate constants for dissolution      + -
!c                                reactions
!c           ratemp(ndr*nm)     = reaction rates for minerals         * +
!c                                including parallel reactions
!c           satm(nm)           = IAP/K for free phase product        + -
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in free phase product
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c
!c           character:
!c           ----------
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c
!c
!c local:    real*8:
!c           -------
!c           conc_mol          = molar concentration of organic
!c                               compound in organic mixture
!c           frac_mol          = mole fraction of organic compound
!c                               in organic mixture
!c           r0                = constant
!c           r1                = constant
!c
!c           integer*4:
!c           ----------
!c           i1                = counter 
!c           ireac             = counter
!c           istart            = pointer
!c           istop             = pointer
!c
!c external: satindex  = compute saturation index
!c ----------------------------------------------------------------------
      subroutine raoult_omp(c,gammac,ratem,phim,phimold,aream,im, &
      conc_mol_avg_omp, satm_omp, ratemp_omp, eqm_omp, rated_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real (type_r8) :: conc_mol, frac_mol
      real (type_r8) :: conc_mol_avg_omp
      real (type_r8), allocatable :: satm_omp(:)
      real (type_r8), allocatable :: ratemp_omp(:)
      real (type_r8), allocatable :: eqm_omp(:) 
      real (type_r8), allocatable :: rated_omp(:)     

      dimension c(*),gammac(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

!c  compute effective dissolution rate

      if (reaction_type(im).eq.'raoult') then

!c  compute mol fraction of organic compound in organic mixture

        conc_mol = phimold*densm(im)/gfwm(im)           !local variable
        frac_mol = conc_mol/conc_mol_avg_omp

!c  pure phase saturation index
        satm_omp(im) = satindex_omp(c,eqm_omp(im),gammac,xnum,iam,jam,im)

!c  compute effective solubility
        satm_omp(im) = satm_omp(im)/frac_mol

!c  compute reaction rate for dissolution of organic compound
        ratem = r0
!c  consider parallel reaction pathways

        istart = iamd(im)
        istop = iamd(im+1)-1

        do ireac = istart,istop
          ratemp_omp(ireac) = - aream * rated_omp(ireac) * frac_mol   &
     &                    * eqm_omp(im) * (r1 - satm_omp(im))
          ratem = ratem + ratemp_omp(ireac)
        end do
        ratem = ratem*phimold/(phimold+1.0d3*phimin(im))

!c set rate to zero, if organic is depleted

        if (phimold.lt.phimin(im)+1.0d-3*phimin(im)) then
          do ireac = istart,istop
            ratemp_omp(ireac) = r0
          end do
          ratem = r0
        end if

      end if           !(reaction_type)

      return
      end subroutine
      
!c ----------------------------------------------------------------------
!c subroutine ratemin_new_omp
!c ----------------------
!c
!c compute absolute dissolution-precipitation rates of minerals
!c based on new database format
!c
!c sign convention: dissolution -
!c                  precipitation +
!c
!c written by:      Uli Mayer - November 11, 01
!c
!c last modified:   Uli Mayer - February 3, 02
!c                  added hyperbolic and inhibition terms
!c                  for minerals
!c                  Uli Mayer - August 8, 02
!c                  added hyperbolic and inhibition terms 
!c                  for components as species in solution 
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           gammax(nx)         = activity coefficient of             + -
!c                                secondary aqueous species
!c           phim               = volume fractions of minerals        + -
!c           phimold            = volume fractions of minerals        + -
!c                                - old time level
!c           ratem              = absolute dissolution-precipitation  * +
!c                                rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(nc)           = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/l h2o]
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           diffm(ndr*nm)      = free diffusion coefficient of       + -
!c                                primary reactant in water
!c                                (transport controlled reactions)
!c           eqm(nm)            = equilibrium constants for minerals  + -
!c           fmdi(nrc*nc)       = inhibition constants - T^a          + - 
!c           fmdm(nrc*nc)       = half saturation constants - T^a     + -
!c           fmic(nrc*nc)       = inhibition constants - C^c          + - 
!c           fmhc(nrc*nc)       = half saturation constants - C^c     + -
!c           fmdpi(nrc*nm)      = inhibition constants - phi^m        + - 
!c           fmdpm(nrc*nm)      = half saturation constants - phi^m   + -
!c           orddc(nrc*nm)      = order of free species in            + -
!c                                dissolution reaction
!c           orddcx(nrc*nm)     = order of secondary aqueous          + -
!c                                species in dissolution reaction
!c           orddt(nrc*nm)      = order of total aqueous component    + -
!c                                concentration in dissolution
!c                                reaction
!c           ordmdi(nrc*nc)     = order of inhibition terms for       + -
!c                                dissolution-precipitation reactions
!c                                - T^a
!c           ordmdm(nrc*nc)     = order of hyperbolic terms for       + -
!c                                dissolution-precipitation reactions
!c                                - T^a
!c           ordmic(nrc*nc)     = order of inhibition terms for       + -
!c                                dissolution-precipitation reactions
!c                                - C^c
!c           ordmhc(nrc*nc)     = order of hyperbolic terms for       + -
!c                                dissolution-precipitation reactions
!c                                - C^c
!c           ordmdpi(nrc*nm)    = order of inhibition terms for       + -
!c                                dissolution-precipitation reactions
!c                                - phi^m
!c           ordmdpm(nrc*nm)    = order of hyperbolic terms for       + -
!c                                dissolution-precipitation reactions
!c                                - phi^m
!c           ordm(ndr*nm)       = exponent m for reaction rate law    + -
!c           ordn(ndr*nm)       = exponent n for reaction rate law    + -
!c           rated(ndr*nm)      = rate constants for dissolution      + -
!c                                reactions
!c           ratemp(ndr*nm)     = reaction rates for minerals         * +
!c                                including parallel reactions
!c           satm(nm)           = saturation indices                  * +
!c           xnud(ndr*nm)       = stoichiometric coefficients of      + -
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of      + +
!c                                components in mineral
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution        + -
!c                                reactions
!c           iamdc(ndr*nm+1)    = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - T^a)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - T^a)
!c           iamic(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - C^c)
!c           iamhc(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - C^c)
!c           iamdpi(ndr*nm+1)   = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms 
!c                                - phi^m)
!c           iamdpm(ndr*nm+1)   = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms 
!c                                - phi^m)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamdc(nrc*nm)      = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - T^a)
!c           jamdm(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - T^a)
!c           jamic(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - C^c)
!c           jamhc(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - C^c)
!c           jamdpi(nrc*nm)     = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - 
!c                                phi^m)
!c           jamdpm(nrc*nm)     = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - phi^m)
!c           jamdt(nrc*nm)      = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c           nx                 = number of aqueous complexes         + -
!c
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!crevaff           
!c           reverse_affinity_term(nm) = .true. -> reverse affinity   + - 
!c                                                 term if IAP/K > 1                   
!crevaff
!c
!c           character:
!c           ----------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = type of dissolution-precipitation   + -
!c                                reaction
!c
!c local:    real*8:
!c           -------
!c           prodrc             = product of reacting species
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           ireac              = counter (number of dissolution/ 
!c                                         precipitation reactions)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ic                 = counter (components)
!c           im2                = counter (minerals)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: raoult   = compute dissolution rate of organic compound
!c                      from organic mixture based on raoult's law
!c ----------------------------------------------------------------------
      subroutine ratemin_new_omp(totc,c,cx,gammac,gammax,ratem,phim,       &
                             phimold,aream,im, conc_mol_avg_omp, satm_omp, &
                             ratemp_omp, eqm_omp, rated_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      
      real (type_r8) :: r1_iap_k
      real (type_r8) :: prodrc
      real (type_r8) :: conc_mol_avg_omp
      real (type_r8), allocatable :: satm_omp(:)
      real (type_r8), allocatable :: ratemp_omp(:)
      real (type_r8), allocatable :: eqm_omp(:) 
      real (type_r8), allocatable :: rated_omp(:)

      dimension c(*),cx(*),gammac(*),gammax(*),totc(*),phim(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

!c  compute dissolution rate for organic compound based on Raoult's law

      if (reaction_type(im).eq.'raoult') then
        call raoult_omp(c,gammac,ratem,phim(im),phimold,aream,im,      &
        conc_mol_avg_omp, satm_omp, ratemp_omp, eqm_omp, rated_omp)
        return

      end if

!c  initialize total reaction rate
      ratem = r0

!c  initialize parallel reaction rates

      istart = iamd(im)
      istop = iamd(im+1)-1

      do ireac = istart,istop
        ratemp_omp(ireac) = r0
      end do

!c  calculate saturation index for current mineral except for
!c  far from equilibrium dissolution-precipitation reactions

      if (.not.far_from_equil(im)) then
        satm_omp(im) = eqm_omp(im)**(-r1)

        istart = iam(im)
        istop = iam(im+1)-1
        do i1 = istart,istop
          ic = jam(i1)
          satm_omp(im) = satm_omp(im) * (gammac(ic)*c(ic))**xnum(i1)
        end do

      end if
!c  compute total dissolution/precipitation rate for surface controlled
!c  dissolution/precipitation reactions

      if (rate_control(im).eq.'surface') then

!c  compute rates only for specified reaction direction
        if (reaction_type(im).eq.'reversible' .or.                      &
     &      reaction_type(im).eq.'dissolution_far_from_equilibrium' .or.&
     &      (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
     &       r1-satm_omp(im).gt.r0) .or.                                &
     &      reaction_type(im).eq.                                       &
     &      'precipitation_far_from_equilibrium' .or.                   &
     &      (reaction_type(im).eq.'precipitation_to_equilibrium'.and.   &
     &       r1-satm_omp(im).lt.r0)) then

!c  loop over parallel dissolution reactions

          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop
  
!c  scale reaction rate depending on equilibrium condition except
!c  for far-from-equilibrium reactions 

            if (reaction_type(im).eq.                                 &
     &          'dissolution_far_from_equilibrium') then

              prodrc = -rated_omp(ireac)
                                                                       
            elseif (reaction_type(im).eq.                             &
     &             'precipitation_far_from_equilibrium') then
              prodrc = rated_omp(ireac)

!culi 18/05/06 modified formulation for precipitation_to_equilibrium   !MX sept2012
!culi to avoid excessively large precipitation rates 
            elseif (reaction_type(im).eq.                             &
     &             'precipitation_to_equilibrium') then              
              prodrc = rated_omp(ireac) * (r1 - satm_omp(im)**-r1)
            else

!c  commented out to avoid NaN problems              
              ! prodrc = -rated(ireac)                                 &
              !        * (r1 - satm(im)**ordm(ireac))**ordn(ireac)
              ! 
              !if(isnan(prodrc)) then
              !    write(*,*) "prodrc is nan4: ", r1 - satm(im)**ordm(ireac),  ordn(ireac)
              !end if
              
              !Lasaga et al. (1994) equation. dsu, 2012-12-20
              
              if (b_ratelaw_exponent_n) then

                if (reverse_affinity_term(im).and.satm_omp(im).gt.r1) then
!crevaff
                    prodrc = rated_omp(ireac) * (r1 - satm_omp(im)**-ordm(ireac))**ordn(ireac)

!crevaff
                else
                  r1_iap_k = r1 - satm_omp(im)**ordm(ireac)

                  if(r1_iap_k>0) then       !satm(im) < 1 as ordm(ireac) is positive
                      if (reaction_type(im) == 'precipitation_to_equilibrium') then
                          prodrc = 0.0d0
                      else
                          prodrc = -rated_omp(ireac) * r1_iap_k**ordn(ireac)
                      end if
                  else                      !satm(im) >= 1 as ordm(ireac) is positive 
                      if (reaction_type(im) == 'dissolution_to_equilibrium') then
                          prodrc = 0.0d0
                      else
                          prodrc = rated_omp(ireac) * (abs(r1_iap_k))**ordn(ireac)
                      end if
                  end if
                  
                end if  
                  
              else
!crevaff
                if (reverse_affinity_term(im).and.satm_omp(im).gt.r1) then
                    prodrc = rated_omp(ireac) * (r1 - satm_omp(im)**-ordm(ireac))
                else
                    prodrc = -rated_omp(ireac) * (r1 - satm_omp(im)**ordm(ireac))
                end if  
!crevaff                
              end if
              
     !--old--
     !         prodrc = -rated(ireac)                                  &
     !&               * (r1 - satm(im)**ordm(ireac))
     	        
            end if

	      
!c  form product of reacting components in terms of total 
!c  aqueous component concentrations

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)

            end do

!c  form product of reacting components as species in solution

            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdc(i1)
              prodrc = prodrc * (gammac(ic)*c(ic))**orddc(i1)

            end do

!c  form product of reacting complexed species

            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1

            do i1 = istart2,istop2

              ix = jamdcx(i1)
              prodrc = prodrc * (gammax(ix)*cx(ix))**orddcx(i1)

            end do

!c  hyperbolic terms - T^a

            istart2 = iamdm(ireac)
            istop2 = iamdm(ireac+1)-1
      
            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdm(i1)

                prodrc = prodrc                                       &
     &                 * (totc(ic)/(fmdm(i1) + totc(ic)))**ordmdm(i1)

              end do

            end if

!c  inhibition terms - T^a

            istart2 = iamdi(ireac)
            istop2 = iamdi(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdi(i1)

                prodrc = prodrc                                       &
     &                 * (fmdi(i1)/(fmdi(i1)+totc(ic)))**ordmdi(i1)

              end do

            end if

!c  hyperbolic terms - C^c

            istart2 = iamhc(ireac)
            istop2 = iamhc(ireac+1)-1
      
            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamhc(i1)

                prodrc = prodrc                                       &
     &                 * (gammac(ic)*c(ic)                            &
     &                 / (fmhc(i1) + gammac(ic)*c(ic)))**ordmhc(i1)

              end do

            end if

!c  inhibition terms - C^c

            istart2 = iamic(ireac)
            istop2 = iamic(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamic(i1)

                prodrc = prodrc                                       &
     &                 * (fmic(i1)                                    &
     &                 / (fmic(i1)+gammac(ic)*c(ic)))**ordmic(i1)

              end do

            end if

!c  hyperbolic terms - phi^m

            istart2 = iamdpm(ireac)
            istop2 = iamdpm(ireac+1)-1
      
            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                im2 = jamdpm(i1)

                prodrc = prodrc * (phim(im2) /                        &
     &                   (fmdpm(i1) + phim(im2)))**ordmdpm(i1)

              end do

            end if

!c  inhibition terms - phi^m

            istart2 = iamdpi(ireac)
            istop2 = iamdpi(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                im2 = jamdpi(i1)

                prodrc = prodrc * (fmdpi(i1) /                        &
     &                   (fmdpi(i1) + phim(im2)))**ordmdpi(i1)

              end do

            end if

!c  compute total rate for surface controlled reactions
!c  [moles/(l bulk*day)] = [m^2 mineral/l bulk]
!c                          ----------- 
!c                       * [moles/(m^2 mineral * day)]
!c                                 -----------
            ratemp_omp(ireac) = aream * prodrc

!c  sum up parallel reaction rates for surface controlled
!c  dissolution/precipitation reactions
            ratem = ratem + ratemp_omp(ireac)

          end do       !loop over parallel diss/prec reactions

        else           !reaction_type
          ratem = r0
 
        end if         !reaction_type

!c  compute total dissolution rate for transport 
!c  controlled dissolution reactions

      elseif (rate_control(im).eq.'transport') then
        if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
     &      reaction_type(im).eq.'reversible'.or.                      &
     &      (reaction_type(im).eq.'dissolution_to_equilibrium'.and.    &
     &       r1-satm_omp(im).gt.r0)) then

!c  compute total dissolution rate 
 
          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop

!c  scale reaction rate, if dissolution reaction is limited by
!c  equilibrium conditions 

            if (far_from_equil(im)) then
              prodrc = r1
            else
              prodrc = r1-satm_omp(im) 
            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
            end do

!c  form product of reacting component species for current dissolution
!c  reaction, activity coefficients are here not considered explicitely,
!c  but are by definition included in the effective diffusion coefficient
 
            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdc(i1)
              prodrc = prodrc * c(ic)**orddc(i1)
            end do
 
!c  include complexed species in product of reacting species for current
!c  dissolution reaction
 
            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1
            do i1 = istart2,istop2
              ix = jamdcx(i1)
              prodrc = prodrc * cx(ix)**orddcx(i1)
            end do
 
!c  compute rate
!c  [moles/(l bulk*day)] = [m mineral / m^3 bulk]
!c                          ---------   ---
!c                       * [m^3 h2o/m^3 mineral * m^2 mineral/day]
!c                          --- --- -----------   -----------
!c                       * [moles/l h2o]
!c                                  ---
            ratemp_omp(ireac) = - aream * diffm(ireac)/xnud(ireac) * prodrc
!c  sum up parallel rates
            ratem = ratem + ratemp_omp(ireac)

          end do  
 
!c  set reaction rate to zero for all other conditions
 
        else
          ratem = r0
 
        end if          !(reaction_type(im))

      end if            !(rate_control(im))
 
!cdbg
      info_debug = 0
      if (info_debug.gt.0) then
        write(*,'(a,e12.5)') 'ratem = ',ratem
        write(*,'(a,e12.5)') 'phim = ', phim(im)
        write(*,'(a,e12.5)') 'phimold = ', phimold
        write(*,'(a,e12.5)') 'aream = ', aream
      end if
      if (info_debug.eq.1) then
        pause
      end if
!cdbg

      return
      end subroutine

!c ----------------------------------------------------------------------
!c subroutine ratemin_omp
!c ------------------
!c
!c compute absolute dissolution-precipitation rates of minerals
!c
!c sign convention: dissolution -
!c                  precipitation +
!c
!c written by:      Uli Mayer - February 8, 96
!c
!c last modified:   THH March 18, 2005 
!c                  line 301 form ratenew
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           gammax(nx)         = activity coefficient of             + -
!c                                secondary aqueous species
!c           phim               = volume fractions of minerals        + -
!c           phimold            = volume fractions of minerals        + -
!c                                - old time level
!c           ratem              = absolute dissolution-precipitation  * +
!c                                rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(nc)           = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/l h2o]
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           diffm(ndr*nm)      = free diffusion coefficient of       + -
!c                                primary reactant in water
!c                                (transport controlled reactions)
!c           eqm(nm)            = equilibrium constants for minerals  + -
!c           fmdi(nrc*nm)       = inhibition factors                  + - 
!c           fmdm(nrc*nm)       = monod factors                       + -
!c           orddc(nrc*nm)      = order of free species in            + -
!c                                dissolution reaction
!c           orddcx(nrc*nm)     = order of secondary aqueous          + -
!c                                species in dissolution reaction
!c           orddt(nrc*nm)      = order of total aqueous component    + -
!c                                concentration in dissolution
!c                                reaction
!c           ordmdm(nrc*nm)     = order of monod terms for            + -
!c                                dissolution-precipitation reactions
!c           ordm(ndr*nm)       = exponent m for reaction rate law    + -
!c           ordn(ndr*nm)       = exponent n for reaction rate law    + -
!c           rated(ndr*nm)      = rate constants for dissolution      + -
!c                                reactions
!c           ratemp(ndr*nm)     = reaction rates for minerals         * +
!c                                including parallel reactions
!c           satm(nm)           = saturation indices                  * +
!c           xnud(ndr*nm)       = stoichiometric coefficients of      + -
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of      + +
!c                                components in mineral
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution        + -
!c                                reactions
!c           iamdc(ndr*nm+1)    = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamdc(nrc*nm)      = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           jamdm(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           jamdt(nrc*nm)      = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c           nx                 = number of aqueous complexes         + -
!c
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c
!c           character:
!c           ----------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = product of reacting species
!c           termmdm            = monod terms
!c           termmdi            = inhibition and toxicity terms
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           ireac              = counter (number of dissolution/ 
!c                                         precipitation reactions)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueosu species)
!c
!c external: raoult   = compute dissolution rate of organic compound
!c                      from organic mixture based on raoult's law
!c ----------------------------------------------------------------------
      subroutine ratemin_omp(totc,c,cx,gammac,gammax,ratem,phim,    &
                      phimold,aream,im, conc_mol_avg_omp, satm_omp, &
                      ratemp_omp, eqm_omp, rated_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      
      real (type_r8) :: r1_iap_k
      real (type_r8) :: prodrc
      real (type_r8) :: termmdm, termmdi
      real (type_r8) :: conc_mol_avg_omp
      real (type_r8), allocatable :: satm_omp(:)
      real (type_r8), allocatable :: ratemp_omp(:)
      real (type_r8), allocatable :: eqm_omp(:) 
      real (type_r8), allocatable :: rated_omp(:)
      
      dimension c(*),cx(*),gammac(*),gammax(*),totc(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

!c  compute dissolution rate for organic compound based on Raoult's law

      if (reaction_type(im).eq.'raoult') then
        call raoult_omp(c,gammac,ratem,phim,phimold,aream,im,      &
        conc_mol_avg_omp, satm_omp, ratemp_omp, eqm_omp, rated_omp)

        return

      end if

!c  initialize total reaction rate

      ratem = r0

!c  initialize parallel reaction rates

      istart = iamd(im)
      istop = iamd(im+1)-1

      do ireac = istart,istop
        ratemp_omp(ireac) = r0
      end do

!c  calculate saturation index for current mineral except for
!c  far from equilibrium dissolution-precipitation reactions

      if (.not.far_from_equil(im)) then
        satm_omp(im) = eqm_omp(im)**(-r1)

        istart = iam(im)
        istop = iam(im+1)-1
        do i1 = istart,istop
          ic = jam(i1)
          satm_omp(im) = satm_omp(im) * (gammac(ic)*c(ic))**xnum(i1)
        end do

      end if

!c  compute total dissolution/precipitation rate for surface controlled
!c  dissolution/precipitation reactions

      if (rate_control(im).eq.'surface') then

!c  compute rates only for specified reaction direction
        if (reaction_type(im).eq.'reversible' .or.                    &
     &     reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
     &     (reaction_type(im).eq.'dissolution_to_equilibrium'.and.    &
     &     r1-satm_omp(im).gt.r0) .or.                                &
     &     reaction_type(im).eq.                                      &
     &     'precipitation_far_from_equilibrium' .or.                  &
     &     (reaction_type(im).eq.'precipitation_to_equilibrium'.and.  &
     &     r1-satm_omp(im).lt.r0).or.                                 &
     &     reaction_type(im).eq.'monod') then

!c  compute monod and inhibition terms, if applicable

          if (reaction_type(im).eq.'monod') then

!c  fractional order terms


!c  monod terms

            istart2 = iamdm(im)
            istop2 = iamdm(im+1)-1
            termmdm = r1
      
            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdm(i1)

                termmdm = termmdm                                     &
     &                  * (totc(ic)/(fmdm(i1) + totc(ic)))**ordmdm(i1)

              end do

            end if

!c  inhibition terms

            istart2 = iamdi(im)
            istop2 = iamdi(im+1)-1
            termmdi = r1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdi(i1)

                termmdi = termmdi * fmdi(i1)/(fmdi(i1)+totc(ic))

              end do

            end if

!c  affinity term

          end if       !(reaction_type(im).eq.'monod')

!c  loop over parallel dissolution reactions

          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop
  
!c  scale reaction rate depending on equilibrium condition except
!c  for far-from-equilibrium reactions 

            if (reaction_type(im).eq.                                 &
     &          'dissolution_far_from_equilibrium'.or.                &
     &           reaction_type(im).eq.'monod') then
              prodrc = -rated_omp(ireac)                                                                 
                                                                       
            elseif (reaction_type(im).eq.                             &
     &             'precipitation_far_from_equilibrium') then

              prodrc = rated_omp(ireac)

            else

!c THH lattice edits
!c  commented out to avoid NaN problems              
             !prodrc = -rated(ireac)                                     &
             !       * (r1 - satm(im)**ordm(ireac))**ordn(ireac)
             !
             ! if(isnan(prodrc)) then
             !     write(*,*) "prodrc is nan3: ", r1 - satm(im)**ordm(ireac),  ordn(ireac)
             ! end if
             
             !Lasaga et al. (1994) equation. dsu, 2012-12-20
             
             if (b_ratelaw_exponent_n) then
                  r1_iap_k = r1 - satm_omp(im)**ordm(ireac)

                 if (r1_iap_k > 0) then
                     if (reaction_type(im) == 'precipitation_to_equilibrium') then
                         prodrc = 0.0d0
                     else
                          prodrc = -rated_omp(ireac) * r1_iap_k**ordn(ireac)
                     end if
                 else
                     if (reaction_type(im) == 'dissolution_to_equilibrium') then
                         prodrc = 0.0d0
                     else
                          prodrc = rated_omp(ireac) * (abs(r1_iap_k))**ordn(ireac)
                     end if
                 end if               
             else
                 prodrc = -rated_omp(ireac) * (r1 - (satm_omp(im)**ordm(ireac)))
             end if 
             
     !--old--
     !         prodrc = -rated(ireac)                                  &
     !&               * (r1 - (satm(im)**ordm(ireac)))

            end if

!c  form product of reacting components in terms of total 
!c  aqueous component concentrations

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdt(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then
                prodrc = prodrc                                       &
     &                 * (totc(ic)/(totc(ic)+ordm(ireac)))**ordn(ireac)
              end if

              prodrc = prodrc * totc(ic)**orddt(i1)

            end do

!c  form product of reacting components as species in solution

            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdc(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then
                prodrc = prodrc * (gammac(ic)*c(ic) /                 &
     &                   (gammac(ic)*c(ic)+ordm(ireac)))**ordn(ireac)
              end if

              prodrc = prodrc * (gammac(ic)*c(ic))**orddc(i1)

            end do

!c  form product of reacting complexed species

            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1

            do i1 = istart2,istop2

              ix = jamdcx(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then
                prodrc = prodrc * (gammax(ix)*cx(ix) /                &
     &                   (gammax(ix)*cx(ix)+ordm(ireac)))**ordn(ireac)
              end if

              prodrc = prodrc * (gammax(ix)*cx(ix))**orddcx(i1)
            end do

!c  compute total rate for surface controlled reactions
!c  [moles/(l bulk*day)] = [m^2 mineral/l bulk]
!c                          ----------- 
!c                       * [moles/(m^2 mineral * day)]
!c                                 -----------
            ratemp_omp(ireac) = aream * prodrc

!c  include monod and inhibition terms, if applicable

            if (reaction_type(im).eq.'monod') then
              ratemp_omp(ireac) = ratemp_omp(ireac) * termmdm * termmdi
            end if

!c  sum up parallel reaction rates for surface controlled
!c  dissolution/precipitation reactions
            ratem = ratem + ratemp_omp(ireac)
          end do       !loop over parallel diss/prec reactions

        else           !reaction_type

          ratem = r0
 
        end if         !reaction_type

!c  compute total dissolution rate for transport 
!c  controlled dissolution reactions

      elseif (rate_control(im).eq.'transport') then

        if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
     &      reaction_type(im).eq.'reversible'.or.                      &
     &      (reaction_type(im).eq.'dissolution_to_equilibrium'.and.    &
     &       r1-satm_omp(im).gt.r0)) then

!c  compute total dissolution rate 
 
          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop

!c  scale reaction rate, if dissolution reaction is limited by
!c  equilibrium conditions 

            if (far_from_equil(im)) then
              prodrc = r1
            else
              prodrc = r1-satm_omp(im) 
            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
            end do

!c  form product of reacting component species for current dissolution
!c  reaction, activity coefficients are here not considered explicitely,
!c  but are by definition included in the effective diffusion coefficient
 
            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdc(i1)
              prodrc = prodrc * c(ic)**orddc(i1)
            end do
 
!c  include complexed species in product of reacting species for current
!c  dissolution reaction
 
            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1
            do i1 = istart2,istop2
              ix = jamdcx(i1)
              prodrc = prodrc * cx(ix)**orddcx(i1)
            end do
 
!c  compute rate
!c  [moles/(l bulk*day)] = [m mineral / m^3 bulk]
!c                          ---------   ---
!c                       * [m^3 h2o/m^3 mineral * m^2 mineral/day]
!c                          --- --- -----------   -----------
!c                       * [moles/l h2o]
!c                                  ---
            ratemp_omp(ireac) = - aream * diffm(ireac)/xnud(ireac) * prodrc
!c  sum up parallel rates
            ratem = ratem + ratemp_omp(ireac)

          end do  
 
!c  set reaction rate to zero for all other conditions
 
        else

          ratem = r0
 
        end if          !(reaction_type(im))

      end if            !(rate_control(im))
 
!cdbg
      info_debug = 0
      if (info_debug.gt.0) then
        write(*,'(a,e12.5)') 'ratem = ',ratem
        write(*,'(a,e12.5)') 'phim = ', phim
        write(*,'(a,e12.5)') 'phimold = ', phimold
        write(*,'(a,e12.5)') 'aream = ', aream
      end if
      if (info_debug.eq.1) then
        pause
      end if
!cdbg

      return
    end subroutine

!c ----------------------------------------------------------------------
!c subroutine tcorr_omp
!c ----------------
!c
!c temperature corrections for debye-huckel, equilibrium and rate 
!c constants
!c
!c written by:      Uli Mayer - June 30, 1999
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           tempkel            = temperature [K]                     + -
!c
!c common: 
!c
!c chem.f:   real*8:
!c           -------
!c           dgaq(naq)          = activation energies for intra-      + -
!c                                aqueous kinetic reaction
!c           dgcm(nm)           = activation energy for               + -
!c                                dissolution-precipitation
!c                                reaction
!c           dhad               = Debye Huckel constant a_d depending * +
!c                                on dielectric constant and
!c                                temperature
!c           dhaq(naq)          = enthalpy changes for intra-aqueous  + -
!c                                kinetic reaction
!c           dhbd               = Debye Huckel constant b_d depending * +
!c                                on dielectric constant and
!c                                temperature
!c           dhcg(ng)           = enthalpy change for gases           + -
!c           dhcm(nm)           = enthalpy change of dissolution-     + -
!c                                precipitation reaction
!c           dhcmx(nmx)         = enthalpy change of dissolution-     + -
!c                                precipitation reaction
!c                                (excluded minerals)
!c           dhcr(nr)           = enthalpy change for redox reaction  + -
!c           dhcsb(nsb)         = enthalpy change for sorbed species  + -
!c           dhcx(nx)           = enthalpy change for secondary       + -
!c                                aqueous species
!c           eqaq(naq)          = equilibrium constants for           * +
!c                                intra-aqueous kinetic reactions
!c           eqaqs(naq)         = equilibrium constants for           + -
!c                                intra-aqueous kinetic reactions
!c                                at standard temperature
!c           eqg(ng)            = equilibrium constants for gases     * +
!c           eqgs(ng)           = equilibrium constants for gases     + -
!c                                at standard temperature
!c           eqm(nm)            = equilibrium constants for minerals  * +
!c           eqms(nm)           = equilibrium constants for minerals  + -
!c                                at standard temperature
!c           eqmx(nmx)          = equilibrium constants for excluded  * +
!c                                minerals
!c           eqmxs(nmx)         = equilibrium constants for excluded  + -
!c                                minerals at standard temperature
!c           eqsb(nsb)          = equilibrium constants for           * +
!c                                sorbed species
!c           eqsbs(nsb)         = equilibrium constants for           + -
!c                                sorbed species at standard
!c                                temperature
!c           eqr(nr)            = equilibrium constant for redox      * +
!c                                couple reaction equation
!c           eqrs(nr)           = equilibrium constant for redox      + -
!c                                for standard temperature
!c                                couple reaction equation
!c           eqx(nx)            = equilibrium constants for           * +
!c                                secondary aqueous species
!c           eqxs(nx)           = equilibrium constants for           + -
!c                                secondary aqueous species
!c                                at standard temperature
!c           ratecaq(naq)       = log of rate constant for intra-     * +
!c                                aqueous kinetic reactions
!c                                (units: liter -  moles - seconds)
!c           ratecaqs(naq)      = log of rate constant for intra-     + -
!c                                aqueous kinetic reactions at
!c                                stndard temperature
!c                                (units: liter -  moles - seconds)
!c           rated(ndr*nm)      = rate constants for dissolution      * +
!c                                reactions
!c           rateds(ndr*nm)     = rate constants for dissolution-     + -
!c                                precipitation reactions at
!c                                standard temperature
!c           rgascal            = ideal gas constant                  + -
!c                                [kcal/(deg K mole)]
!c           tconv              = temperature correction factor       + -
!c 
!c           integer*4:
!c           ---------- 
!c           iamd(nm+1)         = pointer array to dissolution-       + -
!c                                precipitation reactions
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nx                 = number of aqueous complexes         + -
!c
!c local:    integer*4:
!c           ----------
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imx                = counter (excluded minerals)
!c           ir                 = counter (redox couples)
!c           ireac              = counter (dissolution-
!c                                         precipitation reactions)
!c           isb                = counter (sorbed species)
!c           istart             = pointer
!c           istop              = pointer
!c           ix                 = counter (aqueous complexes)
!c
!c external: dhconst   = compute debye huckel constants a_d and b_d
!c           vhoff_omp     = temperatre corrections for equilibrium and rate
!c                       constants based on integrated Van't Hoff and
!c                       Arrhenius equation
!c ----------------------------------------------------------------------

      subroutine tcorr_omp(tempkel, dhad_omp, dhbd_omp, eqx_omp, eqg_omp, eqm_omp,  &
      rated_omp, eqmx_omp, eqr_omp, eqsb_omp, eqaq_omp, ratecaq_omp)

      use parm
      use chem

      implicit real*8 (a-h,o-z)

      !These parameters are used as local variable in each thread when run in parallel mode
      real (type_r8) :: dhad_omp                    
      real (type_r8) :: dhbd_omp
      real (type_r8), allocatable :: eqx_omp(:)
      real (type_r8), allocatable :: eqg_omp(:)
      real (type_r8), allocatable :: eqm_omp(:)
      real (type_r8), allocatable :: rated_omp(:)
      real (type_r8), allocatable :: eqmx_omp(:)
      real (type_r8), allocatable :: eqr_omp(:)
      real (type_r8), allocatable :: eqsb_omp(:)
      real (type_r8), allocatable :: eqaq_omp(:)
      real (type_r8), allocatable :: ratecaq_omp(:)


!c  debye-huckel constants
      call dhconst_omp(dhad_omp,dhbd_omp,tempkel,tconv)

      
!c  aqueous complexation reactions

      do ix = 1,nx
        eqx_omp(ix) = vhoff_omp(dhcx(ix),eqxs(ix),tempkel,tempks,rgascal)
      end do

!c  gas dissolution-exsolution reactions

      do ig = 1,ng
        eqg_omp(ig) = vhoff_omp(dhcg(ig),eqgs(ig),tempkel,tempks,rgascal)
      end do

!c  dissolution-precipitation reactions

      do im = 1,nm

        eqm_omp(im) = vhoff_omp(dhcm(im),eqms(im),tempkel,tempks,rgascal)

!cff     write(23,*) dlog10(eqm(im)),dlog10(eqms(im))

        istart = iamd(im)
        istop = iamd(im+1)-1

        do ireac = istart,istop
          rated_omp(ireac) = vhoff_omp(dgcm(im),rateds(ireac),    &            
     &                         tempkel,tempks,rgascal)
        end do

      end do

!c  excluded mineral phases

      do imx = 1,nmx
        eqmx_omp(imx) = vhoff_omp(dhcmx(imx),eqmxs(imx),tempkel,tempks,  &  
     &                    rgascal)     
      end do

!c  redox couples

      do ir = 1,nr
        eqr_omp(ir) = vhoff_omp(dhcr(ir),eqrs(ir),tempkel,tempks,rgascal)     
      end do

!c  sorption and ion-exchange reactions

      do isb = 1,nsb
        eqsb_omp(isb) = vhoff_omp(dhcsb(isb),eqsbs(isb),tempkel,tempks,  &     
     &                    rgascal)
      end do

!c  intra-aqueous kinetic reactions

      do iaq = 1,naq     
        eqaq_omp(iaq) = vhoff_omp(dhaq(iaq),eqaqs(iaq),tempkel,tempks,        & 
     &                    rgascal)                                     
        ratecaq_omp(iaq) = vhoff_omp(dgaq(iaq),ratecaqs(iaq),tempkel,tempks,  & 
     &                       rgascal)          
      end do

      return
      end subroutine

!c ----------------------------------------------------------------------
!c subroutine updtsvap_omp
!c -------------------
!c
!c update secondary variables in aqueous phase
!c - activity coefficients
!c - concentrations of secondary aqueous species
!c - ionic strength
!c
!c written by:      Uli Mayer - January 29, 96
!c
!c last modified:   Uli Mayer - November 28, 96
!c
!c definition of variables:
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + +
!c                                - new time level [moles/l water]
!c           cx(nx)             = concentrations of secondary         + +
!c                                aqueous species
!c                                - new time level [moles/l water]
!c           gammac(nc)         = activity coefficients of free       + +
!c                                species
!c           gammax(nx)         = activity coefficient of             + +
!c                                secondary aqueous species
!c           strion             = ionic strength                      + +
!c
!c common:
!c chem.f:   real*8:
!c           ------- 
!c           acth2omin          = min. activity for h2o               + -
!c           actv(nc)           = activity of free species            + -
!c                                - new time level
!c           adav               = coefficient for Davies equation     + -
!c           bdav               = coefficient for Davies equation     + -
!c           dhac(nc)           = debye-huckel a for free species     + -
!c           dhad               = Debye Huckel constant a_d depending + -
!c                                on dielectric constant and
!c                                temperature (only for 25C)
!c           dhax(nx)           = debye-huckel a for secondary        + -
!c                                aqueous species
!c           dhbc(nc)           = debye-huckel b for free species     + -
!c           dhbd               = Debye Huckel constant b_d depending + -
!c                                on dielectric constant and
!c                                temperature (only for 25C)
!c           dhbx(nx)           = debye-huckel b for secondary        + -
!c                                aqueous species
!c           eqr(nr)            = equilibrium constant for redox      + -
!c                                couple reaction equation
!c           eqx(nx)            = equilibrium constants for           + -
!c                                formation of complexed
!c                                species from free species
!c           xnur(nr*nc)        = stoichiometric coefficient of       + -
!c                                component in redox couple
!c                                reaction equation
!c           xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of secondary aqueous
!c                                species from free species
!c
!c           integer*4:
!c           ----------
!c           iarc(nr+1)         = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                free species in
!c                                secondary aqueous species
!c           jarc(nr*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in secondary aqueous
!c                                species
!c           nc                 = number of components including h2o  + -
!c           nopu               = number of primary unknowns          + -
!c           nr                 = number of redox couples             + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           logical:
!c           --------
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c           update_activity    = 'no_update' -> unity activity       + -
!c                                 coefficients
!c                                'time_lagged' -> update activity
!c                                 coefficients after each time step
!c                                'double_update' -> double update
!c                                 of activity coefficients during
!c                                 Newton iterations
!c
!c           character:
!c           ----------
!c           component_type(nc) = 'aqueous' = aqueous component       + -
!c                                'surface' = surface site
!c                                'biomass' = biomass
!c           ctype(nc-1)        = 'charge' = correct total aqueous    + -
!c                                           component concentration
!c                                           for specified component 
!c                                           to satisfy charge balance
!c                                'fixed'  = compute total aqueous
!c                                           component concentrations
!c                                           based on fixed activities
!c                                           of components as species
!c                                           in solution
!c                                'free'   = compute concentrations
!c                                           of components as species
!c                                           in solution based on 
!c                                           specified total aqueous
!c                                           component concentrations
!c                                'ph'    =  pH specified for 'h+1'
!c           namec(nc)          = component names                     + -
!c           namex(nx)          = names of aqueous complexes          + -
!c
!c local:    integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           ir                 = counter (redox couples)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: acoff     = compute activity coefficient 
!c           secspec   = compute concentration of secondary aqueous
!c                       species based on concentrations of free 
!c                       species
!c           ionstr    = compute ionic strength
!c ----------------------------------------------------------------------
      subroutine updtsvap_omp (c,cx,gammac,gammax,strion, dhad_omp, dhbd_omp, &
      eqr_omp, eqx_omp)

      use parm
      use chem

      implicit real*8 (a-h,o-z)

      real (type_r8) :: dhad_omp                    
      real (type_r8) :: dhbd_omp
      real (type_r8), allocatable :: eqr_omp(:)
      real (type_r8), allocatable :: eqx_omp(:)

      dimension c(*),cx(*),gammac(*),gammax(*)

!c  activity coefficients for free species
 
      if (update_activity.eq.'double_update') then
!cprovi----------------------------------------------	  
      if (ispitzer) then
!cprovi----------------------------------------------        
!cprovi it was added by Sergio Andrs Bea Jofr?
!cprovi Compute activity coefficients from
!cprovi Pitzer equations 
!cprovi Cuidado, las componentes pueden no ser acuosas
!cprovi preguntarle a Uli 
!cprovi---------------------------------------------- 
        call pitzer (phase,gammac,gammax,c,cx,nc,nx,ilog)       !output: gammac, gammax
      else  
	  do ic=1,nc

          if (component_type(ic).eq.'aqueous') then
            gammac(ic) = acoff(c,cx,strion,chargec(ic),dhac(ic),      &
     &                         dhbc(ic),dhad_omp,dhbd_omp,adav,bdav,          &     
     &                         acth2omin,nc,nx,namec(ic),namec)
          elseif (component_type(ic).eq.'biomass') then
            gammac(ic) = 1.0d0
          end if

        end do
 
!c  activity coefficients for aqueous complexes
 
        do ix=1,nx
          gammax(ix) = acoff_omp(c,cx,strion,chargex(ix),dhax(ix),dhbx(ix),&
     &                       dhad_omp,dhbd_omp,adav,bdav,acth2omin,nc,nx,      &
     &                       namex(ix),namec)
        end do
      end if 
      end if

!c  compute free species concentrations from free species activities, 
!c  if free species activities are fixed

       do ic = 1,nc-1
         if (ctype(ic).eq.'fixed') then
           c(ic) = actv(ic)/gammac(ic) 
         end if
       end do

!c  equilibrium redox reactions, compute concentrations of oxidized 
!c  components of redox couples

      if (redox_equil.and.nr.gt.0) then
        do ir=1,nr
          ic = nopu+ir
          call secspec(c,c(ic),eqr_omp(ir),gammac,gammac(ic),xnur,    &
     &                 iarc,jarc,nc,ir)          
        end do
      end if

!c  compute concentrations of aqueous complexes

 
      do ix = 1,nx
        call secspec_omp(c,cx(ix),eqx_omp(ix),gammac,gammax(ix),xnux,     &
     &               iax,jax,nc,ix)
      end do
 
!c  update ionic strength
 
      call ionstr(c,cx,strion,chargec,chargex,nc-1,nx,namec)            !output: strion
 
!c  make sure new ionic strength is not larger than maximum
!c  allowed ionic strength to avoid convergence problems
 
      strion = dmin1(strion,sionmax)

      return
      end subroutine
      
!c ----------------------------------------------------------------------
!c subroutine rateint_new_omp
!c ----------------------
!c
!c ------------------------------
!c add: hyperbolic terms minerals
!c ------------------------------
!c
!c compute total reaction rates for intra-aqueous kinetic reactions
!c using new database format
!c
!c written by:      Uli Mayer - July 14, 02
!c                  based on rateint.f
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           rate               = rate for current intra-aqueous      * +
!c                                kinetic reactions [mol/(l h2o*day)
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c           cx(nx)             = concentrations of aqueous           + -
!c                                complexes
!c           gammac(nc)         = activity coefficients of components + -
!c                                as species in solution
!c           gammax(nx)         = activity coefficients of aqueous    + -
!c                                complexes
!c           phim(nm)           = mineral volume fractions            + -
!c           totc(nc-1)         = total aqueous component             + -
!c                                concentrations
!c
!c           integer*4:
!c           ----------
!c           iaq                = pointer to current intra-aqueous    + -
!c                                kinetic reactions
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           eqaq(naq)          = equilibrium constants for intra-    + -
!c                                aqueous kinetic reactions
!c           faqic(naq*nc)      = inhibition factors C^c              + -
!c           faqit(naq*nc)      = inhibition factors T^a              + -
!c           faqim(naq*nm)      = inhibition factors phi^m            + -
!c           faqhc(naq*nc)      = half saturation constants C^c       + -
!c           faqht(naq*nc)      = half saturation constants T^a       + -
!c           faqhm(naq*nm)      = half saturation constants phi^m     + -
!c           ordaqic(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for inhibition terms C^c
!c           ordaqit(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for inhibition terms T^a
!c           ordaqim(naq*nm)    = order of intra-aqueous kinetic      + -
!c                                reaction for inhibition terms phi^m
!c           ordaqhc(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms C^c
!c           ordaqht(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms T^a
!c           ordaqhm(naq*nm)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms phi^m
!c           ordaqc(naq*nc)     = order of intra-aqueous kinetic      + -
!c                                reaction C^c
!c           ordaqt(naq*nc)     = order of intra-aqueous kinetic      + -
!c                                reaction T^a
!c           ordaqx(naq*nx)     = order of intra-aqueous kinetic      + -
!c                                reaction C^x
!c           sataq(naq)         = IAP/K for intra-aqueous kinetic     * * 
!c                                reactions
!c           scalfac_aq(naq)    = scaling factors for intra-aqueous   + -
!c                                kinetic reactions
!c           ratecaq(naq)       = log of rate constant for intra-     + -
!c                                aqueous kinetic reactions
!c                                (units: liter -  moles - seconds)
!c           xnuaq(naq*nc)      = stoichiometric coefficient of       + -
!c                                components in intra-aqueous
!c                                kinetic reaction
!c
!c           integer*4:
!c           ----------
!c           iaaq(naq+1)        = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           iaaqic(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms C^c)
!c           iaaqit(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms T^a)
!c           iaaqim(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms phi^m)
!c           iaaqhc(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms C^c)
!c           iaaqht(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           iaaqhm(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms phi^m)
!c           iaaqc(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                C^c
!c           iaaqt(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                T^a
!c           iaaqx(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                C^x
!c           jaaq(naq*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaqic(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms C^c)
!c           jaaqit(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms T^a)
!c           jaaqim(naq*nm)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms phi^m)
!c           jaaqhc(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms C^c)
!c           jaaqht(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           jaaqhm(naq*nm)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms phi^m)
!c           jaaqc(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                C^c
!c           jaaqt(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                T^a
!c           jaaqx(naq*nx)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                C^x
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c
!c
!c           character:
!c           ----------
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           rtype_aq(naq)      = reaction type of intra-aqueous      * +
!c                                kinetic reaction
!c
!c local:    real*8:
!c           -------
!c           prodrc             = product of reacting species
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           iaqit              = counter
!c           iaqic              = counter
!c           iaqim              = counter
!c           iaqhc              = counter
!c           iaqht              = counter
!c           iaqhm              = counter
!c           iaqc               = counter
!c           iaqt               = counter
!c           iaqx               = counter
!c           ic                 = counter (components)
!c           im                 = counter (minerals)
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine rateint_new_omp(rate,totc,c,cx,gammac,gammax,phim,iaq, &
      sataq_omp, ratecaq_omp, eqaq_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      
      real (type_r8), allocatable :: sataq_omp(:)
      real (type_r8), allocatable :: ratecaq_omp(:)
      real (type_r8), allocatable :: eqaq_omp(:)

      dimension totc(*),c(*),cx(*),gammac(*),gammax(*),phim(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

      info_debug = 0
 
!c  form product of reactants for current intra-aqueous kinetic 
!c  reaction
 
      prodrc = r1

!c  fractional terms - total aqueous component concentrations

      istart2 = iaaqt(iaq)
      istop2 = iaaqt(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqt = istart2,istop2

          ic = jaaqt(iaqt)
          prodrc = prodrc * totc(ic)**ordaqt(iaqt)

        end do

      end if

!c  fractional terms - activities of components as species in solution

      istart2 = iaaqc(iaq)
      istop2 = iaaqc(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqc = istart2,istop2

          ic = jaaqc(iaqc)
          prodrc = prodrc * (gammac(ic)*c(ic))**ordaqc(iaqc)

        end do

      end if

!c  fractional terms - activities of aqueous complexes

      istart2 = iaaqx(iaq)
      istop2 = iaaqx(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqx = istart2,istop2

          ix = jaaqx(iaqx)

          prodrc = prodrc * (gammax(ix)*cx(ix))**ordaqx(iaqx)

        end do

      end if


!c  hyperbolic terms - total aqueous component concentrations

      istart2 = iaaqht(iaq)
      istop2 = iaaqht(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqht = istart2,istop2

          ic = jaaqht(iaqht)
          prodrc = prodrc                                             &
     &           * (totc(ic)/(faqht(iaqht) +                          &
     &              totc(ic)))**ordaqht(iaqht) 

        end do

      end if

!c  hyperbolic terms - activities of components as species in solution

      istart2 = iaaqhc(iaq)
      istop2 = iaaqhc(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqhc = istart2,istop2

          ic = jaaqhc(iaqhc)

!csevinc          prodrc = prodrc * (gammac(ic)*c(ic)
!csevinc     &           / (faqhc(iaqhc) + gammac(ic)*c(ic)))**ordaqhc(iaqhc) 
          prodrc = prodrc * (c(ic)  &
     &           / (faqhc(iaqhc) + c(ic)))**ordaqhc(iaqhc) 

        end do

      end if

!c  hyperbolic terms - minerals

      istart2 = iaaqhm(iaq)
      istop2 = iaaqhm(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqhm = istart2,istop2

          im = jaaqhm(iaqhm)

          prodrc = prodrc * (phim(im)                                 &
     &           / (faqhm(iaqhm) + phim(im)))**ordaqhm(iaqhm) 

        end do

      end if
 
!c  inhibition terms - total aqueous component concentrations

      istart2 = iaaqit(iaq)
      istop2 = iaaqit(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqit = istart2,istop2

          ic = jaaqit(iaqit)
          prodrc = prodrc * (faqit(iaqit)                             &
     &           / (faqit(iaqit)+totc(ic)))**ordaqit(iaqit)

        end do

      end if

!c  inhibition terms - activities of components as species in solution

      istart2 = iaaqic(iaq)
      istop2 = iaaqic(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqic = istart2,istop2

          ic = jaaqic(iaqic)

          prodrc = prodrc * (faqic(iaqic)                             &
     &           / (faqic(iaqic)+gammac(ic)*c(ic)))**ordaqic(iaqic)

        end do

      end if

!c  inhibition terms - minerals

      istart2 = iaaqim(iaq)
      istop2 = iaaqim(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqim = istart2,istop2

          im = jaaqim(iaqim)
          prodrc = prodrc * (faqim(iaqim)                             &
     &           / (faqim(iaqim)+phim(im)))**ordaqim(iaqim)

        end do

      end if

!c  compute IAP/K for reversible reactions

      if (rtype_aq(iaq).ne.'irreversible') then

        sataq_omp(iaq) = eqaq_omp(iaq)**(-r1)

        istart = iaaq(iaq)
        istop = iaaq(iaq+1)-1
        do i1 = istart,istop
          ic = jaaq(i1)
          sataq_omp(iaq) = sataq_omp(iaq) * (gammac(ic)*c(ic))**xnuaq(i1)
        end do

	end if

!c  modify reaction product for reversible reactions

      if (rtype_aq(iaq).eq.'reversible') then

!crevintaff
         if (reverse_intra_affinity(iaq).and.sataq_omp(iaq).gt.r1) then
             prodrc = - prodrc * (r1 - sataq_omp(iaq)**-r1)
         else 
             prodrc = prodrc * (r1 - sataq_omp(iaq))
         end if    
!crevintaff
     
!crevintaff     prodrc = prodrc * (r1 - sataq(iaq))
     
!c  modify reaction product for irreversible reactions - log K control

	elseif (rtype_aq(iaq).eq.'irreversible - log K control') then

         prodrc = dmax1(r0,(prodrc * (r1 - sataq_omp(iaq))))

	end if

!c  multiply with effective rate constant [moles/(m^3 h2o * day)]
 
      rate = - scalfac_aq(iaq)*ratecaq_omp(iaq)*prodrc

!cdbg ---- activate this section for purposes of debugging -----

      if (info_debug.gt.0) then
        write(*,'(a)') 'returning from rateint ...'
        write(*,'(a12)') nameaq(iaq)
        write(*,'(a,e17.10)') 'rate     ',rate
        write(*,*) '----------------------------------------------'
      end if

      if (info_debug.gt.1) then
        stop
      end if

      return
      end subroutine  
      
!c ----------------------------------------------------------------------
!c subroutine rateint_omp
!c ------------------
!c
!c compute total reaction rates for intra-aqueous kinetic reactions
!c
!c written by:      Uli Mayer - April 23, 99
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           rate               = rate for current intra-aqueous      * +
!c                                kinetic reactions [mol/(l h2o*day)
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c           gammac(ic)         = activity coefficients of components + -
!c                                as species in solution
!c           phim(nm)           = mineral volume fractions            + -
!c           totc(nc-1)         = total aqueous component             + -
!c                                concentrations
!c
!c           integer*4:
!c           ----------
!c           iaq                = pointer to current intra-aqueous    + -
!c                                kinetic reactions
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           faqi(naq*nc)       = inhibition factors                  + -
!c           faqht(naq*nc)      = half saturation constants T^a       + -
!c           ordaqht(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms T^a   + -
!c                                in intra-aqueous kinetic reactions
!c           jaaq(naq*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaqi(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms)
!c           jaaqht(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           jaaqt(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (total aqueous component
!c                                concentrations)
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c
!c
!c           character:
!c           ----------
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           rtype_aq(naq)      = reaction type of intra-aqueous      * +
!c                                kinetic reaction
!c                                'monod'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = product of reacting species
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           iaqi               = counter
!c           iaqht              = counter
!c           iaqt               = counter
!c           ic                 = counter (components)
!c           im                 = counter (minerals)
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine rateint_omp(rate,totc,c,gammac,phim,iaq, ratecaq_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real (type_r8), allocatable :: ratecaq_omp(:)

      dimension totc(*),c(*),gammac(*),phim(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)
 
!c  initialize reaction rate for intra-aqueous reaction

      rate = r0

!c  form product of reactants for current intra-aqueous kinetic 
!c  reaction
 
      prodrc = r1

!c  total aqueous component concentrations, except for h+1

      istart2 = iaaqt(iaq)
      istop2 = iaaqt(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqt = istart2,istop2

          ic = jaaqt(iaqt)

          if (namec(ic).ne.'h+1') then
		  prodrc = prodrc * totc(ic)**ordaqt(iaqt)
          else
            prodrc = prodrc * c(ic)**ordaqt(iaqt)
		end if

        end do

      end if

!c  monod terms

      istart2 = iaaqht(iaq)
      istop2 = iaaqht(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqht = istart2,istop2

          ic = jaaqht(iaqht)

          if (namec(ic).ne.'h+1') then
            prodrc = prodrc                                           &
     &             * (totc(ic)/(faqht(iaqht)                          &
     &             + totc(ic)))**ordaqht(iaqht)                        
          else
	      prodrc = prodrc                                           &
     &             * (c(ic)/(faqht(iaqht) + c(ic)))**ordaqht(iaqht) 
          end if

        end do

      end if
 
!c  inhibition terms due to components

      istart2 = iaaqi(2*iaq-1)
      istop2 = iaaqi(2*iaq)-1

      if (istop2.ge.istart2) then

        do iaqi = istart2,istop2

          ic = jaaqi(iaqi)

          if (namec(ic).ne.'h+1') then
            prodrc = prodrc * faqi(iaqi)/(faqi(iaqi)+totc(ic))
          else
            prodrc = prodrc * faqi(iaqi)/(faqi(iaqi)+gammac(ic)*c(ic))
          end if

        end do

      end if

!c  inhibition terms due to minerals

      istart2 = iaaqi(2*iaq)
      istop2 = iaaqi(2*iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqi = istart2,istop2

          im = jaaqi(iaqi)
          prodrc = prodrc * faqi(iaqi)/(faqi(iaqi)+phim(im))

        end do

      end if

!c  sum up final reaction rate [moles/(m^3 h2o * day)]
 
      rate = rate - scalfac_aq(iaq)*ratecaq_omp(iaq)*prodrc

!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        write(*,'(a)') 'returning from rateint ...'
        write(*,'(a12)') nameaq(iaq)
        write(*,'(a,e17.10)') 'rate     ',rate
        write(*,*) '----------------------------------------------'
      end if

      if (info_debug.gt.1) then
        stop
      end if

      return
      end subroutine 
      
      
!c ----------------------------------------------------------------------
!c subroutine totint_omp
!c ------------------
!c compute total source/sink term towards total aqueous component 
!c concentrations due to intra-aqueous kinetic reactions
!c or derivative thereof
!c
!c written by:      Uli Mayer - April 23, 99
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c
!c passed:   idbg               = unit number - debugging file        + -
!c           totintaq(nc-1)     = total source-sink term towards      * +
!c                                total aqueous component
!c                                concentrations due to intra-aqueous
!c                                kinetic reactions or derivative
!c                                thereof
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           rateaq(naq)        = reaction rates of intra-aqueous     + -
!c                                kinetic reaction
!c           xnuaq(naq*nc)      = stoichiometric coefficient of       + -
!c                                components in intra-aqueous
!c                                kinetic reaction
!c
!c           integer*4:
!c           ----------
!c           iaaq(naq+1)        = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaq(naq*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components including h2o  + -
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c 
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c
!c           integer*4:
!c           ----------
!c           i                  = counter (stoichiometric
!c                                coefficients)
!c           iaq                = counter (intra-aqueous
!c                                kinetic reactions)
!c           ic                 = counter (components) 
!c           info_debug         = flag to control debugging 
!c                                information
!c           istart             = pointer (stoichiometric 
!c                                coefficients)
!c           istop              = pointer (stoichiometric
!c                                coefficients)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine totint_omp(totintaq,idbg, rateaq_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      
      real (type_r8), allocatable :: rateaq_omp(:)

      dimension totintaq(*)

      parameter (r0 = 0.0d0)
 
      do ic = 1,nc-1
        totintaq(ic) = r0
      end do
 
      do iaq = 1,naq
        istart = iaaq(iaq)
        istop = iaaq(iaq+1)-1
        do i = istart,istop
          ic = jaaq(i)
 
!c  skip h2o, since not a primary unknown
 
          if (namec(ic).ne.'h2o') then
            totintaq(ic) = totintaq(ic)+xnuaq(i)*rateaq_omp(iaq)
          end if
        end do

      end do

!cdbg
      info_debug = 0

      if (info_debug.gt.0) then
        write(idbg,'(a)') 'returning from totint ...'
        do ic = 1,nc-1
          write(idbg,'(a12,1x,e10.3)') namec(ic),totintaq(ic)
        end do
        write(idbg,*) '----------------------------------------------'
      end if

      if (info_debug.gt.1) then
        stop
      end if
!cdbg
      return
      end subroutine
      
!c ----------------------------------------------------------------------
!c subroutine rategasd_omp
!c -------------------
!c
!c compute degassing rates
!c
!c density dependent flow modification
!c
!c written by:      Uli Mayer - March 1, 00
!c
!c last modified:   Tom Henderson - October 22, 2002
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c common:
!c passed:   real*8:
!c           -------
!c           tkel               = nodal temperatures in Kelvin        + - 
!c           g(ng)              = gas concentrations                  + -
!c                                - new time level [moles/l air]
!c           phead              = pressure head                      + -
!c
!c chem.f:   real*8:
!c           -------
!c           degas_rate         = rate constant for degassing         + -
!c                                [mol L-1 h2o s-1]
!c           g_acc              = gravitational acceleration vector   + -
!c                                [m s^-2]
!c           pa_atm             = conversion factor [Pa atm ^-1]      + -
!c           pres_atm           = atmospheric pressure [atm]          + -
!c           rateg(ng)          = degassing rates                     * +
!c           rgas               = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           rho_w              = desnity of water [kg m^-3]          + -
!c
!c           integer*4:
!c           ----------
!c           ng                 = number of gases                     + -
!c
!c local:    real*8:
!c           -------
!c           pres_tot           = total gas pressure [atm]
!c           pres_conf          = confining pressure [atm]
!c           r0                 = constant
!c           r1                 = constant
!c           rate               = reaction rate [mol L^-1 h2o s^-1]
!c
!c           integer*4:
!c           ----------
!c           ig                 = counter (gases)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine rategasd_omp(g,tkel,phead, rateg_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real (type_r8), allocatable :: rateg_omp(:)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

      dimension g(*)

!c  initialize array for degassing rates

      do ig = 1,ng
        rateg_omp(ig) = r0
      end do

!c  compute total gas pressure

      pres_tot = r0
      do ig = 1,ng
        pres_tot = pres_tot + rgas*tkel*g(ig)
      end do

!c  compute confining pressure
!c  assumes constant density for now
!c
      pres_conf = pres_atm    &
     &          + (rho_w * g_acc * phead)/pa_atm

!c  compute total rate of degassing, if sum of partial pressures 
!c  exceeds confining pressure

      if (pres_tot.gt.pres_conf) then

         rate = -degas_rate * (r1-pres_tot/pres_conf)

!c  compute rates for specific gases depending on mole fraction in 
!c  escaping gas mixture

        do ig = 1,ng
          rateg_omp(ig) = (rgas*tkel*g(ig))/pres_tot * rate
        end do

      end if

!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        if (pres_tot.gt.pres_conf) then
          write(*,'(a)') 'returning from rategas ...'
          write(*,*) pres_tot/pres_conf
          write(*,*) 'rate  ', rate
          do ig = 1,ng
            write(*,*) nameg(ig), rateg_omp(ig)
          end do
          write(*,*) '----------------------------------------------'
        end if
      end if

      if (info_debug.gt.1) then
        stop
      end if

      return
      end subroutine 
      
!c ----------------------------------------------------------------------
!c subroutine rategas_omp
!c ------------------
!c
!c compute degassing rates
!c
!c written by:      Uli Mayer - March 1, 00
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c common:
!c passed:   real*8:
!c           -------
!c           tkel               = nodal temperatures in Kelvin        + - 
!c           g(ng)              = gas concentrations                  + -
!c                                - new time level [moles/l air]
!c           hhead              = hydraulic head                      + -
!c           zg                 = spatial coordinates in z-direction  + -
!c
!c chem.f:   real*8:
!c           -------
!c           degas_rate         = rate constant for degassing         + -
!c                                [mol L-1 h2o s-1]
!c           g_acc              = gravitational acceleration vector   + -
!c                                [m s^-2]
!c           pa_atm             = conversion factor [Pa atm ^-1]      + -
!c           pres_atm           = atmospheric pressure [atm]          + -
!c           rateg(ng)          = degassing rates                     * +
!c           rgas               = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           rho_w              = desnity of water [kg m^-3]          + -
!c
!c           integer*4:
!c           ----------
!c           ng                 = number of gases                     + -
!c
!c local:    real*8:
!c           -------
!c           pres_tot           = total gas pressure [atm]
!c           pres_conf          = confining pressure [atm]
!c           r0                 = constant
!c           r1                 = constant
!c           rate               = reaction rate [mol L^-1 h2o s^-1]
!c
!c           integer*4:
!c           ----------
!c           ig                 = counter (gases)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine rategas_omp(g,tkel,hhead,zg, rateg_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real (type_r8), allocatable :: rateg_omp(:)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

      dimension g(*)

!c  initialize array for degassing rates

      do ig = 1,ng
        rateg_omp(ig) = r0
      end do

!c  compute total gas pressure

      pres_tot = r0
      do ig = 1,ng
        pres_tot = pres_tot + rgas*tkel*g(ig)
      end do

!c  compute confining pressure

      pres_conf = pres_atm    &
     &          + (rho_w * g_acc * (hhead - zg))/pa_atm

!c  compute total rate of degassing, if sum of partial pressures 
!c  exceeds confining pressure

      if (pres_tot.gt.pres_conf) then

         rate = -degas_rate * (r1-pres_tot/pres_conf)

!c  compute rates for specific gases depending on mole fraction in 
!c  escaping gas mixture

        do ig = 1,ng
          rateg_omp(ig) = (rgas*tkel*g(ig))/pres_tot * rate
        end do

      end if

!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        if (pres_tot.gt.pres_conf) then
          write(*,'(a)') 'returning from rategas ...'
          write(*,*) pres_tot/pres_conf
          write(*,*) 'rate  ', rate
          do ig = 1,ng
            write(*,*) nameg(ig), rateg_omp(ig)
          end do
          write(*,*) '----------------------------------------------'
        end if
      end if

      if (info_debug.gt.1) then
        stop
      end if

      return
      end subroutine
      
!c ----------------------------------------------------------------------
!c subroutine totredx_omp
!c ------------------
!c compute total source/sink term towards total aqueous component 
!c concentrations due to oxidation-reduction reactions
!c or derivative thereof
!c
!c written by:      Uli Mayer - May 30, 97
!c
!c last modified:   Uli Mayer - February 4, 98
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c
!c passed:   totoxrd(nc-1)      = total source/sink term towards      * +
!c                                aqueous component concentrations
!c                                due to oxidation/reduction
!c                                reactions [moles/(l h2o*day)] 
!c                                or derivative thereof
!c           idbg               = unit number - debugging file        + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           rateor(nr)         = oxidation-reduction rates for       + -
!c                                redox couples [moles/(l h2o*day)]
!c           xnur(nr*nc)        = stoichiometric coefficient of       + -
!c                                component in redox couple
!c                                reaction equation
!c
!c           integer*4:
!c           ----------
!c           iars(nr)           = pointer array to secondary          + -
!c                                component of redox couple
!c           iarc(nr+1)         = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           jarc(nr*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           nc                 = number of components including h2o  + -
!c           nr                 = number of redox couples             + -
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           i                  = counter (stoichiometric
!c                                coefficients)
!c           ic                 = counter (components) 
!c           info_debug         = flag to control debugging 
!c                                information
!c           ir                 = counter (redox couples)
!c           istart             = pointer (stoichiometric 
!c                                coefficients)
!c           istop              = pointer (stoichiometric
!c                                coefficients)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine totredx_omp(totoxrd,idbg, rateor_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: rateor_omp(:)

      dimension totoxrd(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)
 
      do ic = 1,nc-1
        totoxrd(ic) = r0
      end do
 
      do ir = 1,nr
        istart = iarc(ir)
        istop = iarc(ir+1)-1
        do i = istart,istop
          ic = jarc(i)
 
!c  skip h2o, since not a primary unknown
 
          if (namec(ic).ne.'h2o') then
            totoxrd(ic) = totoxrd(ic)+xnur(i)*rateor_omp(ir)
          end if
        end do

!c  add contribution from secondary component of redox couple

        ic = iars(ir)
        totoxrd(ic) = totoxrd(ic) - r1*rateor_omp(ir)

      end do

!cdbg
      info_debug = 0

      if (info_debug.gt.0) then
        write(idbg,'(a)') 'returning from totredx ...'
        do ic = 1,nc-1
          write(idbg,'(a12,1x,e10.3)') namec(ic),totoxrd(ic)
        end do
        write(idbg,*) '----------------------------------------------'
      end if

      if (info_debug.gt.1) then
        stop
      end if
!cdbg
      return
      end subroutine     
      
      
!c ----------------------------------------------------------------------
!c subroutine
!c -------------------
!c
!c compute analytical derivatives of total aqueous component 
!c concentrations based on concentrations of free species and 
!c secondary aqueous speciesmodified:   
!c
!c
!c written by:      Uli Mayer - October 31, 00
!c
!c last 
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c                                - new time level [moles/l water]
!c
!c           integer*4:
!c           ----------
!c           jbl                = pointer to column of block matrix   + -
!c
!c chem.f:   real*8:
!c           -------
!c           dtotc(n)           = derivatives of total aqueous        * +
!c                                component concentrations
!c                                [moles/l water]
!c           xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of secondary aqueous
!c                                species from free species
!c
!c           integer*4:
!c           ----------
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                free species in
!c                                secondary aqueous species
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in secondary aqueous
!c                                species
!c           nc                 = number of components                + -
!c           nr                 = number of redox couples             + -
!c           nx                 = number of secondary aqueous         + -
!c                                species
!c
!c
!c local:    real*8:
!c           -------
!c           r0                  = constant
!c           r1                  = constant
!c
!c           integer*4:
!c           ----------
!c           i                   = counter (stoichiometric
!c                                 coefficients)
!c           ibl                 = counter (components)
!c           istart              = pointer (stoichiometric 
!c                                 coefficients)
!c           istop               = pointer (stoichiometric
!c                                 coefficients)
!c           ix                  = counter (secondary species) 
!c
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine atotconc_omp(c,cx,jbl, dtotc_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: dtotc_omp(:)

      dimension c(*),cx(*)
 
      parameter (r0 = 0.0d0)

      dimension factor(100)
 
!c  free species 
 
      do ibl=1,nc-1
        if (jbl.eq.ibl) then
          dtotc_omp(ibl) = c(ibl) 
        else
          dtotc_omp(ibl) = r0
        end if
      end do

!c  aqueous complexes

      if (nx.gt.0) then

!c  initialize factors

        do ix = 1,nx
          factor(ix) = r0
        end do

!c  define factors for aqueous complexes

        do ix = 1,nx
          istart = iax(ix)
          istop = iax(ix+1)-1
          do i1 = istart,istop
            ibl = jax(i1)
            if (ibl.eq.jbl) then
	        factor(ix) = xnux(i1)
	      end if
          end do
        end do
 
!c  sum up contributions from aqueous complexes
 
        do ix=1,nx
          istart = iax(ix)
          istop = iax(ix+1)-1
          do i = istart,istop
            ibl = jax(i)
            if (namec(ibl).ne.'h2o') then
              dtotc_omp(ibl) = dtotc_omp(ibl) + factor(ix)*xnux(i)*cx(ix)
            end if
          end do
        end do

      end if

!cff  redox species, unfinished and deactivated with nr>100

      if (redox_equil.and.nr.gt.100) then

!c  initialize factors
        
	  do ir = 1,nr
          factor(ir) = r0
        end do

!c  define factors for redox couples 

        do ir = 1,nr
          istart = iarc(ir)
          istop = iarc(ir+1)-1
	    do i1 = istart,istop
            ibl = jarc(i1)
            if (ibl.eq.jbl) then
	        factor(ir) = xnur(i1)
	      end if
          end do
        end do

!c  sum up contributions from redox couples

        do ir = 1,nr
          istart = iarc(ir)
          istop = iarc(ir+1)-1
          do i1 = istart,istop
            ibl = jarc(i1)

!c  skip h2o, since not a primary unknown
 
            if (namec(ibl).ne.'h2o') then
              dtotc_omp(ibl) = dtotc_omp(ibl)+factor(ir)*xnur(i1)*c(ir+nopu)
            end if
          end do
        end do

      end if

!c  final derivative

      do ibl = 1,nc-1
        dtotc_omp(ibl) = dtotc_omp(ibl)/c(jbl)
      end do
 
      return
      end subroutine
      
!c ----------------------------------------------------------------------
!c subroutine dtotconc_omp
!c -------------------
!c
!c compute derivatives of total aqueous component concentrations based 
!c on concentrations of free species and secondary aqueous species
!c
!c written by:      Uli Mayer - February 26, 96
!c
!c last modified:   Uli Mayer - December 16, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c                                - new time level [moles/l water]
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c
!c           integer*4:
!c           ----------
!c           jbl                = pointer to column of block matrix   + -
!c
!c chem.f:   real*8:
!c           -------
!c           cxinc(nx)          = secondary aqueous species           + -
!c                                concentrations dependent on
!c                                incremented free species
!c                                concentrations
!c                                [moles/l water]
!c           dtotc(n)           = derivatives of total aqueous        * +
!c                                component concentrations
!c                                [moles/l water]
!c           xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of secondary aqueous
!c                                species from free species
!c
!c           integer*4:
!c           ----------
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                free species in
!c                                secondary aqueous species
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in secondary aqueous
!c                                species
!c           nc                 = number of components                + -
!c           nx                 = number of secondary aqueous         + -
!c                                species
!c
!c
!c local:    integer*4:
!c           ----------
!c           i                   = counter (stoichiometric
!c                                 coefficients)
!c           ibl                 = counter (components)
!c           ibl2                = counter (components)
!c           istart              = pointer (stoichiometric 
!c                                 coefficients)
!c           istop               = pointer (stoichiometric
!c                                 coefficients)
!c           ix                  = counter (secondary species) 
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine dtotconc_omp(c,cx,drtinc,jbl, dtotc_omp, cinc_omp, cxinc_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: dtotc_omp(:)
      real(type_r8), allocatable :: cinc_omp(:)
      real(type_r8), allocatable :: cxinc_omp(:)

      dimension c(*),cx(*)
 
!c  contributions from free species 
 
      do ibl=1,nc-1
        dtotc_omp(ibl) = cinc_omp(ibl) - c(ibl)
      end do
 
!c  sum up contributions from aqueous complexes
 
      do ix=1,nx
        istart = iax(ix)
        istop = iax(ix+1)-1
        do i = istart,istop
          ibl = jax(i)

!c  skip h2o, since not a primary unknown
 
          if (namec(ibl).ne.'h2o') then
            dtotc_omp(ibl) = dtotc_omp(ibl) + xnux(i)*(cxinc_omp(ix)-cx(ix))
          end if
        end do
      end do
 
!c  form derivative -> divide by increment for numerical
!c  differentiation
 
      do ibl=1,nc-1
        dtotc_omp(ibl) = dtotc_omp(ibl)/drtinc
      end do
 
      return
      end subroutine 
      
!c -----------------------------------------------------------------------
!c subroutine gasconc_omp
!c ------------------
!c compute gas concentration in air phase based on concentrations 
!c of free species in aqueous phase 
!c
!c written by:      Uli Mayer - September 24, 96
!c
!c last modified:   Uli Mayer - November 28, 96   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + -
!c                                [moles/l water]
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           g                  = gas concentration of gas            * +
!c                                [moles/l air]
!c           ig                 = pointer to gas                      + -
!c           tempkel            = temperature [deg K]                 + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           eqg(ng)            = equilibrium constants for           + -
!c                                formation of gases from free
!c                                species
!c           rgas               = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           xnug(ng*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of gases from
!c                                free species
!c
!c           integer*4:
!c           ----------
!c           iaga(ng+1)         = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           jaga(ng*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           nc                 = number of components                + -
!c
!c
!c
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           i                  = counter (stoichiometric 
!c                                coefficients)
!c           ic                 = counter (components)
!c           istart             = pointer (stoichiometric
!c                                coefficients)
!c           iend               = pointer (stoichiometric
!c                                coefficients)
!c
!c external: -  
!c ----------------------------------------------------------------------
  
      subroutine gasconc_omp(c,gammac,g,ig,tempkel, eqg_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: eqg_omp(:)

      dimension c(*),gammac(*)

      parameter (r1 = 1.0d0)
 
!c  convert from [atm] to [moles/l air]

      g = r1/(rgas*tempkel*eqg_omp(ig))
 
      istart = iaga(ig)
      iend = iaga(ig+1)-1
      do i = istart,iend
        ic = jaga(i)
        g = g * (gammac(ic)*c(ic))**xnug(i)
      end do
 
      return
      end subroutine
      
!c ----------------------------------------------------------------------
!c subroutine drategdd_omp
!c -------------------
!c
!c compute derivatives of degassing rates
!c
!c written by:      Uli Mayer - March 1, 00
!c
!c last modified:   Tom Henderson - October 22, 2002
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c common:
!
!c passed:   real*8:
!c           -------
!c           tkel               = nodal temperatures in Kelvin        + - 
!c           g(ng)              = gas concentrations                  + -
!c                                - new time level [moles/l air]
!c           phead              = pressure head                       + -
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c 
!c chem.f:   real*8:
!c           -------
!c           degas_rate         = rate constant for degassing         + -
!c                                [mol L-1 h2o s-1]
!c           g_acc              = gravitational acceleration vector   + -
!c                                [m s^-2]
!c           ginc(ng)           = gas concentrations dependent on     + -
!c                                incremented concentrations of
!c                                components as species in solution
!c                                [moles/l air]
!c           pa_atm             = conversion factor [Pa atm ^-1]      + -
!c           pres_atm           = atmospheric pressure [atm]          + -
!c           rateg(ng)          = degassing rates                     * +
!c           rho_w              = density of water [kg m^-3]          + -
!c           rgas               = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c
!c           integer*4:
!c           ----------
!c           ng                 = number of gases                     + -
!c
!c local:    real*8:
!c           -------
!c           pres_tot           = total gas pressure [atm]
!c           pres_tot_inc       = total gas pressure [atm]
!c                                - incremented
!c           pres_conf          = confining pressure [atm]
!c           r0                 = constant
!c           r1                 = constant
!c           rate               = reaction rate [mol L^-1 h2o s^-1]
!c           rate_inc           = reaction rate [mol L^-1 h2o s^-1]
!c                                - incremented
!c
!c           integer*4:
!c           ----------
!c           ig                 = counter (gases)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine drategdd_omp(g,tkel,phead,drtinc, rateg_omp, ginc_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: rateg_omp(:)
      real(type_r8), allocatable :: ginc_omp(:)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

      dimension g(*)

!c  initialize array for degassing rates

      do ig = 1,ng
        rateg_omp(ig) = r0
      end do

!c  compute total gas pressure

      pres_tot = r0
      pres_tot_inc = r0
      do ig = 1,ng
        pres_tot = pres_tot + rgas*tkel*g(ig)
        pres_tot_inc = pres_tot_inc + rgas*tkel*ginc_omp(ig)
      end do

!c  compute confining pressure
!c  assume constant density for now

      pres_conf = pres_atm    &
               + (rho_w * g_acc * phead)/pa_atm

!c  compute total rate of degassing, if sum of partial pressures 
!c  exceeds confining pressure

      if (pres_tot.gt.pres_conf) then

         rate = -degas_rate * (r1-pres_tot/pres_conf)
         rate_inc = -degas_rate * (r1-pres_tot_inc/pres_conf)

!c  compute rates for specific gases depending on mole fraction in 
!c  escaping gas mixture

        do ig = 1,ng
          rateg_omp(ig) = (rgas*tkel*ginc_omp(ig)/pres_tot_inc * rate_inc &
                   -  rgas*tkel*g(ig)/pres_tot * rate)            &
                   / drtinc
        end do

      end if

!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        if (pres_tot.gt.pres_conf) then
          write(*,'(a)') 'returning from drategas ...'
          do ig = 1,ng
            write(*,*) nameg(ig), rateg_omp(ig)
          end do
          write(*,*) '----------------------------------------------'
        end if
      end if

      if (info_debug.gt.1) then
        stop
      end if

      return
      end subroutine
      
!c ----------------------------------------------------------------------
!c subroutine drategas_omp
!c -------------------
!c
!c compute derivatives of degassing rates
!c
!c written by:      Uli Mayer - March 1, 00
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c common:
!
!c passed:   real*8:
!c           -------
!c           tkel               = nodal temperatures in Kelvin        + - 
!c           g(ng)              = gas concentrations                  + -
!c                                - new time level [moles/l air]
!c           hhead              = hydraulic head                      + -
!c           zg                 = spatial coordinates in z-direction  + -
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c 
!c chem.f:   real*8:
!c           -------
!c           degas_rate         = rate constant for degassing         + -
!c                                [mol L-1 h2o s-1]
!c           g_acc              = gravitational acceleration vector   + -
!c                                [m s^-2]
!c           ginc(ng)           = gas concentrations dependent on     + -
!c                                incremented concentrations of
!c                                components as species in solution
!c                                [moles/l air]
!c           pa_atm             = conversion factor [Pa atm ^-1]      + -
!c           pres_atm           = atmospheric pressure [atm]          + -
!c           rateg(ng)          = degassing rates                     * +
!c           rho_w              = density of water [kg m^-3]          + -
!c           rgas               = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c
!c           integer*4:
!c           ----------
!c           ng                 = number of gases                     + -
!c
!c local:    real*8:
!c           -------
!c           pres_tot           = total gas pressure [atm]
!c           pres_tot_inc       = total gas pressure [atm]
!c                                - incremented
!c           pres_conf          = confining pressure [atm]
!c           r0                 = constant
!c           r1                 = constant
!c           rate               = reaction rate [mol L^-1 h2o s^-1]
!c           rate_inc           = reaction rate [mol L^-1 h2o s^-1]
!c                                - incremented
!c
!c           integer*4:
!c           ----------
!c           ig                 = counter (gases)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine drategas_omp(g,tkel,hhead,zg,drtinc, rateg_omp, ginc_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: rateg_omp(:)
      real(type_r8), allocatable :: ginc_omp(:)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

      dimension g(*)

!c  initialize array for degassing rates

      do ig = 1,ng
        rateg_omp(ig) = r0
      end do

!c  compute total gas pressure

      pres_tot = r0
      pres_tot_inc = r0
      do ig = 1,ng
        pres_tot = pres_tot + rgas*tkel*g(ig)
        pres_tot_inc = pres_tot_inc + rgas*tkel*ginc_omp(ig)
      end do

!c  compute confining pressure

      pres_conf = pres_atm    &
               + (rho_w * g_acc * (hhead - zg))/pa_atm

!c  compute total rate of degassing, if sum of partial pressures 
!c  exceeds confining pressure

      if (pres_tot.gt.pres_conf) then

         rate = -degas_rate * (r1-pres_tot/pres_conf)
         rate_inc = -degas_rate * (r1-pres_tot_inc/pres_conf)

!c  compute rates for specific gases depending on mole fraction in 
!c  escaping gas mixture

        do ig = 1,ng
          rateg_omp(ig) = (rgas*tkel*ginc_omp(ig)/pres_tot_inc * rate_inc &
                   -  rgas*tkel*g(ig)/pres_tot * rate)            &
                   / drtinc
        end do

      end if

!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        if (pres_tot.gt.pres_conf) then
          write(*,'(a)') 'returning from drategas ...'
          do ig = 1,ng
            write(*,*) nameg(ig), rateg_omp(ig)
          end do
          write(*,*) '----------------------------------------------'
        end if
      end if

      if (info_debug.gt.1) then
        stop
      end if

      return
      end subroutine 
      
!c ----------------------------------------------------------------------
!c subroutine drateint_new_omp
!c -----------------------
!c
!c compute derivative of reaction rates for intra-aqueous kinetic 
!c reactions (new database format)
!c
!c written by:      Uli Mayer - July 14, 02
!c                  based on drateint.f
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c           cx(nx)             = concentrations of aqueous           + -
!c                                complexes
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           gammac(nc)         = activity coefficients of components + -
!c                                as species in solution
!c           gammax(nx)         = activity coefficients of aqueous    + -
!c                                complexes
!c           phim(nm)           = mineral volume fractions            + -
!c           rate               = rate for current intra-aqueous      * +
!c                                kinetic reactions [mol/(l h2o*day)
!c           totc(nc-1)         = total aqueous component             + -
!c                                concentrations
!c
!c           integer*4:
!c           ----------
!c           iaq                = pointer to current intra-aqueous    + -
!c                                kinetic reactions
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           eqaq(nac)          = equilibrium constants for intra-    + -
!c                                aqueous kinetic reactions
!c           faqic(naq*nc)      = inhibition factors C^c              + -
!c           faqit(naq*nc)      = inhibition factors T^a              + -
!c           faqim(naq*nm)      = inhibition factors phi^m            + -
!c           faqhc(naq*nc)      = half saturation constants C^c       + -
!c           faqht(naq*nc)      = half saturation constants T^a       + -
!c           faqhm(naq*nm)      = half saturation constants phi^m     + -
!c           ordaqic(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for inhibition terms C^c
!c           ordaqit(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for inhibition terms T^a
!c           ordaqim(naq*nm)    = order of intra-aqueous kinetic      + -
!c                                reaction for inhibition terms phi^m
!c           ordaqhc(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms C^c
!c           ordaqht(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms T^a
!c           ordaqhm(naq*nm)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms phi^m
!c           ordaqc(naq*nc)     = order of intra-aqueous kinetic      + -
!c                                reaction C^c
!c           ordaqt(naq*nc)     = order of intra-aqueous kinetic      + -
!c                                reaction T^a
!c           ordaqx(naq*nx)     = order of intra-aqueous kinetic      + -
!c                                reaction C^x
!c           sataq(naq)         = IAP/K for intra-aqueous kinetic     * +
!c                                reactions
!c           scalfac_aq(naq)    = scaling factors for intra-aqueous   + -
!c                                kinetic reactions
!c           ratecaq(naq)       = log of rate constant for intra-     + -
!c                                aqueous kinetic reactions
!c                                (units: liter -  moles - seconds)
!c           cinc(n)            = concentrations of species as        + -
!c                                components in solution
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           cxinc(nx)          = concentrations of aqueous           + -
!c                                complexes
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           totcinc(n)         = total aqueous component             + -
!c                                concentrations
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           xnuaq(naq*nc)      = stoichiometric coefficient of       + -
!c                                components in intra-aqueous
!c                                kinetic reaction
!c
!c           integer*4:
!c           ----------
!c           iaaq(naq+1)        = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           iaaqic(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms C^c)
!c           iaaqit(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms T^a)
!c           iaaqim(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms phi^m)
!c           iaaqhc(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms C^c)
!c           iaaqht(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           iaaqhm(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms phi^m)
!c           iaaqc(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                C^c
!c           iaaqt(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                T^a
!c           iaaqx(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                C^x
!c           jaaq(naq*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaqic(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms C^c)
!c           jaaqit(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms T^a)
!c           jaaqim(naq*nm)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms phi^m)
!c           jaaqhc(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms C^c)
!c           jaaqht(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           jaaqhm(naq*nm)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms phi^m)
!c           jaaqc(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                C^c
!c           jaaqt(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                T^a
!c           jaaqx(naq*nx)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                C^x
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c
!c
!c           character:
!c           ----------
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           rtype_aq(naq)      = reaction type of intra-aqueous      + -
!c                                kinetic reaction
!c                                'monod'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = product of reacting species
!c           prodrcinc          = product of reacting species
!c                                (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c           sataqinc           = IAP/K for intra-aqueous kinetic
!c                                reactions - incremented
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           iaqic              = counter
!c           iaqit              = counter
!c           iaqim              = counter
!c           iaqhc              = counter
!c           iaqht              = counter
!c           iaqhm              = counter
!c           iaqt               = counter
!c           ic                 = counter (components)
!c           im                 = counter (minerals)
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine drateint_new_omp(rate,totc,c,cx,gammac,gammax,phim,    &
                             drtinc,iaq, sataq_omp, ratecaq_omp,        &
                             eqaq_omp, totcinc_omp, cinc_omp, cxinc_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      
      real (type_r8), allocatable :: sataq_omp(:)
      real (type_r8), allocatable :: ratecaq_omp(:)
      real (type_r8), allocatable :: eqaq_omp(:)
      real (type_r8), allocatable :: totcinc_omp(:)
      real (type_r8), allocatable :: cinc_omp(:)
      real (type_r8), allocatable :: cxinc_omp(:)
      

      dimension c(*),cx(*),gammac(*),gammax(*),totc(*),phim(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)
 
!c  form product of reactants for current intra-aqueous kinetic 
!c  reaction
 
      prodrc = r1
      prodrcinc = r1

!c  fractional order terms - total aqueous component concentrations

      istart2 = iaaqt(iaq)
      istop2 = iaaqt(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqt = istart2,istop2

          ic = jaaqt(iaqt)
		prodrc = prodrc * totc(ic)**ordaqt(iaqt)
          prodrcinc = prodrcinc * totcinc_omp(ic)**ordaqt(iaqt)

        end do

      end if

!c  fractional order terms - activities of components as species
!c  in solution

      istart2 = iaaqc(iaq)
      istop2 = iaaqc(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqc = istart2,istop2

          ic = jaaqc(iaqc)

          prodrc = prodrc * (gammac(ic)*c(ic))**ordaqc(iaqc)
          prodrcinc = prodrcinc * (gammac(ic)*cinc_omp(ic))**ordaqc(iaqc)

        end do

      end if

!c  fractional order terms - activities of components as species
!c  in solution

      istart2 = iaaqx(iaq)
      istop2 = iaaqx(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqx = istart2,istop2

          ix = jaaqx(iaqx)

          prodrc = prodrc * (gammax(ix)*cx(ix))**ordaqx(iaqx)
          prodrcinc = prodrcinc * (gammax(ix)*cxinc_omp(ix))**ordaqx(iaqx)

        end do

      end if

!c  hyperbolic terms - activities of components as concentrations in
!c  solution

      istart2 = iaaqhc(iaq)
      istop2 = iaaqhc(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqhc = istart2,istop2

          ic = jaaqhc(iaqhc)

!csevinc          prodrc = prodrc * (gammac(ic)*c(ic)
!csevinc     &           / (faqhc(iaqhc) + gammac(ic)*c(ic)))**ordaqhc(iaqhc) 
!csevinc          prodrcinc = prodrcinc * (gammac(ic)*cinc(ic)
!csevinc     &              / (faqhc(iaqhc)
!csevinc     &                 + gammac(ic)*cinc(ic)))**ordaqhc(iaqhc)
          prodrc = prodrc * (c(ic)          &
     &           / (faqhc(iaqhc) + c(ic)))**ordaqhc(iaqhc) 
          prodrcinc = prodrcinc * (cinc_omp(ic) &
     &              / (faqhc(iaqhc)         &
     &                 + cinc_omp(ic)))**ordaqhc(iaqhc)	

        end do

      end if

!c  hyperbolic terms - total aqueous component concentrations

      istart2 = iaaqht(iaq)
      istop2 = iaaqht(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqht = istart2,istop2

          ic = jaaqht(iaqht)
          prodrc = prodrc                         &
                * (totc(ic)/(faqht(iaqht)         &
                + totc(ic)))**ordaqht(iaqht) 
          prodrcinc = prodrcinc * (totcinc_omp(ic)/   &
                    (faqht(iaqht)+totcinc_omp(ic)))**ordaqht(iaqht)

        end do

      end if

!c  hyperbolic terms - minerals
!c  Note: This is at the present time not necessary, since phi is not 
!c        considered implicitly, included only for future modifications

      istart2 = iaaqhm(iaq)
      istop2 = iaaqhm(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqhm = istart2,istop2

          im = jaaqhm(iaqhm)
          prodrc = prodrc                     &
                * (phim(im)/(faqhm(iaqhm)     &
                + phim(im)))**ordaqhm(iaqhm) 
          prodrcinc = prodrcinc * (phim(im)/  &
                    (faqhm(iaqhm)+phim(im)))**ordaqhm(iaqhm)

        end do

      end if
 
!c  inhibition terms - total aqueous component concentrations

      istart2 = iaaqit(iaq)
      istop2 = iaaqit(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqit = istart2,istop2

          ic = jaaqit(iaqit)

          prodrc = prodrc * (faqit(iaqit)         &
                / (faqit(iaqit)+totc(ic)))**ordaqit(iaqit)
          prodrcinc = prodrcinc * (faqit(iaqit)   &
                   / (faqit(iaqit)+totcinc_omp(ic)))**ordaqit(iaqit)

        end do

      end if

!c  inhibition terms - activities of components as species in solution

      istart2 = iaaqic(iaq)
      istop2 = iaaqic(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqic = istart2,istop2

          ic = jaaqic(iaqic)

          prodrc = prodrc * (faqic(iaqic)                         &
                / (faqic(iaqic)+gammac(ic)*c(ic)))**ordaqic(iaqic)
          prodrcinc = prodrcinc * (faqic(iaqic)                   &
                   / (faqic(iaqic)                                &
                      + gammac(ic)*cinc_omp(ic)))**ordaqic(iaqic)

        end do

      end if


!c  inhibition terms due to minerals
!c  Note: This is at the present time not necessary, since phi is not 
!c        considered implicitly, included only for future modifications

      istart2 = iaaqim(iaq)
      istop2 = iaaqim(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqim = istart2,istop2

          im = jaaqim(iaqim)

          prodrc = prodrc * (faqim(iaqim)                         &
                / (faqim(iaqim)+phim(im)))**ordaqim(iaqim)
          prodrcinc = prodrcinc * (faqim(iaqim)                   &
                   / (faqim(iaqim)+phim(im)))**ordaqim(iaqim)

        end do

      end if

!c  compute IAP/K for reversible reactions, regular and incremented

      if (rtype_aq(iaq).ne.'irreversible') then

        sataq_omp(iaq) = eqaq_omp(iaq)**(-r1)
	  sataqinc = sataq_omp(iaq)

        istart = iaaq(iaq)
        istop = iaaq(iaq+1)-1
        do i1 = istart,istop
          ic = jaaq(i1)
          sataq_omp(iaq) = sataq_omp(iaq) * (gammac(ic)*c(ic))**xnuaq(i1)
	    sataqinc = sataqinc * (gammac(ic)*cinc_omp(ic))**xnuaq(i1)
        end do

	end if

!c  modify reaction product for reversible reactions

      if (rtype_aq(iaq).eq.'reversible') then

!crevintaff
         if (reverse_intra_affinity(iaq).and.sataq_omp(iaq).gt.r1) then
           prodrc = - prodrc * (r1 - sataq_omp(iaq)**-r1)
           prodrcinc = - prodrcinc * (r1 - sataqinc**-r1)
         else 
           prodrc = prodrc * (r1 - sataq_omp(iaq))
           prodrcinc = prodrcinc * (r1 - sataqinc)
         end if    
!crevintaff 

!crevintaff         prodrc = prodrc * (r1 - sataq(iaq))
!crevintaff         prodrcinc = prodrcinc * (r1 - sataqinc)
     
!c  modify reaction product for irreversible reactions - log K control

	elseif (rtype_aq(iaq).eq.'irreversible - log K control') then

         prodrc = prodrc * dmax1(r0,(prodrc * (r1 - sataq_omp(iaq))))
         if (prodrc.gt.r0) then
           prodrcinc = prodrcinc  &
                    * dmax1(r0,(prodrcinc * (r1 - sataqinc)))
         else
	     prodrcinc = r0
         end if

	end if

!c  sum up final reaction rate [moles/(m^3 h2o * day)]
 
      rate = - scalfac_aq(iaq)*ratecaq_omp(iaq)   &
            * (prodrcinc-prodrc)/drtinc


!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        write(*,'(a)') 'returning from rateint ...'
        write(*,'(a12)') nameaq(iaq)
        write(*,'(a,e17.10)') 'rate     ',rate
        write(*,*) '----------------------------------------------'
      end if

      if (info_debug.gt.1) then
        stop
      end if

      return
      end subroutine

!c ----------------------------------------------------------------------
!c subroutine drateint_omp
!c -------------------
!c
!c compute derivative of reaction rates for intra-aqueous kinetic 
!c reactions
!c
!c written by:      Uli Mayer - April 23, 99
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           gammac(ic)         = activity coefficients of components + -
!c                                as species in solution
!c           phim(nm)           = mineral volume fractions            + -
!c           rate               = rate for current intra-aqueous      * +
!c                                kinetic reactions [mol/(l h2o*day)
!c           totc(nc-1)         = total aqueous component             + -
!c                                concentrations
!c
!c           integer*4:
!c           ----------
!c           iaq                = pointer to current intra-aqueous    + -
!c                                kinetic reactions
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           faqi(naq*nc)       = inhibition factors                  + -
!c           faqht(naq*nc)      = half saturation constants T^a       + -
!c           ordaqht(naq*nc)    = order of intra-aqueous kinetic      + -
!c                                reaction for hyperbolic terms T^a
!c           ordaqt(naq*nc)     = order of intra-aqueous kinetic      + -
!c                                reaction with respect to total
!c                                aqueous component concentrations
!c           scalfac_aq(naq)    = scaling factors for intra-aqueous   + -
!c                                kinetic reactions
!c           ratecaq(naq)       = log of rate constant for intra-     + -
!c                                aqueous kinetic reactions
!c                                (units: liter -  moles - seconds)
!c           cinc(n)            = concentrations of species as        + -
!c                                components in solution
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           totcinc(n)         = total aqueous component             + -
!c                                concentrations
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           xnuaq(naq*nc)      = stoichiometric coefficient of       + -
!c                                components in intra-aqueous
!c                                kinetic reaction
!c
!c           integer*4:
!c           ----------
!c           iaaq(naq+1)        = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           iaaqi(2*naq+1)     = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms)
!c           iaaqht(naq+1)      = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyerbolic terms T^a)
!c           iaaqt(naq+1)       = row pointer array to reactants      + -
!c                                in intra-aqueous kinetic reactions
!c                                (total aqueous component
!c                                concentrations)
!c           jaaq(naq*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaqi(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms)
!c           jaaqht(naq*nc)     = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           jaaqt(naq*nc)      = column pointer array to reactants   + -
!c                                in intra-aqueous kinetic reactions
!c                                (total aqueous component
!c                                concentrations)
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c
!c
!c           character:
!c           ----------
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           rtype_aq(naq)      = reaction type of intra-aqueous      + -
!c                                kinetic reaction
!c                                'monod'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = product of reacting species
!c           prodrcinc          = product of reacting species
!c                                (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           iaqi               = counter
!c           iaqh               = counter
!c           iaqt               = counter
!c           ic                 = counter (components)
!c           im                 = counter (minerals)
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine drateint_omp(rate,totc,c,gammac,phim,drtinc,iaq, &
                           ratecaq_omp, cinc_omp, totcinc_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: ratecaq_omp(:)
      real(type_r8), allocatable :: cinc_omp(:)
      real(type_r8), allocatable :: totcinc_omp(:)

      dimension c(*),gammac(*),totc(*),phim(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)
 
!c  initialize reaction rate for intra-aqueous reaction

      rate = r0

!c  form product of reactants for current intra-aqueous kinetic 
!c  reaction
 
      prodrc = r1
      prodrcinc = r1

!c  total aqueous component concentrations and pH

      istart2 = iaaqt(iaq)
      istop2 = iaaqt(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqt = istart2,istop2

          ic = jaaqt(iaqt)

          if (namec(ic).ne.'h+1') then
		  prodrc = prodrc * totc(ic)**ordaqt(iaqt)
            prodrcinc = prodrcinc * totcinc_omp(ic)**ordaqt(iaqt)
          else
            prodrc = prodrc * c(ic)**ordaqt(iaqt)
            prodrcinc = prodrcinc * cinc_omp(ic)**ordaqt(iaqt)
	    end if

        end do

      end if

!c  monod terms

      istart2 = iaaqht(iaq)
      istop2 = iaaqht(iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqht = istart2,istop2

          ic = jaaqht(iaqht)

          if (namec(ic).ne.'h+1') then
            prodrc = prodrc                                       &
                  * (totc(ic)/(faqht(iaqht)                       &
                  + totc(ic)))**ordaqht(iaqht) 
            prodrcinc = prodrcinc * (totcinc_omp(ic)/                 &
                      (faqht(iaqht)+totcinc_omp(ic)))**ordaqht(iaqht)
          else
            prodrc = prodrc                                       &
                  * (c(ic)/(faqht(iaqht) + c(ic)))**ordaqht(iaqht) 
            prodrcinc = prodrcinc * (cinc_omp(ic)/                    &
                      (faqht(iaqht)+cinc_omp(ic)))**ordaqht(iaqht)
		end if 

        end do

      end if
 
!c  inhibition terms due to components

      istart2 = iaaqi(2*iaq-1)
      istop2 = iaaqi(2*iaq)-1

      if (istop2.ge.istart2) then

        do iaqi = istart2,istop2

          ic = jaaqi(iaqi)

          if (namec(ic).ne.'h+1') then
            prodrc = prodrc * faqi(iaqi)/(faqi(iaqi)+totc(ic))
            prodrcinc = prodrcinc * faqi(iaqi)/(faqi(iaqi)+totcinc_omp(ic))
          else
            prodrc = prodrc                                           &
                  * faqi(iaqi)/(faqi(iaqi)+gammac(ic)*c(ic))
            prodrcinc = prodrcinc                                     &
                     * faqi(iaqi)/(faqi(iaqi)+gammac(ic)*cinc_omp(ic))
          end if

        end do

      end if

!c  inhibition terms due to minerals
!c  Note: This is at the present time not necessary, since phi is not 
!c        considered implicitly, included only for future modifications

      istart2 = iaaqi(2*iaq)
      istop2 = iaaqi(2*iaq+1)-1

      if (istop2.ge.istart2) then

        do iaqi = istart2,istop2

          im = jaaqi(iaqi)

          prodrc = prodrc * faqi(iaqi)/(faqi(iaqi)+phim(im))
          prodrcinc = prodrcinc * faqi(iaqi)/(faqi(iaqi)+phim(im))

        end do

      end if

!c  sum up final reaction rate [moles/(m^3 h2o * day)]
 
      rate = rate - scalfac_aq(iaq)*ratecaq_omp(iaq)  &
                 * (prodrcinc-prodrc)/drtinc

!cdbg ---- activate this section for purposes of debugging -----

      info_debug = 0

      if (info_debug.gt.0) then
        write(*,'(a)') 'returning from rateint ...'
        write(*,'(a12)') nameaq(iaq)
        write(*,'(a,e17.10)') 'rate     ',rate
        write(*,*) '----------------------------------------------'
      end if

      if (info_debug.gt.1) then
        stop
      end if

      return
      end subroutine
      
!c ----------------------------------------------------------------------
!c subroutine draterdx_omp
!c -------------------
!c
!c compute derivative of total oxidation/reduction rates for redox 
!c couples in terms of total aqueous component concentrations
!c
!c sign convention: depletion of primary component - ve
!c                  production of secondary component + ve
!c
!c written by:      Uli Mayer - May 29, 97
!c
!c last modified:   Uli Mayer - February 4, 98
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c                                - new time level [moles/l h2o]
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           drate              = derivative of oxidation-reduction   * +
!c                                rate for redox couple 
!c                                [moles/(l h2o*day)
!c           gammac(nc)         = activity coefficients of components + -
!c                                as species in solution
!c           gammax(nx)         = activity coefficients of            + -
!c                                secondary aqueous species
!c           totc(nc-1)         = total aqueous component             + -
!c                                concentrations
!c                                - new time level [moles/l h2o]
!c
!c           integer*4:
!c           ----------
!c           idbg               = unit number - debugging file        + -
!c           ir                 = pointer to current redox couple     + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           bcatfac(nr*nor)    = bacterial catalysis factor          + -
!c           chomc(nr*nor*nc)   = cutoff concentrations for reacting  + -
!c                                species (components as species
!c                                in solution)
!c           chomt(nr*nor*nc)   = cutoff concentration for reacting   + -
!c                                species (total aqueous component
!c                                concentrations)
!c           chomx(nr*nor*nx)   = cutoff concentration for reacting   + -
!c                                species (aqueous complexes)
!c           cinc(nc)           = incremented concentrations of       + -
!c                                components as species in solution
!c                                - new time level [moles/l h2o]
!c           cxinc(nx)          = secondary aqueous species           + -
!c                                concentrations dependent on
!c                                incremented concentrations of
!c                                components as species in solution
!c                                [moles/l h2o]
!c           eqr(nr)            = equilibrium constant for redox      + -
!c                                couple reaction equation
!c           ordorc(nr*nor*nc)  = order of oxidation-reduction        + -
!c                                reaction with respect to components
!c                                as species in solution
!c           ordort(nr*nor*nc)  = order of oxidation-reduction        + -
!c                                reaction with respect to total
!c                                aqueous component concentrations
!c           ordorx(nr*nor*nx)  = order of oxidation-reduction        + -
!c                                reaction with respect to
!c                                secondary aqueous species
!c           rateox(nr*nor)     = log of oxidation-reduction rate     + -
!c                                constant
!c                                (units: liter -  moles - seconds)
!c           dtotc(nc-1)        = derivatives of total aqueous        + -
!c                                component concentrations
!c           xnur(nr*nc)        = stoichiometric coefficient of       + -
!c                                component in redox couple
!c                                reaction equation
!c
!c
!c           integer*4:
!c           ----------
!c           iarc(nr+1)         = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           iaor(nr+1)         = pointer array to parallel           + -
!c                                oxidation-reduction reactions
!c           iaorc(nr*nor+1)    = row pointer array to reactants      + -
!c                                in parallel oxidation-reduction
!c                                reactions (components as species
!c                                in solution)
!c           iaort(nr*nor+1)    = row pointer array to reactants      + -
!c                                in parallel oxidation-reduction
!c                                reactions (total aqueous component
!c                                concentrations)
!c           iaorx(nr*nor+1)    = row pointer array to reactants      + -
!c                                in parallel oxidation-reduction
!c                                reactions (secondary aqueous
!c                                species)
!c           iars(nr)           = pointer array to secondary          + -
!c                                component of redox couple
!c           jaorc(nr*nor*nc)   = column pointer array to reactants   + -
!c                                in parallel oxidation-reduction
!c                                reactions (components as species
!c                                in solution)
!c           jaort(nr*nor*nc)   = column pointer array to reactants   + -
!c                                in parallel oxidation-reduction
!c                                reactions (total aqueous component
!c                                concentrations)
!c           jaorx(nr*nor*nx)   = column pointer array to reactants   + -
!c                                in parallel oxidation-reduction
!c                                reactions (secondary aqueous
!c                                species)
!c           jarc(nr*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in secondary aqueous
!c                                species
!c           nc                 = number of components                + -
!c           nr                 = number of redox couples             + -
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           namerp(nr)         = name of primary components of       + -
!c                                redox couples
!c           rtype_hom(nr)      = reaction type of homogeneous        + -
!c                                reaction in aqueous phase
!c                                'forward'
!c                                'backward'
!c                                'forward-to-equilibrium'
!c                                'backward-to-equilibrium'
!c                                'reversible'
!c                                'equilibrium'
!c
!c local:    real*8:
!c           -------
!c           aprod              = activity product                  
!c           aprodinc           = activity product (incremented)                 
!c           eps                = 1.d-300
!c           prodrc             = product of reacting species
!c           prodrcinc          = product of reacting species
!c                                (incremented)
!c           rate               = oxidation-reduction rate
!c           rateinc            = oxidation-reduction rate 
!c                                (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           ior                = counter (parallel oxidation-
!c                                         reduction reactions)
!c           iorc               = counter
!c           iort               = counter
!c           iorx               = counter
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine draterdx_omp(c,cx,gammac,gammax,drate,totc,drtinc,ir,idbg, &
                             totcinc_omp, cinc_omp, cxinc_omp, eqr_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: totcinc_omp(:)
      real(type_r8), allocatable :: cinc_omp(:)
      real(type_r8), allocatable :: cxinc_omp(:)
      real(type_r8), allocatable :: eqr_omp(:)

      dimension c(*),cx(*),gammac(*),gammax(*),totc(*)

      parameter (eps = 1.d-300,r0 = 0.0d0, r1 = 1.0d0)
 
!c  initialize oxidation-reduction rate
!c  (not incremented / incremented)

      rate = r0
      rateinc = r0

!c  pointer to oxidation-reduction reactions for redox couple
 
      istart = iaor(ir)
      istop = iaor(ir+1)-1

!c  loop over parallel oxidation-reduction reactions

      do ior = istart,istop
 
!c  form product of reactants for current oxidation-reduction
!c  reaction, skip, if current oxidation-reduction rate is 
!c  zero order 
 
        prodrc = r1
        prodrcinc = r1

!c  total aqueous component concentrations

        istart2 = iaort(ior)
        istop2 = iaort(ior+1)-1

        if (istop2.ge.istart2) then    !skip for zero order rate

          do iort = istart2,istop2

            ic = jaort(iort)

            if (rtype_hom(ir).eq.'forward'.or.            &
               rtype_hom(ir).eq.'backward') then

              prodrc = prodrc                             &
                    * totc(ic) / (totc(ic)+chomt(iort))
              prodrcinc = prodrcinc                       &
                       * totcinc_omp(ic) / (totcinc_omp(ic)+chomt(iort))

            end if

            prodrc = prodrc * totc(ic)**ordort(iort)
            prodrcinc = prodrcinc * totcinc_omp(ic)**ordort(iort)

          end do

        end if

!c  components as species in solution

        istart2 = iaorc(ior)
        istop2 = iaorc(ior+1)-1

        if (istop2.ge.istart2) then    !skip for zero order rate

          do iorc = istart2,istop2

            ic = jaorc(iorc)

            if (rtype_hom(ir).eq.'forward'.or.        &
               rtype_hom(ir).eq.'backward') then

              prodrc = prodrc                         &
                    * (gammac(ic)*c(ic))              &
                    / (gammac(ic)*c(ic)+chomc(iorc))
              prodrcinc = prodrcinc                   &
                       * (gammac(ic)*cinc_omp(ic))        &
                       / (gammac(ic)*cinc_omp(ic)+chomc(iorc))

            end if

            prodrc = prodrc * (gammac(ic)*c(ic))**ordorc(iorc)
            prodrcinc = prodrcinc * (gammac(ic)*cinc_omp(ic))**ordorc(iorc)

          end do

        end if

!c  secondary aqueous species

        istart2 = iaorx(ior)
        istop2 = iaorx(ior+1)-1

        if (istop2.ge.istart2) then    !skip for zero order rate

          do iorx = istart2,istop2

            ix = jaorx(iorx)

            if (rtype_hom(ir).eq.'forward'.or.            &
               rtype_hom(ir).eq.'backward') then

              prodrc = prodrc                             &
                    * (gammax(ic)*cx(ic))                 &
                    / (gammax(ic)*cx(ic)+chomx(iorx))
              prodrcinc = prodrcinc                       &
                    * (gammax(ic)*cxinc_omp(ic))              &
                    / (gammax(ic)*cxinc_omp(ic)+chomx(iorx))

            end if

            prodrc = prodrc * (gammax(ix)*cx(ix))**ordorx(iorx)
            prodrcinc = prodrcinc * (gammax(ix)*cxinc_omp(ix))**ordorx(iorx)

          end do

        end if
 
!c  sum up final oxidation-reduction rate [moles/(m^3 h2o * day)]
!c  (not incremented / incremented)
 
        rate = rate - bcatfac(ior)*rateox(ior)*prodrc
        rateinc = rateinc - bcatfac(ior)*rateox(ior)*prodrcinc

      end do          !number of parallel oxidation rates

!c  compute K/IAP for redox reaction
!c  (not incremented / incremented)

!c  reacting species

      aprod = r1
      aprodinc = r1
      istart = iarc(ir)
      istop = iarc(ir+1)-1
      do i = istart,istop 
        ic = jarc(i)
        aprod =  aprod*(gammac(ic)*c(ic))**xnur(i)
        aprodinc =  aprodinc*(gammac(ic)*cinc_omp(ic))**xnur(i)
      end do

!c  produced species

      ic = iars(ir)
      aprod = aprod*(gammac(ic)*c(ic))**(-r1)
      aprodinc = aprodinc *(gammac(ic)*cinc_omp(ic))**(-r1)

!c  final K/IAP (not incremented / incremented)

      aprod = eqr_omp(ir)/aprod
      aprodinc = eqr_omp(ir)/aprodinc

!c  correct sign
!c  fix this later

      rate = -rate
      rateinc = -rateinc

!c  multiply with affinity factor

      if (rtype_hom(ir).eq.'forward_to_equilibrium'.or.   &
         rtype_hom(ir).eq.'backward_to_equilibrium'.or.   &
         rtype_hom(ir).eq.'reversible') then

        rate = rate * (r1-aprod)
        rateinc = rateinc * (r1-aprodinc)

      end if

!c  compute derivative of oxidation/reduction rate

      drate = (rateinc-rate)/drtinc
 
!c  consider irreversibility of reaction

      if (rtype_hom(ir).eq.'forward_to_equilibrium') then

        rate = dmax1(rate,r0)
        if (rate.lt.eps) then
          drate = r0
        end if

      elseif (rtype_hom(ir).eq.'backward_to_equilibrium') then

        rate = dmin1(rate,r0)
        if (rate.gt.-eps) then
          drate = r0
        end if

      end if


!cdbg ---- activate this section for purposes of debugging -----
!c
!c     info_debug = 0 -> no debugging information
!c     info_debug = 1 -> write to file and continue run    
!c     info_debug = 2 -> write to screen and pause
!c     info_debug = 3 -> write to file and stop

      info_debug = 0

      if (info_debug.eq.2) then
        idbg = 0
      end if

      if (info_debug.gt.0) then
        write(idbg,'(a)') 'returning from draterdx ...'
        write(idbg,'(a12,1x,a12)') namerp(ir),namers(ir)
        write(idbg,'(a,e10.3)') 'prodrc       ',prodrc
        write(idbg,'(a,e10.3)') 'prodrcinc    ',prodrcinc
        write(idbg,'(a,e10.3)') 'aprod        ',aprod
        write(idbg,'(a,e10.3)') 'aprodinc     ',aprodinc
        write(idbg,'(a,e10.3)') 'rate         ',rate   
        write(idbg,'(a,e10.3)') 'rateinc      ',rateinc
        write(idbg,'(a,e10.3)') 'drate        ',drate
        write(idbg,*) '----------------------------------------------'
      end if

      if (info_debug.eq.2) then
        pause
      elseif (info_debug.eq.3) then
        stop
      end if

      return
    end subroutine        

!c ----------------------------------------------------------------------
!c subroutine draoult_omp
!c ------------------
!c
!c compute derivative of dissolution rate for organic contaminant from 
!c organic mixture
!c
!c sign convention: dissolution -
!c
!c written by:      Uli Mayer - January 17, 00
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of components as     + -
!c                                species in solution
!c                                - new time level [moles/l water]
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           gammac(nc)         = activity coefficients of components + -
!c                                as species in solution
!c           phim               = volume fractions of minerals        + -
!c           phimold            = volume fractions of minerals        + -
!c                                - old time level
!c           ratem              = absolute dissolution-precipitation  * +
!c                                rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(nc)           = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/l h2o]
!c
!c           integer*4:
!c           ----------
!c           im                = counter
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           cinc(nc)           = incremented concentrations          + -
!c                                of components as species in
!c                                solution
!c                                [moles/l h2o]
!c           conc_mol_avg       = average molar concentration of      + -
!c                                organic mixture 
!c           densm(nm)          = density of free phase product       + -
!c           eqm(nm)            = solubility constant for organic     + -
!c                                compound
!c           gfwm(nm)           = gram formula weight of free phase   + -
!c                                product
!c           rated(ndr*nm)      = rate constants for dissolution      + -
!c                                reactions
!c           satm(nm)           = IAP/K for free phase product        + -
!c           xnum(nm*nc)        = stoichiometric coefficients of
!c                                components in free phase product
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c
!c           character:
!c           ----------
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c
!c
!c local:    real*8:
!c           -------
!c           conc_mol           = molar concentration of organic
!c                                compound in organic mixture
!c           frac_mol           = mole fraction of organic compound
!c                                in organic mixture
!c           r0                 = constant
!c           r1                 = constant
!c           satminc            = saturation index with respect
!c                                to current mineral (incremented)
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter 
!c           ireac              = counter
!c           istart             = pointer
!c           istop              = pointer
!c
!c external: satindex  = compute saturation index
!c ----------------------------------------------------------------------
  
      subroutine draoult_omp(c,gammac,ratem,phim,phimold,aream,drtinc,im, &
                 conc_mol_avg_omp, satm_omp, eqm_omp, cinc_omp, rated_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8) :: conc_mol_avg_omp
      real(type_r8), allocatable :: satm_omp(:)
      real(type_r8), allocatable :: eqm_omp(:)
      real(type_r8), allocatable :: cinc_omp(:)
      real(type_r8), allocatable :: rated_omp(:)

      dimension c(*),gammac(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

!c  compute effective dissolution rate

      if (reaction_type(im).eq.'raoult') then

!c  compute mol fraction of organic compound in organic mixture

        conc_mol = phimold*densm(im)/gfwm(im)
        frac_mol = conc_mol/conc_mol_avg_omp

!c  compute free phase saturation indices (unshifted and shifted)

        satm_omp(im) = satindex_omp(c,eqm_omp(im),gammac,xnum,iam,jam,im)
        satminc = satindex_omp(cinc_omp,eqm_omp(im),gammac,xnum,iam,jam,im)

!c  compute effective saturation indices

        satm_omp(im) = satm_omp(im)/frac_mol
        satminc = satminc/frac_mol

!c  compute reaction rate for dissolution of organic compound

        ratem = r0

!c  consider parallel reaction pathways

        istart = iamd(im)
        istop = iamd(im+1)-1
      
  	  do ireac = istart,istop
          ratem = ratem - aream * rated_omp(ireac) * frac_mol     &
               * eqm_omp(im) * ((r1 - satminc) -  (r1 - satm_omp(im)))
        end do
        ratem = ratem*phimold/(phimold+1.0d3*phimin(im))

!c  set rate to zero, if organic approaches depleted

        if (phimold.lt.phimin(im)+1.0d-3*phimin(im)) then
          ratem = r0
        end if

!c  divide by increment of numerical differentiation
!c  and obtain derivative of total rate

      ratem = ratem/drtinc

      end if           !(reaction_type)

      return
      end subroutine   
      
      
!c ----------------------------------------------------------------------
!c subroutine aratemin_omp
!c -------------------
!c
!c compute analytical derivative of absolute dissolution-precipitation rate 
!c of mineral
!c
!c sign convention: dissolution -
!c                  precipitation +
!c
!c written by:      Uli Mayer - Oct 27, 00
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           gammax(nx)         = activity coefficient of             + -
!c                                secondary aqueous species
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           phim               = volume fraction of mineral          + -
!c           phimold            = volume fraction of mineral          + -
!c                                - old time level
!c           ratem              = derivative of absolute dissolution- * +
!c                                precipitation rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(n)            = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/(l bulk)]
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           cinc(nc)           = incremented free species            + -
!c                                concentrations
!c                                [moles/l h2o]
!c           cxinc(nx)          = secondary aqueous species           + -
!c                                concentrations dependent on
!c                                incremented free species
!c                                concentrations
!c                                [moles/l h2o]
!c           diffm(ndr*nm)      = free diffusion coefficient of       + -
!c                                primary reactant in water
!c                                (transport controlled reactions)
!c           eqm(nm)            = equilibrium constants for minerals  + -
!c           fmdi(nrc*nc)        = inhibition factors                  + -
!c           fmdm(nrc*nc)        = monod factors                       + -
!c           orddc(nrc*nm)      = order of free species in            + -
!c                                dissolution reaction
!c           orddcx(nrc*nm)     = order of secondary aqueous          + -
!c                                species in dissolution reaction
!c           orddt(nrc*nm)      = order of total aqueous component    + -
!c                                concentration in dissolution
!c                                reaction
!c           ordm(ndr*nm)       = exponent m for reaction rate law    + -
!c           ordmdm(nrc*nm)     = order of monod terms for            + -
!c                                dissolution-precipitation reactions
!c           ordn(ndr*nm)       = exponent n for reaction rate law    + -
!c           rated(ndr*nm)      = rate constants for dissolution      + -
!c                                reactions
!c           satm(nm)           = saturation indices                  * +
!c           totcinc(n)         = total aqueous component             + -
!c                                concentrations - new time level, 
!c                                incremented [moles/l water]
!c           xnud(ndr*nm)       = stoichiometric coefficients of      + -
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution        + -
!c                                reactions
!c           iamdc(ndr*nm+1)    = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamdc(nrc*nm)      = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           jamdm(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           jamdt(nrc*nm)      = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c           nx                 = number of aqueous complexes         + -
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c
!c           logical:
!c           --------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = activity product of species
!c                                involved in reaction
!c           prodrcinc          = activity product of species
!c                                involved in reaction (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c           ratetrans          = differential of transport controlled
!c                                reaction rate 
!c                                (incremented - not incremnented)
!c           satminc            = saturation index with respect
!c                                to current mineral (incremented)
!c
!c           integer*4:
!c           ----------
!c           ireac              = counter 
!c           istart             = pointer (start of reaction set) 
!c           iend               = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueosu species)
!c           i1                 = counter
!c
!c external: draoult  = compute derivative of dissolution rate 
!c                      of organic compound from organic mixture based 
!c                      on raoult's law
!c ----------------------------------------------------------------------
  
      subroutine aratemin_omp(totc,c,cx,gammac,gammax,ratem,phim, &
                         phimold,aream,im,jbl,ivol,               &
                        conc_mol_avg_omp, satm_omp, eqm_omp,      &
                        rated_omp, cinc_omp, cxinc_omp, totcinc_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8) :: conc_mol_avg_omp
      real(type_r8), allocatable :: satm_omp(:)
      real(type_r8), allocatable :: eqm_omp(:)
      real(type_r8), allocatable :: rated_omp(:)
      real(type_r8), allocatable :: cinc_omp(:)
      real(type_r8), allocatable :: cxinc_omp(:)
      real(type_r8), allocatable :: totcinc_omp(:)

      dimension totc(*),c(*),cx(*),gammac(*),gammax(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)

!c  initialize derivative of total reaction rate

      ratem = r0
	xnum_jbl = r0

!c  calculate factors for derivative, due to IAP/K except for 
!c  far-from-equilibrium dissolution-precipitation reactions

      if (.not.far_from_equil(im)) then

        satm_omp(im) = eqm_omp(im)**(-r1)
        
        istart = iam(im)
        istop = iam(im+1)-1
        do i1 = istart,istop
          ic = jam(i1)
          satm_omp(im) = satm_omp(im) * (gammac(ic)*c(ic))**xnum(i1)
	    if (ic.eq.jbl) then
	      xnum_jbl = xnum(i1)
	    end if
        end do

      end if

!c  surface-controlled dissolution-precipitation reactions

      if (rate_control(im).eq.'surface') then

        if (reaction_type(im).eq.'reversible') then

!c  loop over parallel dissolution-precipitation reactions

          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop 

!c  determine factors for derivative due to fractional order terms

            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1
            prod_dc = r1
	      orddc_jbl = r0

            do i1 = istart2,istop2
   
              ic = jamdc(i1)
	        prod_dc = prod_dc * (gammac(ic)*c(ic))**orddc(i1)
  	        if (ic.eq.jbl) then
	          orddc_jbl = orddc(i1)
	        end if
        
	      end do

!c  determine derivative for parallel reaction pathway

            prodrc = orddc_jbl*prod_dc &
                  - (orddc_jbl+xnum_jbl)*prod_dc*satm_omp(im)

!c  add derivative to derivative for overall dissolution-
!c  precipitation reaction and scale by reaction rate
 	  
	      ratem = ratem-rated_omp(ireac)*prodrc

	    end do      !(reaction pathways)
        
	  end if        !(reaction_type(im)

      end if          !(rate_control(im)

!c  compute final derivative for overall dissolution-
!c  precipitation reaction  

	ratem = aream*ratem/c(jbl)
      
      return

!c ************************************************************

      if (reaction_type(im).eq.'raoult') then

        call draoult_omp(c,gammac,ratem,phim,phimold,aream,drtinc,im, &
        conc_mol_avg_omp, satm_omp, eqm_omp, cinc_omp, rated_omp)
        return

      end if

!c  initialize total reaction rate

      ratem = r0

!c  calculate saturation index for current mineral 
!c  (not incremented - incremented) except for far from
!c  equilibrium dissolution-precipitation reactions

      if (.not.far_from_equil(im)) then

        satm_omp(im) = eqm_omp(im)**(-r1)
        
        istart = iam(im)
        istop = iam(im+1)-1
        do i1 = istart,istop
          ic = jam(i1)
          satm_omp(im) = satm_omp(im) * (gammac(ic)*c(ic))**xnum(i1)
        end do

      end if

!c  compute difference of total dissolution/precipitation rate 
!c  for surface controlled dissolution/precipitation reactions
!c  (incremented - not incremented)

      if (rate_control(im).eq.'surface') then

!c  compute rates only for specified reaction direction

        if (reaction_type(im).eq.'reversible' .or.                     &
          reaction_type(im).eq.'dissolution_far_from_equilibrium' .or. &
          (reaction_type(im).eq.'dissolution_to_equilibrium'.and.      &
          r1-satm_omp(im).gt.r0) .or.                                      &
          reaction_type(im).eq.                                        &
          'precipitation_far_from_equilibrium' .or.                    &
          (reaction_type(im).eq.'precipitation_to_equilibrium'.and.    &
           r1-satm_omp(im).lt.r0).or.                                      &
           reaction_type(im).eq.'monod') then

!c  loop over parallel dissolution/precipitation reactions

          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop

!c  scale reaction rate depending on equilibrium condition except for
!c  far from equilibrium reactions
!c  (not incremented - incremented)

            if (reaction_type(im).eq. & 
               'dissolution_far_from_equilibrium'.or. &
                reaction_type(im).eq.'monod') then

              prodrc = rated_omp(ireac)
              prodrcinc = rated_omp(ireac)

            elseif (reaction_type(im).eq. &
                  'precipitation_far_from_equilibrium') then

              prodrc = -rated_omp(ireac)
              prodrcinc = -rated_omp(ireac)

            else

              prodrc = - rated_omp(ireac)  &
                    * (r1-satm_omp(im)**ordm(ireac))**ordn(ireac)
              

            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdt(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then

                prodrc = prodrc &
                      * (totc(ic)/(totc(ic)+ordm(ireac)))**ordn(ireac)
                prodrcinc = prodrcinc &
                         * (totcinc_omp(ic)/ &
                            (totcinc_omp(ic)+ordm(ireac)))**ordn(ireac)

              end if

              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc_omp(ic)**orddt(i1)

            end do

!c  form product of reacting components as species in solution
!c  (not incremented - incremented)

            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdc(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then

                prodrc = prodrc * (gammac(ic)*c(ic) / &
                        (gammac(ic)*c(ic)+ordm(ireac)))**ordn(ireac)
                prodrcinc = prodrcinc * (gammac(ic)*cinc_omp(ic) / &
                      (gammac(ic)*cinc_omp(ic)+ordm(ireac)))**ordn(ireac)

              end if

              prodrc = prodrc * (gammac(ic)*c(ic))**orddc(i1)
              prodrcinc = prodrcinc * (gammac(ic)*cinc_omp(ic))**orddc(i1)

            end do

!c  form product of reacting complexed species
!c  (not incremented - incremented)

            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1

            do i1 = istart2,istop2

              ix = jamdcx(i1)

!c  scale reaction for far from equilibrium reactions


              if (far_from_equil(im)) then

                prodrc = prodrc * (gammax(ix)*cx(ix) / & 
                        (gammax(ix)*cx(ix)+ordm(ireac)))**ordn(ireac)
                prodrcinc = prodrcinc * (gammax(ix)*cxinc_omp(ix) / &
                      (gammax(ix)*cxinc_omp(ix)+ordm(ireac)))**ordn(ireac)

              end if

              prodrc = prodrc * (gammax(ix)*cx(ix))**orddcx(i1)
              prodrcinc = prodrcinc * (gammax(ix)*cxinc_omp(ix))**orddcx(i1)

            end do


!c  compute total rate for surface controlled reactions
!c  [moles/(L bulk*day)] = [m^2 mineral/L bulk]
!c                          -----------         
!c                       * [moles/(m^2 mineral * day)]
!c                                 -----------
!c  and sum up parallel reaction rates for surface controlled
!c  dissolution/precipitation reactions (incremented - not incremented)

            ratem = ratem - aream * (prodrcinc - prodrc)

          end do       !loop over parallel diss/prec reactions

!c  add monod and inhibition terms

          if (reaction_type(im).eq.'monod') then

!c  monod terms

            istart2 = iamdm(im)
            istop2 = iamdm(im+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdm(i1)

                ratem =  ratem &
                 * ((totcinc_omp(ic)/(fmdm(i1) + totcinc_omp(ic)))**ordmdm(i1) &
                 -  (totc(ic)/(fmdm(i1) + totc(ic)))**ordmdm(i1))

              end do

            end if

!c  inhibition terms

            istart2 = iamdi(im)
            istop2 = iamdi(im+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdi(i1)

                ratem = ratem * (fmdi(i1)/(fmdi(i1)+totcinc_omp(ic)) &
                             -  fmdi(i1)/(fmdi(i1)+totc(ic)))

              end do

            end if

          end if       !(reaction_type(im).eq.'monod')

        end if         !reaction_type(im)

!c  compute difference of total dissolution/precipitation rate 
!c  for transport controlled dissolution/precipitation reactions
!c  (incremented - not incremented)

      elseif (rate_control(im).eq.'transport') then

       if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or. &
           reaction_type(im).eq.'reversible'.or.                       &
           (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
            r1-satm_omp(im).gt.r0)) then

!c  compute difference of total dissolution rate 
!c  (incremented - not incremented)
 
          istart = iamd(im)
          iend = iamd(im+1)-1

          do ireac = istart,iend
 
!c  scale reaction rate, if dissolution reaction is limited by
!c  equilibrium conditions

            if (far_from_equil(im)) then
              prodrc = r1
              prodrcinc = r1
            else
              prodrc = r1-satm_omp(im)
              prodrcinc = r1-satminc
            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc_omp(ic)**orddt(i1)
            end do
 
!c  form product of reacting free species for current dissolution
!c  reaction, activity coefficients are here not considered explicitely,
!c  but are by definition included in the effective diffusion coefficient
!c  (free species and incremented free species)
 
            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1
            do i1 = istart2,istop2
              ic = jamdc(i1)
              prodrc = prodrc * c(ic)**orddc(i1)
              prodrcinc = prodrcinc * cinc_omp(ic)**orddc(i1)
            end do
 
!c  include complexed species in product of reacting species for current
!c  dissolution reaction
!c  (complexed species and incremented complexed species)
 
            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1
            do i1 = istart2,istop2
              ix = jamdcx(i1)
              prodrc = prodrc * cx(ix)**orddcx(i1)
              prodrcinc = prodrcinc * cxinc_omp(ix)**orddcx(i1)
            end do
 
!c  compute difference of total rate 
!c  [moles/(l bulk*day)] = [m mineral / m^3 bulk]
!c                          ---------   --- 
!c                       * [m^3 h2o/m^3 mineral * m^2 mineral/day]
!c                          --- --- -----------   ----------- 
!c                       * [moles/l h2o]
!c                                  ---
!c  and sum up difference of total dissolution rate 
!c  [moles/(l h2o)] (incremented - not incremented)

            ratem = ratem - aream * diffm(ireac)/xnud(ireac) &
                         * (prodrcinc - prodrc)

          end do  

!c  do not allow precipitation 

        else            !reaction_type(im)

          ratem = r0
 
        end if          !reaction_type(im)

      end if            !rate_control(im)

!c  divide by increment of numerical differentiation
!c  and obtain derivative of total rate

      ratem = ratem/drtinc
 
      return
    end subroutine  
                        
!c ----------------------------------------------------------------------
!c subroutine dratemin_omp
!c -------------------
!c
!c compute derivative of absolute dissolution-precipitation rate 
!c of mineral
!c
!c sign convention: dissolution -
!c                  precipitation +
!c
!c written by:      Uli Mayer - December 21, 96
!c
!c last modified:   Uli Mayer - July 25, 97
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           gammax(nx)         = activity coefficient of             + -
!c                                secondary aqueous species
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           phim               = volume fraction of mineral          + -
!c           phimold            = volume fraction of mineral          + -
!c                                - old time level
!c           ratem              = derivative of absolute dissolution- * +
!c                                precipitation rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(n)            = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/(l bulk)]
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           cinc(nc)           = incremented free species            + -
!c                                concentrations
!c                                [moles/l h2o]
!c           cxinc(nx)          = secondary aqueous species           + -
!c                                concentrations dependent on
!c                                incremented free species
!c                                concentrations
!c                                [moles/l h2o]
!c           diffm(ndr*nm)      = free diffusion coefficient of       + -
!c                                primary reactant in water
!c                                (transport controlled reactions)
!c           eqm(nm)            = equilibrium constants for minerals  + -
!c           fmdi(nrc*nm)       = inhibition factors                  + -
!c           fmdm(nrc*nm)       = monod factors                       + -
!c           orddc(nrc*nm)      = order of free species in            + -
!c                                dissolution reaction
!c           orddcx(nrc*nm)     = order of secondary aqueous          + -
!c                                species in dissolution reaction
!c           orddt(nrc*nm)      = order of total aqueous component    + -
!c                                concentration in dissolution
!c                                reaction
!c           ordm(ndr*nm)       = exponent m for reaction rate law    + -
!c           ordmdm(nrc*nm)     = order of monod terms for            + -
!c                                dissolution-precipitation reactions
!c           ordn(ndr*nm)       = exponent n for reaction rate law    + -
!c           rated(ndr*nm)      = rate constants for dissolution      + -
!c                                reactions
!c           satm(nm)           = saturation indices                  * +
!c           totcinc(n)         = total aqueous component             + -
!c                                concentrations - new time level, 
!c                                incremented [moles/l water]
!c           xnud(ndr*nm)       = stoichiometric coefficients of      + -
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution        + -
!c                                reactions
!c           iamdc(ndr*nm+1)    = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamdc(nrc*nm)      = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           jamdm(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           jamdt(nrc*nm)      = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c           nx                 = number of aqueous complexes         + -
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c
!c           logical:
!c           --------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = activity product of species
!c                                involved in reaction
!c           prodrcinc          = activity product of species
!c                                involved in reaction (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c           ratetrans          = differential of transport controlled
!c                                reaction rate 
!c                                (incremented - not incremnented)
!c           satminc            = saturation index with respect
!c                                to current mineral (incremented)
!c
!c           integer*4:
!c           ----------
!c           ireac              = counter 
!c           istart             = pointer (start of reaction set) 
!c           iend               = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueosu species)
!c           i1                 = counter
!c
!c external: draoult  = compute derivative of dissolution rate 
!c                      of organic compound from organic mixture based 
!c                      on raoult's law
!c ----------------------------------------------------------------------
  
      subroutine dratemin_omp(totc,c,cx,gammac,gammax,ratem,phim, &
                         phimold,aream,drtinc,im,ivol,            &
                        conc_mol_avg_omp, satm_omp, eqm_omp,      &
                        rated_omp, cinc_omp, cxinc_omp, totcinc_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8) :: conc_mol_avg_omp
      real(type_r8), allocatable :: satm_omp(:)
      real(type_r8), allocatable :: eqm_omp(:)
      real(type_r8), allocatable :: rated_omp(:)
      real(type_r8), allocatable :: cinc_omp(:)
      real(type_r8), allocatable :: cxinc_omp(:)
      real(type_r8), allocatable :: totcinc_omp(:)
      
      real*8 :: r1_iap_k = 0.0

      dimension totc(*),c(*),cx(*),gammac(*),gammax(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)
 
      if (reaction_type(im).eq.'raoult') then

        call draoult_omp(c,gammac,ratem,phim,phimold,aream,drtinc,im, &
        conc_mol_avg_omp, satm_omp, eqm_omp, cinc_omp, rated_omp)
        return

      end if

!c  initialize total reaction rate

      ratem = r0

!c  calculate saturation index for current mineral 
!c  (not incremented - incremented) except for far from
!c  equilibrium dissolution-precipitation reactions

      if (.not.far_from_equil(im)) then

        satm_omp(im) = eqm_omp(im)**(-r1)
        satminc = eqm_omp(im)**(-r1)

        istart = iam(im)
        istop = iam(im+1)-1
        do i1 = istart,istop
          ic = jam(i1)
          satm_omp(im) = satm_omp(im) * (gammac(ic)*c(ic))**xnum(i1)
          satminc = satminc * (gammac(ic)*cinc_omp(ic))**xnum(i1)
        end do

      end if

!c  compute difference of total dissolution/precipitation rate 
!c  for surface controlled dissolution/precipitation reactions
!c  (incremented - not incremented)

      if (rate_control(im).eq.'surface') then

!c  compute rates only for specified reaction direction

        if (reaction_type(im).eq.'reversible' .or.                     &
           reaction_type(im).eq.'dissolution_far_from_equilibrium' .or.&
           (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
            r1-satm_omp(im).gt.r0) .or.                                    &
           reaction_type(im).eq.                                       &
           'precipitation_far_from_equilibrium' .or.                   &
           (reaction_type(im).eq.'precipitation_to_equilibrium'.and.   &
            r1-satm_omp(im).lt.r0).or.                                     &
            reaction_type(im).eq.'monod') then

!c  loop over parallel dissolution/precipitation reactions

          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop

!c  scale reaction rate depending on equilibrium condition except for
!c  far from equilibrium reactions
!c  (not incremented - incremented)

            if (reaction_type(im).eq.                                 &
               'dissolution_far_from_equilibrium'.or.                 &
                reaction_type(im).eq.'monod') then

              prodrc = rated_omp(ireac)
              prodrcinc = rated_omp(ireac)

            elseif (reaction_type(im).eq.                             &
                  'precipitation_far_from_equilibrium') then

              prodrc = -rated_omp(ireac)
              prodrcinc = -rated_omp(ireac)

            else

!c  commented out to avoid NaN problems
              !prodrc = rated(ireac)                                     &
              !       * (r1 - satm(im)**ordm(ireac))**ordn(ireac)
              !prodrcinc = rated(ireac)                                  &
              !          * (r1 - satminc**ordm(ireac))**ordn(ireac)
              !
              !if(isnan(prodrc)) then
              !    write(*,*) "prodrc is nan1: ", r1 - satm(im)**ordm(ireac),  ordn(ireac)
              !end if
              !
              !if(isnan(prodrcinc)) then
              !    write(*,*) "prodrcinc is nan1: ", r1 - satminc**ordm(ireac),  ordn(ireac)
              !end if
              
              !Lasaga et al. (1994) equation. dsu, 2012-12-20
              
              if(b_ratelaw_exponent_n) then
                  r1_iap_k = r1 - satm_omp(im)**ordm(ireac)
                  if (r1_iap_k > 0) then
                      if (reaction_type(im) == 'precipitation_to_equilibrium') then
                          prodrc = 0.0d0
                      else
                          prodrc = rated_omp(ireac) * r1_iap_k**ordn(ireac)
                      end if
                  else
                      if (reaction_type(im) == 'dissolution_to_equilibrium') then
                          prodrc = 0.0d0
                      else
                          prodrc = -rated_omp(ireac) * (abs(r1_iap_k))**ordn(ireac)
                      end if    
                  end if
                  
                  r1_iap_k = r1 - satminc**ordm(ireac)
                  if (r1_iap_k > 0) then
                      if (reaction_type(im) == 'precipitation_to_equilibrium') then
                          prodrcinc = 0.0d0
                      else
                          prodrcinc = rated_omp(ireac) * r1_iap_k**ordn(ireac)
                      end if
                  else
                      if (reaction_type(im) == 'dissolution_to_equilibrium') then
                          prodrcinc = 0.0d0
                      else
                          prodrcinc = -rated_omp(ireac) * (abs(r1_iap_k))**ordn(ireac)
                      end if    
                  end if                    
              else
                  prodrc = rated_omp(ireac) * (r1 - (satm_omp(im)**ordm(ireac)))
                  prodrcinc = rated_omp(ireac) * (r1 - (satminc**ordm(ireac)))
              end if
              
              !--old--
              !prodrc = rated(ireac)                                   &
              !      * (r1 - (satm(im)**ordm(ireac)))
              !prodrcinc = rated(ireac)                                &
              !         * (r1 - (satminc**ordm(ireac)))


            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdt(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then

                prodrc = prodrc               &
                      * (totc(ic)/(totc(ic)+ordm(ireac)))**ordn(ireac)
                prodrcinc = prodrcinc         &
                         * (totcinc_omp(ic)/      &
                            (totcinc_omp(ic)+ordm(ireac)))**ordn(ireac)

              end if

              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc_omp(ic)**orddt(i1)

            end do

!c  form product of reacting components as species in solution
!c  (not incremented - incremented)

            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdc(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then

                prodrc = prodrc * (gammac(ic)*c(ic) /                 &
                        (gammac(ic)*c(ic)+ordm(ireac)))**ordn(ireac)
                prodrcinc = prodrcinc * (gammac(ic)*cinc_omp(ic) /        &
                      (gammac(ic)*cinc_omp(ic)+ordm(ireac)))**ordn(ireac)

              end if

              prodrc = prodrc * (gammac(ic)*c(ic))**orddc(i1)
              prodrcinc = prodrcinc * (gammac(ic)*cinc_omp(ic))**orddc(i1)

            end do

!c  form product of reacting complexed species
!c  (not incremented - incremented)

            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1

            do i1 = istart2,istop2

              ix = jamdcx(i1)

!c  scale reaction for far from equilibrium reactions


              if (far_from_equil(im)) then

                prodrc = prodrc * (gammax(ix)*cx(ix) /                &
                        (gammax(ix)*cx(ix)+ordm(ireac)))**ordn(ireac)
                prodrcinc = prodrcinc * (gammax(ix)*cxinc_omp(ix) /       &
                      (gammax(ix)*cxinc_omp(ix)+ordm(ireac)))**ordn(ireac)

              end if

              prodrc = prodrc * (gammax(ix)*cx(ix))**orddcx(i1)
              prodrcinc = prodrcinc * (gammax(ix)*cxinc_omp(ix))**orddcx(i1)

            end do


!c  compute total rate for surface controlled reactions
!c  [moles/(L bulk*day)] = [m^2 mineral/L bulk]
!c                          -----------         
!c                       * [moles/(m^2 mineral * day)]
!c                                 -----------
!c  and sum up parallel reaction rates for surface controlled
!c  dissolution/precipitation reactions (incremented - not incremented)

            ratem = ratem - aream * (prodrcinc - prodrc)

          end do       !loop over parallel diss/prec reactions

!c  add monod and inhibition terms

          if (reaction_type(im).eq.'monod') then

!c  monod terms

            istart2 = iamdm(im)
            istop2 = iamdm(im+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdm(i1)

                ratem =  ratem                                        &
                 * ((totcinc_omp(ic)/(fmdm(i1) + totcinc_omp(ic)))**ordmdm(i1) &
                 -  (totc(ic)/(fmdm(i1) + totc(ic)))**ordmdm(i1))

              end do

            end if

!c  inhibition terms

            istart2 = iamdi(im)
            istop2 = iamdi(im+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdi(i1)

                ratem = ratem * (fmdi(i1)/(fmdi(i1)+totcinc_omp(ic))      &
                             -  fmdi(i1)/(fmdi(i1)+totc(ic)))

              end do

            end if

          end if       !(reaction_type(im).eq.'monod')

        end if         !reaction_type(im)

!c  compute difference of total dissolution/precipitation rate 
!c  for transport controlled dissolution/precipitation reactions
!c  (incremented - not incremented)

      elseif (rate_control(im).eq.'transport') then

        if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
           reaction_type(im).eq.'reversible'.or.                       &
           (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
            r1-satm_omp(im).gt.r0)) then

!c  compute difference of total dissolution rate 
!c  (incremented - not incremented)
 
          istart = iamd(im)
          iend = iamd(im+1)-1

          do ireac = istart,iend
 
!c  scale reaction rate, if dissolution reaction is limited by
!c  equilibrium conditions

            if (far_from_equil(im)) then
              prodrc = r1
              prodrcinc = r1
            else
              prodrc = r1-satm_omp(im)
              prodrcinc = r1-satminc
            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc_omp(ic)**orddt(i1)
            end do
 
!c  form product of reacting free species for current dissolution
!c  reaction, activity coefficients are here not considered explicitely,
!c  but are by definition included in the effective diffusion coefficient
!c  (free species and incremented free species)
 
            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1
            do i1 = istart2,istop2
              ic = jamdc(i1)
              prodrc = prodrc * c(ic)**orddc(i1)
              prodrcinc = prodrcinc * cinc_omp(ic)**orddc(i1)
            end do
 
!c  include complexed species in product of reacting species for current
!c  dissolution reaction
!c  (complexed species and incremented complexed species)
 
            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1
            do i1 = istart2,istop2
              ix = jamdcx(i1)
              prodrc = prodrc * cx(ix)**orddcx(i1)
              prodrcinc = prodrcinc * cxinc_omp(ix)**orddcx(i1)
            end do
 
!c  compute difference of total rate 
!c  [moles/(l bulk*day)] = [m mineral / m^3 bulk]
!c                          ---------   --- 
!c                       * [m^3 h2o/m^3 mineral * m^2 mineral/day]
!c                          --- --- -----------   ----------- 
!c                       * [moles/l h2o]
!c                                  ---
!c  and sum up difference of total dissolution rate 
!c  [moles/(l h2o)] (incremented - not incremented)

            ratem = ratem - aream * diffm(ireac)/xnud(ireac)  &
                         * (prodrcinc - prodrc)

          end do  

!c  do not allow precipitation 

        else            !reaction_type(im)

          ratem = r0
 
        end if          !reaction_type(im)

      end if            !rate_control(im)

!c  divide by increment of numerical differentiation
!c  and obtain derivative of total rate

      ratem = ratem/drtinc
 
      return
    end subroutine
                        
                        
!c ----------------------------------------------------------------------
!c subroutine dratemin_new_omp
!c -----------------------
!c
!c compute derivative of absolute dissolution-precipitation rate 
!c of mineral (new database format)
!c
!c based on routine dratemin
!c
!c sign convention: dissolution -
!c                  precipitation +
!c
!c written by:      Uli Mayer - November 11, 01
!c
!c last modified:   Uli Mayer - February 3, 02
!c                  added hyperbolic and inhibition terms for 
!c                  minerals
!c                  Uli Mayer - August 8, 02
!c                  added hyperbolic and inhibition terms for
!c                  components as species in solution
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           gammax(nx)         = activity coefficient of             + -
!c                                secondary aqueous species
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           phim               = volume fraction of mineral          + -
!c           phimold            = volume fraction of mineral          + -
!c                                - old time level
!c           ratem              = derivative of absolute dissolution- * +
!c                                precipitation rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(n)            = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/(l bulk)]
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           cinc(nc)           = incremented free species            + -
!c                                concentrations
!c                                [moles/l h2o]
!c           cxinc(nx)          = secondary aqueous species           + -
!c                                concentrations dependent on
!c                                incremented free species
!c                                concentrations
!c                                [moles/l h2o]
!c           diffm(ndr*nm)      = free diffusion coefficient of       + -
!c                                primary reactant in water
!c                                (transport controlled reactions)
!c           eqm(nm)            = equilibrium constants for minerals  + -
!c           fmdi(nrc*nc)       = inhibition constants - T^a          + -
!c           fmdm(nrc*nc)       = half saturation constants - T^a     + -
!c           fmic(nrc*nc)       = inhibition constants - C^c          + -
!c           fmhc(nrc*nc)       = half saturation constants - C^c     + -
!c           fmdpi(nrc*nm)      = inhibition constants - phi^m        + -
!c           fmdpm(nrc*nm)      = half saturation constants - phi^m   + -
!c           orddc(nrc*nm)      = order of free species in            + -
!c                                dissolution reaction
!c           orddcx(nrc*nm)     = order of secondary aqueous          + -
!c                                species in dissolution reaction
!c           orddt(nrc*nm)      = order of total aqueous component    + -
!c                                concentration in dissolution
!c                                reaction
!c           ordm(ndr*nm)       = exponent m for reaction rate law    + -
!c           ordmdi(nrc*nm)     = order of inhibition terms for       + -
!c                                dissolution-precipitation reactions
!c                                - T^a
!c           ordmdm(nrc*nm)     = order of hyperbolic terms for       + -
!c                                dissolution-precipitation reactions
!c                                - T^a
!c           ordmic(nrc*nm)     = order of inhibition terms for       + -
!c                                dissolution-precipitation reactions
!c                                - C^c
!c           ordmhc(nrc*nm)     = order of hyperbolic terms for       + -
!c                                dissolution-precipitation reactions
!c                                - C^c
!c           ordmdpi(nrc*nm)    = order of inhibition terms for       + -
!c                                dissolution-precipitation reactions
!c                                - phi^m
!c           ordmdpm(nrc*nm)    = order of hyperbolic terms for       + -
!c                                dissolution-precipitation reactions
!c                                - phi^m
!c           ordn(ndr*nm)       = exponent n for reaction rate law    + -
!c           rated(ndr*nm)      = rate constants for dissolution      + -
!c                                reactions
!c           satm(nm)           = saturation indices                  * +
!c           totcinc(n)         = total aqueous component             + -
!c                                concentrations - new time level, 
!c                                incremented [moles/l water]
!c           xnud(ndr*nm)       = stoichiometric coefficients of      + -
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution        + -
!c                                reactions
!c           iamdc(ndr*nm+1)    = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - T^a)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - T^a)
!c           iamic(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - C^c)
!c           iamhc(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - C^c)
!c           iamdpi(ndr*nm+1)   = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - 
!c                                phi^m)
!c           iamdpm(ndr*nm+1)   = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - 
!c                                phi^m)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamdc(nrc*nm)      = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - T^a)
!c           jamdm(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - T^a)
!c           jamic(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - C^c)
!c           jamhc(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - C^c)
!c           jamdpi(nrc*nm)     = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms 
!c                                - phi^m)
!c           jamdpm(nrc*nm)     = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms 
!c                                - phi^m)
!c           jamdt(nrc*nm)      = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c           nx                 = number of aqueous complexes         + -
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c
!c           logical:
!c           --------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = type of mineral dissolution-        + -
!c                                precipiaton reaction
!c
!c local:    real*8:
!c           -------
!c           prodrc             = activity product of species
!c                                involved in reaction
!c           prodrcinc          = activity product of species
!c                                involved in reaction (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c           ratetrans          = differential of transport controlled
!c                                reaction rate 
!c                                (incremented - not incremnented)
!c           satminc            = saturation index with respect
!c                                to current mineral (incremented)
!c
!c           integer*4:
!c           ----------
!c           ireac              = counter 
!c           istart             = pointer (start of reaction set) 
!c           iend               = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ic                 = counter (components)
!c           im2                = counter (minerals)
!c           ix                 = counter (secondary aqueosu species)
!c           i1                 = counter
!c
!c external: draoult  = compute derivative of dissolution rate 
!c                      of organic compound from organic mixture based 
!c                      on raoult's law
!c ----------------------------------------------------------------------
  
      subroutine dratemin_new_omp(totc,c,cx,gammac,gammax,ratem,phim, &
                             phimold,aream,drtinc,im,ivol,            &
                             conc_mol_avg_omp, satm_omp, eqm_omp,     &
                        rated_omp, cinc_omp, cxinc_omp, totcinc_omp)
 
      use parm
      use chem
 
      implicit real*8 (a-h,o-z)
      real(type_r8) :: conc_mol_avg_omp
      real(type_r8), allocatable :: satm_omp(:)
      real(type_r8), allocatable :: eqm_omp(:)
      real(type_r8), allocatable :: rated_omp(:)
      real(type_r8), allocatable :: cinc_omp(:)
      real(type_r8), allocatable :: cxinc_omp(:)
      real(type_r8), allocatable :: totcinc_omp(:)
      
      real*8 :: r1_iap_k = 0.0

      dimension totc(*),c(*),cx(*),gammac(*),gammax(*),phim(*)

      parameter (r0 = 0.0d0, r1 = 1.0d0)
 
      if (reaction_type(im).eq.'raoult') then

        call draoult_omp(c,gammac,ratem,phim(im),phimold,aream,drtinc,im, &
        conc_mol_avg_omp, satm_omp, eqm_omp, cinc_omp, rated_omp)
        return

      end if

!c  initialize total reaction rate

      ratem = r0

!c  calculate saturation index for current mineral 
!c  (not incremented - incremented) except for far from
!c  equilibrium dissolution-precipitation reactions

      if (.not.far_from_equil(im)) then

        satm_omp(im) = eqm_omp(im)**(-r1)
        satminc = eqm_omp(im)**(-r1)

        istart = iam(im)
        istop = iam(im+1)-1
        do i1 = istart,istop
          ic = jam(i1)
          satm_omp(im) = satm_omp(im) * (gammac(ic)*c(ic))**xnum(i1)
          satminc = satminc * (gammac(ic)*cinc_omp(ic))**xnum(i1)
        end do

      end if

!c  compute difference of total dissolution/precipitation rate 
!c  for surface controlled dissolution/precipitation reactions
!c  (incremented - not incremented)

      if (rate_control(im).eq.'surface') then

!c  compute rates only for specified reaction direction

        if (reaction_type(im).eq.'reversible' .or.                     &
           reaction_type(im).eq.'dissolution_far_from_equilibrium' .or.&
           (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
            r1-satm_omp(im).gt.r0) .or.                                    &
           reaction_type(im).eq.                                       &
           'precipitation_far_from_equilibrium' .or.                   &
           (reaction_type(im).eq.'precipitation_to_equilibrium'.and.   &
            r1-satm_omp(im).lt.r0)) then

!c  loop over parallel dissolution/precipitation reactions

          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop

!c  scale reaction rate depending on equilibrium condition except for
!c  far from equilibrium reactions
!c  (not incremented - incremented)

            if (reaction_type(im).eq.                                 &
               'dissolution_far_from_equilibrium') then

              prodrc = rated_omp(ireac)
              prodrcinc = rated_omp(ireac)

            elseif (reaction_type(im).eq.                             &
                  'precipitation_far_from_equilibrium') then

              prodrc = -rated_omp(ireac)
              prodrcinc = -rated_omp(ireac)

!culi 18/05/06 modified formulation for precipitation_to_equilibrium 
!culi to avoid excessively large precipitation rates 

            elseif (reaction_type(im).eq.			&
     &             'precipitation_to_equilibrium') then

              prodrc = -rated_omp(ireac) 				&
     &               * (r1 - satm_omp(im)**-r1)
              prodrcinc = -rated_omp(ireac)				&
     &                  * (r1 - satminc**-r1)
            
            else

!c  commented out to avoid NaN problems
              !prodrc = rated(ireac)                                     &
              !       * (r1 - satm(im)**ordm(ireac))**ordn(ireac)
              !prodrcinc = rated(ireac)                                  &
              !          * (r1 - satminc**ordm(ireac))**ordn(ireac)
              !
              !if(isnan(prodrc)) then
              !    write(*,*) "prodrc is nan2: ", r1 - satm(im)**ordm(ireac),  ordn(ireac)
              !end if
              !
              !if(isnan(prodrcinc)) then
              !    write(*,*) "prodrcinc is nan2: ", r1 - satminc**ordm(ireac),  ordn(ireac)
              !end if
              
              !Lasaga et al. (1994) equation. dsu, 2012-12-20
              
              if (b_ratelaw_exponent_n) then
                  
                if (reverse_affinity_term(im).and.satm_omp(im).gt.r1) then
                    prodrc = -rated_omp(ireac)      &
     &                 * (r1 - satm_omp(im)**-ordm(ireac))**ordn(ireac)
                    prodrcinc = -rated_omp(ireac)   &
     &                    * (r1 - satminc**-ordm(ireac))**ordn(ireac)
                else
                  
                  r1_iap_k = r1 - satm_omp(im)**ordm(ireac)
                  if (r1_iap_k > 0) then        !satm(im) < 1 as ordm(ireac) is positive
                      if (reaction_type(im) == 'precipitation_to_equilibrium') then
                          prodrc = 0.0d0
                      else 
                          prodrc = rated_omp(ireac) * r1_iap_k**ordn(ireac)
                      end if
                  else                          !satm(im) >= 1 as ordm(ireac) is positive 
                      if (reaction_type(im) == 'dissolution_to_equilibrium') then
                          prodrc = 0.0d0
                      else
                          prodrc = -rated_omp(ireac) * (abs(r1_iap_k))**ordn(ireac)
                      end if
                  end if
                                    
                  r1_iap_k = r1 - satminc**ordm(ireac)
                  if (r1_iap_k > 0) then        !satm(im) < 1 as ordm(ireac) is positive
                      if (reaction_type(im) == 'precipitation_to_equilibrium') then
                          prodrcinc = 0.0d0
                      else
                          prodrcinc = rated_omp(ireac) * r1_iap_k**ordn(ireac)
                      end if
                  else                          !satm(im) >= 1 as ordm(ireac) is positive 
                      if (reaction_type(im) == 'dissolution_to_equilibrium') then
                          prodrcinc = 0.0d0
                      else
                          prodrcinc = -rated_omp(ireac) * (abs(r1_iap_k))**ordn(ireac)
                      end if
                  end if  
                  
                end if
                
              else
!crevaff
                if (reverse_affinity_term(im).and.satm_omp(im).gt.r1) then
                    prodrc = -rated_omp(ireac)      &
     &                 * (r1 - satm_omp(im)**-ordm(ireac))
                    prodrcinc = -rated_omp(ireac)   &
     &                    * (r1 - satminc**-ordm(ireac))
                else
                    prodrc = rated_omp(ireac) * (r1 - satm_omp(im)**ordm(ireac))
                    prodrcinc = rated_omp(ireac) * (r1 - satminc**ordm(ireac))  
                end if    
!crevaff         
              end if
              
              !--old--
              !prodrc = rated(ireac)                                   &
              !      * (r1 - satm(im)**ordm(ireac))
              !prodrcinc = rated(ireac)                                &
              !         * (r1 - satminc**ordm(ireac))

            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc_omp(ic)**orddt(i1)

            end do

!c  form product of reacting components as species in solution
!c  (not incremented - incremented)

            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdc(i1)
              prodrc = prodrc * (gammac(ic)*c(ic))**orddc(i1)
              prodrcinc = prodrcinc * (gammac(ic)*cinc_omp(ic))**orddc(i1)

            end do

!c  form product of reacting complexed species
!c  (not incremented - incremented)

            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1

            do i1 = istart2,istop2

              ix = jamdcx(i1)

              prodrc = prodrc * (gammax(ix)*cx(ix))**orddcx(i1)
              prodrcinc = prodrcinc * (gammax(ix)*cxinc_omp(ix))**orddcx(i1)

            end do

!c  hyperbolic terms - T^a

            istart2 = iamdm(ireac)
            istop2 = iamdm(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdm(i1)

                prodrc = prodrc * (totc(ic)/                      &
                        (fmdm(i1) + totc(ic)))**ordmdm(i1)
                prodrcinc = prodrcinc * (totcinc_omp(ic)/             &
                          (fmdm(i1) + totcinc_omp(ic)))**ordmdm(i1)

              end do

            end if

!c  inhibition terms - T^a

            istart2 = iamdi(ireac)
            istop2 = iamdi(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdi(i1)
                prodrc = prodrc                                       &
                      * (fmdi(i1)/(fmdi(i1)+totc(ic)))**ordmdi(i1)
                prodrcinc = prodrcinc * (fmdi(i1)/                    &
                          (fmdi(i1)+totcinc_omp(ic)))**ordmdi(i1)
                
              end do

            end if

!c  hyperbolic terms - C^c

            istart2 = iamhc(ireac)
            istop2 = iamhc(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamhc(i1)

                prodrc = prodrc * (gammac(ic)*c(ic)/                  &
                        (fmhc(i1) + gammac(ic)*c(ic)))**ordmhc(i1)
                prodrcinc = prodrcinc * (gammac(ic)*cinc_omp(ic)/         &
                          (fmhc(i1) + gammac(ic)*cinc_omp(ic)))**ordmhc(i1)

              end do

            end if

!c  inhibition terms - C^c

            istart2 = iamic(ireac)
            istop2 = iamic(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamic(i1)
                prodrc = prodrc                                   &
                      * (fmic(i1)                                 &
                      / (fmic(i1)+gammac(ic)*c(ic)))**ordmic(i1)
                prodrcinc = prodrcinc * (fmic(i1)/                &
                          (fmic(i1)+gammac(ic)*cinc_omp(ic)))**ordmic(i1)
                
              end do

            end if

!c  hyperbolic terms - phi^m

            istart2 = iamdpm(ireac)
            istop2 = iamdpm(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                im2 = jamdpm(i1)

                prodrc = prodrc * (phim(im2)/                 &
                        (fmdpm(i1) + phim(im2)))**ordmdpm(i1)
                prodrcinc = prodrcinc * (phim(im2)/           &
                          (fmdpm(i1) + phim(im2)))**ordmdpm(i1)

              end do

            end if

!c  inhibition terms - phi^m

            istart2 = iamdpi(ireac)
            istop2 = iamdpi(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                im2 = jamdpi(i1)
                prodrc = prodrc * (fmdpi(i1)/                 &
                        (fmdpi(i1)+phim(im2)))**ordmdpi(i1)
                prodrcinc = prodrcinc * (fmdpi(i1)/           &
                          (fmdpi(i1)+phim(im2)))**ordmdpi(i1)
                
              end do

            end if

!c  compute total rate for surface controlled reactions
!c  [moles/(L bulk*day)] = [m^2 mineral/L bulk]
!c                          -----------         
!c                       * [moles/(m^2 mineral * day)]
!c                                 -----------
!c  and sum up parallel reaction rates for surface controlled
!c  dissolution/precipitation reactions (incremented - not incremented)

            ratem = ratem - aream * (prodrcinc - prodrc)

          end do       !loop over parallel diss/prec reactions

        end if         !reaction_type(im)

!c  compute difference of total dissolution/precipitation rate 
!c  for transport controlled dissolution/precipitation reactions
!c  (incremented - not incremented)

      elseif (rate_control(im).eq.'transport') then

        if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
           reaction_type(im).eq.'reversible'.or.                       &
           (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
            r1-satm_omp(im).gt.r0)) then

!c  compute difference of total dissolution rate 
!c  (incremented - not incremented)
 
          istart = iamd(im)
          iend = iamd(im+1)-1

          do ireac = istart,iend
 
!c  scale reaction rate, if dissolution reaction is limited by
!c  equilibrium conditions

            if (far_from_equil(im)) then
              prodrc = r1
              prodrcinc = r1
            else
              prodrc = r1-satm_omp(im)
              prodrcinc = r1-satminc
            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc_omp(ic)**orddt(i1)
            end do
 
!c  form product of reacting free species for current dissolution
!c  reaction, activity coefficients are here not considered explicitely,
!c  but are by definition included in the effective diffusion coefficient
!c  (free species and incremented free species)
 
            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1
            do i1 = istart2,istop2
              ic = jamdc(i1)
              prodrc = prodrc * c(ic)**orddc(i1)
              prodrcinc = prodrcinc * cinc_omp(ic)**orddc(i1)
            end do
 
!c  include complexed species in product of reacting species for current
!c  dissolution reaction
!c  (complexed species and incremented complexed species)
 
            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1
            do i1 = istart2,istop2
              ix = jamdcx(i1)
              prodrc = prodrc * cx(ix)**orddcx(i1)
              prodrcinc = prodrcinc * cxinc_omp(ix)**orddcx(i1)
            end do
 
!c  compute difference of total rate 
!c  [moles/(l bulk*day)] = [m mineral / m^3 bulk]
!c                          ---------   --- 
!c                       * [m^3 h2o/m^3 mineral * m^2 mineral/day]
!c                          --- --- -----------   ----------- 
!c                       * [moles/l h2o]
!c                                  ---
!c  and sum up difference of total dissolution rate 
!c  [moles/(l h2o)] (incremented - not incremented)

            ratem = ratem - aream * diffm(ireac)/xnud(ireac)  &
                         * (prodrcinc - prodrc)

          end do  

!c  do not allow precipitation 

        else            !reaction_type(im)

          ratem = r0
 
        end if          !reaction_type(im)

      end if            !rate_control(im)

!c  divide by increment of numerical differentiation
!c  and obtain derivative of total rate

      ratem = ratem/drtinc
 
      return
   end subroutine 
                        
                        
!c  ----------------------------------------------------------------------
!c  subroutine dtotdyvisc_omp
!c  -------------------
!c 
!c  compute derivatives of total aqueous component dynamic viscosity based 
!c  on concentrations of free species and secondary aqueous species
!c 
!c  written by:      Pejman Rasouli - February 24, 2010
!c 
!c  last modified:   
!c 
!c  definition of variables:
!c 
!c  I --> on input   * arbitrary  - initialized  + entries expected
!c  O --> on output  * arbitrary  - unaltered    + altered
!c                                                                     I O
!c  passed:   real*8:
!c            -------
!c            c(nc)              = concentrations of free species      + -
!c                                 - new time level [moles/l water]
!c            cx(nx)             = concentrations of secondary         + -
!c                                 aqueous species
!c                                 - new time level [moles/l water]
!c            drtinc             = increment for numerical             + -
!c                                 differentiation
!c 
!c            integer*4:
!c            ----------
!c            jbl                = pointer to column of block matrix   + -
!c 
!c  chem.f:   real*8:
!c            -------
!c            cxinc(nx)          = secondary aqueous species           + -
!c                                 concentrations dependent on
!c                                 incremented free species
!c                                 concentrations
!c                                 [moles/l water]
!c            dtotc(n)           = derivatives of total aqueous        * +
!c                                 component concentrations
!c                                 [moles/l water]
!c            xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                 for formation of secondary aqueous
!c                                 species from free species
!c 
!c            integer*4:
!c            ----------
!c            iax(nx+1)          = row pointer array to                + -
!c                                 stoichiometric coefficients of
!c                                 free species in
!c                                 secondary aqueous species
!c            jax(nx*nc)         = column pointer array to             + -
!c                                 stoichiometric coefficients of
!c                                 free species in secondary aqueous
!c                                 species
!c            nc                 = number of components                + -
!c            nx                 = number of secondary aqueous         + -
!c                                 species
!c 
!c 
!c  local:    integer*4:
!c            ----------
!c            i                   = counter (stoichiometric
!c                                  coefficients)
!c            ibl                 = counter (components)
!c            ibl2                = counter (components)
!c            istart              = pointer (stoichiometric 
!c                                  coefficients)
!c            istop               = pointer (stoichiometric
!c                                  coefficients)
!c            ix                  = counter (secondary species) 
!c 
!c  external: -
!c  ----------------------------------------------------------------------
  
      subroutine dtotdyvisc_omp(cd,cdx,diff_cof_ic,diff_cof_ix,drtinc, &
                               dtotviscnew_omp,cinc_omp, cxinc_omp)
     
      use parm
      use chem
      use gen
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: dtotviscnew_omp(:)
      real(type_r8), allocatable :: cinc_omp(:)
      real(type_r8), allocatable :: cxinc_omp(:)
      
      real*8 cd(nc),cdx(nx),diff_cof_ic(nc),diff_cof_ix(nx) 

 
!c   contributions from free species 
 
      do ibl=1,nc-1
      
        dtotviscnew_omp(ibl) = diff_cof_ic(ibl)*(cinc_omp(ibl) - cd(ibl))
        
      end do
 
!c   sum up contributions from aqueous complexes
 
      do ix=1,nx
        istart = iax(ix)
        istop = iax(ix+1)-1
        do i = istart,istop
          ibl = jax(i)

!c   skip h2o, since not a primary unknown
 
          if (namec(ibl).ne.'h2o') then
          
            dtotviscnew_omp(ibl) = dtotviscnew_omp(ibl)             &
     &                 + diff_cof_ix(ix)*(xnux(i)*(cxinc_omp(ix)-cdx(ix)))
          
          end if
        end do
      end do
 
!c   form derivative -> divide by increment for numerical
!c   differentiation
 
      do ibl=1,nc-1
      
        dtotviscnew_omp(ibl) = dtotviscnew_omp(ibl)/drtinc
        
      end do
 
!cdbg
      info_debug = 0
      if (info_debug.gt.0) then 
       do ic=1,nc-1     
           write(idbg,'(a,i4,a,e10.3,/)')		&
     &          'dtotvisc(',ic,') = ',dtotviscnew_omp(ic)   
       end do
           write(idbg,'(a,e10.3,/)')			&
     &          'time = ',time         
!       write(idbg,*) 'wrote to dbg from elecmigration.f'
       end if 
!cdbg
 
      return
  end subroutine
                               
!
!c  -----------------------------------------------------------------------
!c  subroutine delcmigfunc_omp
!c  -------------------
!c 
!c  compute the electric potential for aqueous component electrostatic  
!c  based on concentrations of free species and secondary aqueous species
!c 
!c  written by:      Pejman Rasouli - June 03, 2010
!c 
!c  last modified:   Pejman Rasouli - February 07, 2010
!c                   Electromigration term is computeted here
!c                   and the transport equation converted to
!c                   Nersnst-Planck equation 
!c                     
!c 
!c  definition of variables:
!c 
!c  I --> on input   * arbitrary  - initialized  + entries expected
!c  O --> on output  * arbitrary  - unaltered    + altered
!c                                                                     I O
!c  passed:   real*8:
!c            -------
!c            !c (nc)              = concentrations of free species      + -
!c                                 [moles/l water]
!c            cx(nx)             = concentrations of secondary aqueous + -
!c                                 species [moles/l water]
!c            totc(nc-1)         = total aqueous component             + -
!c                                 concentrations [moles/l water]
!c 
!c  common:
!c  chem.f:   real*8:
!c            -------
!c            xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                 for formation of secondary aqueous
!c                                 species from free species
!c 
!c            integer*4:
!c            ----------
!c            iax(nx+1)          = row pointer array to                + -
!c                                 stoichiometric coefficients of
!c                                 free species in
!c                                 secondary aqueous species
!c            jax(nx*nc)         = column pointer array to             + -
!c                                 stoichiometric coefficients of
!c                                 free species in secondary aqueous
!c                                 species
!c            nc                 = number of components including h2o  + -
!c            nx                 = number of secondary aqueous species + -
!c 
!c  local:    integer*4:
!c            ----------
!c            i                  = counter (stoichiometric
!c                                 coefficients)
!c            ic                 = counter (components)
!c            ix                 = counter (secondary aqueous species) 
!c            istart             = pointer (stoichiometric 
!c                                 coefficients)
!c            iend               = pointer (stoichiometric
!c                                 coefficients)
!c 
!c  external: -
!c  ----------------------------------------------------------------------
  
      subroutine delcmigfunc_omp(elecmignew,elecmignew_pert,drtinc, &
                                delecmigrationnew_omp)      
     
      use parm
      use chem
      use gen
 
      implicit real*8 (a-h,o-z)
      real(type_r8), allocatable :: delecmigrationnew_omp(:)
      
      real*8 elecmignew(nc),elecmignew_pert(nc),drtinc
             
      do ibl=1,nc-1
      
         delecmigrationnew_omp(ibl) = (elecmignew_pert(ibl)  &
     &                           - elecmignew(ibl))/drtinc
        
      end do

      return
      end subroutine                                
      
End Module m_jacobi_omp