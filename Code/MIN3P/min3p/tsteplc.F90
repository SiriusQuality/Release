!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/tsteplc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine tsteplc
!c ------------------
!c
!c estimate magnitude of next time step (local chemistry)
!c based on maximum pH change
!c
!c written by:      Uli Mayer - December 2, 96
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   ulc
!c
!c common:
!c chem.f:   real*8:
!c           ------- 
!c           delt_lc(nthreads)  = time step                           + +
!c                                (local chemistry)
!c           delt_max_lc        = maximum time step (local chemitsry) + -
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components excluding h2o  + -
!c                                equals number of unknowns per
!c                                control volume
!c
!c local:    real*8:
!c           -------
!c           delt_old           = magnitude of previous time step
!c           delta_ph           = pH change during previous time 
!c                                step
!c           delt_min_lc        = minimum time step             
!c           ph_star_lc         = anticipated pH change per
!c                                time step
!c           rhalf              = constant 
!c           r3half             = constant
!c
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine tsteplc(cnew,cold,ulc)

      use parm
      use chem
#ifdef OPENMP
      use omp_lib 
#endif 

      implicit none
      
      integer :: tid

      real*8 :: cnew, cold, ulc
      
      dimension cnew(*),cold(*),ulc(*)

      real*8, parameter :: rhalf = 0.5d0, r3half = 1.5d0  
      
      real*8 :: ph_star_lc, delt_min_lc, delta_ph, delt_old
      
      integer :: ic
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

!c  hardwired - should pass value through

      ph_star_lc = 3.0d0 
      delt_min_lc = 1.d-20
      delta_ph = 0.0d0

!c  calculate pH change 

      do ic=1,nc-1
        if (namec(ic).eq.'h+1') then
          delta_ph = dabs(dlog10(cnew(ic))-dlog10(cold(ic)))
        end if
      end do
          
!c  new time step estimate for local chemistry based on
!c  pH change from previous time step

      delt_old = delt_lc(tid)
      delt_lc(tid) = ph_star_lc/delta_ph*delt_old    !first estimate
      delt_lc(tid) = dmin1(delt_lc(tid), r3half*delt_old) !upper bound - max. increase
      delt_lc(tid) = dmin1(delt_lc(tid), delt_max_lc)     !upper bound - max. time step
      delt_lc(tid) = dmax1(delt_lc(tid), rhalf*delt_old)  !lower bound - max. decrease
      delt_lc(tid) = dmax1(delt_lc(tid), delt_min_lc)     !lower bound - min. time step
      

      return
      end
