!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/soilparm.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine soilparm
!c -------------------
!c
!c compute soil hydraulic parameters (variably saturated flow)
!c
!c written by:      Uli Mayer - May 28, 96
!c
!c last modified:   Uli Mayer - November 25, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           relperm(nn)        = relative permeability               * +
!c           sanew(nn)          = aqueous phase saturation            * +
!c                                - new time level
!c
!c           integer*4:
!c           ---------- 
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           nn                 = total number of control volumes     + -
!c
!c common: 
!c bbls.f:      logical
!c           --------
!c             gas_bubbles        =.true. -> gas phase saturation       + -
!c                                        is calculated
!c                                         below the water table
!c           bubble_perm        = .true. -> update permeability due 
!c                                         to change in gas 
!c                                         saturation
!c phys.f:   real*8:
!c           -------
!c           swr(nzn)           = residual saturation                 + -
!c           aentry(nzn)        = air entry pressure                  + -
!c           spalpha(nzn)       = soil hydraulic function parameter   + -
!c           spbeta(nzn)        = soil hydraulic function parameter   + -
!c           spgamma(nzn)       = soil hydraulic function parameter   + -
!c           expn(nzn)          = krw - p equation exponent           + -
!c
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c           izn                = counter (zones)
!c
!c external: satfpres  = compute saturations from pressure
!c           relpfsat  = compute relative permeability from saturation
!c ----------------------------------------------------------------------
 
      subroutine soilparm(uvsnew,sanew,relperm,relpermg,sonew,mpropvs, &
                          nn)
 
      use parm
      use phys
      use bbls
#ifdef OPENMP      
      use gen, only : rank, b_enable_output, uvsold, saold,            &
                      uvsold, saold, nngl,                             &
                      numofloops_thred_soilparm_1,                     &
                      numofloops_thred_global,                         &
                      numofthreads_global 
#else
      use gen, only : rank, b_enable_output, uvsold, saold, nngl
#endif

#ifdef OPENMP
      use omp_lib 
#endif 

      implicit none

      real*8 :: relpfsat,relpfsat_g, satfpres, satfpres_app
      external relpfsat,relpfsat_g, satfpres, satfpres_app

      integer :: nn
      real*8 :: uvsnew, sanew, relperm, relpermg, par_land,            &
                sgr_eff, sa_eff_old, sonew, sanew_corr
      integer :: mpropvs
      dimension uvsnew(*),sanew(*),relperm(*),relpermg(*),mpropvs(*),  &
                sonew(*)

      real*8, parameter :: r0 = 0.0d0,r1 = 1.0d0,relperm_min = 1.0d-03
      
      integer :: ivol, izn 

!c  compute soil hydraulic parameters 
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_soilparm_1)                       &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol, izn, par_land, sa_eff_old, sgr_eff,          &
    !$omp sanew_corr)                                              
    !$omp do schedule(static)
#endif 
      do ivol=1,nngl
        izn = mpropvs(ivol)                   !material property zone
        if (uvsnew(ivol).lt.aentry(izn)) then
!c_trap    
          if (trap_bubbles) then
            if (unsaturated(ivol)) then         !if node was previously unsaturated
              if(drainage(ivol).and.main_drain(ivol)) then  ! if on main drainage curve
                sa_app(ivol) = satfpres_app(aentry(izn),uvsnew(ivol),  &
                               spalpha(izn),spbeta(izn),spgamma(izn))
                sa_eff(ivol) = sa_app(ivol)
                sanew(ivol) = sa_eff(ivol)*(r1-swr(izn))+swr(izn)
!c correct aqueous saturation when oil is present
                if (oil_saturation) then
	              sanew_corr = sanew(ivol) * ( r1 - sonew(ivol) )
		        else
	              sanew_corr = sanew(ivol)
                endif
                
                relperm(ivol) = relpfsat(sanew_corr,swr(izn),          &
                                         expn(izn), spgamma(izn))

              else               ! if imbibition or on scanning drainage curve
                sa_app(ivol) = satfpres_app(aentry(izn),uvsnew(ivol),  &
                               spalpha(izn),spbeta(izn),spgamma(izn))
                par_land = (r1-swr(izn))/sgr_imbi(izn)-r1
                if (sa_app(ivol).gt.sa_min(ivol)) then
                  sgt(ivol) = ((r1-sa_min(ivol))/                      &
                                (r1+par_land*(r1-sa_min(ivol))))-        &
                     ((r1-sa_app(ivol))/(r1+par_land*(r1-sa_app(ivol))))
    !if(sgt(ivol).lt.r0)then
    !write (*,*) "sgt problem #1", ivol, sgt(ivol)
    !end if
                else
                  sgt(ivol)=r0
                end if
                sa_eff(ivol) = sa_app(ivol)-sgt(ivol)
                sa_eff_old = (saold(ivol)-swr(izn))/(r1-swr(izn))

!c_trap determine sa_eff and sgt if gas saturation is greater than maximum (sgr)

                if (big_bubble(ivol)) then            
                  if (drainage(ivol)) then           ! if drainage on scanning curve
                    if (sa_eff(ivol).gt.sa_eff_old) then
                      sa_eff(ivol) = sa_eff_old
                      sgt(ivol) = sa_app(ivol)-sa_eff(ivol)
                      if(sgt(ivol).lt.r0)then
                        if(rank == 0 .and. b_enable_output) then  
                          write (*,*) "sgt problem #2", ivol, sgt(ivol)
                        end if
                      end if
                    else
                      big_bubble(ivol) = .false.
                    end if
                  else                                 ! if imbibition
                    if (sgt_old(ivol).gt.sgt(ivol)) then
                     sgt(ivol) = sgt_old(ivol)
                     if(sgt(ivol).lt.r0)then
                       if(rank == 0 .and. b_enable_output) then  
                         write (*,*) "sgt problem #3", ivol, sgt(ivol)
                       end if
                     end if
                     sa_eff(ivol) = sa_app(ivol)-sgt(ivol) 
                    end if
                  end if
                end if                                 !big_bubble
                sanew(ivol) = sa_eff(ivol)*(r1-swr(izn))+swr(izn)
!c correct aqueous saturation when oil is present
                if (oil_saturation) then
	              sanew_corr = sanew(ivol) * ( r1 - sonew(ivol) )
		        else
	              sanew_corr = sanew(ivol)
                endif
                
                relperm(ivol) = relpfsat(sanew_corr,swr(izn),          &
                                         expn(izn),spgamma(izn))
              end if                                     ! if drainage           
            else if(.not.solvegb(ivol)) then           !if node was saturated in previous timestep and gasbub has not been called during this time step
              sg_eff(ivol)=(r1-saold(ivol))/(r1-swr(izn))
              sgr_eff = sgr_imbi(izn)/(r1-swr(izn))
              if (sg_eff(ivol).le.sgr_eff) then !if bubble size is less than maximum trapped bubble size
                par_land = (r1-swr(izn))/sgr_imbi(izn)-r1
                sa_min(ivol)= (sg_eff(ivol)+sg_eff(ivol)*par_land-r1)/ &
                              (sg_eff(ivol)*par_land-r1)
                sa_app(ivol) = satfpres_app(aentry(izn),uvsold(ivol),  &
                               spalpha(izn),spbeta(izn),spgamma(izn))
                sgt(ivol) = ((r1-sa_min(ivol))/                        &
                              (r1+par_land*(r1-sa_min(ivol))))-        &
                    ((r1-sa_app(ivol))/(r1+par_land*(r1-sa_app(ivol))))
                
                if(sgt(ivol).lt.r0)then
                  if (rank == 0 .and. b_enable_output) then  
                    write (*,*) 'sgt problem #4', ivol, sgt(ivol)
                  end if
                end if

                sa_eff(ivol) = sa_app(ivol)-sgt(ivol)
                sanew(ivol) = sa_eff(ivol)*(r1-swr(izn))+swr(izn)
!c correct aqueous saturation when oil is present
                if (oil_saturation) then
	              sanew_corr = sanew(ivol) * ( r1 - sonew(ivol) )
		        else
	              sanew_corr = sanew(ivol)
	            endif
                
                relperm(ivol) = relpfsat(sanew_corr,swr(izn),          &
                                         expn(izn),spgamma(izn))
                big_bubble(ivol) = .false.
              else                               !if bubble size is greater than maximum trapped bubble size
                sa_min(ivol)= r0
                sa_app(ivol) = satfpres_app(aentry(izn),uvsnew(ivol),  &
                               spalpha(izn),spbeta(izn),spgamma(izn))
                par_land = (r1-swr(izn))/sgr_imbi(izn)-r1
                sgt(ivol) = ((r1-sa_min(ivol))/                        &
                              (r1+par_land*(r1-sa_min(ivol))))-        &
                     ((r1-sa_app(ivol))/(r1+par_land*(r1-sa_app(ivol))))
                
                if(sgt(ivol).lt.r0)then
                  if (rank == 0 .and. b_enable_output) then
                    write (*,*) "sgt problem #5", ivol, sgt(ivol)
                  end if
                end if

                sa_eff(ivol) = sa_app(ivol)-sgt(ivol)
                sa_eff_old = (saold(ivol)-swr(izn))/(r1-swr(izn))
                if (sa_eff(ivol).gt.sa_eff_old) then
                  sa_eff(ivol)= sa_eff_old
                  sgt(ivol) = sa_app(ivol)-sa_eff(ivol)
                  if(sgt(ivol).lt.r0)then
                    if (rank == 0 .and. b_enable_output) then  
                      write (*,*) "sgt problem #6", ivol, sgt(ivol)
                    end if
                  end if
                end if
                sanew(ivol) = sa_eff(ivol)*(r1-swr(izn))+swr(izn)
!c correct aqueous saturation when oil is present
                if (oil_saturation) then
	              sanew_corr = sanew(ivol) * ( r1 - sonew(ivol) )
		        else
	              sanew_corr = sanew(ivol)
                endif
                
                relperm(ivol) = relpfsat(sanew_corr,swr(izn),          &
                                         expn(izn),spgamma(izn))
                big_bubble(ivol)=.true.
              end if
            end if                                ! node previously saturated
          else                                      ! if not trapped bubbles
            
            sanew(ivol) = satfpres(swr(izn),aentry(izn),uvsnew(ivol),  &
                                 spalpha(izn),spbeta(izn),spgamma(izn))
            
!c correct aqueous saturation when oil is present
            if (oil_saturation) then
	          sanew_corr = sanew(ivol) * ( r1 - sonew(ivol) )
		    else
	          sanew_corr = sanew(ivol)
	        endif

            relperm(ivol) = relpfsat(sanew_corr,swr(izn),expn(izn),    &
                                     spgamma(izn))
				     
          end if            ! if not trapped bubbles
	  			     
!c correct aqueous saturation when oil is present
          if (oil_saturation) then
	        sanew_corr = sanew(ivol) * ( r1 - sonew(ivol) )
		  else
	        sanew_corr = sanew(ivol)
	      endif
          relpermg(ivol)= relpfsat_g(sanew_corr,swr(izn),expn(izn),   &
                                     spgamma(izn))	  			     
				     
        else                ! if saturated
          if (trap_bubbles.and.unsaturated(ivol)) then ! if this is the first time step that the node is saturated
            sa_app(ivol) = r1
            par_land = (r1-swr(izn))/sgr_imbi(izn)-r1
            sgt(ivol) = ((r1-sa_min(ivol))/                            &
                          (r1+par_land*(r1-sa_min(ivol))))-            &
               ((r1-sa_app(ivol))/(r1+par_land*(r1-sa_app(ivol))))
            
            if(sgt(ivol).lt.r0)then
              if(rank == 0 .and. b_enable_output) then  
                write (*,*) "sgt problem #7", ivol, sgt(ivol)
              end if
            end if

            sa_eff(ivol) = sa_app(ivol)-sgt(ivol)
            if (big_bubble(ivol)) then            
              if (sgt_old(ivol).gt.sgt(ivol)) then
                sgt(ivol) = sgt_old(ivol)
                sa_eff(ivol) = sa_app(ivol)-sgt(ivol) 
              end if
            end if
            sanew(ivol) = sa_eff(ivol)*(r1-swr(izn))+swr(izn)
          end if
!c_bubbles
          if (gas_bubbles.and.bubble_perm) then
!c correct aqueous saturation when oil is present
            if (oil_saturation) then
	          sanew_corr = sanew(ivol) * ( r1 - sonew(ivol) )
		    else
	          sanew_corr = sanew(ivol)
            endif
            
            relperm(ivol) = relpfsat(sanew_corr,swr(izn),expn(izn),    &
                                     spgamma(izn))
            relperm(ivol) = dmax1(relperm(ivol),relperm_min)
            
            relpermg(ivol)= relpfsat_g(sanew_corr,swr(izn),expn(izn),  &
                                       spgamma(izn))
	      else if (gas_bubbles.and.(.not.bubble_perm)) then
	          relperm(ivol) = r1
              relpermg(ivol) = r0
          else            
            sanew(ivol) = r1
            relperm(ivol) = r1
            relpermg(ivol) = r0
          end if
          
        end if
      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

!cdbg  activate for purposes of debugging
!c
!c     write(igen,'(4x,3a12)') 'uvsnew      ',
!c    &                        'sanew       ',
!c    &                        'relperm     '
!c     do ivol=1,nngl
!c       write(igen,'(3(e10.4,2x))') uvsnew(ivol),
!c    &                              sanew(ivol),
!c    &                              relperm(ivol)
!c     end do
!c     stop
!cdbg
      return
      end
