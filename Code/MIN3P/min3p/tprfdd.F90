!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 488 $
!> $Author: cblitz $
!> $Date: 2017-07-17 18:22:05 +0200 (Mon, 17 Jul 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/tprfdd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine tprfdd
!c -----------------
!c
!c write transient data for variably saturated flow simulation to output
!c file
!c
!c modified for density dependent flow
!c
!c written by:      Uli Mayer - July 27, 01
!c
!c last modified:   Tom Henderson - Fenbruary 9, 2004
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c
!c passed:   integer*4:
!c           ----------
!c           ivol               = pointer to current control volume   + -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           cvol(nn)           = nodal volumes                       + -
!c           pornew(nn)         = porosity (new time level)           + -
!c           sgnew(nn)          = gaseous phase saturation            + - 
!c                                - new time level
!c           sanew(nn)          = aqueous phase saturation            + - 
!c                                - new time level
!c           time_io            = current solution time (I/O units)   + -
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           igbp               = unit number, flow variables,        + -
!c                                transient data
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           mtime              = current time step                   + -
!c           nn                 = number of control volumes           + -
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           root_uptake        = .true.  -> compute root water       + -
!c                                           uptake 
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c
!c dens.f:   real*8:
!c           -------
!c           density(nn)        = fluid density                       + - 
!c           pressure(nn)       = fluid pressure                      + - 
!c
!c local:    real*8:
!c           ------- 
!c           fhead              = freshwater head 
!c           ioutdebug          = output toggle
!c           phead              = pressure head
!c           qroot              = root water uptake for current
!c                                control volume
!c           theta_a            = aqueous phase content         
!c           theta_g            = gas phase content         
!c           r1                 = constant
!c
!c external: rootwat   = compute rate of root water uptake
!c --------------------------------------------------------------------------

      subroutine tprfdd(ivol,igb,ngb_tstep)
 
      use parm
      use gen
      use phys
      use dens
      use chem 
      use module_binary_mpiio, only : binary_write_data

      implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif
      
      integer :: ivol, igb, ngb_tstep
      
      integer :: izn, ioutdebug
      
      real*8 :: theta_a, theta_g, rootwat, phead, fhead, actw,  &
                dummy, dummy2, dummy3, dummy4, pv  !CBF , qroot

      external rootwat

      real*8, parameter :: r1 = 1.0d0
      
      integer :: nvarsigbp
#ifdef MPI
      integer(kind=MPI_OFFSET_KIND) :: offset
#else
      integer*8 :: offset
#endif

!c  logical variable for output format
!c  0 = identical format to non-density dependent flow

      ioutdebug = 1
      qroot=0.0d0

!c     write(*,'(/a)') 'enter routine tprfvs ...'

      theta_a = pornew(ivol)*sanew(ivol)

!c  compute root uptake rate

      !CBF  if (root_uptake) then
      !CBF    qroot = cvol(ivol) * rootwat(sanew(ivol),mpropvs(ivol))
      !CBF end if

!c  calculate pressure and freshwater heads
      phead = uvsnew(ivol)/(density(ivol) * gacc)
      fhead = phead * density(ivol)/ref_dens + zg(ivol)

!c debugging output for comparison to standard test files

!c  use same output fomat as non-density dependent flow simulations
!c  to compare results

      if (ioutdebug .eq. 0) then  !tprfvs format - no fluid pressures

        if (fully_saturated) then

          if (b_output_binary) then
            nvarsigbp = 5 
            realbuffer_gb(1:nvarsigbp)= (/time_io,fhead, uvsnew(ivol), &
                                   sanew(ivol),theta_a/)
          else
            write(igbp,'(5e15.7)') time_io,fhead, uvsnew(ivol),        &
                                   sanew(ivol),theta_a
          end if
                                                                       
        elseif (variably_saturated) then
                                                                       
          sgnew(ivol) = r1 - sanew(ivol) - snnew(ivol)                 
          theta_g = pornew(ivol)*sgnew(ivol)   
          if (b_output_binary) then
            nvarsigbp = 8 
            realbuffer_gb(1:nvarsigbp)= (/time_io,fhead,uvsnew(ivol),  &
                                      sanew(ivol),theta_a,             &
                                      sgnew(ivol), theta_g, qroot/)  
          else
            write(igbp,'(8e15.7)') time_io,fhead,uvsnew(ivol),         &
                                      sanew(ivol),theta_a,             &
                                      sgnew(ivol), theta_g, qroot
          end if                                                             
        end if
        
        if(b_output_binary) then
          call binary_write_data(igbp_mpi(igb), 1,             &
                       (/ngb_tstep/),offset_igbp_ijk(igb),.true.)
          call binary_write_data(igbp_mpi(igb), nvarsigbp,     &
                       realbuffer_gb,offset_igbp(igb),.true.)

          offset_igbp = offset_igbp + nvarsigbp*nfloatbit

        end if
      end if 
                                                                       
      if (ioutdebug .eq. 1) then                                       
        if (fully_saturated) then
          if (b_output_binary) then
            nvarsigbp = 7 
            realbuffer_gb(1:nvarsigbp)= (/time_io,fhead, uvsnew(ivol), &
                                   phead,density(ivol),                &
                                   sanew(ivol),theta_a/)
          else
            write(igbp,'(7e15.7)') time_io,fhead, uvsnew(ivol),        &
                                   phead,density(ivol),                &
                                   sanew(ivol),theta_a
          end if                                                             
        elseif (variably_saturated) then
                                                                       
          sgnew(ivol) = r1 - sanew(ivol) - snnew(ivol)                 
          theta_g = pornew(ivol)*sgnew(ivol)                           
          if (evaporation) then                                        
            izn = mpropvs(ivol)                                       
            if (reactive_transport) then                              
             actw=gamma(nc,ivol)                                      
            else                                                      
             actw=r1                                                  
            end if                                                    
            call vapor_prop (dummy,pv,dummy2,dummy3,dummy4,            &
                             tempnew(ivol),aentry(izn),uvsnew(ivol),   &
                             actw,density(ivol),ivol)                  
                                                                       
            if (b_output_binary) then                                  
              nvarsigbp = 14 
              realbuffer_gb(1:nvarsigbp)= (/time_io,fhead,uvsnew(ivol),&
                                phead, density(ivol),                  &
                                sanew(ivol),theta_a,sgnew(ivol),       &
                                theta_g,qroot,tempnew(ivol),           &
                                densvnew(ivol),actw,pv/)                                                       
            else                                                       
              write(igbp,'(14e15.7)') time_io,fhead,uvsnew(ivol),      &
                                phead, density(ivol),                  &
                                sanew(ivol),theta_a,sgnew(ivol),       &
                                theta_g,qroot,tempnew(ivol),           &
                                densvnew(ivol),actw,pv  
            end if
          else 
            if (b_output_binary) then
              nvarsigbp = 10 
              realbuffer_gb(1:nvarsigbp)= (/time_io,fhead,uvsnew(ivol),&
                                 phead, density(ivol),                 &
                                 sanew(ivol),theta_a,sgnew(ivol),      &
                                 theta_g, Qroot/) 
            else
              write(igbp,'(10e15.7)') time_io,fhead,uvsnew(ivol),      &
                                 phead, density(ivol),                 &
                                 sanew(ivol),theta_a,sgnew(ivol),      &
                                 theta_g, qroot
            end if
         end if 
        end if
        
        if (b_output_binary) then
          call binary_write_data(igbp_mpi(igb), 1,             &
                       (/ngb_tstep/),offset_igbp_ijk(igb),.true.)
          call binary_write_data(igbp_mpi(igb), nvarsigbp,     &
                       realbuffer_gb,offset_igbp(igb),.true.) 

          offset_igbp(igb) = offset_igbp(igb) + nvarsigbp*nfloatbit

        end if
      end if

      return
      end
