!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/tprfrtlc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine tprfrtlc
!c -------------------
!c write transient data to output file for postprocessing
!c (reactive transport or local chemistry)
!c
!c
!c written by:      Uli Mayer - February 17, 96
!c
!c last modified:   Uli Mayer - February 1, 98
!c                  Uli Mayer - November 12, 01
!c                  added new database format
!c                  for dissolution-precipitation reactions
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + -
!c                                [moles/l water]
!c           cx(nx)             = concentrations of secondary aqueous + +
!c                                species [moles/l water]
!c           cm(nm)             = concentrations of minerals          + -
!c                                [moles/l bulk]
!c           deltat             = time step                           + -
!c           g(ng)              = gas concentrations [moles/l air]    + -
!c           gammac(nc)         = activity coefficients of free       * *
!c                                species
!c           gammax(nx)         = activity coefficients of aqueous    * *
!c                                complexes
!c           cec_l              = cation exchange capacity (meq/100g) + -
!c                                - local system
!c           distcoff(nc)       = sorption distribution coefficient   + -
!c                                [-], [l bulk/l bulk] 
!c           phim(nm)           = volume fractions of minerals        + -
!c           phimold(nm)        = volume fractions of minerals        + -
!c                                (old time level)
!c           porvol             = porosity                            + -
!c           strion             = ionic strength                      + +
!c           sw                 = saturation (aqueous phase)          + -
!c           time               = current solution time               + -
!c           totc(n)            = total aqueous component             + -
!c                                concentrations [moles/l water]
!c           tempkel            = temperature [deg K]                 + -
!c           hhead              = hydraulic head                      + -
!c           zg                 = elevation head                      + -
!c
!c           integer*4:
!c           ----------
!c           iunit1             = unit number, total aqueous          + -
!c                                             component 
!c                                             concentrations
!c                                             transient data
!c           iunit2             = unit number, species concentrations + -
!c                                             transient data
!c           iunit3             = unit number, master variables       + -
!c                                             transient data
!c           iunit4             = unit number, partial gas pressures  + -
!c                                             transient data
!c           iunit11            = unit number, degassing rates        + -
!c                                             transient data
!c           iunit5             = unit number, oxidation-reduction    + -
!c                                             rates, transient 
!c                                             data
!c           iunit6             = unit number, concentrations of      + -
!c                                             sorbed species     
!c           iunit7             = unit number, mineral saturation     + -
!c                                             indices, transient 
!c                                             data
!c           iunit8             = unit number, mineral volume         + -
!c                                             fractions, transient
!c                                             data
!c           iunit9             = unit number, dissolution-           + -
!c                                             precipitation rates
!c                                             transient data
!c           iunit10            = unit number, saturation indices     + -
!c                                             (excluded minerals)
!c                                             transient data
!c           iunit12            = unit number, Isotope data           + -
!c           ivolume            = number of control volume considered + -
!c                                ( = 0, for batch problem)
!c           l_prfx             = length of prefix of I/O files       + -
!c           l_zone_name        = length of zone name                 + -
!c           ntstp              = current time step                   + -
!c
!c           logical:    
!c           --------
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           zone_name          = zone name                           + -
!c
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           alkfacc(nc)        = alkalinity factors for components   + -
!c                                as species in solution
!c           alkfacx(nx)        = alkalinity factors for aqueous      + -
!c                                complexes
!c           conc_mol_avg(nthreads)
!c                              = average molar concentration of      + *
!c                                organic mixture
!c           csb(nsb)           = concentrations of sorbed species    * *
!c                                - new time level
!c           csb_ion(nsb_ion,nthreads)   
!c                              = concentrations of sorbed species    * *
!c                                - new time level
!c                                (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    * *
!c                                - new time level
!c                                (surface-complex)
!c           densm(nm)          = densities of minerals               + -
!c           eqm(nm,nthreads)   = equilibrium constants for minerals  + -
!c           eqmx(nmx,nthreads) = equilibrium constants for excluded  + -
!c                                minerals
!c           eqsb(nsb)          = equilibrium constants for           + -
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for           + -
!c                                sorbed species (ion-exchange)
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for           + -
!c                                sorbed species (surface-complex)
!c           gfwm(nm)           = gram formula weight of minerals     + -
!c           phimin(nm)         = volume fractions of minerals for    + -
!c                                nucleation
!c           phimin_out(nm)     = cutoff mineral volume fractions     + -
!c                                for output
!c           phi_out(nm)        = mineral volume fractions for output * *
!c           rateaq(naq,nthreads)
!c                              = reaction rates of intra-aqueous     * *
!c                                kinetic reaction
!c           rateg(ng,nthreads) = degassing rates                     * a
!c           rateor(nr,tid)     = oxidation-reduction rate for        * * 
!c                                redox couple [moles/(l h2o*day)
!c           rgasatm            = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           satm(nm,nthreads)  = IAP/K                               * +
!c           satm_log(nm)       = saturation indices                  * +
!c           satmx(nmx)         = saturation indices for excluded     * +
!c                                minerals
!c           tconv              = temperature correction factor       + -
!c           totan(nc,nthreads) = total sorbed component              * *
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk)
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c           xnumx(nmx*nc)      = stoichiometric coefficients of      + -
!c                                components in excluded mineral
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components
!c           xnusb_ion(nsb_ion*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)= stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components (surface-complex)
!c           
!c           integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamp(nm+1)         = pointer array for distribution      + -
!c                                and combination of mineralogical
!c                                parameters
!c           iamx(nmx+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in excluded mineral
!c           iasb(nsb+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamx(nmx*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in excluded mineral
!c           jasb(nsb*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to            + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to          + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           l_nameanc(nc)      = length of names of sorbed           + -
!c                                components (non-competitive
!c                                sorption
!c           l_nameaq(naq)      = length of names of intra-aqueous    + -
!c                                kinetic reactions
!c           l_namec(nc)        = length of component names           + -
!c           l_nameg(ng)        = length of names of gases            + -
!c           l_namem(nm)        = length of mineral names             + -
!c           l_namemp(ndr*nm)   = length of names of parallel         + -
!c                                dissolution-precipitation reactions
!c           l_namemx(nmx)      = length of names of excluded         + -
!c                                minerals
!c           l_namer(nr)        = length of names of redox couples    + -
!c           l_namesb_ion(nsb)  = length of names of sorbed           + -
!c                                species (ion-exchange)
!c           l_namesb_surf(nsb) = length of names of sorbed           + -
!c                                species (surface-complex)
!c           l_namesb(nsb)      = length of names of sorbed           + -
!c                                species
!c           l_namex(nx)        = length of names of secondary        + -
!c                                aqueous species
!c           nanc               = number of sorbed species            + -
!c                                non-competitive sorption
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           logical:
!c           --------
!c           compute_alkalinity = .true.  -> calculate alkalinity     + -
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c           gas_removal        = .true.  -> degassing of dissolved   + -
!c                                           gases, if confining
!c                                           pressure exceeded
!c           new_database       = .true.  -> use new database format  + -
!c           noncompetitive_sorption = logical array for activation   + -  
!c                                     of noncompetitive sorption
!c                                     reactions
!c           ph_output          = .true.  -> output of pH             + -
!c           ph_sweep           = .true.  -> sweep over specified     + -
!c                                           pH-range
!c           pe_output          = .true.  -> output of pe and Eh      + -
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c           update_porosity    = .true.  -> update porosity as       + -
!c                                           a result of dissolution-
!c                                           precipitation reactions
!c
!c           character:
!c           ----------
!c           isotherm_type(nc)  = definition of sorption isotherm     + -   
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           nameanc(nc)        = names of sorbed species             + -
!c                                (non-competitive sorption)
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namem(nm)          = mineral names                       + -
!c           namemx(nm)         = names of excluded minerals          + -
!c           namer(nr)          = names of redox couples              + -
!c           namesb(nsb)        = names of sorbed species             + -
!c           namesb_ion(nsb_ion)= names of sorbed species             + -
!c                                (ion-exchange)
!c           namesb_surf(nsb_surf)= names of sorbed species           + -
!c                                  (surface-complex)
!c           namex(nx)          = names of secondary aqueous species  + -
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c           sorption_type      = 'gaines-thomas'                     + -
!c                                'gapon'
!c
!c local:    real*8:
!c           -------
!c           alk_carb           = carbonate alkalinity [eq/L]
!c           alk_noncarb        = noncarbonate alkalinity [eq/L]
!c           alk_tot            = total alkalinity [eq/L]
!c           alk_carb_mg        = carbonate alkalinity [mg/L CaCO3]
!c           alk_noncarb_mg     = non-carbonate alkalinity
!c                                [mg/L CaCO3]
!c           alk_tot_mg         = total alkalinity [mg/L CaCO3]
!c           conc_mol           = molar concentration of organic
!c                                compound in organic mixture
!c           eh                 = Eh
!c           frac_mol           = mole fraction of organic compound
!c                                in organic mixture
!c           pe                 = pe
!c           ph                 = pH
!c           por_out            = porosity for output
!c           pres_tot           = total gas pressure [atm]
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           ianc               = counter (non-competitive sorption
!c                                         reactions)
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           ic                 = counter (components)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imx                = counter (excluded minerals)
!c           isb                = counter (sorbed species)
!c           isites             = counter (surface sites)
!c           ir                 = counter (redox couples)
!c           ix                 = counter (secondary species)
!c           l_indep_var        = length of independent variable
!c                                for output
!c           nxout              = number of secondary species for 
!c                                output
!c           character:
!c           ----------
!c           indep_var          = independent variable for output
!c
!c external: alkcalc   = compute alkalinity
!c           comptotc  = compress concentration vector, if number
!c                       of unknowns is reduced due to redox
!c                       equilibrium reactions
!c           modrate   = modify reaction rate
!c           molconc   = compute average molar concentration for
!c                       organic mixture
!c           phpe      = compute pH, pe and Eh
!c           rategas   = compute degassing rates
!c           rateint   = compute rate for intra-aqueous kinetic
!c                       reactions
!c           rateint_new   = compute rate for intra-aqueous kinetic
!c                       reactions (new database format)
!c           ratemin   = compute absolute dissolution-precipitation
!c                       rates of minerals
!c           ratemin_new = compute absolute dissolution-precipitation
!c                       rates of minerals (new database format)
!c           rateredx  = compute oxidation/reduction rates for
!c                       redox couples
!c           satindex  = compute saturation index
!c           sorbspc   = compute sorbed species concentration
!c           totconc   = total aqueous component concentration
!c           updtsvap  = update secondary variables in aqueous phase
!c ----------------------------------------------------------------------

      subroutine tprfrtlc(totc,c,cx,gammac,gammax,cm,g,cec_l,distcoff,&
                          aream,phim,phimold,strion,tempkel,hhead,zg, &
                          time,deltat,sw,porvol,iunit1,iunit2,iunit3, &
                          iunit4,iunit11,iunit5,iunit6,iunit7,iunit8, &
                          iunit9,iunit10,iunit12,                     &
                          offset1,offset2,offset3,offset4,offset11,   &
                          offset5,offset6,offset7,offset8,offset9,    &
                          offset10,offset12,                          &
                          offset1_ijk,offset2_ijk,offset3_ijk,        &
                          offset4_ijk,offset11_ijk,offset5_ijk,       &
                          offset6_ijk,offset7_ijk,offset8_ijk,        &
                          offset9_ijk,offset10_ijk,offset12_ijk,      & 
                          prefix,l_prfx,tec_header,                   &
                          ivolume,ntstp,ngb_tstep,zone_name,          &
                          l_zone_name,update_porosity)
 
      use parm
      use chem
      use dens
      use bbls
      use writeversion
#ifdef PETSC
      use gen, only : ilog, b_writeversion_tecplot, node_idx_lg2g,     &
                      b_output_binary, realbuffer_gb,                  &
                      b_output_multizone,nfloatbit,idbg
#else
      use gen, only : ilog, b_writeversion_tecplot, b_output_binary,   &
                      realbuffer_gb,b_output_multizone,nfloatbit,      &
                      Petsc_Comm_World,Petsc_Comm_Self,idbg
#endif
#ifdef OPENMP
      use omp_lib 
#endif

      use module_binary_mpiio, only :  tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data
      
      implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif
      
      integer :: tid,iaq,ianc,ierr,i,i1,i2,i3,ii,ic,ic1,ic2,           &
                 icur,icount,ig,im,imi,imx,ir,ireac,isb,isites,        &
                 istart,istop,istart2,istop2,iunit1,iunit2,            &
                 iunit3,iunit4,iunit5,iunit6,iunit7,iunit8,iunit9,     &
                 iunit10,iunit11,iunit12,ivolume,ix,next,nxout,        &
                 l_indep_var,l_prfx,l_zone_name,ntstp,ngb_tstep  
      
      real*8 :: c, cx, gammac, gammax, strion, totc, time,             &
                zbal, zpos, zneg, ph, pe, eh, tempkel, alk_carb,       &
                alk_noncarb, alk_tot, alk_carb_mg, alk_noncarb_mg,     &
                alk_tot_mg, pres_tot, g, hhead, zg, phim, distcoff,    &
                sw, porvol, dummy, cec_l, phimold, satindex, conc_mol, &
                frac_mol, por_out, ratem, aream, cm, deltat, gammatemp,&
                tottemp

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
 
      external alkcalc, comptotc,  phpe,                      &
     &         rateredx, satindex, sorbspc, totconc
                                                                       
      character*72 prefix, indep_var                                   
      character*72 zone_name
                                                                       
      logical tec_header,update_porosity
                                                                       
      dimension totc(*),c(*),cx(*),cm(*),g(*),distcoff(*),gammac(*),   &
     &          gammax(*),aream(*),phim(*),phimold(*)
      
      character*72, allocatable :: nametemp(:)
      integer (type_i4), allocatable :: l_nametemp(:)
      real*8, allocatable :: valuetemp(:)
      
      integer*4 :: nvars
      character*72, allocatable :: tec_variables(:)
      character*2048 :: strbuffer
      
#ifdef MPI
      integer(kind=MPI_OFFSET_KIND) ::                                 &
                   offset1,offset2,offset3,offset4,offset5,offset6,    &
                   offset7,offset8,offset9,offset10,offset11,offset12, &
                   offset1_ijk,offset2_ijk,offset3_ijk,                &
                   offset4_ijk,offset5_ijk,offset6_ijk,                &
                   offset7_ijk,offset8_ijk,offset9_ijk,                &
                   offset10_ijk,offset11_ijk,offset12_ijk
#else
      integer*8 ::                                                     &
                   offset1,offset2,offset3,offset4,offset5,offset6,    &
                   offset7,offset8,offset9,offset10,offset11,offset12, &
                   offset1_ijk,offset2_ijk,offset3_ijk,                &
                   offset4_ijk,offset5_ijk,offset6_ijk,                &
                   offset7_ijk,offset8_ijk,offset9_ijk,                &
                   offset10_ijk,offset11_ijk,offset12_ijk
#endif
     
      !For the shared-memory parallel version, the variables defined in the module
      !are shared variables by different threads. So as to avoid race condition, 
      !these variable should be passed by dummy arguments. Danyang Su, 2013-05.
      interface
      
        !>interface of molconc
        subroutine molconc(phim)
          use parm, only : type_r8
          real(type_r8), dimension(*) :: phim
        end subroutine molconc
        
        !>interface of rategas
        subroutine rategas(g,tkel,hhead,zg,sg_loc)
          use parm, only : type_r8
          real(type_r8), dimension(*) :: g
          real(type_r8) :: tkel
          real(type_r8) :: hhead
          real(type_r8) :: zg       
          real(type_r8) :: sg_loc
        end subroutine rategas
        
        !>interface of rategasd
        subroutine rategasd(g,tkel,phead,sg_loc)
          use parm, only : type_r8
          real(type_r8), dimension(*) :: g
          real(type_r8) :: tkel
          real(type_r8) :: phead    
          real(type_r8) :: sg_loc
        end subroutine rategasd
        
        !>interface of rateint
        subroutine rateint(rate,totc,c,gammac,phim,iaq,scalfacaq)
          use parm, only : type_i4, type_r8
          real(type_r8) :: rate
          real(type_r8), dimension(*) :: totc
          real(type_r8), dimension(*) :: c
          real(type_r8), dimension(*) :: gammac
          real(type_r8), dimension(*) :: phim
          integer(type_i4) :: iaq   
          real(type_r8) :: scalfacaq
        end subroutine rateint
        
        !>interface of rateint_new
        subroutine rateint_new(rate,totc,c,cx,gammac,gammax,phim,iaq,  &
                               scalfacaq)
          use parm, only : type_i4, type_r8     
          real(type_r8) :: rate
          real(type_r8), dimension(*) :: totc
          real(type_r8), dimension(*) :: c
          real(type_r8), dimension(*) :: cx
          real(type_r8), dimension(*) :: gammac
          real(type_r8), dimension(*) :: gammax
          real(type_r8), dimension(*) :: phim
          integer(type_i4) :: iaq
          real(type_r8) :: scalfacaq
        end subroutine rateint_new
                               
        !> interface of ratemin
        subroutine ratemin(totc,c,cx,gammac,gammax,ratem,phim,    &
                           phimold,aream,im) 
          use parm, only: type_i4, type_r8
          real(type_r8), dimension(*) :: totc
          real(type_r8), dimension(*) :: c
          real(type_r8), dimension(*) :: cx
          real(type_r8), dimension(*) :: gammac
          real(type_r8), dimension(*) :: gammax
          real(type_r8) :: ratem
          real(type_r8) :: phim 
          real(type_r8) :: phimold
          real(type_r8) :: aream
          integer(type_i4) :: im
        end subroutine ratemin  
                           
        !> interface of ratemin_new
        subroutine ratemin_new(totc,c,cx,gammac,gammax,ratem,phim,    &
                               phimold,aream,im) 
          use parm, only: type_i4, type_r8
          real(type_r8), dimension(*) :: totc
          real(type_r8), dimension(*) :: c
          real(type_r8), dimension(*) :: cx
          real(type_r8), dimension(*) :: gammac
          real(type_r8), dimension(*) :: gammax
          real(type_r8) :: ratem
          real(type_r8), dimension(*) :: phim 
          real(type_r8) :: phimold
          real(type_r8) :: aream
          integer(type_i4) :: im
        end subroutine ratemin_new
                               
        !>interface of updtsvap
        subroutine updtsvap (c,cx,gammac,gammax,strion)
          use parm, only : type_r8
          real(type_r8), dimension(*) :: c
          real(type_r8), dimension(*) :: cx
          real(type_r8), dimension(*) :: gammac
          real(type_r8), dimension(*) :: gammax
          real(type_r8) :: strion
        end subroutine updtsvap                           
        
        !>interface of modrate
        subroutine modrate(ratem,cmnewm,delt,im)
          use parm, only : type_i4, type_r8
          real(type_r8) :: ratem
          real(type_r8) :: cmnewm
          real(type_r8) :: delt
          integer(type_i4) :: im
        end subroutine modrate
        
       
      end interface
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
 
!cprovi----------------------------------------- 
!cprovi was initialized 
!cprovi Sergio Andres Bea
!cprovi 02/02/2009
!cprovi-----------------------------------------
      istart=1
      istop=1
      
      allocate (nametemp(nip*8), stat = ierr)
      nametemp = ""
      call checkerr(ierr,'nametemp',ilog)

      allocate (l_nametemp(nip*8), stat = ierr)
      l_nametemp = 0
      call checkerr(ierr,'l_nametemp',ilog)

      allocate (valuetemp(nip*8), stat = ierr)
      valuetemp = 0.0d0
      call checkerr(ierr,'valuetemp',ilog)
      
!cprovi-----------------------------------------
!c  output for maximum 120 species concentrations

!cmx        nxout = min(100-nc-1,nx)       !max. 100 species for output  
!cmx         100 is not enough for the example waybrant (isotope)

      nxout = min(1000-nc-1,nx)       !max. 120 species (nc+nx-1) for output

!c  define independent variable for output

      if(ph_sweep) then
        indep_var = 'pH'
        l_indep_var = 2
      else
        indep_var = 'time'
        l_indep_var = 4
      end if
  
!c  write out headers
 
!c  total aqueous component concentrations 
 
      if (ntstp.eq.0) then          !(ntstp.eq.0)
 
!c  --------------------------------------------------------------------- 
!c  file header for postprocessing using tecplot
!c  --------------------------------------------------------------------- 

        if (tec_header) then
          
          if (b_output_binary) then
            allocate(tec_variables(1000+nc+nxout))
            tec_variables = ''
          end if

!c  total aqueous component concentrations
!c ----------------------------------------------------------------------

!c  file header
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(iunit1, "#")
          end if
        
          if (b_output_binary) then
            offset1 = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                         iunit1, "#!TDV102",'dataset '//               &
                         prefix(:l_prfx),offset1,.true.,.true.) 
            
            nvars = nc
            tec_variables(1) = indep_var(:l_indep_var)
            do ic = 1, nc-1
              tec_variables(ic+1) = namec(ic)(:l_namec(ic))
            end do

            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         iunit1, nvars,tec_variables(1:nvars),         &
                         offset1,.true.,.true.)
          else
            write(iunit1,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(iunit1,'(150a)') 'variables = "',                    &
                                    indep_var(:l_indep_var),'"',       &
                                  (',"',namec(ic)(:l_namec(ic)),       &
                                   '"',ic=1,nc-1)
          end if

!c  zone record

          if (ivolume.eq.0) then
            if (b_output_binary) then  
              strbuffer = 'T_j, '//zone_name(:l_zone_name)
            else
              write(iunit1,'(3a)')                                     &
                    'zone t = "T_j, ',                                 &
                    zone_name(:l_zone_name),'", f=point'  
            end if
          else  
             if (b_output_binary) then
#ifdef PETSC
               write(strbuffer,'(2(a,i10))')                           &
                    'T_j, local volume = ',ivolume,                    &          
                    ', global volume = ', node_idx_lg2g(ivolume)
#else          
               write(strbuffer,'(a,i10)') 'T_j, volume = ',ivolume
#endif
             else
#ifdef PETSC
               write(iunit1,'(a,3(a,i10))')                            &
                    'zone t = "T_j, ',                                 &
                    'local volume = ',ivolume,                         &          
                    ', global volume = ', node_idx_lg2g(ivolume),      &
                    '", f=point'
#else          
               write(iunit1,'(a,2(a,i5))')                             &
                    'zone t = "T_j, ',                                 &
                    'volume = ',ivolume,'", f=point'
#endif         
            end if
          end if
          
          if (b_output_binary) then
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,iunit1, &
                         trim(strbuffer),offset1, 1, 1, 1, .true.,     &
                         .true.,b_output_multizone)
            offset1_ijk = offset1 - 5*4
            call tecplot_binary_write_section(PETSC_COMM_SELF,iunit1,  &
                         nvars,0,offset1,.true.,.true.,                &
                         b_output_multizone) 
          end if
 
!c  species concentrations
!c ----------------------------------------------------------------------
 
!c  file header
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(iunit2, "#")
          end if
          
          if (b_output_binary) then
            offset2 = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                           iunit2, "#!TDV102",'dataset '//             &
                           prefix(:l_prfx),offset2,.true.,.true.)  
  
            nvars = nc + nxout 
            
            tec_variables(1) = indep_var(:l_indep_var)
            do ic=1,nc-1
              tec_variables(ic+1) = namec(ic)(:l_namec(ic))  
            end do
            do ix=1,nxout
              tec_variables(nc+ix) = namex(ix)(:l_namex(ix)) 
            end do
            
            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         iunit2,nvars,tec_variables(1:nvars),          &
                         offset2,.true.,.true.) 
          else
            write(iunit2,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(iunit2,'(600a)') 'variables = "',                    &
                                   indep_var(:l_indep_var),'"',        &
                                  (',"',namec(ic)(:l_namec(ic)),       &
                                  '"',ic=1,nc-1),                      &
                                  (',"',namex(ix)(:l_namex(ix)),       &
                                  '"',ix=1,nxout)
          end if

!c  zone record

          if (ivolume.eq.0) then
            if (b_output_binary) then
              strbuffer = 'C_j, X_i, '//zone_name(:l_zone_name)              
            else
              write(iunit2,'(3a)')                                     &
                    'zone t = "C_j, X_i, ',                            &
                     zone_name(:l_zone_name),'", f=point'
            end if
          else
#ifdef PETSC
            if (b_output_binary) then
              write(strbuffer,'(2(a,i10))')                            &
                    'C_j, X_i, local volume = ', ivolume,              &
                    ', global volume = ', node_idx_lg2g(ivolume)  
            else
              write(iunit2,'(3(a,i10))')                               &
                    'zone t = "C_j, X_i, local volume = ', ivolume,    &
                    ', global volume = ', node_idx_lg2g(ivolume),      &
                    '", f=point'
            end if
#else
            if (b_output_binary) then
              write(strbuffer,'(a,i5)')'C_j, X_i, volume = ',ivolume
            else
              write(iunit2,'(2(a,i5))')                                &
                    'zone t = "C_j, X_i, volume = ',                   &
                     ivolume,'", f=point'
            end if
#endif
          end if
          
          if (b_output_binary) then
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,iunit2, &
                         trim(strbuffer),offset2, 1, 1, 1,.true.,      &
                         .true.,b_output_multizone)
            offset2_ijk = offset2 - 5*4

            call tecplot_binary_write_section(PETSC_COMM_SELF,iunit2,  &
                         nvars,0,offset2,.true.,.true.,                &
                         b_output_multizone)
          end if

!c  master variables
!c ----------------------------------------------------------------------

!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(iunit3, "#")
          end if
          
!c  title and variables  
          if (b_output_binary) then
            offset3 = 0
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                         iunit3, "#!TDV102",'dataset '//               &
                         prefix(:l_prfx),offset3,.true.,.true.) 
          else
            write(iunit3,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          end if
          
          if ((ph_output).and.(pe_output)) then
            if (b_output_binary) then
              nvars = 13
              !Tecplot binary output cannot allow the same variable name
              if (indep_var(:l_indep_var) == 'pH') then
                tec_variables(1) = "pH_"
              else
                tec_variables(1) = indep_var(:l_indep_var)
              end if
              tec_variables(2:13) = [character(len=72) ::              &
                                  "pH","pe","Eh","ionic strength",     &
                                  "C-Alk [eq/L]","NC-Alk [eq/L]",      &
                                  "Alk [eq/L]","C-Alk [mg/L CaCO_3]",  &
                                  "NC-Alk [mg/L CACO_3]",              &
                                  "Alk [mg/L CaCO_3]","temperature",   &
                                  "charge bal [%]"] 
            else
              write(iunit3,'(9a)') 'variables = "',                    &
                                 indep_var(:l_indep_var),'",',         &
                               '"pH","pe","Eh","ionic strength",',     &
                               '"C-Alk [eq/L]","NC-Alk [eq/L]",',      &
                               '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",',  &
                               '"NC-Alk [mg/L CACO_3]",',              &
                               '"Alk [mg/L CaCO_3]",',                 &
                               '"temperature",',                       &
                               '"charge bal [%]"' 
            end if
          elseif ((.not.ph_output).and.(pe_output)) then
            if (b_output_binary) then
              nvars = 12
              tec_variables(1) = indep_var(:l_indep_var)
              tec_variables(2:12) = [character(len=72) ::              &
                                 "pe","Eh","ionic strength",           &
                                 "C-Alk [eq/L]","NC-Alk [eq/L]",       &
                                 "Alk [eq/L]","C-Alk [mg/L CaCO_3]",   &
                                 "NC-Alk [mg/L CACO_3]",               &
                                 "Alk [mg/L CaCO_3]","temperature",    &
                                 "charge bal [%]"] 
            else
              write(iunit3,'(9a)') 'variables = "',                    &
                                    indep_var(:l_indep_var),'",',      &
                                 '"pe","Eh","ionic strength",',        &
                                 '"C-Alk [eq/L]","NC-Alk [eq/L]",',    &
                                 '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",',&
                                 '"NC-Alk [mg/L CACO_3]",',            &
                                 '"Alk [mg/L CaCO_3]",',               &
                                 '"temperature",',                     &
                                 '"charge bal [%]"' 
            end if
          elseif ((ph_output).and.(.not.pe_output)) then
            if (b_output_binary) then
              nvars = 11
              !Tecplot binary output cannot allow the same variable name
              if (indep_var(:l_indep_var) == 'pH') then
                tec_variables(1) = "pH_"
              else
                tec_variables(1) = indep_var(:l_indep_var)
              end if
              tec_variables(2:11) = [character(len=72) ::              &
                                 "pH","ionic strength",                &
                                 "C-Alk [eq/L]","NC-Alk [eq/L]",       &
                                 "Alk [eq/L]","C-Alk [mg/L CaCO_3]",   &
                                 "NC-Alk [mg/L CACO_3]",               &
                                 "Alk [mg/L CaCO_3]","temperature",    &
                                 "charge bal [%]"] 
            else
              write(iunit3,'(9a)') 'variables = "',                    &
                                    indep_var(:l_indep_var),'",',      &
                                 '"pH","ionic strength",',             &
                                 '"C-Alk [eq/L]","NC-Alk [eq/L]",',    &
                                 '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",',&
                                 '"NC-Alk [mg/L CACO_3]",',            &
                                 '"Alk [mg/L CaCO_3]",',               &
                                 '"temperature",',                     &
                                 '"charge bal [%]"'
            end if
          end if
          
          if (b_output_binary) then              
            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         iunit3, nvars, tec_variables(1:nvars),        &
                         offset3, .true., .true.) 
          end if

!c  zone record

          if (ivolume.eq.0) then
            if (b_output_binary) then
              strbuffer = 'Master variables, '//zone_name(:l_zone_name)              
            else
              write(iunit3,'(3a)')                                     &
                    'zone t = "Master variables, ',                    &
                     zone_name(:l_zone_name),'", f=point' 
            end if
          else                       
#ifdef PETSC
            if (b_output_binary) then
              write(strbuffer,'(2(a,i10))')                            &
                 'Master variables, local volume = ',ivolume,          &
                 ', global volume = ', node_idx_lg2g(ivolume) 
            else
              write(iunit3,'(3(a,i10))')                               &
                 'zone t = "Master variables, local volume = ',ivolume,&
                 ', global volume = ', node_idx_lg2g(ivolume),         &
                 '", f=point'
            end if
#else
            if (b_output_binary) then
              write(strbuffer,'(a,i5)') 'Master variables, volume = ', &
                                        ivolume
            else
              write(iunit3,'(2(a,i5))')                                &
                    'zone t = "Master variables, volume = ',           &
                     ivolume,'", f=point'
            end if
#endif
          end if
          
          if (b_output_binary) then
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,iunit3, &
                         trim(strbuffer),offset3, 1, 1, 1, .true.,     &
                         .true.,b_output_multizone)
            offset3_ijk = offset3 - 5*4

            call tecplot_binary_write_section(PETSC_COMM_SELF,iunit3,  &
                         nvars,0,offset3,.true.,.true.,                &
                         b_output_multizone) 
          end if

!c  partial gas pressures
!c ----------------------------------------------------------------------

          if (ng.gt.0) then

!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
                call writeversion2file(iunit4, "#")
            end if
            
!c  file header  
            if (b_output_binary) then
              offset4 = 0
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iunit4, "#!TDV102",'dataset '//             &
                           prefix(:l_prfx),offset4,.true.,.true.)
              
              nvars = 2+ng
              tec_variables(1) = indep_var(:l_indep_var)
              do ig=1,ng
                tec_variables(ig+1) = nameg(ig)(:l_nameg(ig))
              end do
              tec_variables(ng+2) = "p_t_o_t"

              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           iunit4, nvars, tec_variables(1:nvars),      &
                           offset4,.true.,.true.)
            else
              write(iunit4,'(3a)') 'title = "dataset ',                &
                                    prefix(:l_prfx),'"'                 
              write(iunit4,'(1000a)') 'variables = "',                 &
                                      indep_var(:l_indep_var),'"',     &
                                 (',"',nameg(ig)(:l_nameg(ig)),        &
                                 '"',ig=1,ng),', "p_t_o_t"'
            end if

!c  zone record 

            if (ivolume.eq.0) then
              if (b_output_binary) then
                strbuffer = 'G_i, '//zone_name(:l_zone_name)
              else
                write(iunit4,'(3a)') 'zone t = "G_i, ',                &
                                      zone_name(:l_zone_name),         &
                                     '", f=point'      
              end if
            else           
#ifdef PETSC
              if (b_output_binary) then
                write(strbuffer,'(2(a,i10))')                          &
                   'G_i, local volume = ', ivolume,                    &
                   ', global volume = ', node_idx_lg2g(ivolume) 
              else
                write(iunit4,'(3(a,i10))')                             &
                   'zone t = "G_i, local volume = ', ivolume,          &
                   ', global volume = ', node_idx_lg2g(ivolume),       &
                   '", f=point'
              end if
#else
              if (b_output_binary) then
                write(strbuffer,'(2(a,i5))') 'G_i, volume = ', ivolume
              else
                write(iunit4,'(2(a,i5))') 'zone t = "G_i, volume = ',  &
                                           ivolume,'", f=point'
              end if
#endif
            end if
            
            if (b_output_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iunit4,trim(strbuffer),offset4, 1, 1, 1,    &
                           .true.,.true.,b_output_multizone)
              offset4_ijk = offset4 - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,iunit4,&
                           nvars,0,offset4,.true.,.true.,              &
                           b_output_multizone)
            end if

!c  degassing rates
!c ----------------------------------------------------------------------

            if (gas_removal) then

!c  version information
              if (b_writeversion_tecplot.and..not.b_output_binary) then
                  call writeversion2file(iunit1, "#")
              end if
              
!c  file header 
              if (b_output_binary) then
                offset11 = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             iunit11, "#!TDV102",'dataset '//          &
                             prefix(:l_prfx),offset11,.true.,.true.)  
                
                nvars = ng + 1
                tec_variables(1) = indep_var(:l_indep_var)
                do ig=1,ng
                  tec_variables(ig+1) = nameg(ig)(:l_nameg(ig))  
                end do
                
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             iunit11,nvars,tec_variables(1:nvars),     &
                             offset11,.true.,.true.) 
              else
                write(iunit11,'(3a)') 'title = "dataset ',             &
                                      prefix(:l_prfx),'"'               
                write(iunit11,'(1000a)') 'variables = "',              &
                                         indep_var(:l_indep_var),'"',  &
                                    (',"',nameg(ig)(:l_nameg(ig)),     &
                                    '"',ig=1,ng)
              end if

!c  zone record

              if (ivolume.eq.0) then
                if (b_output_binary) then
                  strbuffer =  'R_i^g, '//zone_name(:l_zone_name)
                else
                  write(iunit11,'(3a)') 'zone t = "R_i^g, ',           &
                                         zone_name(:l_zone_name),      &
                                        '", f=point'
                end if
              else
#ifdef PETSC    
                if (b_output_binary) then
                  write(strbuffer,'(3(a,i10))')                        &
                     'R_i^g, local volume = ', ivolume,                &
                     ', global volume = ', node_idx_lg2g(ivolume)
                else
                  write(iunit11,'(3(a,i10))')                          &
                     'zone t = "R_i^g, local volume = ', ivolume,      &
                     ', global volume = ', node_idx_lg2g(ivolume),     &
                     '", f=point'
                end if
#else
                if (b_output_binary) then
                  write(strbuffer,'(2(a,i5))')                         &
                     'R_i^g, volume = ', ivolume
                else
                  write(iunit11,'(2(a,i5))')                           &
                     'zone t = "R_i^g, volume = ', ivolume,'", f=point'
                end if
#endif
              end if
              
              if (b_output_binary) then
               call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,     &
                            iunit11,trim(strbuffer),offset11, 1, 1, 1, &
                            .true.,.true.,b_output_multizone)
               offset11_ijk = offset11 - 5*4
               
               call tecplot_binary_write_section(PETSC_COMM_SELF,      &
                            iunit11,nvars,0,offset11,.true.,.true.,    &
                            b_output_multizone) 
              end if
            end if

          end if                  !(ng.gt.0)

!c  oxidation-reduction rates
!c ----------------------------------------------------------------------

          if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) then
            
!c  version information
            if (b_writeversion_tecplot.and..not.b_output_binary) then
                call writeversion2file(iunit5, "#")
            end if
            
!c  file header 
            if (b_output_binary) then
              offset5 = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iunit5, "#!TDV102",'dataset '//             &
                           prefix(:l_prfx),offset5,.true.,.true.)  
  
              nvars = nr + 1
              tec_variables(1) = indep_var(:l_indep_var)
              do ir = 1, nr
                tec_variables(ir+1) = namer(ir)(:l_namer(ir))
              end do

              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           iunit5,nvars,tec_variables(1:nvars),        &
                           offset5,.true.,.true.) 
            else
              write(iunit5,'(3a)') 'title = "dataset ',                &
                                    prefix(:l_prfx),'"'                 
              write(iunit5,'(1000a)') 'variables = "',                 &
                                      indep_var(:l_indep_var),'"',     &
                                 (',"',namer(ir)(:l_namer(ir)),'"',    &
                                  ir=1,nr)
            end if
                                                                      
!c  zone record
                                                                       
            if (ivolume.eq.0) then 
              if (b_output_binary) then
                strbuffer = 'hom. reaction rates, '//                  &
                            zone_name(:l_zone_name) 
              else
                write(iunit5,'(3a)')                                   &
                      'zone t = "hom. reaction rates, ',               &
                       zone_name(:l_zone_name),'", f=point' 
              end if
            else    
#ifdef PETSC
              if (b_output_binary) then
                write(strbuffer,'(2(a,i10))')                          &
                  'hom. reaction rates, local volume = ',ivolume,      &
                  ', global volume = ',node_idx_lg2g(ivolume)
              else
                write(iunit5,'(3(a,i10))')                             &
                  'zone t = "hom. reaction rates, local volume = ',    &
                  ivolume,', global volume = ',node_idx_lg2g(ivolume), &
                  '", f=point'
              end if
#else
              if (b_output_binary) then
                write(strbuffer,'(a,i5)')                              &
                      'hom. reaction rates, volume = ', ivolume 
              else
                write(iunit5,'(2(a,i5))')                              &
                      'zone t = "hom. reaction rates, volume = ',      &
                       ivolume,'", f=point'
              end if
#endif
            end if
            
            if (b_output_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iunit5,trim(strbuffer),offset5, 1, 1, 1,    &
                           .true.,.true.,b_output_multizone)
              offset5_ijk = offset5 - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,iunit5,&
                           nvars,0,offset5,.true.,.true.,              &
                           b_output_multizone) 
            end if

          end if              !((nr.gt.0)....)

!c  rates of intra-aqueous kinetic reactions 
!c ----------------------------------------------------------------------

          if (naq.gt.0) then

!c  version information
            if (b_writeversion_tecplot.and..not.b_output_binary) then
                call writeversion2file(iunit5, "#")
            end if
            
!c  file header 
            if (b_output_binary) then
              offset5 = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iunit5, "#!TDV102",'dataset '//             &
                           prefix(:l_prfx),offset5,.true.,.true.)  
              
              nvars = naq + 1
              tec_variables(1) = indep_var(:l_indep_var)
              do iaq=1,naq
                tec_variables(iaq+1) = nameaq(iaq)(:l_nameaq(iaq))  
              end do

              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           iunit5, nvars, tec_variables(1:nvars),      &
                           offset5, .true., .true.) 
            else
              write(iunit5,'(3a)') 'title = "dataset ',                &
                                    prefix(:l_prfx),'"'                 
              write(iunit5,'(1000a)') 'variables = "',                 &
                                      indep_var(:l_indep_var),'"',     &
                                   (',"',nameaq(iaq)(:l_nameaq(iaq)),  &
                                   '"',iaq=1,naq)
            end if
                                                                       
                                                                      
!c  zone record
                                                                       
            if (ivolume.eq.0) then 
              if (b_output_binary) then
                strbuffer =  'intra-aqueous reactions, ' //            &
                             zone_name(:l_zone_name) 
              else
                write(iunit5,'(3a)')                                   &
                      'zone t = "intra-aqueous reactions, ',           &
                       zone_name(:l_zone_name),'", f=point' 
              end if
            else  
#ifdef PETSC
              if (b_output_binary) then
                write(strbuffer,'(3(a,i10))')                          &
                  'intra-aqueous reactions, local volume = ',          &
                  ivolume,', global volume = ', node_idx_lg2g(ivolume)
              else
                write(iunit5,'(3(a,i10))')                             &
                  'zone t = "intra-aqueous reactions, local volume = ',&
                  ivolume,', global volume = ', node_idx_lg2g(ivolume),&
                  '", f=point'
              end if
#else
              if (b_output_binary) then
                write(strbuffer,'(a,i5)')                              &
                      'intra-aqueous reactions, volume = ',ivolume
              else
                write(iunit5,'(2(a,i5))')                              &
                      'zone t = "intra-aqueous reactions, volume = ',  &
                       ivolume,'", f=point'
              end if
#endif
            end if
            
            if (b_output_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iunit5,trim(strbuffer),offset5, 1, 1, 1,    &
                           .true.,.true.,b_output_multizone)
              offset5_ijk = offset5 - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,iunit5,&
                           nvars,0,offset5,.true.,.true.,              &
                           b_output_multizone)
            end if

          end if              !(naq.gt.0....)

!c  concentrations of sorbed species
!c ----------------------------------------------------------------------

          if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.noncompetitive_sorption) then

!c  version information
            if (b_writeversion_tecplot.and..not.b_output_binary) then
                call writeversion2file(iunit6, "#")
            end if
            
!c  file header 
            if (b_output_binary) then
              offset6 = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iunit6, "#!TDV102",'dataset '//             &
                           prefix(:l_prfx),offset6,.true.,.true.)  
  
              nvars = nanc+nsites+nsb_ion+nsb_surf+1
              
              tec_variables(1) = indep_var(:l_indep_var)
              do ianc=1,nanc
                tec_variables(ianc+1) = nameanc(ianc)(:l_nameanc(ianc))  
              end do
              do isites=1,nsites
                tec_variables(nanc+isites+1) =                         &
                    namec(iaic(isites))(:l_namec(iaic(isites)))
              end do
              do isb=1,nsb_ion
                tec_variables(nanc+nsites+isb+1) =                     &
                    namesb_ion(isb)(:l_namesb_ion(isb))
              end do
              do isb=1,nsb_surf
                tec_variables(nanc+nsites+nsb_ion+isb+1) =             &
                    namesb_surf(isb)(:l_namesb_surf(isb))
              end do
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           iunit6, nvars, tec_variables(1:nvars),      &
                           offset6,.true.,.true.)
            else
              write(iunit6,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'                                   
              write(iunit6,'(1000a)') 'variables = "',                 &
                           indep_var(:l_indep_var),'"',                &
                           (',"',nameanc(ianc)                         &
                           (:l_nameanc(ianc)),                         &
                           '"',ianc=1,nanc),                           &
                           (',"',namec(iaic(isites))                   &
                           (:l_namec(iaic(isites))),                   &
                           '"',isites=1,nsites),                       &
                           (',"',namesb_ion(isb)(:l_namesb_ion(isb)),  &
                           '"',isb=1,nsb_ion),                         &
                           (',"',namesb_surf(isb)(:l_namesb_surf(isb)),&
                           '"',isb=1,nsb_surf)
            end if
                                                                      
!c  zone record
                                                                       
            if (ivolume.eq.0) then 
              if (b_output_binary) then
                strbuffer = 'S_i, ' // zone_name(:l_zone_name) 
              else
                write(iunit6,'(3a)')                                   &
                      'zone t = "S_i, ',                               &
                       zone_name(:l_zone_name),'", f=point' 
              end if
            else      
#ifdef PETSC
              if (b_output_binary) then
                write(strbuffer,'(2(a,i10))')                          &
                      'S_i, local volume = ', ivolume,                 &
                      ', global volume = ', node_idx_lg2g(ivolume)
              else
                write(iunit6,'(3(a,i10))')                             &
                      'zone t = "S_i, local volume = ', ivolume,       &
                      ', global volume = ', node_idx_lg2g(ivolume),    &
                      '", f=point'
              end if
#else
              if (b_output_binary) then
                write(strbuffer,'(2(a,i5))')'S_i, volume = ',ivolume
              else
                write(iunit6,'(2(a,i5))')                              &
                      'zone t = "S_i, volume = ',ivolume,'", f=point'
              end if
#endif
            end if
            
            if (b_output_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iunit6,trim(strbuffer),offset6, 1, 1, 1,    &
                           .true.,.true.,b_output_multizone)
              offset6_ijk = offset6 - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,iunit6,&
                           nvars,0,offset6,.true.,.true.,              &
                           b_output_multizone)
            end if

          end if

!c  mineral saturation indices
!c ----------------------------------------------------------------------

          if (nm.gt.0) then

!c  version information
            if (b_writeversion_tecplot.and..not.b_output_binary) then
                call writeversion2file(iunit7, "#")
            end if
            
!c  file header
            if (b_output_binary) then
              offset7 = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iunit7, "#!TDV102",'dataset '//             &
                           prefix(:l_prfx),offset7,.true.,.true.)  
  
              nvars = nm+1
              tec_variables(1) = indep_var(:l_indep_var)
              do im=1,nm
                tec_variables(im+1) = namem(im)(:l_namem(im))  
              end do

              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           iunit7, nvars, tec_variables(1:nvars),      &
                           offset7, .true., .true.) 
            else
              write(iunit7,'(3a)') 'title = "dataset ',prefix(:l_prfx),&
                                   '"'                                   
              write(iunit7,'(1000a)') 'variables = "',                 &
                                      indep_var(:l_indep_var),'"',     &
                                   (',"',namem(im)(:l_namem(im)),      &
                                   '"',im=1,nm)
            end if
                                                                      
!c  zone record for initial condition
                                                                       
            if (ivolume.eq.0) then 
              if (b_output_binary) then
                strbuffer = 'SI, ' // zone_name(:l_zone_name)
              else
                write(iunit7,'(3a)')                                   &
                      'zone t = "SI, ',                                &
                       zone_name(:l_zone_name),'", f=point'
              end if
            else      
#ifdef PETSC
              if (b_output_binary) then
                write(strbuffer,'(2(a,i10))')                          &
                      'SI, local volume = ',ivolume,                   &
                      ', global volume = ', node_idx_lg2g(ivolume)
              else
                write(iunit7,'(3(a,i10))')                             &
                      'zone t = "SI, local volume = ',ivolume,         &
                      ', global volume = ', node_idx_lg2g(ivolume),    &         
                      '", f=point'
              end if
#else
              if (b_output_binary) then
                write(strbuffer,'(2(a,i5))') 'SI, volume = ',ivolume
              else
                write(iunit7,'(2(a,i5))')                              &
                      'zone t = "SI, volume = ', ivolume,'", f=point'
              end if
#endif
            end if
            
            if (b_output_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iunit7,trim(strbuffer),offset7, 1, 1, 1,    &
                           .true.,.true.,b_output_multizone)
              offset7_ijk = offset7 - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,iunit7,&
                           nvars,0,offset7,.true.,.true.,              &
                           b_output_multizone)
            end if
   
!c  mineral volume fractions
!c ----------------------------------------------------------------------

!c  version information
            if (b_writeversion_tecplot.and..not.b_output_binary) then
                call writeversion2file(iunit8, "#")
            end if

!c  file header
            if (b_output_binary) then
              offset8 = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iunit8, "#!TDV102",'dataset '//             &
                           prefix(:l_prfx),offset8,.true.,.true.)  
  
              nvars = nm+2
              tec_variables(1) = indep_var(:l_indep_var)
              do im=1,nm
                tec_variables(im+1) = namem(im)(:l_namem(im))  
              end do
              tec_variables(nm+2) = 'porosity'

              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           iunit8, nvars,tec_variables(1:nvars),       &
                           offset8,.true.,.true.) 
            else
              write(iunit8,'(3a)') 'title = "dataset ',prefix(:l_prfx),&
                                   '"'                                  
              write(iunit8,'(1000a)') 'variables = "',                 &
                                      indep_var(:l_indep_var),'"',     &
                                   (',"',namem(im)(:l_namem(im)),      &
                                    '"',im=1,nm),',"porosity"'
            end if                                                          
!c  zone record
                                                                       
            if (ivolume.eq.0) then 
              if (b_output_binary) then
                strbuffer = 'phi_i, '//zone_name(:l_zone_name) 
              else
                write(iunit8,'(3a)') 'zone t = "phi_i, ',              &
                                      zone_name(:l_zone_name),         &
                                     '", f=point'  
              end if
            else  
#ifdef PETSC
              if (b_output_binary) then
                write(strbuffer,'(2(a,i10))')                          &
                      'phi_i, local volume = ', ivolume,               &
                      ', global volume = ', node_idx_lg2g(ivolume)
              else
                write(iunit8,'(3(a,i10))')                             &
                      'zone t = "phi_i, local volume = ', ivolume,     &
                      ', global volume = ', node_idx_lg2g(ivolume),    &         
                      '", f=point'
              end if
#else
              if (b_output_binary) then
                write(strbuffer,'(2(a,i5))') 'phi_i, volume = ',ivolume
              else
                write(iunit8,'(2(a,i5))') 'zone t = "phi_i, volume = ',&
                                           ivolume,'", f=point'
              end if
#endif
            end if
            
            if (b_output_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iunit8,trim(strbuffer),offset8, 1, 1, 1,    &
                           .true.,.true.,b_output_multizone)
              offset8_ijk = offset8 - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,iunit8,&
                           nvars,0,offset8,.true.,.true.,              &
                           b_output_multizone)
            end if

!c  mineral dissolution-precipitation rates
!c ----------------------------------------------------------------------

!c  version information
            if (b_writeversion_tecplot.and..not.b_output_binary) then
                call writeversion2file(iunit9, "#")
            end if
            
!c  file header 
            if (b_output_binary) then
              offset9 = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iunit9, "#!TDV102",'dataset '//             &
                           prefix(:l_prfx),offset9,.true.,.true.)  
              
              istart = iamd(1)                                          
              istop = iamd(nm+1)-1 
              nvars = istop-istart+2
              tec_variables(1) = indep_var(:l_indep_var)
              do ireac=istart,istop 
                tec_variables(ireac+1) = namemp(ireac)(:l_namemp(ireac))  
              end do

              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           iunit9,nvars,tec_variables(1:nvars),        &
                           offset9,.true.,.true.) 
            else
              write(iunit9,'(3a)') 'title = "dataset ',prefix(:l_prfx),&
                                   '"'                                  
              istart = iamd(1)                                          
              istop = iamd(nm+1)-1                                      
              write(iunit9,'(1000a)') 'variables = "',                 &
                                      indep_var(:l_indep_var),'"',     &
                                 (',"',namemp(ireac)(:l_namemp(ireac)),&
                                 '"',ireac=istart,istop)
            end if
                                                                      
!c  zone record
                                                                       
            if (ivolume.eq.0) then 
              if (b_output_binary) then
                strbuffer = 'Diss.-prec. rates, '//                    &
                            zone_name(:l_zone_name)  
              else
                write(iunit9,'(3a)')                                   &
                      'zone t = "Diss.-prec. rates, ',                 &
                      zone_name(:l_zone_name),'", f=point'
              end if
            else    
#ifdef PETSC
              if (b_output_binary) then
                write(strbuffer,'(2(a,i10))')                          &
                      'Diss.-prec. rates, volume = ',ivolume,          &
                      ', global volume = ', node_idx_lg2g(ivolume)
              else
                write(iunit9,'(a,2(a,i10),a)')                         &
                      'zone t = "Diss.-prec. rates, ',                 &
                      'volume = ',ivolume, ', global volume = ',       &
                      node_idx_lg2g(ivolume), '", f=point'
              end if
#else
              if (b_output_binary) then
                write(strbuffer,'(a,i5)')                              &
                      'Diss.-prec. rates, volume = ',ivolume
              else
                write(iunit9,'(2a,i5,a)')                              &
                      'zone t = "Diss.-prec. rates, ',                 &
                      'volume = ',ivolume,'", f=point'
              end if
#endif
            end if
            
            if (b_output_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iunit9,trim(strbuffer),offset9, 1, 1, 1,    &
                           .true.,.true.,b_output_multizone)
              offset9_ijk = offset9 - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,iunit9,&
                           nvars,0,offset9,.true.,.true.,              &
                           b_output_multizone) 
            end if

          end if                  !(nm.gt.0)

!c  saturation indices (excluded minerals)
!c ----------------------------------------------------------------------

          if (nmx.gt.0) then

!c  version information
            if (b_writeversion_tecplot.and..not.b_output_binary) then
                call writeversion2file(iunit10, "#")
            end if
            
!c  file header
            if (b_output_binary) then
              offset10 = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iunit10, "#!TDV102",'dataset '//            &
                           prefix(:l_prfx),offset10,.true.,.true.)  
  
              nvars = nmx+1
              tec_variables(1) = indep_var(:l_indep_var)
              do imx=1,nmx
                tec_variables(imx+1) = namemx(imx)(:l_namemx(imx))  
              end do

              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           iunit10, nvars,tec_variables(1:nvars),      &
                           offset10,.true.,.true.)
            else
              write(iunit10,'(3a)') 'title = "dataset ',               &
                                     prefix(:l_prfx),'"'                                   
              write(iunit10,'(1000a)') 'variables = "',                &
                                       indep_var(:l_indep_var),'"',    &
                                 (',"',namemx(imx)(:l_namemx(imx)),'"',&
                                  imx=1,nmx)
            end if
                                                                      
!c  zone record
                                                                       
            if (ivolume.eq.0) then
              if (b_output_binary) then
                strbuffer = 'SI, '//zone_name(:l_zone_name) 
              else
                write(iunit10,'(3a)') 'zone t = "SI, ',                &
                                      zone_name(:l_zone_name),         &
                                     '", f=point'  
              end if
            else      
#ifdef PETSC
              if (b_output_binary) then
                write(strbuffer,'(2(a,i10))')                          &
                     'SI, local volume = ',ivolume,                    &
                     ', global volume = ', node_idx_lg2g(ivolume)
              else
                write(iunit10,'(a,2(a,i10),a)') 'zone t = "SI, ',      &
                      'local volume = ',ivolume, ', global volume = ', &
                      node_idx_lg2g(ivolume),'", f=point'
              end if
#else
              if (b_output_binary) then
                write(strbuffer,'(a,i5)') 'SI, volume = ',ivolume
              else
                write(iunit10,'(2a,i5,a)') 'zone t = "SI, ',           &
                                          'volume = ',ivolume,         &
                                          '", f=point'
              end if
#endif
            end if
            
            if (b_output_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iunit10,trim(strbuffer),offset10, 1, 1, 1,  &
                           .true.,.true.,b_output_multizone)
              offset10_ijk = offset10 - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           iunit10,nvars,0,offset10,.true.,.true.,     &
                           b_output_multizone) 
            end if

          end if                  !(nmx.gt.0) 
          
!c_isotope
!c ----------------------------------------------------------------------

          if (iso_output) then
              
!c  version information
            if (b_writeversion_tecplot.and..not.b_output_binary) then
                call writeversion2file(iunit12, "#")
            end if
            
!c  file header
            i1 = 0
            do i=1,nip
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i2 = istart, istop
                ic2 = jamdisoo(i2)
                i1 = i1 +1
                nametemp(i1) = namec(ic2)
                l_nametemp(i1) = index(nametemp(i1),' ')-1
              end do
              i1 = i1 +1
              ic2 = jamdisoo(istart)
              nametemp(i1) = 'sum_'//namec(ic2)
              l_nametemp(i1) = index(nametemp(i1),' ')-1
              
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i2 = istart+1, istop
                ic2 = jamdisoo(i2)
                i1 = i1 +1 
                nametemp(i1) = 'delta_'//namec(ic2)
                l_nametemp(i1) = index(nametemp(i1),' ')-1
              end do
            end do
            
            nvars = i1 + 1
            
            if (b_output_binary) then
              offset12 = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iunit12, "#!TDV102",'dataset '//            &
                           prefix(:l_prfx),offset12,.true.,.true.)  
  
              tec_variables(1) = indep_var(:l_indep_var)
              do imi=1,i1
                tec_variables(imi+1) = nametemp(imi)(:l_nametemp(imi))
              end do

              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                         iunit12,nvars,tec_variables(1:nvars),         &
                         offset12,.true.,.true.)
            else
              write(iunit12,'(3a)') 'title = "dataset ',               &
                                    prefix(:l_prfx),'"'
              
              write(iunit12,'(1000a)') 'variables = "',                &
                    indep_var(:l_indep_var),'"',                       &
                    (',"',nametemp(imi)(:l_nametemp(imi)),'"',imi=1,i1)
            end if
                                                                        
            if (ivolume.eq.0) then  
              if (b_output_binary) then
                strbuffer = 'SI, '//zone_name(:l_zone_name) 
              else 
                write(iunit12,'(3a)') 'zone t = "Isotopes, ',          &
                                      zone_name(:l_zone_name),         &
                                     '", f=point'    
              end if
            else  
#ifdef PETSC
              if (b_output_binary) then
                write(strbuffer,'(2(a,i10))')                          &
                     'Isotopes, local volume = ',ivolume,              &
                     ', global volume = ', node_idx_lg2g(ivolume)
              else
                write(iunit12,'(a,2(a,i10),a)') 'zone t = "Isotopes, ',&
                      'local volume = ',ivolume, ', global volume = ', &
                      node_idx_lg2g(ivolume),'", f=point'
              end if
#else
              if (b_output_binary) then
                write(strbuffer,'(a,i5)') 'Isotopes, volume = ',ivolume
              else
                write(iunit12,'(2a,i5,a)') 'zone t = "Isotopes, ',     &
                                          'volume = ',ivolume,         &
                                          '", f=point'
              end if
#endif 
            end if
            
            if (b_output_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iunit12,trim(strbuffer),offset12, 1, 1, 1,  &
                           .true.,.true.,b_output_multizone)
              offset12_ijk = offset12 - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           iunit12,nvars,0,offset12,.true.,.true.,     &
                           b_output_multizone) 
            end if
           
          end if
          
          if (b_output_binary) then
            deallocate(tec_variables)
          end if

        else                      !(tec_header)

!c  --------------------------------------------------------------------- 
!c  file header for postprocessing using xmgr - convertible to tecplot
!c  --------------------------------------------------------------------- 

!c  total aqueous component concentrations
!c ----------------------------------------------------------------------

!c  version information
          if (b_writeversion_tecplot ) then
              call writeversion2file(iunit1, "#")
          end if
          
!c  file header          
          write(iunit1,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
          write(iunit1,'(150a)') '# variables = "',                   &
     &                            indep_var(:l_indep_var),'"',        &
     &                          (',"',namec(ic)(:l_namec(ic)),        &
     &                          '"',ic=1,nc-1)
                                                                      
!c  zone record
                                                                       
          if (ivolume.eq.0) then                                       
            write(iunit1,'(3a)')                                      &
     &            '# zone t = "T_j, ',zone_name(:l_zone_name),        &
     &            '", f=point'                                         
          else       
#ifdef PETSC
            write(iunit1,'(2(a,i10),a)')                              &
     &            '# zone t = "T_j, local volume = ',ivolume,         &
     &            ', global volume = ', node_idx_lg2g(ivolume),       &
     &            '", f=point'
#else
            write(iunit1,'(a,i5,a)')                                  &
     &            '# zone t = "T_j, volume = ',ivolume,'", f=point'
#endif
          end if

 
!c  species concentrations
!c ----------------------------------------------------------------------
 
!c  version information
          if (b_writeversion_tecplot ) then
              call writeversion2file(iunit2, "#")
          end if
          
!c  file header          
          write(iunit2,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
          write(iunit2,'(600a)') '# variables = "',                   &
     &                           indep_var(:l_indep_var),'"',         &
     &                          (',"',namec(ic)(:l_namec(ic)),'"',    &
     &                          ic=1,nc-1),                           &
     &                          (',"',namex(ix)(:l_namex(ix)),'"',    &
     &                          ix=1,nxout)
                                                                      
!c  zone record
                                                                       
          if (ivolume.eq.0) then                                       
            write(iunit2,'(3a)')                                      &
     &            '# zone t = "C_j, X_i, ',                           &
     &             zone_name(:l_zone_name),'", f=point'                
          else         
#ifdef PETSC
            write(iunit2,'(3(a,i10))')                                &
     &            '# zone t = "C_j, X_i, local volume = ',ivolume,    &
     &            ', global volume = ', node_idx_lg2g(ivolume),       &
     &            '", f=point'
#else
            write(iunit2,'(2(a,i5))')                                 &
     &            '# zone t = "C_j, X_i, volume = ',                  &
     &             ivolume,'", f=point'
#endif
          end if

!c  master variables
!c ----------------------------------------------------------------------

!c  version information
          if (b_writeversion_tecplot ) then
              call writeversion2file(iunit3, "#")
          end if
          
!c  title and variables          
          write(iunit3,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
          if ((ph_output).and.(pe_output)) then
            write(iunit3,'(9a)') '# variables = "',                   &
     &                            indep_var(:l_indep_var),'",',       &
     &                         '"pH","pe","Eh","ionic strength",',    &
     &                         '"C-Alk [eq/L]","NC-Alk [eq/L]",',     &
     &                         '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",', &
     &                         '"NC-Alk [mg/L CACO_3]",',             &
     &                         '"Alk [mg/L CaCO_3]",',                &
     &                         '"temperature",',                      &
     &                         '"charge bal [%]"'                      
          elseif ((.not.ph_output).and.(pe_output)) then               
            write(iunit3,'(9a)') '# variables = "',                   &
     &                            indep_var(:l_indep_var),'",',       &
     &                         '"pe","Eh","ionic strength",',         &
     &                         '"C-Alk [eq/L]","NC-Alk [eq/L]",',     &
     &                         '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",', &
     &                         '"NC-Alk [mg/L CACO_3]",',             &
     &                         '"Alk [mg/L CaCO_3]",',                &
     &                         '"temperature",',                      &
     &                         '"charge bal [%]"'                      
          elseif ((ph_output).and.(.not.pe_output)) then               
            write(iunit3,'(9a)') '# variables = "',                   &
     &                            indep_var(:l_indep_var),'",',       &
     &                         '"pH","ionic strength", ',             &
     &                         '"C-Alk [eq/L]","NC-Alk [eq/L]",',     &
     &                         '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",', &
     &                         '"NC-Alk [mg/L CACO_3]",',             &
     &                         '"Alk [mg/L CaCO_3]",',                &
     &                         '"temperature",',                      &
     &                         '"charge bal [%]"'
          end if

!c  zone record

          if (ivolume.eq.0) then
            write(iunit3,'(3a)')                                      &
     &            '# zone t = "Master variables, ',                   &
     &             zone_name(:l_zone_name),'", f=point'                
          else                
#ifdef PETSC
            write(iunit3,'(3(a,i10))')                                &
     &            '# zone t = "Master variables, local volume = ',    &
     &            ivolume,', global volume = ', node_idx_lg2g(ivolume),&
     &            '", f=point'
#else
            write(iunit3,'(2(a,i5))')                                 &
     &            '# zone t = "Master variables, volume = ',          &
     &             ivolume,'", f=point'
#endif
          end if

!c  partial gas pressures
!c ----------------------------------------------------------------------

          if (ng.ne.0) then

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(iunit4, "#")
            end if
            
!c  file header          
            write(iunit4,'(3a)') '# title = "dataset ',               &
     &                            prefix(:l_prfx),'"'                  
            write(iunit4,'(1000a)') '# variables = "',                &
     &                              indep_var(:l_indep_var),'"',      &
     &                         (',"',nameg(ig)(:l_nameg(ig)),'"',     &
     &                          ig=1,ng),', "p_t_o_t"'

!c  zone record 
                                                                       
            if (ivolume.eq.0) then                                     
              write(iunit4,'(3a)')                                    &
     &              '# zone t = "G_i, ',                              &
     &               zone_name(:l_zone_name),'", f=point'              
            else 
#ifdef PETSC                
              write(iunit4,'(3(a,i10))')                              &
     &              '# zone t = "G_i, local volume = ', ivolume,      &
     &              ', global volume = ', node_idx_lg2g(ivolume),     &         
     &              '", f=point'
#else
              write(iunit4,'(2(a,i5))')                               &
     &              '# zone t = "G_i, volume = ',                     &
     &               ivolume,'", f=point'
#endif
            end if

!c  degassing rates
!c ----------------------------------------------------------------------

            if (gas_removal) then

!c  version information
              if (b_writeversion_tecplot ) then
                  call writeversion2file(iunit11, "#")
              end if
              
!c  file header          
              write(iunit11,'(3a)') '# title = "dataset ',            &
     &                               prefix(:l_prfx),'"'               
              write(iunit11,'(1000a)') '# variables = "',             &
     &                                 indep_var(:l_indep_var),'"',   &
     &                            (',"',nameg(ig)(:l_nameg(ig)),'"',  &
     &                             ig=1,ng)
                                                                      
!c  zone record
                                                                       
              if (ivolume.eq.0) then                                   
                write(iunit11,'(3a)')                                 &
     &                '# zone t = "R_i^g, ',                          &
     &                 zone_name(:l_zone_name),'", f=point'            
              else   
#ifdef PETSC
                write(iunit11,'(3(a,i10))')                           &
     &                '# zone t = "R_i^g, local volume = ',ivolume,   &
     &                ', global volume = ', node_idx_lg2g(ivolume),   &
     &                '", f=point'
#else
                write(iunit11,'(2(a,i5))')                            &
     &                '# zone t = "R_i^g, volume = ',                 &
     &                 ivolume,'", f=point'
#endif
              end if

            end if                !(gas_removal)

          end if                  !(ng.eq.0)

!c  oxidation-reduction rates
!c ----------------------------------------------------------------------

          if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) then
            
!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(iunit5, "#")
            end if
            
!c  file header          
            write(iunit5,'(3a)') '# title = "dataset ',               &
     &                            prefix(:l_prfx),'"'                  
            write(iunit5,'(1000a)') '# variables = "',                &
     &                              indep_var(:l_indep_var),'"',      &
     &                         (',"',namer(ir)(:l_namer(ir)),         &
     &                          ir=1,nr)
                                                                      
!c  zone record
                                                                       
            if (ivolume.eq.0) then                                     
              write(iunit5,'(3a)')                                    &
     &              '# zone t = "hom. reaction rates, ',              &
     &               zone_name(:l_zone_name),'", f=point'              
            else              
#ifdef PETSC
              write(iunit5,'(3(a,i10))')                              &
     &            '# zone t = "hom. reaction rates, local volume = ', &
     &            ivolume,', global volume = ', node_idx_lg2g(ivolume),&
     &            '", f=point'
#else
              write(iunit5,'(2(a,i5))')                               &
     &              '# zone t = "hom. reaction rates, volume = ',     &
     &               ivolume,'", f=point'
#endif
            end if

          end if              !((nr.gt.0)....)

!c  rates of intra-aqueous kinetic reactions
!c ----------------------------------------------------------------------

          if (naq.gt.0) then

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(iunit5, "#")
            end if
            
!c  file header          
            write(iunit5,'(3a)') '# title = "dataset ',               &
     &                            prefix(:l_prfx),'"'                  
            write(iunit5,'(1000a)') '# variables = "',                &
     &                              indep_var(:l_indep_var),'"',      &
     &                         (',"',nameaq(iaq)(:l_nameaq(iaq)),     &
     &                          iaq=1,naq)
                                                                      
!c  zone record
                                                                       
            if (ivolume.eq.0) then                                     
              write(iunit5,'(3a)')                                     &
     &              '# zone t = "intra-aqueous reactions, ',           &
     &               zone_name(:l_zone_name),'", f=point'              
            else           
#ifdef PETSC
              write(iunit5,'(3(a,i10))')                               &
     &          '# zone t = "intra-aqueous reactions, local volume = ',&
     &          ivolume,', global volume = ', node_idx_lg2g(ivolume),  &
     &          '", f=point'
#else
              write(iunit5,'(2(a,i5))')                                &
     &              '# zone t = "intra-aqueous reactions, volume = ',  &
     &               ivolume,'", f=point'
#endif
            end if

          end if              !(naq.gt.0)

!c  concentrations of sorbed species
!c ----------------------------------------------------------------------

          if (nsb_ion.gt.0.or.nsb_surf.gt.0) then

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(iunit6, "#")
            end if
            
!c  file header          
            write(iunit6,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'                                    
            write(iunit6,'(1000a)') '# variables = "',                           &
                                    indep_var(:l_indep_var),'"',                 &
                                  (',"',nameanc(ianc)                            &
                                  (:l_nameanc(ianc)),                            &
                                  '"',ianc=1,nanc),                              &
                                 (',"',namec(iaic(isites))                       &
                                 (:l_namec(iaic(isites))),'"',                   &
                                  isites=1,nsites),                              &
                                 (',"',namesb_ion(isb)(:l_namesb_ion(isb)),'"',  &
                                  isb=1,nsb_ion),                                &
                                 (',"',namesb_surf(isb)(:l_namesb_surf(isb)),'"',&
                                  isb=1,nsb_surf)
                                                                       
!c  zone record
                                                                        
            if (ivolume.eq.0) then                                      
              write(iunit6,'(3a)')                                     &
     &              '# zone t = "S_i, ',                               &
     &              zone_name(:l_zone_name),'", f=point'                
            else  
#ifdef PETSC
              write(iunit6,'(3(a,i10))')                               &
     &              '# zone t = "S_i, local volume = ', ivolume,       &
     &              ', global volume = ', node_idx_lg2g(ivolume),      &
     &              '", f=point'
#else
              write(iunit6,'(2(a,i5))')                                &
     &              '# zone t = "S_i, volume = ',                      &
     &              ivolume,'", f=point'
#endif
            end if

          end if

!c  mineral saturation indices
!c ----------------------------------------------------------------------

          if (nm.gt.0) then

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(iunit7, "#")
            end if
            
!c  file header          
            write(iunit7,'(3a)') '# title = "dataset ',prefix(:l_prfx),&
     &                           '"'                                    
            write(iunit7,'(1000a)') '# variables = "',                 &
     &                              indep_var(:l_indep_var),'"',       &
     &                           (',"',namem(im)(:l_namem(im)),'"',    &
     &                            im=1,nm)
                                                                       
!c  zone record for initial condition
                                                                        
            if (ivolume.eq.0) then                                      
              write(iunit7,'(3a)')                                     &
     &              '# zone t = "SI, ',                                &
     &              zone_name(:l_zone_name),'", f=point'                
            else           
#ifdef PETSC
              write(iunit7,'(3(a,i10))')                               &
     &              '# zone t = "SI, local volume = ', ivolume,        &
     &              ', global volume = ', node_idx_lg2g(ivolume),      &         
     &              '", f=point'
#else
              write(iunit7,'(2(a,i5))')                                &
     &              '# zone t = "SI, volume = ',                       &
     &              ivolume,'", f=point'
#endif
            end if
   
!c  mineral volume fractions
!c ----------------------------------------------------------------------

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(iunit8, "#")
            end if
            
!c  file header          
            write(iunit8,'(3a)') '# title = "dataset ',prefix(:l_prfx),&
     &                           '"'                                    
            write(iunit8,'(1000a)') '# variables = "',                 &
     &                              indep_var(:l_indep_var),'"',       &
     &                           (',"',namem(im)(:l_namem(im)),'"',    &
     &                            im=1,nm),',"porosity"'
                                                                       
!c  zone record
                                                                        
            if (ivolume.eq.0) then                                      
              write(iunit8,'(3a)')                                     &
     &              '# zone t = "phi_i, ',                             &
     &              zone_name(:l_zone_name),'", f=point'                
            else                
#ifdef PETSC
              write(iunit8,'(3(a,i10))')                               &
     &              '# zone t = "phi_i, local volume = ', ivolume,     &
     &              ', global volume = ', node_idx_lg2g(ivolume),      &         
     &              '", f=point'
#else
              write(iunit8,'(2(a,i5))')                                &
     &              '# zone t = "phi_i, volume = ',                    &
     &              ivolume,'", f=point'
#endif
            end if

!c  mineral dissolution-precipitation rates
!c ----------------------------------------------------------------------

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(iunit9, "#")
            end if
            
!c  file header          
            write(iunit9,'(3a)') '# title = "dataset ',prefix(:l_prfx),&
     &                           '"'                                    
            istart = iamd(1)                                            
            istop = iamd(nm+1)-1                                        
            write(iunit9,'(1000a)') '# variables = "',                 &
     &                              indep_var(:l_indep_var),'"',       &
     &                           (',"',namemp(ireac)(:l_namemp(ireac)),&
     &                            '"',ireac=istart,istop)
                                                                       
!c  zone record
                                                                        
            if (ivolume.eq.0) then                                      
              write(iunit9,'(3a)')                                     &
     &              '# zone t = "Diss.-prec. rates, ',                 &
     &              zone_name(:l_zone_name),'", f=point'                
            else       
#ifdef PETSC
              write(iunit9,'(a,3(a,i10))')                             &
     &              '# zone t = "Diss.-prec. rates, ',                 &
     &              'local volume = ',ivolume,                         &
     &              ', global volume = ', node_idx_lg2g(ivolume),      &
     &              '", f=point'
#else
              write(iunit9,'(a,2(a,i5))')                              &
     &              '# zone t = "Diss.-prec. rates, ',                 &
     &              'volume = ',ivolume,'", f=point'
#endif
            end if

          end if                  !(nm.gt.0)

!c  saturation indices (excluded minerals)
!c ----------------------------------------------------------------------

          if (nmx.gt.0) then

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(iunit10, "#")
            end if
            
!c  file header          
            write(iunit10,'(3a)') '# title = "dataset ',prefix(:l_prfx),&
     &                           '"'                                     
            write(iunit10,'(1000a)') '# variables = "',                 &
     &                               indep_var(:l_indep_var),'"',       &
     &                           (',"',namemx(imx)(:l_namemx(imx)),'"', &
     &                            imx=1,nmx)
                                                                        
!c  zone record
                                                                         
            if (ivolume.eq.0) then                                       
              write(iunit10,'(3a)') '# zone t = "SI, ',                 &
     &                              zone_name(:l_zone_name),            &
     &                             '", f=point'                          
            else                                                         
              write(iunit10,'(2a,i5,a)') '# zone t = "SI, ',            &
     &                                  'volume = ',ivolume,            &
     &                                  '", f=point'
            end if

          end if                  !(nmx.gt.0) 
          
!c  isotope
          if (iso_output) then
              
!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(iunit12, "#")
            end if
            
            i1 = 0
            do i=1,nip
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i2 = istart, istop
                ic2 = jamdisoo(i2)
                i1 = i1 +1
                nametemp(i1) = namec(ic2)
                l_nametemp(i1) = index(nametemp(i1),' ')-1
              end do
              i1 = i1 +1
              ic2 = jamdisoo(istart)
              nametemp(i1) = 'sum_'//namec(ic2)
              l_nametemp(i1) = index(nametemp(i1),' ')-1
              
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i2 = istart+1, istop
                  ic2 = jamdisoo(i2)
                  i1 = i1 +1 
                  nametemp(i1) = 'delta_'//namec(ic2)
                l_nametemp(i1) = index(nametemp(i1),' ')-1
              end do
            end do
            
!c  file header 
            write(iunit12,'(3a)') '# title = "dataset ',               &
                                  prefix(:l_prfx),'"'

            write(iunit12,'(1000a)') '# variables = "',                &
                                     indep_var(:l_indep_var),'"',      &
                             (',"',nametemp(imi)(:l_nametemp(imi)),'"',&
                                  imi=1,i1)
                                                                        
            if (ivolume.eq.0) then                                      
              write(iunit12,'(3a)') '# zone t = "Isotopes, ',          &
                                    zone_name(:l_zone_name),           &
                                   '", f=point'                         
            else                                                        
              write(iunit12,'(2a,i5,a)') '# zone t = "Isotopes, ',     &
                                        'volume = ',ivolume,           &
                                        '", f=point'
            end if
           
          end if

        end if                    !(tec_header)

      end if                      !(ntstp.eq.0)
 
!c  update secondary variables before print-out
 
      call updtsvap(c,cx,gammac,gammax,strion)
 
!c  print out results of current time step

!c  total aqueous component concentrations 
 
      call totconc(c,cx,totc)
 
      if (b_output_binary) then
        nvars = nc
        realbuffer_gb(1:nvars) =  (/time,(totc(ic),ic=1,nc-1)/)
        call binary_write_data(iunit1, 1,(/ngb_tstep/),        &
                     offset1_ijk,.true.)
        call binary_write_data(iunit1, nvars, realbuffer_gb,   &
                     offset1,.true.) 

        offset1 = offset1 + nvars*nfloatbit

      else
        write(iunit1,'(50e15.7)') time,(totc(ic),ic=1,nc-1)
      end if

!c  species concentrations
 
      if (b_output_binary) then
        nvars = nc+nxout
        realbuffer_gb(1:nvars) = (/time,(c(ic),ic=1,nc-1),     &
                                   (cx(ix),ix=1,nxout)/)
        call binary_write_data(iunit2, 1,(/ngb_tstep/),        &
                     offset2_ijk,.true.)
        call binary_write_data(iunit2, nvars, realbuffer_gb,   &
                     offset2,.true.) 

        offset2 = offset2 + nvars*nfloatbit

      else
        write(iunit2,'(1000e15.7)') time,(c(ic),ic=1,nc-1),            &
                                   (cx(ix),ix=1,nxout)
      end if

!c  master variables

      ! Compute charge balance
      call cbalance(c,cx,zbal,zpos,zneg)

      call phpe(c,gammac,ph,pe,eh,tempkel)      

      if (compute_alkalinity) then
        call alkcalc(alk_carb,alk_noncarb,alk_tot,                    &
     &               alk_carb_mg,alk_noncarb_mg,alk_tot_mg,           &
     &               alkfacc,alkfacx,c,cx,                            &
     &               iax,jax,nc,nx,namec,namex)
      else                     !CMX
        alk_carb=r0
        alk_noncarb=r0
        alk_tot=r0
        alk_carb_mg=r0
        alk_noncarb_mg=r0
        alk_tot_mg=r0
      end if

      if (b_output_binary) then
        if ((ph_output).and.(pe_output)) then
          nvars = 13
          realbuffer_gb(1:nvars) =  (/time,ph,pe,eh,strion,alk_carb,   &
                                    alk_noncarb,alk_tot,alk_carb_mg,   &
                                    alk_noncarb_mg,alk_tot_mg,         &
                                    tempkel-tconv,zbal/)
        elseif ((.not.ph_output).and.(pe_output)) then 
          nvars = 12
          realbuffer_gb(1:nvars) =  (/time,pe,eh,strion,alk_carb,      &
                                    alk_noncarb,alk_tot,alk_carb_mg,   &
                                    alk_noncarb_mg,alk_tot_mg,         &
                                    tempkel-tconv,zbal/)                
        elseif ((ph_output).and.(.not.pe_output)) then  
          nvars = 11
          realbuffer_gb(1:nvars) =  (/time,ph,strion,alk_carb,         &
                                    alk_noncarb, alk_tot,alk_carb_mg,  &
                                    alk_noncarb_mg,alk_tot_mg,         &
                                    tempkel-tconv,zbal/)
        end if
        call binary_write_data(iunit3, 1,(/ngb_tstep/),        &
                     offset3_ijk,.true.)
        call binary_write_data(iunit3, nvars, realbuffer_gb,   &
                     offset3,.true.) 

        offset3 = offset3 + nvars*nfloatbit

      else
        if ((ph_output).and.(pe_output)) then
          write(iunit3,'(13e15.7)') time,ph,pe,eh,strion,alk_carb,     &
                                    alk_noncarb,alk_tot,alk_carb_mg,   &
                                    alk_noncarb_mg,alk_tot_mg,         &
                                    tempkel-tconv,zbal                  
        elseif ((.not.ph_output).and.(pe_output)) then                  
          write(iunit3,'(12e15.7)') time,pe,eh,strion,alk_carb,        &
                                    alk_noncarb,alk_tot,alk_carb_mg,   &
                                    alk_noncarb_mg,alk_tot_mg,         &
                                    tempkel-tconv,zbal                  
        elseif ((ph_output).and.(.not.pe_output)) then                  
          write(iunit3,'(11e15.7)') time,ph,strion,alk_carb,           &
                alk_noncarb, alk_tot,alk_carb_mg,alk_noncarb_mg,       &
                alk_tot_mg,tempkel-tconv,zbal
        end if
      end if

!c  partial gas pressures

      if (ng.gt.0) then
 
!c  total gas pressure

        pres_tot = r0
        do ig = 1,ng
          pres_tot = pres_tot+rgasatm*tempkel*g(ig)
        end do
 
        if (b_output_binary) then
          nvars = ng+2
          realbuffer_gb(1:nvars) =  (/time,(rgasatm*tempkel*g(ig),     &
                                    ig=1,ng),pres_tot/)
          call binary_write_data(iunit4, 1,(/ngb_tstep/),      &
                       offset4_ijk,.true.)
          call binary_write_data(iunit4, nvars, realbuffer_gb, &
                       offset4,.true.) 

          offset4 = offset4 + nvars*nfloatbit

        else
          write(iunit4,'(50e15.7)') time,(rgasatm*tempkel*g(ig),       &
     &                              ig=1,ng),pres_tot
        end if

!c  gas removal rates

        if (gas_removal) then
          if (density_dependence) then
!c  uvsnew was passed into hhead
            call rategasd(g,tempkel,hhead,1-sw)
          else
            call rategas(g,tempkel,hhead,zg,1-sw)
          end if

          if (b_output_binary) then
            nvars = ng+1
            realbuffer_gb(1:nvars) =  (/time,(rateg(ig,tid),ig=1,ng)/)
            call binary_write_data(iunit11, 1,(/ngb_tstep/),   &
                         offset11_ijk,.true.)
            call binary_write_data(iunit11, nvars,             &
                         realbuffer_gb,offset11,.true.) 

            offset11 = offset11 + nvars*nfloatbit

          else
            write(iunit11,'(50e15.7)') time,(rateg(ig,tid),ig=1,ng)
          end if
 
        end if

      end if
 
!c  oxidation-reduction rates
!c  !!!use iunit5 for intra-aqueous reactions
!c  !!!get rid of the following, after raterdx is incorporated into 
!c  !!!rateint

      if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) then

        do ir = 1,nr
          call rateredx(c,cx,gammac,gammax,rateor(ir,tid),totc,ir)
        end do

        if (b_output_binary) then
          nvars = nr+1
          realbuffer_gb(1:nvars) =  (/time,(rateor(ir,tid),ir=1,nr)/)
          call binary_write_data(iunit5, 1,(/ngb_tstep/),      &
                       offset5_ijk,.true.)
          call binary_write_data(iunit5, nvars,                &
                       realbuffer_gb,offset5,.true.) 

          offset5 = offset5 + nvars*nfloatbit

        else
          write(iunit5,'(50e15.7)') time,(rateor(ir,tid),ir=1,nr)
        end if

      end if

!c  reaction rates of intra-aqueous kinetic reactions

      if (naq.gt.0) then 
        if (ivolume > 0) then
          scalfac_aq(1:naq) = scalfac_aq_ivol(1:naq,ivolume)
        end if
        do iaq = 1,naq
          if (new_database) then
            call rateint_new(rateaq(iaq,tid),totc,c,cx,gammac,gammax,  &
                             phim,iaq,scalfac_aq(iaq))
          else
            call rateint(rateaq(iaq,tid),totc,c,gammac,phim,iaq,       &
                       scalfac_aq(iaq))
          end if
        end do

        if (b_output_binary) then
          nvars = naq+1
          realbuffer_gb(1:nvars) =  (/time,(rateaq(iaq,tid),iaq=1,naq)/)
          call binary_write_data(iunit5, 1,(/ngb_tstep/),      &
                       offset5_ijk,.true.)
          call binary_write_data(iunit5, nvars,                &
                       realbuffer_gb,offset5,.true.) 

          offset5 = offset5 + nvars*nfloatbit

        else
          write(iunit5,'(50e15.7)') time,(rateaq(iaq,tid),iaq=1,naq)
        end if
  
      end if

!c  concentrations of sorbed species

!c  compute sorbed concentrations - noncompetitive reactions

      if (noncompetitive_sorption) then
      
        call totcona(totan(:,tid),totc,distcoff,sw,porvol)

!c  compress sorbed concentration vector for output      

        ianc = 0
        do ic = 1,nc-1
          if (isotherm_type(ic).ne.'none') then
            ianc = ianc+1
            totan(ianc,tid) = totan(ic,tid)
          end if
        end do

      end if

!c  compute sorbed species concentrations based on aqueous concentrations
!c  competitive sorption

      if (nsb_ion.gt.0) then
          do isb = 1,nsb_ion 
                call sorbspc_m(csb_ion(isb,tid),dummy,cec_l,          &
                     cec_fraction(idx_nsites_ion(isb)),               &
                     eqsb_ion(:,tid),eqsb_surf(:,tid),                &
                     gammac,c,xnusb_ion,xnusb_surf,                   &
                     iasb_ion,iasb_surf,jasb_ion,jasb_surf,           &
                     nsb_ion,nsb_surf,isb,0,                          &
                     sorption_type_ion,sorption_type_surf,            &
                     sorption_group,isactcexch)
          end do  
      end if
      
      if (nsb_surf.gt.0) then
        do isb = 1,nsb_surf
          call sorbspc(dummy,csb_surf(isb,tid),cec_l,                 &
               eqsb_ion(:,tid),eqsb_surf(:,tid),                      &
               gammac,c,xnusb_ion,xnusb_surf,                         &
               iasb_ion,iasb_surf,jasb_ion,jasb_surf,                 &
               nsb_ion,nsb_surf,0,isb,                                &
               sorption_type_ion,sorption_type_surf,                  &
               sorption_group,isactcexch)
        end do
      end if

!c  output - sorbed species

      if (nsb_ion .gt. 0 .or. nsb_surf.gt.0 .or.                      &
          noncompetitive_sorption) then

        if (b_output_binary) then
          nvars = nanc+nsites+nsb_ion+nsb_surf+1
          realbuffer_gb(1:nvars) =  (/time,                            &
                (totan(ianc,tid),ianc=1,nanc),                         &
                (c(iaic(isites)),isites=1,nsites),                     &
                (csb_ion(isb,tid),isb=1,nsb_ion),                      &
                (csb_surf(isb,tid),isb=1,nsb_surf)/)
          call binary_write_data(iunit6, 1,(/ngb_tstep/),      &
                       offset6_ijk,.true.)
          call binary_write_data(iunit6, nvars,                &
                       realbuffer_gb,offset6,.true.) 

          offset6 = offset6 + nvars*nfloatbit

        else
          write(iunit6,'(50e15.7)') time,                              &
                (totan(ianc,tid),ianc=1,nanc),                         &
                (c(iaic(isites)),isites=1,nsites),                     &
                (csb_ion(isb,tid),isb=1,nsb_ion),                      &
                (csb_surf(isb,tid),isb=1,nsb_surf)
        end if
      end if

!c  mineral saturation indices
 
      if (nm.gt.0) then

!c  compute average molar concentrations for organic mixture
!c  in solid phase

        call molconc(phimold)

        do im = 1,nm

          if (.not.far_from_equil(im)) then

!c  saturation indices for minerals
!c_isotope
            if (isofrac(im)) then
              satm(im,tid) = eqm(im,tid)**(-r1)
              ireac = iamd(im)            
              istart = iam(im)
              istop = iam(im+1)-1 
                  
              do i1 = istart, istop ! loop through components in mineral
                icount = 0
                ic = jam(i1)
                next = 0
                do i = 1, nifrm(im)  ! loop through isotope sets
                  istart2 = next + iamdiso(im)
                  icur = iamdiso2(im) + i - 1
                  istop2 = iamdiso(im) + jamdiso2(icur) - 1
                  next = jamdiso2(icur)
                  gammatemp = r0
                  !loop through isotope compents in set
                  do i2 = istart2, istop2 
                    ii = jamdiso(i2)
                    !check to see if component is an isotope
                    if (ii.eq.ic) then 
                      icount = icount + 1
                      !if so sum the isotope activities
                      do i3 = istart2, istop2 
                        ic2 = jamdiso(i3)
                        gammatemp = gammatemp + gammac(ic2)*c(ic2)
                      end do 
                      satm(im,tid) = satm(im,tid) *(gammatemp**xnum(i1))
                    end if
                  end do
                end do 
                !if not calculate the saturaton index the normal way  
                if (icount.eq.0) then    
                    satm(im,tid) = satm(im,tid) * (gammac(ic)*c(ic))**xnum(i1)
                end if
              end do   !i1
            
              satm_log(im) = dlog10(satm(im,tid))

            else if (reaction_type(im).ne.'raoult') then

              satm(im,tid) = satindex(c,eqm(im,tid),gammac,xnum,      &
                             iam,jam,im)
              satm_log(im) = dlog10(satm(im,tid))

!c  effective saturation indices for dissolution form organic mixtures
!c  based on raoult's law

            elseif (reaction_type(im).eq.'raoult') then

!c  compute molar concentration of organic compound in organic mixture

              conc_mol = phimold(im)*densm(im)/gfwm(im)

!c  pure phase saturation index

              satm(im,tid) = satindex(c,eqm(im,tid),gammac,xnum,       &
                             iam,jam,im)

!c  effective solubility according to Raoult's law

              frac_mol = conc_mol/conc_mol_avg(tid) 
              satm(im,tid) = satm(im,tid)/frac_mol
              satm_log(im) = dlog10(satm(im,tid))

            end if

!c  skip for far-from-equilibrium reactions

          else

            satm_log(im) = r0

          end if
        end do

        if (b_output_binary) then
          nvars = nm+1
          realbuffer_gb(1:nvars) =  (/time,(satm_log(im),im=1,nm)/)
          call binary_write_data(iunit7, 1,(/ngb_tstep/),      &
                       offset7_ijk,.true.)
          call binary_write_data(iunit7, nvars,                &
                       realbuffer_gb,offset7,.true.) 

          offset7 = offset7 + nvars*nfloatbit

        else
          write(iunit7,'(50e15.7)') time,(satm_log(im),im=1,nm)
        end if
 
!c  mineral volume fractions
 
!c  get rid off concentrations below numerical accuracy

        do im = 1,nm
          if (phim(im).gt.phimin_out(im)) then
            phi_out(im) = phim(im)
          else
            phi_out(im) = phimin(im)
          end if
        end do

!c  compute porosity from mineral volume fractions for output

        por_out = r1
        do im = 1,nm
          if (iamp(im+1)-iamp(im).gt.0) then
            por_out = por_out - phi_out(im)
          end if
        end do
       
      if (update_porosity) then
        if (b_output_binary) then
          nvars = nm+2
          realbuffer_gb(1:nvars) =  (/time,(phi_out(im),im=1,nm),      &
                                      porvol/)
        else
          write(iunit8,'(50e15.7)') time,(phi_out(im),im=1,nm),porvol
        end if

      else
        if (b_output_binary) then
          nvars = nm+2
          realbuffer_gb(1:nvars) =  (/time,(phi_out(im),im=1,nm),      &
                                      por_out/)
        else
          write(iunit8,'(50e15.7)') time,(phi_out(im),im=1,nm),por_out
        end if
          
      end if

      if (b_output_binary) then
        call binary_write_data(iunit8, 1,(/ngb_tstep/),                &
                     offset8_ijk,.true.)
        call binary_write_data(iunit8, nvars,                          &
                     realbuffer_gb,offset8,.true.) 
        offset8 = offset8 + nvars*nfloatbit

      end if

!c  mineral dissolution-precipitation rates

        do im = 1,nm

          if (new_database) then
            call ratemin_new(totc,c,cx,gammac,gammax,ratem,phim,      &
     &                       phimold(im),aream(im),im)
        else                                                         
            call ratemin(totc,c,cx,gammac,gammax,ratem,phim(im),      &
     &                   phimold(im),aream(im),im)
        end if

!c  modify computed rates in the same manner as done in the residual
!c  assembly
!CMX
          istart = iamd(1)
          istop = iamd(nm+1)-1    
!CMX

          call modrate(ratem,cm(im),deltat,im)

        end do
        
        if (b_output_binary) then
          nvars = istop-istart+2
          realbuffer_gb(1:nvars) =  (/time,(ratemp(ireac,tid),         &
                                    ireac=istart,istop)/)
          call binary_write_data(iunit9, 1,(/ngb_tstep/),      &
                       offset9_ijk,.true.)
          call binary_write_data(iunit9, nvars,                &
                       realbuffer_gb,offset9,.true.) 

          offset9 = offset9 + nvars*nfloatbit

        else
          write(iunit9,'(50e15.7)') time,(ratemp(ireac,tid),           &
                                    ireac=istart,istop)
        end if

      end if           !(nm.gt.0)

!c  saturation indices (excluded minerals)

      if (nmx.gt.0) then

         do imx = 1,nmx
            satmx(imx) =  satindex(c,eqmx(imx,tid),gammac,xnumx,      &
     &                             iamx,jamx,imx)
         end do

         if (b_output_binary) then
           nvars = nmx+1
           realbuffer_gb(1:nvars) =  (/time,(dlog10(satmx(imx)),       &
                                      imx=1,nmx)/)
           call binary_write_data(iunit10, 1,(/ngb_tstep/),    &
                        offset10_ijk,.true.)
           call binary_write_data(iunit10, nvars,              &
                        realbuffer_gb,offset10,.true.) 

           offset10 = offset10 + nvars*nfloatbit
 
         else
           write(iunit10,'(50e15.7)') time,(dlog10(satmx(imx)),        &
                                      imx=1,nmx)
         end if

      end if           !(nmx.gt.0)
      
      
      
!c_isotopes    
      if (iso_output) then
        i1 = 0
        do i=1,nip
          istart = iamdisoo(i)
          istop = iamdisoo(i+1)-1
          tottemp = r0
          do i2 = istart, istop
            ic2 = jamdisoo(i2)
            i1 = i1 +1
            valuetemp(i1) = totc(ic2)
            tottemp = tottemp + totc(ic2)
          end do
          i1 = i1 +1
          valuetemp(i1) = tottemp
           
          istart = iamdisoo(i)
          istop = iamdisoo(i+1)-1
          do i2 = istart+1, istop
            ic1 = jamdisoo(istart)
            ic2 = jamdisoo(i2)
            i1 = i1 +1 
            valuetemp(i1)=(totc(ic2)/totc(ic1)/isodelta(i2)-1)*1000
          end do            
        end do

        if (b_output_binary) then
          nvars = i1+1
          realbuffer_gb(1:nvars) =  (/time,(valuetemp(imi),imi=1,i1)/)
          call binary_write_data(iunit12, 1,(/ngb_tstep/),             &
                       offset12_ijk,.true.)
          call binary_write_data(iunit12, nvars,                       &
                       realbuffer_gb,offset12,.true.) 

          offset12 = offset12 + nvars*nfloatbit
 
        else
          write(iunit12,'(50e15.7)') time,(valuetemp(imi),imi=1,i1)
        end if
        
      end if

!c  compress total aqueous component concentration vector in case of
!c  equilibrium reactions 

      if (redox_equil.and.nr.gt.0) then
        call comptotc(totc) 
      end if 

      return
      end
