!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/diffcoff_mcd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c  ----------------------------------------------------------------------
!c  subroutine diffcoff_mcd
!c  -----------------
!c 
!c  compute harmonically averaged diffusion coefficients 
!c  for free and secondary aqueous species  
!c 
!c 
!c                         /|   ij, D_ij
!c                        / | /
!c                       /  |/
!c                      |   /
!c             D_i      |  /|           D_j
!c             *--------|-*-------------*
!c             i d_i,ij |   |  d_j,ij   j
!c                      |   |
!c                      |  / 
!c                      | /   
!c 
!c 
!c  Based on Uli Mayer template
!c 
!c  Written by:   Pejman Rasouli - February 11, 2010
!c 
!c  last modified:   Pejman Rasouli - February 16, 2012
!c 
!c  definition of variables:
!c 
!c  I --> on input   * arbitrary  - initialized  + entries expected
!c  O --> on output  * arbitrary  - unaltered    + altered
!c  
!c                                                                     I O
!c  passed:   -
!c 
!c  common:   
!c  gen.f:    real*8:
!c            -------
!c            cinfvs(njavs)      = influence coefficients              * +
!c                                 (variably saturated flow)
!c            delx(nvx)          = spatial increment in x-direction    + -
!c            dely(nvy)          = spatial increment in y-direction    + -
!c            delz(nvz)          = spatial increment in z-direction    + -
!c            perm_fac(nn)       = scaling factor for permeability     + -
!c                                 as a function of porosity changes
!c            f_epor_ps(nc,nzn)  = correction factor of porosity for
!c                                  primary species                    +-
!c            f_epor_ss(nc,nzn)  = correction factor of porosity for
!c                                  secondary species                  +-
!c            f_etau_ps(nc,nzn)  = correction factor of tortuosity for
!c                                  primary species                    +-
!c            f_etau_ss(nc,nzn)  = correction factor of tortuosity for
!c                                  secondary species                  +-
!c 
!c            integer*4:
!c            ----------
!c            nvx                = number of control volumes in        + -
!c                                 x-direction
!c            nvy                = number of control volumes in        + -
!c                                 y-direction
!c            nvz                = number of control volumes in        + -
!c                                 z-direction
!c 
!c            logical:
!c            --------
!c            half_cells         = .true.  -> half cells on boundary   + -
!c 
!c 
!c  phys.f:   real*8:
!c            -------
!c 
!c 
!c 
!c  local:    real*8:
!c            -------
!c            areaf              = interfacial area
!c            delx_i             = interfacial distance i-ij in 
!c                                 x-direction
!c            delx_j             = interfacial distance j-ij in
!c                                 x-direction
!c            dely_i             = interfacial distance i-ij in
!c                                 y-direction
!c            dely_j             = interfacial distance j-ij in
!c                                 y-direction
!c            delz_i             = interfacial distance i-ij in
!c                                 z-direction
!c            delz_j             = interfacial distance j-ij in
!c            rhalf              = constant
!c            
!c            integer*4:
!c            ----------
!c            ivx                = counter (number of control
!c                                 volumes in x-direction)
!c            ivy                = counter (number of control
!c                                 volumes in y-direction)
!c            ivz                = counter (number of control
!c                                 volumes in z-direction)
!c            ivol               = pointer (current control volume)
!c            ivxp               = pointer (previous control 
!c                                 volume in x-direction) 
!c            ivxn               = pointer (next control volume in 
!c                                 x-direction)
!c            ivyp               = pointer (previous control
!c                                 volume in y-direction)
!c            ivyn               = pointer (next control volume in
!c                                 y-direction)
!c            ivzp               = pointer (previous control
!c                                 volume in z-direction)
!c            ivzn               = pointer (next control volume in
!c                                 z-direction)
!c            izn                = pointer (material property zone)
!c            jtemp              = pointer to colum entries
!c 
!c  external: -
!c  ----------------------------------------------------------------------
 
      subroutine diffcoff_mcd (nvxgls, nvxgle, nvxgbl,                 &
                 nvygls, nvygle, nvygbl,nvzgls, nvzgle, nvzgbl,        &
                 nvx, nvy, nvz, ia, ja,                                &
                 mprop,pornew, sanew,tortuosity_corr,                  &
                 half_cells,nc,nx, mdiff_ic,mdiff_ix,                  &
                 njamxc,nmax,mdiff_ic_cvol,mdiff_ix_cvol,              &
                 assigned_tau,tau,type_tortuosity,                     &
                 marchies,delx,dely,delz,type_averaging_De,            &
                 tau_fac, epor_diff,f_epor, f_etau, hmulti_diff,       &
                 sonew)

#ifdef OPENMP
      use omp_lib 
      use gen, only : numofthreads_global,                          &
                      numofloops_thred_global,                      &
                      numofloops_thred_diffcoff_mcd_1,              &
                      f_epor_ps, f_etau_ps, f_epor_ss, f_etau_ss
#else
      use gen, only : f_epor_ps, f_etau_ps, f_epor_ss, f_etau_ss
#endif 

      implicit none
      
      integer :: ic, ix, izn, info_debug, nmax, njamxc, jzn

      external diffcoff
      
      real*8  diffcoff
      real*8, dimension(*) :: f_epor
      real*8, dimension(*) :: f_etau
      
      integer nvxgls, nvxgle, nvxgbl, nvygls, nvygle, nvygbl,          &
              nvzgls, nvzgle, nvzgbl, ivxgbl, ivygbl, ivzgbl,          &
              ivxpgbl, ivypgbl, ivzpgbl, ivxngbl, ivyngbl, ivzngbl,    &
              nvx, nvy, nvz, ia(nmax+1), ja(njamxc),                   &
              isymm(njamxc), mprop(*), nc, nx
      
      real*8  pornew(nmax), sanew(nmax),mdiff_ic(nc),                  &
              mdiff_ix(nx),mdiff_ic_cvol(nc, njamxc),marchies(nmax),   &
              mdiff_ix_cvol(nx, njamxc), delx(nvx),dely(nvy),delz(nvz),&
              tau(nmax), tau_fac(nmax), sonew(nmax)        
     
      logical half_cells,tortuosity_corr,assigned_tau, epor_diff,      &
              hmulti_diff
         
      character(len=*) type_tortuosity,type_averaging_De
      
!c      local variables

      real*8, parameter :: rhalf = 0.5d0, r1 = 1.0d0, r2 = 2.0d0,      &
                           pi = 3.141592653589790E+00
      
!c      added for dgm model
      real*8 :: so_av
           
!c      added for harmonic averaging

      real*8 diff_i,diff_j,diff_ij,areaf,satav,                        &
             por_i,por_j,delx_i,dely_i,delz_i,                         &
             delx_j,dely_j,delz_j,tau_i,tau_j,                         &
             epor_i,epor_j,etau_i,etau_j
      
      integer ivz, ivy, ivx, ivxp,ivxn,ivyp,    &
              ivyn,ivzp,ivzn,jtemp,ivol,jvol

#ifdef OPENMP      
      integer :: nvols
#endif

      delx_i = 0.0d0
      dely_i = 0.0d0
      delz_i = 0.0d0

!c  set up to work for half and full cells


!c   initialize pointer to current control volume

      info_debug = 0 
      ivol=0
      tau_i = r1
      tau_j = r1
      
!c   loop over control volumes
#ifdef OPENMP      
      nvols = nvx * nvy * nvz
#endif
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nvols > numofloops_thred_diffcoff_mcd_1)                &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ic, ivol, ivx, ivy, ivz, ivxp, ivxn, ivyp, ivyn,   &
    !$omp ivzp, ivzn, ix, izn, jtemp, jvol, jzn,                      &
    !$omp ivxgbl, ivygbl, ivzgbl, ivxpgbl, ivypgbl, ivzpgbl,          &
    !$omp ivxngbl, ivyngbl, ivzngbl,                                  &
    !$omp delx_i, delx_j, dely_i, dely_j, delz_i, delz_j, diff_i,     &
    !$omp diff_ij, diff_j, por_i, por_j, satav, tau_i, tau_j,         &
    !$omp epor_i,epor_j,etau_i,etau_j, so_av)                         &
    !$omp reduction(+:mdiff_ic_cvol, mdiff_ix_cvol)
    !$omp do schedule(static)
#endif   
          do ivz = 1,nvz                  ! number of control volumes in z
            ivzgbl = ivz+nvzgls-1  
            do ivy = 1,nvy                ! number of control volumes in y
              ivygbl = ivy+nvygls-1   
              do ivx = 1,nvx              ! number of control volumes in x
              ivxgbl = ivx+nvxgls-1     
                
!c   pointer to current control volume
#ifdef OPENMP
            ivol = ((ivz-1)*nvy + ivy-1) * nvx + ivx
#else
            ivol = ivol+1
#endif
            jtemp = ia(ivol)
            if (assigned_tau) then
                   tau_i = tau(ivol)*tau_fac(ivol)      ! assign tortuosity 
            end if
!c   assign porosity for current control volume
           
            por_i = pornew(ivol)    ! assign porosity
            
            jtemp = jtemp+1         ! skip diagonal
            
!c   pointers to previous colums in x,y and z

            ivxp = ivx-1
            ivxn = ivx+1
            ivyp = ivy-1
            ivyn = ivy+1
            ivzp = ivz-1
            ivzn = ivz+1
            
            ivxpgbl = ivxgbl-1
            ivxngbl = ivxgbl+1
            ivypgbl = ivygbl-1
            ivyngbl = ivygbl+1
            ivzpgbl = ivzgbl-1
            ivzngbl = ivzgbl+1 
!c   assign interfacial distances of current control volume

            if (half_cells) then            !half_cells on boundary
            
              if (nvx.gt.1) then                        !in x-direction
                if (ivxgbl.eq.1.or.ivxgbl.eq.nvxgbl) then        !boundary
                  delx_i = delx(ivxgbl)
                elseif (ivxgbl.gt.0.and.ivxgbl.lt.nvxgbl) then  !interior
                  delx_i = rhalf*delx(ivxgbl) 
                end if
              end if

              if (nvy.gt.1) then                        !in y-direction
                if (ivygbl.eq.1.or.ivygbl.eq.nvygbl) then        !boundary
                  dely_i = dely(ivygbl)
                elseif (ivygbl.gt.0.and.ivygbl.lt.nvygbl) then  !interior
                  dely_i = rhalf*dely(ivygbl) 
                end if
              end if

              if (nvz.gt.1) then                        !in z-direction
                if (ivzgbl.eq.1.or.ivzgbl.eq.nvzgbl) then        !boundary
                  delz_i = delz(ivzgbl)
                elseif (ivzgbl.gt.0.and.ivzgbl.lt.nvzgbl) then  !interior
                  delz_i = rhalf*delz(ivzgbl) 
                end if
              end if

            else                            !full cells on boundary

              if (nvx.gt.1) then                        !in x-direction
                delx_i = rhalf*delx(ivxgbl) 
              end if

              if (nvy.gt.1) then                        !in y-direction
                dely_i = rhalf*dely(ivygbl) 
              end if

              if (nvz.gt.1) then                        !in z-direction
                delz_i = rhalf*delz(ivzgbl) 
              end if

            end if                          !(half_cells)

!c   calculate influence coefficients in x-direction

            if (nvx.gt.1) then              !connections in x-direction
              if (ivxp.gt.0) then           !left connection  (2)
                if (half_cells) then        !half cells on boundary
                  if (ivxpgbl.eq.1) then
                    delx_j = delx(ivxpgbl)
                  elseif (ivxpgbl.gt.1) then
                    delx_j = rhalf*delx(ivxpgbl)       
                  end if
                else                        !full cells on boundary
                  delx_j = rhalf*delx(ivxpgbl)       
                end if                      !(half_cells)
                
                jvol = ja(jtemp)
                jzn = mprop(jvol)             
                por_j = pornew(jvol)

                if (assigned_tau) then
                 tau_j = tau(jvol)*tau_fac(jvol)          ! assign tortuosity
                end if 
!cprovi------------------------------------------------
!cprovi------------------------------------------------
!cprovi------------------------------------------------
!cprovi------------------------------------------------                
             do ic =1,nc
!cmx  adding modification factor for effective porosity calculation
                if (hmulti_diff .or. (epor_diff .eqv. .true. .and. por_i .lt. 0.3 .and.  por_j .lt. 0.3)) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
 !                    epor_i = por_i*f_epor(ic)
                     epor_i = por_i*f_epor_ps(ic,izn)
                     epor_j = por_j*f_epor_ps(ic,jzn)
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ps(ic,izn)
                     etau_j = tau_j*f_etau_ps(ic,jzn)
                     
                     satav=dmin1(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,epor_i,      &
                                      tortuosity_corr,assigned_tau,    &
                                      etau_i,type_tortuosity,          &
                                      marchies(ivol),so_av)
                     
                     satav=dmin1(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ic(ic),satav,epor_j,      &
                                      tortuosity_corr,assigned_tau,    &
                                      etau_j,type_tortuosity,          &
                                      marchies(jvol),so_av)
                 else
!cmx 
                     satav=dmin1(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,por_i,       &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_i,type_tortuosity,           &
                                      marchies(ivol),so_av)
      
                     satav=dmin1(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ic(ic),satav,por_j,       &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                 end if
      
                diff_ij = diff_i*diff_j
      
                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then               
                     mdiff_ic_cvol(ic, jtemp)=mdiff_ic_cvol(ic, jtemp)+    &
                     r2*diff_ij/(diff_i+diff_j)
                  elseif(type_averaging_De.eq.'arithmetic')then
                     mdiff_ic_cvol(ic, jtemp)=mdiff_ic_cvol(ic, jtemp)+ &
                     (diff_i + diff_j)*rhalf 
                  elseif(type_averaging_De.eq.'no averaging')then
                     mdiff_ic_cvol(ic, jtemp)=mdiff_ic_cvol(ic, jtemp)+    &
                     (diff_i)/(delx_i)                  
                  endif
                  
                endif
      
      
             end do                         ! loop over free species
             
             do ix = 1,nx                   ! loop over secondary species
!cmx  adding modification factor for effective porosity calculation
                if (hmulti_diff .eqv. .true. ) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
 !                    epor_i = por_i*f_epor(ic)
                     epor_i = por_i*f_epor_ss(ix,izn)
                     epor_j = por_j*f_epor_ss(ix,jzn)
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ss(ix,izn)
                     etau_j = tau_j*f_etau_ss(ix,jzn)
                     
                     satav=min(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ix(ix),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
      
                     satav=min(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ix(ix),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                     
                else
        
                    satav=min(r1, sanew(ivol))
                    so_av=dmin1(r1, sonew(ivol))
                    diff_i = diffcoff(mdiff_ix(ix),satav,por_i,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_i,type_tortuosity,           &
                                      marchies(ivol),so_av)
      
                    satav=min(r1, sanew(jvol))
                    so_av=dmin1(r1, sonew(jvol))
                    diff_j = diffcoff(mdiff_ix(ix),satav,por_j,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                end if

                diff_ij = diff_i*diff_j

                if(diff_ij.gt.0.0) then
                
                  if (type_averaging_De.eq.'harmonic') then
                     mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+    &
                     r2*diff_ij/(diff_i+diff_j)
      
                  elseif(type_averaging_De.eq.'arithmetic')then
                     mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+    &
                     (diff_i + diff_j)*rhalf
      
                  elseif(type_averaging_De.eq.'no averaging')then
                     mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+    &
                     (diff_i)/(delx_i)
                  endif
                  
                endif 
             end do                         ! loop over secondary species
             
!cprovi------------------------------------------------
!cprovi------------------------------------------------
!cprovi------------------------------------------------
!cprovi------------------------------------------------             
                jtemp = jtemp+1
                
              end if

              if (ivxn.le.nvx) then         !right connection  (3)
                if (half_cells) then        !half cells on boundary
                  if (ivxngbl.eq.nvxgbl) then
                    delx_j = delx(ivxngbl)
                  elseif (ivxngbl.lt.nvxgbl) then
                    delx_j = rhalf*delx(ivxngbl)       
                  end if
                else                        !full cells on boundary
                  delx_j = rhalf*delx(ivxngbl)
                end if                      !(half_cells)
                
                jvol = ja(jtemp)
                jzn = mprop(jvol)             
                por_j = pornew(jvol)
                
                if (assigned_tau) then
                 tau_j = tau(jvol)*tau_fac(jvol)          ! assign tortuosity
                end if

!cprovi------------------------------------------------              
             do ic =1,nc
                 !cmx  adding modification factor for effective porosity calculation
                 if (hmulti_diff .or. (epor_diff .eqv. .true. .and. por_i .lt. 0.3 .and.  por_j .lt. 0.3)) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
                     epor_i = por_i*f_epor_ps(ic,izn)
                     epor_j = por_j*f_epor_ps(ic,jzn)
                     
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ps(ic,izn)
                     etau_j = tau_j*f_etau_ps(ic,jzn)

                     satav=dmin1(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
                     satav=dmin1(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ic(ic),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                 else
!cmx 
                     satav=dmin1(r1, sanew(ivol)) 
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,por_i,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_i,type_tortuosity,          &
                                       marchies(ivol),so_av)
      
                     satav=dmin1(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ic(ic),satav,por_j,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_j,type_tortuosity,          &
                                       marchies(jvol),so_av)
                 end if
      
                diff_ij = diff_i*diff_j
      
                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                     mdiff_ic_cvol(ic, jtemp)= mdiff_ic_cvol(ic, jtemp)+    &
                     r2*diff_ij/(diff_i+diff_j)
      
                  elseif(type_averaging_De.eq.'arithmetic')then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+        &
                     (diff_i + diff_j)*rhalf
      
                  elseif(type_averaging_De.eq.'no averaging')then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+        &
                     (diff_i)/(delx_i)
      
                  endif
                endif
             end do                         ! loop over free species
             
             do ix = 1,nx                   ! loop over secondary species

!cmx  adding modification factor for effective porosity calculation
                if (hmulti_diff .eqv. .true. ) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
 !                    epor_i = por_i*f_epor(ic)
                     epor_i = por_i*f_epor_ss(ix,izn)
                     epor_j = por_j*f_epor_ss(ix,jzn)
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ss(ix,izn)
                     etau_j = tau_j*f_etau_ss(ix,jzn)
                     
                     satav=min(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ix(ix),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
      
                     satav=min(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ix(ix),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                     
               else                 
                    satav=min(r1, sanew(ivol))
                    so_av=dmin1(r1, sonew(ivol))
                    diff_i = diffcoff(mdiff_ix(ix),satav,por_i,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_i,type_tortuosity,           &
                                      marchies(ivol),so_av)
      
                    satav=min(r1, sanew(jvol))
                    so_av=dmin1(r1, sonew(jvol))
                    diff_j = diffcoff(mdiff_ix(ix),satav,por_j,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                
               end if
               

                diff_ij = diff_i*diff_j

                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                    mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+    &
                        r2*diff_ij/(diff_i+diff_j)
      
                  elseif(type_averaging_De.eq.'arithmetic')then
                    mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+    &
                     (diff_i + diff_j)*rhalf
      
                  elseif(type_averaging_De.eq.'no averaging')then
                     mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+    &
                     (diff_i)/(delx_i)
                  endif
                
                endif 
             end do                         ! loop over secondary species
!cprovi------------------------------------------------              
                jtemp = jtemp+1
                
              end if

            end if                          !connections in x-direction

!c   calculate influence coefficients in y-direction

            if (nvy.gt.1) then              !connections in y-direction
              if (ivyp.gt.0) then           !front connection (4)
                if (half_cells) then        !half cells on boundary
                  if (ivypgbl.eq.1) then
                    dely_j = dely(ivypgbl)
                  elseif (ivypgbl.gt.1) then
                    dely_j = rhalf*dely(ivypgbl)       
                  end if
                else                        !full cells on boundary
                  dely_j = rhalf*dely(ivypgbl)       
                end if                      !(half_cells)
                
                jvol = ja(jtemp)
                jzn = mprop(jvol)               
                por_j = pornew(jvol)
                
                if (assigned_tau) then
                 tau_j = tau(jvol)*tau_fac(jvol)          ! assign tortuosity
                end if  
                              
 !cprovi------------------------------------------------                          
                
                do ic =1,nc
!cmx  adding modification factor for effective porosity calculation
                 if (hmulti_diff .or. (epor_diff .eqv. .true. .and. por_i .lt. 0.3 .and.  por_j .lt. 0.3)) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
                     epor_i = por_i*f_epor_ps(ic,izn)
                     epor_j = por_j*f_epor_ps(ic,jzn)
                     
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ps(ic,izn)
                     etau_j = tau_j*f_etau_ps(ic,jzn)

                     satav=dmin1(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
                     satav=dmin1(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ic(ic),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                 else
!cmx 

                     satav=min(r1, sanew(ivol))  
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,por_i,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_i,type_tortuosity,          &
                                       marchies(ivol),so_av)
      
                     satav=min(r1, sanew(jvol))  
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ic(ic),satav,por_j,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_j,type_tortuosity,          &
                                       marchies(jvol),so_av)
                 
                 end if
      
                 diff_ij = diff_i*diff_j
      
                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+ &
                        r2*diff_ij/(diff_i+diff_j)
      
                  elseif(type_averaging_De.eq.'arithmetic')then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                     (diff_i + diff_j)*rhalf
      
                  elseif(type_averaging_De.eq.'no averaging')then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                     (diff_i/dely_i) 
                  endif
                
                endif
             end do                         ! loop over free species
             
                do ix =1,nx                 ! loop over secondary species
                    !cmx  adding modification factor for effective porosity calculation
                if (hmulti_diff .eqv. .true. ) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
 !                    epor_i = por_i*f_epor(ic)
                     epor_i = por_i*f_epor_ss(ix,izn)
                     epor_j = por_j*f_epor_ss(ix,jzn)
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ss(ix,izn)
                     etau_j = tau_j*f_etau_ss(ix,jzn)
                     
                     satav=min(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ix(ix),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
      
                     satav=min(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ix(ix),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                     
               else                 

                     satav=min(r1, sanew(ivol))  
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ix(ix),satav,por_i,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_i,type_tortuosity,          &
                                       marchies(ivol),so_av)
      
                    satav=min(r1, sanew(jvol))  
                    so_av=dmin1(r1, sonew(jvol))
                    diff_j = diffcoff(mdiff_ix(ix),satav,por_j,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                end if

                diff_ij = diff_i*diff_j

                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                    mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+    &
                        r2*diff_ij/(diff_i+diff_j)
      
                  elseif(type_averaging_De.eq.'arithmetic')then
                    mdiff_ix_cvol(ix, jtemp) = mdiff_ix_cvol(ix, jtemp)+ &
                     (diff_i + diff_j)*rhalf
      
                  elseif(type_averaging_De.eq.'no averaging')then
                    mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+  &
                     (diff_i/dely_i)
                  endif
                
                endif
             end do                         ! loop over secondary species
  !cprovi------------------------------------------------                        
                
                jtemp = jtemp+1
                
              end if

              if (ivyn.le.nvy) then         !back connection (5)
                if (half_cells) then        !half cells on boundary
                  if (ivyngbl.eq.nvygbl) then
                    dely_j = dely(ivyngbl)
                  elseif (ivyngbl.lt.nvygbl) then
                    dely_j = rhalf*dely(ivyngbl)
                  end if
                else                        !full cells on boundary
                  dely_j = rhalf*dely(ivyngbl)
                end if                      !(half_cells)
                
                jvol = ja(jtemp)
                jzn = mprop(jvol)             
                por_j = pornew(jvol)
                
                if (assigned_tau) then
                 tau_j = tau(jvol)*tau_fac(jvol)          ! assign tortuosity
                end if
                
  !cprovi------------------------------------------------    
                do ic =1,nc
                    !cmx  adding modification factor for effective porosity calculation
                  if (hmulti_diff .or. (epor_diff .eqv. .true. .and. por_i .lt. 0.3 .and.  por_j .lt. 0.3)) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
 !                    epor_i = por_i*f_epor(ic)
                     epor_i = por_i*f_epor_ps(ic,izn)
                     epor_j = por_j*f_epor_ps(ic,jzn)
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ps(ic,izn)
                     etau_j = tau_j*f_etau_ps(ic,jzn)
                     satav=dmin1(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
                     satav=dmin1(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ic(ic),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                   else
!cmx 

                     satav=min(r1, sanew(ivol)) 
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,por_i,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_i,type_tortuosity,          &
                                       marchies(ivol),so_av)
      
                    satav=min(r1, sanew(jvol)) 
                    so_av=dmin1(r1, sonew(jvol))
                    diff_j = diffcoff(mdiff_ic(ic),satav,por_j,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                  end if
      
                  diff_ij = diff_i*diff_j
      
                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                        r2*diff_ij/(diff_i+diff_j)
      
                  elseif(type_averaging_De.eq.'arithmetic')then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                     (diff_i + diff_j)*rhalf
      
                  elseif(type_averaging_De.eq.'no averaging')then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+ &
                     (diff_i/dely_i)
                  endif
                
                endif
             end do                         ! loop over free species
                       
                         
             do ix =1,nx                ! loop over secondary species
                 !cmx  adding modification factor for effective porosity calculation
                if (hmulti_diff .eqv. .true. ) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
 !                    epor_i = por_i*f_epor(ic)
                     epor_i = por_i*f_epor_ss(ix,izn)
                     epor_j = por_j*f_epor_ss(ix,jzn)
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ss(ix,izn)
                     etau_j = tau_j*f_etau_ss(ix,jzn)
                     
                     satav=min(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ix(ix),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
      
                     satav=min(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ix(ix),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                     
                else

                     satav=min(r1, sanew(ivol))  
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ix(ix),satav,por_i,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_i,type_tortuosity,          &
                                       marchies(ivol),so_av)
      
                    satav=min(r1, sanew(jvol))  
                    so_av=dmin1(r1, sonew(jvol))
                    diff_j = diffcoff(mdiff_ix(ix),satav,por_j,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                end if

                diff_ij = diff_i*diff_j

                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                    mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+    &
                        r2*diff_ij/(diff_i+diff_j)
      
                  elseif(type_averaging_De.eq.'arithmetic')then
                    mdiff_ix_cvol(ix, jtemp) =  mdiff_ix_cvol(ix, jtemp)+    &
                     (diff_i + diff_j)*rhalf
      
                  elseif(type_averaging_De.eq.'no averaging')then
                    mdiff_ix_cvol(ix, jtemp) = mdiff_ix_cvol(ix, jtemp)+    &
                     (diff_i/dely_i) 
                  endif
                
                endif
             end do                         ! loop over secondary species
                         
  !cprovi------------------------------------------------                                                       

                jtemp = jtemp+1
                
              end if

            endif                          !connections in y-direction

!c   calculate influence coefficients in z-direction

            if (nvz.gt.1) then              !connections in z-direction
              if (ivzp.gt.0) then           !bottom connection (6)
                if (half_cells) then        !half cells on boundary
                  if (ivzpgbl.eq.1) then
                    delz_j = delz(ivzpgbl)
                  elseif (ivzpgbl.gt.1) then
                    delz_j = rhalf*delz(ivzpgbl)       
                  end if
                else                        !full cells on boundary
                  delz_j = rhalf*delz(ivzpgbl)       
                end if                      !(half_cells)
                
                jvol = ja(jtemp)
                jzn = mprop(jvol)
                por_j = pornew(jvol)
                
                if (assigned_tau) then
                 tau_j = tau(jvol)*tau_fac(jvol)          ! assign tortuosity
                end if
                

  !cprovi------------------------------------------------ 
                  
             do ic =1,nc
    !cmx  adding modification factor for effective porosity calculation
                 if (hmulti_diff .or. (epor_diff .eqv. .true. .and. por_i .lt. 0.3 .and.  por_j .lt. 0.3)) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
                     epor_i = por_i*f_epor_ps(ic,izn)
                     epor_j = por_j*f_epor_ps(ic,jzn)
                     
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ps(ic,izn)
                     etau_j = tau_j*f_etau_ps(ic,jzn)

                     satav=dmin1(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
                     satav=dmin1(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ic(ic),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                 else
!cmx 
                     satav=min(r1, sanew(ivol))  
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,por_i,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_i,type_tortuosity,          &
                                       marchies(ivol),so_av)
      
                    satav=min(r1, sanew(jvol))
                    so_av=dmin1(r1, sonew(jvol))
                    diff_j = diffcoff(mdiff_ic(ic),satav,por_j,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                end if
                
                diff_ij = diff_i*diff_j
      
                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                        r2*diff_ij/(diff_i+diff_j)
                  elseif(type_averaging_De.eq.'arithmetic')then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                     (diff_i + diff_j)*rhalf
                  elseif(type_averaging_De.eq.'no averaging')then
                    mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                     (diff_i/delz_i)
                  endif
                
                endif
             end do                         ! loop over free species
      
             do ix =1,nx                    ! loop over secondary species
    !cmx  adding modification factor for effective porosity calculation
        if (hmulti_diff .eqv. .true. ) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
 !                    epor_i = por_i*f_epor(ic)
                     epor_i = por_i*f_epor_ss(ix,izn)
                     epor_j = por_j*f_epor_ss(ix,jzn)
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ss(ix,izn)
                     etau_j = tau_j*f_etau_ss(ix,jzn)
                     
                     satav=min(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ix(ix),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
      
                     satav=min(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ix(ix),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                     
               else

                     satav=min(r1, sanew(ivol)) 
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ix(ix),satav,por_i,       &
                                       tortuosity_corr,assigned_tau,    &
                                       tau_i,type_tortuosity,          &
                                       marchies(ivol),so_av)
      
                    satav=min(r1, sanew(jvol))
                    so_av=dmin1(r1, sonew(jvol))
                    diff_j = diffcoff(mdiff_ix(ix),satav,por_j,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                end if
                
                diff_ij = diff_i*diff_j

                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                    mdiff_ix_cvol(ix, jtemp) =mdiff_ix_cvol(ix, jtemp)+    &
                        r2*diff_ij/(diff_i+diff_j)
      
                  elseif(type_averaging_De.eq.'arithmetic')then
                   mdiff_ix_cvol(ix, jtemp) = mdiff_ix_cvol(ix, jtemp)+    &
                     (diff_i + diff_j)*rhalf
      
                  elseif(type_averaging_De.eq.'no averaging')then
                   mdiff_ix_cvol(ix, jtemp) =  mdiff_ix_cvol(ix, jtemp)+    &
                     (diff_i/delz_i)
                  endif
                
                endif
             end do                        ! loop over secondary species
             
  !cprovi------------------------------------------------                       

                jtemp = jtemp+1
                
              end if

              if (ivzn.le.nvz) then         !top connection (7)
                if (half_cells) then        !half cells on boundary
                  if (ivzngbl.eq.nvzgbl) then
                    delz_j = delz(ivzngbl)
                  elseif (ivzngbl.lt.nvzgbl) then
                    delz_j = rhalf*delz(ivzngbl)
                  end if
                else                        !full cells on boundary
                  delz_j = rhalf*delz(ivzngbl)
                end if                      !(half_cells)
                
                jvol = ja(jtemp)
                jzn = mprop(jvol)
                por_j = pornew(jvol)
                
                if (assigned_tau) then
                 tau_j = tau(jvol)*tau_fac(jvol)          ! assign tortuosity
                end if

  !cprovi------------------------------------------------                    
             do ic =1,nc
            !cmx  adding modification factor for effective porosity calculation
                 if (hmulti_diff .or. (epor_diff .eqv. .true. .and. por_i .lt. 0.3 .and.  por_j .lt. 0.3)) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
                     epor_i = por_i*f_epor_ps(ic,izn)
                     epor_j = por_j*f_epor_ps(ic,jzn)
                     
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ps(ic,izn)
                     etau_j = tau_j*f_etau_ps(ic,jzn)

                     satav=dmin1(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
                     
                     satav=dmin1(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ic(ic),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                 else
!cmx 
                     satav=min(r1, sanew(ivol))  
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ic(ic),satav,por_i,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_i,type_tortuosity,          &
                                       marchies(ivol),so_av)
      
                    satav=min(r1, sanew(jvol))
                    so_av=dmin1(r1, sonew(jvol))
                    diff_j = diffcoff(mdiff_ic(ic),satav,por_j,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                  end if
                
                diff_ij = diff_i*diff_j
      
                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                  mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                        r2*diff_ij/(diff_i+diff_j)
      
                  elseif(type_averaging_De.eq.'arithmetic')then
                  mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                     (diff_i + diff_j)*rhalf
      
                  elseif(type_averaging_De.eq.'no averaging')then
                  mdiff_ic_cvol(ic, jtemp) =mdiff_ic_cvol(ic, jtemp)+    &
                     (diff_i/delz_i)
                  endif
                
                endif
             end do                         ! loop over free species
      
             do ix =1,nx                    ! loop over secondary species
                 !cmx  adding modification factor for effective porosity calculation
                if (hmulti_diff .eqv. .true. ) then
                     epor_i = 0.0d0
                     epor_j = 0.0d0
                     izn = mprop(ivol)
                     jzn = mprop(jvol)
 !                    epor_i = por_i*f_epor(ic)
                     epor_i = por_i*f_epor_ss(ix,izn)
                     epor_j = por_j*f_epor_ss(ix,jzn)
                     etau_i = 0.0d0
                     etau_j = 0.0d0
                     etau_i = tau_i*f_etau_ss(ix,izn)
                     etau_j = tau_j*f_etau_ss(ix,jzn)
                     
                     satav=min(r1, sanew(ivol))
                     so_av=dmin1(r1, sonew(ivol))
                     
                     diff_i = diffcoff(mdiff_ix(ix),satav,epor_i,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_i,type_tortuosity,         &
                                       marchies(ivol),so_av)
      
                     satav=min(r1, sanew(jvol))
                     so_av=dmin1(r1, sonew(jvol))
                     diff_j = diffcoff(mdiff_ix(ix),satav,epor_j,      &
                                       tortuosity_corr,assigned_tau,   &
                                       etau_j,type_tortuosity,         &
                                       marchies(jvol),so_av)
                     
               else

                     satav=min(r1, sanew(ivol))   
                     so_av=dmin1(r1, sonew(ivol))
                     diff_i = diffcoff(mdiff_ix(ix),satav,por_i,       &
                                       tortuosity_corr,assigned_tau,   &
                                       tau_i,type_tortuosity,          &
                                       marchies(ivol),so_av)
      
                    satav=min(r1, sanew(jvol))
                    so_av=dmin1(r1, sonew(jvol))
                    diff_j = diffcoff(mdiff_ix(ix),satav,por_j,        &
                                      tortuosity_corr,assigned_tau,    &
                                      tau_j,type_tortuosity,           &
                                      marchies(jvol),so_av)
                end if
                
                diff_ij = diff_i*diff_j

                if(diff_ij.gt.0.0) then
                  
                  if (type_averaging_De.eq.'harmonic') then
                    mdiff_ix_cvol(ix, jtemp) = mdiff_ix_cvol(ix, jtemp)+ &
                        r2*diff_ij/(diff_i+diff_j)
                  elseif(type_averaging_De.eq.'arithmetic')then
                    mdiff_ix_cvol(ix, jtemp) = mdiff_ix_cvol(ix, jtemp)+ &
                     (diff_i + diff_j)*rhalf
                  elseif(type_averaging_De.eq.'no averaging')then
                    mdiff_ix_cvol(ix, jtemp) = mdiff_ix_cvol(ix, jtemp)+ &
                     (diff_i/delz_i)
                  endif
                
                endif
             end do                        ! loop over secondary species
  !cprovi------------------------------------------------                   
                
                

                jtemp = jtemp+1

                      
              end if
            end if                          ! connections in z-direction
 
    
         
          end do                            ! number of increments in x
        end do                              ! number of increments in y
      end do                                ! number of increments in z
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif       
      
!      do ivol=1,nngl
!        do ic = 1,nc  
!           write(idbg,*)'ivol,ic,mdiff_ic_cvol',
!     &                     ivol,ic,mdiff_ic_cvol(ic, ivol)
!        end do
!      end do    
!      
!      write(idbg,*) 'wrote to dbg from diffcof_mcd.f'   

      return
      end