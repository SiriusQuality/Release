!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/vapor_prop.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!cprovi----------------------------------------------------------------------
!cprovi subroutine vapor_prop
!cprovi 
!cprovi Compute the saturated vapour density
!cprovi
!cprovi Constant for saturated vapour density 
!cprovi See Saito et al. (2006) equation 17 
!cprovi 
!cprovi Saito, H.; Simunek, J. & Mohanty, B. 
!cprovi Numerical analyses of coupled water, vapor and heat transport 
!cprovi in the vadose zone. Vadose Zone Journal, 2006, 5, 784-800
!cprovi 
!cprovi For default, vapour density is compute as 
!cprovi Edlefson and Anderson, 1943; Sprackling, 1985). It was implemented
!cprovi in CODE-BRIGHT (e.g. see Olivella et al., 1994)
!c ----------------------------------------------------------------------
subroutine vapor_prop (densv_ivol,pv_ivol,ddensvdpa_ivol,ddensvdt_ivol,latvap_ivol,temp_ivol,pgas_ivol, &
                       pliq_ivol,actw,densliq_ivol,ivol)
                       
                       
use parm
use gen
use dens
use phys
use chem       
      
implicit none 
      
real*8, intent(in)             :: temp_ivol        ! temperature [oC]

real*8, intent(in)             :: pgas_ivol        ! Gas pressure 

real*8, intent(in)             :: pliq_ivol        ! Liquid pressure 

real*8, intent(in)             :: actw             ! Water activity 

real*8, intent(in)             :: densliq_ivol     ! Liquid density 

real*8, intent(out)            :: densv_ivol       ! Vapour density 

real*8, intent(out)            :: ddensvdpa_ivol   ! Derivative of the vapour density with respect to liquid pressure

real*8, intent(out)            :: ddensvdt_ivol    ! Derivative of the vapour density with respect to temperature 

real*8, intent(out)            :: latvap_ivol

real*8, intent(out)            :: pv_ivol

integer, intent(in)            :: ivol 
                  
real*8, parameter      :: r1=1.0d0, &
                          r2=2.0d0, &
                          r0=0.0d0, &
                          rkelvin=273.15d0, &
                          r103=1.0d3, &
                          r104=1.0d4, &
                          r102=1.0d2, &
                          r106=1.0d6, &
                          dtempinc=1.0d0, &
                          dpliqinc=-1.0d0, &
                          mw_cte = 0.0180153d0, &
                          !rgas_cte = 8.3144621d0 
                          rgas_cte = 8.3145d0
                          
                          
real*8                 :: term2, &
                          term3, &
                          term4, &
                          term5, &
                          tempkloc, &
                          rtempk, &
                          exp1, &
                          exp2, &
                          rtempkdens, & 
                          pvinc, &
                          mw_loc, &
                          rgas_loc, &
                          hr, &
                          pliqinc, &
                          tempinc, &
                          densvinc, &
                          densliqinc, &
                          rhonew, &
                          dp                                   
 
ddensvdpa_ivol=r0
ddensvdt_ivol=r0
pv_ivol = r0
densliqinc = r0

if (reactive_transport) then  
  mw_loc = gfwc(nc)/r103
  rgas_loc = rgasjoule
else
  mw_loc = mw_cte
  rgas_loc = rgas_cte
end if

tempkloc = rkelvin + temp_ivol 
!cprovi---------------------------------------------------------------------
!cprovi Compute the latent heat vaporization of liquid water
!cprovi---------------------------------------------------------------------
latvap_ivol = (clatvap1 - clatvap2*temp_ivol)/r103
!cprovi---------------------------------------------------------------------
!cprovi Compute the vapor density
!cprovi---------------------------------------------------------------------
select case (densv_model)

case ('saito')
 
!cprovi---------------------------------------------------------------------
!cprovi Compute the relative humidity as a function of liquid pressure and 
!cprovi temperature 
!cprovi (see Philip and Vries, 1957, o Saito et al. (2006))
!cprovi---------------------------------------------------------------------   
if (iscapcorr) then
  dp = pgas_ivol-pliq_ivol
  hr = dexp(-dp*mw_loc/(densliq_ivol*rgas_loc*tempkloc))
else
  hr = r1
end if 
!cprovi---------------------------------------------------------------------
!cprovi Compute the saturated vapour density
!cpvori (see Saito et al. (2006))
!cprovi---------------------------------------------------------------------    
 term2 = cdensv2-(cdensv3/tempkloc)-cdensv4*tempkloc
 densv_ivol = hr * actw * cdensv1 * dexp(term2)/tempkloc 
!cprovi---------------------------------------------------------------------   
!cprovi Compute derivative of vapour density with respect to liquid pressure
!cprovi---------------------------------------------------------------------   
!cprovi------------------------------------------------------------------- 
!cprovi Compute derivatives with respect to liquid pressure
!cprovi-------------------------------------------------------------------  
pliqinc = pliq_ivol + dpliqinc
!cprovi------------------------------------------------------------------- 
!cprovi Capilarity correction 
!cprovi------------------------------------------------------------------- 
if (iscapcorr) then
  dp = pgas_ivol-pliqinc
  hr = dexp(-dp*mw_loc/(densliq_ivol*rgas_loc*tempkloc))
else
  hr = r1
end if
densvinc = hr * actw * cdensv1 * dexp(term2)/tempkloc

ddensvdpa_ivol = (densvinc-densv_ivol)/dpliqinc 
!cprovi---------------------------------------------------------------------
!cprovi Compute derivative of vapour density with respect to temperature    
!cprovi---------------------------------------------------------------------
tempinc = temp_ivol + dtempinc
tempkloc = rkelvin + tempinc 
if (ivol>0) then  
    if (ispitzerdens) then 
        densliqinc = rhonew(ref_dens,density_pitzer(ivol),ref_dens,  &
                            tempinc,tempref_dens,r1,drho_dt,nonlindens_heat, &
                            cdens1,cdens2,cdens3,cdens4)
    else
        densliqinc = rhonew(ref_dens,tds_new(ivol),ref_tds, &
                            tempinc,tempref_dens,drho_dc,drho_dt,nonlindens_heat, &
                            cdens1,cdens2,cdens3,cdens4)
    end if
end if
if (iscapcorr) then
  dp = pgas_ivol-pliq_ivol
  hr = dexp(-dp*mw_loc/(densliqinc*rgas_loc*tempkloc))
else
  hr = r1
end if 
!cprovi---------------------------------------------------------------------
!cprovi Compute the saturated vapour density
!cpvori (see Saito et al. (2006))
!cprovi---------------------------------------------------------------------    
 term2 = cdensv2-(cdensv3/tempkloc)-cdensv4*tempkloc
 densvinc = hr * actw * cdensv1 * dexp(term2)/tempkloc
 ddensvdt_ivol = (densvinc-densv_ivol)/dtempinc 
 

case default  

!cprovi---------------------------------------------------------------------
!cprovi Vapour density versus capillary pressure 
!cprovi (See Edlefson and Anderson, 1943; Sprackling, 1985))
!cprovi Vapour density model implemented in CODE-BRIGHT
!cprovi See also Saaltink, M. W.; Ayora, C. & Olivella, S. 
!cprovi User's guide for RetrasoCodeBright (RCB) 2005
!cprovi---------------------------------------------------------------------
  rtempk = rgas_loc*tempkloc 
!cprovi------------------------------------------------------------------- 
!cprovi   
!cprovi------------------------------------------------------------------- 
  rtempkdens = rtempk*densliq_ivol
!cprovi------------------------------------------------------------------- 
!cprovi Capilarity correction 
!cprovi------------------------------------------------------------------- 
  if (iscapcorr) then
    dp = pgas_ivol-pliq_ivol
    exp1 = dexp(-dp*mw_loc/rtempkdens)
  else
    exp1 = r1
  end if
  
  exp2 = dexp(-cdensv6/tempkloc)

  pv_ivol = cdensv5 * actw * exp2 * r106

  densv_ivol = mw_loc*pv_ivol*exp1/rtempk
 !cprovi------------------------------------------------------------------- 
 !cprovi Compute derivatives with respect to liquid pressure
 !cprovi-------------------------------------------------------------------  
  pliqinc = pliq_ivol + dpliqinc
 !cprovi------------------------------------------------------------------- 
 !cprovi Capilarity correction 
 !cprovi------------------------------------------------------------------- 
  if (iscapcorr) then
   dp = pgas_ivol-pliqinc
   exp1 = dexp(-dp*mw_loc/rtempkdens)
  else
   exp1 = r1
  end if
  
  densvinc = mw_loc*pv_ivol*exp1/rtempk
  
  ddensvdpa_ivol = (densvinc-densv_ivol)/dpliqinc   
  !cprovi-------------------------------------------------------------------
  !cprovi Compute derivatives with respect to temperature 
  !cprovi-------------------------------------------------------------------
  tempinc = temp_ivol + dtempinc
  
  tempkloc = rkelvin + tempinc
  rtempk = rgas_loc*tempkloc
  if (ivol>0) then  
    if (ispitzerdens) then 
        densliqinc = rhonew(ref_dens,density_pitzer(ivol),ref_dens,  &
                            tempinc,tempref_dens,r1,drho_dt,nonlindens_heat, &
                            cdens1,cdens2,cdens3,cdens4)
    else
        densliqinc = rhonew(ref_dens,tds_new(ivol),ref_tds, &
                            tempinc,tempref_dens,drho_dc,drho_dt,nonlindens_heat, &
                            cdens1,cdens2,cdens3,cdens4)
    end if
  end if
  
  rtempkdens = rtempk*densliqinc
 !cprovi------------------------------------------------------------------- 
 !cprovi Capilarity correction 
 !cprovi------------------------------------------------------------------- 
  if (iscapcorr) then
   dp = pgas_ivol-pliq_ivol
   exp1 = dexp(-dp*mw_loc/rtempkdens)
  else
   exp1 = r1
  end if
    
  exp2 = dexp(-cdensv6/tempkloc)

  pvinc = cdensv5 * actw * exp2 * r106

  densvinc = mw_loc*pvinc*exp1/rtempk 
  
  ddensvdt_ivol = (densvinc-densv_ivol)/dtempinc
  
  
  
  

end select
   
return
end
