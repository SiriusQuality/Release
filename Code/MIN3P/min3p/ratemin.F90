!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/ratemin.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine ratemin
!c ------------------
!c
!c compute absolute dissolution-precipitation rates of minerals
!c
!c sign convention: dissolution -
!c                  precipitation +
!c
!c written by:      Uli Mayer - February 8, 96
!c
!c last modified:   THH March 18, 2005 
!c                  line 301 form ratenew
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           gammax(nx)         = activity coefficient of             + -
!c                                secondary aqueous species
!c           phim               = volume fractions of minerals        + -
!c           phimold            = volume fractions of minerals        + -
!c                                - old time level
!c           ratem              = absolute dissolution-precipitation  * +
!c                                rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(nc)           = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/l h2o]
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           diffm(ndr*nm)      = free diffusion coefficient of       + -
!c                                primary reactant in water
!c                                (transport controlled reactions)
!c           eqm(nm,nthreads)            = equilibrium constants for minerals  + -
!c           fmdi(nrc*nm)       = inhibition factors                  + - 
!c           fmdm(nrc*nm)       = monod factors                       + -
!c           orddc(nrc*nm)      = order of free species in            + -
!c                                dissolution reaction
!c           orddcx(nrc*nm)     = order of secondary aqueous          + -
!c                                species in dissolution reaction
!c           orddt(nrc*nm)      = order of total aqueous component    + -
!c                                concentration in dissolution
!c                                reaction
!c           ordmdm(nrc*nm)     = order of monod terms for            + -
!c                                dissolution-precipitation reactions
!c           ordm(ndr*nm)       = exponent m for reaction rate law    + -
!c           ordn(ndr*nm)       = exponent n for reaction rate law    + -
!c           rated(ndr*nm,nthreads)      
!c                              = rate constants for dissolution      + -
!c                                reactions
!c           ratemp(ndr*nm,nthreads)
!c                              = reaction rates for minerals         * +
!c                                including parallel reactions
!c           satm(nm,nthreads)  = saturation indices                  * +
!c           xnud(ndr*nm)       = stoichiometric coefficients of      + -
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of      + +
!c                                components in mineral
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution        + -
!c                                reactions
!c           iamdc(ndr*nm+1)    = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamdc(nrc*nm)      = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           jamdm(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           jamdt(nrc*nm)      = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c           nx                 = number of aqueous complexes         + -
!c
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c
!c           character:
!c           ----------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = product of reacting species
!c           termmdm            = monod terms
!c           termmdi            = inhibition and toxicity terms
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter
!c           istart             = pointer (start of reaction set) 
!c           istop              = pointer (end of reaction set)
!c           ireac              = counter (number of dissolution/ 
!c                                         precipitation reactions)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueosu species)
!c
!c external: raoult   = compute dissolution rate of organic compound
!c                      from organic mixture based on raoult's law
!c ----------------------------------------------------------------------
  
      subroutine ratemin(totc,c,cx,gammac,gammax,ratem,phim,          &
                        phimold,aream,im)
 
      use parm
      use chem
#ifdef OPENMP
      use omp_lib 
#endif 
 
      implicit none
      
      real*8 :: totc, c, cx, gammac, gammax, ratem, phim, phimold, aream
      integer :: im
      
      integer :: tid, i1, ic, ireac, istart, istop, istart2, istop2,   &
                 ix, info_debug
      
      real*8 :: r1_iap_k, prodrc, prodrcinc, termmdm, termmdi

      dimension c(*),cx(*),gammac(*),gammax(*),totc(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      
      !This is not needed when interface is declared
      !external raoult
      
      !For the shared-memory parallel version, the variables defined in the module
      !are shared variables by different threads. So as to avoid race condition, 
      !these variable should be passed by dummy arguments. Danyang Su, 2013-05.
      interface
        subroutine raoult(c,gammac,ratem,phim,phimold,aream,im)
          use parm, only: type_i4, type_r8
          integer(type_i4) :: im
          real(type_r8), dimension(*) :: c
          real(type_r8), dimension(*) :: gammac
          real(type_r8) :: ratem
          real(type_r8) :: phim
          real(type_r8) :: phimold
          real(type_r8) :: aream
        end subroutine
      end interface
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
      
      r1_iap_k = 0.0d0
      termmdm = 0.0d0
      termmdi = 0.0d0

!c  compute dissolution rate for organic compound based on Raoult's law


      if (reaction_type(im).eq.'raoult') then

        call raoult(c,gammac,ratem,phim,phimold,aream,im)
        return

      end if

!c  initialize total reaction rate

      ratem = r0

!c  initialize parallel reaction rates

      istart = iamd(im)
      istop = iamd(im+1)-1

      do ireac = istart,istop
        ratemp(ireac,tid) = r0
      end do

!c  calculate saturation index for current mineral except for
!c  far from equilibrium dissolution-precipitation reactions

      if (.not.far_from_equil(im)) then

        satm(im,tid) = eqm(im,tid)**(-r1)

        istart = iam(im)
        istop = iam(im+1)-1
        do i1 = istart,istop
          ic = jam(i1)
          satm(im,tid) = satm(im,tid) * (gammac(ic)*c(ic))**xnum(i1)
        end do

      end if

!c  compute total dissolution/precipitation rate for surface controlled
!c  dissolution/precipitation reactions

      if (rate_control(im).eq.'surface') then

!c  compute rates only for specified reaction direction

        if (reaction_type(im).eq.'reversible' .or.                    &
     &     reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
     &     (reaction_type(im).eq.'dissolution_to_equilibrium'.and.    &
     &     r1-satm(im,tid).gt.r0) .or.                                &
     &     reaction_type(im).eq.                                      &
     &     'precipitation_far_from_equilibrium' .or.                  &
     &     (reaction_type(im).eq.'precipitation_to_equilibrium'.and.  &
     &     r1-satm(im,tid).lt.r0).or.                                 &
     &     reaction_type(im).eq.'monod') then

!c  compute monod and inhibition terms, if applicable

          if (reaction_type(im).eq.'monod') then

!c  fractional order terms


!c  monod terms

            istart2 = iamdm(im)
            istop2 = iamdm(im+1)-1
            termmdm = r1
      
            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdm(i1)

                termmdm = termmdm                                     &
     &                  * (totc(ic)/(fmdm(i1) + totc(ic)))**ordmdm(i1)

              end do

            end if

!c  inhibition terms

            istart2 = iamdi(im)
            istop2 = iamdi(im+1)-1
            termmdi = r1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdi(i1)

                termmdi = termmdi * fmdi(i1)/(fmdi(i1)+totc(ic))

              end do

            end if

!c  affinity term

          end if       !(reaction_type(im).eq.'monod')

!c  loop over parallel dissolution reactions

          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop
  
!c  scale reaction rate depending on equilibrium condition except
!c  for far-from-equilibrium reactions 

            if (reaction_type(im).eq.                                 &
     &          'dissolution_far_from_equilibrium'.or.                &
     &           reaction_type(im).eq.'monod') then
                                                                       
              prodrc = -rated(ireac,tid)
                                                                       
            elseif (reaction_type(im).eq.                             &
     &             'precipitation_far_from_equilibrium') then

              prodrc = rated(ireac,tid)

            else

!c THH lattice edits
!c  commented out to avoid NaN problems              
             !prodrc = -rated(ireac)                                     &
             !       * (r1 - satm(im)**ordm(ireac))**ordn(ireac)
             !
             ! if(isnan(prodrc)) then
             !     write(*,*) "prodrc is nan3: ", r1 - satm(im)**ordm(ireac),  ordn(ireac)
             ! end if
             
             !Lasaga et al. (1994) equation. dsu, 2012-12-20
             
             if (b_ratelaw_exponent_n) then
                 r1_iap_k = r1 - satm(im,tid)**ordm(ireac)
                 if (r1_iap_k > 0) then
                     if (reaction_type(im) == 'precipitation_to_equilibrium') then
                         prodrc = 0.0d0
                     else
                         prodrc = -rated(ireac,tid) *                 &
                                  r1_iap_k**ordn(ireac)
                     end if
                 else
                     if (reaction_type(im) == 'dissolution_to_equilibrium') then
                         prodrc = 0.0d0
                     else
                         prodrc = rated(ireac,tid) *                  &
                                  (abs(r1_iap_k))**ordn(ireac)
                     end if
                 end if               
             else
                 prodrc = -rated(ireac,tid) *                         &
                          (r1 - (satm(im,tid)**ordm(ireac)))
             end if 
             
     !--old--
     !         prodrc = -rated(ireac)                                  &
     !&               * (r1 - (satm(im)**ordm(ireac)))

            end if

!c  form product of reacting components in terms of total 
!c  aqueous component concentrations

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdt(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then
                prodrc = prodrc                                       &
     &                 * (totc(ic)/(totc(ic)+ordm(ireac)))**ordn(ireac)
              end if

              prodrc = prodrc * totc(ic)**orddt(i1)

            end do

!c  form product of reacting components as species in solution

            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdc(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then
                prodrc = prodrc * (gammac(ic)*c(ic) /                 &
     &                   (gammac(ic)*c(ic)+ordm(ireac)))**ordn(ireac)
              end if

              prodrc = prodrc * (gammac(ic)*c(ic))**orddc(i1)

            end do

!c  form product of reacting complexed species

            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1

            do i1 = istart2,istop2

              ix = jamdcx(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then
                prodrc = prodrc * (gammax(ix)*cx(ix) /                &
     &                   (gammax(ix)*cx(ix)+ordm(ireac)))**ordn(ireac)
              end if

              prodrc = prodrc * (gammax(ix)*cx(ix))**orddcx(i1)
            end do

!c  compute total rate for surface controlled reactions
!c  [moles/(l bulk*day)] = [m^2 mineral/l bulk]
!c                          ----------- 
!c                       * [moles/(m^2 mineral * day)]
!c                                 -----------

            ratemp(ireac,tid) = aream * prodrc

!c  include monod and inhibition terms, if applicable

            if (reaction_type(im).eq.'monod') then

              ratemp(ireac,tid) = ratemp(ireac,tid) * termmdm *       &
                                  termmdi

            end if

!c  sum up parallel reaction rates for surface controlled
!c  dissolution/precipitation reactions

            ratem = ratem + ratemp(ireac,tid)

          end do       !loop over parallel diss/prec reactions

        else           !reaction_type

          ratem = r0
 
        end if         !reaction_type

!c  compute total dissolution rate for transport 
!c  controlled dissolution reactions

      elseif (rate_control(im).eq.'transport') then

        if (reaction_type(im).eq.                                     &
            'dissolution_far_from_equilibrium'.or.                    &
     &      reaction_type(im).eq.'reversible'.or.                     &
     &      (reaction_type(im).eq.'dissolution_to_equilibrium'.and.   &
     &       r1-satm(im,tid).gt.r0)) then

!c  compute total dissolution rate 
 
          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop

!c  scale reaction rate, if dissolution reaction is limited by
!c  equilibrium conditions 

            if (far_from_equil(im)) then
              prodrc = r1
            else
              prodrc = r1-satm(im,tid) 
            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
            end do

!c  form product of reacting component species for current dissolution
!c  reaction, activity coefficients are here not considered explicitely,
!c  but are by definition included in the effective diffusion coefficient
 
            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdc(i1)
              prodrc = prodrc * c(ic)**orddc(i1)
            end do
 
!c  include complexed species in product of reacting species for current
!c  dissolution reaction
 
            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1
            do i1 = istart2,istop2
              ix = jamdcx(i1)
              prodrc = prodrc * cx(ix)**orddcx(i1)
            end do
 
!c  compute rate
!c  [moles/(l bulk*day)] = [m mineral / m^3 bulk]
!c                          ---------   ---
!c                       * [m^3 h2o/m^3 mineral * m^2 mineral/day]
!c                          --- --- -----------   -----------
!c                       * [moles/l h2o]
!c                                  ---

            ratemp(ireac,tid) = - aream * diffm(ireac)/xnud(ireac)    &
     &                    * prodrc

!c  sum up parallel rates

            ratem = ratem + ratemp(ireac,tid)

          end do  
 
!c  set reaction rate to zero for all other conditions
 
        else

          ratem = r0
 
        end if          !(reaction_type(im))

      end if            !(rate_control(im))
 
!cdbg
      info_debug = 0
      if (info_debug.gt.0) then
        write(*,'(a,e12.5)') 'ratem = ',ratem
        write(*,'(a,e12.5)') 'phim = ', phim
        write(*,'(a,e12.5)') 'phimold = ', phimold
        write(*,'(a,e12.5)') 'aream = ', aream
      end if
      if (info_debug.eq.1) then
        !pause
      end if
!cdbg

      return
      end
