!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/bbls.F90 $
!---------------------------------------------------------------------
!********************************************************************!
    
module bbls
    
    use parm

!c---------------------------------------------------------------------- 
!c Variables for bubble problem
!c
!c written by:      Rich Amos - June 23, 2003
!c
!c last modified:   Rich Amos - March 28, 2004 
!c
!c Variable definitions
!c
!c     real*8
!c     ------
!c     tot_gas(ng,ivol)     = total concentration of gas in
!c                        the aqueous and gas phases
!c    k_henry(ig,ivol) = henry's law constant for gas(i)->gas pair(i)
!c     sanew_b(nn)         = water saturation prior to reactran and gasbub
!c                        for convergence check of outer bubble loop
!c     sanew_c(nn)      = sanew prior to gasbub for non-gas component update and
!c                        relaxation scheme
!c     uvsnew_b(nn)     = solution vector prior to reactran and gasbub 
!c                         fot convergence check of outer bubble loop
!c    aqueous_gas(ig)  = concentration of gas pair in the aqueous phase
!c                       (either as a component or a secondary species)
!c                       (mole/L)
!c    c_update(nc,nn)     = component concentration at previous inner
!c                       bubble iteration. 
!c     bub_tol          = convergance tolerance for inner bubble loop
!c     bubflow_tol      = convergance tolerance for outer bubble loop
!c     maxsg_update     = maximum update in gas saturation per loop
!c     gas_tol          = convergance tolerance for bubble newton loop
!c     res_tol          = residual tolerance for bubble newton loop
!c     gascon_a(ng)     = temperature dependent solubility coefficient
!c     gascon_b(ng)     = temperature dependent solubility coefficient
!c     gascon_c(ng)     = temperature dependent solubility coefficient
!c     min_to_overwrite = number of mineral to read distribution from file
!c     sa_app(nn)       = apparent saturation of water
!c     sa_eff(nn)       = effective saturation of water
!c     sg_eff(nn)       = effective saturation of gas phase
!c     sa_min(nn)       = minimum saturation of water phase prior to imbibition
!c     sgr_imbi(nzn)    = residual saturation of gas phase on main imbibition curve
!c     sgt(nn)          = trapped gas saturation
!c     sgt_old(nn)      = trapped gas saturation at old time level
!c     sg_temp(nn)      = tmeporary holder for gas phase saturation
!c     dsadt_max        = maximum rate of saturation change (del sa/day)
!c     updatefactor     = updatefactor for bubble loop relaxation scheme
!c
!c     integer
!c    -------
!c     gas_pair(ng)            = component number for
!c                              gas pair for each gas
!c    ibub                    = counter for inner bubble iteration loop
!c    ibubflow                = counter for outer bubble iteration loop
!c     maxibub                 = maximum number of inner iterations
!c     maxibubflow             = maximum number of outer iterations
!c     ivol_max                = volume with maximum chnage in gas saturation
!c
!c    logical
!c    -------
!c     gas_bubbles         =.true. -> gas phase saturation is calculated      
!c                                below the water table
!c    found_pair         =.true. -> component or species pair of gas
!c                                 found in component or species 
!c                                 array
!c    bub_not_converged        = .true.-> inner bubble loop not converged
!c     bubflow_not_converged    = .true.-> outer bubble loop not converged
!c    gas_species(ng,nx)        = .true.-> species ix has a common 
!c                              component with gas ig  
!c    update_component(nc)    = .true.-> component is an assigned gas
!c                              component or h+ and totcnew is updated in jacrt
!c                              .false.-> totcnew is not updated in jacrt
!c     double_bubble           = .true. -> double bubble iterations
!c     bubble_out              = .true. -> write bubble output file
!c     bubble_perm             = .true. -> update permeability due to change in gas 
!c                                         saturation
!c     trap_bubbles            = .true. -> calculate trapped gas saturation upon imbibition
!c     sgsolved                = .true. -> routine solvsg called and bubble size is calculated 
!c                               for at least one control volume during the bubble iteration
!c    drainage(nn)            = .true. -> drainage is occurring in volume
!c    main_drain(nn)           = .true. -> drainage is occuring on main drainage curve
!c    unsaturated(nn)          = .true. -> control volume was unsaturated during last time step
!c    big_bubble(nn)           = .true. -> bubble size was bigger than sgr when drainage began
!c     solvegb(nn)             = .true. -> gasbub calculated for this volume during this time step
!c 
!c     character
!c     ---------
!c     gas_type(ng)            = specifies temperature dependence of solubility
!c                               'type_0' enthalphy (default)              
!c                               'type_1' CRC handbook
!c                               'type_2' bunsen solubility coefficients
!c   
!c---------------------------------------------------------------------
        
    real (type_r8), allocatable :: tot_gas(:,:)
    real (type_r8), allocatable :: k_henry(:,:)
    real (type_r8), allocatable :: aqueous_gas(:)
    real (type_r8), allocatable :: uvsnew_b(:)
    real (type_r8), allocatable :: sanew_c(:)
    real (type_r8), allocatable :: sanew_b(:)
    real (type_r8), allocatable :: c_update(:,:)
    real (type_r8), allocatable :: gascon_a(:)
    real (type_r8), allocatable :: gascon_b(:)
    real (type_r8), allocatable :: gascon_c(:)
    real (type_r8), allocatable :: min_to_overwrite(:)
    real (type_r8), allocatable :: sa_app(:)
    real (type_r8), allocatable :: sa_eff(:)
    real (type_r8), allocatable :: sg_eff(:)
    real (type_r8), allocatable :: sa_min(:)
    real (type_r8), allocatable :: sa_min_old(:)
    real (type_r8), allocatable :: sgr_imbi(:)
    real (type_r8), allocatable :: sgt(:)
    real (type_r8), allocatable :: sgt_old(:)
    real (type_r8), allocatable :: sg_temp(:)

    integer (type_i4), allocatable :: gas_pair(:)

    real (type_r8):: bub_tol
    real (type_r8):: bubflow_tol
    real (type_r8):: maxsg_update
    real (type_r8):: dsadt_max
    real (type_r8):: gas_tol
    real (type_r8):: res_tol
    real (type_r8):: updatefactor
    real (type_r8):: updatefactor_old
    real (type_r8):: delsa_maxold
    real (type_r8):: gassatfact
    real (type_r8):: bub_exp
    real (type_r8):: ts_lim

    integer (type_i4) :: ibub
    integer (type_i4) :: ibubflow
    integer (type_i4) :: ivol_max
    integer (type_i4) :: maxibubflow
    integer (type_i4) :: maxibub

    logical :: gas_bubbles
    logical :: found_pair
    logical :: bub_not_converged
    logical :: bubflow_not_converged
    logical :: double_bubble
    logical :: bubble_out
    logical :: bubble_perm
    logical :: trap_bubbles    
    logical :: zero_storage
    logical :: sgsolved

    logical, allocatable :: gas_species(:,:)
    logical, allocatable :: update_component(:)
    logical, allocatable :: drainage(:)
    logical, allocatable :: main_drain(:)
    logical, allocatable :: unsaturated(:)
    logical, allocatable :: big_bubble(:)
    logical, allocatable :: big_bub_old(:)
    logical, allocatable :: solvegb(:)

    character*12, allocatable :: gas_type(:)

end module bbls
