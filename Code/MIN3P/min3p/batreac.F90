!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/batreac.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine batreac 
!c ------------------
!c
!c driver subroutine for local chemistry
!c
!c written by:      Uli Mayer - May 15, 96
!c
!c last modified:   Uli Mayer - November 18, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           porc               = porosity for local chemistry        + -
!c                                calculations
!c           sac                = air saturation for local            + -
!c                                chemistry calculations
!c           swc                = water saturation for local          + -
!c                                chemistry saturations
!c
!c common:
!c gen.f:    integer*4:
!c           ----------
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           idbg               = unit number, debugging information  + -
!c           itmp               = unit number, temporary storage      + -
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, logbook                + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           l_zone_name        = length of zone name                 * +
!c
!c
!c           logical:
!c           --------
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           section_header     = section header                      * *
!c           zone_name          = name of zone                        * +
!c
!c chem.f:   real*8:
!c           -------
!c           actv(nc)           = activities of components as species + -
!c                                in solution - new time level
!c           ccnew(nc)          = concentrations of free species      + -
!c                                - new time level [moles/l water] 
!c           ccold(nc)          = concentrations of free species      + -
!c                                - old time level [moles/l water] 
!c           cgc(ng)            = gas concentrations                  * +
!c                                - new time level [moles/l air]
!c           cxc(nx)            = concentrations of secondary         * +
!c                                aqueous species
!c                                - new time level [moles/l water]
!c           gamma_l(nc+nx)     = activity coefficients for aqueous   * *
!c                                species
!c           ph_fixed           = fixed value for pH                  + +
!c           ph_inc             = ph-increment for pH-sweep           + -
!c                                calculations
!c           tempk              = temperature [deg K]                 + -
!c           totco(n,nthreads)  = total aqueous component             + +
!c                                concentrations
!c                                - old time level [moles/l water]
!c           totcinit(n)        = total aqueous component             + -
!c                                concentrations
!c                                - initial concenttrations
!c                                [moles/l water]
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components including h2o  + -
!c           nph_steps          = number of pH-steps for pH-sweep     + -
!c                                calculations
!c
!c           logical:
!c           --------
!c           lb_output          = .true.  -> output of transient data * +
!c                                           (local chemistry)
!c           ph_sweep           = .true.  -> sweep over specified     + -
!c                                           pH-range
!c           reactive_minerals  = .true.  -> consider mineral         * +
!c                                           dissolution-
!c                                           precipitation reactions
!c           redox_equil_lc     = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c           character:
!c           ----------
!c           ctype(nc-1)        = 'charge' = correct total aqueous    + +
!c                                           component concentration
!c                                           for specified component
!c                                           to satisfy charge balance
!c                                'fixed'  = compute total aqueous
!c                                           component concentrations
!c                                           based on fixed activities
!c                                           of components as species
!c                                           in solution
!c                                'free'   = compute concentrations
!c                                           of components as species
!c                                           in solution based on
!c                                           specified total aqueous
!c                                           component concentrations
!c                                'ph'    =  pH specified for 'h+1'
!c           ctype_init(nc-1)   = 'charge' = correct total aqueous    + -
!c                                           component concentration
!c                                           for specified component
!c                                           to satisfy charge balance
!c                                'fixed'  = compute total aqueous
!c                                           component concentrations
!c                                           based on fixed activities
!c                                           of components as species
!c                                           in solution
!c                                'free'   = compute concentrations
!c                                           of components as species
!c                                           in solution based on
!c                                           specified total aqueous
!c                                           component concentrations
!c                                'ph'    =  pH specified for 'h+1'
!c           namec(nc)          = component names                     + -
!c
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c           r10                = constant
!c 
!c           integer*4:
!c           ----------
!c           ilz                = counter (zones)
!c           iph_steps          = counter (ph sweep calculations)
!c           l_string           = length of text string
!c           nlz                = number of zones
!c
!c           logical:
!c           --------
!c           found_section      = .true.  -> section header was
!c                                           found in input file
!c
!c external: clstpfls  = close postprocessing files for transient 
!c                       data (local chemistry)
!c           gcreact   = geochemical reactions for batch system
!c           icrtlczn  = read control parameters and initial 
!c                       condition for current zone 
!c                       (reactive transport or local chemistry)
!c           opnplfls  = open postprocessing files for 
!c                       transient data (local chemistry)
!c           outputlc  = write results of local chemistry 
!c                       computations to generic output file
!c           phcorr    = calculate fixed free species activities
!c                       and concentrations which require 
!c                       specified pH
!c           readbloc  = read section of input file and write to
!c                       temporary file 
!c           rtrvpprm  = retrieve physical parameters
!c           setsize   = define number of primary unknowns
!c ----------------------------------------------------------------------
 
      subroutine batreac
 
      use parm
      use gen
      use chem
      use phys
#ifdef OPENMP
      use omp_lib 
#endif

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      
      implicit none
      
      integer :: tid 
      
      real*8 :: r0, r1, r10, swc, sac, porc 
      integer :: i, ic, ilz, ivol, l_string, nlz 

      external clstpfls,icrtlczn,opnplfls,outputlc, &
              phcorr,readbloc,rtrvpprm,setsize

      logical found_section

      parameter (r0=0.0d0, r1 = 1.0d0, r10 = 10.0d0)
      
      
      
      !For the shared-memory parallel version, the variables defined in the module
      !are shared variables by different threads. So as to avoid race condition, 
      !these variable should be passed by dummy arguments or threadprivate variables.
      !Danyang Su, 2013-05.
      interface
      
        !>interface of gcreact           
        subroutine gcreact(cnew,cold,cx,gammac,gammax,gnew,sw,sa,por,   &
                        igen,ilog,idbg,tec_header,prefix,l_prfx,        &
                        zone_name,l_zone_name) 
          use parm, only : type_i4, type_r8
          real(type_r8), dimension(*) :: cnew
          real(type_r8), dimension(*) :: cold
          real(type_r8), dimension(*) :: cx
          real(type_r8), dimension(*) :: gammac
          real(type_r8), dimension(*) :: gammax
          real(type_r8), dimension(*) :: gnew
          real (type_r8) :: sw
          real (type_r8) :: sa
          real (type_r8) :: por
          integer(type_i4) :: igen
          integer(type_i4) :: ilog
          integer(type_i4) :: idbg
          logical :: tec_header
          character*72 :: prefix
          integer(type_i4) :: l_prfx
          character*72 :: zone_name
          integer(type_i4) :: l_zone_name 
        end subroutine
      
      end interface
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif      
 
!c  read section header for local chemistry

      section_header = 'initial condition - local geochemistry'
      call readbloc (idat,itmp,section_header,found_section,.true.)

!c  define length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if

!c  terminate program if section header not found

      if (.not.found_section) then
        if (rank == 0) then  
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

!c  write section header to generic output file

      if(b_enable_output)  then   
        if (rank == 0) then
          if (b_enable_output_gen) then
            write(igen,'(/72a)')('-',i=1,72)
            write(igen,'(a)') section_header(:l_string)
            write(igen,'(72a)')('-',i=1,72)
          end if
        
          write(ilog,'(a)') section_header(:l_string)
          write(ilog,'(72a/)')('-',i=1,72)   
        end if
      end if
  
!c  assign concentration for h2o

      ccnew(nc) = r1
      ccold(nc) = r1

!c  read number of zones to be processed 
  
      read(itmp,*,err=999,end=999) nlz 
      
      if(b_enable_output .and. b_enable_output_gen)  then      
        write(igen,*)
        write(igen,'(a,i10)') &
        'number of zones                                 = ',nlz      
      end if
 
      do ilz=1,nlz                            !loop over zones

!c  initialize control and input parameters for current zone 

        call icrtlczn(ilz)

!c  set number of primary unknowns for current batch problem

        call setsize(redox_equil_lc)

!c  settings for output of pc-pH diagrams

        if (ph_sweep) then
          lb_output = .true.
          tec_header = .true.
        end if

!c  open output files for postprocessing

        if (lb_output .and. b_enable_output) then
          if(rank == 0) then  
            call opnplfls(ilz)
          end if
          tec_header = .true.
        end if

        call phcorr(ccnew,ccold,tempk,ilog)
!c  retrieve physical parameters for scaling
!CMX
      if (nngl.lt.1) then
        call rtrvpprm(swc,sac,porc,section_header)
        call gcreact(ccnew,ccold,cxc,gamma_l(1),gamma_l(nc+1),   &
                    cgc,swc,sac,porc,igen,ilog,idbg,tec_header,  &
                    prefix,l_prfx,zone_name,l_zone_name)
      else
!CMX 
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_batreac_1)                      &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol)                                               &
    !$omp firstprivate(swc, sac, ccnew,ccold,cxc, cgc)                 
    !$omp do schedule(static)
#endif
      do ivol = 1,nngl         !loop over control volumes
          if (porosity_field) then
                swc = r1
                sac = r0
          else
              call rtrvpprm(swc,sac,pornew(ivol),section_header)            
          endif

          if (temp_field.or.heat_transport) then
           call tcorr(tkel(ivol))
          end if
!c  compute initial condition
 
          call gcreact(ccnew,ccold,cxc,gamma_l(1),gamma_l(nc+1),      &
                     cgc,swc,sac,pornew(ivol),igen,ilog,idbg,         &
                     tec_header,prefix,l_prfx,zone_name,l_zone_name)

!          call gcreact(ccnew,ccold,cxc,gamma_l(1),gamma_l(nc+1), &
!                    cgc,r1,r0,r1,igen,ilog,idbg,                 &
!                    tec_header,prefix,l_prfx,zone_name,l_zone_name)
 
      end do            !loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif 
      end if

 
!c  write results to generic output file
 
        if(b_enable_output .and. b_enable_output_gen)  then 
          call outputlc(ccnew,cxc,gamma_l(1),gamma_l(nc+1),cgc, &
                       igen,ilog,section_header)
        end if
 
!c  sweep over pH-range

        if (ph_sweep) then

          do iph_steps = 1,nph_steps

!c  redefine parameters for ph-sweep calculations 

            do ic = 1,nc-1

              totco(ic,:) = totcinit(ic)

              if (ctype_init(ic).eq.'eh'.or. &
                 ctype_init(ic).eq.'pe'.or.  &
                 ctype_init(ic).eq.'pco2') then
                ctype(ic) = ctype_init(ic)
              end if

              if (namec(ic).eq.'h+1') then
                ph_fixed = ph_fixed+ph_inc
                specified_ph = .true.
                actv(ic) = r10**(-ph_fixed)
                ccold(ic) = r10**(-ph_fixed)
                ccnew(ic) = ccold(ic)
                ctype(ic) = 'fixed'
              end if

            end do

!c  calculate fixed free species activities and concentrations
!c  which require specified pH

            call phcorr(ccnew,ccold,tempk,ilog)

!c  compute initial condition
!CMXb
            if (nngl.lt.1) then
              call gcreact(ccnew,ccold,cxc,gamma_l(1),gamma_l(nc+1), &
                        cgc,swc,sac,porc,igen,ilog,idbg,tec_header,  &
                        prefix,l_prfx,zone_name,l_zone_name)
            else
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_batreac_2)                      &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol)                                               &
    !$omp firstprivate(swc, sac, ccnew,ccold,cxc, cgc)                 
    !$omp do schedule(static)
#endif 
              do ivol = 1,nngl         !loop over control volumes
                if (temp_field.or.heat_transport) then
                  call tcorr(tkel(ivol))
                end if
                call gcreact(ccnew,ccold,cxc,gamma_l(1),gamma_l(nc+1),&
                             cgc,swc,sac,pornew(ivol),igen,ilog,idbg, &
                             tec_header,prefix,l_prfx,zone_name,      &
                             l_zone_name)
              end do            !loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

            end if

!CMXend
 
!c  write results to generic output file
 
            if(b_enable_output .and. b_enable_output_gen)  then
              call outputlc(ccnew,cxc,gamma_l(1),gamma_l(nc+1),cgc, &
                           igen,ilog,section_header)
            end if
 
          end do           !(loop over pH-values

        end if             !(ph_sweep)

!c  clear logical array for next zone
 
        reactive_minerals = .false.
 
!c  close files for postprocessing of transient data
 
        if (lb_output .and. b_enable_output) then
          if(rank == 0) then
            call clstpfls
          end if
        end if
 
      end do         !(loop over number of zones)
 
      goto 1000

999   continue
      if (rank == 0) then
        write(ilog,*) 'error reading input file'
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end
