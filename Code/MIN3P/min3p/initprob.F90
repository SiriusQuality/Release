!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 491 $
!> $Author: fgerard $
!> $Date: 2017-07-18 00:06:39 +0200 (Tue, 18 Jul 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/initprob.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initprob
!c -------------------
!c
!c initialize variably saturated flow and/or reactive transport 
!c simulation or initialize equilibrium or reaction path simulation
!c
!c modified for optional density dependent flow simulation
!c
!c written by:      Uli Mayer - October, 1995
!c
!c last modified:   Tom Henderson - April 1, 2003
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    logical:
!c           --------
!c           geo_chemistry      = .true.  -> local or background and  + -
!c                                           source chemistry
!c           reactive_transport = .true.  -> perform reactive         + -
!c                                           transport simulation
!c           varsat_flow        = .true.  -> perform flow simulation  + -
!c
!c dens.f:   logical:
!c           --------
!c          density_dependence = .true.  -> density-dependent flow   + -
!c           flow_verification  = .true.  -> verify pressure formulation
!c                                           for constant density 
!c                                           test problem
!c           
!c local:    -
!c
!c external: inittsgs = time step control parameters (global system)
!c           initcpvs = control parameters for variably saturated flow
!c           initcpdd = control parameters for density dependent flow
!c           initcprt = control parameters for reactive transport
!c           sptldisc = read spatial discretization parameters, 
!c                      discretize solution domain and compute nodal 
!c                      volumes
!c           initopgs = output control parameters (global system)
!c           initcsys = define geochemical system 
!c           opnmbfls = open mass balance files
!c           opnmbfls_mcd = open mass balance files for MCD
!c           datstr_1 = set up data structure, generate ordering vectors 
!c                      and perform symbolic factorization for 1d-scalar 
!c                      matrix (variably saturated flow)
!c           datstr_n = set up data-structure, generate ordering vectors 
!c                      and perform symbolic factorization for nd-scalar
!c                      matrix (reactive transport)
!c           initcplc = control parameters for local chemistry
!c           initpppm = physical parameters for porous medium
!c           initppvs = physical parameters for variably saturated flow
!c           initppdd = physical parameters for density dependent flow
!c           infcvs   = compute influence coefficients (variably
!c                      saturated flow)
!c           initpprt = physical parameters (reactive transport)
!c           initicvs = initial condition (variably saturated flow)
!c           initicdd = initial condition (density dependent flow)
!c           initbcvs = boundary conditions (variably saturated flow)
!c           initbcdd = boundary conditions (density dependent flow)
!c           initsatw = compute initial saturations 
!c           initicrt = initial condition (reactive transport)
!c           initbcrt = boundary conditions (reactive transport)
!c           indextec = calculate i,j,k indices for TECPLOT
!c                      postprocessing
!c           initweed = initialize work arrays for determination 
!c                      of secondary aqueous species, which are 
!c                      obsolete for simulation
!c           inittemp = define temperature field and compute
!c                      temperature-dependent constants
!c           mem_rt   = allocate memory for reactive transport 
!c                      simulation
!c           mem_vs   = allocate memory for variably-saturated
!c                      flow simulation
!c           mem_dd = allocate memory for variably-saturated
!c                      density dependent flow simulation
!c           mem_hmcd = allocate memory for hybrid
!c                      multicomponent diffusion model
!c           weed     = determine seondary aqueous species, which 
!c                      are obsolete for simulation
!c ----------------------------------------------------------------------
 
      subroutine initprob
 
      use parm
      use gen
      use dens
      use chem 
      use phys 
      use bbls
      
      use module_binary_mpiio, only : binary_subarray_initialize
#ifdef OPENMP
      use omp_lib 
#endif
     
#ifdef PETSC
      use solver_snes_common, only : rtol_flow, abstol_flow,           &
                 maxits_flow, rtol_react, abstol_react, maxits_react,  &
                 pc_factor_shift_flow, pc_factor_shift_react
      use solver_dd, only : solver_dd_DMDACreate_react
#endif
    

      implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif

      integer :: ivol, izn, ierr
      
      real*8 :: actw, dummy

#ifdef PETSC
      PetscErrorCode :: ierrcode 
      logical :: seepage_face_gbl
#endif
      
      integer :: rwork_max_size

      external inittsgs,initcpvs,initcpdd, initcprt,sptldisc,         &
     &         initopgs,initcsys,opnmbfls,datstr_1,datstr_n,initcplc, &
     &         initpppm,initppvs,initppdd, infcvs,initpprt,initicvs,  &
     &         initicdd, initbcvs,initbcdd, initsatw, initicrt,       &
     &         initbcrt,indextec,inittemp,initweed,mem_rt,            &
     &         mem_vs, mem_dd, weed, mem_hmcd
     
      real*8, parameter    :: rkelvin=273.15d0,r0=0.0d0,r1=1.0d0
 

      !For the shared-memory parallel version, the variables defined in the module
      !are shared variables by different threads. So as to avoid race condition, 
      !these variable should be passed by dummy arguments. Danyang Su, 2013-05.
      interface
      
        !>interface of tcorr
        subroutine tcorr(tempkel)
          use parm, only : type_r8     
          real(type_r8) :: tempkel      
        end subroutine tcorr
      
      end interface

!c  define geochemical system
      if (geo_chemistry) then
        call initcsys
      end if
!c  read spatial discretization parameters, discretize solution domain
!c  and compute nodal volumes

!c  Parallelized, OpenMP, MPI, DSU

      if (varsat_flow.or.reactive_transport) then
        call sptldisc
      end if
      
!c  Parallelized, OpenMP, DSU
      if (varsat_flow) then
        call mem_vs
      end if
      
!c  Parallelized, OpenMP, DSU
      if (heat_transport .or. temp_field) then
        call mem_heat
      else
        b_water_freezing = .false.
        b_water_freezing_ratemin = .false.
      end if
      

!c  allocate memory for reactive transport simulation
!c  Parallelized, OpenMP, DSU
      if (reactive_transport) then
        call mem_rt
      end if

!c  allocate memory for density-dependent flow simulation (new)
!c  Parallelized, OpenMP, DSU
      if (density_dependence) then
        call mem_dd
      end if

!c  define temperature field and compute temperature-dependent 
!c  constants

      if (geo_chemistry) then
        call inittemp
      end if
  
!c  assign indices for tecplot output

      call indextec

!c  time step control parameters for reactive transport and/or
!c  variably saturated flow 

      if ((varsat_flow.and.transient_flow).or.reactive_transport) then
        call inittsgs
      end if

!c  control parameters for local chemistry

      if (geo_chemistry) then
        call initcplc
      end if

!c  control parameters for variably saturated 
!c  and density dependent flow

      if (varsat_flow)then
        if (density_dependence) then
          
          call initcpdd
        
          if (heat_transport) then
             call initcpenergybal
             if (variably_saturated.and.evaporation) then
             
                 call initcpevaporation
!c  Parallelized, OpenMP, DSU
                 call mem_evap 
             
             end if
          end if 
        
        else 
          call initcpvs
        end if

	     if (.not.root_uptake) then	! CBF 
	  
         call mem_etr	! CBF 

	  endif	! CBF 


      end if
      
!cprovi---------------------------------------------------------------------
!cprovi it was added by Sergio Andrï¿½s Bea Jofr?
!cprovi Aqueous Phase with Pitzer equations are created only if
!cprovi ispitzer=true 
!cprovi---------------------------------------------------------------------
      if (ispitzer) then 
        call initpitzer  
      end if 
!cprovi---------------------------------------------------------------------
!cprovi---------------------------------------------------------------------
!cprovi---------------------------------------------------------------------
      
      

!c  control parameters for reactive transport

      if (reactive_transport) then
        call initcprt
      end if
      
!c  control parameters for reactive transport

      if (gas_bubbles) then
        call initcpgb
      end if

!c  output control parameters for reactive transport and/or
!c  variably saturated flow and/or batch reaction

      call initopgs

!c  set up data structure, generate ordering vectors and perform 
!c  symbolic factorization for 1d - Jacobian matrix
!c  (variably saturated flow and reactive transport)
!c  Partially parallelized, OpenMP, DSU
      if (varsat_flow.or.reactive_transport) then
        call datstr_1
      end if

!c  set up data-structure, generate ordering vectors and perform
!c  symbolic factorization for reactive transport problem
!c  Partially parallelized, OpenMP, DSU
      if (reactive_transport) then
        call datstr_n
#ifdef PETSC
        call solver_dd_DMDACreate_react 
#endif
      end if

!c  open mass balance files
!c  write mass balance files only by the master process (thread)
      if(rank == 0 .and. b_enable_output) then      
          call opnmbfls

          if(flux_out)then               !MCD
            call opnmbfls_mcd
          end if
      end if

    
!cprovi--------------------------------------------------------------
!cprovi Open file corresponding to energy balance
!cprovi--------------------------------------------------------------
    if(rank == 0) then
        if (heat_transport.and.energy_balance) then
            call opnenergybal
        end if
    end if

!cprovi--------------------------------------------------------------    
!cprovi--------------------------------------------------------------    
!cprovi--------------------------------------------------------------
!c  physical parameters for porous medium
!c  Partially parallelized, OpenMP, DSU
      call initpppm

   
      if (varsat_flow) then
        if (density_dependence) then

!c  physical parameters for density dependent variably saturated flow
!c  Partially parallelized, OpenMP, DSU        
             call initppdd

!c  influence coefficients for density dependent variably saturated flow        
         
        else   ! not density dependent flow

!c  physical parameters for variably saturated flow
!c  Partially parallelized, OpenMP, DSU
           call initppvs

!c  influence coefficients for variably saturated flow

        end if  !density dependence
        
!cprovi---------------------------------------------------------------        
!cprovi Read physical parameters for energy balance
!cprovi--------------------------------------------------------------- 
!c  Partially parallelized, OpenMP, DSU
        if (heat_transport) then   
           
           call initppeb

        end if    

!c  Compute influence coefficients for flow equation 
!c  Parallelized, OpenMP, DSU      
        call infcvs

!c  physical parameters for reactive transport

      if (reactive_transport) then
        call mem_hmcd
        call initpprt
      end if
 
!c  initial condition for variably saturated flow
!c  not density dependent
!c  Partially parallelized, OpenMP, DSU
      if ((varsat_flow).and.(.not.density_dependence)) then
          
        culabsbalvs = r0
        
        call initicvs

!c  boundary conditions for variably saturated flow
 
        call initbcvs

!c  initial saturations 
!c  Parallelized, OpenMP, DSU    
        call initsatw
   
      end if
      
!cprovi-------------------------------------------------------------------
!cprovi Read initial conditions (temperature) for energy balance 
!cprovi calculations. It is performed previously to density calculations.
!cprovi-------------------------------------------------------------------
!c  Partially parallelized, OpenMP, DSU
       if (density_dependence.and.heat_transport) then
          call initicenergybal
       end if 

!cprovi-------------------------------------------------------------------
!cprovi Update the tkel vector and the temperature dependent variables
!cprovi-------------------------------------------------------------------  
!cdsu   The calling of tcorr is confused to me. In the sequential running, 
!cdsu   the variables (dhad, dhbd, ..., ratecaq) are updated by last volume.
!cdsu   Why call tcorr for every volume.
!cdsu   comment out by DSU       
!cdsu   Add the following variables to private if tcorr is called every time
!cdsu   in the parallel loop: dhad, dhbd, eqx, eqg, eqm, rated, eqmx, eqr, 
!cdsu   eqsb_ion, eqsb_surf, eqaq, ratecaq
!cdsu
!cdsu   if (temp_field.or.heat_transport) then
!cdsu   when temp_field is true,the temperature has already been assigned
!cdsu   in inittemp function that is called earlier.
!cdsu   DSU, 2016-04-13
        if (.not.temp_field.and.heat_transport) then
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initprob_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol)
    !$omp do schedule(static)
#endif   
         do ivol=1,nngl
           tkel(ivol) = tempnew(ivol) + rkelvin
         end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

         !This calling is used to generated the same result as sequential codes,
         !because tcorr is last updated by volume nn in sequential running. DSU
         !call tcorr(tkel(nngl))
        
       end if
!cprovi-------------------------------------------------------------------
!cprovi-------------------------------------------------------------------
!cprovi-------------------------------------------------------------------
       if (reactive_transport) then

!c  initialize work arrays for determination of secondary aqueous
!c  species, which are obsolete for simulation

        call initweed

!c  initial condition for reactive transport 
!c  Partially parallelized, OpenMP, DSU

        call initicrt 

!c  boundary conditions for reactive transport 
!c  Partially parallelized, OpenMP, DSU
        call initbcrt

!c  determine seondary aqueous species, which are obsolete 
!c  for simulation
        if (b_enable_output) then
          call weed
        end if

      end if

!c CBF plant transpiration and passive/rejective solute uptake
        if (root_uptake.and.varsat_flow) then	! CBF
            call initplant
	
!c CBF build binary matrix for transpiration

          call binmattransp

        endif	! CBF

!c CBF build binary matrix for physical evaporation
        if (varsat_flow) then	! CBF
          call binmatevap	! CBF
        endif			! CBF

!c density dependent flow

      if (density_dependence) then
      !cprovi--------------------------------------------------------------------------
      !cprovi Compute densities (also viscosity) as a function of water composition 
      !cprovi and temperature 
      !cprovi--------------------------------------------------------------------------
      !cprovi  Parallelized, OpenMP, DSU 
      if (.not.flow_verification) then
          if (heat_transport) then 
             call ddtds_energybal(.true.)          
          else
             call ddtds 
          end if 
      end if
      !cprovi--------------------------------------------------------------------------
      !cprovi Read initial conditions for flow  
      !cprovi--------------------------------------------------------------------------
      !cprovi  Paritially parallelized, OpenMP, DSU 
      call initicdd
      !cprovi--------------------------------------------------------------------------
      !cprovi Read boundary conditions for flow  
      !cprovi--------------------------------------------------------------------------      
      call initbcdd
      !cprovi--------------------------------------------------------------------------
      !cprovi Compute the first pore water saturation as a function of initial 
      !cprovi pressure distribution 
      !cprovi--------------------------------------------------------------------------
      !cprovi  Parallelized, OpenMP, DSU 
      call initsatw
      
      if (heat_transport) then
            
            if (evaporation) then
              !cprovi--------------------------------------------------------------------------
              !cprovi Compute the saturated vapour density 
              !cprovi (see Saito et al. (2006) and RETRASO user's manual)
              !cprovi--------------------------------------------------------------------------
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initprob_2)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol, izn, actw, dummy)                  
    !$omp do schedule(static)
#endif
              do ivol=1,nngl 
                izn = mpropvs(ivol) 
                if (reactive_transport) then
                  actw=gamma(nc,ivol)
                else    
                  actw=r1
                end if    
                call vapor_prop (densvnew(ivol),dummy,ddensvdpa(ivol),&
                                 ddensvdt(ivol),latvapnew(ivol),      &
                                 tempnew(ivol),aentry(izn),           &
                                 uvsnew(ivol),actw,                   &
                                 density(ivol),ivol)
               
                densvold(ivol)=densvnew(ivol)
                latvapold(ivol)=latvapnew(ivol)
                
                call surf_tens_prop (dummy,dsurftensdt(ivol),         &
                                     tempnew(ivol))
                
              end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif 
            end if  
!cprovi---------------------------------------------------------------
!cprovi Init boundary conditions for heat transport
!cprovi---------------------------------------------------------------
!cprovi  Paritially parallelized, OpenMP, DSU 
           call initbcenergybal         
!cprovi---------------------------------------------------------------
!cprovi Compute influence coefficients for energy balance
!cprovi--------------------------------------------------------------- 
!cprovi  Parallelized, OpenMP, DSU 
           call infheat_c (nvxgl,nvygl,nvzgl,iavs,javs,isymvs,        &
     &                     cinfheat_c,dimcv,heatcondw,                &
     &                     heatconds,heatcondg,pornew,sanew,          &
     &                     zg,idbg,ilog,njavs,nngl,                   &
     &                     half_cells,cinfrad,radial_coord,           &
     &                     heatcond_model,nheatcond)

        end if 
!cprovi---------------------------------------------------------------        
!cprovi---------------------------------------------------------------        
!cprovi---------------------------------------------------------------     
      end if  

      end if
      
!cprovi---------------------------------------------------------------
!cprovi Init maximum size of rwork_max for flow and reactive transport
!cprovi---------------------------------------------------------------    

      if (i_solver_type_react == 0 .or. i_solver_type_flow == 0) then
          
          n_rwork_max = 0
          n_iwork_max = 0

          if(varsat_flow .or. steady_flow .or. fully_saturated) then
            n_rwork_max = 8*nngl
            n_iwork_max = nngl
          end if
      
          if (density_dependence.and.heat_transport) then
            n_rwork_max = max(n_rwork_max, 16*nngl)
            n_iwork_max = max(n_iwork_max, 2*nngl)
          end if
      
          if (reactive_transport) then
            n_rwork_max = max(n_rwork_max, 8*nngl*n)
            n_iwork_max = max(n_iwork_max, nngl*n)
          end if
      
          if (n_rwork_max > 0) then
            allocate(rwork_max(n_rwork_max), stat = ierr)
            rwork_max=0.0 
            call checkerr(ierr,'rwork_max',ilog)        
          end if
      
          if (n_iwork_max > 0) then
            allocate(iwork_max(n_iwork_max), stat = ierr)
            iwork_max=0 
            call checkerr(ierr,'iwork_max',ilog)        
          end if
          
      end if
      
#ifdef PETSC
        if(b_min3p_input_param_first) then
            if(heat_transport) then
                if(levelglob >= 1) then
                  pc_factor_shift_flow = "nonzero"
                end if
                rtol_flow = deltolglob
                abstol_flow = restolglob
                maxits_flow = msolvitglob
            else
                if(level_vs >= 1) then
                  pc_factor_shift_flow = "nonzero"
                end if
                rtol_flow = deltol_vs
                abstol_flow = restol_vs
                maxits_flow = msolvit_vs
            end if
            if (level_rt >= 1) then
              pc_factor_shift_react = "nonzero"
            end if
            rtol_react = deltol_rt
            abstol_react = restol_rt
            maxits_react = msolvit_rt
        end if
#endif
    
        ! Do necessary synchronization here
#ifdef MPI       
        call MPI_Allreduce(seepage_face, seepage_face_gbl,1,           &
                      MPI_LOGICAL,MPI_LOR,Petsc_Comm_World,ierrcode)
        CHKERRQ(ierrcode)
        seepage_face = seepage_face_gbl
#endif 

       !> Initialize mpi subarray output
       if (b_output_binary .and. b_output_mpiio_single .and. .not. b_output_multizone) then
         call binary_subarray_initialize
       end if

      return
      end

