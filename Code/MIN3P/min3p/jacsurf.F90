!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/jacsurf.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine jacsurf
!c ------------------
!c
!c construct Jacobian matrix and rhs vector for determination of
!c composition of surface sites
!c
!c written by:      Uli Mayer - March 18, 00
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           cnew(nc)           = concentrations of free species      + -
!c                                [moles/l water]
!c           gammac(nc)         = activity coefficients of free       * +
!c                                species
!c           sw                 = water saturation                    + -
!c           por                = porosity                            + -
!c
!c common:   
!c chem.f:   real*8:
!c           -------
!c           alc(nc-1,nc-1,nthreads) 
!c                              = jacobian matrix                * +
!c           blc(nc-1,nthreads) = rhs-vector                     * + 
!c           cec(nthreads)      = cation exchange capacity (meq/100g) + -
!c           cinc(nc,nthreads)  = incremented free species            * +
!c                                concentrations
!c                                [moles/(l water)]
!c           chargesb(nsb)      = charge of sorbed species            + -
!c           chargesb_ion(nsb_ion)   
!c                              = charge of sorbed species       + -
!c                                     (ion-exchange)
!c           chargesb_surf(nsb_surf) 
!c                              = charge of sorbed species       + -
!c                                     (surface-complex)
!c           csb(nsb)           = concentrations of sorbed species    * +
!c                                - new time level
!c           csb_ion(nsb_ion,nthreads)   
!c                              = concentrations of sorbed species    * +
!c                                - new time level (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    * +
!c                                - new time level (surface-complex)
!c           dcsb(nsb)          = derivatives of concentrations of    * *
!c                                sorbed species with respect to
!c                                primary species
!c           dcsb_ion(nsb_ion,nthreads)  
!c                              = derivatives of concentrations of    * *
!c                                sorbed species with respect to
!c                                primary species (ion-exchange)
!c           dcsb_surf(nsb_surf,nthreads)
!c                              = derivatives of concentrations of    * *
!c                                sorbed species with respect to
!c                                primary species (surface-complex)
!c           dtotsb(n)          = derivatives of total source/sink    * +
!c                                term towards total aqueous
!c                                component concentrations due to
!c                                sorption reactions
!c                                [moles/(l bulk*day)]
!c           dtotsb_ion(n,nthreads)      
!c                              = derivatives of total source/sink    * *
!c                                term towards total aqueous
!c                                component concentrations due to
!c                                sorption reactions
!c                                [moles/(l bulk*day)]
!c                                (ion-exchange)
!c           dtotsb_surf(n,nthreads)     
!c                              = derivatives of total source/sink    * *
!c                                term towards total aqueous
!c                                component concentrations due to
!c                                sorption reactions
!c                                [moles/(l bulk*day)]
!c                                (surface-complex)
!c           eqsb(nsb)          = equilibrium constants for           + -
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for           + -
!c                                sorbed species (ion-exchange)
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for           + -
!c                                sorbed species (surface-complex)
!c           rhobulk            = dry bulk density of porous medium   + -
!c           totco(n,nthreads)  = total aqueous component             + -
!c                                concentrations
!c                                - old time level [moles/l water]
!c           totcsn(nc-1)       = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c           totcsn_ion(nc-1,nthreads) 
!c                              = total sorbed component              + -
!c                                concentrations
!c                                (ion-exchange)
!c           totcsn_surf(nc-1,nthreads)  
!c                              = total sorbed component              + -
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (surface-complex)
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components
!c           xnusb_ion(nsb_ion*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (surface-complex)
!c           dinc_lc            = factor to compute increment for     + -
!c                                numerical differentiation
!c
!c           integer*4:
!c           ----------
!c           iasb(nsb+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to              + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           jasb(nsb*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           nc                 = number of components including h2o  + -
!c           nopu               = number of primary unknowns          + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c
!c           logical:
!c           --------
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c           character:
!c           ----------
!c           component_type(nc) = 'aqueous' = aqueous component       + -
!c                                'surface' = surface site
!c                                'biomass' = biomass
!c           namec(nc)          = component names                     + -
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c           sorption_type      = 'gaines-thomas'                     + -
!c                                'gapon'
!c                                'surface-complex'
!c                                'constant-capacitance'
!c
!c local:    real*8:
!c           -------
!c           drtinc             = increment for numerical 
!c                                differentiation
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           isb                = counter (sorbed species)
!c           ibl                = counter (rows of Jacobian 
!c                                matrix) 
!c           jbl                = counter (columns of Jacobian 
!c                                matrix)
!c
!c external: comptotc  = compress concentration vector, if number
!c                       of unknowns is reduced due to redox 
!c                       equilibrium reactions
!c           sorbspc   = compute concentration of sorbed species
!c           totsorb   = compute total sorbed component concentrations
!c                       [moles/l bulk]
!c ----------------------------------------------------------------------
 
      subroutine jacsurf(cnew,gammac,sw,por)
 
      use parm
      use chem
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
      implicit none
      integer :: tid, ibl, ic, isb, jbl, info_debug
      real*8 dummy, drtinc
      
      external comptotc, sorbspc, totsorb
      
      real*8 :: cnew, gammac, sw, por

      dimension cnew(*),gammac(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
      
!c  compute concentrations of sorbed species
      do isb = 1, nsb_ion
        call sorbspc(csb_ion(isb,tid),dummy,cec(tid),                 &
             eqsb_ion(:,tid),eqsb_surf(:,tid),gammac,cnew,            &
             xnusb_ion,xnusb_surf,iasb_ion,iasb_surf,jasb_ion,        &
             jasb_surf,nsb_ion,nsb_surf,isb,0,sorption_type_ion,      &
             sorption_type_surf,sorption_group,isactcexch)
      end do
      
!c  compute concentrations of sorbed species
      do isb = 1, nsb_surf
        call sorbspc(dummy,csb_surf(isb,tid),cec(tid),                &
             eqsb_ion(:,tid),eqsb_surf(:,tid),gammac,cnew,            &
             xnusb_ion,xnusb_surf,iasb_ion,iasb_surf,jasb_ion,        &
             jasb_surf,nsb_ion,nsb_surf,0,isb,sorption_type_ion,      &
             sorption_type_surf,sorption_group,isactcexch)
      end do
           
!c  compute total sorbed concentrations

      call totsorb(csb_ion(:,tid),csb_surf(:,tid),                    &
                   chargesb_ion,rhobulk,                              &
                   totcsn_ion(:,tid),totcsn_surf(:,tid),              &
                   xnusb_ion,xnusb_surf,iasb_ion,                     &
                   iasb_surf,jasb_ion,jasb_surf,nc,nsb_ion,nsb_surf,  &
                   namec)

!c  compress total sorbed component concentration vector in case 
!c  of redox equilibrium reactions

      if (redox_equil.and.nr.gt.0.and.nsb_ion.gt.0) then
        call comptotc(totcsn_ion(:,tid))
      end if
      

      if (redox_equil.and.nr.gt.0.and.nsb_surf.gt.0) then
        call comptotc(totcsn_surf(:,tid))
      end if
 
!c  construct right hand side vector

      do ibl = 1,nopu               !loop over rows
 
        if (component_type(ibl).eq.'surface') then

!c  contributions from aqueous phase

          blc(ibl,tid) = - sw*por*(cnew(ibl)-totco(ibl,tid))

!c  contributions from sorbed phase

          blc(ibl,tid) = blc(ibl,tid) - sw*por*(totcsn_surf(ibl,tid))

        else

           blc(ibl,tid) = r0

        end if                        !component_type(ibl)

      end do                           !loop over rows

!c  construct jacobian matrix
!c  assign current component species concentrations to work array
 
!      do ic = 1,nopu
!!cmx        cinc(ibl,tid) = cnew(ibl)            ! This loop is completely replaced by the next loop. Delete! 
!	     cinc(ic,tid) = cnew(ic)
!      end do
 
      do jbl = 1,nopu                 !loop over columns

!c  compute increment for numerical differentiation

        drtinc = dinc_lc * cnew(jbl)
 
!c  increment free species concentration for current column
  
        cinc(jbl,tid) = cnew(jbl) + drtinc
 
!c  compute concentrations of sorbed species based on incremented free
!c  species concentrations 
        do isb = 1,nsb_ion
          call sorbspc(dcsb_ion(isb,tid),dummy,cec(tid),              &
                       eqsb_ion(:,tid),eqsb_surf(:,tid),              &
                       gammac,cinc(:,tid),                            &
                       xnusb_ion,xnusb_surf,iasb_ion,iasb_surf,       &
                       jasb_ion, jasb_surf,nsb_ion,nsb_surf,          &
                       isb,0,sorption_type_ion,                       &
                       sorption_type_surf,sorption_group,isactcexch)
!c  compute derivatives of concentrations of sorbed species
          dcsb_ion(isb,tid) = (dcsb_ion(isb,tid) - csb_ion(isb,tid))  &
                              /drtinc
        end do
        
!c  compute concentrations of sorbed species based on incremented free
!c  species concentrations 
        do isb = 1,nsb_surf
          call sorbspc(dummy,dcsb_surf(isb,tid),cec(tid),             &
               eqsb_ion(:,tid),eqsb_surf(:,tid),                      &
               gammac,cinc(:,tid),                                    &
               xnusb_ion,xnusb_surf,iasb_ion,iasb_surf,jasb_ion,      &
               jasb_surf,nsb_ion,nsb_surf,0,isb,sorption_type_ion,    &
               sorption_type_surf,sorption_group,isactcexch)
!c  compute derivatives of concentrations of sorbed species
          dcsb_surf(isb,tid) = (dcsb_surf(isb,tid) -                  &
                               csb_surf(isb,tid))/drtinc
        end do

!c  compute total sorbed concentrations

        call totsorb(dcsb_ion(:,tid),dcsb_surf(:,tid),                &
                     chargesb_ion,rhobulk,                            &
                     dtotsb_ion(:,tid),dtotsb_surf(:,tid),            &
                     xnusb_ion,xnusb_surf,                            &
                     iasb_ion,iasb_surf,jasb_ion,jasb_surf,nc,        &
                     nsb_ion,nsb_surf,namec)

!c  compress total sorbed component concentration vector in case
!c  of redox equilibrium reactions

        if (redox_equil.and.nr.gt.0.and.nsb_ion.gt.0) then
          call comptotc(dtotsb_ion(:,tid))
        end if
        
        if (redox_equil.and.nr.gt.0.and.nsb_surf.gt.0) then
          call comptotc(dtotsb_surf(:,tid))
        end if
 
!c  contruct current column of jacobian matrix
 
        do ibl = 1,nopu            !loop over rows

!c  allocate entry in jacobian matrix
 
          if (component_type(ibl).eq.'surface'.and.ibl.eq.jbl) then

!c  diagonal entries

            alc(ibl,jbl,tid) = alc(ibl,jbl,tid) + sw*por*             &
                               (r1+dtotsb_surf(ibl,tid))
            alc(ibl,jbl,tid) = cnew(jbl) * alc(ibl,jbl,tid)  

!c  off-diagonal entries

          elseif (component_type(ibl).eq.'surface'.and.               &
                  ibl.ne.jbl) then

            alc(ibl,jbl,tid) = alc(ibl,jbl,tid) + sw*por*             &
                               (dtotsb_surf(ibl,tid))
            alc(ibl,jbl,tid) = cnew(jbl) * alc(ibl,jbl,tid)  

!c  put 1 on diagonal for component type 'fixed' 

          elseif (component_type(ibl).ne.'surface'.and.               &
     &            ibl.eq.jbl) then
   
            alc(ibl,jbl,tid) = r1

!c  put 0 on off-diagonal in rows and columns for component type 
!c  'fixed'

          elseif (component_type(ibl).ne.'surface'.and.               &
     &            ibl.ne.jbl) then
   
            alc(ibl,jbl,tid) = r0
   
          end if                          !end - component_type(ibl)

        end do                            !end - loop over rows
 
!c  assign unshifted concentration to work array
 
        cinc(jbl,tid) = cnew(jbl)

      end do                              !end - loop over columns
      
!cdbg  activate this section for debugging
!c     info_debug = 1 -> write to screen
!c     info_debug = 2 -> write to screen and pause
!c     info_debug = 3 -> write to screen and stop

      info_debug = 0

      if (info_debug.gt.0) then
        write(*,*)
        do ibl = 1,nopu
          write(*,'(a,1x,15(1pe12.3))') trim(namec(ibl)),             &
     &                               (alc(ibl,jbl,tid),jbl=1,nc-1),   &
     &                                blc(ibl,tid)
        end do
        write(*,*)
      end if
      if (info_debug.eq.2) then
        !pause
      elseif (info_debug.eq.3) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
!cdbg
 
      return
      end
