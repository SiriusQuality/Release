!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/dratemin_new.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine dratemin_new
!c -----------------------
!c
!c compute derivative of absolute dissolution-precipitation rate 
!c of mineral (new database format)
!c
!c based on routine dratemin
!c
!c sign convention: dissolution -
!c                  precipitation +
!c
!c written by:      Uli Mayer - November 11, 01
!c
!c last modified:   Uli Mayer - February 3, 02
!c                  added hyperbolic and inhibition terms for 
!c                  minerals
!c                  Uli Mayer - August 8, 02
!c                  added hyperbolic and inhibition terms for
!c                  components as species in solution
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           gammax(nx)         = activity coefficient of             + -
!c                                secondary aqueous species
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           phim               = volume fraction of mineral          + -
!c           phimold            = volume fraction of mineral          + -
!c                                - old time level
!c           ratem              = derivative of absolute dissolution- * +
!c                                precipitation rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(n)            = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/(l bulk)]
!c
!c common:
!c biol.f:   real*8:
!c           -------
!c           rootdens           = root density at a given ivol !FG sept 2021
!c chem.f:   real*8:
!c           -------
!c           cinc(nc,nthreads)  = incremented free species            + -
!c                                concentrations
!c                                [moles/l h2o]
!c           cxinc(nx,nthreads) = secondary aqueous species           + -
!c                                concentrations dependent on
!c                                incremented free species
!c                                concentrations
!c                                [moles/l h2o]
!c           diffm(ndr*nm)      = free diffusion coefficient of       + -
!c                                primary reactant in water
!c                                (transport controlled reactions)
!c           eqm(nm,nthreads)   = equilibrium constants for minerals  + -
!c           fmdi(nrc*nc)       = inhibition constants - T^a          + -
!c           fmdm(nrc*nc)       = half saturation constants - T^a     + -
!c           fmic(nrc*nc)       = inhibition constants - C^c          + -
!c           fmhc(nrc*nc)       = half saturation constants - C^c     + -
!c           fmdpi(nrc*nm)      = inhibition constants - phi^m        + -
!c           fmdpm(nrc*nm)      = half saturation constants - phi^m   + -
!c           orddc(nrc*nm)      = order of free species in            + -
!c                                dissolution reaction
!c           orddcx(nrc*nm)     = order of secondary aqueous          + -
!c                                species in dissolution reaction
!c           orddt(nrc*nm)      = order of total aqueous component    + -
!c                                concentration in dissolution
!c                                reaction
!c           ordm(ndr*nm)       = exponent m for reaction rate law    + -
!c           ordmdi(nrc*nm)     = order of inhibition terms for       + -
!c                                dissolution-precipitation reactions
!c                                - T^a
!c           ordmdm(nrc*nm)     = order of hyperbolic terms for       + -
!c                                dissolution-precipitation reactions
!c                                - T^a
!c           ordmic(nrc*nm)     = order of inhibition terms for       + -
!c                                dissolution-precipitation reactions
!c                                - C^c
!c           ordmhc(nrc*nm)     = order of hyperbolic terms for       + -
!c                                dissolution-precipitation reactions
!c                                - C^c
!c           ordmdpi(nrc*nm)    = order of inhibition terms for       + -
!c                                dissolution-precipitation reactions
!c                                - phi^m
!c           ordmdpm(nrc*nm)    = order of hyperbolic terms for       + -
!c                                dissolution-precipitation reactions
!c                                - phi^m
!c           ordn(ndr*nm)       = exponent n for reaction rate law    + -
!c           rated(ndr*nm,nthreads)
!c                              = rate constants for dissolution      + -
!c                                reactions
!c           satm(nm,nthreads)  = saturation indices                  * +
!c           totcinc(n,nthreads)= total aqueous component             + -
!c                                concentrations - new time level, 
!c                                incremented [moles/l water]
!c           xnud(ndr*nm)       = stoichiometric coefficients of      + -
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution        + -
!c                                reactions
!c           iamdc(ndr*nm+1)    = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - T^a)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - T^a)
!c           iamic(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - C^c)
!c           iamhc(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - C^c)
!c           iamdpi(ndr*nm+1)   = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - 
!c                                phi^m)
!c           iamdpm(ndr*nm+1)   = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - 
!c                                phi^m)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamdc(nrc*nm)      = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - T^a)
!c           jamdm(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - T^a)
!c           jamic(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - C^c)
!c           jamhc(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - C^c)
!c           jamdpi(nrc*nm)     = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms 
!c                                - phi^m)
!c           jamdpm(nrc*nm)     = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms 
!c                                - phi^m)
!c           jamdt(nrc*nm)      = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c           nx                 = number of aqueous complexes         + -
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c
!c           logical:
!c           --------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = type of mineral dissolution-        + -
!c                                precipiaton reaction
!c
!c local:    real*8:
!c           -------
!c           prodrc             = activity product of species
!c                                involved in reaction
!c           prodrcinc          = activity product of species
!c                                involved in reaction (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c           ratetrans          = differential of transport controlled
!c                                reaction rate 
!c                                (incremented - not incremnented)
!c           satminc            = saturation index with respect
!c                                to current mineral (incremented)
!c
!c           integer*4:
!c           ----------
!c           ireac              = counter 
!c           istart             = pointer (start of reaction set) 
!c           iend               = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ic                 = counter (components)
!c           im2                = counter (minerals)
!c           ix                 = counter (secondary aqueosu species)
!c           i1                 = counter
!c
!c external: draoult  = compute derivative of dissolution rate 
!c                      of organic compound from organic mixture based 
!c                      on raoult's law
!c ----------------------------------------------------------------------
  
      subroutine dratemin_new(totc,c,cx,gammac,gammax,ratem,phim,   &
                             phimold,aream,drtinc,im,ivol)
 
      use parm
      use chem
      use gen, only : idbg
      use biol !FG sept 2021
#ifdef OPENMP
      use omp_lib 
#endif 
 
      implicit none
      
      logical :: summed_species
      
      integer :: tid, im, ivol
      
      real*8 :: r1_iap_k, prodrc, prodrcinc
      
      real*8 :: totc, c, cx, gammac, gammax, ratem, phim, phimod,      &
                aream, drtinc
      
      real*8 :: sar, sarinc

      dimension totc(*),c(*),cx(*),gammac(*),gammax(*),phim(*)

      real*8 :: alphar, alphartot, alphartop, alphartotinc,            &
                alphartopinc, alpharinc, gammatemp, gammatempinc,      &
                sumic, sumicinc, phimold, satminc, sumix, sumixinc
      integer :: i, i1, i2, i3, ii, ic2, icur, icount, itemp, ic,      &
                 iend, im2, ireac, istart, istop,istart2, istop2,      &
                 istart3, istop3, ix, itop, ibottom, next
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      
      !This is not needed when interface is declared
      !external draoult 
      
      !For the shared-memory parallel version, the variables defined in the module
      !are shared variables by different threads. So as to avoid race condition, 
      !these variable should be passed by dummy arguments. Danyang Su, 2013-05.
      interface 
        subroutine draoult(c,gammac,ratem,phim,phimold,aream,drtinc,im)
          use parm, only: type_i4, type_r8
          integer(type_i4) :: im
          real(type_r8), dimension(*) :: c
          real(type_r8), dimension(*) :: gammac
          real(type_r8) :: ratem
          real(type_r8) :: phim
          real(type_r8) :: phimold
          real(type_r8) :: aream
          real(type_r8) :: drtinc
        end subroutine draoult  
        
                !>interface of updtsvap
        subroutine dratemin_salinity(totc,c, sar, sarinc, im, ivol)
          use parm, only: type_i4, type_r8
          integer(type_i4) :: im
          integer(type_i4) :: ivol
          real(type_r8), dimension(*) :: c
          real(type_r8), dimension(*) :: totc
          real(type_r8) :: sar
          real(type_r8) :: sarinc
        end subroutine dratemin_salinity
        
      end interface 
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
      
      satminc = r0

      r1_iap_k = 0.0d0
 
      if (reaction_type(im).eq.'raoult') then

        call draoult(c,gammac,ratem,phim(im),phimold,aream,drtinc,im)
        return

      end if

!c  initialize total reaction rate

      ratem = r0

!c  calculate saturation index for current mineral 
!c  (not incremented - incremented) except for far from
!c  equilibrium dissolution-precipitation reactions
!c_isotope

      if (isofrac(im).and.(.not.far_from_equil(im))) then
        
          satm(im,tid) = eqm(im,tid)**(-r1)
          satminc = eqm(im,tid)**(-r1)

          ireac = iamd(im)
          
          istart = iam(im)
          istop = iam(im+1)-1 
            
          do i1 = istart, istop ! loop through components in mineral
            icount = 0
            ic = jam(i1)
            next = 0
            do i = 1, nifrm(im)  ! loop through isotope sets
                istart2 = next + iamdiso(im)
                icur = iamdiso2(im) + i - 1
                istop2 = iamdiso(im) + jamdiso2(icur) - 1
                next = jamdiso2(icur)
                gammatemp = r0
                gammatempinc = r0
                !loop through isotope compents in set
                do i2 = istart2, istop2 
                  ii = jamdiso(i2)
                  !check to see if component is an isotope
                  if (ii.eq.ic) then 
                    icount = icount + 1
                    !if so sum the isotope activities
                    do i3 = istart2, istop2 
                      ic2 = jamdiso(i3)
                      gammatemp = gammatemp + c(ic2)
                      gammatempinc = gammatempinc + cinc(ic2,tid)                
                    end do 
                    gammatemp =  gammac(ic)*gammatemp
                    gammatempinc = gammac(ic)*gammatempinc
                    satm(im,tid) = satm(im,tid)*(gammatemp**xnum(i1))
                    satminc=satminc*(gammatempinc**xnum(i1))
                  end if
                end do
            end do 
            !if not calculate the saturaton index the normal way  
            if (icount.eq.0) then   
              satm(im,tid) = satm(im,tid) * (gammac(ic)*c(ic))**xnum(i1)
              satminc=satminc*(gammac(ic)*cinc(ic,tid))**xnum(i1)
            end if
          end do   !i1 
            
      else if (.not.far_from_equil(im)) then

        satm(im,tid) = eqm(im,tid)**(-r1)
        satminc = eqm(im,tid)**(-r1)

        istart = iam(im)
        istop = iam(im+1)-1
        do i1 = istart,istop
          ic = jam(i1)
          satm(im,tid) = satm(im,tid) * (gammac(ic)*c(ic))**xnum(i1)
          satminc = satminc * (gammac(ic)*cinc(ic,tid))**xnum(i1)
        end do

      end if

!c  compute difference of total dissolution/precipitation rate 
!c  for surface controlled dissolution/precipitation reactions
!c  (incremented - not incremented)
!c  also for active uptake by roots (type = 'root') !FG sept 2021
      
      !FG sept 2021
      if ((rate_control(im).eq.'surface').or. (rate_control(im).eq.'root')) then

!c  compute rates only for specified reaction direction

        if (reaction_type(im).eq.'reversible' .or.                     &
           reaction_type(im).eq.'dissolution_far_from_equilibrium' .or.&
           (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
            dg_lim(im)-satm(im,tid).gt.r0) .or.                        &
           reaction_type(im).eq.                                       &
           'precipitation_far_from_equilibrium' .or.                   &
           (reaction_type(im).eq.'precipitation_to_equilibrium'.and.   &
            dg_lim(im)-satm(im,tid).lt.r0)) then

!c  loop over parallel dissolution/precipitation reactions

          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop

!c  scale reaction rate depending on equilibrium condition except for
!c  far from equilibrium reactions
!c  (not incremented - incremented)

            if (reaction_type(im).eq.                                 &
               'dissolution_far_from_equilibrium') then

              prodrc = rated(ireac,tid)
              prodrcinc = rated(ireac,tid)

            elseif (reaction_type(im).eq.                             &
                  'precipitation_far_from_equilibrium') then

              prodrc = -rated(ireac,tid)
              prodrcinc = -rated(ireac,tid)
              
              if (rate_control(im).eq.'root') then !FG sept 2021 - root density term if type 'root'
              
                 prodrc = -rootdens*rated(ireac,tid)
                 prodrcinc = -rootdens*rated(ireac,tid)
                 
              endif !root  

!culi 18/05/06 modified formulation for precipitation_to_equilibrium 
!culi to avoid excessively large precipitation rates 

            elseif (reaction_type(im).eq.            &
     &             'precipitation_to_equilibrium') then

              prodrc = -rated(ireac,tid) * (r1 - satm(im,tid)**(-r1))
              prodrcinc = -rated(ireac,tid) * (r1 - satminc**(-r1))
            
            else

!c  commented out to avoid NaN problems
              !prodrc = rated(ireac)                                     &
              !       * (r1 - satm(im)**ordm(ireac))**ordn(ireac)
              !prodrcinc = rated(ireac)                                  &
              !          * (r1 - satminc**ordm(ireac))**ordn(ireac)
              !
              !if(isnan(prodrc)) then
              !    write(*,*) "prodrc is nan2: ", r1 - satm(im)**ordm(ireac),  ordn(ireac)
              !end if
              !
              !if(isnan(prodrcinc)) then
              !    write(*,*) "prodrcinc is nan2: ", r1 - satminc**ordm(ireac),  ordn(ireac)
              !end if
              
              !Lasaga et al. (1994) equation. dsu, 2012-12-20
              
              if (b_ratelaw_exponent_n) then
                  
                if (reverse_affinity_term(im).and.                    &
                    satm(im,tid).gt.r1) then
                    
                    prodrc = -rated(ireac,tid)                        &
     &                 * (r1 - satm(im,tid)**(-ordm(ireac)))**ordn(ireac)
                    prodrcinc = -rated(ireac,tid)                     &
     &                 * (r1 - satminc**(-ordm(ireac)))**ordn(ireac)
                    
                else
                  
                  r1_iap_k = dg_lim(im) - satm(im,tid)**ordm(ireac)
                  if (r1_iap_k > 0) then        !satm(im) < 1 as ordm(ireac) is positive
                      if (reaction_type(im) == 'precipitation_to_equilibrium') then
                          prodrc = 0.0d0
                      else 
                          prodrc = rated(ireac,tid) *                 &
                                   r1_iap_k**ordn(ireac)
                      end if
                  else                          !satm(im) >= 1 as ordm(ireac) is positive 
                      if (reaction_type(im) == 'dissolution_to_equilibrium') then
                          prodrc = 0.0d0
                      else
                          prodrc = -rated(ireac,tid) *                &
                                   (abs(r1_iap_k))**ordn(ireac)
                      end if
                  end if
                                    
                  r1_iap_k = dg_lim(im) - satminc**ordm(ireac)
                  if (r1_iap_k > 0) then        !satm(im) < 1 as ordm(ireac) is positive
                      if (reaction_type(im) == 'precipitation_to_equilibrium') then
                          prodrcinc = 0.0d0
                      else
                          prodrcinc = rated(ireac,tid) *              &
                                      r1_iap_k**ordn(ireac)
                      end if
                  else                          !satm(im) >= 1 as ordm(ireac) is positive 
                      if (reaction_type(im) == 'dissolution_to_equilibrium') then
                          prodrcinc = 0.0d0
                      else
                          prodrcinc = -rated(ireac,tid) *             &
                                      (abs(r1_iap_k))**ordn(ireac)
                      end if
                  end if  
                  
                end if
		

                
              else
!crevaff
                if (reverse_affinity_term(im).and.                    &
                    satm(im,tid).gt.dg_lim(im)) then
                    
                    prodrc = -rated(ireac,tid)                        &
     &                 * (dg_lim(im) - satm(im,tid)**(-ordm(ireac)))
                    prodrcinc = -rated(ireac,tid)                     &
     &                 * (dg_lim(im) - satminc**(-ordm(ireac)))
                else
                    prodrc = rated(ireac,tid) *                       &
                             (dg_lim(im) - satm(im,tid)**ordm(ireac))
                    prodrcinc = rated(ireac,tid) *                    &
                                (dg_lim(im) - satminc**ordm(ireac)) 
                end if   

!crevaff         
              end if
              
              !--old--
              !prodrc = rated(ireac)                                   &
              !      * (r1 - satm(im)**ordm(ireac))
              !prodrcinc = rated(ireac)                                &
              !         * (r1 - satminc**ordm(ireac))

            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc(ic,tid)**orddt(i1)

            end do

!c  form product of reacting components as species in solution
!c  (not incremented - incremented)

            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdc(i1)
              prodrc = prodrc * (gammac(ic)*c(ic))**orddc(i1)
              prodrcinc = prodrcinc * (gammac(ic)*cinc(ic,tid))**orddc(i1)

            end do

!c  form product of reacting complexed species
!c  (not incremented - incremented)

            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1

            do i1 = istart2,istop2

              ix = jamdcx(i1)

              prodrc = prodrc * (gammax(ix)*cx(ix))**orddcx(i1)
              prodrcinc = prodrcinc *                                 &
                          (gammax(ix)*cxinc(ix,tid))**orddcx(i1)

            end do

           
!acting minerals
            
            istart2 = iamdphm(ireac)
            istop2 = iamdphm(ireac+1)-1

            do i1 = istart2,istop2

              ix = jamdphm(i1)

              prodrc = prodrc * (phim(ix)**ordmdphm(i1))
              prodrcinc = prodrcinc * (phim(ix)**ordmdphm(i1))

            end do

!c_uranium
!c  form product of summed reacting complexed species
!c  (not incremented - incremented)

            istart2 = iamdscx(ireac)
            istop2 = iamdscx(ireac+1)-1
            summed_species = .false.
            sumix = r0
            sumixinc = r0

            do i1 = istart2,istop2

              ix = jamdscx(i1)
              sumix = sumix + (gammax(ix)*cx(ix)*orddscx(i1))
              sumixinc = sumixinc + (gammax(ix)*cxinc(ix,tid)*orddscx(i1))
              summed_species = .true.

            end do

            if (summed_species) then
              prodrc = prodrc * sumix**orddsumx(im)
              prodrcinc = prodrcinc * sumixinc**orddsumx(im)
            end if

!c  hyperbolic terms - T^a

            istart2 = iamdm(ireac)
            istop2 = iamdm(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdm(i1)

                prodrc = prodrc * (totc(ic)/                          &
                        (fmdm(i1) + totc(ic)))**ordmdm(i1)
                prodrcinc = prodrcinc * (totcinc(ic,tid)/             &
                          (fmdm(i1) + totcinc(ic,tid)))**ordmdm(i1)

              end do

            end if
 
            
!c_isotopes
!c  hyperbolic terms - sum T^a

            istart2 = iamdsta2(ireac)
            istop2 = iamdsta2(ireac+1)-1
            itemp = 0
            
            do i1 = istart2, istop2                  

              istart3 = iamdsta(ireac)+itemp
              istop3 = istart3+ntsc(i1)-1
              sumic = r0
              sumicinc = r0
              do i2 = istart3, istop3
                ic = jamdsta(i2)
                sumic = sumic + totc(ic)
                sumicinc = sumicinc + totcinc(ic,tid)
              end do

              prodrc = prodrc                                      &
                   * (sumic/(fmdsta(i1) + sumic))**orddsta(i1)              
              prodrcinc = prodrcinc                                &
                     * (sumicinc/(fmdsta(i1) + sumicinc))**orddsta(i1)
                
              itemp = itemp + ntsc(i1)

            end do

!c isotopes
!c isotope fractionation

            if ((.not.far_from_equil(im)).and.(satm(im,tid).lt.r1)) then
              next = 0   
              do i = 1, nifrm(im)  ! loop through isotope sets
                istart2 = next + iamdiso(im)
                icur = iamdiso2(im) + i - 1
                istop2 = iamdiso(im) + jamdiso2(icur) - 1
                next = jamdiso2(icur)
                ibottom = jamdpair(istart2)
                alphartot = r1
                alphartop = r1
                !loop through isotope compents in set
                do i2 = istart2+1, istop2 
                    itop = jamdpair(i2)
                    alphar = phim(itop)/phim(ibottom)*jamdalpha(i2)
                    alphartot = alphartot + alphar
                    if (itop.eq.im) then
                      alphartop = alphar
                    end if
                end do
                
                prodrc = prodrc*alphartop/alphartot
                prodrcinc = prodrcinc*alphartop/alphartot

              end do
            else
              next = 0
              do i = 1, nifrm(im)  ! loop through isotope sets
                istart2 = next + iamdiso(im)
                icur = iamdiso2(im) + i - 1
                istop2 = iamdiso(im) + jamdiso2(icur) - 1
                next = jamdiso2(icur)
                ibottom = jamdiso(istart2)
                alphartot = r1
                alphartop = r1
                alphartotinc = r1
                alphartopinc = r1
                !loop through isotope compents in set
                do i2 = istart2+1, istop2 
                    itop = jamdiso(i2)
                    alphar = totc(itop)/totc(ibottom)*jamdalpha(i2)
                    alpharinc = totcinc(itop,tid)/totcinc(ibottom,tid)*&
                                jamdalpha(i2)
                    alphartot = alphartot + alphar
                    alphartotinc = alphartotinc + alpharinc
                
                    istart = iam(im)
                    istop = iam(im+1)-1 
                    do i1 = istart, istop
                        ic = jam(i1)
                        if (ic.eq.itop) then
                           alphartop = alphar
                           alphartopinc = alpharinc
                        end if
                    end do
                end do
                prodrc = prodrc*alphartop/alphartot
                prodrcinc = prodrcinc*alphartopinc/alphartotinc

              end do
            end if
       

!c  inhibition terms - T^a

            istart2 = iamdi(ireac)
            istop2 = iamdi(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdi(i1)
                prodrc = prodrc                                       &
                      * (fmdi(i1)/(fmdi(i1)+totc(ic)))**ordmdi(i1)
                prodrcinc = prodrcinc * (fmdi(i1)/                    &
                          (fmdi(i1)+totcinc(ic,tid)))**ordmdi(i1)
                
              end do

            end if

!c  hyperbolic terms - C^c

            istart2 = iamhc(ireac)
            istop2 = iamhc(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamhc(i1)

                prodrc = prodrc * (gammac(ic)*c(ic)/                  &
                   (fmhc(i1) + gammac(ic)*c(ic)))**ordmhc(i1)
                prodrcinc = prodrcinc * (gammac(ic)*cinc(ic,tid)/     &
                   (fmhc(i1) + gammac(ic)*cinc(ic,tid)))**ordmhc(i1)

              end do

            end if
	    

!c  inhibition terms - C^c

            istart2 = iamic(ireac)
            istop2 = iamic(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamic(i1)
                prodrc = prodrc                                   &
                      * (fmic(i1)                                 &
                      / (fmic(i1)+gammac(ic)*c(ic)))**ordmic(i1)
                prodrcinc = prodrcinc * (fmic(i1)/                &
                   (fmic(i1)+gammac(ic)*cinc(ic,tid)))**ordmic(i1)
                
              end do

            end if
	    
!c  hyperbolic terms - phi^m

            istart2 = iamdpm(ireac)
            istop2 = iamdpm(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                im2 = jamdpm(i1)

                prodrc = prodrc * (phim(im2)/                 &
                        (fmdpm(i1) + phim(im2)))**ordmdpm(i1)
                prodrcinc = prodrcinc * (phim(im2)/           &
                          (fmdpm(i1) + phim(im2)))**ordmdpm(i1)

              end do

            end if

!c  inhibition terms - phi^m

            istart2 = iamdpi(ireac)
            istop2 = iamdpi(ireac+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                im2 = jamdpi(i1)
                prodrc = prodrc * (fmdpi(i1)/                 &
                        (fmdpi(i1)+phim(im2)))**ordmdpi(i1)
                prodrcinc = prodrcinc * (fmdpi(i1)/           &
                          (fmdpi(i1)+phim(im2)))**ordmdpi(i1)
                
              end do

            end if

!c  compute total rate for surface controlled reactions
!c  [moles/(L bulk*day)] = [m^2 mineral/L bulk]
!c                          -----------         
!c                       * [moles/(m^2 mineral * day)]
!c                                 -----------
!c  and sum up parallel reaction rates for surface controlled
!c  dissolution/precipitation reactions (incremented - not incremented)

!c Calculate the salinity dependent mineral reaction rate coefficient f_s
!c  modify the ratem

            if (salinity_dependent(im)) then
                sar = 0.0d0
                sarinc =0.0d0
                call dratemin_salinity(totc,c, sar, sarinc, im, ivol)
                ratem = ratem - aream * (prodrcinc*sarinc - prodrc*sar)
            else
                ratem = ratem - aream * (prodrcinc - prodrc)
            end if

          end do       !loop over parallel diss/prec reactions

        end if         !reaction_type(im)

!c  compute difference of total dissolution/precipitation rate 
!c  for transport controlled dissolution/precipitation reactions
!c  (incremented - not incremented)

      elseif (rate_control(im).eq.'transport') then

        if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
           reaction_type(im).eq.'reversible'.or.                       &
           (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
            dg_lim(im)-satm(im,tid).gt.r0)) then

!c  compute difference of total dissolution rate 
!c  (incremented - not incremented)
 
          istart = iamd(im)
          iend = iamd(im+1)-1

          do ireac = istart,iend
 
!c  scale reaction rate, if dissolution reaction is limited by
!c  equilibrium conditions

            if (far_from_equil(im)) then
              prodrc = r1
              prodrcinc = r1
            else
              prodrc = dg_lim(im)-satm(im,tid)
              prodrcinc = dg_lim(im)-satminc
            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc(ic,tid)**orddt(i1)
            end do
 
!c  form product of reacting free species for current dissolution
!c  reaction, activity coefficients are here not considered explicitely,
!c  but are by definition included in the effective diffusion coefficient
!c  (free species and incremented free species)
 
            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1
            do i1 = istart2,istop2
              ic = jamdc(i1)
              prodrc = prodrc * c(ic)**orddc(i1)
              prodrcinc = prodrcinc * cinc(ic,tid)**orddc(i1)
            end do
 
!c  include complexed species in product of reacting species for current
!c  dissolution reaction
!c  (complexed species and incremented complexed species)
 
            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1
            do i1 = istart2,istop2
              ix = jamdcx(i1)
              prodrc = prodrc * cx(ix)**orddcx(i1)
              prodrcinc = prodrcinc * cxinc(ix,tid)**orddcx(i1)
            end do
 
!c  compute difference of total rate 
!c  [moles/(l bulk*day)] = [m mineral / m^3 bulk]
!c                          ---------   --- 
!c                       * [m^3 h2o/m^3 mineral * m^2 mineral/day]
!c                          --- --- -----------   ----------- 
!c                       * [moles/l h2o]
!c                                  ---
!c  and sum up difference of total dissolution rate 
!c  [moles/(l h2o)] (incremented - not incremented)

            ratem = ratem - aream * diffm(ireac)/xnud(ireac)  &
                         * (prodrcinc - prodrc)

          end do  

!c  do not allow precipitation 

        else            !reaction_type(im)

          ratem = r0
 
        end if          !reaction_type(im)

      end if            !rate_control(im)

!!c Calculate the salinity dependent mineral reaction rate coefficient f_s
!!c  modify the ratem
!
!      if (salinity_dependent(im)) then
!          salinity = 0.0
!          salinityinc = 0.0
!          do ic = 1, nc-1
!              if (namec(ic) .ne. 'o2(aq)') then
!                salinity = salinity + gfwc(ic)*totc(ic)
!                salinityinc = salinityinc + gfwc(ic)*totcinc(ic)
!              end if
!          end do
!          
!          if (sdtype(im) .eq. 'equation') then
!              sar = 0.0d0
!              sarinc = 0.0d0
!              
!              if (salinity .le. min_salinity(im)) then
!                  sar = min_sar(im)
!                  sarinc = min_sar(im)
!              else if (salinity .ge. max_salinity(im)) then
!                  sar = max_sar(im)
!                  sarinc = max_sar(im)
!              else
!                  do i = 1, nfac(im)
!                      sar = sar + sfac_sdmin(im,i)*(salinity**(i-1))
!                      sarinc = sarinc + sfac_sdmin(im,i)*(salinityinc**(i-1))
!                  end do
!              end if 
!          end if
!          
!          if (sar .gt. 0.0 .and. sar .le. 1.0) then
!            ratem = ratem*sar
!          else if (sar .le. 0.0) then
!              ratem = ratem*1.0d-10
!          else
!            if (rank == 0 .and. b_enable_output) then
!                write(ilog,'(2a)') 'error calculating salinity dependent factor of mineral  ',namem(im)
!                write(ilog,'(a,e12.5)') 'The salinity = ',salinity
!                write(ilog,'(a,e12.5)') 'The coefficient = ',sar
!                write(ilog,*) 'It should be between 0.0 to less or equal 1.0.'
!                stop
!            end if
!          end if
!          
!      end if    
!c  divide by increment of numerical differentiation
!c  and obtain derivative of total rate

      ratem = ratem/drtinc
 
      return
      end
