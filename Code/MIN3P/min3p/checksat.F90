!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/checksat.F90 $
!---------------------------------------------------------------------
!********************************************************************!


! ----------------------------------------------------------------------
! subroutine checksat                                                   
! -------------------                                                   
!                                                                       
! check for supersaturated condistions for dissolution of organic       
! compound from organic mixture                                         
!                                                                       
! written by:      Uli Mayer - January 25, 00                           
!                                                                       
! last modified:                                                        
!                                                                       
! definition of variables:                                              
!                                                                       
! I --> on input   * arbitrary  - initialized  + entries expected       
! O --> on output  * arbitrary  - unaltered    + altered                
!                                                                    I O
! common:                                                               
! gen.f:    real*8:                                                     
!           -------                                                     
!           cnew(nc,nn)        = concentrations of free species      + -
!                                - new time level [moles/l water]       
!           gamma(nc+nx,nn)    = activity coefficients of aqueous    + -
!                                species [-]                            
!           phiold(nm,nn)      = volume fractions of minerals        + -
!                                (old time level)                       
!           phi_init(nm,nn)    = volume fractions of minerals        + -
!                                (initial condition)                    
!                                                                       
!           integer*4:                                                  
!           ----------                                                  
!           nn                 = total number of control volumes     + -
!           idetail_rt         = information level                   + -
!           ilog               = unit number, logbook file           + -
!                                                                       
! chem.f:   real*8:                                                     
!           -------                                                     
!           conc_mol_avg(nthreads)
!c                             = average molar concentration of      + -
!                                organic mixture                        
!           densm(nm)          = density of free phase product       + -
!           eqm(nm,nthreads)   = equilibrium constants for minerals  + -
!           gfwm(nm)           = gram formula weight of free phase   + -
!                                product                                
!           phimin(nm)         = minimum volume fractions for        + -
!                                free phase                             
!           satm(nm,nthreads)  = IAP/K for minerals                  + -
!           xnum(nm*nc)        = stoichiometric coefficients of      + -
!                                components in mineral                  
!                                                                       
!           integer*4:                                                  
!           ----------                                                  
!           iam(nm+1)          = row pointer array to                + -
!                                stoichiometric coefficients of         
!                                components in mineral                  
!           jam(nm*nc)         = column pointer array to             + -
!                                stoichiometric coefficients of         
!                                components in mineral                  
!           nm                 = number of minerals specified        + -
!                                                                       
!           character:                                                  
!           ----------                                                  
!           namem(nm)          = mineral names                       + -
!           reaction_type(nm)  = 'reversible'                        + -
!                                'dissolution_to_equilibrium'           
!                                'precipitation_to_equilibrium'         
!                                'dissolution_far_from_equilibrium'     
!                                'precipitation_far_from_equilibrium'   
!                                'monod'                                
!                                'raoult'                               
!                                                                       
!                                                                       
! local:    real*8:                                                     
!           -------                                                     
!           conc_mol          = molar concentration of organic          
!                               compound in organic mixture             
!           frac_mol          = mole fraction of organic compound       
!                               in organic mixture                      
!           satm_max          = maximum tolerable degree of             
!                               supersaturation                         
!                                                                       
!           integer*4:                                                  
!           ----------                                                  
!           im                = counter                                 
!           ivol              = counter                                 
!                                                                       
!           logical:                                                    
!           --------                                                    
!           check_saturation   = .true.  -> check for supersaturated    
!                                           conditions for organic      
!                                           compounds when dissolving   
!                                           from organic mixture        
!                                                                       
! external: molconc  = compute molar concentration of organic mixture   
! ----------------------------------------------------------------------
                                                                        
      SUBROUTINE checksat 
                                                                        
      use parm 
      use gen 
      use chem
#ifdef OPENMP
      use omp_lib 
#endif
                                                                        
      implicit none
      
      integer :: i, im, ivol, tid
      
      real*8 :: satm_max, conc_mol, frac_mol, satindex
      
      logical check_saturation
      
      external :: satindex
                
      !This is not needed when interface is declared
      !EXTERNAL molconc                                                                         
      
      !For the shared-memory parallel version, the variables defined in the module
      !are shared variables by different threads. So as to avoid race condition, 
      !these variable should be passed by dummy arguments. Danyang Su, 2013-05.
      interface
      
        !>interface of molconc
        subroutine molconc(phim)
          use parm, only : type_r8
          real(type_r8), dimension(*) :: phim    
        end subroutine molconc
      
      end interface 
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
                                                                        
      satm_max = 2.0d0 
                                                                        
!  determine if check for supersaturated conditions must be performed   
                                                                        
      check_saturation = .false. 
      DO im = 1, nm 
      IF (reaction_type (im) .eq.'raoult') then 
         check_saturation = .true. 
      ENDIF 
      enddo 
                                                                        
!  check for superaturated conditions in solution domain                
                                                                        
      IF (check_saturation) then 
                                                                        
         DO ivol = 1, nngl 
                                                                        
!  compute total molar concentration in organic mixture                 
                                                                        
         CALL molconc (phiold (1, ivol) ) 
                                                                        
!  check individual organic compounds for supersaturated conditions     
                                                                        
         DO im = 1, nm 
                                                                        
         IF (phi_init (im, ivol) .gt.phimin (im) ) then 
                                                                        
!  compute mol fraction of organic compound in organic mixture          
                                                                        
            conc_mol = phiold (im, ivol) * densm (im) / gfwm (im) 
            frac_mol = conc_mol / conc_mol_avg(tid) 
                                                                        
!  pure phase saturation index                                          
                                                                        
            satm(im,tid) = satindex(cnew(1,ivol),eqm(im,tid),gamma(1, &
                       ivol),xnum,iam,jam,im)                                  
                                                                        
!  compute effective solubility                                         
                                                                        
            satm (im,tid) = satm (im,tid) / frac_mol 
                                                                        
!  set flag for reduction of time step to .true., if supersaturated     
!  by a factor of satm_max                                              
                                                                        
            IF (satm (im,tid) .gt.satm_max) then 
                                                                        
               IF (idetail_rt > 0 .and. b_enable_output) then 
                  if (rank == 0) then
                    WRITE (ilog, '(72a)') ('-', i = 1, 72) 
                    WRITE (ilog, '(a)')                                &
                           'organic compound dissolving too fast' 
                    WRITE (ilog, '(i6,a,1x,e13.6)') ivol,              &
                           trim(namem (im)) , satm (im,tid)                                                   
                    WRITE (ilog, '(a)') 'reducing time step' 
                    WRITE (ilog, '(72a)') ('-', i = 1, 72) 
                  end if
               ENDIF 
                                                                        
               reduce_timestep = .true. 
               RETURN 
                                                                        
            ENDIF 
                                                                        
         ENDIF 
                                      !(im=1,nm)                        
         enddo 
                                      !(ivol=1,nn)                      
         enddo 
                                      !(check_saturation)               
      ENDIF 
                                                                        
      RETURN 
      END SUBROUTINE checksat                       
