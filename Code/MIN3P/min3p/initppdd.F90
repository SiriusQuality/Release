!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 496 $
!> $Author: fgerard $
!> $Date: 2017-07-19 22:34:11 +0200 (mer., 19 juil. 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/initppdd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initppdd
!c -------------------
!c
!c physical parameters for density dependent flow
!c
!c from Uli Mayer template
!c
!c written by:      Tom Henderson - August 22, 2002
!c
!c last modified:   Tom Henderson - July 27, 2004 - no overwrite of nodal K file
!c                                  September 10, 2003
!c                                  fixed error - early return for permeability-field
!c                                  napl addition
!c
!c		    Celine Blitz Frayret (CBF) and Frédéric Gérard (FG) - from May 9, 2017 - According to the MIN3P-ArchiSimple


!c  NOTE: for density dependent flow, permeabilities are stored in
!c  arrays.  Specific storage, air entry, and Van Genuchten alpha
!c  coefficients converted from length units to pressure units.
!c
!c  
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common: 
!c gen.f:    real*8:
!c           ------- 
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c           canopy_int         = canopy interception                 + -
!c           sec_per_days       = conversion factor from SI input     + -
!c                                units for physico-chemical
!c                                parameters to internal time units
!c           pet                = potential evapotranspiration        + -
!c           pe_soil            = potential soil evaporation          + -
!c           qroot_tot_max      = total root water uptake             + -
!c           time_soi           = next read time for soil specific    + -
!c                                parameters
!c
!c
!c           integer*4:
!c           ----------
!c           icnv               = unit number, type conversion and    + -
!c                                temporary storage
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           idbg               = unit number, debugging file         + -
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, logbook                + -
!c           ihyc               = unit number, initial hydraulic      + -
!c                                             conductivity
!c                                             distribution
!c           isoi               = unit number, soil specific          * +
!c                                parameters
!c           itmp               = unit number, temporary storage      + -
!c           itec               = i-index for tecplot                 + -
!c           jtec               = j-index for tecplot                 + -
!c           ktec               = k-index for tecplot                 + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           l_zone_name        = length of zone name                 * +
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           nn                 = total number of control volumes     + -
!c           nvx                = number of control volumes in        + -
!c                                x-direction
!c           nvy                = number of control volumes in        + -
!c                                y-direction
!c           nvz                = number of control volumes in        + -
!c                                z-direction
!c
!c           logical:
!c           --------
!c           transient_flow     = .true.  -> .not.steady_flow,        + -
!c                                        -> transient flow
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       * +
!c           section_header     = section header                      * +
!c           zone_name          = name of zone                        * +
!c
!c phys.f:   real*8:
!c           -------
!c           condxx(nzn)        = saturated permeability in           * +
!c                                x-direction
!c           condyy(nzn)        = saturated permeability in           * +
!c                                y-direction
!c           condzz(nzn)        = saturated permeability in           * +
!c                                z-direction
!c           permx(nn)          = saturated permeability in           * + 
!c                                x-direction
!c           permy(nn)          = saturated permeability in           * +
!c                                y-direction
!c           permz(nn)          = saturated permeability in           * +
!c                                z-direction
!c           spstor(nzn)        = specific storage coefficient        * +
!c           swr(nzn)           = residual saturation                 * +
!c           expn(nzn)          = soil hydraulic function parameter   * +
!c           spalpha(nzn)       = soil hydraulic function parameter   * +
!c           spbeta(nzn)        = soil hydraulic function parameter   * +
!c           spgamma(nzn)       = soil hydraulic function parameter   * +
!c           aentry(nzn)        = air entry pressure                  * +
!c           root_length_dens(nzn) = root length density              * +
!c           satwdry(nzn)       = air-dry water saturation            * +
!c           satwlim(nzn)       = water saturation at wilting point   * +
!c           satwfield(nzn)     = water saturation at field capacity  * +
!c           rew0(nzn)          = relative extractable water at       * +
!c                                50% of maximum extraction capacity 
!c                                (fitting parameter)
!c           p1(nzn)            = fitting parameter for root water    * +
!c                                uptake function
!c           tree_trans_factor(nzn) = tree transpiration factor       * +
!c           canopy_evap_factor(nzn) = efficiency factor for canopy   * +
!c                                     evaporation
!c
!c
!c           integer*4:
!c           ----------
!c           mprop_name(nzn)    = name of material property zone      + -
!c           nzn                = number of material property zones   + -
!c
!c           logical:
!c           --------
!c           permeability_field = .true.  -> read permeability field  * +
!c                                .false. -> specify permeabilities
!c                                           in input file
!c CBF removed  root_uptake        = .true.  -> compute root water       * +
!c                                           uptake
!c dens.f:   logical:
!c           --------
!c           init_perm          = .true. -> initial media properties  * +
!c                                           in permeability units
!c           init_cond          = .true. -> initial media properties  * +
!c                                           in hydraulic conductivity
!c                                           units
!c local:    real*8:
!c           -------
!c           dens_h2o           = density of water [kg m^-3]
!c           gacc               = gravitational acceleration [m s^-2]
!c           r0                 = constant
!c           r1                 = constant
!c           rdummy             = real*8 dummy variable 
!c           visc_h2o           = dynamic viscosity 
!c                                [Pa s] = [kg m^-1 s^-1] 
!c           xpmin              = min. x-coordinate of material
!c                                property zone
!c           xpmax              = max. x-coordinate of material
!c                                property zone
!c           ypmin              = min. y-coordinate of material
!c                                property zone
!c           ypmax              = max. y-coordinate of material
!c                                property zone
!c           zpmin              = min. z-coordinate of material
!c                                property zone
!c           zpmax              = max. z-coordinate of material
!c                                property zone
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter
!c           ivol               = counter
!c           izn                = counter (zones)
!c           l_string           = length of text string
!c
!c           logical:
!c           --------
!c           found_section      = .true.  -> section header was
!c                                           found in input file
!c           found_subsection   = .true.  -> subsection header was
!c                                           found in input file
!c
!c           character:
!c           ----------
!c           subsection         = name of subsection in input file
!c           cdummy             = character dummy variable
!c
!c external: findstrg  = find text string in file
!c           readbloc  = read section of input file and write to
!c                       temporary file
!c ----------------------------------------------------------------------
 
      subroutine initppdd
 
      use parm
      use gen
      use phys
      use dens
      use writeversion
      use file_unit, only : lun_get, lun_free
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use module_binary_mpiio, only :  binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close,              &
                                       binary_subarray_initialize

      implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#elif PETSC
#include <finclude/petscsys.h>
#endif     
      
      
      integer :: i, ivol, ivol_l, izn, l_string, ierrcode
      
      real*8 :: convk, rdummy, qroot_tot_max

      external findstrg, readbloc

      logical found_section, found_subsection
      character*72 subsection
      character*1 cdummy
      
      integer :: iskip, nskip
      character*2048 strbuffer
      character*72 :: tec_variables(6)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, rhalf=0.5d0,        & 
                 tiny=1.0d-5, r05 = 1.0d-5 
      
#ifdef MPI
      integer(kind=MPI_OFFSET_KIND) :: offset_ihyc, offset_ihyc_temp
#else
      integer*8 :: offset_ihyc, offset_ihyc_temp
#endif

!c  set defaults
      dens_h2o = 1.0d+3
      visc_h2o = 1.0d-3
      convk = visc_h2o/(ref_dens * gacc)  !conductivity * convk = permeability
      permeability_field = .false.
      storcoeff_field = .false.
      ! CBF root_uptake = .false.

!c  initialize relative permeability to 1.0
      
      do ivol = 1,nngl
        relperm(ivol) = r1
      end do 
 
!c  read parameters for variably saturated flow and write 
!c  to temporary file
 
      section_header = 'physical parameters - variably saturated flow'
      call readbloc (idat,itmp,section_header,found_section,.true.)

!c  define length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if

!c  terminate program if section header not found

      if (.not.found_section) then
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
 
      elseif (found_section) then

!c  write section header to generic output file
        if (b_enable_output .and. b_enable_output_gen) then
          write(igen,'(/72a)')('-',i=1,72)
          write(igen,'(a)') section_header(:l_string)
          write(igen,'(72a/)')('-',i=1,72)
        end if

!c  read flow parameters as nodal values from separate file

!c  read permeability field from file

        subsection = 'read permeability field from file'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
          
          open(ihyc,file=prefix(:l_prfx)//'.hyc',status='unknown',    &
                form='formatted')
     
          permeability_field = .true.

!c  read permeabilities

          read(ihyc,*,err=998,end=998) cdummy
          read(ihyc,*,err=998,end=998) cdummy
          read(ihyc,*,err=998,end=998) cdummy
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
                read(ihyc,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif 
            read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,      &
                                         permx(ivol), permy(ivol),    &
                                         permz(ivol)
            
          end do

          close(ihyc)
          call lun_free(ihyc)
                
        end if

!c  read hydraulic conductivity field from file

        subsection = 'read hydraulic conductivity field from file'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          open(ihyc,file=prefix(:l_prfx)//'.hyc',status='unknown',    &
               form='formatted') 

          permeability_field = .true.

!c  read hydraulic conductivities
!c  and convert to permeabilities

          read(ihyc,*,err=998,end=998) cdummy
          read(ihyc,*,err=998,end=998) cdummy
          read(ihyc,*,err=998,end=998) cdummy
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
                read(ihyc,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif 
            read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,      &
                                         permx(ivol), permy(ivol),    &
                                         permz(ivol)
!cprovi-------------------------------------------------------------
!cprovi Change for intrinsic permeability [m2]
!cprovi-------------------------------------------------------------        
            permx(ivol) = permx(ivol) * convk 
            permy(ivol) = permy(ivol) * convk 
            permz(ivol) = permz(ivol) * convk 
          end do
          
          close(ihyc)
          call lun_free(ihyc)
                
        end if
     
!cprovi--------------------------------------------------------------
!cprovi Read Specific Storage coefficients from file
!cprovi--------------------------------------------------------------      
        subsection = 'read specific storage coefficient from file'
         
        call findstrg(subsection,itmp,found_subsection)
        
        if (found_subsection) then
          open(istor,file=prefix(:l_prfx)//'.spstor',status='unknown', &
                form='formatted')
          storcoeff_field = .true.
          stor=r0
          read(istor,*,err=998,end=998) cdummy
          read(istor,*,err=998,end=998) cdummy
          read(istor,*,err=998,end=998) cdummy
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
                read(istor,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif
            read(istor,*,err=998,end=998) rdummy, rdummy, rdummy,      &
                                         stor(ivol)
            
            stor(ivol)=stor(ivol)/(gacc * ref_dens)     
          end do
                
          close(istor)
          call lun_free(istor)
                  
        end if
      
!cprovi--------------------------------------------------------------
!cprovi Read Skemton coefficient from file
!cprovi--------------------------------------------------------------      
        if (compute_ice_sheet_loading) then   
         subsection = 'read skempton coefficient from file'
         
           call findstrg(subsection,itmp,found_subsection)
        
           if (found_subsection) then
             open(iskempton,file=prefix(:l_prfx)//'.skempton',    & 
                  status='unknown',form='formatted')
             skempton=r1
             read(iskempton,*,err=998,end=998) cdummy
             read(iskempton,*,err=998,end=998) cdummy
             read(iskempton,*,err=998,end=998) cdummy
             nskip = 0
             do ivol = 1,nngl
#ifdef PETSC
               do iskip = 1, node_idx_lg2g(ivol) - nskip -1  
                   read(iskempton,*,end=999,err=999) rdummy
               end do
               nskip = node_idx_lg2g(ivol)
#endif  
               read(iskempton,*,err=998,end=998)rdummy, rdummy,   &
                                                rdummy, skempton(ivol)
                  
                       
             end do

             close(iskempton)
             call lun_free(iskempton)
                  
           end if
        end if
     
     
     
        subsection = 'residual gas saturation'
       
        call findstrg(subsection,itmp,found_subsection)
        sgr=r0
        if (found_subsection) then
           read(itmp,*,err=999,end=999) sgr
           if (sgr>r1.or.sgr<r0) then
             sgr=r0
           end if
        end if


!c  convert to internal time units

        if (permeability_field) then
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppdd_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)                  
    !$omp do schedule(static)
#endif        
          do ivol = 1,nngl
            permx(ivol) = permx(ivol)*sec_per_days
            permy(ivol) = permy(ivol)*sec_per_days
            permz(ivol) = permz(ivol)*sec_per_days
          end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif 

!c  feed-back to output file
          if (b_enable_output .and. b_enable_output_gen) then
            write(igen,'(3a)') 'read as nodal properties from file ',  &
     &                          prefix(:l_prfx)//'.hyc' 
          end if
 
!cprovi--------------------------------------------------------------
!cprovi--------------------------------------------------------------
!cprovi--------------------------------------------------------------
          if (compute_ice_sheet_loading) then          
             permx0=permx
             permy0=permy
             permz0=permz
          end if 
!cprovi--------------------------------------------------------------
!cprovi--------------------------------------------------------------
!cprovi--------------------------------------------------------------

        end if

!c  read material properties for material property zones from input file
               
        do izn = 1,nzn                !loop over property zones

!c  assign defaults for physical parameters for variably saturated flow

          spstor(izn) = r0

!c  search for entry for material property zone in input file

          zone_name = mprop_name(izn)

!c  define length of name of material property zone

          l_zone_name = index(zone_name,'  ')-1
          if (l_zone_name.lt.0.or.l_zone_name.gt.72) then
            l_zone_name = 72
          end if

!c  search temporary data file for current material property zone
!c  and write to scratch file

          call readbloc (itmp,icnv,zone_name,found_subsection,.true.)

!c  read material properties

            if (found_subsection) then

!c  initial media properties in permeability units

            if (.not.permeability_field) then

!c  permeabilities/conductivities in y-direction

              if (init_perm) then
                subsection = 'permeability in x-direction'
              else if (init_cond) then
                subsection = 'hydraulic conductivity in x-direction'
              end if

              call findstrg(subsection,icnv,found_subsection)

              if (found_subsection.and.nvx.gt.1) then

                read(icnv,*,err=999,end=999) condxx(izn)
                if (init_cond) then
                  condxx(izn) = condxx(izn) * convk
                end if

              elseif (.not.found_subsection.and.nvx.gt.1) then

                l_string = index(subsection,'  ')-1
                if (l_string.eq.-1.or.l_string.gt.72) then
                l_string=72
                end if
                
                if (rank == 0) then
                  write(ilog,*) 'SIMULATION TERMINATED'
                  write(ilog,*) 'error reading input file'
                  write(ilog,*) 'subsection "',subsection(:l_string),   &
                                  '" missing'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop

              end if

!c  permeabilities/conductivities in y-direction

              if (init_perm) then
                subsection = 'permeability in y-direction'
              else if (init_cond) then
                subsection = 'hydraulic conductivity in y-direction'
              end if

              call findstrg(subsection,icnv,found_subsection)

              if (found_subsection.and.nvy.gt.1) then

                read(icnv,*,err=999,end=999) condyy(izn)

                if (init_cond) then
                  condyy(izn) = condyy(izn) * convk
                end if

              elseif (.not.found_subsection.and.nvy.gt.1) then

                if (rank == 0) then  
                  l_string = index(subsection,'  ')-1
                  if (l_string.eq.-1.or.l_string.gt.72) then
                     l_string=72
                  end if
                  
                  write(ilog,*) 'SIMULATION TERMINATED'
                  write(ilog,*) 'error reading input file'
                  write(ilog,*) 'subsection "',subsection(:l_string),   &
                                '" missing'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop

              end if
  
!c  permeabilities in z-direction

              if (init_perm) then
                subsection = 'permeability in z-direction'
              else if (init_cond) then
                subsection = 'hydraulic conductivity in z-direction'
              end if

              call findstrg(subsection,icnv,found_subsection)

              if (found_subsection.and.nvz.gt.1) then

                read(icnv,*,err=999,end=999) condzz(izn)

                if (init_cond) then
                    condzz(izn) = condzz(izn) * convk
                end if

              elseif (.not.found_subsection.and.nvz.gt.1) then

                if (rank == 0) then
                  l_string = index(subsection,'  ')-1
                  if (l_string.eq.-1.or.l_string.gt.72) then
                     l_string=72
                  end if
                  write(ilog,*) 'SIMULATION TERMINATED'
                  write(ilog,*) 'error reading input file'
                  write(ilog,*) 'subsection "',subsection(:l_string),   &
     &                          '" missing'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop

              end if !found_subsection.and.nvz.gt.1

            end if  !init_perm

!c  specific storage coefficient


        subsection = 'specific storage coefficient'

        call findstrg(subsection,icnv,found_subsection)
        if (found_subsection.and.transient_flow) then
            read(icnv,*,err=999,end=999) spstor(izn)

!c convert specific storage from units of [1/h] to [1/P]
!c Ss = Sp * freshwater density * gravitational constant
!c Sp = specific storage with respect to pressure

          spstor(izn) = spstor(izn)/(gacc * ref_dens)
                     
        elseif (.not.found_subsection.and.transient_flow) then
          if (.not. update_permeability) then
            if (rank == 0) then
              l_string = index(subsection,'  ')-1
              if (l_string.eq.-1.or.l_string.gt.72) then
                 l_string=72
              end if
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading input file'
              write(ilog,*) 'subsection "',subsection(:l_string), &
                            '" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop
          end if
              
         end if
       
            if ((variably_saturated).or.(napl_permeability)) then
            
             !cprovi------------------------------------------------------------------
             !cprovi Parameters for oven dry model
             !cprovi Fayer, M.J. & C.S. Simmons, 1995. Modified Soil Water 
             !cprovi Retention Functions for All Matric Suctions, 
             !cprovi Water Resour. Res. 31(5), 1233?238.
             !cprovi------------------------------------------------------------------
             subsection = 'oven-drying parameters'
             isovendrying(izn) = .false.
             beta_ovendry(izn) = r1 / (gacc * ref_dens)
             hm_ovendry(izn) = -r05 * gacc * ref_dens 
             w0_ovendry(izn) = 1.0d-10
             cp0_ovendry(izn) = 0.025d0
             call findstrg(subsection,icnv,found_subsection)

             if (found_subsection) then
             
                isovendrying(izn) = .true.
                read(icnv,*,err=999,end=999) hm_ovendry(izn)
                read(icnv,*,err=999,end=999) w0_ovendry(izn)
                read(icnv,*,err=999,end=999) beta_ovendry(izn)
                read(icnv,*,err=999,end=999) cp0_ovendry(izn)
                hm_ovendry(izn) = -hm_ovendry(izn) * gacc * ref_dens
                beta_ovendry(izn) = beta_ovendry(izn)/ (gacc * ref_dens)
                 
             end if
!c  soil hydraulic function parameters

              subsection = 'soil hydraulic function parameters'
              
              call findstrg(subsection,icnv,found_subsection)

              if (found_subsection) then

                read(icnv,*,err=999,end=999) swr(izn)

                if ((variably_saturated).or.                      &
                   (napl_kfunction.eq.'vangenuchten')) then

                  read(icnv,*,err=999,end=999) spalpha(izn)
                  read(icnv,*,err=999,end=999) spbeta(izn)
                  read(icnv,*,err=999,end=999) expn(izn)
                  read(icnv,*,err=999,end=999) aentry(izn)

!c convert VG alpha from units of 1/L to 1/pressure
                spalpha(izn) = spalpha(izn)/(gacc * ref_dens)

!c convert air entry pressure from units of L to pressure
                aentry(izn) = aentry(izn) * gacc * ref_dens

!c  assign remaining soil hydraulic function parameters      

                  spgamma(izn) = r1-(r1/spbeta(izn))

                end if

              elseif (.not.found_subsection) then

                if (rank == 0) then  
                  l_string = index(subsection,'  ')-1
                  if (l_string.eq.-1.or.l_string.gt.72) then
                     l_string=72
                  end if
                  write(ilog,*) 'SIMULATION TERMINATED'
                  write(ilog,*) 'error reading input file'
                  write(ilog,*) 'subsection "',subsection(:l_string),   &
                                '" missing'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop

              end if

            end if             !(variably_saturated)


! CBF : REMOVED ROOT UPTAKE RELATED PARAMETERS ----------------------------
!c  read parameters for root water uptake
!CBF            subsection = 'root water uptake'
!            call findstrg(subsection,icnv,found_subsection)
!            if (found_subsection) then
!              root_uptake = .true. 
!              read(icnv,*,err=999,end=999) satwlim(izn)
!              read(icnv,*,err=999,end=999) satwfield(izn)
!              read(icnv,*,err=999,end=999) satwdry(izn)	
!              read(icnv,*,err=999,end=999) root_length_dens(izn)
!              read(icnv,*,err=999,end=999) rew0(izn) 
!              read(icnv,*,err=999,end=999) p1(izn)
!              read(icnv,*,err=999,end=999) tree_trans_factor(izn)
!              read(icnv,*,err=999,end=999) canopy_evap_factor(izn)
!c  modify saturation of wilting point, if necessary
!cff            satwlim(izn) = dmax1(satwlim(izn),1.5d0*swr(izn),0.01d0)
!            elseif (.not.found_subsection) then
!              if (root_uptake) then
!                if (rank == 0) then  
!                  l_string = index(subsection,'  ')-1
!                  if (l_string.eq.-1.or.l_string.gt.72) then
!                       l_string=72
!                  end if
!                  write(ilog,*) 'SIMULATION TERMINATED'
!                  write(ilog,*) 'error reading input file'
!                  write(ilog,*) 'subsection "',subsection(:l_string),   &
!                                '" missing'
!                  close(ilog)
!                end if
!#ifdef PETSC
!                call petsc_mpi_finalize
!#endif
!                stop
!              end if
!            end if
! ------------------- CBF END -------------------------------------


!c  write parameters for variably saturated flow to generic output file
            if (b_enable_output .and. b_enable_output_gen)then
                
            if (nzn.lt.10) then
              write(igen,'(/a,i1,a,1x,a)') 'material property zone ', &
     &                                      izn,':',                  &
     &                                      zone_name(:l_zone_name)
            else
              write(igen,'(/a,i2,a,1x,a)') 'material property zone ', &
     &                                      izn,':',                  &
     &                                      zone_name(:l_zone_name)
            end if
            write(igen,'(72a)')('-',i=1,72)

            if (nvx.gt.1) then
              write(igen,'(a,1pe10.3)')                               &
     &        'saturated permeability k_xx                    = ',    &
     &         condxx(izn)
            end if
            if (nvy.gt.1) then
              write(igen,'(a,1pe10.3)')                               &
     &        'saturated permeability k_yy                     = ',   &
     &         condyy(izn)
            end if
            if (nvz.gt.1) then
              write(igen,'(a,1pe10.3)')                               &
     &        'saturated permeability k_zz                     = ',   &
     &         condzz(izn)
            end if
            
          if (transient_flow) then
              write(igen,'(a,1pe10.3)')                               &
     &        'specific storage coefficient                     = ',  &
     &         spstor(izn)
            end if
            if (variably_saturated) then
              write(igen,'(/a/,3(a,41x,a,1pe10.3/),a,41x,a,1pe10.3)') &
     &        'van genuchten parameters:',                            &
     &        'alpha ',' = ',spalpha(izn),                            &
     &        'beta  ',' = ',spbeta(izn),                             &
     &        'gamma ',' = ',spgamma(izn),                            &
     &        'expn  ',' = ',expn(izn)
              write(igen,'(a,1pe10.3)')                               &
     &        'air entry pressure                              = ',   &
     &         aentry(izn)
            end if
! CBF          if (root_uptake) then
! CBF            write(igen,'(/a/,7(a,18x,a,1pe10.3/),a,18x,a,1pe10.3)') &
! CBF     &        'root uptake parameters:',                              &
! CBF     &        'saturation at wilting point: ',' = ',satwlim(izn),     &
! CBF     &        'air-dry water saturation:    ',' = ',satwdry(izn),     &
! CBF     &        'root length density:         ',' = ',                  &
! CBF     &         root_length_dens(izn),                                 &
! CBF     &        'fitting parameter REW_0:     ',' = ',rew0(izn),        &
! CBF     &        'fitting parameter p1:        ',' = ',p1(izn),          &
! CBF     &        'tree transpiration factor:   ',' = ',                  &
! CBF     &         tree_trans_factor(izn),                                &
! CBF     &        'canopy evaporation factor:   ',' = ',                  &
! CBF     &         canopy_evap_factor(izn)
! CBF          end if
          
          end if

!c  conversion of time units for computation in days


            if (nvx.gt.1) then
               condxx(izn) = condxx(izn) * sec_per_days
            end if
            if (nvy.gt.1) then
               condyy(izn) = condyy(izn) * sec_per_days
            end if
            if (nvz.gt.1) then
               condzz(izn) = condzz(izn) * sec_per_days
            end if

          elseif (.not.found_subsection) then
            
            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading section "',                  &
     &                       section_header(:l_string),'" ',            &
     &                      'in input file'
              write(ilog,*) 'entry for material property zone "',       &
     &                       zone_name(:l_zone_name),'" missing'
              write(ilog,*) 'error may also be caused by missing or ',  &
     &                      'mispelled keyword for nodal property ',    &
     &                      'zone input'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if                          !(found_subsection)

        end do                            !loop over property zones

      end if                              !(found_section)

! CBF removed all root related reads
!
!c  open file containing time dependent parameters for root water 
!c  uptake and read initial parameter set
!
!      if (root_uptake) then
!        !isoi = 16
!        isoi = lun_get()
!        open(isoi,file=prefix(:l_prfx)//'.soi',                       &
!                  err=997, status='old')
!        read(isoi,*,err=998,end=998) cdummy
!        read(isoi,*,err=998,end=998) time_soi,pet,pe_soil,canopy_int
!        pet = pet * sec_per_days
!        pe_soil = pe_soil*sec_per_days
!        canopy_int = canopy_int*sec_per_days
!        qroot_tot_max = tree_trans_factor(1) * pet                    &
!                      - canopy_int/canopy_evap_factor(1)
!      end if
! CBF end
!c  output of nodal hydraulic conductivities           

      
      if (.not.permeability_field) then

        if (b_enable_output) then
            
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_o.hyc'
            else
              strbuffer = prefix(:l_prfx)//'_'//                       &
                          trim(adjustl(str_rank))//'_o.hyc'
            end if
              
            call binary_file_open(Petsc_Comm_World, ihyc,      &
                         trim(strbuffer), b_output_mpiio_single)

          else
            open(ihyc,file=prefix(:l_prfx)//'_o'//                     &
                 trim(adjustl(str_rank))//'.hyc',status='unknown',     &
                 form='formatted')
          end if

!c  version information
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(ihyc, "#")
        end if
      
!c  title and variables
        if (b_output_binary) then
          strbuffer = 'dataset '//prefix(:l_prfx)//''
          offset_ihyc = 0
          call tecplot_binary_write_header(Petsc_Comm_World,           &
                       ihyc, "#!TDV102", trim(strbuffer), offset_ihyc, &
                       b_output_mpiio_single,.false.)           

          tec_variables(1:6) = [character(len=72) ::"x", "y", "z",     &
                                "k_xx", "k_yy", "k_zz"]
          
          call tecplot_binary_write_variable(Petsc_Comm_World, ihyc, 6,&
                       tec_variables(1:6), offset_ihyc,                &
                       b_output_mpiio_single,.false.)

        else
          write(ihyc,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          write(ihyc,'(2a)') 'variables = "x", "y", "z", "k_xx", ',    &
     &                       '"k_yy", "k_zz"'
        end if

!c  zone record
        if (b_output_binary) then
          strbuffer = "K - initial [m/s]" 
          offset_ihyc_temp = offset_ihyc
          
          if (b_output_multizone) then
            call tecplot_binary_write_zoneinfo(Petsc_Comm_World,ihyc,  &
                         trim(strbuffer),offset_ihyc,itec,jtec,ktec,   &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)          
            offset_ihyc = offset_ihyc_temp +                           &
                          (11+len_trim(strbuffer))*4*nprcs+4
          else
            call tecplot_binary_write_zoneinfo(Petsc_Comm_World,ihyc,  &
                         trim(strbuffer),offset_ihyc,                  &
                         itec_gbl,jtec_gbl,ktec_gbl,                   &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)          
            offset_ihyc = offset_ihyc_temp +                           &
                          (12+len_trim(strbuffer))*4
          end if
        else
          write(ihyc,'(a,3(a,i5),a)')                                  &
     &          'zone t = "K - initial [m/s]", ',                      &
     &          'i =',itec,', j =',jtec,', k =',ktec,',  f=point' 
        end if
        
!c  section information for binary output
        if (b_output_binary) then
          offset_ihyc_temp = offset_ihyc
          call tecplot_binary_write_section(Petsc_Comm_World,ihyc,6,   &
                       nn_offset,offset_ihyc,b_output_mpiio_single,    &
                       .false.,b_output_multizone)
          allocate(realbuffer(nn*6)) 
          realbuffer = 0.0d0
        end if

!c  output of hydraulic conductivities in units [m/s]

        ivol_l = 0
        
        do ivol = 1,nngl
!c  skip ghost nodes
#ifdef PETSC
          if (node_idx_lg2l(ivol) < 0) then
              cycle
          end if 
#endif  

          izn = mpropvs(ivol)
          
          ivol_l = ivol_l + 1 
          
          if (b_output_binary) then
              realbuffer((ivol_l-1)*6+1:ivol_l*6) = (/                 &
                                   xg(ivol),yg(ivol),zg(ivol),         &
                                   condxx(izn) / convk / sec_per_days, &
                                   condyy(izn) / convk / sec_per_days, &
                                   condzz(izn) / convk / sec_per_days/)
          else
            write(ihyc,'(6e15.7)') xg(ivol),yg(ivol),zg(ivol),         &
                                   condxx(izn) / convk / sec_per_days, &
                                   condyy(izn) / convk / sec_per_days, &
                                   condzz(izn) / convk / sec_per_days
          end if
          
        end do
        
        if(b_output_binary) then
          if (b_output_multizone .or. .not.b_output_mpiio_single) then
            call binary_write_data(ihyc, size(realbuffer,1),           &
                         realbuffer, offset_ihyc,b_output_mpiio_single)
          else
            call binary_subarray_initialize(6,b_mpiarray_ihyc_init,    &
                        .false.,mpiarray_filetype_ihyc,                &
                        mpiarray_sizes_gbl_ihyc,                       &
                        mpiarray_sizes_sub_ihyc,                       &
                        mpiarray_starts_sub_ihyc)
            call binary_write_data(ihyc, size(realbuffer,1),           &
                         realbuffer, offset_ihyc,mpiarray_filetype_ihyc)
          end if
          deallocate(realbuffer) 
        end if
 
!c  close output file for initial hydraulic conductivity 
!c  distribution
        if(b_output_binary) then
          call binary_file_close(ihyc,b_output_mpiio_single)  
        else
          close(ihyc)
        end if
        call lun_free(ihyc)
        
        end if

    end if

    
    if (.not.storcoeff_field) then
    
       do ivol=1,nngl
        
        izn=mpropvs(ivol)
        stor(ivol)=spstor(izn)
       
       end do
    
    end if

      goto 1000

997   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED' 
        write(ilog,*) 'file ', prefix(:l_prfx)//'.soi missing'
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

998   continue 
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading nodal material properties field ', &
     &                'from file'
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file'
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end
