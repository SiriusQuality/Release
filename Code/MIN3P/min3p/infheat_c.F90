!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/infheat_c.F90 $
!---------------------------------------------------------------------
!********************************************************************!

! ----------------------------------------------------------------------
! subroutine infheat_c                                                  
! -------------------                                                   
!                                                                       
! compute influence coefficients for advective and dispersive flux      
! terms for rectangular, cartesian finite volume discretization         
! (reactive transport) for aqueous phase using density dependent        
! flow equation                                                         
!                                                                       
! definition of variables:                                              
!                                                                       
! I --> on input   * arbitrary  - initialized  + entries expected       
! O --> on output  * arbitrary  - unaltered    + altered                
!                                                                    I O
!     input:                                                            
!                                                                       
! passed:   real*8:                                                     
!           -------                                                     
!           d(3, ibk)          = dimension of cells in x,y,z         + -
!                                direction                              
!           density(nn)        = fluid density                       + -
!           dvolcoef           = volume flux coefficient including   * +
!                                viscosity and relative permeability    
!           diffu              = phase molecular diffusion (m2/day)     
!           disx(nzn)          = dispersion, x direction (m)            
!           disy(nzn)          =    "      , y    "      (m)            
!           disz(nzn)          =    "      , z    "      (m)            
!           cinfrt_va()        = influence coefficients                 
!                                J^w_ij/A_ij                            
!                                (advective flux terms)                 
!           cinfrt_da()        = influence coefficients                 
!                                D_ij * A_ij / d_ij                     
!                                (dispersvie flux terms)                
!           viscosity(nn)      = fluid viscosity                     - -
!                                                                       
!           integer*4:                                                  
!           ----------                                                  
!           ibk                = block i                                
!           id                 = connected block j                      
!           idbg               = output for debugging information       
!           ilog               = unit number, logbook                   
!           nmax               = max cells for dim purposes             
!           nphas              = max number of phases                   
!           njamxc             = max dim ja array (ncomp.com)           
!           nvx                = number of control volumes              
!                                in x direction                         
!           nvy                = number of control volumes              
!                                in y direction                         
!           nvz                = number of control volumes              
!                                in z direction                         
!           pornew(ibk)        = porosity                               
!           sanew(nmax)        = aqueous phase saturation               
!                                - new time level                       
!           uvsnew(nmax)       = pressure                               
!           relperm(nmax)      = rel permeability                       
!           cinfvs(nmax)       = influence coefficient                  
!                                (variably saturated flow)              
!           ia(), ja()         = ysmp pointers                          
!           isymm(ii)          = symmetry pointer for cell ibk          
!                                                                       
!           logical:                                                    
!           --------                                                    
!           fully_saturated    = .true.  -> saturated conditions        
!           variably_saturated = .true.  -> .not.fully_saturated,       
!                                        -> variably saturated          
!                                           conditions                  
!           half_cells         = .true.  -> half cells on boundary      
!           tortuosity_corr    = .true.  -> Millington-Quirk            
!                                           tortuosity correction       
!                                           for diffusion               
!                                           coefficients                
!                                                                       
!                                                                       
!                                                                       
! local:                                                                
!                                                                       
! external: diffcoff  = compute effective diffusion coefficient         
!           fluxdd    = flux function for fully saturated flow          
!           fluxvs    = flux function for variably saturated flow       
! ----------------------------------------------------------------------
                                                                        
      subroutine infheat_c (nvx,nvy,nvz,ia,ja,isymm,                   &
                            cinfheat_c,d,heatcondw,heatconds,          &
                            heatcondg,pornew,sanew,                    &
                            zg,idbg,ilog,njamxc,nmax,                  &
                            half_cells,cinfrad,radial_coord,           &
                            heatcond_model,nheatcond)  
      
#ifdef OPENMP
      use omp_lib 
      use gen, only : rank, b_enable_output,                           &
                      numofthreads_global,                             &
                      numofloops_thred_global,                         &
                      numofloops_thred_infheat_c_1
#else
      use gen, only : rank, b_enable_output
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
                                                                        
      implicit none 
                                                                        
      integer njamxc,nmax,nvx, nvy, nvz, ia(nmax+1), ja(njamxc),        &
              isymm(njamxc), idbg, ilog                                 
                                                                        
      logical half_cells, radial_coord 
                                                                        
      real*8  pornew(nmax),                                             &
              zg(nmax),sanew(nmax), d(3,nmax),                          &
              cinfheat_c(njamxc),cinfrad(njamxc),                       &
              heatcondw(nmax,3),heatconds(nmax,3)                       
      real*8  heatcondg,nheatcond 
      character (len=*) heatcond_model 
                                                                        
                                                                        
!     local variables                                                   
                                                                        
      real*8, parameter :: r0 = 0.0d0, rhalf = 0.5d0,                   &
                 r1 = 1.0d0, r2 = 2.0d0                                 
                                                                        
      real*8 aread(3,12),areax(3,12), vel(3), dist(3,12),               &
             porav, satav,                                              &
             tend(3), areai,term1_ibk,term1_id,term2_ibk,term2_id,      &
             lambdax,lambday,lambdaz,areadloc,                          &
             lambda_dry,lambda_sat,lambda_ibk,lambda_id                 
                                                                        
!cprovi    changed: Nov. 09, added for harmonic averaging               
      real*8 diff_i,diff_j,diff_ij,areaf,                               &
            por_i,por_j,delx_i,dely_i,delz_i,delx_j,dely_j,delz_j,      &
            tau_i, tau_j                                                
                                                                        
      integer ibk, ivz, ivy, ivx, ibkz, ibky,                           &
              ii, id, ixx, iyy, izz, iisav,                             &
              idim, npair(3), iface(3,12), ndim,                        &
              fvpair(3,12,2), ipair, idim2, idim3,info_debug            
                                                                        
!cprovi    changed: Nov. 09, added for harmonic averaging               
      integer ivxp,ivxn,ivyp,ivyn,ivzp,ivzn,jtemp,nedge,                &
              izn,jzn                                         
                                                                        
      character*1 iups 
      
#ifdef OPENMP      
      integer :: nvols
#endif

      external :: zero_r8_parallel
                                                                        
!  compute influence coefficients for advective flux terms              
!  (influence coefficients are equal Darcy flux = J_ij/A_ij)            
                                                                        
!  loop over control volumes                                            
                                                                        
      info_debug = 0 
                                                                        
!  compute the influence coefficients for dispersive flux terms         
!  loop over the number of "pseudo dispersion elements"                 
                                                                        
!  zero the influence coefficient for dispersive flux term              
      call zero_r8_parallel(cinfheat_c, njamxc, 1, 1)
      
!  loop over control volumes                                            
#ifdef OPENMP      
      nvols = nvx * nvy * nvz
#endif

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nvols > numofloops_thred_infheat_c_1)                   &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ibk, id, idim, idim2, idim3, iface, ii, ipair,     &
    !$omp iisav, ivx, ivy, ivz, ndim, npair)                          &
    !$omp firstprivate(aread, areax, areadloc, dist, fvpair,          &
    !$omp lambda_dry, lambda_ibk, lambda_id, lambda_sat,              &
    !$omp lambdax, lambday, lambdaz, porav, satav, tend,              &
    !$omp term1_ibk, term1_id, term2_ibk, term2_id)                   
    !$omp do schedule(static)
#endif
                                   !increments in z-direction           
      do ivz = 1, nvz 
                                  !increments in y-direction            
        do ivy = 1, nvy 
                                 !increments in x-direction             
          do ivx = 1, nvx 
                                                                        
!  find node pairs for elemental velocities as well                     
!  as influence coefficient for node pairs within dipersion element     
             call cliqdisp (nvx, nvy, nvz, ivx, ivy, ivz,               &
                           fvpair,npair,aread,areax,dist,d,half_cells,  &
                           ia, ja, njamxc,                              &
                           nmax, idbg, cinfrad, radial_coord)           
!  check if fully connected "pseudo dispersion element"                 
!  was found for dimensionality of problem                              
                                                                        
            if ((nvx > 1 .and. npair(1) == 0) .or.                     &
                (nvy > 1 .and. npair(2) == 0) .or.                     &
                (nvz > 1 .and. npair(3) == 0)) cycle                 
                                                                        
             do idim = 1, 3 
                                                                        
              idim2 = idim + 1 
              idim3 = idim + 2 
              if (idim2>3) idim2 = idim2 - 3 
              if (idim3>3) idim3 = idim3 - 3 
                                                                        
                                                                        
!  loop over the number of node pairs in the dimension                  
                                                                        
              do ipair = 1, npair(idim) 
                                                                        
                ibk = fvpair(idim, ipair, 1) 
                id = fvpair(idim, ipair, 2) 
                                                                        
!cprovi------------------------------------------------                 
                do ii = ia(ibk), ia(ibk+1)-1 
                  if (ja(ii) .eq. id) then 
                    iisav = ii 
                    go to 431 
                  endif 
                end do
                if (rank == 0) then
                  write(ilog,*) ' error-cannot find id in list-infheat_c' 
                  write(ilog,*) ' ibk, id ', ibk, id 
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop 
  431           continue 
                iface(idim, ipair) = iisav 
                                                                        
                                                                        
                                                                        
                     !ipair = 1, npair(idim)                            
              end do 
                                                                        
                                                                        
                   !idim = 1, 3                                         
            end do 
                                                                        
!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
!  average porosity of the element                                      
!  note: each node is included in "ndim" number of node                 
!        pairs, therefore the average must be divided                   
!        by ndim as well as the number of nodes in the                  
!        element                                                        
            porav = r0 
            do idim = 1, 3 
               do ipair = 1, npair(idim) 
                  ibk = fvpair(idim, ipair, 1) 
                  id = fvpair(idim, ipair, 2) 
                  porav = porav                                         &
                        + dmin1( r1, pornew(ibk) )                      &
                        + dmin1( r1, pornew(id) )                       
               end do 
            end do 
                                                                        
            ndim = 0 
            if (nvx .gt. 1) ndim = ndim + 1 
            if (nvy .gt. 1) ndim = ndim + 1 
            if (nvz .gt. 1) ndim = ndim + 1 
            porav = porav / float(ndim) / r2**ndim 
                                                                        
            satav = r0 
            do idim = 1, 3 
                  do ipair = 1, npair(idim) 
                     ibk = fvpair(idim, ipair, 1) 
                     id = fvpair(idim, ipair, 2) 
                     satav = satav                                      &
                           + dmin1( r1, sanew(ibk) )                    &
                           + dmin1( r1, sanew(id) )                     
                  end do 
            end do 
            satav = satav / float(ndim) / r2**ndim 
                                                                        
!  calculate average dispersivities for the "pseudo                     
!  dispersion element"                                                  
                                                                        
                                                                        
                                                                        
            lambdax=r0 
            lambday=r0 
            lambdaz=r0 
                                                                        
                                                !loop over dimensions   
            do idim = 1, 3 
                                               !node pairs              
              do ipair = 1, npair(idim) 
                                                                        
                     ibk = fvpair(idim, ipair, 1) 
                     id = fvpair(idim, ipair, 2) 
                                                                        
                                                                        
                     select case (heatcond_model) 
                     case ('model 1') 
                       lambdax=lambdax +                                &
                               porav*satav*heatcondw(ibk,1)+            &
                               (r1-porav)*heatconds(ibk,1)+             &
                               porav*satav*heatcondw(id,1)+             &
                               (r1-porav)*heatconds(id,1)               
                                                                        
                       lambday=lambday +                                &
                               porav*satav*heatcondw(ibk,2)+            &
                               (r1-porav)*heatconds(ibk,2)+             &
                               porav*satav*heatcondw(id,2)+             &
                               (r1-porav)*heatconds(id,2)               
                                                                        
                       lambdaz=lambdaz +                                &
                               porav*satav*heatcondw(ibk,3)+            &
                               (r1-porav)*heatconds(ibk,3)+             &
                               porav*satav*heatcondw(id,3)+             &
                               (r1-porav)*heatconds(id,3)               
                    case ('model 2') 
                                                                        
                       lambda_ibk = 86.4d0*                             &
                                 (0.228d0-2.406d0*pornew(ibk)*          &
                                 sanew(ibk)+                            &
                                 4.909d0*                               &
                                 (pornew(ibk)*sanew(ibk))**0.5d0)       
                                                                        
                       lambda_id = 86.4d0*                              &
                                  (0.228d0-2.406d0*pornew(id)*          &
                                  sanew(id)+                            &
                                  4.909d0*                              &
                                 (pornew(id)*sanew(id))**0.5d0)         
                                                                        
                       lambdax = lambdax + lambda_ibk + lambda_id 
                       lambday = lambday + lambda_ibk + lambda_id 
                       lambdaz = lambdaz + lambda_ibk + lambda_id 
                                                                        
                    case ('model 3') 
                       lambda_dry = heatconds(ibk,1)**(r1-pornew(ibk))* &
                                    heatcondg**pornew(ibk)              
                       lambda_sat = heatconds(ibk,1)**(r1-pornew(ibk))* &
                                    heatcondw(ibk,1)**pornew(ibk)       
                                                                        
                       lambda_ibk = lambda_sat*dsqrt(sanew(ibk))+       &
                                    lambda_dry*(r1-dsqrt(sanew(ibk)))   
                                                                        
                       lambda_dry = heatconds(id,1)**(r1-pornew(id))*   &
                                    heatcondg**pornew(id)               
                       lambda_sat = heatconds(id,1)**(r1-pornew(id))*   &
                                    heatcondw(id,1)**pornew(id)         
                                                                        
                       lambda_id = lambda_sat*dsqrt(sanew(id))+         &
                                   lambda_dry*(r1-dsqrt(sanew(id)))     
                       lambdax = lambdax + lambda_ibk + lambda_id 
!-----------------------------------------------------------------------
                       lambda_dry = heatconds(ibk,2)**(r1-pornew(ibk))* &
                                    heatcondg**pornew(ibk)              
                       lambda_sat = heatconds(ibk,2)**(r1-pornew(ibk))* &
                                    heatcondw(ibk,2)**pornew(ibk)       
                                                                        
                       lambda_ibk = lambda_sat*dsqrt(sanew(ibk))+       &
                                    lambda_dry*(r1-dsqrt(sanew(ibk)))   
                                                                        
                       lambda_dry = heatconds(id,2)**(r1-pornew(id))*   &
                                    heatcondg**pornew(id)               
                       lambda_sat = heatconds(id,2)**(r1-pornew(id))*   &
                                    heatcondw(id,2)**pornew(id)         
                                                                        
                       lambda_id = lambda_sat*dsqrt(sanew(id))+         &
                                   lambda_dry*(r1-dsqrt(sanew(id)))     
                       lambday = lambday + lambda_ibk + lambda_id 
!-----------------------------------------------------------------------
                       lambda_dry = heatconds(ibk,3)**(r1-pornew(ibk))* &
                                    heatcondg**pornew(ibk)              
                       lambda_sat = heatconds(ibk,3)**(r1-pornew(ibk))* &
                                    heatcondw(ibk,3)**pornew(ibk)       
                                                                        
                       lambda_ibk = lambda_sat*dsqrt(sanew(ibk))+       &
                                    lambda_dry*(r1-dsqrt(sanew(ibk)))   
                                                                        
                       lambda_dry = heatconds(id,3)**(r1-pornew(id))*   &
                                    heatcondg**pornew(id)               
                       lambda_sat = heatconds(id,3)**(r1-pornew(id))*   &
                                    heatcondw(id,3)**pornew(id)         
                                                                        
                       lambda_id = lambda_sat*dsqrt(sanew(id))+         &
                                   lambda_dry*(r1-dsqrt(sanew(id)))     
                       lambdaz = lambdaz + lambda_ibk + lambda_id 
                                                                        
                                                                        
                                                                        
                    case ('model 4') 
                                                                        
                       lambda_dry = heatconds(ibk,1)**(r1-pornew(ibk))* &
                                    heatcondg**pornew(ibk)              
                       lambda_sat = heatconds(ibk,1)**(r1-pornew(ibk))* &
                                    heatcondw(ibk,1)**pornew(ibk)       
                                                                        
                       lambda_ibk = lambda_sat**sanew(ibk)*             &
                                    lambda_dry**(r1-sanew(ibk))         
                                                                        
                       lambda_dry = heatconds(id,1)**(r1-pornew(id))*   &
                                    heatcondg**pornew(id)               
                       lambda_sat = heatconds(id,1)**(r1-pornew(id))*   &
                                    heatcondw(id,1)**pornew(id)         
                                                                        
                       lambda_id =  lambda_sat**sanew(id)*              &
                                    lambda_dry**(r1-sanew(id))          
                       lambdax = lambdax + lambda_ibk + lambda_id 
!-----------------------------------------------------------------------
                       lambda_dry = heatconds(ibk,2)**(r1-pornew(ibk))* &
                                    heatcondg**pornew(ibk)              
                       lambda_sat = heatconds(ibk,2)**(r1-pornew(ibk))* &
                                    heatcondw(ibk,2)**pornew(ibk)       
                                                                        
                       lambda_ibk = lambda_sat**sanew(ibk)*             &
                                    lambda_dry**(r1-sanew(ibk))         
                                                                        
                       lambda_dry = heatconds(id,2)**(r1-pornew(id))*   &
                                    heatcondg**pornew(id)               
                       lambda_sat = heatconds(id,2)**(r1-pornew(id))*   &
                                    heatcondw(id,2)**pornew(id)         
                                                                        
                       lambda_id =  lambda_sat**sanew(id)*              &
                                    lambda_dry**(r1-sanew(id))          
                       lambday = lambday + lambda_ibk + lambda_id 
!-----------------------------------------------------------------------
                       lambda_dry = heatconds(ibk,3)**(r1-pornew(ibk))* &
                                    heatcondg**pornew(ibk)              
                       lambda_sat = heatconds(ibk,3)**(r1-pornew(ibk))* &
                                    heatcondw(ibk,3)**pornew(ibk)       
                                                                        
                       lambda_ibk = lambda_sat**sanew(ibk)*             &
                                    lambda_dry**(r1-sanew(ibk))         
                                                                        
                       lambda_dry = heatconds(id,3)**(r1-pornew(id))*   &
                                    heatcondg**pornew(id)               
                       lambda_sat = heatconds(id,3)**(r1-pornew(id))*   &
                                    heatcondw(id,3)**pornew(id)         
                                                                        
                       lambda_id =  lambda_sat**sanew(id)*              &
                                    lambda_dry**(r1-sanew(id))          
                       lambdaz = lambdaz + lambda_ibk + lambda_id 
                                                                        
                   case ('model 5') 
                       term1_ibk = (r1-pornew(ibk))**nheatcond 
                       term2_ibk = pornew(ibk)**nheatcond 
                       term1_id = (r1-pornew(id))**nheatcond 
                       term2_id = pornew(id)**nheatcond 
                                                                        
                       lambda_dry = heatconds(ibk,1)*term1_ibk+         &
                                    heatcondg*term2_ibk                 
                       lambda_sat = heatconds(ibk,1)*term1_ibk+         &
                                    heatcondw(ibk,1)*term2_ibk          
                                                                        
                       lambda_ibk = lambda_sat**sanew(ibk)*             &
                                    lambda_dry**(r1-sanew(ibk))         
                                                                        
                       lambda_dry = heatconds(id,1)*term1_id+           &
                                    heatcondg*term2_id                  
                       lambda_sat = heatconds(id,1)*term1_id+           &
                                    heatcondw(id,1)*term2_id            
                                                                        
                       lambda_id =  lambda_sat**sanew(id)*              &
                                    lambda_dry**(r1-sanew(id))          
                       lambdax = lambdax + lambda_ibk + lambda_id 
!-----------------------------------------------------------------------
                       lambda_dry = heatconds(ibk,2)*term1_ibk+         &
                                    heatcondg*term2_ibk                 
                       lambda_sat = heatconds(ibk,2)*term1_ibk+         &
                                    heatcondw(ibk,2)*term2_ibk          
                                                                        
                       lambda_ibk = lambda_sat**sanew(ibk)*             &
                                    lambda_dry**(r1-sanew(ibk))         
                                                                        
                       lambda_dry = heatconds(id,2)*term1_id+           &
                                    heatcondg*term2_id                  
                       lambda_sat = heatconds(id,2)*term1_id+           &
                                    heatcondw(id,2)*term2_id            
                                                                        
                       lambda_id =  lambda_sat**sanew(id)*              &
                                    lambda_dry**(r1-sanew(id))          
                       lambday = lambday + lambda_ibk + lambda_id 
!-----------------------------------------------------------------------
                       lambda_dry = heatconds(ibk,3)*term1_ibk+         &
                                    heatcondg*term2_ibk                 
                       lambda_sat = heatconds(ibk,3)*term1_ibk+         &
                                    heatcondw(ibk,3)*term2_ibk          
                                                                        
                       lambda_ibk = lambda_sat**sanew(ibk)*             &
                                    lambda_dry**(r1-sanew(ibk))         
                                                                        
                       lambda_dry = heatconds(id,3)*term1_id+           &
                                    heatcondg*term2_id                  
                       lambda_sat = heatconds(id,3)*term1_id+           &
                                    heatcondw(id,3)*term2_id            
                                                                        
                       lambda_id =  lambda_sat**sanew(id)*              &
                                    lambda_dry**(r1-sanew(id))          
                       lambdaz = lambdaz + lambda_ibk + lambda_id 
                                                                        
                    case ('model 6') 
                                                                        
                                                                        
                       lambda_ibk =0.228d0-2.406d0*sanew(ibk)*pornew(ibk)  &
                               + 4.909d0*(sanew(ibk)*pornew(ibk))**rhalf
                       lambda_ibk = lambda_ibk * 86.4d0 
                                                                        
                       lambda_id =0.228d0-2.406d0*sanew(id)*pornew(id)  &
                                 + 4.909d0*(sanew(id)*pornew(id))**rhalf
                       lambda_id = lambda_id * 86.4d0 
                                                                        
                       lambdax = lambdax + lambda_ibk + lambda_id 
                       lambday = lambday + lambda_ibk + lambda_id 
                       lambdaz = lambdaz + lambda_ibk + lambda_id 
                                                                        
                                                                        
                    end select 
                                                                        
                                                   !node pairs          
                  end do 
                                                   !dimensions          
               end do 
                                                                        
                                                                        
               lambdax = lambdax / float(ndim) / r2**ndim 
               lambday = lambday / float(ndim) / r2**ndim 
               lambdaz = lambdaz / float(ndim) / r2**ndim 
                                                                        
!  calculate the dispersion tensor for the "pseudo dispersion element"  
!  average porosity of the element                                      
                                                                        
                                                                        
               tend(1) = lambdax 
                                                                        
               tend(2) = lambday 
                                                                        
               tend(3) = lambdaz 
                                                                        
!  build total influence coefficient from all elemental contributions   
                                                                        
#ifdef OPENMP
    !$omp critical
#endif                                     !loop over dimensions   
               do idim = 1, 3 
                                                                        
!  adjust for 1d-, 2d, 3d - discretization                              
                                                                        
                                                                        
                                                          !node pairs   
                    do ipair = 1, npair(idim) 
                                                                        
                     iisav = iface(idim, ipair) 
                                                                        
                     areadloc = aread(idim,ipair) 
                                                                        
                     cinfheat_c(iisav)=cinfheat_c(iisav)+               &
                                       tend(idim)*areadloc              
                                                                        
                                                                        
                     cinfheat_c(isymm(iisav))=cinfheat_c(isymm(iisav))+ &
                                       tend(idim)*areadloc              
                                                                        
                                                                        
                    end do 
               end do 
#ifdef OPENMP
    !$omp end critical
#endif                                                         
!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
                                                                   
          end do
        end do
      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif
                                                                        
                                                                        
      return 
      END                                           
