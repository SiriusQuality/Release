!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/min3p/file_utility.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!> module of file utility
module file_utility

    use gen, only : ilog, rank, b_enable_output

    implicit none
    
    character(1), parameter :: strcomment = "!"

    contains

    !> Convert upper case to lower case
    subroutine lowercase(string)

        implicit none

        character(*), intent(INOUT) :: string

        integer :: i,j

        do i = 1,len_trim(string)

            j = ichar(string(i:i))

            if (j >= 65 .AND. j <= 90) then

                j = j + 32
                string(i:i) = char(j)

            end if

        end do

    end subroutine lowercase
    
    !> Read next line, skip comment line start with comment character
    function readnextline(iunit, strbuffer) result (bflag)
    
        implicit none
        
        integer, intent(in) :: iunit
        character(2048), intent(inout) :: strbuffer
        logical :: bflag
        
        integer :: i, istat
        
        strbuffer = ""
        bflag = .true.

        do while(bflag)

            read(iunit, "(a)", iostat = istat) strbuffer            
      
            if (istat > 0) then             !Error in reading  
                if (rank == 0 .and. b_enable_output) then
                  write(ilog, *) "Error in reading file."
                end if
                bflag = .false. 
                exit            
            else if (istat < 0) then    !End of file            
                bflag = .false.  
                exit                        
            end if

            strbuffer = adjustl(strbuffer)

            if(len_trim(strbuffer) /= 0 ) then
            
                ! Conver all case to lower case
                call lowercase(strbuffer)
                
                if (strbuffer(1:1) /= strcomment) then
                    call replacecharacter(strbuffer, achar(9), " ")     !replace tab with blank space
                    exit
                end if

            end if

        end do
    
    end function readnextline
    
    !> replace character in string
    subroutine replacecharacter(str, stra, strb)
    
        implicit none
        
        character(*), intent(inout) :: str
        character(*), intent(in) :: stra, strb
        character(2048) :: tempstr 
        
        integer :: i, j, k, n1, n2, n3
        
        n1 = len(str)
        n2 = len(stra)
        n3 = len(strb)        
        j = 1
        k = 0
        do i = 1, n1 - n2 + 1
            if (k>0) then
                k = k - 1
                cycle
            end if
            if(str(i:i+n2-1) == stra(1:n2)) then
                tempstr(j: j + n3 - 1) = strb(1:n3)
                j = j + n3
                k = n2 - 1
            else                
                tempstr(j:j) = str(i:i)
                j = j + 1
            end if
        end do
        
        str = tempstr
        
    end subroutine replacecharacter

end module