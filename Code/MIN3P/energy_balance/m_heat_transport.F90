!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/energy_balance/m_heat_transport.F90 $
!---------------------------------------------------------------------
!********************************************************************!

module m_heat_transport
!-------------------------------------------------------------------------
! Modules used 
!-------------------------------------------------------------------------
use parm 

implicit none

!-------------------------------------------------------------------------
!
!   $Description: This module solves the heat_transport equation 
!
!   $Use:  
!
!   $Author: Sergio Andrés Bea Jofr?
!
!   $License: UBC
!
!-------------------------------------------------------------------------
!%------------------------------------------------------------------------
!%------------------------------------------------------------------------
logical                                      :: heat_transport        ! If true, heat transport coupled to flow equations are solved 

real (type_r8), allocatable, dimension(:)    :: tempnew               ! Temperature vector in k+1

real (type_r8), allocatable, dimension(:)    :: tempold               ! Temperature vector in k

real (type_r8)                               :: heatcapw              ! Heat specific capacity of water [E Mw-1 oC-1]

real (type_r8), allocatable, dimension(:)    :: heatcaps              ! Solid heat specific capacity [E Ms-1 oC]

real (type_r8), allocatable, dimension(:,:)  :: heatcondw             ! Heat conductivity for water [E L-1 T-1 oC]

real (type_r8), allocatable, dimension(:,:)  :: heatconds             ! Heat conductivity for solid [E L-1 T-1 oC]

real (type_r8)                               :: heatcondg             ! Heat conductivity for gas [E L-1 T-1 oC]

real (type_r8), allocatable, dimension(:)    :: denssolid             ! Heat conductivity for solid [E L-1 T-1 oC]

real (type_r8), allocatable, dimension(:,:)  :: distcells             ! Distance between cells 

character(len=100)                           :: heatcond_model        ! Thermal conductivity model

real*8                                       :: nheatcond             ! Power of porosity function in thermal conducitivity model

logical                                      :: split_divdensv        ! Split divergence of density vapor in a term for Pl and T (using chain rule)

real (type_r8), allocatable, dimension(:)    :: cinfheat_c            ! Influence coefficients for energy balance (conductive)

real (type_r8), allocatable, dimension(:)    :: cinfheat_d            ! Influence coefficients for energy balance (dispersive)

real (type_r8), allocatable, dimension(:)    :: heatflux_a            ! Heat adevective fluxes corresponding to connected cell volumes [ncon-1]

real (type_r8), allocatable, dimension(:)    :: heatflux_c            ! Heat conductive fluxes corresponding to connected cell volumes [ncon-1]

real (type_r8), allocatable, dimension(:)    :: heatflux_d            ! Heat dispersive fluxes corresponding to connected cell volumes [ncon-1]

real (type_r8), allocatable, dimension(:)    :: vsfluxheat            ! Heat dispersive fluxes corresponding to connected cell volumes [ncon-1]

real (type_r8), allocatable, dimension(:)    :: dcoefheat             !

real (type_r8), allocatable, dimension(:)    :: del_temp              ! Delta temperature between ivol and jvol 

real (type_r8), allocatable, dimension(:)    :: disheatx              ! Longitudinal dispersion coefficient for heat equation 

real (type_r8), allocatable, dimension(:)    :: disheaty              ! Transverse horizontal dispersion coefficient for heat equation 

real (type_r8), allocatable, dimension(:)    :: disheatz              ! Transverse vertical dispersion coefficient for heat equation  

real (type_r8)                               :: dinc_heat             ! Incremental factor for derivatives with respect temperature

real (type_r8)                               :: drho_dt               ! Derivative of density with respect to temperature   

integer                                      :: ienergy               ! Input unit for energy balance parameters

logical                                      :: update_viscosity_temp ! Update viscosity as function of temperature

logical                                      :: update_heatcondw      ! Update the thermal conductivity of water as function of temperature

logical                                      :: isboussinesq          ! Bussinesq approach in flow equation is considered  

real (type_r8), allocatable, dimension(:)    :: aglob                 ! Jacobian for flow and heat equation 

real (type_r8), allocatable, dimension(:)    :: afglob

real (type_r8), allocatable, dimension(:)    :: bglob                 ! Residual for flow and heat equations

real (type_r8), allocatable, dimension(:)    :: uglob                 ! Solution vector for water pressures and temperatures

real (type_r8), allocatable, dimension(:)    :: bcondheat             ! Vector for boundary conditions for heat equation 

real (type_r8), allocatable, dimension(:)    :: bcondheat0            ! Vector for boundary conditions for heat equation (initial) 

integer, allocatable, dimension(:)           :: iabheat               ! Index of cells associated with boundary conditions 

!integer, allocatable, dimension(:)           :: bvalid_iabheat        ! flag to indicate if this boundary condition is valid. 
!                                                                      ! If the boundary condition is overwritten, it is an 
!                                                                      ! invalid boundary condition  
!                                                                      ! .true.  => valid
!                                                                      ! .false. => invalid

integer, allocatable, dimension(:)           :: iabheat0              ! Index of cells associated with boundary conditions (initial)

character(len=100), allocatable, dimension(:):: btypeheat             ! Type of boundary conditions 

integer                                      :: nbheat                ! Number of boundary conditions zones for energy balance

integer                                      :: nbheat0               ! Number of boundary conditions zones for energy balance (initial)

integer, allocatable, dimension(:)           :: iaglob

integer, allocatable, dimension(:)           :: jaglob

integer, allocatable, dimension(:)           :: iafglob

integer, allocatable, dimension(:)           :: jafglob

integer, allocatable, dimension(:)           :: iafdglob

integer, allocatable, dimension(:)           :: lorderglob

integer, allocatable, dimension(:)           :: invordglob

integer, allocatable, dimension(:)           :: isymglob1

integer, allocatable, dimension(:)           :: isymglob2

integer, allocatable, dimension(:)           :: isymglob3

integer, allocatable, dimension(:)           :: isymglob4

integer                                      :: mnjafglob

!!
!!Refer to Note201211231457 in datstr_1.F90:
!!No definition or reference is found for the mnjaglob before.
!!Danyang, 2012-11-23
!!

integer                                      :: mnjaglob

integer                                      :: njafglob

integer                                      :: njaglob

real (type_r8)                               :: tolglob 

real (type_r8)                               :: restolglob

real (type_r8), allocatable, dimension(:)    :: resglob 

real (type_r8)                               :: deltolglob

integer                                      :: maxiterglob 

integer                                      :: levelglob 

integer                                      :: msolvitglob 

integer                                      :: idetailglob 

integer                                      :: itsolvtotglob

integer                                      :: iterglob              ! Number of global iterations 

real*8                                       :: tempref_dens          ! Reference temperature for density 

real*8                                       :: tempcorr_min          ! Temperature correction for solution update

real*8                                       :: tempcorr_max          ! Temperature correction for solution update

real*8                                       :: ref_tds               ! Reference TDS

logical                                      :: density_field         ! Density field is read from data file 

real (type_r8), allocatable, dimension(:)    :: density_pitzer        ! Density for Pitzer equations are read (in k+1)

real (type_r8), allocatable, dimension(:)    :: densold_pitzer        ! Density for Pitzer equations are read (in k)

logical                                      :: nonlindens_heat       ! Non-lineal dependence of density with temperature 

logical                                      :: massflux_second       ! Second boundary condition for flow and heat condition is mass flux  

logical                                      :: isadvective           ! isadvective=true, then advective term in heat equation is considered

logical                                      :: isdispersive          ! isdispersive=true, then dispersive term in heat equation is considered

logical                                      :: isconductive          ! isconductive=true, then conductive term in heat equation is considered

character(len=100)                           :: sp_weight_heat        ! Spatial weighting for temperature in energy balance equations

logical                                      :: isstorflow            ! If true, then storage term in flow equation is computed

logical                                      :: isstorheat            ! If true, then storage term in energy balance equation is computed

real (type_r8)                               :: ups_heat              ! Upstream factor for energy balance equation 

logical                                      :: av_dens_z             ! Average density in buoyancy term is considered

logical                                      :: ishydrostatic2        

logical                                      :: islogunk_energybal    ! islogunk_energybal=true, derivatives with respect to log Pa and log T are considered

integer                                      :: iviscomodel           ! Index of viscosity model

real*8                                       :: ugloblim_log          ! Limit for update in log cycles

integer                                      :: imheat                ! unit for energy balance unit 

integer                                      :: imheat_first          ! index of first unit for energy balance

integer                                      :: imheat_last           ! index of last unit for energy balance

integer, allocatable                         :: imheat_mpi(:)         ! file unit of heat transport for binary output 

integer*8, allocatable                       :: offset_imheat(:)      ! offset of heat transport for binary output 

integer*8, allocatable                       :: offset_imheat_ijk(:)  ! offset of records number of heat transport for binary output

real (type_r8)                               :: totenergy             ! Total energy in the system 

real (type_r8)                               :: culabsbalheat         ! Absolute cumulative energy balance error

real (type_r8)                               :: culrelbalheat         ! Relative cumulative energy balance error

logical                                      :: energy_balance        ! if it is true, then energy balance is computed

real (type_r8), allocatable, dimension(:)    :: entalchg              ! Entalphy change vector in the present time level

logical                                      :: entalphy_change       ! If true, enthalphy in reactions are considered

real*8, parameter                            :: cvisco1=0.7063d0      ! Viscosity constant

real*8, parameter                            :: cvisco2=-0.04832d0    ! Viscosity constant

real*8, parameter                            :: cvisco3=239.4d-7      ! Viscosity constant

real*8, parameter                            :: cvisco4=248.37d0      ! cvisco3=133.15d0 

real*8, parameter                            :: cvisco5=133.15d0      ! cvisco3=133.15d0 
!cprovi--------------------------------------------------------------------------------------------------------
!cprovi Constant for the density changes by temperature 
!cprovi See Yusa and Oishi (1989)
!cprovi--------------------------------------------------------------------------------------------------------
real*8, parameter                            :: cdens1=1758.4d0       ! Density constant

real*8, parameter                            :: cdens2=-4.8434d-3     ! Density constant

real*8, parameter                            :: cdens3=1.0907d-5      ! Density constant

real*8, parameter                            :: cdens4=9.8467d-9      ! Density constant
!cprovi--------------------------------------------------------------------------------------------------------
!cprovi Parameters for thermal conductivity taken from 
!cprovi 
!cprovi--------------------------------------------------------------------------------------------------------
real*8, parameter                            :: clambdaw1=36.1498d0   ! Constant for fluid thermal conductivity 

real*8, parameter                            :: clambdaw2=1.25d0      ! Constant for fluid thermal conductivity

real*8, parameter                            :: clambdaw3=0.03d0      ! Constant for fluid thermal conductivity

real*8, parameter                            :: clambdaw4=0.00014d0   ! Constant for fluid thermal conductivity
!cprovi--------------------------------------------------------------------------------------------------------
!cprovi Parameters corresponding to evaporation processes
!cprovi (see Saito et al. (2006)
!cprovi--------------------------------------------------------------------------------------------------------
logical                                      :: evaporation           ! If true, evaporation is computed 

logical                                      :: update_ddensv         ! Update vapor density derivatives with
                                                                      ! respect to state variables in each
                                                                      ! time increment 

real (type_r8)                               :: gammaw0               ! Surface tension at 258C (71.89 g s-2).

logical                                      :: isenhfactor           ! Compute anhanced factor in thermal vapour fluxes (e.g. Cass, 1984)

real (type_r8)                               :: fclay_nabla           ! Mass fraction of clay in the soil [-].

real (type_r8)                               :: cte_nabla             ! Constant for enhanced nabla paramater (see Saito et al., 2006)

real (type_r8)                               :: nabla_qhv             ! Enhanced factor for isothermal vapor fluxes 

real (type_r8)                               :: gainwt                ! Gain factor, wich quantifies the temperature 
                                                                      ! dependence of soil water retention curve.                                                                     
real (type_r8)                               :: heatcapv              ! Heat specific capacity of water vapour [E Mv-1 oC-1]

real (type_r8)                               :: heatcapa              ! Heat specific capacity of air [E Mv-1 oC-1]
                                                                      
real (type_r8)                               :: diffv0                ! Diffusivity of water vapor in air

real (type_r8), allocatable, dimension(:)    :: densvnew              ! Vapor density in current time level [nn]

real (type_r8), allocatable, dimension(:)    :: densvold              ! Vapor density in previous time level [nn]

real (type_r8), allocatable, dimension(:)    :: ddensvdpa             ! Derivatives of saturated vapor density with respect to liquid pressure [nn]

real (type_r8), allocatable, dimension(:)    :: ddensvdt              ! Derivatives of saturated vapor density with respect to temperature [nn]

real (type_r8), allocatable, dimension(:)    :: dsurftensdt           ! Derivatives of surface tension with respect to temperature [nn]

!cprovi---------------------------------------------------- 
!cprovi Influence coefficients
!cprovi (see Saito et al. (2006)
!cprovi---------------------------------------------------- 

real (type_r8), allocatable, dimension(:)    :: cinfevap_pa           ! Influence coefficients 

real (type_r8), allocatable, dimension(:)    :: cinfevap_t            ! Influence coefficients

real (type_r8), allocatable, dimension(:)    :: cinfvs_t              ! Influence coefficients

real (type_r8), allocatable, dimension(:)    :: vapflux               ! Vapour fluxes induced by liquid pressure gradients

real (type_r8), allocatable, dimension(:)    :: vapfluxheat           ! Vapour fluxes induced by temperature gradients

real (type_r8), allocatable, dimension(:)    :: heatflux_v            ! Heat 

real (type_r8), allocatable, dimension(:)    :: latvapnew             ! Volumetric latent heat vaporization 

real (type_r8), allocatable, dimension(:)    :: latvapold             ! Volumetric latent heat vaporization 

character(len=100)                           :: densv_model           ! Density vapour model

logical                                      :: iscapcorr             ! If true, consider capilarity correction on water vapour density 
 
!cprovi---------------------------------------------------- 
!cprovi Parameters for atmospheric boundary conditions
!cprovi----------------------------------------------------

logical                                      :: write_evap_info       ! Write temporal evolution about energy and evaporation paramaters 

real*8                                       :: runoff_atm            ! Run off term 

integer                                      :: ievap                 ! Unit to write the temporal evolution about energy and evaporation parameters

integer                                      :: ivelvap               ! Unit to write the vapor velocity

integer*8                                    :: offset_ievap          ! Offset for binary output of evap file

integer*8                                    :: offset_ievap_ijk      ! Offset of records number for binary output of evap file

real*8                                       :: totwflux_atm          ! Total mass water flux

real*8                                       :: tothflux_atm          ! Total energy flux  

real*8                                       :: gammaw_atm            ! Leakage coefficient for runoff term 

real*8                                       :: facevap_atm           ! Factor to multiply evaporation 

real*8                                       :: facrad_atm            ! Factor to multiply radiation 

real*8                                       :: densv_atm             ! Vapour density in the atmosphere 

real*8                                       :: evap_atm              ! Evaporation term 

real*8                                       :: sheat_atm             ! Sensible heat term 

logical                                      :: read_rad_atm          ! Read atmospheric parameters from file

logical                                      :: read_temp_atm         ! Read atmospheric temperature from file

logical                                      :: read_hr_atm           ! Read atmospheric relative himidity from file

logical                                      :: read_wind_atm         ! Read wind from file

logical                                      :: read_rain_atm         ! Read rainfall event from file

logical                                      :: read_cloud_atm        ! Read cloud index from file

logical                                      :: read_evap_rate_atm    ! Read evaporation from file

logical                                      :: comp_evap_rate_atm    ! If true, compute evaporation rate 

logical                                      :: comp_daily_rad_atm    ! Compute daily variation (day/night) in radiation 

logical                                      :: read_atm              ! Read some atmospheric parameters

real*8                                       :: time_atm              ! Time corresponding to atmospheric parameters in the input file

real*8                                       :: tnoon_atm             ! Time of solar noon  

real*8                                       :: tautumn_atm           ! Time when autumn start   

real*8                                       :: tjan_atm              ! Time when jenuary start   

integer                                      :: iatm                  ! Unit for read atmospheric parameters

real*8                                       :: icloud_atm            ! Cloud index

real*8                                       :: adry_atm              ! Dry albedo

real*8                                       :: awet_atm              ! Wet albedo

real*8                                       :: lat_atm               ! Latutude of the location [rad] 

real*8                                       :: rain_atm              ! Rainfall term 

real*8                                       :: hrav_atm              ! Relative humidity average in the atmosphere

real*8                                       :: dhry_atm              ! Annualy amplitude in the relative humidity 
  
real*8                                       :: dhrd_atm              ! Diurnal amplitude in the relative humidity 

real*8                                       :: tempav_atm            ! Average temperature in the atmosphere 

real*8                                       :: dtempy_atm            ! Annual temperature increment

real*8                                       :: dtempd_atm            ! Daily temperature increment 

real*8                                       :: hr_maxy_atm           ! Time during the year when relative humidity is maximum [time units depends on units of the problem]

real*8                                       :: hr_maxd_atm           ! Time during the day when wind speed is maximum [time units depends on units of the problem]

real*8                                       :: temp_maxy_atm         ! Time during the year when atmospheric temperature is maximum [time units depends on units of the problem]

real*8                                       :: temp_maxd_atm         ! Time during the day when atmospheric temperature is maximum [time units depends on units of the problem]

real*8                                       :: hr_atm                ! Relative humidity of the atmosphere [-]

real*8                                       :: temp_atm              ! Temperature of the atmosphere [oC]

real*8                                       :: wind_atm              ! Wind speed [m/s] 

real*8                                       :: dwindy_atm            ! Annual wind speed increment 

real*8                                       :: dwindd_atm            ! Daily wind speed increment [m s-1]  

real*8                                       :: windav_atm            ! Wind speed average [m s-1] 

real*8                                       :: wind_maxy_atm         ! Time during the year when wind speed is maximum [time units depends on units of the problem]
  
real*8                                       :: wind_maxd_atm         ! Time during the day when wind speed is maximum [units depends on time unit of the problem]

real*8                                       :: roughness_atm         ! Roughness length [m] 

real*8                                       :: screen_atm            ! Height where atmospheric data were measured [m]

real*8                                       :: rh_atm                ! Aerodynamic resistance to vapor flow

character(len=100)                           :: rs_model_atm          ! Soil surface resistance model to water flow 

character(len=100)                           :: tort_model_vap        ! Tortuosity model for vapor flow 

real*8                                       :: radnet                ! Net solar radiation [KJ day-1 m-2] 

real*8                                       :: latvap_atm            ! Atmospheric vaportization [KJ kg-1]

real*8                                       :: densg_atm             ! Gas density in the atmosphere [kg m-3]

real*8, parameter                            :: cvkarman=0.4d0        ! 

!cprovi---------------------------------------------------- 
!cprovi Constant for saturated vapour density 
!cprovi See Saito et al. (2006) equation 17 
!cprovi 
!cprovi Saito, H.; Simunek, J. & Mohanty, B. 
!cprovi Numerical analyses of coupled water, vapor and heat transport 
!cprovi in the vadose zone. Vadose Zone Journal, 2006, 5, 784-800
!cprovi---------------------------------------------------- 

real*8, parameter                            :: cdensv1=1.0d-3 

real*8, parameter                            :: cdensv2=31.3716d0

real*8, parameter                            :: cdensv3=6014.79d0

real*8, parameter                            :: cdensv4=7.92495d-3 
!cprovi---------------------------------------------------- 
!cprovi Constant for saturated vapour density 
!cprovi See RETRASO manual
!cprovi----------------------------------------------------
real*8, parameter                            :: cdensv5=136075.0d0 

real*8, parameter                            :: cdensv6=5239.7d0 

!cprovi---------------------------------------------------- 
!cprovi Latent heat vaporization of liquid water
!cpeovi (See Saito et al. (2006), equations 21 and 22)
!cprovi----------------------------------------------------
real*8, parameter                            :: clatvap1=2.501d6

real*8, parameter                            :: clatvap2=2369.2d0
!cprovi---------------------------------------------------- 
!cprovi Solar constant 
!cprovi----------------------------------------------------
real*8, parameter                            :: cgsun=118886.4d0    ! [KJ day-1 m-2] 

real*8, parameter                            :: cmaxdsun=0.4119d0   ! [rad]  Maximum declination of the sun  

real*8, parameter                            :: cboltzman=4.8988d-6 !  Stefan Boltzman constant (KJ/day/m2/K4)  

! ----------------------------------------------------------------------
! standard data structure and solver - heat transport: 
! ----------------------------------------------------
!        -->                                                         <--
!           real*8:
!           -------
!           aglob_std(njaglob)     = jacobian matrix for standard sparse
!                                     matrix
!           integer:
!           --------
!           jaglob_std(njaglob)    = connectivity list for 1d-scalar 
!                                    matrix
!           imapglob_std(njaglob)  = point of standard sparse matrix to 
!                                     sparse matrix used in ws209
!                                 
!        -->                                                         <--
! ----------------------------------------------------------------------
real (type_r8), allocatable :: aglob_std(:)
integer (type_i4), allocatable :: jaglob_std(:)
integer (type_i4), allocatable :: imapglob_std(:)
logical :: bsymbolicfactor_glob  =  .true.

real (type_r8), allocatable, dimension(:)    :: uglob_std                 ! Solution vector for water pressures and temperatures

!-----------------------------------------------------------------------
! variables for water freezing control
! added by Danyang Su, 2015-03-24
!-----------------------------------------------------------------------
!        -->                                                         <--
!           real*8:
!           -------
!           water_freezing_temper  = water freezing temperature
!           water_freezing_cond    = hydraulic conductivity after 
!                                    water freezing, e.g., 1.0d-20
!                                    DO NOT set to zero.
!           water_freezing_ratemin = reaction rate when water is frozen
!           logical:
!           --------
!           b_water_freezing       = if true, use water freezing 
!                                    when temperature is below 
!                                    freezing temperature
!           b_water_freezing_ratemin
!                                  = if true, use specific reaction rate
!                                    when water is frozen.
!                                    
!-----------------------------------------------------------------------
real (type_r8) :: water_freezing_temper
real (type_r8) :: water_freezing_cond
real (type_r8) :: water_freezing_ratemin
logical        :: b_water_freezing
logical        :: b_water_freezing_ratemin
      
!%************************************************************
!%************************************************************
!%************************************************************
!%************************************************************
!%************************************************************
end module m_heat_transport 
