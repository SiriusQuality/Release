!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 491 $
!> $Author: fgerard $
!> $Date: 2017-07-18 00:06:39 +0200 (Tue, 18 Jul 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/solver/solver_snes_common.F90 $
!---------------------------------------------------------------------
!********************************************************************!

#ifdef PETSC

!> module: solver_snes_common
!>
!> written by: Danyang Su
!>
!> module description:
!>
!> Module of nonlinear function  
!>
!> Note: This module is not high efficient at present. 
!> See http://www.mcs.anl.gov/petsc/ for detail


module solver_snes_common

    implicit none
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsysdef.h>
#include <petsc/finclude/petscvecdef.h>
#include <petsc/finclude/petscdmdef.h>
#include <petsc/finclude/petscsys.h>
#include <petsc/finclude/petscvec.h>
#include <petsc/finclude/petscdmda.h>
#include <petsc/finclude/petscis.h>
#include <petsc/finclude/petscmat.h>
#include <petsc/finclude/petscksp.h>
#include <petsc/finclude/petscpc.h>
#include <petsc/finclude/petscvec.h90>
#include <petsc/finclude/petscdmda.h90>
#elif PETSC
#include <finclude/petscsysdef.h>
#include <finclude/petscvecdef.h>
#include <finclude/petscdmdef.h>
#include <finclude/petscsys.h>
#include <finclude/petscvec.h>
#include <finclude/petscdmda.h>
#include <finclude/petscis.h>
#include <finclude/petscmat.h>
#include <finclude/petscksp.h>
#include <finclude/petscpc.h>
#include <finclude/petscvec.h90>
#include <finclude/petscdmda.h90>
#endif
    
       type userctx
        !> DMDA
        DM :: da
        !> degree of freedom
        PetscInt :: dof
        !> stencil width
        PetscInt :: swidth
        !> dimension of the distributed array
        PetscInt :: dim
        !> grid information
        PetscInt :: xs,xe,xl,gxs,gxe,gxl
        PetscInt :: ys,ye,yl,gys,gye,gyl
        PetscInt :: zs,ze,zl,gzs,gze,gzl
        !> global Vector ranger, 1-based  
        PetscInt :: range_start, range_end
        !> global dimension in each direction of the array
        PetscInt :: nvxgbl,nvygbl,nvzgbl
        !> corresponding number of procs in each dimension
        PetscInt :: npx, npy, npz  
        !> local bounding box coordinates in each dimension
        PetscReal :: xlmin, xlmax, ylmin, ylmax, zlmin, zlmax
        !> global bounding box coordinates in each dimension
        PetscReal :: xlmingbl, xlmaxgbl, ylmingbl, ylmaxgbl, zlmingbl, zlmaxgbl
       
        !Other parameters, to be removed if not necessary
        double precision lambda  
      end type userctx   
      
      
      !> General variables
      PetscInt :: stencil_width

      !PetscErrorCode :: ierr
    
      !> Variables of flow problem
      !> DMDA 
      type(userctx) :: dmda_flow 
      !> KSP
      KSP :: ksp_flow

      !> Solution
      Vec :: x_flow
      Vec :: x_flow_loc
      !> Residual
      Vec :: r_flow
      Vec :: r_flow_loc
      !> Right hand side
      Vec :: b_flow
      Vec :: b_flow_loc
      !> Jacobian matrix
      Mat :: a_flow
      !> Matrix operator J    
      Mat :: a_flow_j
      !> Factored matrix
      Mat :: a_flow_fac
      
      !> Parameters for PC flow 
      PC :: pc_flow

     
      !> @strKSPType PETSc KSP solver type, e.g, "KSPGMRES", "KSPBCGS"
      character(16) :: strKSPType_flow
      
      !> @strKSPNormType PETSc KSP Norm type, e.g., "KSP_NORM_NONE", "KSP_NORM_PRECONDITIONED"
      !>                                            "KSP_NORM_UNPRECONDITIONED", "KSP_NORM_NATURAL"
      character(32) :: strKSPNormType_flow
      
      !> @strPCType_flow PETSc preconditioner type in flow, e.g., "pcbjacobi", "pcilu"
      character(32) :: strPCType_flow
      
      !> @strKSPConvergenceType_flow PETSc convergence criteria type in flow, e.g., "kspdefault", "kspuserdefined"
      character(32) :: strKSPConvergenceType_flow
      
      !> @b_mykspconverged_flow
      PetscBool :: b_mykspconverged_flow
      
      !> @b_recal_norm_flow
      PetscBool :: b_recal_norm_flow
      
      !> @b_check_norm_flow
      PetscBool :: b_check_norm_flow
      
      !> @param PC factor shift type
      character(32) :: pc_factor_shift_flow         !default none

      !> @param rtol the relative convergence tolerance (relative decrease in the residual norm) 
      PetscReal :: rtol_flow         !default 1.0E-5
      !> @param abstol the absolute convergence tolerance (absolute size of the residual norm) 
      PetscReal :: abstol_flow       !default 1.0E-50
      !> @param dtol  the divergence tolerance (amount residual can increase before KSPDefaultConverged() concludes that the method is diverging) 
      PetscReal :: dtol_flow         !default 1.0E5
      !> @param maxits maximum number of iterations to use    
      PetscInt  :: maxits_flow       !default 1.0E5
      !> @param residual norm, can be preconditioned residual norm or true residual norm
      PetscReal :: rnorm_flow
      !> @param initial residual norm, can be preconditioned residual norm or true residual norm
      PetscReal :: rnorm_init_flow
      
      !> @param b_use_petsc_default_flow
      PetscBool :: b_use_petsc_default_flow
      
      !> @param b_initial_guess_nonzero_flow
      PetscBool :: b_initial_guess_nonzero_flow

      !> @param b_form_initial_guess_flow
      PetscBool :: b_form_initial_guess_flow

      !> @param b_reuse_preconditioner_flow
      PetscBool :: b_reuse_preconditioner_flow
      
      !> @param b_set_preconditioner_flow
      PetscBool :: b_set_preconditioner_flow

      !> @param b_set_pcfactor_flow
      PetscBool :: b_set_pcfactor_flow

      !> Varialbes of reactive transport problem
      !> DMDA  
      type(userctx) :: dmda_react
      !> KSP
      KSP :: ksp_react

      !> Solution
      Vec :: x_react
      Vec :: x_react_loc
      !> Residual
      Vec :: r_react
      Vec :: r_react_loc
      !> Right hand side
      Vec :: b_react
      Vec :: b_react_loc
      !> Jacobian matrix
      Mat :: a_react
      !> Matrix operator J    
      Mat :: a_react_j
      !> Factored matrix
      Mat :: a_react_fac
      
      !> Parameters for PC reactive transport
      PC :: pc_react
      
      !> @strKSPType PETSc KSP solver type, e.g, "KSPGMRES", "KSPBCGS"
      character(16) :: strKSPType_react
      
      !> @strKSPNormType PETSc KSP Norm type, e.g., "KSP_NORM_NONE", "KSP_NORM_PRECONDITIONED"
      !>                                            "KSP_NORM_UNPRECONDITIONED", "KSP_NORM_NATURAL"
      character(32) :: strKSPNormType_react
      
      !> @strPCType_react PETSc preconditioner type in reactive transport, e.g., "pcbjacobi", "pcilu"
      character(32) :: strPCType_react
      
      !> @strKSPConvergenceType_react PETSc convergence criteria type in reactive transport, e.g., "kspdefault", "kspuserdefined"
      character(32) :: strKSPConvergenceType_react
      
      !> @b_mykspconverged_react
      PetscBool :: b_mykspconverged_react
      
      !> @b_recal_norm_react
      PetscBool :: b_recal_norm_react
      
      !> @b_check_norm_react
      PetscBool :: b_check_norm_react
      
      !> @param PC factor shift type
      character(32) :: pc_factor_shift_react         !default none

      !> @param rtol the relative convergence tolerance (relative decrease in the residual norm) 
      PetscReal :: rtol_react         !default 1.0E-5
      !> @param abstol the absolute convergence tolerance (absolute size of the residual norm) 
      PetscReal :: abstol_react       !default 1.0E-50
      !> @param dtol  the divergence tolerance (amount residual can increase before KSPDefaultConverged() concludes that the method is diverging) 
      PetscReal :: dtol_react         !default 1.0E5
      !> @param maxits maximum number of iterations to use    
      PetscInt :: maxits_react       !default 1.0E5
      !> @param residual norm, can be preconditioned residual norm or true residual norm
      PetscReal :: rnorm_react
      !> @param initial residual norm, can be preconditioned residual norm or true residual norm
      PetscReal :: rnorm_init_react

      !> @param b_use_petsc_default_react
      PetscBool :: b_use_petsc_default_react

      !> @param b_initial_guess_nonzero_react
      PetscBool :: b_initial_guess_nonzero_react
      
      !> @param b_form_initial_guess_react
      PetscBool :: b_form_initial_guess_react

      !> @param b_reuse_preconditioner_react
      PetscBool :: b_reuse_preconditioner_react
      
      !> @param b_set_preconditioner_react
      PetscBool :: b_set_preconditioner_react

      !> @param b_set_pcfactor_react
      PetscBool :: b_set_pcfactor_react
     
      !>Local to global map for nodes
      ISLocalToGlobalMapping :: ismap_node      
      !>Local to global map for flow problem, 
      !>if dof == 1, the same as ismap_node
      ISLocalToGlobalMapping :: ismap_flow
      !>Local to global map for reactive transport problem, 
      !>if dof == 1, the same as ismap_node
      ISLocalToGlobalMapping :: ismap_react
      
      
    
end module solver_snes_common
    
#endif
