!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 453 $
!> $Author: dsu $
!> $Date: 2017-02-21 19:54:05 +0100 (Tue, 21 Feb 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/solver/mpi_sync.F90 $
!---------------------------------------------------------------------
!********************************************************************!

#ifdef MPI

!> module: mpi_sync
!>
!> written by: Danyang Su
!>
!> module description:
!>
!> Note:
!> This module is deprecated for domain decomposition method.
!>
!> Module of synchronization for different process
!> See http://www.mcs.anl.gov/petsc/ for detail

module mpi_sync

    use gen
    use dens
#ifdef PETSC
    use solver_petsc, only : strKSPType_flow, strPCType_flow,         &
                             strKSPConvergenceType_flow, rtol_flow,   &
                             abstol_flow, dtol_flow, maxits_flow,     &
                             strKSPType_react, strPCType_react,       &
                             strKSPConvergenceType_react, rtol_react, &
                             abstol_react, dtol_react, maxits_react,  &
                             ierrcode
#endif    

    implicit none    
    
#ifdef PETSC_V3_6_X
#include <petsc/finclude/petscsys.h>
#else
#include <finclude/petscsys.h>
#endif

    public mpi_sync_input
    
    contains   
    
    
    !>
    !> mpi_sync_input
    !> Synchronize the input parameters
    !>
    subroutine mpi_sync_input    
    
        implicit none
        
        !> Model input parameters
        
       
        !density_dependence
        call MPI_BCAST(density_dependence, 1, MPI_LOGICAL, 0,        &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !deltol_rt
        call MPI_BCAST(deltol_rt, 1, MPI_REAL8, 0,                   &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !deltol_vs
        call MPI_BCAST(deltol_vs, 1, MPI_REAL8, 0,                   &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !deltolglob
        call MPI_BCAST(deltolglob, 1, MPI_REAL8, 0,                  &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !flow_verification
        call MPI_BCAST(flow_verification, 1, MPI_LOGICAL, 0,         &
                       Petsc_Comm_World, ierrcode)   
        CHKERRQ(ierrcode)
        
        !fully_saturated
        call MPI_BCAST(fully_saturated, 1, MPI_LOGICAL, 0,           &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)

        !heat_transport
        call MPI_BCAST(heat_transport, 1, MPI_LOGICAL, 0,            &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !idbg
        call MPI_BCAST(idbg, 1, MPI_INTEGER4, 0,                     &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !idetail_rt
        call MPI_BCAST(idetail_rt, 1, MPI_INTEGER4, 0,               &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
       
        !idetail_vs
        call MPI_BCAST(idetail_vs, 1, MPI_INTEGER4, 0,               &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !idetailglob
        call MPI_BCAST(idetailglob, 1, MPI_INTEGER4, 0,              &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !ilog
        call MPI_BCAST(ilog, 1, MPI_INTEGER4, 0,                     &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !i_solver_type_flow
        call MPI_BCAST(i_solver_type_flow, 1, MPI_INTEGER4, 0,       &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !i_solver_type_react
        call MPI_BCAST(i_solver_type_react, 1, MPI_INTEGER4, 0,      &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !iterative_solver_flow
        call MPI_BCAST(iterative_solver_flow, 1, MPI_LOGICAL, 0,     &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !maxit_rt
        call MPI_BCAST(maxit_rt, 1, MPI_INTEGER4, 0,                 &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !maxit_vs
        call MPI_BCAST(maxit_vs, 1, MPI_INTEGER4, 0,                 &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !msolvit_rt
        call MPI_BCAST(msolvit_rt, 1, MPI_INTEGER4, 0,               &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !msolvit_vs
        call MPI_BCAST(msolvit_vs, 1, MPI_INTEGER4, 0,               &
                       Petsc_Comm_World, ierrcode)  
        CHKERRQ(ierrcode)
        
        !msolvitglob
        call MPI_BCAST(msolvitglob, 1, MPI_INTEGER4, 0,              &
                       Petsc_Comm_World, ierrcode)  
        CHKERRQ(ierrcode)
        
        !restol_rt
        call MPI_BCAST(restol_rt, 1, MPI_REAL8, 0,                   &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !restol_vs
        call MPI_BCAST(restol_vs, 1, MPI_REAL8, 0,                   &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !restolglob
        call MPI_BCAST(restolglob, 1, MPI_REAL8, 0,                  &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
       
        !reactive_transport
        call MPI_BCAST(reactive_transport, 1, MPI_LOGICAL, 0,        &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !seepage_face
        call MPI_BCAST(seepage_face, 1, MPI_LOGICAL, 0,              &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
       
        !steady_flow
        call MPI_BCAST(steady_flow, 1, MPI_LOGICAL, 0,               &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !tfinal
        call MPI_BCAST(tfinal, 1, MPI_REAL8, 0,                      &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !transient_flow
        call MPI_BCAST(transient_flow, 1, MPI_LOGICAL, 0,            &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !update_permeability
        call MPI_BCAST(update_permeability, 1, MPI_LOGICAL, 0,       &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !update_activity_rt
        call MPI_BCAST(update_activity_rt, len(update_activity_rt),  &
                       MPI_CHARACTER, 0, Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
       
        !variably_saturated
        call MPI_BCAST(variably_saturated, 1, MPI_LOGICAL, 0,        &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)

        !varsat_flow
        call MPI_BCAST(varsat_flow, 1, MPI_LOGICAL, 0,               &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !> PETSc parameters
        
        call MPI_BCAST(b_min3p_input_param_first, 1, MPI_LOGICAL, 0, &
                       Petsc_Comm_World, ierrcode) 
        CHKERRQ(ierrcode)
        
        !b_solver_test_petsc
        call MPI_BCAST(b_solver_test_petsc, 1, MPI_LOGICAL, 0,       &
                       Petsc_Comm_World, ierrcode)    
        CHKERRQ(ierrcode)
        
        !strKSPType_flow 
        call MPI_BCAST(strKSPType_flow, len(strKSPType_flow),        &
                       MPI_CHARACTER, 0, Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !strPCType_flow
        call MPI_BCAST(strPCType_flow, len(strPCType_flow),          &
                       MPI_CHARACTER, 0, Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !strKSPConvergenceType_flow
        call MPI_BCAST(strKSPConvergenceType_flow,                   &
                       len(strKSPConvergenceType_flow),              &
                       MPI_CHARACTER, 0, Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !strKSPType_react 
        call MPI_BCAST(strKSPType_react, len(strKSPType_react),      &
                       MPI_CHARACTER, 0, Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !strPCType_react
        call MPI_BCAST(strPCType_react, len(strPCType_react),          &
                       MPI_CHARACTER, 0, Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !strKSPConvergenceType_react
        call MPI_BCAST(strKSPConvergenceType_react,                   &
                       len(strKSPConvergenceType_react),              &
                       MPI_CHARACTER, 0, Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !rtol_flow
        if(b_min3p_input_param_first) then
            if(heat_transport) then
                rtol_flow = deltolglob
            else
                rtol_flow = deltol_vs
            end if
        else
            call MPI_BCAST(rtol_flow, 1, MPI_REAL8, 0,               &
                           Petsc_Comm_World, ierrcode)
            CHKERRQ(ierrcode)
            if(i_solver_type_flow == 2) then
                if(heat_transport) then
                    deltolglob = rtol_flow
                else
                    deltol_vs = restol_vs
                end if
            end if
            
        end if
        
        !abstol_flow
        if(b_min3p_input_param_first) then
            if(heat_transport) then
                abstol_flow = restolglob
            else
                abstol_flow = rtol_flow 
            end if
        else
            call MPI_BCAST(abstol_flow, 1, MPI_REAL8, 0,             &
                           Petsc_Comm_World, ierrcode)
            CHKERRQ(ierrcode)
            if (i_solver_type_flow == 2) then
                if(heat_transport) then
                    restolglob = abstol_flow
                else
                    restol_vs = abstol_flow
                end if
            end if
        end if
        
        !rtol_react
        if(b_min3p_input_param_first) then
            rtol_react = deltol_rt
        else
            call MPI_BCAST(rtol_react, 1, MPI_REAL8, 0,              &
                           Petsc_Comm_World, ierrcode)
            CHKERRQ(ierrcode)
            if(i_solver_type_react == 2) then
                deltol_rt = rtol_react   
            end if
        end if
       
        !abstol_react
        if(b_min3p_input_param_first) then
            abstol_react = restol_rt
        else
            call MPI_BCAST(abstol_react, 1, MPI_REAL8, 0,            &
                           Petsc_Comm_World, ierrcode)
            CHKERRQ(ierrcode)
            if (i_solver_type_react == 2) then
                restol_rt = abstol_react
            end if
        end if
        
        !dtol_flow
        call MPI_BCAST(dtol_flow, 1, MPI_REAL8, 0,                   &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !dtol_react
        call MPI_BCAST(dtol_react, 1, MPI_REAL8, 0,                  &
                       Petsc_Comm_World, ierrcode)
        CHKERRQ(ierrcode)
        
        !maxits_flow
        if(b_min3p_input_param_first) then
            if(heat_transport) then
                maxits_flow = msolvitglob
            else
                maxits_flow = msolvit_vs
            end if
        else
            call MPI_BCAST(maxits_flow, 1, MPI_INTEGER4, 0,          &
                           Petsc_Comm_World, ierrcode)
            CHKERRQ(ierrcode)
            if(i_solver_type_flow == 2) then
                if(heat_transport) then
                    msolvitglob = maxits_flow
                else
                    msolvit_vs = maxits_flow
                end if
            end if
        end if
        
        !maxits_react
        if(b_min3p_input_param_first) then
            maxits_react = msolvit_rt
        else
            call MPI_BCAST(maxits_react, 1, MPI_INTEGER4, 0,         &
                           Petsc_Comm_World, ierrcode)
            CHKERRQ(ierrcode)
            if(i_solver_type_react == 2) then
                msolvit_rt = maxits_react
            end if
        end if        
        
    end subroutine mpi_sync_input


end module mpi_sync
#endif
