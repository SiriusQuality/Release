!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 144 $
!> $Author: dsu $
!> $Date: 2013-11-21 00:42:27 +0100 (Thu, 21 Nov 2013) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/solver/cond_number/cond_num_cal.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine cond_num_cal
!c -----------------
!c
!c subroutine for estimating condition number
!c
!c written by:      Danyang Su - May 30, 2013
!c
!c last modified:   Danyang Su - May 30, 2013
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c           n                  = number of unknows in matrix         + -
!c           nz                 = incomplete factorization            + -
!c           ia(n+1)            = row start pointers for a()          + -
!c           ja(nz)             = global connection list for a()      + -
!c           a(nz)              = coefficient matrix                  + -
!c           cond(2)            = condition numbers.                  * +
!c           info(5)            = return information to the user      * +

#ifdef CONDITION_NUMBER
subroutine cond_num_cal(n, nz, ia, ja, a, cond, info)

    implicit none
        
    integer, intent(in) :: n
    integer, intent(in) :: nz
    integer, intent(in) :: ia(n + 1)
    integer, intent(in) :: ja(nz)
    real(8), intent(in) :: a(nz)
    real(8), intent(out) :: cond(2)
    integer, intent(out) :: info(5)
    
    !local variable
    integer :: i, j
    integer :: icntl(5)
    integer :: la, lw, liw
    integer, allocatable :: irn(:), jcn(:), iw(:)
    real(8), allocatable :: acn(:), w(:)
    real(8) :: rtemp 
    
    !external subroutine
    external MC75ID, MC75AD
    
    !estimate condition number
    rtemp = log10(1.0*nz)/log10(2.0)
    la = max(4, ceiling(rtemp)) * nz
    liw = 19*nz + 7 
    lw = 8*nz
    allocate(w(lw), acn(la), irn(la), jcn(la), iw(liw))
    
    do i = 1, n
        do j = ia(i), ia(i + 1) - 1
            irn(j) = i
        end do
    end do 
    jcn(1:nz) = ja(1:nz)
    acn(1:nz) = a(1:nz)
    
    call MC75ID(icntl)
    call MC75AD(n,nz,la,acn,irn,jcn,cond,liw,iw,lw,w,icntl,info)
    
    deallocate(w, acn, irn, jcn, iw)
    
    end subroutine
#endif