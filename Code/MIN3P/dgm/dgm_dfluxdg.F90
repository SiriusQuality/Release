!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 491 $
!> $Author: fgerard $
!> $Date: 2017-07-18 00:06:39 +0200 (Tue, 18 Jul 2017) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/dgm/dgm_dfluxdg.F90 $
!---------------------------------------------------------------------
!********************************************************************!
    
!c ----------------------------------------------------------------------
!c subroutine dgm_dfluxdg
!c ------------------------
!c
!c compute derivative of total diffusive flux of gases using the dusty gas model
!c LU decomposition of system matrix perfomed previously to calculate fluxes 
!c is used here to solve system
!c
!c amat dfmat/dy  = dbmat/dy - damat/dy fmat
!c
!c amat (i,i) = - SUM (Xj/Dij) - 1/Di^k
!c amat (i,j) =   Xi/Dij
!c dbmat (i)  =   d/dy [ nabla(Ci) + dens * gacc / R / T * Xi * nabla(z) ]
!c dfmat (i)  =   dNi^D/dy  (derivative of molar diffusive flux of species i)
!c
!c written by:  Sergi Molins - May 2,2006
!c
!c modified by: Sergi Molins - May 24,2006
!c              press+temp dependence of gas diff coeff
!c              Sergi Molins - June 12, 2006
!c              added new passed variable: relp
!c              fully saturated: gporij<10^-30 and relp<10^-30 
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c_i(ng)            = gaseous species concentrations      + -
!c                                at control volume i
!c           c_j(ng)            = gaseous species concentrations      + -
!c                                at control volume j
!c           dc_i(ng)           = derivative of gas concentrations    + -
!c                                at control volume i
!c           dmolfrac_i(ng)     = derivative of gas molar fraction    + -
!c                                at control volume i
!c           zgi                = elevation at control volume i       + -
!c           zgj                = elevation at control volume j       + -
!c           dens               = gas density at interface i-j        + -
!c           gpij               = gas pressure at interface i-j       + -
!c           tempkel            = temperature at interface i-j [K]    + -
!c           tauijx             = gas tortuosity at interface i-j     + - 
!c           gporx              = porosity at interface i-j           + -
!c           delta_ijx          = distance between nodes i - j [m]    + -
!c           small              = constant                            + -
!c           factor             = weighting factor to compute         + -
!c                                derivative term at interface i-j
!c                                (see wgpropd.f subroutine)   
!c           ludecomp(ng,ng)    = LU decomposition of amat            + -
!c                                (see dgm_fluxdg.f subroutine)
!c           fmat(ng)           = molar diffusive fluxes for          + -
!c                                gas species [moles m^-2 d^-1]
!c           dgm_dgflux(nc)     = derivatives of                      * +
!c                                total molar diffusive fluxes for
!c                                gas components [moles m^-2 d^-1]
!c
!c           integer*4:
!c           ----------
!c           ipvt(ng)           = pivot indeces
!C                                (see dgefam.f,dgeslm.f subroutines) + -
!c
!c gen.f:    real*8:
!c           -------
!c           gacc               = gravity m s^-2                      + -
!c
!c           logical:
!c           -------
!c           gas_gravity        = enable gas gravity in advection     + -
!c
!c chem.f    real*8:
!c           -------
!c           rgasjoule          = ideal gas constant
!c                                [J/(deg K mol)]
!c           gfwg(ng)           = gram formula weight gas species     + -
!c           xnug(ng*nc)        = stoichiometric coefficient matrix 
!c                                for formation of gases from
!c                                components
!c           pa_atm             = pascal to atmosphere                + -
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gas species               + -
!c           nr                 = number of redox couples             + -
!c           iaga(ng+1)         = row pointer array to                + -
!c                                stoichiometric coefficients of 
!c                                components in gases
!c           jaga(ng*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients of 
!c                                components in gases
!c           logical:
!c           -------
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c phys.f:   real*8:
!c           -------
!c           diff_bin_g(ng,ng)  = binary diffusion coefficients       + -
!c           theta_diff         = exponent for temp correction        + -
!c
!c           logical:
!c           --------
!c           diff_press         = correction for pressure dependence  + -  
!c           diff_temp          = correction for temp dependence      + -  
!c
!c common:   -
!c
!c local:    real*8:
!c           -------
!c           r0               = constant
!c           r1               = constant
!c           dbmat(ng)        = vector
!c           damat(ng,ng)     = matrix
!c           alpha_diff       = diffusion correction (press & temp corr)
!c
!c           integer*4:
!c           ----------
!c           i                = index
!c           ic               = index
!c           jc               = index
!c           istart           = index 
!c           iend             = index
!c
!c external: dgeslm.f         = linear system solver
!c           comptotc.f       = total gaseous component diff flux vectors   
!c ----------------------------------------------------------------------
 
      subroutine dgm_dfluxdg(c_i        ,c_j        ,    &
                             dc_i       ,dmolfrac_i ,    &
                             zgi        ,zgj        ,    &
                             dens       ,gpij       ,    &
                             tempkel    ,relp       ,    &
                             tauijx     ,gporx      ,    &
                             delta_ijx  ,small      ,    &
                             factor     ,ipvt       ,    &
                             ludecomp   ,fmat       ,    &
                             dgm_dgflux             )
 
      use gen
	  use chem
	  use phys
	
	  implicit none
      

!c------------------------------------------------

!c    constants

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
!c	  parameter (small = 1.0d-30)

!c    passed
      real*8       c_i(ng)        ,c_j(ng)       ,   &
                   dc_i(ng)       ,dmolfrac_i(ng),   &
                   zgi            ,zgj           ,   &
                   dens           ,gpij          ,   &
                   tempkel        ,relp          ,   &
                   tauijx         ,gporx         ,   &
                   delta_ijx      ,small         ,   &
                   factor         ,                  &
                   ludecomp(ng,ng), fmat(ng)     ,   &
                   dgm_dgflux(nc)
      
      
      real*8 ::    dgm_gflux(nc), relpg

	  integer*4    ipvt(ng)

!c     internal
      integer*4    i ,ic, ig, istart, iend, jc

	  real*8       dbmat(ng)     ,damat(ng,ng)  ,   &
                   alpha_diff    ,beta_diff

      alpha_diff = r1 / gporx / tauijx * factor
!v      alpha_diff = r1

      !c fix bug here, DSU, 2017-06-23,beta_diff is not initialized if diff_press is not ture
      beta_diff = gacc * factor / delta_ijx / rgasjoule / tempkel / 1.d3

!c     pressure & temperature dependence
	  if (diff_press) then
      
         alpha_diff = alpha_diff * gpij * pa_atm
!v         alpha_diff = alpha_diff / gpij / pa_atm
      
         !beta_diff = gacc * factor / delta_ijx / rgasjoule             &
         !                          / tempkel   / 1.d3
	     
	  endif

	  if (diff_temp) then
      
	   alpha_diff = alpha_diff / tempkel**theta_diff
!v	   alpha_diff = alpha_diff * tempkel**theta_diff
      
	  endif

!c---------------------------------------------------------------------------
!c     check if there is gas phase
      if (gporx.lt.small.or.relp.lt.small) then
!c       no gas phase: do not calculate fluxes

        do ic=1,ng
	      dbmat(ic) = r0
	    enddo

      else
!c---------------------------------------------------------------------------
!c      set up DGM system

!       right hand side vector - three steps: 
!                            1 - decide if it includes gravity or not
!                            2 - build damat matrix
!                            3 - build dbmat as dbmat + damat * fmat

        if (.not.gas_gravity) then ! do not include gravity

	      do ic=1,ng
          
	        damat(ic,ic)= r0 !20060218
            
	        do jc =1,ng
          
	         if (ic.ne.jc) then
		  
!c              --diagonal terms
	           damat(ic,ic) = damat(ic,ic)                             &
                              - dmolfrac_i(jc) / diff_bin_g(ic,jc)     &
                              * alpha_diff
          
!v	           damat(ic,ic) = damat(ic,ic)
!v     &                        - dmolfrac_i(jc) / diff_bin_g(ic,jc)
!v     &                        / gporx / tauijx * factor / alpha_diff 
          
!c              --off-diagonal terms
                 damat(ic,jc) = dmolfrac_i(ic) / diff_bin_g(ic,jc)     &
                              * alpha_diff
          
!v                 damat(ic,jc) = 
!v     &                        + dmolfrac_i(ic) / diff_bin_g(ic,jc)
!v     &                        / gporx / tauijx * factor / alpha_diff
          
	         endif !ic.ne.jc
          
	        enddo
          
            dbmat(ic) = - dc_i(ic) / delta_ijx
          
	        do jc=1,ng
              dbmat(ic)=dbmat(ic) - damat(ic,jc)*fmat(jc)
            enddo
          
	      enddo

	    else                       ! include gravity

	      do ic=1,ng
          
	        damat(ic,ic)= r0 !20060218
          
	        do jc =1,ng
          
	          if (ic.ne.jc) then
		  
!c               --diagonal terms
	            damat(ic,ic) = damat(ic,ic)                            & 
                               - dmolfrac_i(jc) / diff_bin_g(ic,jc)    &
                               * alpha_diff
!v     &                         / gporx / tauijx * factor / alpha_diff
          
!c               --off-diagonal terms
                  damat(ic,jc) =                                       &
                               + dmolfrac_i(ic) / diff_bin_g(ic,jc)    &
                               * alpha_diff
!v     &                         / gporx / tauijx * factor / alpha_diff
          
	          endif !ic.ne.jc
          
	        enddo
          
	        dbmat(ic) =                                                &
      	              - dc_i(ic) / delta_ijx                           &
                        + beta_diff * gfwg(ic) * dc_i(ic) * (zgj- zgi)
          
!v     &                  + gacc * gfwg(ic) * factor * dc_i(ic) * (zgj- zgi)
!v     &  		        / delta_ijx /  rgasjoule / tempkel / 1.d3
          
	        do jc=1,ng
              dbmat(ic)=dbmat(ic) - damat(ic,jc)*fmat(jc)
            enddo
		     
	      enddo

        endif

!c---------------------------------------------------------------------------
!c       solve for derivative of fluxes using LU decomposition performed prev.

!c       back substitution
        call dgeslm (ludecomp,ng,ng,ipvt,dbmat)
!c---------------------------------------------------------------------------

      endif ! calculation of derivative of fluxes
!c---------------------------------------------------------------------------

!c     pass results to external variables

!c     initialize dgm_dgflux
      do ic=1,nc 
	    dgm_dgflux(ic) = r0
 	  enddo

      do ig=1,ng

        istart = iaga(ig)
        iend = iaga(ig+1)-1
	
        do i = istart,iend        
	      ic = jaga(i)
		  dgm_dgflux(ic) = dgm_dgflux(ic) + dbmat(ig) * xnug(i)
        end do
        
      enddo

!c  compress total gaseous component diffusive flux vectors
!c  in case of redox equilibrium reactions

      if (redox_equil.and.nr.gt.0) then
        call comptotc(dgm_dgflux)
      end if
	
!c---------------------------------------------------------------------------	 
    	
      return
      end