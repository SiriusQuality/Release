!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 296 $
!> $Author: dsu $
!> $Date: 2015-04-07 22:22:37 +0200 (Tue, 07 Apr 2015) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/fgerard_new/src/dgm/dgm_fluxdg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine dgm_fluxdg
!c --------------------------
!c
!c compute total diffusive flux of gases using the dusty gas model for rhs vector
!c LU decomposition of system matrix to calculate derivatives for global jacobian
!c for now, there is no knudsen diffusion
!c
!c amat fmat  = bmat
!c
!c amat (i,i) = - SUM (Xj/Dij) - 1/Di^k
!c amat (i,j) =   Xi/Dij
!c bmat (i)   =   nabla(Ci) + dens * gacc / R / T * Xi * nabla(z)
!c fmat (i)   =   Ni^D  (molar diffusive flux of species i)
!c
!c written by:  Sergi Molins - May 2,2006
!c
!c modified by: Sergi Molins - May 24,2006
!c              press+temp dependence of gas diff coeff
!c              Sergi Molins - June 12, 2006
!c              fully saturated: gporij<10^-30 and relp<10^-30 
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c_i(ng)            = gaseous species concentrations      + -
!c                                at control volume i
!c           c_j(ng)            = gaseous species concentrations      + -
!c                                at control volume j
!c           c_ij(ng)           = gaseous species concentrations      + -
!c                                at interface i-j
!c           molfrac(ng)        = gas molar fraction at interface i   + -
!c           zgi                = elevation at control volume i       + -
!c           zgj                = elevation at control volume j       + -
!c           dens               = gas density at interface i-j        + -
!c           tempkel            = temperature at interface i-j [K]    + -
!c           permijy            = permeability at interface i-j [m^2] + -
!c           relp               = relative permeability               + -
!c           tauijx             = gas tortuosity at interface i-j     + - 
!c           gpij               = gas pressure at interface i-j       + - 
!c           gporx              = porosity at interface i-j           + -
!c           delta_ijx          = distance between nodes i - j [m]    + -
!c           small              = constant                            + -
!c           amat(ng,ng)        = matrix (see above)                  + +
!c           bmat(ng)           = molar diffusive fluxes for          + +
!c                                gas species [moles m^-2 d^-1]
!c           dgm_gflux(nc)      = total molar diffusive fluxes for    * +
!c                                gas components [moles m^-2 d^-1]
!c           dgm_neflux(nc)     = non-equimolar diffusive fluxes for  * +
!c                                gas components [moles m^-2 d^-1]
!c
!c           integer*4:
!c           ----------
!c           ipvt(ng)           = pivot indeces
!C                                (see dgefam.f,dgeslm.f subroutines) + +
!c
!c gen.f:    real*8:
!c           -------
!c           gacc               = gravity m s^-2                      + -
!c
!c           logical:
!c           -------
!c           gas_gravity        = enable gas gravity in advection     + -
!c
!c chem.f    real*8:
!c           -------
!c           rgasjoule          = ideal gas constant
!c                                [J/(deg K mol)]
!c           gfwg(ng)           = gram formula weight gas species     + -
!c           xnug(ng*nc)        = stoichiometric coefficient matrix 
!c                                for formation of gases from
!c                                components
!c           pa_atm             = pascal to atmosphere                + -
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gas species               + -
!c           nr                 = number of redox couples             + -
!c           iaga(ng+1)         = row pointer array to                + -
!c                                stoichiometric coefficients of 
!c                                components in gases
!c           jaga(ng*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients of 
!c                                components in gases
!c           logical:
!c           -------
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c phys.f:   real*8:
!c           -------
!c           diff_bin_g(ng,ng)  = binary diffusion coefficients       + -
!c           theta_diff         = exponent for temp correction        + -
!c
!c           logical:
!c           --------
!c           diff_press         = correction for pressure dependence  + -
!c           diff_temp          = correction for temp dependence      + -
!c
!c common:   -
!c
!c local:    real*8:
!c           -------
!c           r0               = constant
!c           r1               = constant
!c           diff_knud        = knudsen diffusion coefficient
!c           neflux           = non-equimolar flux
!c           expt             = exponent in knudsen diff coeff
!c           beta             = constant in knudsen diff coeff
!c           vis2             = air viscosity (reference)
!c           gfm2             = gram formula weight for air (reference)
!c           alpha_diff       = factor that modifies the diffusion coeff
!c                              as a function pressure and temperature
!c
!c           integer*4:
!c           ----------
!c           i                = index
!c           ic               = index
!c           jc               = index
!c           ig               = index
!c           istart           = index 
!c           iend             = index
!c
!c external: dgeslm.f         = linear system solver  
!c           dgefam.f         = LU decomp of linear system
!c           comptotc.f       = total gaseous component diff flux vectors
!c ----------------------------------------------------------------------
 
      subroutine  dgm_fluxdg(c_i       ,c_j        ,    &
                             c_ij      ,molfrac    ,    &
                             zgi       ,zgj        ,    &
                             dens      ,gpij       ,    &
                             tempkel   ,permijy    ,    &
                             relp      ,tauijx     ,    &
                             gporx     ,delta_ijx  ,    &
                             small     ,                &
                             amat      ,                &
                             bmat      ,ipvt       ,    &
                             dgm_gflux ,dgm_neflux )
 
      use gen
	  use chem
	  use phys
	
	  implicit none

!c------------------------------------------------

!c     constants
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0

!c     passed
      real*8       c_i(ng)         ,c_j(ng)        ,    &
                   c_ij(ng)        ,molfrac(ng)    ,    &
                   zgi             ,zgj            ,    &
                   dens            ,gpij           ,    &
                   tempkel         ,permijy        ,    &
                   relp            ,tauijx         ,    &
                   gporx           ,delta_ijx      ,    &
                   small           ,                    &
                   amat(ng,ng)     ,bmat(ng)       ,    &
                   dgm_gflux(nc)   ,dgm_neflux(nc)    

	  integer*4    ipvt(ng)

!c     internal
      integer*4    i, ic, jc, ig, istart, iend, info
	
	  real*8       diff_knud, neflux, permijx
      
	  real*8       expt, beta, vis2, gfm2, alpha_diff, beta_diff  

!c--------------------------------------------------------------------------- 
!c     initialize matrix (only diagonal needed)
      do ic=1,ng
	    amat(ic,ic)= r0
	  enddo


      alpha_diff = r1 / gporx / tauijx
!v     alpha_diff = r1

      beta_diff = gacc / delta_ijx / rgasjoule / tempkel / 1.d3

!c     pressure & temperature dependence
	  if (diff_press) then
      
        alpha_diff = alpha_diff * gpij * pa_atm
!v	   alpha_diff = alpha_diff / gpij / pa_atm
	     
	  endif

	  if (diff_temp) then
      
	    alpha_diff = alpha_diff / tempkel**theta_diff
!v       alpha_diff = alpha_diff * tempkel**theta_diff
      
	  endif

!c---------------------------------------------------------------------------
!c     check if there is gas phase
      if (gporx.lt.small.or.relp.lt.small) then
!c       no gas phase: do not calculate fluxes

        do ic=1,ng
	      bmat(ic) = r0
	    enddo

      else
!c---------------------------------------------------------------------------
!c      set up DGM system

!       initialization of dgm parameters

        expt = -.39d0  ! -0.24d0
	    beta = 0.11d0  !  5.57d0

!       expt = -0.24d0
!	    beta = 5.57d0
	
	    vis2 = visc_gcnst
	    gfm2 = 28.9d0
        
	    permijx = relp * permijy / sec_per_days

! commented out 20060217
!        do ic=1,ng
	  
!	    gfm1 = gfwg(ic)
!	    vis1 = visc_comp_g(ic)
	   
!          diff_knud(ic) = 
!     &                  + permijx / vis1 * beta * (permijx**expt) 
!     &                  *    vis1 / vis2 * dsqrt ( gfm2 / gfm1 ) 
!     &                  * sec_per_days 
      
!	  enddo

!c     initialize constant parameters (minimization of calculations)
        diff_knud  = permijx * beta * (permijx**expt)                  &
                   / vis2 * dsqrt (gfm2) * sec_per_days

!c       right hand side vector      
	    if (.not.gas_gravity) then  ! do not include gravity
	  
	      do ic=1,ng
	        bmat(ic) = (c_j(ic) - c_i(ic)) / delta_ijx
	      enddo
  
        else                        ! include gravity

	      do ic=1,ng
	        bmat(ic) = (c_j(ic) - c_i(ic)) / delta_ijx                 &
                       + beta_diff * gfwg(ic) * c_ij(ic) * (zgj - zgi)
          
!              bmat(ic) = (c_j(ic) - c_i(ic)) / delta_ijx
!     &                 + gacc * gfwg(ic) * c_ij(ic) * (zgj - zgi) 
!     &                 / delta_ijx / rgasjoule / tempkel / 1.d3
	      enddo
  
        endif

!c       DGM system matrix
        do ic=1,ng
          
	      do jc =1,ng

	        if (ic.ne.jc) then
		
!c           --diagonal terms
		      amat(ic,ic) = amat(ic,ic)                                &
                            - molfrac(jc) / diff_bin_g(ic,jc)          &
                                          * alpha_diff
      
!v		    amat(ic,ic) = amat(ic,ic)
!v     &                    - molfrac(jc) / diff_bin_g(ic,jc) 
!v     &                                  / gporx / tauijx
!v     &                                  / alpha_diff

!c           --off-diagonal terms
              amat(ic,jc) = molfrac(ic) / diff_bin_g(ic,jc)            &
                                        * alpha_diff

!v              amat(ic,jc) = 0.d0
!v     &                    + molfrac(ic) / diff_bin_g(ic,jc)
!v     &                                  / gporx / tauijx
!v     &                                  / alpha_diff

	        endif !ic.ne.jc
	 
	      enddo ! jc

!c         knudsen term

!v          diff_knud   = dsqrt (gfwg(ic)) / diff_knud_c
          
!v          diff_knud   = permijx / visc_comp_g(ic) 
!v     &                * beta * (permijx**expt) 
!v     &                * visc_comp_g(ic) / vis2 
!v     &                * dsqrt ( gfm2 / gfwg(ic) ) 
!v     &                * sec_per_days      

	    amat(ic,ic) = amat(ic,ic) - dsqrt (gfwg(ic)) / diff_knud 
		
		                                 ! diff_knud !(ic) !/ gporx

!v        amat(ic,ic) = amat(ic,ic) - 1.d0 / diff_knud !(ic) !/ gporx

	  enddo ! ic

!c---------------------------------------------------------------------------
!c       solve for fluxes

!c       LU decomposition
        call dgefam (amat,ng,ng,ipvt,info)

!c       back substitution
        call dgeslm (amat,ng,ng,ipvt,bmat)
!c---------------------------------------------------------------------------

      endif ! calculation of fluxes
!c---------------------------------------------------------------------------

!c     calculate non-equimolar flux
      neflux = r0
      do ig=1,ng
	    neflux = neflux + bmat(ig)
      enddo

!c     pass results to external variables

!c     system matrix (keep for derivatives)
!     commented out 20060217
!      do ic=1,ng 
!	  fmat(ic) = bmat(ic)
!	  do jc=1,ng
!          ludecomp(ic,jc) = amat(ic,jc)
!	  enddo
!	enddo

!c     initialize dgm_gflux
      do ic=1,nc 
	    dgm_gflux(ic) = r0
        dgm_neflux(ic) = r0
 	  enddo

      do ig=1,ng

        istart = iaga(ig)
        iend = iaga(ig+1)-1
	
        do i = istart,iend
        
	      ic = jaga(i)
		  dgm_gflux(ic)  = dgm_gflux(ic) + bmat(ig) * xnug(i)
	      dgm_neflux(ic) = dgm_neflux(ic) + neflux * molfrac(ig) *     &
                           xnug(i)
        end do
        
      enddo
	
!c  compress total gaseous component diffusive flux vectors
!c  in case of redox equilibrium reactions

      if (redox_equil.and.nr.gt.0) then
        call comptotc(dgm_gflux)
	    call comptotc(dgm_neflux)
      end if 

!c---------------------------------------------------------------------------
	     	
      return
      end